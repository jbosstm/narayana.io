<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>JTS</title>
<style>
@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";
@import "https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css";

h6 > .content > .title,h7,h8,h9 {
    font-family:"Open Sans","DejaVu Sans",sans-serif;
    font-weight:normal;
    font-size:.85em;
    font-style:normal;
    color:#ba8425;
    text-rendering:optimizeLegibility;
    margin-top:1em;
    margin-bottom:1em;
    line-height:2em
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>JTS</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_administration">1. Administration</a>
<ul class="sectlevel2">
<li><a href="#_introduction">1.1. Introduction</a></li>
<li><a href="#_ots_and_jakarta_ee_transaction_service_management">1.2. OTS and Jakarta EE Transaction Service Management</a></li>
<li><a href="#_orb_specific_configurations">1.3. ORB-specific Configurations</a></li>
<li><a href="#_initializing_narayana_applications">1.4. Initializing Narayana Applications</a></li>
</ul>
</li>
<li><a href="#_development">2. Development</a>
<ul class="sectlevel2">
<li><a href="#_transaction_processing_overview">2.1. Transaction Processing Overview</a></li>
<li><a href="#_narayana_basics">2.2. Narayana Basics</a></li>
<li><a href="#_introduction_to_the_ots">2.3. Introduction to the OTS</a></li>
<li><a href="#_constructing_an_ots_application">2.4. Constructing an OTS application</a></li>
<li><a href="#_narayana_interfaces_for_extending_the_ots">2.5. Narayana interfaces for extending the OTS</a></li>
<li><a href="#_example">2.6. Example</a></li>
<li><a href="#_trail_map">2.7. Trail map</a></li>
<li><a href="#_failure_recovery">2.8. Failure Recovery</a></li>
<li><a href="#_jta_and_jts">2.9. JTA and JTS</a></li>
<li><a href="#_orb_specific_configuration">2.10. ORB-specific configuration</a></li>
</ul>
</li>
<li><a href="#_orb_portability_2">3. ORB Portability</a>
<ul class="sectlevel2">
<li><a href="#_orb_portability_introduction">3.1. ORB Portability Introduction</a></li>
<li><a href="#_orb_portability_api">3.2. ORB Portability API</a></li>
<li><a href="#_quick_start_to_jtsots">3.3. Quick Start to JTS/OTS</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_administration"><a class="anchor" href="#_administration"></a>1. Administration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction"><a class="anchor" href="#_introduction"></a>1.1. Introduction</h3>
<div class="paragraph">
<p>The notions explained here are to be considered as extensions of what has already been presented in the
'Administration' section of <a href="#jta_introduction">JTA&#8217;s Administration section</a>.</p>
</div>
<div class="paragraph">
<p>Since the release of Narayana 4.1, the Web Services Transaction product has been merged into Narayana. Narayana is thus a single product that is compliant with all of the major distributed transaction standards and specifications.</p>
</div>
<div class="paragraph">
<p>Knowledge of Web Services is not required to administer a Narayana installation that only uses the CORBA/J2EE component, nor is knowledge of CORBA required to use the Web Services component.
This, administrative tasks are separated when they touch only one component or the other.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ots_and_jakarta_ee_transaction_service_management"><a class="anchor" href="#_ots_and_jakarta_ee_transaction_service_management"></a>1.2. OTS and Jakarta EE Transaction Service Management</h3>
<div class="sect3">
<h4 id="_starting_the_run_time_system"><a class="anchor" href="#_starting_the_run_time_system"></a>1.2.1. Starting the run-time system</h4>
<div class="paragraph">
<p>The Narayana run-time support consists of run-time packages and the OTS transaction manager server.
By default, Narayana does not use a separate transaction manager server.
Instead, transaction managers are co-located with each application process to improve performance and improve application fault-tolerance by reducing application dependency on other services.</p>
</div>
<div class="paragraph">
<p>When running applications which require a separate transaction manager, set the <code>JTSEnvironmentBean.transactionManager</code> environment variable to value <code>YES</code>.
The system locates the transaction manager server in a manner specific to the ORB being used.
This method may be any of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Being registered with a name server.</p>
</li>
<li>
<p>Being added to the ORB’s initial references.</p>
</li>
<li>
<p>Via a Narayana specific references file.</p>
</li>
<li>
<p>By the ORB’s specific location mechanism (if applicable).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You override the default registration mechanism by using the <code>OrbPortabilityEnvironmentBean.resolveService</code> environment variable, which takes the following values:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Possible values of <code>OrbPortabilityEnvironmentBean.resolveService</code></caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONFIGURATION_FILE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the default, and causes the system to use the <code>CosServices.cfg</code> file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NAME_SERVICE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana attempts to use a name service to register the transaction factory. If this is not supported, an exception is thrown.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIND_CONNECT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana uses the ORB-specific bind mechanism. If this is not supported, an exception is thrown.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RESOLVE_INITIAL_REFERENCES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana attempts to register the transaction service with the ORB&#8217;s initial service references. If the ORB does not support this, an exception is thrown, and another option must be used.</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_ots_configuration_file"><a class="anchor" href="#_ots_configuration_file"></a>OTS configuration file</h5>
<div class="paragraph">
<p>Similar to the <code>resolve_initial_references</code>, Narayana supports an initial reference file where references for specific services can be stored and used at runtime.
The file, <code>CosServices.cfg</code>, consists of two columns: the service name (in the case of the OTS server TransactionService), and the IOR, separated by a single space.
<code>CosServices.cfg</code> is located at runtime by the following <code>OrbPortabilityEnvironmentBean</code> properties:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>initialReferencesRoot</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The directory where the file is located, defaulting to the current working directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>initialReferencesFile</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the configuration file itself, <code>CosServices.cfg</code> by default.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The OTS server automatically registers itself in the <code>CosServices.cfg</code> file if the <code>OrbPortabilityEnvironmentBean</code> option is used, creating the file if necessary.
Stale information is also automatically removed.
Machines sharing the same transaction server should have access to this file, or a copy of it locally.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Example ORB reference file settings</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">OrbPortabilityEnvironmentBean.initialReferencesFile=myFile
OrbPortabilityEnvironmentBean.initialReferencesRoot=/tmp</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_name_service"><a class="anchor" href="#_name_service"></a>Name service</h5>
<div class="paragraph">
<p>If your ORB supports a name service, and Narayana is configured to use it, the transaction manager is registered with it automatically.
There is no further work required.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This option is not used for JacORB</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_resolve_initial_references"><a class="anchor" href="#_resolve_initial_references"></a>resolve_initial_references</h5>
<div class="paragraph">
<p>Currently, this option is only supported for JacORB.</p>
</div>
</div>
<div class="sect4">
<h5 id="_resolution_services_supported_per_orb"><a class="anchor" href="#_resolution_services_supported_per_orb"></a>Resolution services supported per ORB</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Resolution Mechanism</th>
<th class="tableblock halign-left valign-top">ORB</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OTS configuration file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All available ORBs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JacORB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">resolve_initial_references</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JacORB</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_xa_specific_management"><a class="anchor" href="#_xa_specific_management"></a>1.2.2. XA Specific management</h4>
<div class="paragraph">
<p>Each XA Xid that Narayana creates must have a unique node identifier encoded within it.
Narayana only recovers transactions and states that match a specified node identifier.
Provide the node identifier with the <code>CoreEnvironmentBean.nodeIdentifier</code> property.
This value must be unique across your Narayana instances.
If you do not provide a value, Narayana generates one and reports the value via the logging infrastructure.</p>
</div>
<div class="paragraph">
<p>When running XA recovery, you need to specify which types of Xid Narayana can recover.
Use the <code>JTAEnvironmentBean.xaRecoveryNodes</code> property to provide one or more values, in a space-separated list.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A value of ‘*’ forces Narayana to recover, and possibly rollback, all transactions, regardless of their node identifier.
Use this value with extreme caution.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_selecting_the_jta_implementation"><a class="anchor" href="#_selecting_the_jta_implementation"></a>1.2.3. Selecting the JTA implementation</h4>
<div class="paragraph">
<p>Two variants of the JTA implementation are now provided and accessible through the same interface.
These are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Purely local JTA</dt>
<dd>
<p>Only non-distributed JTA transactions can be executed.
This is the only version available with the Narayana product.</p>
</dd>
<dt class="hdlist1">Remote, CORBA-based JTA</dt>
<dd>
<p>Distributed JTA transactions can be executed.
This version is only available with the Narayana product and requires a supported CORBA ORB.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Both of these implementations are fully compatible with the transactional JDBC driver provided with Narayana.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<div class="title">Selecting the local JTA implementation</div>
<ul>
<li>
<p>Set the property <code>JTAEnvironmentBean.jtaTMImplementation</code> to value <code>com.arjuna.ats.internal.jta.transaction.arjunacore.TransactionManagerImple</code>.</p>
</li>
<li>
<p>Set the property <code>JTAEnvironmentBean.jtaUTImplementation</code> to value <code>com.arjuna.ats.internal.jta.transaction.arjunacore.UserTransactionImple</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These settings are the default values for the properties and do not need to be specified if the local implementation is required.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<div class="title">Selecting the remote JTA implementation</div>
<ul>
<li>
<p>Set the property <code>JTAEnvironmentBean.jtaTMImplementation</code> to value <code>com.arjuna.ats.internal.jta.transaction.jts..TransactionManagerImple</code>.</p>
</li>
<li>
<p>Set the property <code>JTAEnvironmentBean.jtaUTImplementation</code> to value <code>com.arjuna.ats.internal.jta.transaction.jts.UserTransactionImple</code>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_orb_specific_configurations"><a class="anchor" href="#_orb_specific_configurations"></a>1.3. ORB-specific Configurations</h3>
<div class="sect3">
<h4 id="_jacorb"><a class="anchor" href="#_jacorb"></a>1.3.1. JacORB</h4>
<div class="paragraph">
<p>For JacORB to function correctly it needs a valid <code>jacorb.properties</code> or <code>.jacorb_properties</code> file in one of the following places, in searched order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The classpath</p>
</li>
<li>
<p>The home directory of the user running the Narayana Service.
The home directory is retrieved using <code>System.getProperty(“user.home”);</code></p>
</li>
<li>
<p>The current directory</p>
</li>
<li>
<p>The <code>lib/</code> directory of the JDK used to run your application.
This is retrieved using <code>System.getProperty(“java.home”);</code></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A template <code>jacorb.properties</code> file is located in the JacORB installation directory.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Within the JacORB properties file there are two important properties which must be tailored to suit your application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jacorb.poa.thread_pool_max</code></p>
</li>
<li>
<p><code>jacorb.poa.thread_pool_min</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These properties specify the minimum and maximum number of request processing threads that JacORB uses in its thread pool.
If no threads are available, may block until a thread becomes available. For more information on configuring JacORB, refer to the JacORB documentation.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>JacORB includes its own implementation of the classes defined in the <code>CosTransactions.idl</code> file.
Unfortunately these are incompatible with the version shipped with Narayana.
Therefore, the Narayana jar files absolutely must appear in the CLASSPATH before any JacORB jars.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When running the recovery manager, it should always use the same well-known port for each machine on which it runs.
Do not use the <code>OAPort</code> property provided by JacORB unless the recovery manager has its own <code>jacorb.properties</code> file or the property is provided on the command line when starting the recovery manager.
If the recovery manager and other components of Narayana share the same <code>jacorb.properties</code> file, use the <code>JTSEnvironmentBean.recoveryManagerPort</code> and <code>JTSEnvironmentBean.recoveryManagerAddress</code> properties.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_initializing_narayana_applications"><a class="anchor" href="#_initializing_narayana_applications"></a>1.4. Initializing Narayana Applications</h3>
<div class="paragraph">
<p>Narayana must be initialized correctly before any application object is created.
To guarantee this, use the <code>initORB</code> and <code>create_POA</code> methods described in the <em>Orb Portability Guide</em>.
Consult the Orb Portability Guide if you need to use the underlying <code>ORB_init</code> and <code>create_POA</code> methods provided by the ORB instead of the Narayana methods.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_development"><a class="anchor" href="#_development"></a>2. Development</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_transaction_processing_overview"><a class="anchor" href="#_transaction_processing_overview"></a>2.1. Transaction Processing Overview</h3>
<div class="sect3">
<h4 id="_defining_a_transaction"><a class="anchor" href="#_defining_a_transaction"></a>2.1.1. Defining a transaction</h4>
<div class="paragraph">
<p>A transaction is a unit of work that encapsulates multiple database actions such that that either all the encapsulated actions fail or all succeed.</p>
</div>
<div class="paragraph">
<p>Transactions ensure data integrity when an application interacts with multiple datasources.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Practical Example</div>
<p>If you subscribe to a newspaper using a credit card, you are using a transactional system.
Multiple systems are involved, and each of the systems needs the ability to roll back its work, and cause the entire transaction to roll back if necessary.
For instance, if the newspaper&#8217;s subscription system goes offline halfway through your transaction, you don&#8217;t want your credit card to be charged.
If the credit card is over its limit, the newspaper doesn&#8217;t want your subscription to go through.
In either of these cases, the entire transaction should fail of any part of it fails.
Neither you as the customer, nor the newspaper, nor the credit card processor, wants an unpredictable (indeterminate) outcome to the transaction.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>This ability to roll back an operation if any part of it fails is what Narayana is all about.
This guide assists you in writing transactional applications to protect your data.</p>
</div>
<div class="paragraph">
<p>"Transactions" in this guide refers to atomic transactions, and embody the "all-or-nothing" concept outlined above.
Transactions are used to guarantee the consistency of data in the presence of failures.
Transactions fulfill the requirements of ACID: Atomicity, Consistency, Isolation, Durability.</p>
</div>
<div class="dlist">
<div class="title">ACID Properties</div>
<dl>
<dt class="hdlist1">Atomicity</dt>
<dd>
<p>The transaction completes successfully (commits) or if it fails (aborts) all of its effects are undone (rolled back).</p>
</dd>
<dt class="hdlist1">Consistency</dt>
<dd>
<p>Transactions produce consistent results and preserve application specific invariants.</p>
</dd>
<dt class="hdlist1">Isolation</dt>
<dd>
<p>Intermediate states produced while a transaction is executing are not visible to others.
Furthermore, transactions appear to execute serially, even if they are actually executed concurrently.</p>
</dd>
<dt class="hdlist1">Durability</dt>
<dd>
<p>The effects of a committed transaction are never lost (except by a catastrophic failure).</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A transaction can be terminated in two ways: committed or aborted (rolled back).
When a transaction is committed, all changes made within it are made durable (forced on to stable storage, e.g., disk).
When a transaction is aborted, all of the changes are undone.
Atomic actions can also be nested; the effects of a nested action are provisional upon the commit/abort of the outermost (top-level) atomic action.</p>
</div>
</div>
<div class="sect3">
<h4 id="_commit_protocol"><a class="anchor" href="#_commit_protocol"></a>2.1.2. Commit protocol</h4>
<div class="paragraph">
<p>A two-phase commit protocol guarantees that all of the transaction participants either commit or abort any changes made.
<a href="#_img_commit_protocol">Two-Phase Commit</a> illustrates the main aspects of the commit protocol.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>During phase 1, the action coordinator, <code>C</code>, attempts to communicate with all of the action participants, <code>A</code> and <code>B</code>, to determine whether they will commit or abort.</p>
</li>
<li>
<p>An abort reply from any participant acts as a veto, causing the entire action to abort.</p>
</li>
<li>
<p>Based upon these (lack of) responses, the coordinator chooses to commit or abort the action.</p>
</li>
<li>
<p>If the action will commit, the coordinator records this decision on stable storage, and the protocol enters phase 2, where the coordinator forces the participants to carry out the decision.
The coordinator also informs the participants if the action aborts.</p>
</li>
<li>
<p>When each participant receives the coordinator’s phase-one message, it records sufficient information on stable storage to either commit or abort changes made during the action.</p>
</li>
<li>
<p>After returning the phase-one response, each participant who returned a commit response must remain blocked until it has received the coordinator’s phase-two message.</p>
</li>
<li>
<p>Until they receive this message, these resources are unavailable for use by other actions.
If the coordinator fails before delivery of this message, these resources remain blocked.
However, if crashed machines eventually recover, crash recovery mechanisms can be employed to unblock the protocol and terminate the action.</p>
</li>
</ul>
</div>
<div id="_img_commit_protocol" class="imageblock">
<div class="content">
<img src="images/jts-img-2phase.png" alt="jts img 2phase">
</div>
<div class="title">Figure 1. Two-Phase Commit</div>
</div>
</div>
<div class="sect3">
<h4 id="_transactional_proxies"><a class="anchor" href="#_transactional_proxies"></a>2.1.3. Transactional proxies</h4>
<div class="paragraph">
<p>The action coordinator maintains a transaction context where resources taking part in the action need to be registered.
Resources must obey the transaction commit protocol to guarantee ACID properties.
Typically, the resource provides specific operations which the action can invoke during the commit/abort protocol.
However, some resources may not be able to be transactional in this way.
This may happen if you have legacy code which cannot be modified.
Transactional proxies allow you to use these anomalous resources within an action.</p>
</div>
<div class="paragraph">
<p>The proxy is registered with, and manipulated by, the action as though it were a transactional resource, and the proxy performs implementation specific work to make the resource it represents transactional.
The proxy must participate within the commit and abort protocols.
Because the work of the proxy is performed as part of the action, it is guaranteed to be completed or undone despite failures of the action coordinator or action participants.</p>
</div>
</div>
<div class="sect3">
<h4 id="_nested_transactions"><a class="anchor" href="#_nested_transactions"></a>2.1.4. Nested transactions</h4>
<div class="paragraph">
<p>Given a system that provides transactions for certain operations, you can combine them to form another operation, which is also required to be a transaction.
The resulting transaction’s effects are a combination of the effects of its constituent transactions.
This paradigm creates the concept of nested subtransactions, and the resulting combined transaction is called the enclosing transaction.
The enclosing transaction is sometimes referred to as the parent of a nested (or child) transaction.
It can also be viewed as a hierarchical relationship, with a top-level transaction consisting of several subordinate transactions.</p>
</div>
<div class="paragraph">
<p>An important difference exists between nested and top-level transactions.</p>
</div>
<div class="paragraph">
<p>The effect of a nested transaction is provisional upon the commit/roll back of its enclosing transactions.
The effects are recovered if the enclosing transaction aborts, even if the nested transaction has committed.</p>
</div>
<div class="paragraph">
<p>Sub-transactions are a useful mechanism for two reasons:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">fault-isolation</dt>
<dd>
<p>If a sub-transaction rolls back, perhaps because an object it is using fails, the enclosing transaction does not need to roll back.</p>
</dd>
<dt class="hdlist1">modularity</dt>
<dd>
<p>If a transaction is already associated with a call when a new transaction begins, the new transaction is nested within it.
Therefore, if you know that an object requires transactions, you can them within the object.
If the object’s methods are invoked without a client transaction, then the object’s transactions are top-level.
Otherwise, they are nested within the scope of the client&#8217;s transactions.
Likewise, a client does not need to know whether an object is transactional.
It can begin its own transaction.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_the_object_transaction_service_ots"><a class="anchor" href="#_the_object_transaction_service_ots"></a>2.1.5. The Object Transaction Service (OTS)</h4>
<div class="paragraph">
<p>The CORBA architecture, as defined by the OMG, is a standard which promotes the construction of interoperable applications that are based upon the concepts of distributed objects.
The architecture principally contains the following components:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Object Request Broker (ORB)</dt>
<dd>
<p>Enables objects to transparently send and receive requests in a distributed, heterogeneous environment.
This component is the core of the OMG reference model.</p>
</dd>
<dt class="hdlist1">Object Services</dt>
<dd>
<p>A collection of services that support functions for using and implementing objects.
Such services are necessary for the construction of any distributed application.
The Object Transaction Service (OTS) is the most relevant to Narayana.</p>
</dd>
<dt class="hdlist1">Common Facilities</dt>
<dd>
<p>Other useful services that applications may need, but which are not considered to be fundamental.
Desktop management and help facilities fit this category.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The CORBA architecture allows both implementation and integration of a wide variety of object systems.
In particular, applications are independent of the location of an object and the language in which an object is implemented, unless the interface the object explicitly supports reveals such details.
As defined in the OMG CORBA Services documentation, <em>object services</em> are defined as a collection of services (interfaces and objects) that support the basic functions for using and implementing objects.
These services are necessary to construct distributed application, and are always independent of an application domain.
The standards specify several core services including naming, event management, persistence, concurrency control and transactions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The OTS specification allows, but does not require, nested transactions.
Narayana is a fully compliant version of the OTS version 1.1 draft 5, and support nested transactions.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The transaction service provides interfaces that allow multiple distributed objects to cooperate in a transaction, committing or rolling back their changes as a group.
However, the OTS does not require all objects to have transactional behavior.
An object&#8217;s support of transactions can be none at all, for some operations, or fully.
Transaction information may be propagated between client and server explicitly, or implicitly.
You have fine-grained control over an object&#8217;s support of transactions.
If your objects supports partial or complete transactional behavior, it needs interfaces derived from interface <code>TransactionalObject</code>.</p>
</div>
<div class="paragraph">
<p>The Transaction Service specification also distinguishes between recoverable objects and transactional objects.
Recoverable objects are those that contain the actual state that may be changed by a transaction and must therefore be informed when the transaction commits or aborts to ensure the consistency of the state changes.
This is achieved be registering appropriate objects that support the Resource interface (or the derived <code>SubtransactionAwareResource</code> interface) with the current transaction.
Recoverable objects are also by definition transactional objects.</p>
</div>
<div class="paragraph">
<p>In contrast, a simple transactional object does not necessarily need to be recoverable if its state is actually implemented using other recoverable objects.
A simple transactional object does not need to participate the commit protocol used to determine the outcome of the transaction since it maintains no state information of its own.</p>
</div>
<div class="paragraph">
<p>The OTS is a protocol engine that guarantees obedience to transactional behavior.
It does not directly support all of the transaction properties, but relies on some cooperating services:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Persistence/Recovery Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supports properties of atomicity and durability.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Concurrency Control Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supports the isolation properties.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You are responsible for using the appropriate services to ensure that transactional objects have the necessary ACID properties.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_narayana_basics"><a class="anchor" href="#_narayana_basics"></a>2.2. Narayana Basics</h3>
<div class="sect3">
<h4 id="_introduction_2"><a class="anchor" href="#_introduction_2"></a>2.2.1. Introduction</h4>
<div class="paragraph">
<p>Narayana is based upon the original Arjuna system developed at the University of Newcastle between 1986 and 1995. Arjuna predates the OTS specification and includes many features not found in the OTS.
Narayana is a superset of the OTS.
Applications written using the standard OTS interfaces are portable across OTS implementations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>full draft 5 compliance, with support for Synchronization objects and PropagationContexts.</p>
</li>
<li>
<p>support for subtransactions.</p>
</li>
<li>
<p>implicit context propagation where support from the ORB is available.</p>
</li>
<li>
<p>support for multi-threaded applications.</p>
</li>
<li>
<p>fully distributed transaction managers, i.e., there is no central transaction manager, and the creator of a top-level transaction is responsible for its termination.
Separate transaction manager support is also available, however.</p>
</li>
<li>
<p>transaction interposition.</p>
</li>
<li>
<p>X/Open compliance, including checked transactions.
This checking can optionally be disabled.
Note: checked transactions are disabled by default, i.e., any thread can terminate a transaction.</p>
</li>
<li>
<p>JDBC support.</p>
</li>
<li>
<p>Full Jakarta Transactions support.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use Narayana in three different levels, which correspond to the sections in this chapter, and are each explored in their own chapters as well.</p>
</div>
<div class="paragraph">
<p>Because of differences in ORB implementations, Narayana uses a separate ORB Portability library which acts as an abstraction later.
Many of the examples used throughout this manual use this library.
Refer to the ORB Portability Manual for more details.</p>
</div>
<div class="sect4">
<h5 id="_raw_ots"><a class="anchor" href="#_raw_ots"></a>Raw OTS</h5>
<div class="paragraph">
<p>The OTS is only a protocol engine for driving registered resources through a two-phase commit protocol.
You are responsible for building and registering the <code>Resource</code> objects which handle persistence and concurrency control, ensuring ACID properties for transactional application objects.
You need to register <code>Resources</code> at appropriate times, and ensure that a given <code>Resource</code> is only registered within a single transaction.
Programming at the raw OTS level is extremely basic.
You as the programmer are responsible for almost everything to do with transactions, including managing persistence and concurrency control on behalf of every transactional object.</p>
</div>
</div>
<div class="sect4">
<h5 id="_enhanced_ots_functionality"><a class="anchor" href="#_enhanced_ots_functionality"></a>Enhanced OTS functionality</h5>
<div class="paragraph">
<p>The OTS implementation of nested transactions is extremely limited, and can lead to the generation of heuristic results.
An example of such a result is when a sub-transaction coordinator discovers part of the way through committing that some resources cannot commit, but being unable to tell the committed resources to abort. Narayana allows nested transactions to execute a full two-phase commit protocol, which removes the possibility that some resources will comment while others roll back.</p>
</div>
<div class="paragraph">
<p>When resources are registered with a transaction, you have no control over the order in which these resources are invoked during the commit/abort protocol.
For example, if previously registered resources are replaced with newly registered resources, resources registered with a subtransaction are merged with the subtraction&#8217;s parent. Narayana provides an additional Resource subtype which you this level of control.</p>
</div>
</div>
<div class="sect4">
<h5 id="_advanced_api"><a class="anchor" href="#_advanced_api"></a>Advanced API</h5>
<div class="paragraph">
<p>The OTS does not provide any <code>Resource</code> implementations.
You are responsible for implementing these interfaces.
The interfaces defined within the OTS specification are too low-level for most application programmers.
Therefore, Narayana includes <em>Transactional Objects for Java (TXOJ)</em> , which makes use of the raw Common Object Services interfaces but provides a higher-level API for building transactional applications and frameworks.
This API automates much of the activities concerned with participating in an OTS transaction, freeing you to concentrate on application development, rather than transactions.</p>
</div>
<div class="paragraph">
<p>The architecture of the system is shown in Figure 2. The API interacts with the concurrency control and persistence services, and automatically registers appropriate resources for transactional objects.
These resources may also use the persistence and concurrency services.</p>
</div>
<div class="paragraph">
<p>Narayana exploits object-oriented techniques to provide you with a toolkit of Java classes which are inheritable by application classes, to obtain transactional properties.
These classes form a hierarchy, illustrated in <a href="#_jbossts_class_hierarchy">Narayana class hierarchy</a>.</p>
</div>
<div id="_jbossts_class_hierarchy" class="imageblock">
<div class="content">
<img src="images/jts-jbossts-class-hierarchy.png" alt="Narayana class hierarchy">
</div>
<div class="title">Figure 2. Narayana class hierarchy</div>
</div>
<div class="paragraph">
<p>Your main responsibilities are specifying the scope of transactions and setting appropriate locks within objects. Narayana guarantees that transactional objects will be registered with, and be driven by, the appropriate transactions.
Crash recovery mechanisms are invoked automatically in the event of failures.
When using the provided interfaces, you do not need to create or register <code>Resource</code> objects or call services controlling persistence or recovery.
If a transaction is nested, resources are automatically propagated to the transaction’s parent upon commit.</p>
</div>
<div class="paragraph">
<p>The design and implementation goal of Narayana was to provide a programming system for constructing fault-tolerant distributed applications.
Three system properties were considered highly important:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integration of Mechanisms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fault-tolerant distributed systems require a variety of system functions for naming, locating and invoking operations upon objects, as well as for concurrency control, error detection and recovery from failures. These mechanisms are integrated in a way that is easy for you to use.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flexibility</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mechanisms must be flexible, permitting implementation of application-specific enhancements, such as type-specific concurrency and recovery control, using system defaults.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Portability</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You need to be able to run Narayana on any ORB.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Narayana is implemented in Java and extensively uses the type-inheritance facilities provided by the language to provide user-defined objects with characteristics such as persistence and recoverability.</p>
</div>
</div>
<div class="sect4">
<h5 id="_narayana_and_the_ots_implementation"><a class="anchor" href="#_narayana_and_the_ots_implementation"></a>Narayana and the OTS implementation</h5>
<div class="paragraph">
<p>The OTS specification is written with flexibility in mind, to cope with different application requirements for transactions. Narayana supports all optional parts of the OTS specification.
In addition, if the specification allows functionality to be implemented in a variety of different ways, Narayana supports all possible implementations.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Narayana implementation of OTS specifications</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">OTS specification</th>
<th class="tableblock halign-left valign-top">Narayana default implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the transaction service chooses to restrict the availability of the transaction context, then it should raise the <code>Unavailable</code> exception.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana does not restrict the availability of the transaction context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">An implementation of the transaction service need not initialize the transaction context for every request.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana only initializes the transaction context if the interface supported by the target object extends the <code>TransactionalObject</code> interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">An implementation of the transaction service may restrict the ability for the <code>Coordinator</code>, <code>Terminator</code>, and <code>Control</code> objects to be transmitted or used in other execution environments to enable it to guarantee transaction integrity.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana does not impose restrictions on the propagation of these objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction service may restrict the termination of a transaction to the client that started it.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana allows the termination of a transaction by any client that uses the <code>Terminator</code> interface. In addition, Narayana does not impose restrictions when clients use the <code>Current</code> interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>TransactionFactory</code> is located using the <code>FactoryFinder</code> interface of the life-cycle service.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana provides multiple ways in which the <code>TransactionFactory</code> can be located.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A transaction service implementation may use the Event Service to report heuristic decisions.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana does not use the Event Service to report heuristic decisions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">An implementation of the transaction service does not need to support nested transactions.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana supports nested transactions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Synchronization</code> objects must be called whenever the transaction commits.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana allows <code>Synchronizations</code> to be called no matter what state the transaction terminates with.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A transaction service implementation is not required to support interposition.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana supports various types of interposition.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_thread_class"><a class="anchor" href="#_thread_class"></a>2.2.2. Thread class</h4>
<div class="paragraph">
<p>Narayana is fully multi-threaded and supports the OTS notion of allowing multiple threads to be active within a transaction, and for a thread to execute multiple transactions.
A thread can only be active within a single transaction at a time, however.
By default, if a thread is created within the scope of a transaction, the new thread is not associated with the transaction.
If the thread needs to be associated with the transaction, use the <code>resume</code> method of either the <code>AtomicTransaction</code> class or the <code>Current</code> class.</p>
</div>
<div class="paragraph">
<p>However, if newly created threads need to automatically inherit the transaction context of their parent, then they should extend the <code>OTS_Thread</code> class.</p>
</div>
<div class="listingblock">
<div class="title">Extending the <code class="class">OTS_Thread</code>class</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">OTS_Thread</span> <span class="directive">extends</span> <span class="predefined-type">Thread</span> {
    <span class="directive">protected</span> OTS_Thread();

    <span class="directive">public</span> <span class="type">void</span> terminate();

    <span class="directive">public</span> <span class="type">void</span> run();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Call the <code>run</code> method of <code>OTS_Thread</code> at the start of the application thread class&#8217;s <code>run</code> method.
Call <code>terminate</code> before you exit the body of the application thread’s <code>run</code> method.</p>
</div>
</div>
<div class="sect3">
<h4 id="_orb_portability_issues"><a class="anchor" href="#_orb_portability_issues"></a>2.2.3. ORB portability issues</h4>
<div class="paragraph">
<p>Although the CORBA specification is a standard, it is written so that an ORB can be implemented in multiple ways.
As such, writing portable client and server code can be difficult.
Because Narayana has been ported to most of the widely available ORBs, it includes a series of ORB Portability classes and macros.
If you write your application using these classes, it should be mostly portable between different ORBs.
These classes are described in the separate ORB Portability Manual.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_introduction_to_the_ots"><a class="anchor" href="#_introduction_to_the_ots"></a>2.3. Introduction to the OTS</h3>
<div class="paragraph">
<p>Basic Narayana programming involves using the OTS interfaces provided in the <code>CosTransactions</code> module, which is specified in <code>CosTransactions.idl</code>.
This chapter is based on the <code>OTS Specification1</code>, specifically with the aspects of OTS that are valuable for developing OTS applications using Narayana.
Where relevant, each section describes Narayana implementation decisions and runtime choices available to you.
These choices are also summarized at the end of this chapter.
Subsequent chapters illustrate using these interfaces to construct transactional applications.</p>
</div>
<div class="sect3">
<h4 id="_defining_the_ots"><a class="anchor" href="#_defining_the_ots"></a>2.3.1. Defining the OTS</h4>
<div class="paragraph">
<p>The raw <code>CosTransactions</code> interfaces reside in package <code>org.omg.CosTransactions</code>.
The Narayana implementations of these interfaces reside in package <code>com.arjuna.CosTransactions</code> and its sub-packages.</p>
</div>
<div class="paragraph">
<p>You can override many run-time decisions of Narayana Java properties specified at run-time.
The property names are mentioned in the <code>com.arjuna.ats.jts.common.Environment</code> class.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-ots_architecture.png" alt="jts ots architecture">
</div>
<div class="title">Figure 3. OTS architecture</div>
</div>
</div>
<div class="sect3">
<h4 id="_action_programming_models"><a class="anchor" href="#_action_programming_models"></a>2.3.2. Action programming models</h4>
<div class="paragraph">
<p>A client application program can manage a transaction using direct or indirect context management.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Indirect context management</em> means that an application uses the pseudo-object <code>Current</code>, provided by the Transaction Service, to associate the transaction context with the application thread of control.</p>
</li>
<li>
<p>For <em>direct context management</em>, an application manipulates the <code>Control</code> object and the other objects associated with the transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An object may require transactions to be either explicitly or implicitly propagated to its operations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Explicit propagation</em> means that an application propagates a transaction context by passing objects defined by the Transaction Service as explicit parameters.
Typically the object is the <code>PropagationContext</code> structure.</p>
</li>
<li>
<p><em>Implicit propagation</em> means that requests are implicitly associated with the client’s transaction, by sharing the client&#8217;s transaction context.
The context is transmitted to the objects without direct client intervention.
Implicit propagation depends on indirect context management, since it propagates the transaction context associated with the <code>Current</code> pseudo-object.
An object that supports implicit propagation should not receive any Transaction Service object as an explicit parameter.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A client may use one or both forms of context management, and may communicate with objects that use either method of transaction propagation.
This results in four ways in which client applications may communicate with transactional objects:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Direct Context Management/Explicit Propagation</dt>
<dd>
<p>The client application directly accesses the <code>Control</code> object, and the other objects which describe the state of the transaction.
To propagate the transaction to an object, the client must include the appropriate Transaction Service object as an explicit parameter of an operation.
Typically, the object is the <code>PropagationContext</code> structure.</p>
</dd>
<dt class="hdlist1">Indirect Context Management/Implicit Propagation</dt>
<dd>
<p>The client application uses operations on the <code>Current</code> pseudo-object to create and control its transactions.
When it issues requests on transactional objects, the transaction context associated with the current thread is implicitly propagated to the object.</p>
</dd>
<dt class="hdlist1">Indirect Context Management/Explicit Propagation</dt>
<dd>
<p>for an implicit model application to use explicit propagation, it can get access to the Control using the get_control operation on the <code>Current</code> pseudo object.
It can then use a Transaction Service object as an explicit parameter to a transactional object; for efficiency reasons this should be the PropagationContext structure, obtained by calling get_txcontext on the appropriate <code>Coordinator</code> reference.
This is explicit propagation.</p>
</dd>
<dt class="hdlist1">Direct Context Management/Implicit Propagation</dt>
<dd>
<p>A client that accesses the Transaction Service objects directly can use the <code>resume</code> pseudo-object operation to set the implicit transaction context associated with its thread.
This way, the client can invoke operations of an object that requires implicit propagation of the transaction context.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The main difference between direct and indirect context management is the effect on the invoking thread’s transaction context.
Indirect context management causes the thread’s transaction context to be modified automatically by the OTS.
For instance, if method <code>begin</code> is called, the thread’s notion of the current transaction is modified to the newly-created transaction.
When the transaction is terminated, the transaction previously associated with the thread, if one existed, is restored as the thread’s context.
This assumes that subtransactions are supported by the OTS implementation.</p>
</div>
<div class="paragraph">
<p>If you use direct management, no changes to the thread&#8217;s transaction context are made by the OTS, leaving the responsibility to you.</p>
</div>
</div>
<div class="sect3">
<h4 id="_interfaces"><a class="anchor" href="#_interfaces"></a>2.3.3. Interfaces</h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Interfaces</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Used by</th>
<th class="tableblock halign-left valign-top">Direct context mgmt</th>
<th class="tableblock halign-left valign-top">Indirect context mgmt</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a transaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction originator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Factory::create</code><br>
<code>Control::get_terminator</code><br>
<code>Control::get_coordinator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>begin</code><br>
<code>set_timeout</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Terminate a transaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction originator<br>
(implicit)<br>
All<br>
(explicit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Terminator::commit</code><br>
<code>Terminator::rollback</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>commit rollback</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rollback transaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Terminator::rollback_only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollback_only</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Propagation of transaction to server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declaration of method parameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TransactionalObject</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client control of transaction propagation to server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request parameters</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>get_control</code><br>
<code>suspend</code><br>
<code>resume</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register with a transaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Recoverable Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Coordinator::register_resource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Miscellaneous</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Coordinator::get_status</code><br>
<code>Coordinator::get_transaction_name</code><br>
<code>Coordinator::is_same_transaction</code><br>
<code>Coordinator::hash_transaction</code><br>
<code>get_status</code><br>
<code>get_transaction_name</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For clarity, sub-transaction operations are not shown</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_factory"><a class="anchor" href="#_transaction_factory"></a>2.3.4. Transaction factory</h4>
<div class="paragraph">
<p>The <code>TransactionFactory</code> interface allows the transaction originator to begin a top-level transaction.
sub-transactions must be created using the <code>begin</code> method of <code>Current</code>, or the <code>create_subtransaction</code> method of the parent’s <code>Coordinator</code>).
Operations on the factory and <code>Coordinator</code> to create new transactions use direct context management, and therefore do not modify the calling thread’s transaction context.</p>
</div>
<div class="paragraph">
<p>The <code>create</code> operation creates a new top-level transaction and returns its <code>Control</code> object, which you can use to manage or control participation in the new transaction.
Method <code>create</code> takes a parameter that is an application-specific timeout value, in seconds.
If the transaction does not complete before this timeout elapses, it is rolled back.
If the parameter is <code>0</code>, no application-specific timeout is established.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>sub-transactions do not have a timeout associated with them.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Transaction Service implementation allows the <code>TransactionFactory</code> to be a separate server from the application, shared by transactions clients, and which manages transactions on their behalf.
However, the specification also allows the TransactionFactory to be implemented by an object within each transactional client.
This is the default implementation used by Narayana, because it removes the need for a separate service to be available in order for transactional applications to execute, and therefore reduces a point of failure.</p>
</div>
<div class="paragraph">
<p>If your applications require a separate transaction manager, set the <code>OTS_TRANSACTION_MANAGER</code> environment variable to the value <code>YES</code>.
The system locates the transaction manager server in a manner specific to the ORB being used.
The server can be located in a number of ways.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Registration with a name server.</p>
</li>
<li>
<p>Addition to the ORB’s initial references, using a Narayana specific references file.</p>
</li>
<li>
<p>The ORB’s specific location mechanism, if applicable.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_ots_configuration_file_2"><a class="anchor" href="#_ots_configuration_file_2"></a>OTS configuration file</h5>
<div class="paragraph">
<p>Similar to the <code>resolve_initial_references</code>, Narayana supports an initial reference file where you can store references for specific services, and use these references at runtime.
The file, <code>CosServices.cfg</code>, consists of two columns, separated by a single space.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The service name, which is <code>TransactionService</code> in the case of the OTS server</p>
</li>
<li>
<p>The IOR</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>CosServices.cfg</code> is usually located in the <code>etc/</code> directory of the Narayana installation.
The OTS server automatically registers itself in this file, creating it if necessary, if you use the configuration file mechanism.
Stale information is also automatically removed.
The Transaction Service locates <code>CosServices.cfg</code> at runtime, using the <code>OrbPortabilityEnvironmentBean</code> properties <code>initialReferencesRoot</code> and <code>InitialReferencesFile</code>.
<code>initialReferencesRoot</code> names a directory, and defaults to the current working directory.
<code>initialReferencesFile</code> refers to a file within the <code>initialReferencesRoot</code>, and defaults to the name <code>CosServices.cfg</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_name_service_2"><a class="anchor" href="#_name_service_2"></a>Name service</h5>
<div class="paragraph">
<p>If your ORB supports a name service, and you configure Narayana to use it, the transaction manager is automatically registered with it.</p>
</div>
</div>
<div class="sect4">
<h5 id="_resolve_initial_references_2"><a class="anchor" href="#_resolve_initial_references_2"></a>resolve_initial_references</h5>
<div class="paragraph">
<p>Narayana does not support <code>resolve_initial_references</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_overriding_the_default_location_mechanisms"><a class="anchor" href="#_overriding_the_default_location_mechanisms"></a>Overriding the default location mechanisms</h5>
<div class="paragraph">
<p>You can override the default location mechanism with the <code>RESOLVE_SERVICE</code> property variable, which can have any of three possible values.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CONFIGURATION_FILE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the default option, and directs the system to use the <code>CosServices.cfg</code> file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NAME_SERVICE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana tries to use a name service to locate the transaction factory. If the ORB does not support the name service mechanism, Narayana throws an exception.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BIND_CONNECT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana uses the ORB-specific bind mechanism. If the ORB does not support such a mechanism, Narayana throws an exception.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If <code>RESOLVE_SERVICE</code> is specified when running the transaction factory, the factory registers itself with the specified resolution mechanism.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_timeouts"><a class="anchor" href="#_transaction_timeouts"></a>2.3.5. Transaction timeouts</h4>
<div class="paragraph">
<p>As of Narayana 4.5, transaction timeouts are unified across all transaction components and are controlled by <code>ArjunaCore</code>.
Refer to the <em>ArjunaCore Development Guide</em> for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_contexts"><a class="anchor" href="#_transaction_contexts"></a>2.3.6. Transaction contexts</h4>
<div class="paragraph">
<p>Transaction contexts are fundamental to the OTS architecture.
Each thread is associated with a context in one of three ways.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The thread has no associated transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A transaction ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The thread is associated with a transaction.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Contexts may be shared across multiple threads.
In the presence of nested transactions, a context remembers the stack of transactions started within the environment, so that the context of the thread can be restored to the state before the nested transaction started, when the nested transaction ends.
Threads most commonly use object <code>Current</code> to manipulate transactional information, which is represented by <code>Control</code> objects.
<code>Current</code> is the broker between a transaction and <code>Control</code> objects.</p>
</div>
<div class="paragraph">
<p>Your application can manage transaction contexts either directly or indirectly.
In the direct approach, the transaction originator issues a request to a <code>TransactionFactory</code> to begin a new top-level transaction.
The factory returns a <code>Control</code> object that enables both a <code>Terminator</code> interface and a <code>Coordinator</code> interface.
<code>Terminator</code> ends a transaction.
<code>Coordinator</code> associates a thread with a transaction, or begins a nested transaction.
You need to pass each interface as an explicit parameter in invocations of operations, because creating a transaction with them does not change a thread&#8217;s current context.
If you use the factory, and need to set the current context for a thread to the context which its control object returns, use the <code>resume</code> method of interface <code>Current</code>.</p>
</div>
<div class="listingblock">
<div class="title">Interfaces <code>Terminator</code>, <code>Coordinator</code>, and <code>Control</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C">interface Terminator {
    <span class="directive">void</span> commit (in boolean report_heuristics) raises (HeuristicMixed, HeuristicHazard);
    <span class="directive">void</span> rollback ();
}

interface Coordinator {
    Status get_status ();
    Status get_parent_status ();
    Status get_top_level_status ();

    RecoveryCoordinator register_resource (in Resource r) raises (Inactive);
    Control create_subtransaction () raises (SubtransactionsUnavailable, Inactive);

    <span class="directive">void</span> rollback_only () raises (Inactive);

    ...
}

interface Control {
    Terminator get_terminator () raises (Unavailable);
    Coordinator get_coordinator () raises (Unavailable);
}

interface TransactionFactory {
    Control create (in <span class="predefined-type">unsigned</span> <span class="predefined-type">long</span> time_out);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the factory creates a transaction, you can specify a timeout value in seconds.
If the transaction times out, it is subject to possible roll-back.
Set the timeout to <code>0</code> to disable application-specific timeout.</p>
</div>
<div class="paragraph">
<p>The <code>Current</code> interface handles implicit context management.
Implicit context management provides simplified transaction management functionality, and automatically creates nested transactions as required.
Transactions created using <code>Current</code> do not alter a thread’s current transaction context.</p>
</div>
<div class="listingblock">
<div class="title">Interface <code>Current</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C">interface Current : CORBA::Current {
    <span class="directive">void</span> begin () raises (SubtransactionsUnavailable);
    <span class="directive">void</span> commit (in boolean report_heuristics) raises (NoTransaction, HeuristicMixed, HeuristicHazard);
    <span class="directive">void</span> rollback () raises (NoTransaction);
    <span class="directive">void</span> rollback_only () raises (NoTransaction);
    ...
    Control get_control ();
    Control suspend ();
    <span class="directive">void</span> resume (in Control which) raises (InvalidControl);
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_nested_transactions_2"><a class="anchor" href="#_nested_transactions_2"></a>Nested transactions</h5>
<div class="paragraph">
<p>sub-transactions are a useful mechanism for two reasons:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">fault-tolerance</dt>
<dd>
<p>If a sub-transaction rolls back, the enclosing transaction does not also need to roll back.
This preserves as much of the work done so far, as possible.</p>
</dd>
<dt class="hdlist1">modularity</dt>
<dd>
<p>Indirect transaction management does not require special syntax for creating subtransactions.
Begin a transaction, and if another transaction is associated with the calling thread, the new transaction is nested within the existing one.
If you know that an object requires transactions, you can use them within the object.
If the object&#8217;s methods are invoked without a client transaction, the object&#8217;s transaction is top-level.
Otherwise, it is nested within the client&#8217;s transaction.
A client does not need to know whether an object is transactional.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The outermost transaction of the hierarchy formed by nested transactions is called the top-level transaction.
The inner components are called subtransactions.
Unlike top-level transactions, the commits of subtransactions depend upon the commit/rollback of the enclosing transactions.
Resources acquired within a sub-transaction should be inherited by parent transactions when the top-level transaction completes.
If a sub-transaction rolls back, it can release its resources and undo any changes to its inherited resources.</p>
</div>
<div class="paragraph">
<p>In the OTS, subtransactions behave differently from top-level transactions at commit time.
Top-level transactions undergo a two-phase commit protocol, but nested transactions do not actually perform a commit protocol themselves.
When a program commits a nested transaction, it only informs registered resources of its outcome.
If a resource cannot commit, an exception is thrown, and the OTS implementation can ignore the exception or roll back the sub-transaction.
You cannot roll back a sub-transaction if any resources have been informed that the transaction committed.</p>
</div>
</div>
<div class="sect4">
<h5 id="_transaction_propagation"><a class="anchor" href="#_transaction_propagation"></a>Transaction propagation</h5>
<div class="paragraph">
<p>The OTS supports both implicit and explicit propagation of transactional behavior.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implicit propagation means that an operation signature specifies no transactional behavior, and each invocation automatically sends transaction context associated with the calling thread.</p>
</li>
<li>
<p>Explicit propagation means that applications must define their own mechanism for propagating transactions.
This has the following features:</p>
<div class="ulist">
<ul>
<li>
<p>A client to control if its transaction is propagated with any operation invocation.</p>
</li>
<li>
<p>A client can invoke operations on both transactional and non-transactional objects within a transaction.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Transaction context management and transaction propagation are different things that may be controlled independently of each other.
Mixing of direct and indirect context management with implicit and explicit transaction propagation is supported.
Using implicit propagation requires cooperation from the ORB.
The client must send current context associated with the thread with any operation invocations, and the server must extract them before calling the targeted operation.</p>
</div>
<div class="paragraph">
<p>If you need implicit context propagation, ensure that Narayana is correctly initialized before you create objects.
Both client and server must agree to use implicit propagation.
To use implicit context propagation, your ORB needs to support filters or interceptors, or the <code>CosTSPortability</code> interface.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Implicit context propagation</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property variable <code>OTS_CONTEXT_PROP_MODE</code> set to <code>CONTEXT</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Interposition</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property variable <code>OTS_CONTEXT_PROP_MODE</code> set to <code>INTERPOSITION</code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Interposition is required to use the Narayana Advanced API.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_examples"><a class="anchor" href="#_examples"></a>Examples</h5>
<div class="exampleblock">
<div class="title">Example 2. Simple transactional client using direct context management and explicit transaction propagation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">{
  ...
  org.omg.CosTransactions.Control c;
  org.omg.CosTransactions.Terminator t;
  org.omg.CosTransactions.PropagationContext pgtx;

  <span class="comment">// create top-level action</span>
  c = transFact.create(<span class="integer">0</span>);

  pgtx = c.get_coordinator().get_txcontext();
  ...
  <span class="comment">// explicit propagation</span>
  trans_object.operation(arg, pgtx);
  ...
  <span class="comment">// get terminator</span>
  t = c.get_terminator();
  <span class="comment">// so it can be used to commit</span>
  t.commit(<span class="predefined-constant">false</span>);
  ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The next example rewrites the same program to use indirect context management and implicit propagation.
This example is considerably simpler, because the application only needs to start and either commit or abort actions.</p>
</div>
<div class="listingblock">
<div class="title">Indirect context management and implicit propagation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">{
   ...
   <span class="comment">// create new action</span>
   current.begin();
   ...
   <span class="comment">// implicit propagation</span>
   trans_object2.operation(arg);
   ...

   <span class="comment">// simple commit</span>
   current.commit(<span class="predefined-constant">false</span>);
   ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last example illustrates the flexibility of OTS by using both direct and indirect context management in conjunction with explicit and implicit transaction propagation.</p>
</div>
<div class="listingblock">
<div class="title">Direct and direct context management with explicitly and implicit propagation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">{
  ...
  org.omg.CosTransactions.Control c;
  org.omg.CosTransactions.Terminator t;
  org.omg.CosTransactions.PropagationContext pgtx;

  <span class="comment">// create top-level action</span>
  c = transFact.create(<span class="integer">0</span>);
  pgtx = c.get_coordinator().get_txcontext();

  <span class="comment">// set implicit context</span>
  current.resume(c);
  ...
  <span class="comment">// explicit propagation</span>
  trans_object.operation(arg, pgtx);
  <span class="comment">// implicit propagation</span>
  trans_object2.operation(arg);
  ...
  <span class="comment">// oops! rollback</span>
  current.rollback();
  ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_controls"><a class="anchor" href="#_transaction_controls"></a>2.3.7. Transaction controls</h4>
<div class="paragraph">
<p>The <code>Control</code> interface allows a program to explicitly manage or propagate a transaction context.
An object supporting the <code>Control</code> interface is associated with one specific transaction.
The <code>Control</code> interface supports two operations: <code>get_terminator</code> and <code>get_coordinator</code>.
<code>get_terminator</code> returns an instance of the <code>Terminator</code> interface.
<code>get_coordinator</code> returns an instance of the <code>Coordinator</code> interface.
Both of these methods throw the <code>Unavailable</code> exception if the <code>Control</code> cannot provide the requested object.
The OTS implementation can restrict the ability to use the <code>Terminator</code> and <code>Coordinator</code> in other execution environments or threads.
At a minimum, the creator must be able to use them.</p>
</div>
<div class="paragraph">
<p>Obtain the <code>Control</code> object for a transaction when it is created either by using either the <code>TransactionFactory</code> or <code>create_subtransaction</code> methods defined by the <code>Coordinator</code> interface.
Obtain a <code>Control</code> for the transaction associated with the current thread using the <code>get_control</code> or <code>suspend</code> methods defined by the <code>Current</code> interface.</p>
</div>
<div class="sect4">
<h5 id="_control_jbossts_specifics"><a class="anchor" href="#_control_jbossts_specifics"></a>Narayana specifics</h5>
<div class="paragraph">
<p>The transaction creator must be able to use its <code>Control</code>, but the OTS implementation decides whether other threads can use <code>Control</code>.
Narayana places no restrictions the users of the <code>Control</code>.</p>
</div>
<div class="paragraph">
<p>The OTS specification does not provide a means to indicate to the transaction system that information and objects associated with a given transaction can be purged from the system.
In Narayana, the <code>Current</code> interface destroys all information about a transaction when it terminates.
For that reason, do not use any <code>Control</code> references to the transaction after it commits or rolls back.</p>
</div>
<div class="paragraph">
<p>However, if the transaction is terminated using the <code>Terminator</code> interface, it is up to the programmer to signal that the transaction information is no longer required: this can be done using the <code>destroyControl</code> method of the OTS class in the <code>com.arjuna.CosTransactions</code> package.
Once the program has indicated that the transaction information is no longer required, the same restrictions on using <code>Control</code> references apply as described above.
If <code>destroyControl</code> is not called then transaction information will persist until garbage collected by the Java runtime.</p>
</div>
<div class="paragraph">
<p>In Narayana, you can propagate <code>Coordinators</code> and <code>Terminators</code> between execution environments.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_terminatorinterface"><a class="anchor" href="#_the_terminatorinterface"></a>2.3.8. The <code class="interface">Terminator</code>interface</h4>
<div class="paragraph">
<p>The <code>Terminator</code> interface supports <code>commit</code> and <code>rollback</code> operations.
Typically, the transaction originator uses these operations.
Each object supporting the <code>Terminator</code> interface is associated with a single transaction.
Direct context management via the <code>Terminator</code> interface does not change the client thread’s notion of the current transaction.</p>
</div>
<div class="paragraph">
<p>The <code>commit</code> operation attempts to commit the transaction.
To successfully commit, the transaction must not be marked <code>rollback only</code>, and all of its must participants agree to commit.
Otherwise, the <code>TRANSACTION_ROLLEDBACK</code> exception is thrown.
If the <code>report_heuristics</code> parameter is <code>true</code>, the Transaction Service reports inconsistent results using the <code>HeuristicMixed</code> and <code>HeuristicHazard</code> exceptions.</p>
</div>
<div class="paragraph">
<p>When a transaction is committed, the coordinator drives any registered <code>Resources</code> using their <code>prepare</code> or <code>commit</code> methods.
These Resources are responsible to ensure that any state changes to recoverable objects are made permanent, to guarantee the ACID properties.</p>
</div>
<div class="paragraph">
<p>When <code>rollback</code> is called, the registered <code>Resources</code> need to guarantee that all changes to recoverable objects made within the scope of the transaction, and its descendants, is undone.
All resources locked by the transaction are made available to other transactions, as appropriate to the degree of isolation the resources enforce.</p>
</div>
<div class="sect4">
<h5 id="_narayana_specifics"><a class="anchor" href="#_narayana_specifics"></a>Narayana specifics</h5>
<div class="paragraph">
<p>See <a href="#_control_jbossts_specifics">Narayana specifics</a> for how long <code>Terminator</code> references remain valid after a transaction terminates.</p>
</div>
<div class="paragraph">
<p>When a transaction is committing, it must make certain state changes persistent, so that it can recover if a failure occurs, and continue to commit, or rollback.
To guarantee ACID properties, flush these state changes to the persistence store implementation before the transaction proceeds to commit.
Otherwise, the application may assume that the transaction has committed, when the state changes may still volatile storage, and may be lost by a subsequent hardware failure.
By default, Narayana makes sure that such state changes are flushed.
However, these flushes can impose a significant performance penalty to the application.
To prevent transaction state flushes, set the <code>TRANSACTION_SYNC</code> variable to <code>OFF</code>.
Obviously, do this at your own risk.</p>
</div>
<div class="paragraph">
<p>When a transaction commits, if only a single resource is registered, the transaction manager does not need to perform the two-phase protocol.
A single phase commit is possible, and the outcome of the transaction is determined by the resource.
In a distributed environment, this optimization represents a significant performance improvement.
As such, Narayana defaults to performing single phase commit in this situation.
Override this behavior at runtime by setting the <code>COMMIT_ONE_PHASE</code> property variable to <code>NO</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_coordinator_interface"><a class="anchor" href="#_the_coordinator_interface"></a>2.3.9. The <code>Coordinator</code> interface</h4>
<div class="paragraph">
<p>The <code>Coordinator</code> interface is returned by the <code>get_coordinator</code> method of the <code>Control</code> interface.
It supports the operations resources need to participate in a transaction.
These participants are usually either recoverable objects or agents of recoverable objects, such as subordinate coordinators.
Each object supporting the <code>Coordinator</code> interface is associated with a single transaction.
Direct context management via the <code>Coordinator</code> interface does not change the client thread’s notion of the current transaction.
You can terminate transaction directly, through the <code>Terminator</code> interface.
In that case, trying to terminate the transaction a second time using <code>Current</code> causes an exception to be thrown for the second termination attempt.</p>
</div>
<div class="paragraph">
<p>The operations supported by the <code>Coordinator</code> interface of interest to application programmers are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Operations supported by the <code>Coordinator</code> interface</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>get_status</code><br>
<code>get_parent_status</code><br>
<code>get_top_level_status</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return the status of the associated transaction. At any given time a transaction can have one of the following status values representing its progress:</p>
<p class="tableblock"><code><strong>StatusActive</strong></code>
The transaction is currently running, and has not been asked to prepare or marked for rollback.<br>
<code><strong>StatusMarkedRollback</strong></code>
The transaction is marked for rollback.<br>
<code><strong>StatusPrepared</strong></code>
The transaction has been prepared, which means that all subordinates have responded <code>VoteCommit</code>.<br>
<code><strong>StatusCommitted</strong></code>
The transaction has committed. It is likely that heuristics exist. Otherwise, the transaction would have been destroyed and <code>StatusNoTransaction</code> returned.<br>
<code><strong>StatusRolledBack</strong></code>
The transaction has rolled back. It is likely that heuristics exist. Otherwise. the transaction would have been destroyed and StatusNoTransaction returned.<br>
<code><strong>StatusUnknown</strong></code>
The Transaction Service cannot determine the current status of the transaction. This is a transient condition, and a subsequent invocation should return a different status.<br>
<code><strong>StatusNoTransaction</strong></code>
No transaction is currently associated with the target object. This occurs after a transaction completes.<br>
<code><strong>StatusPreparing</strong></code>
The transaction is in the process of preparing and the final outcome is not known.<br>
<code><strong>StatusCommitting</strong></code>
The transaction is in the process of committing.<br>
<code><strong>StatusRollingBack</strong></code>
The transaction is in the process of rolling back.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is_same_transaction and others</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You can use these operations for transaction comparison. Resources may use these various operations to guarantee that they are registered only once with a specific transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hash_transaction</code><br>
<code>hash_top_level_tran</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns a hash code for the specified transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>register_resource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registers the specified Resource as a participant in the transaction. The <code>Inactive</code> exception is raised if the transaction is already prepared. The <code>TRANSACTION_ROLLEDBACK</code> exception is raised if the transaction is marked <code>rollback only</code>. If the <code>Resource</code> is a <code>SubtransactionAwareResource</code> and the transaction is a sub-transaction, this operation registers the resource with this transaction and indirectly with the top-level transaction when the sub-transaction’s ancestors commit. Otherwise, the resource is only registered with the current transaction. This operation returns a <code>RecoveryCoordinator</code> which this <code>Resource</code> can use during recovery. No ordering of registered Resources is implied by this operation. If <code>A</code> is registered after <code>B</code>, the OTS can operate on them in any order when the transaction terminates. Therefore, do not assume such an ordering exists in your implementation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>register_subtran_aware</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registers the specified sub-transaction-aware resource with the current transaction, so that it know when the sub-transaction commits or rolls back. This method cannot register the resource as a participant in the top-level transaction. The <code>NotSubtransaction</code> exception is raised if the current transaction is not a sub-transaction. As with <code>register_resource</code>, no ordering is implied by this operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>register_synchronization</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registers the <code>Synchronization</code> object with the transaction so that will be invoked before <code>prepare</code> and after the transaction completes. <code>Synchronizations</code> can only be associated with top-level transactions, and the <code>SynchronizationsUnavailable</code> exception is raised if you try to register a <code>Synchronization</code> with a sub-transaction. As with <code>register_resource</code>, no ordering is implied by this operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollback_only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Marks the transaction so that the only possible outcome is for it to rollback. The Inactive exception is raised if the transaction has already been prepared/completed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>create_subtransaction</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A new sub-transaction is created. Its parent is the current transaction. The <code>Inactive</code> exception is raised if the current transaction has already been prepared or completed. If you configure the Transaction Service without sub-transaction support, the <code>SubtransactionsUnavailable</code> exception is raised.</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_narayana_specifics_2"><a class="anchor" href="#_narayana_specifics_2"></a>Narayana specifics</h5>
<div class="paragraph">
<p>See <a href="#_control_jbossts_specifics">Narayana specifics</a> to control how long <code>Coordinator</code> references remain valid after a transaction terminates.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To disable subtransactions, set set the <code>OTS_SUPPORT_SUBTRANSACTIONS</code> property variable to <code>NO</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_heuristics"><a class="anchor" href="#_heuristics"></a>2.3.10. Heuristics</h4>
<div class="paragraph">
<p>The OTS permits individual resources to make heuristic decisions.
<em>Heuristic</em> decisions are unilateral decisions made by one or more participants to commit or abort the transaction, without waiting for the consensus decision from the transaction service.
Use heuristic decisions with care and only in exceptional circumstances, because they can lead to a loss of integrity in the system.
If a participant makes a heuristic decision, an appropriate exception is raised during commit or abort processing.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Possible heuristic outcomes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HeuristicRollback</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Raised on an attempt to commit, to indicate that the resource already unilaterally rolled back the transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HeuristicCommit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Raised on an attempt to roll back, to indicate that the resource already unilaterally committed the transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HeuristicMixed</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates that a heuristic decision has been made. Some updates committed while others rolled back.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HeuristicHazard</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates that a heuristic decision may have been made, and the outcome of some of the updates is unknown. For those updates which are known, they either all committed or all rolled back.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>HeuristicMixed takes priority over HeuristicHazard.
Heuristic decisions are only reported back to the originator if the <code>report_heuristics</code> argument is set to <code>true</code> when you invoke the commit operation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_current"><a class="anchor" href="#_current"></a>2.3.11. <code>Current</code></h4>
<div class="paragraph">
<p>The <code>Current</code> interface defines operations that allow a client to explicitly manage the association between threads and transactions, using indirect context management.
It defines operations that simplify the use of the Transaction Service.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Methods of <code>Current</code></caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>begin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creates a new transaction and associates it with the current thread. If the client thread is currently associated with a transaction, and the OTS implementation supported nested transactions, the new transaction becomes a sub-transaction of that transaction. Otherwise, the new transaction is a top-level transaction. If the OTS implementation does not support nested transactions, the <code>SubtransactionsUnavailable</code> exception is thrown. The thread’s notion of the current context is modified to be this transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>commit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commits the transaction. If the client thread does not have permission to commit the transaction, the standard exception <code>NO_PERMISSION</code> is raised. The effect is the same as performing the <code>commit</code> operation on the corresponding <code>Terminator</code> object. The client thread&#8217;s transaction context is returned to its state before the <code>begin</code> request was initiated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollback</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rolls back the transaction. If the client thread does not have permission to terminate the transaction, the standard exception <code>NO_PERMISSION</code> is raised. The effect is the same as performing the <code>rollback</code> operation on the corresponding <code>Terminator</code> object. The client thread&#8217;s transaction context is returned to its state before the <code>begin</code> request was initiated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollback_only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limits the transaction&#8217;s outcome to rollback only. If the transaction has already been terminated, or is in the process of terminating, an appropriate exception is thrown.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>get_status</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the status of the current transaction, or exception <code>StatusNoTransaction</code> if no transaction is associated with the thread.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>set_timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modifies the timeout associated with top-level transactions for subsequent <code>begin</code> requests, for this thread only. Subsequent transactions are subject to being rolled back if they do not complete before the specified number of seconds elapses. Default timeout values for transactions without explicitly-set timeouts are implementation-dependent. Narayana uses a value of <code>0</code>, which results in transactions never timing out. There is no interface in the OTS for obtaining the current timeout associated with a thread. However, Narayana provides additional support for this. See <a href="#_current_jbossts_specific">Narayana specifics</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>get_control</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtains a <code>Control</code> object representing the current transaction. If the client thread is not associated with a transaction, a null object reference is returned. The operation is not dependent on the state of the transaction. It does not raise the <code>TRANSACTION_ROLLEDBACK</code> exception.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>suspend</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtains an object representing a transaction&#8217;s context. If the client thread is not associated with a transaction, a null object reference is returned. You can pass this object to the <code>resume</code> operation to re-establish this context in a thread. The operation is not dependent on the state of the transaction. It does not raise the <code>TRANSACTION_ROLLEDBACK</code> exception. When this call returns, the current thread has no transaction context associated with it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resume</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Associates the client thread with a transaction. If the parameter is a null object reference, the client thread becomes associated with no transaction. The thread loses association with any previous transactions.</p></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="images/jts-top_level_transaction_current.png" alt="jts top level transaction current">
</div>
<div class="title">Figure 4. Creation of a top-level transaction using <code>Current</code></div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-subtransaction_current.png" alt="jts subtransaction current">
</div>
<div class="title">Figure 5. Creation of a transaction using <code>Current</code></div>
</div>
<div class="sect4">
<h5 id="_current_jbossts_specific"><a class="anchor" href="#_current_jbossts_specific"></a>Narayana specifics</h5>
<div class="paragraph">
<p>Ideally, you should Obtain <code>Current</code> by using the life-cycle service factory finder.
However, very few ORBs support this. Narayana provides method <code>get_current</code> of <code>Current</code> for this purpose.
This class hides any ORB-specific mechanisms required for obtaining <code>Current</code>.</p>
</div>
<div class="paragraph">
<p>If no timeout value is associated with <code>Current</code>, Narayana associates no timeout with the transaction.
The current OTS specification does not provide a means whereby the timeout associated with transaction creation can be obtained.
However, Narayana <code>Current</code> supports a <code>get_timeout</code> method.</p>
</div>
<div class="paragraph">
<p>By default, the Narayana implementation of <code>Current</code> does not use a separate <code>TransactionFactory</code> server when creating new top-level transactions.
Each transactional client has a <code>TransactionFactory</code> co-located with it.
Override this by setting the <code>OTS_TRANSACTION_MANAGER</code> variable to <code>YES</code>.</p>
</div>
<div class="paragraph">
<p>The transaction factory is located in the <code>bin/</code> directory of the Narayana distribution.
Start it by executing the OTS script.
<code>Current</code> locates the factory in a manner specific to the ORB: using the name service, through <code>resolve_initial_references</code>, or via the <code>CosServices.cfg</code> file.
The <code>CosServices.cfg</code> file is similar to <code>resolve_initial_references</code>, and is automatically updated when the transaction factory is started on a particular machine.
Copy the file to each Narayana instance which needs to share the same transaction factory.</p>
</div>
<div class="paragraph">
<p>If you do not need sub-transaction support, set the <code>OTS_SUPPORT_SUBTRANSACTIONS</code> property variable to <code>NO</code>.
The <code>setCheckedAction</code> method overrides the <code>CheckedAction</code> implementation associated with each transaction created by the thread.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_resource"><a class="anchor" href="#_resource"></a>2.3.12. Resource</h4>
<div class="paragraph">
<p>The Transaction Service uses a two-phase commit protocol to complete a top-level transaction with each registered resource.</p>
</div>
<div class="listingblock">
<div class="title">Completing a top-level transaction</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">Resource</span> {
    Vote prepare ();
    <span class="type">void</span> rollback () raises (HeuristicCommit, HeuristicMixed, HeuristicHazard);
    <span class="type">void</span> commit () raises (NotPrepared, HeuristicRollback, HeuristicMixed, HeuristicHazard);
    <span class="type">void</span> commit_one_phase () raises (HeuristicRollback, HeuristicMixed, HeuristicHazard);
    <span class="type">void</span> forget ();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Resource</code> interface defines the operations invoked by the transaction service.
Each <code>Resource</code> object is implicitly associated with a single top-level transaction.
Do not register a <code>Resource</code> with the same transaction more than once.
When you tell a <code>Resource</code> to <code>prepare</code>, <code>commit</code>, or <code>abort</code>, it must do so on behalf of a specific transaction.
However, the <code>Resource</code> methods do not specify the transaction identity.
It is implicit, since a <code>Resource</code> can only be registered with a single transaction.</p>
</div>
<div class="paragraph">
<p>Transactional objects must use the <code>register_resource</code> method to register objects supporting the <code>Resource</code> interface with the current transaction.
An object supporting the <code>Coordinator</code> interface is either passed as a parameter in the case of explicit propagation, or retrieved using operations on the <code>Current</code> interface in the case of implicit propagation.
If the transaction is nested, the <code>Resource</code> is not informed of the sub-transaction’s completion, and is registered with its parent upon commit.</p>
</div>
<div class="paragraph">
<p>This example assumes that transactions are only nested two levels deep, for simplicity.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-resource_nested_transactions.png" alt="jts resource nested transactions">
</div>
<div class="title">Figure 6. <code>Resource</code> and nested transactions</div>
</div>
<div class="paragraph">
<p>Do not register a given <code>Resource</code> with the same transaction more than once, or it will receive multiple termination calls.
When a <code>Resource</code> is directed to <code>prepare</code>, <code>commit</code>, or <code>abort</code>, it needs to link these actions to a specific transaction.
Because <code>Resource</code> methods do not specify the transaction identity, but can only be associated with a single transaction, you can infer the identity.</p>
</div>
<div class="paragraph">
<p>A single <code>Resource</code> or group of <code>Resources</code> guarantees the ACID properties for the recoverable object they represent.
A Resource&#8217;s work depends on the phase of its transaction.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">prepare</dt>
<dd>
<p>If none of the persistent data associated with the resource is modified by the transaction, the Resource can return <code>VoteReadOnly</code> and forget about the transaction.
It does not need to know the outcome of the second phase of the commit protocol, since it hasn&#8217;t made any changes.</p>
<div class="paragraph">
<p>If the resource can write, or has already written, all the data needed to commit the transaction to stable storage, as well as an indication that it has prepared the transaction, it can return <code>VoteCommit</code>.
After receiving this response, the Transaction Service either commits or rolls back.
To support recovery, the resource should store the <code>RecoveryCoordinator</code> reference in stable storage.</p>
</div>
<div class="paragraph">
<p>The resource can return <code>VoteRollback</code> under any circumstances.
After returning this response, the resource can forget the transaction.</p>
</div>
<div class="paragraph">
<p>The <code>Resource</code> reports inconsistent outcomes using the <code>HeuristicMixed</code> and <code>HeuristicHazard</code> exceptions.
One example is that a <code>Resource</code> reports that it can commit and later decides to roll back.
Heuristic decisions must be made persistent and remembered by the <code>Resource</code> until the transaction coordinator issues the <code>forget</code> method.
This method tells the <code>Resource</code> that the heuristic decision has been noted, and possibly resolved.</p>
</div>
</dd>
<dt class="hdlist1">rollback</dt>
<dd>
<p>The resource should undo any changes made as part of the transaction.
Heuristic exceptions can be used to report heuristic decisions related to the resource.
If a heuristic exception is raised, the resource must remember this outcome until the forget operation is performed so that it can return the same outcome in case rollback is performed again.
Otherwise, the resource can forget the transaction.</p>
</dd>
<dt class="hdlist1">commit</dt>
<dd>
<p>If necessary, the resource should commit all changes made as part of this transaction.
As with <code>rollback</code>, it can raise heuristic exceptions.
The <code>NotPrepared</code> exception is raised if the resource has not been prepared.</p>
</dd>
<dt class="hdlist1">commit_one_phase</dt>
<dd>
<p>Since there can be only a single resource, the <code>HeuristicHazard</code> exception reports heuristic decisions related to that resource.</p>
</dd>
<dt class="hdlist1">forget</dt>
<dd>
<p>Performed after the resource raises a heuristic exception.
After the coordinator determines that the heuristic situation is addressed, it issues <code>forget</code> on the resource.
The resource can forget all knowledge of the transaction.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_subtransactionawareresource"><a class="anchor" href="#_subtransactionawareresource"></a>2.3.13. SubtransactionAwareResource</h4>
<div class="paragraph">
<p>Recoverable objects that need to participate within a nested transaction may support the <code>SubtransactionAwareResource</code> interface, a specialization of the <code>Resource</code> interface.</p>
</div>
<div class="listingblock">
<div class="title">Interface <code>SubtransactionAwareResource</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C">interface SubtransactionAwareResource : Resource {
    <span class="directive">void</span> commit_subtransaction (in Coordinator parent);
    <span class="directive">void</span> rollback_subtransaction ();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A recoverable object is only informed of the completion of a nested transaction if it registers a <code>SubtransactionAwareResource</code>.
Register the object with either the <code>register_resource</code> of the <code>Coordinator</code> interface, or the <code>register_subtran_aware</code> method of the <code>Current</code> interface.
A recoverable object registers Resources to participate within the completion of top-level transactions, and <code>SubtransactionAwareResources</code> keep track of the completion of subtransactions.
The <code>commit_subtransaction</code> method uses a reference to the parent transaction to allow sub-transaction resources to register with these transactions.</p>
</div>
<div class="paragraph">
<p><code>SubtransactionAwareResources</code> find out about the completion of a transaction after it terminates.
They cannot affect the outcome of the transaction.
Different OTS implementations deal with exceptions raised by <code>SubtransactionAwareResources</code> in implementation-specific ways.</p>
</div>
<div class="paragraph">
<p>Use method <code>register_resource</code> or method <code>register_subtran_aware</code> to register a <code>SubtransactionAwareResource</code> with a transaction using.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">register_resource</dt>
<dd>
<p>If the transaction is a sub-transaction, the resource is informed of its completion, and automatically registered with the sub-transaction’s parent if the parent commits.</p>
</dd>
<dt class="hdlist1">register_subtran_aware</dt>
<dd>
<p>If the transaction is not a sub-transaction, an exception is thrown.
Otherwise, the resource is informed when the sub-transaction completes.
Unlike <code>register_resource</code>, the resource is not propagated to the sub-transaction’s parent if the transaction commits.
If you need this propagation, re-register using the supplied parent parameter.</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-register_subtran_aware.png" alt="jts register subtran aware">
</div>
<div class="title">Figure 7. Method <code>register_subtran_aware</code></div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-register_resource.png" alt="jts register resource">
</div>
<div class="title">Figure 8. Method <code>register_resource</code></div>
</div>
<div class="paragraph">
<p>In either case, the resource cannot affect the outcome of the transaction completion.
It can only act on the transaction&#8217;s decision, after the decision is made.
However, if the resource cannot respond appropriately, it can raise an exception.
Thee OTS handles these exceptions in an implementation-specific way.</p>
</div>
<div class="sect4">
<h5 id="_narayana_specifics_3"><a class="anchor" href="#_narayana_specifics_3"></a>Narayana specifics</h5>
<div class="paragraph">
<p>A <code>SubtransactionAwareResource</code> which raises an exception to the commitment of a transaction may create inconsistencies within the transaction if other <code>SubtransactionAwareResources</code> think the transaction committed.
To prevent this possibility of inconsistency, Narayana forces the enclosing transaction to abort if an exception is raised.</p>
</div>
<div class="paragraph">
<p>Narayana also provides extended sub-transaction aware resources to overcome this, and other problems.
See Section for further details.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_synchronization_interface"><a class="anchor" href="#_the_synchronization_interface"></a>2.3.14. The <code>Synchronization</code> interface</h4>
<div class="paragraph">
<p>If an object needs notification before a transaction commits, it can register an object which is an implements the <code>Synchronization</code> interface, using the <code>register_synchronization</code> operation of the <code>Coordinator</code> interface.
<code>Synchronizations</code> flush volatile state data to a recoverable object or database before the transaction commits.
You can only associate <code>Synchronizations</code> with top-level transactions.
If you try to associate a <code>Synchronization</code> to a nested transaction, an exception is thrown.
Each object supporting the <code>Synchronization</code> interface is associated with a single top-level transaction.</p>
</div>
<div class="listingblock">
<div class="title"><code>Synchronizations</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C">interface Synchronization : TransactionalObject {
    <span class="directive">void</span> before_completion ();
    <span class="directive">void</span> after_completion (in Status s);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The method <code>before_completion</code> is called before the two-phase commit protocol starts, and <code>after_completion</code> is called after the protocol completes.
The final status of the transaction is given as a parameter to <code>after_completion</code>. If <code>before_completion</code> raises an exception, the transaction rolls back.
Any exceptions thrown by <code>after_completion</code> do not affect the transaction outcome.</p>
</div>
<div class="paragraph">
<p>The OTS only requires <code>Synchronizations</code> to be invoked if the transaction commits.
If it rolls back, registered <code>Synchronizations</code> are not informed.</p>
</div>
<div class="paragraph">
<p>Given the previous description of <code>Control</code>, <code>Resource</code>, <code>SubtransactionAwareResource</code>, and <code>Synchronization</code>, the following UML relationship diagram can be drawn:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-interface_relationship.png" alt="Relationship between `Control`" width="`Resource`" height="`SubtransactionAwareResource`">
</div>
<div class="title">Figure 9. Relationship between <code>Control</code>, <code>Resource</code>, <code>SubtransactionAwareResource</code>, and <code>Synchronization</code></div>
</div>
<div class="sect4">
<h5 id="_narayana_specifics_4"><a class="anchor" href="#_narayana_specifics_4"></a>Narayana specifics</h5>
<div class="paragraph">
<p><code>Synchronizations</code> must be called before the top-level transaction commit protocol starts, and after it completes.
By default, if the transaction is instructed to roll back, the <code>Synchronizations</code> associated with the transaction is not contacted.
To override this, and call <code>Synchronizations</code> regardless of the transaction&#8217;s outcome, set the <code>OTS_SUPPORT_ROLLBACK_SYNC</code> property variable to <code>YES</code>.</p>
</div>
<div class="paragraph">
<p>If you use distributed transactions and interposition, a local proxy for the top-level transaction coordinator is created for any recipient of the transaction context.
The proxy looks like a <code>Resource</code> or <code>SubtransactionAwareResource</code>, and registers itself as such with the actual top-level transaction coordinator.
The local recipient uses it to register <code>Resources</code> and <code>Synchronizations</code> locally.</p>
</div>
<div class="paragraph">
<p>The local proxy can affect how <code>Synchronizations</code> are invoked during top-level transaction commit.
Without the proxy, all <code>Synchronizations</code> are invoked before any Resource or <code>SubtransactionAwareResource</code> objects are processed.
However, with interposition, only those <code>Synchronizations</code> registered locally to the transaction coordinator are called.
<code>Synchronizations</code> registered with remote participants are only called when the interposed proxy is invoked.
The local proxy may only be invoked after locally-registered Resource or <code>SubtransactionAwareResource</code> objects are invoked.
With the <code>OTS_SUPPORT_INTERPOSED_SYNCHRONIZATION</code> property variable set to <code>YES</code>, all <code>Synchronizations</code> are invoked before any Resource or <code>SubtransactionAwareResource</code>, no matter where they are registered.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_transactions_and_registered_resources"><a class="anchor" href="#_transactions_and_registered_resources"></a>2.3.15. Transactions and registered resources</h4>
<div class="imageblock">
<div class="content">
<img src="images/jts-control_and_resources.png" alt="Relationship between a transaction `Control` and the resources registered with it">
</div>
<div class="title">Figure 10. Relationship between a transaction <code>Control</code> and the resources registered with it</div>
</div>
<div class="paragraph">
<p>In <a href="#_subtransaction_commit">Sub-transaction commit</a>, a sub-transaction with both <code>Resource</code> and <code>SubtransactionAwareResource</code> objects commits.
The <code>SubtransactionAwareResources</code> were registered using <code>register_subtran_aware</code>.
The <code>Resources</code> do not know the sub-transaction terminated, but the <code>SubtransactionAwareResources</code> do.
Only the <code>Resources</code> are automatically propagated to the parent transaction.</p>
</div>
<div id="_subtransaction_commit" class="imageblock">
<div class="content">
<img src="images/jts-sub-transaction_commit.png" alt="jts sub transaction commit">
</div>
<div class="title">Figure 11. Sub-transaction commit</div>
</div>
<div class="paragraph">
<p><a href="#_subtransaction_rollback">Sub-transaction rollback</a> illustrates the impact of a sub-transaction rolling back.
Any registered resources are discarded, and all <code>SubtransactionAwareResources</code> are informed of the transaction outcome.</p>
</div>
<div id="_subtransaction_rollback" class="imageblock">
<div class="content">
<img src="images/jts-sub-transaction_rollback.png" alt="jts sub transaction rollback">
</div>
<div class="title">Figure 12. Sub-transaction rollback</div>
</div>
<div class="paragraph">
<p><a href="#_top_level_commit">Top-level commit</a> shows the activity diagram for committing a top-level transaction.
sub-transactions within the top-level transaction which have also successfully committed propagate <code>SubtransactionAwareResources</code> to the top-level transaction.
These <code>SubtransactionAwareResources</code> then participate within the two-phase commit protocol.
Any registered <code>Synchronizations</code> are contacted before <code>prepare</code> is called.
Because of indirect context management, when the transaction commits, the transaction service changes the invoking thread’s transaction context.</p>
</div>
<div id="_top_level_commit" class="imageblock">
<div class="content">
<img src="images/jts-top-level-commit.png" alt="jts top level commit">
</div>
<div class="title">Figure 13. Top-level commit</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-top-level-rollback.png" alt="Top-level rollback">
</div>
<div class="title">Figure 14. Top-level rollback</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_transactionalobject_interface"><a class="anchor" href="#_the_transactionalobject_interface"></a>2.3.16. The <code>TransactionalObject</code> interface</h4>
<div class="paragraph">
<p>The <code>TransactionalObject</code> interface indicates to an object that it is transactional.
By supporting this interface, an object indicates that it wants to associate the transaction context associated with the client thread with all operations on its interface.
The <code>TransactionalObject</code> interface defines no operations.</p>
</div>
<div class="paragraph">
<p>OTS specifications do not require an OTS to initialize the transaction context of every request handler.
It is only a requirement if the interface supported by the target object is derived from <code>TransactionalObject</code>.
Otherwise, the initial transaction context of the thread is undefined.
A transaction service implementation can raise the <code>TRANSACTION_REQUIRED</code> exception if a <code>TransactionalObject</code> is invoked outside the scope of a transaction.</p>
</div>
<div class="paragraph">
<p>In a single-address space application, transaction contexts are implicitly shared between clients and objects, regardless of whether or not the objects support the <code>TransactionalObject</code> interface.
To preserve distribution transparency, where implicit transaction propagation is supported, you can direct Narayana to always propagate transaction contexts to objects.
The default is only to propagate if the object is a <code>TransactionalObject</code>.
Set the <code>OTS_ALWAYS_PROPAGATE_CONTEXT</code> property variable to <code>NO</code> to override this behavior.</p>
</div>
<div class="paragraph">
<p>By default, Narayana does not require objects which support the <code>TransactionalObject</code> interface to invoked within the scope of a transaction.
The object determines whether it should be invoked within a transaction.
If so, it must throw the <code>TransactionRequired</code> exception.
Override this default by setting the <code>OTS_NEED_TRAN_CONTEXT</code> shell environment variable to <code>YES</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Make sure that the settings for <code>OTS_ALWAYS_PROPAGATE_CONTEXT</code> and <code>OTS_NEED_TRAN_CONTEXT</code> are identical at the client and the server.
If they are not identical at both ends, your application may terminate abnormally.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_interposition"><a class="anchor" href="#_interposition"></a>2.3.17. Interposition</h4>
<div class="paragraph">
<p>OTS objects supporting interfaces such as the <code>Control</code> interface are standard CORBA objects.
When an interface is passed as a parameter in an operation call to a remote server, only an object reference is passed.
This ensures that any operations that the remote server performs on the interface are correctly performed on the real object.
However, this can have substantial penalties for the application, because of the overhead of remote invocation.
For example, when the server registers a <code>Resource</code> with the current transaction, the invocation might be remote to the originator of the transaction.</p>
</div>
<div class="paragraph">
<p>To avoid this overhead, your OTS may support interposition.
This permits a server to create a local control object which acts as a local coordinator, and fields registration requests that would normally be passed back to the originator.
This coordinator must register itself with the original coordinator, so that it can correctly participate in the commit protocol.
Interposed coordinators form a tree structure with their parent coordinators.</p>
</div>
<div class="paragraph">
<p>To use interposition, ensure that Narayana is correctly initialized before creating objects.
Also, the client and server must both use interposition.
Your ORB must support filters or interceptors, or the <code>CosTSPortability</code> interface, since interposition requires the use of implicit transaction propagation.
To use interposition, set the <code>OTS_CONTEXT_PROP_MODE</code> property variable to <code>INTERPOSITION</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Interposition is not required if you use the Narayana advanced API.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_recoverycoordinator"><a class="anchor" href="#_recoverycoordinator"></a>2.3.18. RecoveryCoordinator</h4>
<div class="paragraph">
<p>A reference to a <code>RecoveryCoordinator</code> is returned as a result of successfully calling <code>register_resource</code> on the transaction&#8217;s <code>Coordinator</code>.
Each <code>RecoveryCoordinator</code> is implicitly associated with a single <code>Resource</code>.
It can drive the <code>Resource</code> through recovery procedures in the event of a failure which occurs during the transaction.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-resource-and-recoverycoordinator.png" alt="jts resource and recoverycoordinator">
</div>
<div class="title">Figure 15. <code>Resource</code> and <code>RecoveryCoordinator</code></div>
</div>
</div>
<div class="sect3">
<h4 id="_checked_transaction_behavior"><a class="anchor" href="#_checked_transaction_behavior"></a>2.3.19. Checked transaction behavior</h4>
<div class="paragraph">
<p>The OTS supports both checked and unchecked transaction behavior.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A transaction will not commit until all transactional objects involved in the transaction have completed their transactional requests.</p>
</li>
<li>
<p>Only the transaction originator can commit the transaction</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Checked transactional behavior is typical transaction behavior, and is widely implemented.
Checked behavior requires implicit propagation, because explicit propagation prevents the OTS from tracking which objects are involved in the transaction.</p>
</div>
<div class="paragraph">
<p>Unchecked behavior allows you to implement relaxed models of atomicity.
Any use of explicit propagation implies the possibility of unchecked behavior, since you as the programmer are in control of the behavior.
Even if you use implicit propagation, a server may unilaterally abort or commit the transaction using the <code>Current</code> interface, causing unchecked behavior.</p>
</div>
<div class="paragraph">
<p>Some OTS implementations enforce checked behavior for the transactions they support, to provide an extra level of transaction integrity.
The checks ensure that all transactional requests made by the application complete their processing before the transaction is committed.
A checked Transaction Service guarantees that commit fails unless all transactional objects involved in the transaction complete the processing of their transactional requests.
Rolling back the transaction does not require such as check, since all outstanding transactional activities will eventually roll back if they are not directed to commit.</p>
</div>
<div class="paragraph">
<p>There are many possible implementations of checking in a Transaction Service.
One provides equivalent function to that provided by the request and response inter-process communication models defined by X/Open.
The X/Open Transaction Service model of checking widely implemented.
It describes the transaction integrity guarantees provided by many existing transaction systems.
These transaction systems provide the same level of transaction integrity for object-based applications, by providing a Transaction Service interface that implements the X/Open checks.</p>
</div>
<div class="paragraph">
<p>In X/Open, completion of the processing of a request means that the object has completed execution of its method and replied to the request.
The level of transaction integrity provided by a Transaction Service implementing the X/Open model provides equivalent function to that provided by the XATMI and TxRPC interfaces defined by X/Open for transactional applications.
X/Open DTP Transaction Managers are examples of transaction management functions that implement checked transaction behavior.</p>
</div>
<div class="paragraph">
<p>This implementation of checked behavior depends on implicit transaction propagation.
When implicit propagation is used, the objects involved in a transaction at any given time form a tree, called the request tree for the transaction.
The beginner of the transaction is the root of the tree.
Requests add nodes to the tree, and replies remove the replying node from the tree.
Synchronous requests, or the checks described below for deferred synchronous requests, ensure that the tree collapses to a single node before commit is issued.</p>
</div>
<div class="paragraph">
<p>If a transaction uses explicit propagation, the Transaction Service has no way to know which objects are or will be involved in the transaction.
Therefore, the use of explicit propagation is not permitted by a Transaction Service implementation that enforces X/Open-style checked behavior.</p>
</div>
<div class="paragraph">
<p>Applications that use synchronous requests exhibit checked behavior.
If your application uses deferred synchronous requests, all clients and objects need to be under the control of a checking Transaction Service.
In that case, the Transaction Service can enforce checked behavior, by applying a <code>reply</code> check and a <code>committed</code> check.
The Transaction Service must also apply a <code>resume</code> check, so that the transaction is only resumed by applications in the correct part of the request tree.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reply</code> check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Before an object replies to a transactional request, a check is made to ensure that the object has received replies to all the deferred synchronous requests that propagated the transaction in the original request. If this condition is not met, an exception is raised and the transaction is marked as rollback-only. A Transaction Service may check that a reply is issued within the context of the transaction associated with the request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>commit</code> check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Before a commit can proceed, a check is made to ensure that the commit request for the transaction is being issued from the same execution environment that created the transaction, and that the client issuing commit has received replies to all the deferred synchronous requests it made that propagated the transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resume</code> check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Before a client or object associates a transaction context with its thread of control, a check is made to ensure that this transaction context was previously associated with the execution environment of the thread. This association would exist if the thread either created the transaction or received it in a transactional operation.</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_narayana_specifics_5"><a class="anchor" href="#_narayana_specifics_5"></a>Narayana specifics</h5>
<div class="paragraph">
<p>Where support from the ORB is available, Narayana supports X/Open checked transaction behavior.
However, unless the <code>OTS_CHECKED_TRANSACTIONS</code> property variable is set to <code>YES</code>, checked transactions are disabled.
This is the default setting.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Checked transactions are only possible with a co-located transaction manager.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In a multi-threaded application, multiple threads may be associated with a transaction during its lifetime, sharing the context.
In addition, if one thread terminates a transaction, other threads may still be active within it.
In a distributed environment, it can be difficult to guarantee that all threads have finished with a transaction when it terminates.
By default, Narayana issues a warning if a thread terminates a transaction when other threads are still active within it, but allow the transaction termination to continue.
You can choose to block the thread which is terminating the transaction until all other threads have disassociated themselves from its context, or use other methods to solve the problem.
Narayana provides the <code>com.arjuna.ats.arjuna.coordinator.CheckedAction</code> class, which allows you to override the thread and transaction termination policy.
Each transaction has an instance of this class associated with it, and you can implement the class on a per-transaction basis.</p>
</div>
<div class="listingblock">
<div class="title"><code>CheckedAction</code> implementation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CheckedAction</span> {
<span class="directive">public</span> CheckedAction ();

<span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> check (<span class="type">boolean</span> isCommit, Uid actUid, BasicList list);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a thread attempts to terminate the transaction and there active threads exist within it, the system invokes the <code>check</code> method on the transaction’s <code>CheckedAction</code> object.
The parameters to the check method are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>isCommit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates whether the transaction is in the process of committing or rolling back.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>actUid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction identifier.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>list</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of all of the threads currently marked as active within this transaction.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When <code>check</code> returns, the transaction termination continues.
Obviously the state of the transaction at this point may be different from that when check was called.</p>
</div>
<div class="paragraph">
<p>Set the <code>CheckedAction</code> instance associated with a given transaction with the <code>setCheckedAction</code> method of <code>Current</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_summary_of_narayana_implementation_decisions"><a class="anchor" href="#_summary_of_narayana_implementation_decisions"></a>2.3.20. Summary of Narayana implementation decisions</h4>
<div class="ulist">
<ul>
<li>
<p>Any execution environment (thread, process) can use a transaction <code>Control</code>.</p>
</li>
<li>
<p><code>Control</code> s, <code>Coordinator</code> s, and <code>Terminator</code> s are valid for use for the duration of the transaction if implicit transaction control is used, via <code>Current</code>.
If you use explicit control, via the <code>TransactionFactory</code> and <code>Terminator</code>, then use the destroyControl method of the OTS class in <code>com.arjuna.CosTransactions</code> to signal when the information can be garbage collected.</p>
</li>
<li>
<p>You can propagate <code>Coordinator</code> s and <code>Terminator</code> s between execution environments.</p>
</li>
<li>
<p>If you try to commit a transaction when there are still active subtransactions within it, Narayana rolls back the parent and the subtransactions.</p>
</li>
<li>
<p>Narayana includes full support for nested transactions.
However, if a resource raises an exception to the commitment of a sub-transaction after other resources have previously been told that the transaction committed, Narayana forces the enclosing transaction to abort.
This guarantees that all resources used within the sub-transaction are returned to a consistent state.
You can disable support for sub-transactions by setting the <code>OTS_SUPPORT_SUBTRANSACTIONS</code> variable to <code>NO</code>.</p>
</li>
<li>
<p>Obtain <code>Current</code> from the <code>get_current</code> method of the OTS.</p>
</li>
<li>
<p>A timeout value of zero seconds is assumed for a transaction if none is specified using <code>set_timeout</code>.</p>
</li>
<li>
<p>by default, <code>Current</code> does not use a separate transaction manager server by default.
Override this behavior by setting the <code>OTS_TRANSACTION_MANAGER</code> environment variable.
Location of the transaction manager is ORB-specific.</p>
</li>
<li>
<p>Checked transactions are disabled by default.
To enable them, set the <code>OTS_CHECKED_TRANSACTIONS</code> property to <code>YES</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_constructing_an_ots_application"><a class="anchor" href="#_constructing_an_ots_application"></a>2.4. Constructing an OTS application</h3>
<div class="sect3">
<h4 id="_important_notes_for_narayana"><a class="anchor" href="#_important_notes_for_narayana"></a>2.4.1. Important notes for Narayana</h4>
<div class="sect4">
<h5 id="_initialization"><a class="anchor" href="#_initialization"></a>Initialization</h5>
<div class="paragraph">
<p>Narayana must be correctly initialized before you create any application object.
To guarantee this, use the <code>initORB</code> and POA methods described in the <em>Orb Portability Guide</em>.
Consult <em>the Orb Portability Guide</em> if you need direct use of the <code>ORB_init</code> and <code>create_POA</code> methods provided by the underlying ORB.</p>
</div>
</div>
<div class="sect4">
<h5 id="_implicit_context_propagation_and_interposition"><a class="anchor" href="#_implicit_context_propagation_and_interposition"></a>Implicit context propagation and interposition</h5>
<div class="paragraph">
<p>If you need implicit context propagation and interposition, initialize Narayana correctly before you create any objects.
You can only use implicit context propagation on an ORB which supports filters and interceptors, or the <code>CosTSPortability</code> interface.
You can set <code>OTS_CONTEXT_PROP_MODE</code> to <code>CONTEXT</code> or <code>INTERPOSITION</code>, depending on which functionality you need.
If you are using the Narayana API, you need to use interposition.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_writing_applications_using_the_raw_ots_interfaces"><a class="anchor" href="#_writing_applications_using_the_raw_ots_interfaces"></a>2.4.2. Writing applications using the raw OTS interfaces</h4>
<div class="ulist">
<div class="title">Steps to participate in an OTS transaction</div>
<ul>
<li>
<p>Create <code>Resource</code> and <code>SubtransactionAwareResource</code> objects for each object which will participate within the transaction or sub-transaction.
These resources manage the persistence, concurrency control, and recovery for the object.
The OTS invokes these objects during the prepare, commit, or abort phase of the transaction or sub-transaction, and the Resources perform the work of the application.</p>
</li>
<li>
<p>Register <code>Resource</code> and <code>SubtransactionAwareResource</code> objects at the correct time within the transaction, and ensure that the object is only registered once within a given transaction.
As part of registration, a <code>Resource</code> receives a reference to a <code>RecoveryCoordinator</code>.
This reference must be made persistent, so that the transaction can recover in the event of a failure.</p>
</li>
<li>
<p>Correctly propagate resources such as locks to parent transactions and <code>SubtransactionAwareResource</code> objects.</p>
</li>
<li>
<p>Drive the crash recovery for each resource which was participating within the transaction, in the event of a failure.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The OTS does not provide any <code>Resource</code> implementations.
You need to provide these implementations.
The interfaces defined within the OTS specification are too low-level for most situations. Narayana is designed to make use of raw <em>Common Object Services (COS)</em> interfaces, but provides a higher-level API for building transactional applications and framework.
This API automates much of the work involved with participating in an OTS transaction.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_context_management"><a class="anchor" href="#_transaction_context_management"></a>2.4.3. Transaction context management</h4>
<div class="paragraph">
<p>If you use implicit transaction propagation, ensure that appropriate objects support the <code>TransactionalObject</code> interface.
Otherwise, you need to pass the transaction contexts as parameters to the relevant operations.</p>
</div>
<div class="sect4">
<h5 id="_a_transaction_originator_indirect_and_implicit"><a class="anchor" href="#_a_transaction_originator_indirect_and_implicit"></a>A transaction originator: indirect and implicit</h5>
<div class="listingblock">
<div class="title">Indirect and implicit transaction originator</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    ...
    txn_crt.begin();
    <span class="comment">// should test the exceptions that might be raised</span>
    ...
    <span class="comment">// the client issues requests, some of which involve</span>
    <span class="comment">// transactional objects;</span>
    BankAccount1.makeDeposit(deposit);
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>A transaction originator uses indirect context management and implicit transaction propagation.
<code>txn_crt</code> is a pseudo object supporting the <code>Current</code> interface.
The client uses the <code>begin</code> operation to start the transaction, which becomes implicitly associated with the originator’s thread of control.</p>
</div>
<div class="paragraph">
<p>The program commits the transaction associated with the client thread.
The <code>report_heuristics</code> argument is set to <code>false</code>, so the Transaction Service makes no reports about possible heuristic decisions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    ...
    txn_crt.commit(<span class="predefined-constant">false</span>);
    ...</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_transaction_originator_direct_and_explicit"><a class="anchor" href="#_transaction_originator_direct_and_explicit"></a>Transaction originator: direct and explicit</h5>
<div class="listingblock">
<div class="title">Direct and explicit transaction originator</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    ...
    org.omg.CosTransactions.Control c;
    org.omg.CosTransactions.Terminator t;
    org.omg.CosTransactions.Coordinator co;
    org.omg.CosTransactions.PropagationContext pgtx;

    c = TFactory.create(<span class="integer">0</span>);
    t = c.get_terminator();
    pgtx = c.get_coordinator().get_txcontext();
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This transaction originator uses direct context management and explicit transaction propagation.
The client uses a factory object supporting the <code>CosTransactions::TransactionFactory</code> interface to create a new transaction, and uses the returned <code>Control</code> object to retrieve the <code>Terminator</code> and <code>Coordinator</code> objects.</p>
</div>
<div class="paragraph">
<p>The client issues requests, some of which involve transactional objects.
This example uses explicit propagation of the context.
The <code>Control</code> object reference is passed as an explicit parameter of the request.
It is declared in the OMG IDL of the interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
transactional_object.do_operation(arg, pgtx);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The transaction originator uses the <code>Terminator</code> object to commit the transaction.
The <code>report_heuristics</code> argument is set to <code>false</code>, so the Transaction Service makes no reports about possible heuristic decisions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
t.commit(<span class="predefined-constant">false</span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implementing_a_transactional_client"><a class="anchor" href="#_implementing_a_transactional_client"></a>2.4.4. Implementing a transactional client</h4>
<div class="paragraph">
<p>The <code>commit</code> operation of <code>Current</code> or the <code>Terminator</code> interface takes the <code>boolean</code> <code>report_heuristics</code> parameter.
If the <code>report_heuristics</code> argument is <code>false</code>, the commit operation can complete as soon as the <code>Coordinator</code> makes the decision to commit or roll back the transaction.
The application does not need to wait for the <code>Coordinator</code> to complete the commit protocol by informing all the participants of the outcome of the transaction.
This can significantly reduce the elapsed time for the commit operation, especially where participant <code>Resource</code> objects are located on remote network nodes.
However, no heuristic conditions can be reported to the application in this case.</p>
</div>
<div class="paragraph">
<p>Using the <code>report_heuristics</code> option guarantees that the commit operation does not complete until the <code>Coordinator</code> completes the commit protocol with all <code>Resource</code> objects involved in the transaction.
This guarantees that the application is informed of any non-atomic outcomes of the transaction, through one of the exceptions <code>HeuristicMixed</code> or <code>HeuristicHazard</code>.
However, it increases the application-perceived elapsed time for the commit operation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implementing_a_recoverable_server"><a class="anchor" href="#_implementing_a_recoverable_server"></a>2.4.5. Implementing a recoverable server</h4>
<div class="paragraph">
<p>A Recoverable Server includes at least one transactional object and one resource object, each of which have distinct responsibilities.</p>
</div>
<div class="sect4">
<h5 id="_transactional_object"><a class="anchor" href="#_transactional_object"></a>Transactional object</h5>
<div class="paragraph">
<p>The transactional object implements the transactional object&#8217;s operations and registers a <code>Resource</code> object with the <code>Coordinator</code>, so that the Recoverable Server&#8217;s resources, including any necessary recovery, can commit.</p>
</div>
<div class="paragraph">
<p>The <code>Resource</code> object identifies the involvement of the Recoverable Server in a particular transaction.
This requires a <code>Resource</code> object to only be registered in one transaction at a time.
Register a different <code>Resource</code> object for each transaction in which a recoverable server is concurrently involved.
A transactional object may receive multiple requests within the scope of a single transaction.
It only needs to register its involvement in the transaction once.
The <code>is_same_transaction</code> operation allows the transactional object to determine if the transaction associated with the request is one in which the transactional object is already registered.</p>
</div>
<div class="paragraph">
<p>The <code>hash_transaction</code> operations allow the transactional object to reduce the number of transaction comparisons it has to make.
All <code>Coordinators</code> for the same transaction return the same hash code.
The <code>is_same_transaction</code> operation only needs to be called on <code>Coordinators</code> with the same hash code as the <code>Coordinator</code> of the current request.</p>
</div>
</div>
<div class="sect4">
<h5 id="_resource_object"><a class="anchor" href="#_resource_object"></a>Resource object</h5>
<div class="paragraph">
<p>A <code>Resource</code> object participates in the completion of the transaction, updates the resources of the Recoverable Server in accordance with the transaction outcome, and ensures termination of the transaction, including across failures.</p>
</div>
</div>
<div class="sect4">
<h5 id="_reliable_servers"><a class="anchor" href="#_reliable_servers"></a>Reliable servers</h5>
<div class="paragraph">
<p>A <em>Reliable Server</em> is a special case of a Recoverable Server.
A Reliable Server can use the same interface as a Recoverable Server to ensure application integrity for objects that do not have recoverable state.
In the case of a Reliable Server, the transactional object can register a <code>Resource</code> object that replies <code>VoteReadOnly</code> to <code>prepare</code> if its integrity constraints are satisfied.
It replies <code>VoteRollback</code> if it finds a problem.
This approach allows the server to apply integrity constraints which apply to the transaction as a whole, rather than to individual requests to the server.</p>
</div>
</div>
<div class="sect4">
<h5 id="_examples_2"><a class="anchor" href="#_examples_2"></a>Examples</h5>
<div class="exampleblock">
<div class="title">Example 3. Reliable server</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C"><span class="comment">/*
  BankAccount1 is an object with internal resources. It inherits from both the TransactionalObject and the Resource interfaces:
*/</span>
interface BankAccount1:CosTransactions::TransactionalObject, CosTransactions::Resource {
    ...
    <span class="directive">void</span> makeDeposit (in <span class="predefined-type">float</span> amt);
    ...
}
<span class="comment">/* The corresponding Java class is: */</span>
public class BankAccount1 {
public <span class="directive">void</span> makeDeposit(<span class="predefined-type">float</span> amt);
    ...
}
<span class="comment">/*
  Upon entering, the context of the transaction is implicitly associated with the object’s thread. The pseudo object
  supporting the Current interface is used to retrieve the Coordinator object associated with the transaction.
*/</span>
<span class="directive">void</span> makeDeposit (<span class="predefined-type">float</span> amt) {
    org.omg.CosTransactions.Control c;
    org.omg.CosTransactions.Coordinator co;
    c = txn_crt.get_control();
    co = c.get_coordinator();
    ...
<span class="comment">/*
  Before registering the resource the object should check whether it has already been registered for the same
  transaction. This is done using the hash_transaction and is_same_transaction operations.  that this object registers
  itself as a resource. This imposes the restriction that the object may only be involved in one transaction at a
  time. This is not the recommended way for recoverable objects to participate within transactions, and is only used as an
  example.  If more parallelism is required, separate resource objects should be registered for involvement in the same
  transaction.
*/</span>
    RecoveryCoordinator r;
    r = co.register_resource(this);

    <span class="comment">// performs some transactional activity locally</span>
    balance = balance + f;
    num_transactions++;
    ...
    <span class="comment">// end of transactional operation</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Transactional object</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/*  A BankAccount2 is an object with external resources that inherits from the TransactionalObject interface: */</span>
<span class="type">interface</span> <span class="class">BankAccount2</span>: CosTransactions::TransactionalObject {
    ...
    void makeDeposit(in <span class="type">float</span> amt);
    ...
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">BankAccount2</span> {
<span class="directive">public</span> <span class="type">void</span> makeDeposit(<span class="type">float</span> amt);
    ...
}
<span class="comment">/*
Upon entering, the context of the transaction is implicitly associated with the object’s thread. The makeDeposit
operation performs some transactional requests on external, recoverable servers. The objects res1 and res2 are
recoverable objects. The current transaction context is implicitly propagated to these objects.
*/</span>
<span class="type">void</span> makeDeposit(<span class="type">float</span> amt) {
    balance = res1.get_balance(amt);
    balance = balance + amt;
    res1.set_balance(balance);
    res2.increment_num_transactions();
} <span class="comment">// end of transactional operation</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_failure_models"><a class="anchor" href="#_failure_models"></a>2.4.6. Failure models</h4>
<div class="paragraph">
<p>The Transaction Service provides atomic outcomes for transactions in the presence of application, system or communication failures.
From the viewpoint of each user object role, two types of failure are relevant:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A local failure, which affects the object itself.</p>
</li>
<li>
<p>An external failure, such as failure of another object or failure in the communication with an object.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The transaction originator and transactional server handle these failures in different ways.</p>
</div>
<div class="sect4">
<h5 id="_transaction_originator"><a class="anchor" href="#_transaction_originator"></a>Transaction originator</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">Local failure</dt>
<dd>
<p>If a Transaction originator fails before the originator issues <code>commit</code>, the transaction is rolled back.
If the originator fails after issuing commit and before the outcome is reported, the transaction can either commit or roll back, depending on timing.
In this case, the transaction completes without regard to the failure of the originator.</p>
</dd>
<dt class="hdlist1">External failure</dt>
<dd>
<p>Any external failure which affects the transaction before the originator issues <code>commit</code> causes the transaction to roll back.
The standard exception <code>TransactionRolledBack</code> is raised in the originator when it issues <code>commit</code>.</p>
<div class="paragraph">
<p>If a failure occurs after commit and before the outcome is reported, the client may not be informed of the outcome of the transaction.
This depends on the nature of the failure, and the use of the <code>report_heuristics</code> option of <code>commit</code>.
For example, the transaction outcome is not reported to the client if communication between the client and the <code>Coordinator</code> fails.</p>
</div>
<div class="paragraph">
<p>A client can determine the outcome of the transaction by using method <code>get_status</code> on the <code>Coordinator</code>.
However, this is not reliable because it may return the status <code>NoTransaction</code>, which is ambiguous.
The transaction could have committed and been forgotten, or it could have rolled back and been forgotten.</p>
</div>
<div class="paragraph">
<p>An originator is only guaranteed to know the transaction outcome in one of two ways.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if its implementation includes a <code>Resource</code> object, so that it can participate in the two-phase commit procedure.</p>
</li>
<li>
<p>The originator and <code>Coordinator</code> must be located in the same failure domain.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_transactional_server"><a class="anchor" href="#_transactional_server"></a>Transactional server</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">Local failure</dt>
<dd>
<p>If the Transactional Server fails, optional checks by a Transaction Service implementation may make the transaction to roll back.
Without such checks, whether the transaction rolls back depends on whether the commit decision is already made, such as when an unchecked client invokes <code>commit</code> before receiving all replies from servers.</p>
</dd>
<dt class="hdlist1">External failure</dt>
<dd>
<p>Any external failure affecting the transaction during the execution of a Transactional Server causes the transaction to be rolled back.
If the failure occurs while the transactional object’s method is executing, the failure has no effect on the execution of this method.
The method may terminate normally, returning the reply to its client.
Eventually the <code>TransactionRolledBack</code> exception is returned to a client issuing <code>commit</code>.</p>
</dd>
<dt class="hdlist1">Recoverable server</dt>
<dd>
<p>Behavior of a recoverable server when failures occur is determined by the two phase commit protocol between the <code>Coordinator</code> and the recoverable server’s <code>Resource</code> object.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_summary"><a class="anchor" href="#_summary"></a>2.4.7. Summary</h4>
<div class="paragraph">
<p>When you develop OTS applications which use the raw OTS interfaces, be aware of the following items:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create <code>Resource</code> and <code>SubtransactionAwareResource</code> objects for each object which will participate within the transaction or sub-transaction.
These resources handle the persistence, concurrency control, and recovery for the object.
The OTS invokes these objects during the prepare, commit, and abort phases of the transaction or sub-transaction, and the <code>Resources</code> then perform all appropriate work.</p>
</li>
<li>
<p>Register <code>Resource</code> and <code>SubtransactionAwareResource</code> objects at the correct time within the transaction, and ensure that the object is only registered once within a given transaction.
As part of registration, a <code>Resource</code> receives a reference to a <code>RecoveryCoordinator</code>, which must be made persistent so that recovery can occur in the event of a failure.</p>
</li>
<li>
<p>For nested transactions, make sure that any propagation of resources, such as locks to parent transactions, are done correctly.
You also need to manage propagation of <code>SubtransactionAwareResource</code> objects to parents.</p>
</li>
<li>
<p>in the event of failures, drive the crash recovery for each <code>Resource</code> which participates within the transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The OTS does not provide any <code>Resource</code> implementations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_narayana_interfaces_for_extending_the_ots"><a class="anchor" href="#_narayana_interfaces_for_extending_the_ots"></a>2.5. Narayana interfaces for extending the OTS</h3>
<div class="paragraph">
<p>This chapter contains a description of the use of the Narayana classes you can use to extend the OTS interfaces.
These advanced interfaces are all written on top of the basic OTS engine described previously, and applications which use them run on other OTS implementations, only without the added functionality.</p>
</div>
<div class="dlist">
<div class="title">Features</div>
<dl>
<dt class="hdlist1">AtomicTransaction</dt>
<dd>
<p>Provides a more manageable interface to the OTS transaction than <code>CosTransactions::Current</code>. It automatically keeps track of transaction scope, and allows you to create nested top-level transactions in a more natural manner than the one provided by the OTS.</p>
</dd>
<dt class="hdlist1">Advanced subtransaction-Resource classes</dt>
<dd>
<p>Allow nested transactions to use a two-phase commit protocol.
These Resources can also be ordered within Narayana, enabling you to control the order in which <code>Resource</code> s are called during the commit or abort protocol.</p>
</dd>
<dt class="hdlist1">Implicit context propagation between client and server</dt>
<dd>
<p>Where available, Narayana uses implicit context propagation between client and server.
Otherwise, Narayana provides an explicit interposition class, which simplifies the work involved in interposition.
The Narayana API, <em>Transactional Objects for Java (TXOJ)</em>, requires either explicit or implicit interposition.
This is even true in a stand-alone mode when using a separate transaction manager.
TXOJ is fully described in the <em>ArjunaCore Development Guide</em>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>the extensions to the <code>CosTransactions.idl</code> are located in the <code>com.arjuna.ArjunaOTS</code> package and the <code>ArjunaOTS.idl</code> file.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_nested_transactions_3"><a class="anchor" href="#_nested_transactions_3"></a>2.5.1. Nested transactions</h4>
<div class="paragraph">
<p>The OTS implementation of nested transactions is extremely limited, and can lead to the generation of inconsistent results.
One example is a scenario in which a sub-transaction coordinator discovers part of the way through committing that a resources cannot commit.
It may not be able to tell the committed resources to abort.</p>
</div>
<div class="paragraph">
<p>In most transactional systems which support sub-transactions, the sub-transaction commit protocol is the same as a top-level transaction’s.
There are two phases, a <code>prepare</code> phase and a <code>commit</code> or <code>abort</code> phase.
Using a multi-phase commit protocol avoids the above problem of discovering that one resources cannot commit after others have already been told to commit.
The <code>prepare</code> phase generates consensus on the commit outcome, and the <code>commit</code> or <code>abort</code> phase enforces the outcome.</p>
</div>
<div class="paragraph">
<p>Narayana supports the strict OTS implementation of sub-transactions for those resources derived from <code>CosTransactions::SubtransactionAwareResource</code>.
However, if a resource is derived from <code>ArjunaOTS::ArjunaSubtranAwareResource</code>, it is driven by a two-phase commit protocol whenever a nested transaction commits.</p>
</div>
<div class="listingblock">
<div class="title">ArjunaSubtranAwareResource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SubtransactionAwareResource {
    CosTransactions::Vote prepare_subtransaction();
} : CosTransactions::

<span class="type">interface</span> <span class="class">ArjunaSubtranAwareResource</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>During the first phase of the commit protocol the <code>prepare_subtransaction</code> method is called, and the resource behaves as though it were being driven by a top-level transaction, making any state changes provisional upon the second phase of the protocol.
Any changes to persistent state must still be provisional upon the second phase of the top-level transaction, as well.
Based on the votes of all registered resources, Narayana then calls either <code>commit_subtransaction</code> or <code>rollback_subtransaction</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This scheme only works successfully if all resources registered within a given sub-transaction are instances of the <code>ArjunaSubtranAwareResource</code> interface, and that after a resource tells the coordinator it can prepare, it does not change its mind.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_extended_resources"><a class="anchor" href="#_extended_resources"></a>2.5.2. Extended resources</h4>
<div class="paragraph">
<p>When resources are registered with a transaction, the transaction maintains them within a list, called the <em>intentions list</em>.
At termination time, the transaction uses the intentions list to drive each resource appropriately, to commit or abort.
However, you have no control over the order in which resources are called, or whether previously-registered resources should be replaced with newly registered resources.
The Narayana interface <code>ArjunaOTS::OTSAbstractRecord</code> gives you this level of control.</p>
</div>
<div class="listingblock">
<div class="title">OTSAbstractRecord</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">OTSAbstractRecord</span> : ArjunaSubtranAwareResource {
    readonly attribute <span class="type">long</span> typeId;
    readonly attribute string uid;

    <span class="type">boolean</span> propagateOnAbort ();
    <span class="type">boolean</span> propagateOnCommit ();

    <span class="type">boolean</span> saveRecord ();
    <span class="type">void</span> merge (in OTSAbstractRecord record);
    <span class="type">void</span> alter (in OTSAbstractRecord record);

    <span class="type">boolean</span> shouldAdd (in OTSAbstractRecord record);
    <span class="type">boolean</span> shouldAlter (in OTSAbstractRecord record);
    <span class="type">boolean</span> shouldMerge (in OTSAbstractRecord record);
    <span class="type">boolean</span> shouldReplace (in OTSAbstractRecord record);
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>typeId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns the record type of the instance. This is one of the values of the enumerated type <code>Record_type</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a stringified Uid for this record.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>propagateOnAbort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">by default, instances of <code>OTSAbstractRecord</code> should not be propagated to the parent transaction if the current transaction rolls back. By returning <code>TRUE</code>, the instance will be propagated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>propagateOnCommit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returning <code>TRUE</code> from this method causes the instance to be propagated to the parent transaction if the current transaction commits. Returning <code>FALSE</code> disables the propagation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>saveRecord</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returning <code>TRUE</code> from this method causes Narayana to try to save sufficient information about the record to persistent state during commit, so that crash recovery mechanisms can replay the transaction termination in the event of a failure. If <code>FALSE</code> is returned, no information is saved.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>merge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">used when two records need to merge together.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>alter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">used when a record should be altered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shouldAdd</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns <code>true</code> ii the record should be added to the list, <code>false</code> if it should be discarded.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shouldMerge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns <code>true</code> if the two records should be merged into a single record, <code>false</code> otherwise.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shouldReplace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns <code>true</code> if the record should replace an existing one, <code>false</code> otherwise.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When inserting a new record into the transaction’s intentions list, Narayana uses the following algorithm:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>if a record with the same type and uid has already been inserted, then the methods <code>shouldAdd</code>, and related methods, are invoked to determine whether this record should also be added.</p>
</li>
<li>
<p>If no such match occurs, then the record is inserted in the intentions list based on the <code>type</code> field, and ordered according to the uid.
All of the records with the same type appear ordered in the intentions list.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>OTSAbstractRecord</code> is derived from <code>ArjunaSubtranAwareResource</code>.
Therefore, all instances of <code>OTSAbstractRecord</code> inherit the benefits of this interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="_atomictransaction"><a class="anchor" href="#_atomictransaction"></a>2.5.3. AtomicTransaction</h4>
<div class="paragraph">
<p>In terms of the OTS, <code>AtomicTransaction</code> is the preferred interface to the OTS protocol engine.
It is equivalent to <code>CosTransactions::Current</code>, but with more emphasis on easing application development.
For example, if an instance of <code>AtomicTransaction</code> goes out of scope before it terminates, the transaction automatically rolls back.
<code>CosTransactions::Current</code> cannot provide this functionality.
When building applications using Narayana, use <code>AtomicTransaction</code> for the added benefits it provides.
It is located in the <code>com.arjuna.ats.jts.extensions.ArjunaOTS</code> package.</p>
</div>
<div class="listingblock">
<div class="title">AtomicTransaction</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AtomicTransaction</span> {
    <span class="directive">public</span> AtomicTransaction ();
    <span class="directive">public</span> <span class="type">void</span> begin () <span class="directive">throws</span> SystemException, SubtransactionsUnavailable, NoTransaction;
    <span class="directive">public</span> <span class="type">void</span> commit (<span class="type">boolean</span> report_heuristics) <span class="directive">throws</span> SystemException, NoTransaction, HeuristicMixed, HeuristicHazard,TransactionRolledBack;
    <span class="directive">public</span> <span class="type">void</span> rollback () <span class="directive">throws</span> SystemException, NoTransaction;
    <span class="directive">public</span> <span class="predefined-type">Control</span> control () <span class="directive">throws</span> SystemException, NoTransaction;
    <span class="directive">public</span> Status get_status () <span class="directive">throws</span> SystemException;
    <span class="comment">/* Allow action commit to be supressed */</span>
    <span class="directive">public</span> <span class="type">void</span> rollbackOnly () <span class="directive">throws</span> SystemException, NoTransaction;

    <span class="directive">public</span> <span class="type">void</span> registerResource (Resource r) <span class="directive">throws</span> SystemException, Inactive;
    <span class="directive">public</span> <span class="type">void</span> registerSubtransactionAwareResource (SubtransactionAwareResource) <span class="directive">throws</span> SystemException, NotSubtransaction;
    <span class="directive">public</span> <span class="type">void</span> registerSynchronization(Synchronization s) <span class="directive">throws</span> SystemException, Inactive;
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. AtomicTransaction&#8217;s Methods</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>begin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starts an action</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>commit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commits an action</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollback</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abort an action</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Transaction nesting is determined dynamically.
Any transaction started within the scope of another running transaction is nested.</p>
</div>
<div class="paragraph">
<p>The <code>TopLevelTransaction</code> class, which is derived from <code>AtomicTransaction</code>, allows creation of nested top-level transactions.
Such transactions allow non-serializable and potentially non-recoverable side effects to be initiated from within a transaction, so use them with caution.
You can create nested top-level transactions with a combination of the <code>CosTransactions::TransactionFactory</code> and the <code>suspend</code> and <code>resume</code> methods of <code>CosTransactions::Current</code>.
However, the <code>TopLevelTransaction</code> class provides a more user-friendly interface.</p>
</div>
<div class="paragraph">
<p><code>AtomicTransaction</code> and <code>TopLevelTransaction</code> are completely compatible with <code>CosTransactions::Current</code>.
You an use the two transaction mechanisms interchangeably within the same application or object.</p>
</div>
<div class="paragraph">
<p><code>AtomicTransaction</code> and <code>TopLevelTransaction</code> are similar to <code>CosTransactions::Current</code>.
They both simplify the interface between you and the OTS.
However, you gain two advantages by using <code>AtomicTransaction</code> or <code>TopLevelTransaction</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The ability to create nested top-level transactions which are automatically associated with the current thread.
When the transaction ends, the previous transaction associated with the thread, if any, becomes the thread’s current transaction.</p>
</li>
<li>
<p>Instances of <code>AtomicTransaction</code> track scope, and if such an instance goes out of scope before it is terminated, it is automatically aborted, along with its children.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_context_propagation_issues"><a class="anchor" href="#_context_propagation_issues"></a>2.5.4. Context propagation issues</h4>
<div class="paragraph">
<p>When using TXOJ in a distributed manner, Narayana requires you to use interposition between client and object.
This requirement also exists if the application is local, but the transaction manager is remote.
In the case of implicit context propagation, where the application object is derived from <code>CosTransactions::TransactionalObject</code>, you do not need to do anything further. Narayana automatically provides interposition.
However, where implicit propagation is not supported by the ORB, or your application does not use it, you must take additional action to enable interposition.</p>
</div>
<div class="paragraph">
<p>The class <code>com.arjuna.ats.jts.ExplicitInterposition</code> allows an application to create a local control object which acts as a local coordinator, fielding registration requests that would normally be passed back to the originator.
This surrogate registers itself with the original coordinator, so that it can correctly participate in the commit protocol.
The application thread context becomes the surrogate transaction hierarchy.
Any transaction context currently associated with the thread is lost.
The interposition lasts for the lifetime of the explicit interposition object, at which point the application thread is no longer associated with a transaction context.
Instead, it is set to <code>null</code>.</p>
</div>
<div class="paragraph">
<p>interposition is intended only for those situations where the transactional object and the transaction occur within different processes, rather than being co-located.
If the transaction is created locally to the client, do not use the explicit interposition class.
The transaction is implicitly associated with the transactional object because it resides within the same process.</p>
</div>
<div class="listingblock">
<div class="title">ExplicitInterposition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ExplicitInterposition</span> {
    <span class="directive">public</span> ExplicitInterposition();

    <span class="directive">public</span> <span class="type">void</span> registerTransaction(<span class="predefined-type">Control</span> control) <span class="directive">throws</span> InterpositionFailed, SystemException;

    <span class="directive">public</span> <span class="type">void</span> unregisterTransaction() <span class="directive">throws</span> InvalidTransaction, SystemException;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A transaction context can be propagated between client and server in two ways: either as a reference to the client’s transaction Control, or explicitly sent by the client.
Therefore, there are two ways in which the interposed transaction hierarchy can be created and registered.
For example, consider the class Example which is derived from LockManager and has a method increment:</p>
</div>
<div class="listingblock">
<div class="title">ExplicitInterposition Example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">boolean</span> increment(<span class="predefined-type">Control</span> control) {
    ExplicitInterposition inter = <span class="keyword">new</span> ExplicitInterposition();

    <span class="keyword">try</span> {
        inter.registerTransaction(control);
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }

    <span class="comment">// do real work</span>

    <span class="comment">// should catch exceptions!</span>
    inter.unregisterTransaction();

    <span class="comment">// return value dependant upon outcome</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>if the <code>Control</code> passed to the <code>register</code> operation of <code>ExplicitInterposition</code> is <code>null</code>, no exception is thrown.
The system assumes that the client did not send a transaction context to the server.
A transaction created within the object will thus be a top-level transaction.</p>
</div>
<div class="paragraph">
<p>When the application returns, or when it finishes with the interposed hierarchy, the program should call <code>unregisterTransaction</code> to disassociate the thread of control from the hierarchy.
This occurs automatically when the <code>ExplicitInterposition</code> object is garbage collected.
However, since this may be after the transaction terminates, Narayana assumes the thread is still associated with the transaction and issues a warning about trying to terminate a transaction while threads are still active within it.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_example"><a class="anchor" href="#_example"></a>2.6. Example</h3>
<div class="paragraph">
<p>This example illustrates the concepts and the implementation details for a simple client/server example using implicit context propagation and indirect context management.</p>
</div>
<div class="sect3">
<h4 id="_the_basic_example"><a class="anchor" href="#_the_basic_example"></a>2.6.1. The basic example</h4>
<div class="paragraph">
<p>This example only includes a single unit of work within the scope of the transaction.
Consequently, only a one-phase commit is needed.</p>
</div>
<div class="paragraph">
<p>The client and server processes are both invoked using the <code>implicit propagation</code> and <code>interposition</code> command-line options.</p>
</div>
<div class="paragraph">
<p>For the purposes of this worked example, a single method implements the <code>DemoInterface</code> interface.
This method is used in the DemoClient program.</p>
</div>
<div class="listingblock">
<div class="title">idl interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="error">#</span>include &lt;idl/CosTransactions.idl&gt;
<span class="error">#</span>pragma javaPackage <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>

module Demo {
    exception DemoException {};

    <span class="type">interface</span> <span class="class">DemoInterface</span> : CosTransactions::TransactionalObject {
        <span class="type">void</span> work() raises (DemoException);
    }
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_example_implementation_of_the_interface"><a class="anchor" href="#_example_implementation_of_the_interface"></a>Example implementation of the interface</h5>
<div class="paragraph">
<p>This section deals with the pieces needed to implement the example interface.</p>
</div>
<div class="sect5">
<h6 id="_resource_2"><a class="anchor" href="#_resource_2"></a>Resource</h6>
<div class="paragraph">
<p>The example overrides the methods of the <code>Resource</code> implementation class.
The <code>DemoResource</code> implementation includes the placement of <code>System.out.println</code> statements at judicious points, to highlight when a particular method is invoked.</p>
</div>
<div class="paragraph">
<p>Only a single unit of work is included within the scope of the transaction.
Therefore, the <code>prepare</code> or <code>commit</code> methods should never be invoked, but the <code>commit_one_phase</code> method should be invoked.</p>
</div>
<div class="listingblock">
<div class="title">DemoResource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.omg.CosTransactions</span>.*;
<span class="keyword">import</span> <span class="include">org.omg.CORBA.SystemException</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoResource</span> <span class="directive">extends</span> org.omg.CosTransactions.ResourcePOA {
    <span class="directive">public</span> Vote prepare() <span class="directive">throws</span> HeuristicMixed, HeuristicHazard, SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">prepare called</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> Vote.VoteCommit;
    }

    <span class="directive">public</span> <span class="type">void</span> rollback() <span class="directive">throws</span> HeuristicCommit, HeuristicMixed, HeuristicHazard, SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">rollback called</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> commit() <span class="directive">throws</span> NotPrepared, HeuristicRollback, HeuristicMixed, HeuristicHazard, SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">commit called</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> commit_one_phase() <span class="directive">throws</span> HeuristicHazard, SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">commit_one_phase called</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> forget() <span class="directive">throws</span> SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">forget called</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_transactional_implementation"><a class="anchor" href="#_transactional_implementation"></a>Transactional implementation</h6>
<div class="paragraph">
<p>At this stage, the <em>Demo.idl</em> has been processed by the ORB&#8217;s idl compiler to generate the necessary client and server package.</p>
</div>
<div class="paragraph">
<p>Line 14 returns the transactional context for the <code>Current</code> pseudo object.
After obtaining a <code>Control</code> object, you can derive the Coordinator object (line 16).</p>
</div>
<div class="paragraph">
<p>Lines 17 and 19 create a resource for the transaction, and then inform the ORB that the resource is ready to receive incoming method invocations.</p>
</div>
<div class="paragraph">
<p>Line 20 uses the <code>Coordinator</code> to register a <code>DemoResource</code> object as a participant in the transaction.
When the transaction terminates, the resource receives requests to commit or rollback the updates performed as part of the transaction.</p>
</div>
<div class="listingblock">
<div class="title">Transactional implementation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">Demo</span>.*;
<span class="keyword">import</span> <span class="include">org.omg.CosTransactions</span>.*;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts</span>.*;
<span class="keyword">import</span> <span class="include">com.arjuna.orbportability</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoImplementation</span> <span class="directive">extends</span> Demo.DemoInterfacePOA {
    <span class="directive">public</span> <span class="type">void</span> work() <span class="directive">throws</span> DemoException {
        <span class="keyword">try</span> {

            <span class="predefined-type">Control</span> control = OTSManager.get_current().get_control();

            Coordinator coordinator = control.get_coordinator();
            DemoResource resource = <span class="keyword">new</span> DemoResource();

            ORBManager.getPOA().objectIsReady(resource);
            coordinator.register_resource(resource);

        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="keyword">throw</span> <span class="keyword">new</span> DemoException();
        }
    }
}          </code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_server_implementation"><a class="anchor" href="#_server_implementation"></a>Server implementation</h6>
<div class="paragraph">
<p>First, you need to to initialize the ORB and the POA.
Lines 10 through 14 accomplish these tasks.</p>
</div>
<div class="paragraph">
<p>The servant class <code>DemoImplementation</code> contains the implementation code for the <code>DemoInterface</code> interface.
The servant services a particular client request.
Line 16 instantiates a servant object for the subsequent servicing of client requests.</p>
</div>
<div class="paragraph">
<p>Once a servant is instantiated, connect the servant to the POA, so that it can recognize the invocations on it, and pass the invocations to the correct servant.
Line 18 performs this task.</p>
</div>
<div class="paragraph">
<p>Lines 20 through to 21 registers the service through the default naming mechanism.
More information about the options available can be found in the ORB Portability Guide.</p>
</div>
<div class="paragraph">
<p>If this registration is successful, line 23 outputs a <code>sanity check</code> message.</p>
</div>
<div class="paragraph">
<p>Finally, line 25 places the server process into a state where it can begin to accept requests from client processes.</p>
</div>
<div class="listingblock">
<div class="title">DemoServer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.io</span>.*;

<span class="keyword">import</span> <span class="include">com.arjuna.orbportability</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoServer</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        <span class="keyword">try</span> {
            ORB myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>).initORB(args, <span class="predefined-constant">null</span>);
            RootOA myOA = OA.getRootOA(myORB).myORB.initOA();

            ORBManager.setORB(myORB);
            ORBManager.setPOA(myOA);

            DemoImplementation obj = <span class="keyword">new</span> DemoImplementation();

            myOA.objectIsReady(obj);

            Services serv = <span class="keyword">new</span> Services(myORB);
            serv.registerService(myOA.corbaReference(obj), <span class="string"><span class="delimiter">&quot;</span><span class="content">DemoObjReference</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>);

            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Object published.</span><span class="delimiter">&quot;</span></span>);

            myOA.run();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(e);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After the server compiles, you can use the command line options defined below to start a server process.
By specifying the usage of a filter on the command line, you can override settings in the <em>TransactionService.properties</em> file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>if you specify the interposition filter, you also imply usage of implicit context propagation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_client_implementation"><a class="anchor" href="#_client_implementation"></a>Client implementation</h6>
<div class="paragraph">
<p>The client, like the server, requires you to first initialize the ORB and the POA.
Lines 14 through 18 accomplish these tasks.</p>
</div>
<div class="paragraph">
<p>After a server process is started, you can obtain the object reference through the default publication mechanism used to publish it in the server.
This is done in lines 20 and 21.
Initially the reference is an instance of <code>Object</code>.
However, to invoke a method on the servant object, you need to narrow this instance to an instance of the <code>DemoInterface</code> interface.
This is shown in line 21.</p>
</div>
<div class="paragraph">
<p>Once we have a reference to this servant object, we can start a transaction (line 23), perform a unit of work (line 25) and commit the transaction (line 27).</p>
</div>
<div class="listingblock">
<div class="title">DemoClient</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">Demo</span>.*;

<span class="keyword">import</span> <span class="include">java.io</span>.*;

<span class="keyword">import</span> <span class="include">com.arjuna.orbportability</span>.*;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts</span>.*;
<span class="keyword">import</span> <span class="include">org.omg.CosTransactions</span>.*;
<span class="keyword">import</span> <span class="include">org.omg</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoClient</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        <span class="keyword">try</span> {
            ORB myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>).initORB(args, <span class="predefined-constant">null</span>);
            RootOA myOA = OA.getRootOA(myORB).myORB.initOA();

            ORBManager.setORB(myORB);
            ORBManager.setPOA(myOA);

            Services serv = <span class="keyword">new</span> Services(myORB);
            DemoInterface d = (DemoInterface) DemoInterfaceHelper.narrow(serv.getService(<span class="string"><span class="delimiter">&quot;</span><span class="content">DemoObjReference</span><span class="delimiter">&quot;</span></span>));

            OTS.get_current().begin();

            d.work();

            OTS.get_current().commit(<span class="predefined-constant">true</span>);
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(e);
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_sequence_diagram"><a class="anchor" href="#_sequence_diagram"></a>Sequence diagram</h6>
<div class="paragraph">
<p>The sequence diagram illustrates the method invocations that occur between the client and server.
The following aspects are important:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You do not need to pass the transactional context as a parameter in method <code>work</code>, since you are using implicit context propagation.</p>
</li>
<li>
<p>Specifying the use of interposition when the client and server processes are started, by using appropriate filters and interceptors, creates an interposed coordinator that the servant process can use, negating any requirement for cross-process invocations.
The interposed coordinator is automatically registered with the root coordinator at the client.</p>
</li>
<li>
<p>The resource that commits or rolls back modifications made to the transactional object is associated, or registered, with the interposed coordinator.</p>
</li>
<li>
<p>The <code>commit</code> invocation in the client process calls the root coordinator.
The root coordinator calls the interposed coordinator, which in turn calls the <code>commit_one_phase</code> method for the resource.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-sequence-diagram.png" alt="jts sequence diagram">
</div>
<div class="title">Figure 16. Sequence Diagram</div>
</div>
</div>
<div class="sect5">
<h6 id="_interpretation_of_output"><a class="anchor" href="#_interpretation_of_output"></a>Interpretation of output</h6>
<div class="paragraph">
<p>The server process first stringifies the servant instance, and writes the servant IOR to a temporary file.
The first line of output is the sanity check that the operation was successful.</p>
</div>
<div class="paragraph">
<p>In this simplified example, the coordinator object has only a single registered resource.
Consequently, it performs a <code>commit_one_phase</code> operation on the resource object, instead of performing a <code>prepare</code> operation, followed by a <code>commit</code> or <code>rollback</code>.</p>
</div>
<div class="paragraph">
<p>The output is identical, regardless of whether implicit context propagation or interposition is used, since interposition is essentially performance aid.
Ordinarily, you may need to do a lot of marshaling between a client and server process.</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Server output</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>Object reference written to file
commit_one_phase called</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_default_settings"><a class="anchor" href="#_default_settings"></a>2.6.2. Default settings</h4>
<div class="paragraph">
<p>These settings are defaults, and you can override them at run-time by using property variables, or in the properties file in the <code>etc/</code> directory of the installation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Unless a CORBA object is derived from <code>CosTransactions::TransactionalObject</code>,you do not need to propagate any context.
In order to preserve distribution transparency, Narayana defaults to always propagating a transaction context when calling remote objects, regardless of whether they are marked as transactional objects.
You can override this by setting the <code>com.arjuna.ats.jts.alwaysPropagateContext</code> property variable to <code>NO</code>.</p>
</li>
<li>
<p>If an object is derived from <code>CosTransactions::TransactionalObject</code>, and no client context is present when an invocation is made, Narayana transmits a null context.
Subsequent transactions begun by the object are top-level.
If a context is required, then set the <code>com.arjuna.ats.jts.needTranContext</code> property variable to <code>YES</code>, in which case Narayana raises the <em>TransactionRequired</em> exception.</p>
</li>
<li>
<p>Narayana needs a persistent object store, so that it can record information about transactions in the event of failures.
If all transactions complete successfully, this object store has no entries.
The default location for this must be set using the <code>ObjectStoreEnvironmentBean.objectStoreDir</code> variable in the properties file.</p>
</li>
<li>
<p>If you use a separate transaction manager for <code>Current</code>, its location is obtained from the <em>CosServices.cfg</em> file.
<em>CosServices.cfg</em> is located at runtime by the <code>OrbPortabilityEnvironmentBean</code> properties <code>initialReferencesRoot</code> and <code>initialReferencesFile</code>.
The former is a directory, defaulting to the current working directory.
The latter is a file name, relative to the directory.
The default value is <code>CosServices.cfg</code> .</p>
</li>
<li>
<p>Checked transactions are not enabled by default.
This means that threads other than the transaction creator may terminate the transaction, and no check is made to ensure all outstanding requests have finished prior to transaction termination.
To override this, set the <code>JTSEnvironmentBean.checkedTransactions</code> property variable to <code>YES</code>.</p>
</li>
<li>
<p></p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As of Narayana 4.5, transaction timeouts are unified across all transaction components and are controlled by ArjunaCore.
The old JTS configuration property com.arjuna.ats.jts.defaultTimeout still remains but is deprecated.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>if a value of <code>0</code> is specified for the timeout of a top-level transaction, or no timeout is specified, Narayana does not impose any timeout on the transaction.
To override this default timeout, set the <code>CoordinatorEnvironmentBean.defaultTimeout</code> property variable to the required timeout value in seconds.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_trail_map"><a class="anchor" href="#_trail_map"></a>2.7. Trail map</h3>
<div class="sect3">
<h4 id="_introduction_3"><a class="anchor" href="#_introduction_3"></a>2.7.1. Introduction</h4>
<div class="paragraph">
<p>Narayana assures complete, accurate business transactions for any Java based applications, including those written for the Jakarta EE and EJB frameworks.</p>
</div>
<div class="paragraph">
<p>Narayana is a 100% Java implementation of a distributed transaction management system based on the Jakarta EE Java Transaction Service (JTS) standard.
Our implementation of the JTS utilizes the Object Management Group&#8217;s (OMG) Object Transaction Service (OTS) model for transaction interoperability as recommended in the Jakarta EE and EJB standards.
Although any JTS-compliant product will allow Java objects to participate in transactions, one of the key features of Narayana is it&#8217;s 100% Java implementation.
This allows Narayana to support fully distributed transactions that can be coordinated by distributed parties.</p>
</div>
<div class="paragraph">
<p>Narayana runs can be run both as an embedded distributed service of an application server (e.g. WildFly Application Server), affording the user all the added benefits of the application server environment such as real-time load balancing, unlimited linear scalability and unmatched fault tolerance that allows you to deliver an always-on solution to your customers.
It is also available as a free-standing Java Transaction Service.</p>
</div>
<div class="paragraph">
<p>In addition to providing full compliance with the latest version of the JTS specification, Narayana leads the market in providing many advanced features such as fully distributed transactions and ORB portability with POA support.</p>
</div>
<div class="paragraph">
<p>Narayana is tested on HP-UX 11i, Red Hat Linux, Windows Server 2003, and Sun Solaris 10, using Sun&#8217;s JDK 5.
It should howerver work on any system with JDK 5 or 6.</p>
</div>
<div class="paragraph">
<p>The Java Transaction API support for Narayana comes in two flavours:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a purely local implementation, that does not require an ORB, but obviously requires all coordinated resources to reside within the same JVM.</p>
</li>
<li>
<p>a fully distributed implementation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Key features</p>
</div>
<div class="ulist">
<ul>
<li>
<p>full compliance with the Jakarta Transactions specification:</p>
<div class="ulist">
<ul>
<li>
<p>Purely local (ORB-less) JTA offers the fastest JTA performance</p>
</li>
<li>
<p>JDBC support</p>
</li>
<li>
<p>XA compliance</p>
</li>
<li>
<p>JDBC drivers for database access with full transaction support</p>
</li>
<li>
<p>Automatic crash recovery for XAResources</p>
</li>
</ul>
</div>
</li>
<li>
<p>compliance with the JTS specification and OTS 1.2 specification from the OMG</p>
<div class="ulist">
<ul>
<li>
<p>Distributed JTA implementation</p>
</li>
<li>
<p>support for distributed transactions (utilizing two-phase commit)</p>
</li>
<li>
<p>POA ORB support</p>
</li>
<li>
<p>interposition</p>
</li>
<li>
<p>transaction heuristics</p>
</li>
<li>
<p>distributed transaction manager (co-located with the transaction initiator) or transaction manager server</p>
</li>
<li>
<p>checked/unchecked transaction behaviour</p>
</li>
<li>
<p>supports both flat and nested transaction models, with nested-aware resources and resource adapters</p>
</li>
<li>
<p>independent concurrency control system with support for type-specific concurrency control</p>
</li>
<li>
<p>support for CosTransaction::Current</p>
</li>
<li>
<p>direct and indirect transaction management</p>
</li>
<li>
<p>synchronization interface</p>
</li>
<li>
<p>explicit and implicit transaction context propagation</p>
</li>
<li>
<p>automatic crash recovery</p>
</li>
<li>
<p>multi-thread aware</p>
</li>
</ul>
</div>
</li>
<li>
<p>transactional objects (TO) for Java</p>
</li>
<li>
<p>ORB independence via the ORB portability layer</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This trail map will help you get started with running Narayana product.
It is structured as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1. Installation Content: This trail describes the content installed by the Narayana distribution</p>
</li>
<li>
<p>2. The Sample Application: This trail describes via a set of examples how Narayana is used to build transactional applications</p>
</li>
<li>
<p>3. Deploying and testing the Sample Application: This trail describes how to deploy and to test the sample application</p>
</li>
<li>
<p>4. Making the Sample Application Persistent: This trail describes tools allowing to build a persistent application</p>
</li>
<li>
<p>5. Recovery from Failure: This trail describes via a simple scenario how Narayana manages recovery from failure.</p>
</li>
<li>
<p>6. Where Next?: This trail indicates where to find additional information</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to the trails listed above, a set of trails giving more explanation on concept around transaction processing and standards, and also a quick access to section explaining how to configure Narayana are listed in the section "Additional Trails".</p>
</div>
<div class="paragraph">
<p><em>Note:</em> When running the local JTS transactions part of the trailmap, you will need to start the recovery manager: java com.arjuna.ats.arjuna.recovery.RecoveryManager -test</p>
</div>
<div class="sect4">
<h5 id="_overview_of_the_xopen_dtp_model"><a class="anchor" href="#_overview_of_the_xopen_dtp_model"></a>Overview of the X/Open DTP model</h5>
<div class="paragraph">
<p>The X/Open Distributed Transaction Processing (DTP) model is a distributed transaction processing model proposed by the Open Group, a vendor consortium.
This model is a standard among most of the commercial vendors in transaction processing and database domains.</p>
</div>
<div class="paragraph">
<p>This model consists of the follwng components (illustrated in <a href="#figure1">The X/Open DTP model</a>)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an Application Program (AP), which defines transaction boundaries and specifies actions that constitute a transaction</p>
</li>
<li>
<p>Resource Managers (RMs) such as databases or file access systems, which provide access to resources</p>
</li>
<li>
<p>a Transaction Manager &#8482;, which assigns identifiers to transactions, monitors their progress, and takes responsibility for transaction completion and for coordinating failure recovery</p>
</li>
<li>
<p>Communication Resource Managers (CRMs), which control communication between distributed applications within or across TM domains</p>
</li>
</ul>
</div>
<div id="figure1" class="imageblock text-center">
<div class="content">
<img src="images/jts-xopen.png" alt="jts xopen">
</div>
<div class="title">Figure 17. The X/Open DTP model</div>
</div>
</div>
<div class="sect4">
<h5 id="_interface_between_functional_components"><a class="anchor" href="#_interface_between_functional_components"></a>Interface between functional components</h5>
<div class="paragraph">
<p>There are six interfaces between software components in the X/Open DTP model.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AP-RM.
The AP-RM interfaces give the AP access to resources.
X/Open interfaces, such as SQL and ISAM provide AP portability.
The X/Open DTP model imposes few constraints on native RM APIs.
The constraints involve only those native RM interfaces that define transactions.</p>
</li>
<li>
<p>AP-TM.
The AP-TM interface (the TX interface) provides the AP with an Application Programming Interface (API) by which the AP coordinates global transaction management with the TM.
For example, when the AP calls <code>tx_begin()</code> the TM informs the participating RMs of the start of a global transaction.
After each request is completed, the TM provides a return value to the AP reporting back the success or otherwise of the TX call.</p>
</li>
<li>
<p>TM-RM.
The TM-RM interface (the XA interface) lets the TM structure the work of RMs into global transactions and coordinate completion or recovery.
The XA interface is the bidirectional interface between the TM and RM.</p>
<div class="paragraph">
<p>The functions that each RM provides for the TM are called the <code>xa_*()</code> functions.
For example the TM calls <code>xa_start()</code> in each participating RM to start an RM-internal transaction as part of a new global transaction.
Later, the TM may call in sequence <code>xa_end()</code>, <code>xa_prepare()</code>, and <code>xa_commit()</code> to coordinate a (successful in this case) two-phase commit protocol.
The functions that the TM provides for each RM are called the ax_*( ) functions.
For example an RM calls <code>ax_reg()</code> to register dynamically with the TM.</p>
</div>
</li>
<li>
<p>TM-CRM.
The TM-CRM interface (the XA+ interface) supports global transaction information flow across TM Domains.
In particular TMs can instruct CRMs by use of <code>xa_*()</code> function calls to suspend or complete transaction branches, and to propagate global transaction commitment protocols to other transaction branches.
CRMs pass information to TMs in subordinate branches by use of <code>ax_*()</code> function calls.
CRMs also use <code>ax_*()</code> function calls to request the TM to create subordinate transaction branches, to save and retrieve recovery information, and to inform the TM of the start and end of blocking conditions.</p>
</li>
<li>
<p>AP-CRM.
X/Open provides portable APIs for DTP communication between APs within a global transaction.
The API chosen can significantly influence (and may indeed be fundamental to) the whole architecture of the application.
For this reason, these APIs are frequently referred to in this specification and elsewhere as communication paradigms.
In practice, each paradigm has unique strengths, so X/Open offers the following popular paradigms:</p>
<div class="ulist">
<ul>
<li>
<p>the TxRPC interface (see the referenced TxRPC specification)</p>
</li>
<li>
<p>the XATMI interface (see the referenced XATMI specification)</p>
</li>
<li>
<p>the CPI-C interface (see the referenced CPI-C specification).</p>
<div class="paragraph">
<p>X/Open interfaces, such as the CRM APIs listed above, provide application portability.
The X/Open DTP model imposes few constraints on native CRM APIs.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>CRM-OSI TP. This interface (the XAP-TP interface) provides a programming interface between a CRM and Open Systems Interconnection Distributed Transaction Processing (OSI TP) services.
XAP-TP interfaces with the OSI TP Service and the Presentation Layer of the seven-layer OSI model.
X/Open has defined this interface to support portable implementations of application-specific OSI services.
The use of OSI TP is mandatory for communication between heterogeneous TM domains.
For details of this interface, see the referenced XAP-TP specification and the OSI TP standards.
This interface (the XAP-TP interface) provides a programming interface between a CRM and Open Systems Interconnection Distributed Transaction Processing (OSI TP) services.
XAP-TP interfaces with the OSI TP Service and the Presentation Layer of the seven-layer OSI model.
X/Open has defined this interface to support portable implementations of application-specific OSI services.
The use of OSI TP is mandatory for communication between heterogeneous TM domains.
For details of this interface, see the referenced XAP-TP specification and the OSI TP standards.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Although the aim of the Open Group was providing portable interfaces, only the XA interface appears to be accepted and implemented by a wide range of vendors.</p>
</div>
<div class="paragraph">
<p>XA is a bidirectional interface between resource managers and transaction managers.
This interface specifies two sets of functions.
The first set, called as <code>xa_*()</code> functions are implemented by resource managers for use by the transaction manager.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. XA Interface of X/Open DTP Model for the transaction manager</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Function</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Purpose</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xa_start</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directs a resource manager to associate the subsequent requests by application programs to a transaction identified by the supplied identifier.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xa_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ends the association of a resource manager with the transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xa_prepare</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prepares the resource manager for the commit operation. Issued by the transaction manager in the first phase of the two-phase commit operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xa_commit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commits the transactional operations. Issued by the transaction manager in the second phase of the two-phase commit operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xa_recover</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieves a list of prepared and heuristically committed or heuristically rolled back transactions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xa_forget</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forgets the heuristic transaction associated with the given transaction identifier</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The second set of functions, called as <code>ax_*()</code> functions, are implemented by the transaction manager for use by resource managers.</p>
</div>
<div class="paragraph">
<p>Table 2 - XA Interface of X/Open DTP Model for resource managers</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Function</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Purpose</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ax_reg()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dynamically enlists with the transaction manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ax_unreg()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dynamically delists from the transaction manager.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_overview_of_the_distributed_transaction_processing"><a class="anchor" href="#_overview_of_the_distributed_transaction_processing"></a>Overview of the Distributed Transaction Processing</h5>
<div class="paragraph">
<p>Transaction management is one of the most crucial requirements for enterprise application development.
Most of the large enterprise applications in the domains of finance, banking and electronic commerce rely on transaction processing for delivering their business functionality.</p>
</div>
<div class="paragraph">
<p>Enterprise applications often require concurrent access to distributed data shared amongst multiple components, to perform operations on data.
Such applications should maintain integrity of data (as defined by the business rules of the application) under the following circumstances:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>distributed access to a single resource of data, and</p>
</li>
<li>
<p>access to distributed resources from a single application component.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In such cases, it may be required that a group of operations on (distributed) resources be treated as one unit of work.
In a unit of work, all the participating operations should either succeed or fail and recover together.
This problem is more complicated when</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a unit of work is implemented across a group of distributed components operating on data from multiple resources, and/or</p>
</li>
<li>
<p>the participating operations are executed sequentially or in parallel threads requiring coordination and/or synchronization.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In either case, it is required that success or failure of a unit of work be maintained by the application.
In case of a failure, all the resources should bring back the state of the data to the previous state ( <em>i.e.,</em> the state prior to the commencement of the unit of work).</p>
</div>
<div class="paragraph">
<p>From the programmer&#8217;s perspective a transaction is a scoping mechanism for a collection of actions which must complete as a unit.
It provides a simplified model for exception handling since only two outcomes are possible:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>success - meaning that all actions involved within a transaction are completed</p>
</li>
<li>
<p>failure - no actions complete</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-trans_succes_failure.PNG.png" alt="jts trans succes failure.PNG">
</div>
</div>
</div>
<div class="sect4">
<h5 id="_example_2"><a class="anchor" href="#_example_2"></a>Example</h5>
<div class="paragraph">
<p>To illustrate the reliability expected by the application, let&#8217;s consider the fund transfer example which is familiar to all of us.</p>
</div>
<div class="paragraph">
<p>The Money transfer involves two operations: Deposit and Withdrawal</p>
</div>
<div class="paragraph">
<p>The complexity of implementation doesn&#8217;t matter; money moves from one place to another.
For instance, involved accounts may be either located in the same relational table within a database or located on different databases.</p>
</div>
<div class="paragraph">
<p>A Simple transfer consists on moving money from savings to checking while a Complex transfer can be performed at the end- of- day according to a reconciliation between international banks</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-example_transfer.PNG.png" alt="jts example transfer.PNG">
</div>
</div>
<div class="paragraph">
<p>The concept of a transaction, and a transaction manager (or a transaction processing service) simplifies the construction of such enterprise level distributed applications while maintaining the integrity of data in a unit of work.</p>
</div>
<div class="paragraph">
<p>A transaction is a unit of work that has the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Atomicity</em> – either the whole transaction completes or nothing completes - partial completion is not permitted.</p>
</li>
<li>
<p><em>Consistency</em> – a transaction transforms the system from one consistent state to another.
In other words, On completion of a successful transaction, the data should be in a consistent state.
For example, in the case of relational databases, a consistent transaction should preserve all the integrity constraints defined on the data.</p>
</li>
<li>
<p><em>Isolation</em> –  Each transaction should appear to execute independently of other transactions that may be executing concurrently in the same environment.
The effect of executing a set of transactions serially should be the same as that of running them concurrently.
This requires two things:</p>
<div class="ulist">
<ul>
<li>
<p>During the course of a transaction, intermediate (possibly inconsistent) state of the data should not be exposed to all other transactions.</p>
</li>
<li>
<p>Two concurrent transactions should not be able to operate on the same data.
Database management systems usually implement this feature using locking.</p>
</li>
</ul>
</div>
</li>
<li>
<p><em>Durabiliy</em> – The effects of a completed transaction should always be persistent.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These properties, called as <em>ACID</em> properties, guarantee that a transaction is never incomplete, the data is never inconsistent, concurrent transactions are independent, and the effects of a transaction are persistent.</p>
</div>
<div class="sect5">
<h6 id="_transactional_concepts"><a class="anchor" href="#_transactional_concepts"></a>Transactional Concepts</h6>

</div>
<div class="sect5">
<h6 id="_transaction_components"><a class="anchor" href="#_transaction_components"></a>Transaction Components</h6>
<div class="paragraph">
<p>A collection of actions is said to be transactional if they possess the ACID properties.
These properties are assumed to be ensured, in the presence of failures; if actions involved within the transaction are performed by a Transactional System.
A transaction system includes a set of components where each of them has a particular role.
The main components are described below.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-transaction_components.PNG.png" alt="jts transaction components.PNG">
</div>
</div>
</div>
<div class="sect5">
<h6 id="_application_programs"><a class="anchor" href="#_application_programs"></a>Application Programs</h6>
<div class="paragraph">
<p>Application Programs are clients for the transactional resources.
These are the programs with which the application developer implements business transactions.
With the help of the transaction manager, these components create global transactions and operate on the transactional resources with in the scope of these transactions.
These components are not responsible for implementing mechanisms for preserving ACID properties of transactions.
However, as part of the application logic, these components generally make a decision whether to commit or rollback transactions.</p>
</div>
<div class="paragraph">
<p>Application responsibilities could be summarised as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create and demarcate transactions</p>
</li>
<li>
<p>Operate on data via resource managers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A resource manager is, in general, a component that manages persistent and stable data storage system, and participates in the two phase commit and recovery protocols with the transaction manager.</p>
</div>
<div class="paragraph">
<p>A resource manager is typically a driver that provides two sets of interfaces: one set for the application components to get connections and operating, and the other set for participating in two phase commit and recovery protocols coordinated by a transaction manager.
This component may also, directly or indirectly, register resources with the transaction manager so that the transaction manager can keep track of all the resources participating in a transaction.
This process is called as resource enlistment.</p>
</div>
<div class="paragraph">
<p>Resource Manager responsibilities could be summarised as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enlist resources with the transaction manager</p>
</li>
<li>
<p>Participate in two-phase commit and recovery protocol</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The transaction manager is the core component of a transaction processing environment.
Its main responsibilities are to create transactions when requested by application components, allow resource enlistment and delistment, and to manage the two-phase commit or recovery protocol with the resource managers.</p>
</div>
<div class="paragraph">
<p>A typical transactional application begins a transaction by issuing a request to a transaction manager to initiate a transaction.
In response, the transaction manager starts a transaction and associates it with the calling thread.
The transaction manager also establishes a transaction context.
All application components and/or threads participating in the transaction share the transaction context.
The thread that initially issued the request for beginning the transaction, or, if the transaction manager allows, any other thread may eventually terminate the transaction by issuing a commit or rollback request.</p>
</div>
<div class="paragraph">
<p>Before a transaction is terminated, any number of components and/or threads may perform transactional operations on any number of transactional resources known to the transaction manager.
If allowed by the transaction manager, a transaction may be suspended or resumed before finally completing the transaction.</p>
</div>
<div class="paragraph">
<p>Once the application issues the commit request, the transaction manager prepares all the resources for a commit operation, and based on whether all resources are ready for a commit or not, issues a commit or rollback request to all the resources.</p>
</div>
<div class="paragraph">
<p>Resource Manager responsibilities could be summarised as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Establish and maintain transaction context</p>
</li>
<li>
<p>Maintain association between a transaction and the participating resources.</p>
</li>
<li>
<p>Initiate and conduct two-phase commit and recovery protocol with the resource managers.</p>
</li>
<li>
<p>Make synchronization calls to the application components before beginning and after end of the two-phase commit and recovery process</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="_local_vs_distributed_transaction"><a class="anchor" href="#_local_vs_distributed_transaction"></a>Local vs. Distributed Transaction</h7>
<div class="paragraph">
<p>A transaction that involves only one transactional resource, such a database, is considered as <em>local transaction</em> , while a transaction that involves more than one transactional resource that need to be coordinated to reach a consistent state is considered as a <em>distributed transaction.</em></p>
</div>
<div class="paragraph">
<p>A transaction can be specified by what is known as transaction demarcation.
Transaction demarcation enables work done by distributed components to be bound by a global transaction.
It is a way of marking groups of operations to constitute a transaction.</p>
</div>
<div class="paragraph">
<p>The most common approach to demarcation is to mark the thread executing the operations for transaction processing.
This is called as programmatic demarcation.
The transaction so established can be suspended by unmarking the thread, and be resumed later by explicitly propagating the transaction context from the point of suspension to the point of resumption.</p>
</div>
<div class="paragraph">
<p>The transaction demarcation ends after a commit or a rollback request to the transaction manager.
The commit request directs all the participating resources managers to record the effects of the operations of the transaction permanently.
The rollback request makes the resource managers undo the effects of all operations on the transaction.</p>
</div>
</div>
<div class="sect6">
<h7 id="_transaction_context_and_propagation"><a class="anchor" href="#_transaction_context_and_propagation"></a>Transaction Context and Propagation</h7>
<div class="paragraph">
<p>Since multiple application components and resources participate in a transaction, it is necessary for the transaction manager to establish and maintain the state of the transaction as it occurs.
This is usually done in the form of transaction context.</p>
</div>
<div class="paragraph">
<p>Transaction context is an association between the transactional operations on the resources, and the components invoking the operations.
During the course of a transaction, all the threads participating in the transaction share the transaction context.
Thus the transaction context logically envelops all the operations performed on transactional resources during a transaction.
The transaction context is usually maintained transparently by the underlying transaction manager.</p>
</div>
</div>
<div class="sect6">
<h7 id="_resource_enlistment"><a class="anchor" href="#_resource_enlistment"></a>Resource Enlistment</h7>
<div class="paragraph">
<p>Resource enlistment is the process by which resource managers inform the transaction manager of their participation in a transaction.
This process enables the transaction manager to keep track of all the resources participating in a transaction.
The transaction manager uses this information to coordinate transactional work performed by the resource managers and to drive two-phase and recovery protocol.
At the end of a transaction (after a commit or rollback) the transaction manager delists the resources.</p>
</div>
</div>
<div class="sect6">
<h7 id="_two_phase_commit"><a class="anchor" href="#_two_phase_commit"></a>Two-Phase Commit</h7>
<div class="paragraph">
<p>This protocol between the transaction manager and all the resources enlisted for a transaction ensures that either all the resource managers commit the transaction or they all abort.
In this protocol, when the application requests for committing the transaction, the transaction manager issues a prepare request to all the resource managers involved.
Each of these resources may in turn send a reply indicating whether it is ready for commit or not.
Only The transaction manager issues a commit request to all the resource managers, only when all the resource managers are ready for a commit.
Otherwise, the transaction manager issues a rollback request and the transaction will be rolled back.</p>
</div>
</div>
<div class="sect6">
<h7 id="_recovery_and_logging"><a class="anchor" href="#_recovery_and_logging"></a>Recovery and Logging</h7>
<div class="paragraph">
<p>Basically, the Recovery is the mechanism which preserves the transaction atomicity in presence of failures.
The basic technique for implementing transactions in presence of failures is based on the use of logs.
That is, a transaction system has to record enough information to ensure that it can be able to return to a previous state in case of failure or to ensure that changes committed by a transaction are properly stored.</p>
</div>
<div class="paragraph">
<p>In addition to be able to store appropriate information, all participants within a distributed transaction must log similar information, which allows them to take a same decision either to set data in their final state or in their initial state.</p>
</div>
<div class="paragraph">
<p>Two techniques are, in general, used to ensure transaction&#8217;s atomicity.
A first technique focuses on manipulated data, such as the Do/Undo/Redo protocol (considered as a recovery mechanism in a centralised system), which allows a participant to set its data in their final values or to retrieve them in their initial values.
A second technique relies on a distributed protocol named the two phases commit, ensuring that all participants involved within a distributed transaction set their data either in their final values or in their initial values.
In other words, all participants must commit or all must roll back.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-recovery_logs.PNG.png" alt="jts recovery logs.PNG">
</div>
</div>
<div class="paragraph">
<p>In addition to failures, we refer as centralized such system crashes, communication failures due, for instance, to network outages or message loss have to be considered during the recovery process of a distributed transaction.</p>
</div>
<div class="paragraph">
<p>In order to provide an efficient and optimized mechanism to deal with failure, modern transactional systems typically adopt a “presume abort” strategy, which simplifies the transaction management.</p>
</div>
<div class="paragraph">
<p>The presumed abort strategy can be stated as «when in doubt, abort».
With this strategy, when the recovery mechanism has no information about the transaction, it presumes that the transaction has been aborted.</p>
</div>
<div class="paragraph">
<p>A particularity of the presumed-abort assumption allows a coordinator to not log anything before the commit decision and the participants do not to log anything before they prepare.
Then, any failure which occurs before the 2pc starts leads to abort the transaction.
Furthermore, from a coordinator&#8217;s point of view, any communication failure detected by a timeout or exception raised on sending prepare is considered as a negative vote which leads to abort the transaction.
So, within a distributed transaction, a coordinator or a participant may fail in two ways: either it crashes or it times out for a message it was expecting.
When a coordinator or a participant crashes and then restarts, it uses information on stable storage to determine the way to perform the recovery.
As we will see it the presumed-abort strategy enables an optimized behavior for the recovery.</p>
</div>
</div>
<div class="sect6">
<h7 id="_heuristic_decision"><a class="anchor" href="#_heuristic_decision"></a>Heuristic Decision</h7>
<div class="paragraph">
<p>In extremely rare cases, a resource manager may choose not to wait for the outcome from the transaction manager.
This might occur if the communications path was lost and was not likely to be restored for a very long time.
Typically this happens as a result of human intervention and not as an arbitrary action of a resource manager.
In order to release locks and make this transaction data available to new transactions, the resource manager makes a heuristic decision, i.e. it guesses the proper transaction outcome.
When it does so, it must remember its guess until contact with the transaction manager is ultimately re-established.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_standards"><a class="anchor" href="#_standards"></a>Standards</h6>
<div class="paragraph">
<p>Saying that a distributed transaction can involve several distributed participants, means that these participants must be integrated within a global transaction manager which has the responsibility to ensure that all participants take a common decision to commit or rollback the distributed transaction.
The key of such integration is the existence of a common transactional interface which is understood by all participants, transaction manager and resource managers such as databases.</p>
</div>
<div class="paragraph">
<p>The importance of common interfaces between participants, as well as the complexity of their implementation, becomes obvious in an open systems environment.
For this aim, various distributed transaction processing standards have been developed by international standards organizations.
Among these organizations, We list three of them which are mainly considered in the Narayana product:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The X/Open model and its successful XA interface</p>
</li>
<li>
<p>The OMG with its CORBA infrastructure and the Object Transaction Service and finally</p>
</li>
<li>
<p>The Jakarta Transactions specification process</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Basically, these standards have proposed logical models, which divide transaction processing into several functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>those assigned to the application which ties resources together in application-specific operations</p>
</li>
<li>
<p>those assigned to the Resource manager which access physically to data stores</p>
</li>
<li>
<p>functions performed by the Transaction Manager which manages transactions, and finally</p>
</li>
<li>
<p>Communication Resource Managers which allow exchanging information with other transactional domains.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-standards.PNG.png" alt="jts standards.PNG">
</div>
</div>
</div>
<div class="sect5">
<h6 id="_overview_of_the_omg_object_transaction_service"><a class="anchor" href="#_overview_of_the_omg_object_transaction_service"></a>Overview of the OMG Object Transaction Service</h6>
<div class="paragraph">
<p>Object Transaction Service (OTS) is a distributed transaction processing service specified by the Object Management Group (OMG).
This specification extends the CORBA model and defines a set of interfaces to perform transaction processing across multiple CORBA objects.</p>
</div>
<div class="paragraph">
<p>OTS is based on the Open Group&#8217;s DTP model and is designed so that it can be implemented using a common kernel for both the OTS and Open Group APIs.
In addition to the functions defined by DTP, OTS contains enhancements specifically designed to support the object environment.
Nested transactions and explicit propagation are two examples.</p>
</div>
<div class="paragraph">
<p>The CORBA model also makes some of the functions in DTP unnecessary so these have been consciously omitted.
Static registration and the communications resource manager are unnecessary in the CORBA environment.</p>
</div>
<div class="paragraph">
<p>A key feature of OTS is its ability to share a common transaction with XA compliant resource managers.
This permits the incremental addition of objects into an environment of existing procedural applications.</p>
</div>
<div id="ots_architecture" class="imageblock text-center">
<div class="content">
<img src="images/jts-OTS.PNG.png" alt="jts OTS.PNG">
</div>
<div class="title">Figure 18. OTS Architecture</div>
</div>
<div class="paragraph">
<p>The OTS architecture, shown in the <a href="#ots_architecture">OTS Architecture</a>, consists of the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Transaction Client</em>: A program or object that invokes operations on transactional objects.</p>
</li>
<li>
<p><em>Transactional Object</em>: A CORBA object that encapsulates or refers to persistent data, and whose behavior depends on whether or not its operations are invoked during a transaction.</p>
</li>
<li>
<p><em>Recoverable Object</em>: A transactional object that directly maintains persistent data, and participates in transaction protocols.</p>
</li>
<li>
<p><em>Transactional Server</em>: A collection of one or more transactional objects.</p>
</li>
<li>
<p><em>Recoverable Server</em>: A collection of objects, of which at least one of which is recoverable.</p>
</li>
<li>
<p><em>Resource Object</em>: A resource object is an object in the transaction service that is registered for participation in the two-phase commit and recovery protocol.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to the usual transactional semantics, the CORBA OTS provides for the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Nested Transactions</em>: This allows an application to create a transaction that is embedded in an existing transaction.
In this model, multiple subtransactions can be embedded recursively in a transaction.
Subtransactions can be committed or rolled back without committing or rolling back the parent transaction.
However, the results of a commit operation are contingent upon the commitment of all the transaction&#8217;s ancestors.
The main advantage of this model is that transactional operations can be controlled at a finer granularity.
The application will have an opportunity to correct or compensate for failures at the subtransaction level, without actually attempting to commit the complete parent transaction.</p>
</li>
<li>
<p><em>Application Synchronization</em>: Using the OTS synchronization protocol, certain objects can be registered with the transaction service for notification before the start of and the completion of the two-phase commit process.
This enables such application objects to synchronize transient state and data stored in persistent storage.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_application_programming_models"><a class="anchor" href="#_application_programming_models"></a>Application programming models</h6>
<div class="paragraph">
<p>A client application program may use direct or indirect context management to manage a transaction.
With indirect context management, an application uses the pseudo object called Current, provided by the Transaction Service , to associate the transaction context with the application thread of control.
In direct context management, an application manipulates the Control object and the other objects associated with the transaction.</p>
</div>
<div class="paragraph">
<p>An object may require transactions to be either explicitly or implicitly propagated to its operations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Explicit propagation means that an application propagates a transaction context by passing objects defined by the Transaction Service as explicit parameters.
This should typically be the PropagationContext structure.</p>
</li>
<li>
<p>Implicit propagation means that requests are implicitly associated with the client&#8217;s transaction; they share the client&#8217;s transaction context.
It is transmitted implicitly to the objects, without direct client intervention.
Implicit propagation depends on indirect context management, since it propagates the transaction context associated with the Current pseudo object.
An object that supports implicit propagation would not typically expect to receive any Transaction Service object as an explicit parameter.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A client may use one or both forms of context management, and may communicate with objects that use either method of transaction propagation.
(Details of how to enable implicit propagation were described in Section Chapter 0 and Section 0).
This results in four ways in which client applications may communicate with transactional objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Direct Context Management/Explicit Propagation: the client application directly accesses the Control object, and the other objects which describe the state of the transaction.
To propagate the transaction to an object, the client must include the appropriate Transaction Service object as an explicit parameter of an operation; typically this should be the PropagationContext structure.</p>
</li>
<li>
<p>Indirect Context Management/Implicit Propagation: the client application uses operations on the Current pseudo object to create and control its transactions.
When it issues requests on transactional objects, the transaction context associated with the current thread is implicitly propagated to the object.</p>
</li>
<li>
<p>Indirect Context Management/Explicit Propagation: for an implicit model application to use explicit propagation, it can get access to the Control using the get_control operation on the Current pseudo object.
It can then use a Transaction Service object as an explicit parameter to a transactional object; for efficiency reasons this should be the PropagationContext structure, obtained by calling get_txcontext on the appropriate Coordinator reference.
This is explicit propagation.</p>
</li>
<li>
<p>Direct Context Management/Implicit Propagation: a client that accesses the Transaction Service objects directly can use the resume pseudo object operation to set the implicit transaction context associated with its thread.
This allows the client to invoke operations of an object that requires implicit propagation of the transaction context.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_examples_3"><a class="anchor" href="#_examples_3"></a>Examples</h6>
<div class="ulist">
<ul>
<li>
<p>Indirect and Implicit</p>
<div class="paragraph">
<p>In the code fragments below, a transaction originator uses indirect context management and implicit transaction propagation; txn_crt is an example of an object supporting the Current interface.
The client uses the begin operation to start the transaction whichbecomes implicitly associated with the originator&#8217;s thread of control.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">...
txn_crt.begin();
<span class="comment">// should test the exceptions that might be raised</span>
...
<span class="comment">// the client issues requests, some of which involve</span>
<span class="comment">// transactional objects;</span>
BankAccount.makeDeposit(deposit);
...
txn_crt.commit(<span class="predefined-constant">false</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The program commits the transaction associated with the client thread.
The report_heuristics argument is set to false so no report will be made by the Transaction Service about possible heuristic decisions.</p>
</div>
</li>
<li>
<p>Direct and Explicit</p>
<div class="paragraph">
<p>In the following example, a transaction originator uses direct context management and explicit transaction propagation.
The client uses a factory object supporting the CosTransactions::TransactionFactory interface to create a new transaction and uses the returned Control object to retrieve the Ter mi nat or and Coordinator objects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">...
CosTransactions::<span class="predefined-type">Control</span> ctrl;
CosTransactions::Terminator ter;
CosTransactions::Coordinator coo;
coo = TFactory.create(<span class="integer">0</span>);
ter = ctrl.get_terminator();
...
transactional_object.do_operation(arg, c);
...
t.commit(<span class="predefined-constant">false</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client issues requests, some of which involve transactional objects, in this case explicit propagation of the context is used.
The Control object reference is passed as an explicit parameter of the request; it is declared in the OMG IDL of the interface.
The transaction originator uses the Terminator object to commit the transaction; the report_heuristics argument is set to false: so no report will be made by the Transaction Service about possible heuristic decisions.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The main difference between direct and indirect context management is the effect on the invoking thread&#8217;s transaction context.
If using indirect (i.e., invoking operations through the Current pseudo object), then the thread&#8217;s transaction context will be modified automatically by the OTS, e.g., if begin is called then the thread&#8217;s notion of the current transaction will be modified to the newly created transaction; when that is terminated, the transaction previously associated with the thread (if any) will be restored as the thread&#8217;s context (assuming subtransactions are supported by the OTS implementation).
However, if using direct management, no changes to the threads transaction context are performed by the OTS: the application programmer assumes responsibility for this.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_ots_interfaces"><a class="anchor" href="#_ots_interfaces"></a>OTS Interfaces</h5>
<div id="ots_interfaces" class="imageblock text-center">
<div class="content">
<img src="images/jts-OTS_Interfaces.PNG.png" alt="jts OTS Interfaces.PNG">
</div>
<div class="title">Figure 19. OTS interfaces and their interactions</div>
</div>
<div class="paragraph">
<p>The figure "<a href="#ots_interfaces">OTS interfaces and their interactions</a>" describes the principal interfaces in the CORBA OTS specification, with their interaction, while the <a href="#ots_interfaces_table">OTS Interfaces and their role.</a> below provides more details for each interface.</p>
</div>
<table id="ots_interfaces_table" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. OTS Interfaces and their role.</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Interface</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Role and operations</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Transaction demarcation (begin, commit, rollback, rollback_only, set_time_out)</p>
</li>
<li>
<p>Status of the transaction (get_status)</p>
</li>
<li>
<p>Name of the transaction (get_transaction_name)</p>
</li>
<li>
<p>Transaction context (get_control)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TransactionFactory</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Explicit transaction creation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>create a transaction with its associated cooridinator (create)</p>
</li>
<li>
<p>create an interposed coordinator as a subrodinator in the transaction tree (recreate)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Control</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Explicit transaction context management:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>access to the transaction coordinator (get_coordinator)</p>
</li>
<li>
<p>access to the transactions terminator (get_terminator)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Terminator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commit (commit) or rollback (rollback) a transaction in a direct transaction management mode</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Coordinator</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Status of the transaction (get_status, get_parent_status, get_top_level_status)</p>
</li>
<li>
<p>Transaction information (is_same_transaction, is_related_transaction, is_ancestor_transaction, is_descendant_transaction, is_top_level_transaction, hash_transaciton, hash_top_level_transaction, get_transaction_name, get_txcontext)</p>
</li>
<li>
<p>Resource enlistment (register_resource, register_subtrans_aware)</p>
</li>
<li>
<p>Registration of synchronization objects (register_synchronization)</p>
</li>
<li>
<p>Set the transaction for rollback (rollback_only)</p>
</li>
<li>
<p>Create subtransactions (create_subtransaction)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RecoveryCoordinator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to coordinate recovery in case of failure ( <em>replay_completion</em> )</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Participation in two-phase commit and recovery protocol ( <em>prepare, rollback, commit, commit_one_phase, forget</em> )</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Synchronization</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application synchronization before beginning and after completion of two-phase commit ( <em>before_completion, after_completion</em> )</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SubtransactionAwareResource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commit or rollback a subtransaction ( <em>commit_subtransaction, rollback_subtransaction)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TransactionalObject</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A marker interface to be implemented by all transactional objects (no operation defined)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_managing_transactions_in_jakarta_ee"><a class="anchor" href="#_managing_transactions_in_jakarta_ee"></a>Managing Transactions in Jakarta EE</h5>
<div class="sect5">
<h6 id="_jtajts_architecture"><a class="anchor" href="#_jtajts_architecture"></a>JTA/JTS Architecture</h6>
<div class="paragraph">
<p>The Java transaction initiative consists of two specifications: Java Transaction Service (JTS) and Jakarta Transactions API (also known as JTA).</p>
</div>
<div class="paragraph">
<p>JTS specifies the implementation of a Java transaction manager.
This transaction manager supports the JTA, using which application servers can be built to support transactional Java applications.
Internally, the JTS implements the Java mapping of the OMG OTS specifications.</p>
</div>
<div class="paragraph">
<p>The JTA specifies an architecture for building transactional application servers and defines a set of interfaces for various components of this architecture.
The components are: the application, resource managers, and the application server, as shown in the slide.</p>
</div>
<div class="paragraph">
<p>The JTS thus provides a new architecture for transactional application servers and applications, while complying to the OMG OTS 1.1 interfaces internally.
This allows the JTA compliant applications to interoperate with other OTS 1.1 complaint applications through the standard IIOP.</p>
</div>
<div class="paragraph">
<p>As shown in <a href="#jta_jts_transaction_model">The JTA/JTS transaction model</a>, in the Java transaction model, the Java application components can conduct transactional operations on JTA compliant resources via the JTS.
The JTS acts as a layer over the OTS.
The applications can therefore initiate global transactions to include other OTS transaction managers, or participate in global transactions initiated by other OTS compliant transaction managers.</p>
</div>
<div id="jta_jts_transaction_model" class="imageblock text-center">
<div class="content">
<img src="images/jts-j2ee_1.PNG.png" alt="jts j2ee 1.PNG">
</div>
<div class="title">Figure 20. The JTA/JTS transaction model</div>
</div>
<div class="paragraph">
<p>The Java Transaction Service is architected around an application server and a transaction manager.
The architecture is shown in <a href="#jta_jts_architecture">The JTA/JTS Architecture</a>.</p>
</div>
<div id="jta_jts_architecture" class="imageblock text-center">
<div class="content">
<img src="images/jts-j2ee_2.PNG.png" alt="jts j2ee 2.PNG">
</div>
<div class="title">Figure 21. The JTA/JTS Architecture</div>
</div>
<div class="paragraph">
<p>The JTS architecture consists of the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Transaction Manager</em>: The transaction manager is the core component of this architecture and is provided by an implementation of the JTS.
It provides interfaces to create transactions (including transaction demarcation and propagation of transaction context), allows enlistment and delistment of resources, provides interfaces for registering components for application synchronization, implements the synchronization protocol, and initiates and directs the two phase commit and recovery protocol with the resource managers.</p>
</li>
<li>
<p><em>Application Server</em>: One of the key features of the JTS architecture is that it allows an application server to be built on top of the transaction service and the resources.
Application developers can develop and deploy application components onto the application server for initiating and managing transactions.
The application server can therefore abstract all transactional semantics from the application programs.</p>
</li>
<li>
<p><em>Application Components</em>: These are the clients for the transactional resources and implement business transactions.
These are deployed on the application server.
Depending on the architecture of the application server, these components can directly or indirectly create transactions and operate on the transactional resources.
For example, an Jakarta Enterprise Beans (EJB) server allows declarative transaction demarcation, in which case, the EJB components need not directly implement the transactions.
However, a Java implementation of a CORBA OTS, requires the CORBA object to demarcate transactions explicitly.</p>
</li>
<li>
<p><em>Resource Manager</em>: A resource manager is an X/Open XA compliant component that manages a persistent and stable storage system, and participates in the two phase commit and recovery protocol with the transaction manager.
The application manager also provides interfaces for the application server and the application components to operate on the data managed by it.</p>
</li>
<li>
<p><em>Communication Resource Manager</em>: This allows the transaction manager to participate in transactions initiated by other transaction managers.
However, the JTS specification does not specify any protocol for this communication and assumes that an implementation of the communication resource manager supports the CORBA OTS and GIOP specifications.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_jakarta_transactions_api_formally_jta"><a class="anchor" href="#_jakarta_transactions_api_formally_jta"></a>Jakarta Transactions API (formally JTA)</h6>
<div class="paragraph">
<p>The Jakarta Transactions specification may be classified into three categories of interface as shown in <a href="#jta_interfaces">JTA Interfaces</a>.
The Java Transaction API consists of three elements: a high-level application transaction demarcation interface, a high-level transaction manager interface intended for application server, and a standard Java mapping of the X/Open XA protocol intended for transactional resource manager.</p>
</div>
<div id="jta_interfaces" class="imageblock text-center">
<div class="content">
<img src="images/jts-j2ee_3_API.PNG.png" alt="jts j2ee 3 API.PNG">
</div>
<div class="title">Figure 22. JTA Interfaces</div>
</div>
<div class="sect6">
<h7 id="_transaction_manager_interfaces"><a class="anchor" href="#_transaction_manager_interfaces"></a>Transaction Manager Interfaces</h7>
<div class="ulist">
<ul>
<li>
<p><code>jakarta.transaction.Status</code>: Defines the following flags for the status of a transaction:</p>
</li>
</ul>
</div>
<table id="transaction_status_flags" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Transaction Status Flags</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Flag</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Purpose</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_ACTIVE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is active (started but not prepared)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_COMMITTED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is committed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_COMMITTING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is in the process of committing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_MARKED_ROLLBACK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is marked for rollback.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_NO_TRANSACTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">There is no transaction associated with the current Transaction, UserTransaction or TransactionManager objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_PREPARED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Voting phase of the two phase commit is over and the transaction is prepared.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_PREPARING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is in the process of preparing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_ROLLEDBACK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Outcome of the transaction has been determined as rollback. It is likely that heuristics exists.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_ROLLING_BACK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is in the process of rolling back.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_UNKNOWN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A transaction exists but its current status can not be determined. This is a transient condition</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>jakarta.transaction.Transaction</code>, <code>jakarta.transaction.TransactionManager</code>, and <code>jakarta.transaction.UserTransaction</code> interfaces provide a <code>getStatus</code> method that returns one of the above status flags.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jakarta.transaction.Transaction</code>: An object of this type is created for each global transaction.
This interface provides methods for transaction completion(commit and rollback), resource enlistment (enlistResource) and delistment (delistResource), registration of synchronization objects (registerSynchronization), and query of status of the transaction (getStatus).</p>
</li>
<li>
<p><code>jakarta.transaction.TransactionManager</code>: This interface is implemented by the JTS and allows an application server to communicate with the transaction manager to demarcate transactions (begin, commit, rollback), suspending and resuming transactions (suspend and resume), set the transaction for rollback (setRollbackOnly), get the associated Transaction object (getTransaction), set the transaction timeout interval (setTransactionTimeout) and query the status of the transaction (getStatus).</p>
</li>
<li>
<p><code>jakarta.transaction.UserTransaction</code>: This interface provides methods to begin and end transactions (begin, commit, and rollback), set the transaction for rollback (setRollbackOnly), set the transaction timeout interval (setTransactionTimeout), and get the status of the transaction (getStatus).
Nested transactions are not supported, and begin throws the NotSupportedException when the calling thread is already associated with a transaction.
UserTransaction automatically associates newly created transactions with the invoking thread.</p>
</li>
<li>
<p><code>javax.transaction.xa.Xid</code>: This interface is a Java mapping of the X/Open transaction identifier xid structure.
The transaction manager uses an object of this type to associate a resource manager with a transaction.</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_resource_manager_interfaces"><a class="anchor" href="#_resource_manager_interfaces"></a>Resource Manager Interfaces</h7>
<div class="ulist">
<ul>
<li>
<p><code>javax.transaction.xa.XAResource</code>: This is a Java mapping of the X/Open XA interface, and is implemented by resource managers operating with the JTS.
This interface provides methods to start (start) and end (end) work on behalf of a specified transaction, to prepare a transaction with the current resource (prepare), to end transactions with the current resource (commit, forget, recover, and rollback), to compare the current resource manager with another resource manager (isSameRM), and to get and set the transaction timeout (getTransactionTimeout, setTransactionTimeout).</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_application_interfaces"><a class="anchor" href="#_application_interfaces"></a>Application Interfaces</h7>
<div class="paragraph">
<p>The only interface that an application object could implement is the Synchronization interface.
The application components may have to implement whatever other interfaces are mandated by a given application server.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jakarta.transaction.Synchronization</code>: An object intended to participate in a synchronization protocol with the transaction manager should implement this interface.
This mechanism is based on the Observer pattern.
This interface has two methods - beforeCompletion and afterCompletion to be called before starting and after completing, respectively, the two phase commit operation.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_jakarta_transactions_api_usage"><a class="anchor" href="#_jakarta_transactions_api_usage"></a>Jakarta Transactions API - Usage</h6>
<div class="paragraph">
<p>This section describes the usage of the JTA for implementing various transaction semantics.
The purpose of this section is to provide conceptual guidelines only.</p>
</div>
<div class="sect6">
<h7 id="_transaction_demarcation"><a class="anchor" href="#_transaction_demarcation"></a>Transaction Demarcation</h7>
<div class="paragraph">
<p>The Jakarta Transactions specifies two approaches with which new global transactions can be initiated and demarcated.</p>
</div>
<div class="paragraph">
<p>The application component can then use this object to begin, commit and rollback transactions.
In this approach, association between the calling thread and the transaction, and transaction context propagation are handled transparently by the transaction manager.</p>
</div>
<div class="listingblock">
<div class="title">Usage</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Get a UserTransaction object</span>
<span class="comment">// Begin a transaction</span>
userTransaction.begin();
<span class="comment">// Transactional operations ...</span>
<span class="comment">// End the transaction</span>
userTransaction.commit();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Usage</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Begin a transaction</span>
Transaction t = TransactionManager.begin();
<span class="comment">// Transactional operations ...</span>
<span class="comment">// End the transaction</span>
TransactionManager.commit();</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Application Program Demarcation: The <code>jakarta.transaction.UserTransaction</code> interface provides methods for application components to begin and end transactions programmatically.
The underlying application server should provide a mechanism to obtain a reference to this object.
The Jakarta Transactions specification requires that the application servers use the JNDI for storing references to UserTransaction objects and for lookup.</p>
</li>
<li>
<p>Application Server Controlled Demarcation: In this approach, the <code>jakarta.transaction.TransactionManager</code> interface controls transaction demarcation on behalf of the application being managed.
The transaction manager also maintains the transaction context and its association with the calling threads implicitly.</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_resource_enlistment_and_delistment"><a class="anchor" href="#_resource_enlistment_and_delistment"></a>Resource Enlistment and Delistment</h7>
<div class="paragraph">
<p>Transactional resources such as database connections are typically managed by the application server in conjunction with some resource adapter and optionally with connection pooling optimisation.
In order for an external transaction manager to co-ordinate transactional work performed by the resource managers, the application server must enlist and de-list the resources used in the transaction.
These resources (participants) are enlisted with the transaction so that they can be informed when the transaction terminates, e.g. are driven through the two-phase commit protocol.</p>
</div>
<div class="paragraph">
<p>Jakarta Transactions is much more closely integrated with the XA concept of resources than the arbitrary objects.
For each resource in-use by the application, the application server invokes the enlistResource method with an XAResource object which identifies the resource in use.</p>
</div>
<div class="paragraph">
<p>The enlistment request results in the transaction manager informing the resource manager to start associating the transaction with the work performed through the corresponding resource.
The transaction manager is responsible for passing the appropriate flag in its XAResource.start method call to the resource manager.</p>
</div>
<div class="paragraph">
<p>The delistResource method is used to disassociate the specified resource from the transaction context in the target object.
The application server invokes the method with the two parameters: the XAResource object that represents the resource, and a flag to indicate whether the operation is due to the transaction being suspended (TMSUSPEND), a portion of the work has failed (TMFAIL), or a normal resource release by the application (TMSUCCESS).</p>
</div>
<div class="paragraph">
<p>The de-list request results in the transaction manager informing the resource manager to end the association of the transaction with the target XAResource.
The flag value allows the application server to indicate whether it intends to come back to the same resource whereby the resource states must be kept intact.
The transaction manager passes the appropriate flag value in its XAResource.end method call to the underlying resource manager.</p>
</div>
<div class="paragraph">
<p>The application server can enlist and delist resource managers with the transaction manager using the <code>jakarta.transaction.Transaction</code> interface</p>
</div>
<div class="paragraph">
<div class="title">Usage</div>
<p>Resource enlistment is in general done by the application server when an application requests it for a connection to a transactional resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="comment">// ... an implementation of the application server</span>
<span class="comment">// Get a reference to the underlying TransactionManager object.</span>
...
<span class="comment">// Get the current Transaction object from the TransactionManager.</span>
transaction = transactionManager.getTransaction();
<span class="comment">// Get an XAResource object from a transactional resource.</span>
...
<span class="comment">// Create a Transaction object.</span>
...
<span class="comment">// Enlist the resource</span>
transaction.enlistResource(xaResource);...
<span class="comment">// Return the connection to the application.</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Resource delistment is done similarly after the application closes connections to transactional resources.</p>
</div>
</div>
<div class="sect6">
<h7 id="_application_synchronization_with_a_transaction"><a class="anchor" href="#_application_synchronization_with_a_transaction"></a>Application Synchronization with a Transaction</h7>
<div class="paragraph">
<p>Using the JTS synchronization protocol, certain objects can be registered with the transaction manager for notification before the start of and the completion of the two-phase commit process.
This enables such application objects to synchronize transient state and data stored in persistent storage.</p>
</div>
<div class="paragraph">
<p>The <code>jakarta.transaction.Transaction</code> interface provides the <em>registerSynchronization</em> method to register <code>jakarta.transaction.Synchronization</code> objects with the transaction manager.
The transaction manager then uses the synchronization protocol and calls the beforeCompletion and afterCompletion methods before and after the two phase commit process.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <em>beforeCompletion</em> method is called prior to the start of the two-phase transaction complete process.
This call is executed in the same transaction context of the caller who initiates the TransactionManager.commit or the call is executed with no transaction context if Transaction.commit is used.</p>
</li>
<li>
<p>The <em>afterCompletion</em> method is called after the transaction has completed.
The status of the transaction is supplied in the parameter.
This method is executed without a transaction context.</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_further_reading"><a class="anchor" href="#_further_reading"></a>Further Reading</h7>
<div class="ulist">
<ul>
<li>
<p>JDBC and Transactions</p>
</li>
<li>
<p>Jakarta Enterprise Beans and Transactions</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_managing_transactions_in_ejb"><a class="anchor" href="#_managing_transactions_in_ejb"></a>Managing Transactions in EJB</h5>
<div class="sect5">
<h6 id="_an_application_server_model_the_jakarta_enterprise_beans"><a class="anchor" href="#_an_application_server_model_the_jakarta_enterprise_beans"></a>An Application Server Model - The Jakarta Enterprise Beans</h6>
<div class="sect6">
<h7 id="_ejb_overview"><a class="anchor" href="#_ejb_overview"></a>EJB Overview</h7>
<div class="paragraph">
<p>Jakarta Enterprise Beans (EJB) is a technology specification that specifies a framework for building component-based distributed applications.
As an application server framework, the EJB servers address transaction processing, resource pooling, security, threading, persistence, remote access, life cycle etc.</p>
</div>
<div class="paragraph">
<p>The EJB framework specifies construction, deployment and invocation of components called as enterprise beans.
The EJB specification classifies enterprise beans into two categories: entity beans and session beans.
While entity beans abstract persistent domain data, session beans provide for session-specific application logic.
Both types of beans are maintained by EJB compliant servers in what are called as containers.
A container provides the run time environment for an enterprise bean.
The <a href="#ejb_and_transactions">EJB and Transactions</a> shows a simplified architecture of transaction management in EJB compliant application servers.</p>
</div>
<div id="ejb_and_transactions" class="imageblock text-center">
<div class="content">
<img src="images/jts-j2ee_5_ejb_model.PNG.png" alt="jts j2ee 5 ejb model.PNG">
</div>
<div class="title">Figure 23. EJB and Transactions</div>
</div>
<div class="paragraph">
<p>An enterprise bean is specified by two interfaces: the home interface and the remote interface.
The home interface specifies how a bean can be created or found.
With the help of this interface, a client or another bean can obtain a reference to a bean residing in a container on an EJB server.
The remote interface specifies application-specific methods that are relevant to entity or session beans.</p>
</div>
<div class="paragraph">
<p>Clients obtain references to home interfaces of enterprise beans via the Java Naming and Directory Interface (JNDI) mechanism.
An EJB server should provide a JNDI implementation for any naming and directory server.
Using this reference to the home interface, a client can obtain a reference to the remote interface.
The client can then access methods specified in the remote interface.
The EJB specification specifies the Java Remote Method Invocation (RMI) as the application level protocol for remote method invocation.
However, an implementation can use IIOP as the wire-level protocol.</p>
</div>
<div class="paragraph">
<p>In <a href="#ejb_and_transactions">EJB and Transactions</a>, the client first obtains a reference to the home interface, and then a reference to an instance of Bean A via the home interface.
The same procedure is applicable for instance of Bean A to obtain a reference and invoke methods on an instance of Bean B.</p>
</div>
</div>
<div class="sect6">
<h7 id="_ejb_transaction_model"><a class="anchor" href="#_ejb_transaction_model"></a>EJB Transaction Model</h7>
<div class="paragraph">
<p>The EJB framework does not specify any specific transaction service (such as the JTS) or protocol for transaction management.
However, the specification requires that the <code>jakarta.transaction.UserTransaction</code> interface of the JTS be exposed to enterprise beans.
This interface is required for programmatic transaction demarcation as discussed in the next section.</p>
</div>
<div class="paragraph">
<p>The EJB framework allows both programmatic and declarative demarcation of transactions.
Declarative demarcation is needed for all enterprise beans deployed on the EJB.
In addition, EJB clients can also initiative and end transactions programmatically.</p>
</div>
<div class="paragraph">
<p>The container performs automatic demarcation depending on the transaction attributes specified at the time of deploying an enterprise bean in a container.
The following attributes determine how transactions are created.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>NotSupported</em>: The container invokes the bean without a global transaction context.</p>
</li>
<li>
<p><em>Required</em>: The container invokes the bean within a global transaction context.
If the invoking thread already has a transaction context associated, the container invokes the bean in the same context.
Otherwise, the container creates a new transaction and invokes the bean within the transaction context.</p>
</li>
<li>
<p><em>Supports</em>: The bean is transaction-ready.
If the client invokes the bean within a transaction, the bean is also invoked within the same transaction.
Otherwise, the bean is invoked without a transaction context.</p>
</li>
<li>
<p><em>RequiresNew</em>: The container invokes the bean within a new transaction irrespective of whether the client is associated with a transaction or not.</p>
</li>
<li>
<p><em>Mandatory</em>: The container must invoke the bean within a transaction.
The caller should always start a transaction before invoking any method on the bean.</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_transaction_demarcation_2"><a class="anchor" href="#_transaction_demarcation_2"></a>Transaction Demarcation</h7>
<div class="paragraph">
<p>The EJB framework supports three types of transaction demarcation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Declarative Demarcation</em>: This is also called as container managed demarcation.
The container demarcates transactions on behalf of the bean.
The Required or RequiresNew attribute is specified in a deployment descriptor at the time of deploying the bean on an EJB server.
The bean can use the <code>jakarta.ejb.EJBContext.setRollbackOnly()</code> method to mark the transaction for rollback.</p>
</li>
<li>
<p>Bean Managed Demarcation: This is similar to the client-managed demarcation.</p>
</li>
<li>
<p>Client Managed Demarcation: Java clients can use the <code>jakarta.transaction.UserTransaction</code> interface to demarcate transactions programmatically.</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_resource_enlistment_2"><a class="anchor" href="#_resource_enlistment_2"></a>Resource Enlistment</h7>
<div class="paragraph">
<p>Resource enlistment is automatic with EJB.
The EJB containers automatically enlists connections to EJB-aware resource managers whenever a bean obtains a connection.</p>
</div>
</div>
<div class="sect6">
<h7 id="_application_synchronization"><a class="anchor" href="#_application_synchronization"></a>Application Synchronization</h7>
<div class="paragraph">
<p>The EJB specification provides the jakarta.ejb.SessionSynchronization interface for application synchronization.
When implemented by a bean, the container calls the afterBegin, beforeCompletion and afterCompletion methods for application synchronization during the two-phase commit process.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_jdbc_and_transactions"><a class="anchor" href="#_jdbc_and_transactions"></a>JDBC and Transactions</h5>
<div class="paragraph">
<p>Java Data Base Connectivity, provide Java programs with a way to connect to and use relational databases.
The JDBC API lets you invoke SQL commands from Java programming language methods.
In simplest terms, JDBC allows to do three things</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Establish a connection with a database</p>
</li>
<li>
<p>Send SQL statements</p>
</li>
<li>
<p>Process the results</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following code fragment gives a simple example of these three steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="predefined-type">Connection</span> con = <span class="predefined-type">DriverManager</span>.getConnection(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:myDriver:wombat</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">myLogin</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">myPassword</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Statement</span> stmt = con.createStatement();
<span class="predefined-type">ResultSet</span> rs = stmt.executeQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT a, b, c FROM Table1</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">while</span> (rs.next()) {
    <span class="type">int</span> x = rs.getInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>);
    <span class="predefined-type">String</span> s = rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">b</span><span class="delimiter">&quot;</span></span>);
    <span class="type">float</span> f = rs.getFloat(<span class="string"><span class="delimiter">&quot;</span><span class="content">c</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before the version 2.0 of JDBC, only local transactions controlled by the transaction manager of the DBMS is possible.
To code a JDBC transaction, you invoke the commit and rollback methods of the java.sql.Connection interface.
The beginning of a transaction is implicit.
A transaction begins with the first SQL statement that follows the most recent commit, rollback, or connect statement.
(This rule is generally true, but may vary with DBMS vendor.).
The following example illustrates how transactions are managed by the JDBC API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">void</span> withdraw (<span class="type">double</span> amount) {
    <span class="keyword">try</span> {
        <span class="comment">// A connection opened with JDBC is an AUTO COMMIT mode meaning</span>
        <span class="comment">// that the commitment is automatically performed when the connection</span>
        <span class="comment">// is closed</span>
        <span class="comment">//setAutoCommit to false disable this feature</span>
        connection.setAutoCommit(<span class="predefined-constant">false</span>);
        <span class="comment">//perform an SQL update to Withdraw money from account</span>
        connection.commit();
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
        <span class="keyword">try</span> {
            connection.rollback();
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">Exception</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Transaction failed: </span><span class="delimiter">&quot;</span></span> +  ex.getMessage());
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> sqx) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">Exception</span>(...)
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the version 2.0, a JDBC driver can be involved within a distributed transaction since it supports the XAResource interface that allows to participate to the 2PC protocol.
An application that need to include more than one database can create a JTA transaction.
To demarcate a JTA transaction, the application program invokes the begin, commit, and rollback methods of the <code>jakarta.transaction.UserTransaction</code> interface.
The following code, that can be applied to a bean-managed transaction, demonstrates the UserTransaction methods.
The begin and commit invocations delimit the updates to the database.
If the updates fail, the code invokes the rollback method and throws an Exception.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">void</span> transfer(<span class="type">double</span> amount) {
    UserTransaction ut = context.getUserTransaction();

    <span class="keyword">try</span> {
        ut.begin();
        <span class="comment">// Perform SQL command to debit account 1</span>
        <span class="comment">// Perform SQL command to debit account 2</span>
        ut.commit();
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
        <span class="keyword">try</span> {
            ut.rollback();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex1) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">Exception</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">Rollback failed: </span><span class="delimiter">&quot;</span></span> + ex1.getMessage());
        }
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">Exception</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">Transaction failed: </span><span class="delimiter">&quot;</span></span> + ex.getMessage());
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuring_the_narayana"><a class="anchor" href="#_configuring_the_narayana"></a>Configuring the Narayana</h5>
<div class="paragraph">
<p>This trail provides information on the way to configure environmental variables needed to define the behaviour of transactional applications managed with Narayana.
Basically, the behaviour of the Narayana product is configurable through property attributes.
Although these property attributes may be specified as command line arguments, it is more convenient to organise and initialise them through properties files.</p>
</div>
<div class="sect5">
<h6 id="_properties_file"><a class="anchor" href="#_properties_file"></a>Properties File</h6>
<div class="paragraph">
<p>The properties file named <code>jbossts-properties.xml</code> and located under the &lt;ats_installation_directory&gt;/etc directory is organised as a collection of property names.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">&lt;property&gt;
    name=<span class="string"><span class="delimiter">&quot;</span><span class="content">a_name</span><span class="delimiter">&quot;</span></span>
    value=<span class="string"><span class="delimiter">&quot;</span><span class="content">a_value</span><span class="delimiter">&quot;</span></span>
&lt;/property&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some properties must be specified by the developer while others do not need to be defined and can be used with their default values.
Basically, the properties file that does not provide default values to all its properties is the <code>jbossts-properties.xml</code>.</p>
</div>
<div class="paragraph">
<p>The following table describes some properties in the <code>jbossts-properties.xml</code>, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Name</em>: indicates the name of the property</p>
</li>
<li>
<p><em>Description</em>: explain the aim of the property</p>
</li>
<li>
<p><em>Possible Value</em>: indicates possible value the property can have</p>
</li>
<li>
<p><em>Default Value</em>: shows the default value, if any, assigned to the property</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Name</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Possible Value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Default Value</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.ats.arjuna.objectstore.localOSRoot</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By default, all object states will be stored within the "defaultStore" subdirectory of the object store root. However, this subdirectory can be changed by setting the localOSRoot property variable accordingly</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">defaultStore</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.ats.arjuna.objectstore.objectStoreDir</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the location of the ObjectStore</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PutObjectStoreDirHere</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.ats.arjuna.common.varDir</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana needs to be able to write temporary files to a well known location during execution. By default this location is var. However, by setting the varDir property variable this can be overridden.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">var/tmp</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="_objectstore_management"><a class="anchor" href="#_objectstore_management"></a>ObjectStore management</h6>
<div class="paragraph">
<p>The Narayana layer requires an object store for transaction management logs.
Within the transaction service installation, object store is updated regularly whenever transactions are created, or when Transactional Objects for Java is used.
In a failure-free environment, the only object states which should reside within the object store are those representing objects created with the Transactional Objects for Java API.
However, if failures occur, transaction logs may remain in the object store until crash recovery facilities have resolved the transactions they represent.
As such, it is very important that the contents of the object store are not deleted without due care and attention, as this will make it impossible to resolve in doubt transactions.
In addition, if multiple users share the same object store it is important that they realise this and do not simply delete the contents of the object store assuming it is an exclusive resource.</p>
</div>
<div class="paragraph">
<p>The location of the ObjectStore is specified in via the properrty <code>com.arjuna.ats.arjuna.objectstore.objectStoreDir</code> that can be passed with the java flag "-D".
For convenience this property is defined in the properties file <code>jbossts-properties.xml</code>, and its value is set during the Narayana installation.
At any time, the location of the ObjectStore may be changed.</p>
</div>
</div>
<div class="sect5">
<h6 id="_configuring_output"><a class="anchor" href="#_configuring_output"></a>Configuring Output</h6>
<div class="paragraph">
<p>Sometimes it is desirable, mainly in case of debugging, to have some form of output during execution to trace internal actions performed. Narayana uses the logging tracing mechanism provided by the Arjuna Common Logging Framework (CLF) version 2.4, which provides a high level interface that hides differences that exist between logging APIs such Jakarta log4j, JDK 1.4 logging API or dotnet logging API.</p>
</div>
<div class="paragraph">
<p>With the CLF applications make logging calls on commonLogger objects.
These commonLogger objects pass log messages to Handler for publication.
Both commonLoggers and Handlers may use logging Levels to decide if they are interested in a particular log message.
Each log message has an associated log Level, that gives the importance and urgency of a log message.
The set of possible Log Levels are DEBUG, INFO, WARN, ERROR and FATAL.
Defined Levels are ordered according to their integer values as follows: DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL.</p>
</div>
<div class="paragraph">
<p>The CLF provides an extension to filter logging messages according to finer granularity an application may define.
That is, when a log message is provided to the commonLogger with the DEBUG level, additional conditions can be specified to determine if the log message is enabled or not.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These conditions are applied if and only the DEBUG level is enabled and the log request performed by the application specifies debugging granularity.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When enabled, Debugging is filtered conditionally on three variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Debugging level: this is where the log request with the DEBUG Level is generated from, e.g., constructors or basic methods.</p>
</li>
<li>
<p>Visibility level: the visibility of the constructor, method, etc. that generates the debugging.</p>
</li>
<li>
<p>Facility code: for instance the package or sub-module within which debugging is generated, e.g., the object store.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>According to these variables the Common Logging Framework defines three interfaces.
A particular product may implement its own classes according to its own finer granularity. Narayana uses the default Debugging level and the default Visibility level provided by CLF, but it defines its own Facility Code. Narayana uses the default level assigned to its commonLoggers objects (DEBUG).
However, it uses the finer debugging features to disable or enable debug messages.
Finer values used by the Narayana are defined below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Debugging level – Narayana uses the default values defined in the class <code>com.arjuna.common.util.logging.CommonDebugLevel</code></p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Debug Level</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NO_DEBUGGING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A commonLogger object assigned with this values discard all debug requests</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONSTRUCTORS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from constructors</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DESTRUCTORS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0002</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from finalizers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONSTRUCT_AND_DESTRUCT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONSTRUCTORS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DESTRUCTORS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from constructors and finalizers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FUNCTIONS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x010</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from functions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPERATORS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x020</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from operators, such as equals</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FUNCS_AND_OPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FUNCTIONS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPERATORS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from functions and operations.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_NON_TRIVIAL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONSTRUCT_AND_DESTRUCT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FUNCTIONS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPERATORS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from all non-trivial operations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRIVIAL_FUNCS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0100</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from trivial functions.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRIVIAL_OPERATORS:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0200</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from trivial operations, and operators.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_TRIVIAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRIVIAL_FUNCS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRIVIAL_OPERATORS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from all trivial operations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FULL_DEBUGGING</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>Visibility level – Narayana uses the default values defined in the class com.arjuna.common.util.logging.CommonVisibilityLevel</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Debug Level</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIS_NONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No Diagnostic</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIS_PRIVATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">only from private methods.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIS_PROTECTED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0002</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">only from protected methods.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIS_PUBLIC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0004</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">only from public methods.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIS_PACKAGE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0008</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">only from package methods.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIS_ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xffff</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Full Diagnostic</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>Facility Code – Narayana uses the following values</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Facility Code Level</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_ATOMIC_ACTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">atomic action core module</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_BUFFER_MAN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000004</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">state management (buffer) classes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_ABSTRACT_REC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000008</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">abstract records</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_OBJECT_STORE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000010</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object store implementations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_STATE_MAN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000020</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">state management and StateManager)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_SHMEM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000040</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shared memory implementation classes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_GENERAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000080</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">general classes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_CRASH_RECOVERY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000800</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">detailed trace of crash recovery module and classes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_THREADING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00002000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">threading classes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_JDBC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00008000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDBC 1.0 and 2.0 support</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_RECOVERY_NORMAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00040000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">normal output for crash recovery manager</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To ensure appropriate output, it is necessary to set some of the finer debug properties explicitly as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;properties&gt;</span>
    <span class="comment">&lt;!-- CLF 2.4 properties --&gt;</span>
    <span class="tag">&lt;property</span>
            <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.common.util.logging.DebugLevel</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0x00000000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span>
            <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.common.util.logging.FacilityLevel</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0xffffffff</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span>
            <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.common.util.logging.VisibilityLevel</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0xffffffff</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span>
            <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.common.util.logger</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">log4j</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/properties&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, debugging messages are not enabled since the DebugLevel is set to NO_DEBUGGING (0x00000000).
You can enable debugging by providing one of the appropriate value listed above - for instance with you wish to see all internal actions performed by the RecoveryManager to recover transactions from a failure set the DebugLevel to FULL_DEBUGGING (0xffffffff) and the FacilityCode Level FAC_CRASH_RECOVERY.</p>
</div>
<div class="paragraph">
<p><em>Note</em> : To enable finger debug messages, the logging level should be set to the DEBUG level as described below.</p>
</div>
<div class="paragraph">
<p>From the program point of view a same API is used whatever the underlying logging mechanism, but from a configuration point of view is that the user is totally responsible for the configuration of the underlying logging system.
Hence, the properties of the underlying log system are configured in a manner specific to that log system, e.g., a log4j.properties file in the case that log4j logging is used.
To set the logging level to the DEBUG value, the log4j.properties file can be edited to set that value.</p>
</div>
<div class="paragraph">
<p>The property com.arjuna.common.util.logger allows to select the underlying logging system.
Possible value are listed in the following table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Property Value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">log4j</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log4j logging (log4j classes must be available in the classpath); configuration through the log4j.properties file, which is picked up from the <code>CLASSPATH</code> or given through a System property: log4j.configuration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jdk14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDK 1.4 logging API (only supported on JVMs of version 1.4 or higher). Configuration is done through a file logging.properties in the jre/lib directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">simple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selects the simple JDK 1.1 compatible console-based logger provided by Jakarta Commons Logging</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">csf</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selects CSF-based logging (CSF embeddor must be available)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jakarta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses the default log system selection algorithm of the Jakarta Commons Logging framework</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dotnet</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Selects a .net logging implementation</p>
</div>
<div class="paragraph">
<p>Since a dotnet logger is not currently implemented, this is currently identical to simple. Simple is a purely JDK1.1 console-based log implementation.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">avalon</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses the Avalon Logkit implementation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">noop</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disables all logging</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_orb_portability"><a class="anchor" href="#_orb_portability"></a>ORB Portability</h5>
<div class="sect5">
<h6 id="_introduction_4"><a class="anchor" href="#_introduction_4"></a>Introduction</h6>
<div class="paragraph">
<p>Many ORBs currently in use support different versions of CORBA and/or the Java language mapping.</p>
</div>
<div class="paragraph">
<p>Narayana only supports the new Portable Object Adapter (POA) architecture described in the CORBA 2.3 specification as a replacement for the Basic Object Adapter (BOA).
Unlike the BOA, which was weakly specified and led to a number of different (and often conflicting) implementations, the POA was deliberately designed to reduce the differences between ORB implementations, and thus minimise the amount of re-coding that would need to be done when porting applications from one ORB to another.
However, there is still scope for slight differences between ORB implementations, notably in the area of threading.
Note, instead of talking about the POA, this manual will consider the Object Adapter (OA).</p>
</div>
<div class="paragraph">
<p>Because Narayana must be able to run on a number of different ORBs, we have developed an ORB portability interface which allows entire applications to be moved between ORBs with little or no modifications.
This portability interface is available to the application programmer in the form of several Java classes.</p>
</div>
</div>
<div class="sect5">
<h6 id="_the_orb_portability_api"><a class="anchor" href="#_the_orb_portability_api"></a>The ORB Portability API</h6>

</div>
<div class="sect5">
<h6 id="_using_the_orb"><a class="anchor" href="#_using_the_orb"></a>Using the ORB</h6>
<div class="paragraph">
<p>The ORB class provided in the package com.arjuna.orbportability.ORB shown below provides a uniform way of using the ORB.
There are methods for obtaining a reference to the ORB, and for placing the application into a mode where it listens for incoming connections.
There are also methods for registering application specific classes to be invoked before or after ORB initialisation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ORB</span> {
    <span class="directive">public</span> <span class="directive">static</span> ORB getInstance(<span class="predefined-type">String</span> uniqueId);
    <span class="comment">// given the various parameters,this method initialises the ORB and</span>
    <span class="comment">// retains a reference to it within the ORB class.</span>
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initORB () <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initORB (<span class="predefined-type">Applet</span> a, <span class="predefined-type">Properties</span> p)
        <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initORB (<span class="predefined-type">String</span><span class="type">[]</span> s, <span class="predefined-type">Properties</span> p)
        <span class="directive">throws</span> SystemException;

    <span class="comment">//The orb method returns a reference to the ORB.</span>
    <span class="comment">//After shutdown is called this reference may be null.</span>
    <span class="directive">public</span> <span class="directive">synchronized</span> org.omg.CORBA.ORB orb ();
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setOrb (org.omg.CORBA.ORB theORB);
    <span class="comment">// If supported, this method cleanly shuts down the ORB.</span>
    <span class="comment">// Any pre- and post- ORB shutdown classes which</span>
    <span class="comment">//have been registered will also be called.</span>
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> shutdown ();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> addAttribute (<span class="predefined-type">Attribute</span> p);
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> addPreShutdown (PreShutdown c);
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> addPostShutdown (PostShutdown c);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> destroy () <span class="directive">throws</span> SystemException;
    <span class="comment">//these methods place the ORB into a listening mode,</span>
    <span class="comment">//where it waits for incoming invocations.</span>
    <span class="directive">public</span> <span class="type">void</span> run ();
    <span class="directive">public</span> <span class="type">void</span> run (<span class="predefined-type">String</span> name);
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note, some of the methods are not supported on all ORBs, and in this situation, a suitable exception will be thrown.
The ORB class is a factory class which has no public constructor.
To create an instance of an ORB you must call the <code>getInstance</code> method passing a unique name as a parameter.
If this unique name has not been passed in a previous call to <code>getInstance</code> you will be returned a new ORB instance.
Two invocations of <code>getInstance</code> made with the same unique name, within the same JVM, will return the same ORB instance.</p>
</div>
</div>
<div class="sect5">
<h6 id="_using_the_object_adapater_oa"><a class="anchor" href="#_using_the_object_adapater_oa"></a>Using the Object Adapater (OA)</h6>
<div class="paragraph">
<p>The OA classes shown below provide a uniform way of using Object Adapters (OA).
There are methods for obtaining a reference to the OA.
There are also methods for registering application specific classes to be invoked before or after OA initialisation.
Note, some of the methods are not supported on all ORBs, and in this situation, a suitable exception will be thrown.
The OA class is an abstract class and provides the basic interface to an Object Adapter.
It has two sub-classes RootOA and ChildOA, these classes expose the interfaces specific to the root Object Adapter and a child Object Adapter respectively.
From the RootOA you can obtain a reference to the RootOA for a given ORB by using the static method getRootOA.
To create a ChildOA instance use the createPOA method on the RootOA.</p>
</div>
<div class="paragraph">
<p>As described below, the OA class and its sub-classes provide most operations provided by the POA as specified in the POA specification.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">OA</span>
{
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="directive">static</span> RootOA getRootOA(ORB associatedORB);
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initPOA () <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initPOA (<span class="predefined-type">String</span><span class="type">[]</span> args) <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initOA () <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initOA (<span class="predefined-type">String</span><span class="type">[]</span> args) <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="directive">synchronized</span> ChildOA createPOA (<span class="predefined-type">String</span> adapterName,
        PolicyList policies) <span class="directive">throws</span> AdapterAlreadyExists, InvalidPolicy;
    <span class="directive">public</span> <span class="directive">synchronized</span> org.omg.PortableServer.POA rootPoa ();
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setPoa (org.omg.PortableServer.POA thePOA);
    <span class="directive">public</span> <span class="directive">synchronized</span> org.omg.PortableServer.POA poa (<span class="predefined-type">String</span> adapterName);
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setPoa (<span class="predefined-type">String</span> adapterName,
        org.omg.PortableServer.POA thePOA);
    ...
};

<span class="directive">public</span> <span class="type">class</span> <span class="class">RootOA</span> <span class="directive">extends</span> OA {
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> destroy() <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> org.omg.CORBA.Object corbaReference (Servant obj);
    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady (Servant obj, <span class="type">byte</span><span class="type">[]</span> id);
    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady (Servant obj);
    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject (org.omg.CORBA.Object obj);
    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject (Servant obj);
};

<span class="directive">public</span> <span class="type">class</span> <span class="class">ChildOA</span> <span class="directive">extends</span> OA {
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setRootPoa (POA thePOA);
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> destroy() <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> org.omg.CORBA.Object corbaReference (Servant obj);
    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady (Servant obj, <span class="type">byte</span><span class="type">[]</span> id)
        <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady (Servant obj) <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject (org.omg.CORBA.Object obj);
    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject (Servant obj);
};</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_example_3"><a class="anchor" href="#_example_3"></a>Example</h6>
<div class="paragraph">
<p>The following example illustrates how to use the ORB Portability API to create</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">import</span> <span class="include">com.arjuna.orbportability.ORB</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.orbportability.OA</span>;

<span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    <span class="keyword">try</span> {
        <span class="comment">// Create an ORB instance</span>
        ORB orb = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">orb_test</span><span class="delimiter">&quot;</span></span>);
        OA oa = OA.getRootOA( orb );  <span class="comment">// Get the root POA</span>
        orb.initORB(args, <span class="predefined-constant">null</span>); <span class="comment">// Initialize the ORB</span>
        oa.initOA(args);  <span class="comment">// Initialize the OA</span>
        <span class="comment">// Do Work</span>
        oa.destroy(); <span class="comment">// destroy the OA</span>
        orb.shutdown();  <span class="comment">// Shutdown the ORB</span>
    } <span class="keyword">catch</span>(<span class="exception">Exception</span> e) {

    }
};</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_specifying_the_orb_to_use"><a class="anchor" href="#_specifying_the_orb_to_use"></a>Specifying the ORB to use</h6>
<div class="paragraph">
<p>If using such a JDK (from its version 1.2.2) in conjunction with another ORB it is necessary to tell the JVM which ORB to use.
This happens by specifying the org.omg.CORBA.ORBClass and org.omg.CORBA.ORBSingletonClass properties.
If used, ORB Portability classes will ensure that these properties are automatically set when required, i.e., during ORB initialisation.</p>
</div>
<div class="paragraph">
<p>The ORB portability library attempts to detect which ORB is in use, it does this by looking for the ORB implementation class for each ORB it supports.
This means that if there are classes for more than one ORB in the classpath the wrong ORB can be detected.
Therefore it is best to only have one ORB in your classpath.
If it is necessary to have multiple ORBs in the classpath then the property com.arjuna.orbportability.orbImplementation must be set to the value specified in the table below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>ORB</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Property Value</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JacORB v2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.orbportability.internal.orbspecific.jacorb.orb.implementations.jacorb_2_0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For additional details on the features provided by the ORB Portability API refer to the documentation provided by the Narayana distribution.</p>
</div>
</div>
<div class="sect5">
<h6 id="_narayana_failure_recovery"><a class="anchor" href="#_narayana_failure_recovery"></a>Narayana Failure Recovery</h6>
<div class="paragraph">
<p>The failure recovery subsystem of Narayana will ensure that results of a transaction are applied consistently to all resources affected by the transaction, even if any of the application processes or the machine hosting them crash or lose network connectivity.
In the case of machine (system) crash or network failure, the recovery will not take place until the system or network are restored, but the original application does not need to be restarted recovery responsibility is delegated to the Recovery Manager process (see below).
Recovery after failure requires that information about the transaction and the resources involved survives the failure and is accessible afterward: this information is held in the ActionStore, which is part of the ObjectStore.
If the ObjectStore is destroyed or modified, recovery may not be possible.</p>
</div>
<div class="paragraph">
<p>Until the recovery procedures are complete, resources affected by a transaction that was in progress at the time of the failure may be inaccessible.
For database resources, this may be reported as tables or rows held by "in-doubt transactions".</p>
</div>
</div>
<div class="sect5">
<h6 id="_the_recovery_manager"><a class="anchor" href="#_the_recovery_manager"></a>The Recovery Manager</h6>
<div class="paragraph">
<p>The Recovery Manager is a daemon process responsible for performing crash recovery.
Only one Recovery Manager runs per node.
The Object Store provides persistent data storage for transactions to log data.
During normal transaction processing each transaction will log persistent data needed for the commit phase to the Object Store.
On successfully committing a transaction this data is removed, however if the transaction fails then this data remains within the Object Store.</p>
</div>
<div class="paragraph">
<p>The Recovery Manager functions by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Periodically scanning the Object Store for transactions that may have failed.
Failed transactions are indicated by the presence of log data after a period of time that the transaction would have normally been expected to finish.</p>
</li>
<li>
<p>Checking with the application process which originated the transaction whether the transaction is still in progress or not.</p>
</li>
<li>
<p>Recovering the transaction by re-activating the transaction and then replaying phase two of the commit protocol.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To start the Recovery Manager issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the -test flag is used with the Recovery Manager then it will display a "Ready" message when initialised, i.e.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager -test</code></pre>
</div>
</div>
<div class="paragraph">
<p>On initialization the Recovery Manager first loads in configuration information via a properties file.
This configuration includes a number of recovery activators and recovery modules, which are then dynamically loaded.</p>
</div>
<div class="paragraph">
<p>Each recovery activator, which implements the com.arjuna.ats.arjuna.recovery.RecoveryActivator interface, is used to instantiate a recovery class related to the underlying communication protocol.
Indeed, since the version 3.0 of Narayana, the Recovery Manager is not specifically tied to an Object Request Broker or ORB, which is to specify a recovery instance able to manage the OTS recovery protocol the new interface RecoveryActivator is provided to identify specific transaction protocol.
For instance, when used with OTS, the RecoveryActivitor has the responsibility to create a RecoveryCoordinator object able to respond to the replay_completion operation.</p>
</div>
<div class="paragraph">
<p>All RecoveryActivator instances inherit the same interface.
They are loaded via the following recovery extension property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryActivator_&lt;number</span></span><span class="error">&gt;</span>&quot;
    value=&quot;RecoveryClass&quot;/<span class="error">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For instance the RecoveryActivator provided in the distribution of JTS/OTS, which shall not be commented, is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryActivator_1</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.jts.</span>
        <span class="content">orbspecific.recovery.RecoveryEnablement</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each recovery module, which implements the <code>com.arjuna.ats.arjuna.recovery.RecoveryModule</code> interface, is used to recover a different type of transaction/resource, however each recovery module inherits the same basic behaviour.</p>
</div>
<div class="paragraph">
<p>Recovery consists of two separate passes/phases separated by two timeout periods.
The first pass examines the object store for potentially failed transactions; the second pass performs crash recovery on failed transactions.
The timeout between the first and second pass is known as the backoff period.
The timeout between the end of the second pass and the start of the first pass is the recovery period.
The recovery period is larger than the backoff period.</p>
</div>
<div class="paragraph">
<p>The Recovery Manager invokes the first pass upon each recovery module, applies the backoff period timeout, invokes the second pass upon each recovery module and finally applies the recovery period timeout before restarting the first pass again.</p>
</div>
<div class="paragraph">
<p>The recovery modules are loaded via the following recovery extension property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">com.arjuna.ats.arjuna.recovery.recoveryExtension<span class="tag">&lt;number&gt;</span>=<span class="tag">&lt;RecoveryClass&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The default RecoveryExtension settings are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryExtension1</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.</span>
        <span class="content">arjuna.recovery.AtomicActionRecoveryModule</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryExtension2</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.</span>
        <span class="content">txoj.recovery.TORecoveryModule</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryExtension3</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.</span>
        <span class="content">jts.recovery.transactions.TopLevelTransactionRecoveryModule</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryExtension4</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.</span>
        <span class="content">jts.recovery.transactions.ServerTransactionRecoveryModule</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_configuring_the_recovery_manager"><a class="anchor" href="#_configuring_the_recovery_manager"></a>Configuring the Recovery Manager</h6>

</div>
<div class="sect5">
<h6 id="_periodic_recovery"><a class="anchor" href="#_periodic_recovery"></a>Periodic Recovery</h6>
<div class="paragraph">
<p>The backoff period and recovery period are set using the following properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (default 10 secs) --&gt;</span>
com.arjuna.ats.arjuna.recovery.recoveryBackoffPeriod
<span class="comment">&lt;!-- (default 120 secs) --&gt;</span>
com.arjuna.ats.arjuna.recovery.periodicRecovery</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_expired_entry_removal"><a class="anchor" href="#_expired_entry_removal"></a>Expired entry removal</h6>
<div class="paragraph">
<p>The operation of the recovery subsystem will cause some entries to be made in the ObjectStore that will not be removed in normal progress.
The RecoveryManager has a facility for scanning for these and removing items that are very old.
Scans and removals are performed by implementations of the com.arjuna.ats.arjuna.recovery.ExpiryScanner.
Implementations of this interface are loaded by giving the class name as the value of a property whose name begins with ExperyScanner.</p>
</div>
<div class="paragraph">
<p>The RecoveryManager calls the scan() method on each loaded ExpiryScanner implementation at an interval determined by the property com.arjuna.ats.arjuna.recovery.expiryScanInterval.
This value is given in hours default is 12.
An EXPIRY_SCAN_INTERVAL value of zero will suppress any expiry scanning.
If the value as supplied is positive, the first scan is performed when RecoveryManager starts; if the value is negative, the first scan is delayed until after the first interval (using the absolute value)</p>
</div>
<div class="paragraph">
<p>The default ExpiryScanner is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">&lt;property
    name=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.
        expiryScannerTransactionStatusManager</span><span class="delimiter">&quot;</span></span>
    value=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.arjuna.recovery.
        ExpiredTransactionStatusManagerScanner</span><span class="delimiter">&quot;</span></span>/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following table summarize properties used by the Recovery Manager.
These properties are defined by default the properties file named RecoveryManager-properties.xml.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Name</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Possible Value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Default Value</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.periodicRecoveryPeriod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval in seconds between initiating the periodic recovery modules</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value in seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">120</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.recoveryBackoffPeriod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval in seconds between first and second pass of periodic recovery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value in seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.recoveryExtensionX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates a periodic recovery module to use. X is the occurence number of the recovery module among a set of recovery modules. These modules are invoked in sort-order of names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The class name of the periodic recovery module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana provides a set classes given in the RecoveryManager-properties.xml file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.recoveryActivator_X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates a recovery activator to use. X is the occurence number of the recovery activator among a set of recovery activators.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The class name of the periodic recovery activator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana provide one class that manages the recovery protocol specified by the OTS specification</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.expiryScannerXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expiry scanners to use (order of invocation is random). Names must begin with "com.arjuna.ats.arjuna.recovery.expiryScanner"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana provides one class given in the RecoveryManager-properties.xml file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.expiryScanInterval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval, in hours, between running the expiry scanners. This can be quite long. The absolute value determines the interval - if the value is negative, the scan will NOT be run until after one interval has elapsed. If positive the first scan will be immediately after startup. Zero will prevent any scanning.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value in hours</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.transactionStatusManagerExpiryTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Age, in hours, for removal of transaction status manager item. This should be longer than any ts-using process will remain running. Zero = Never removed.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value in Hours</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.transactionStatusManagerPort</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use this to fix the port on which the TransactionStatusManager listens</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port number (short)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">use a free port</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_installation_content"><a class="anchor" href="#_installation_content"></a>Installation Content</h5>
<div class="sect5">
<h6 id="_verifying_installation"><a class="anchor" href="#_verifying_installation"></a>Verifying Installation</h6>
<div class="paragraph">
<p>When installed, the binary release of Narayana, JTS version, should have the following structure.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>/bin: this directory contains commands to run the OTS transaction manager server (if required) and the Recovery Manager, and scripts to configure environment variables needed to execute Narayana.</p>
</li>
<li>
<p>/docs: this directory contains documentation on the way to installing, administering and programming ArjunaCore, Narayana JTA and Narayana JTS.</p>
</li>
<li>
<p>/etc: this directory contains appropriate properties files that can be used to configure the behaviour of the Narayana.</p>
</li>
<li>
<p>/htdocs: this directory describes all APIs defined by Narayana</p>
</li>
<li>
<p>/idl: this directory contains the CORBA idl files that may be registered with your interface repository prior to running any applications.</p>
</li>
<li>
<p>/jacorb: This directory contains the jacorb distribution.</p>
</li>
<li>
<p>/lib: this directory contains the jar files that contains packages defined by the Narayana.
These jar files shall be added in the <code>CLASSPATH</code></p>
</li>
<li>
<p>/services: this directory contains the appropriates scripts, jar and configuration files allowing to start and stop standalone Transaction Service and Recovery Manager</p>
</li>
<li>
<p>/trail_map: contains examples applications</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_testing_your_installation"><a class="anchor" href="#_testing_your_installation"></a>Testing your installation</h6>
<div class="paragraph">
<p>To ensure that your Narayana installation is fully operational, we will run the simple demo.</p>
</div>
<div class="paragraph">
<p>Please follow these steps before running the transactional applications</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure you have the Ant build system installed.
Ant is a Java build tool, similar to make.
It is available for free from <a href="http://ant.apache.org/" class="bare">http://ant.apache.org/</a> The sample application requires version 1.5.1 or later.</p>
</li>
<li>
<p>The <code>PATH</code> and <code>CLASSPATH</code> environment variables need to be set appropriately to use Narayana.
To make this easier, we provide a shell script <code>setup_env.sh</code> (and for Windows a batch file <code>setup_env.bat</code>) in the directory <code>&lt;jbossts_install_root&gt;/bin/</code></p>
</li>
<li>
<p>From a command prompt, cd to the directory containing the <code>build.xml</code> file (<code>&lt;jbossts_install_root&gt;/trail_map</code>) and type 'ant'.
This will compile a set of sources files located under <code>&lt;jbossts_install_root&gt;/trail_map/src</code> then create an application .jar file named <code>jbossts-demo.jar</code> under the directory <code>&lt;jbossts_install_root&gt;/trail_map/lib</code></p>
</li>
<li>
<p>Add the generated jar file to the <code>CLASSPATH</code> environment variable.</p>
</li>
<li>
<p>Ensure that the jacorb is added in your <code>CLASSPATH</code>.
Use only the patched version that ships with Narayana.</p>
<div class="paragraph">
<p><em>Ensure that Narayana jar files appear before jacorb jar files.</em></p>
</div>
</li>
<li>
<p>Start the server <code>src/com/arjuna/demo/simple/HelloServer.java</code> (HelloServer.java).</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The source code for the trailmap is fully documented and can often contain very useful tips and information that may not be reflected elsewhere in the trailmap</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.simple.HelloServer</code></pre>
</div>
</div>
</li>
<li>
<p>Open another command prompt, go to the same <code>/trail_map</code> directory and start the client <code>src/com/arjuna/demo/simple/HelloClient.java</code> (HelloClient.java). Be sure that the environment variable <code>CLASSPATH</code> is set with the same value as explained above.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.simple.HelloClient</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the client window you should see the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Creating a transaction !
Call the Hello Server !
Commit transaction
Done</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the server, which must be stopped by hand, you should see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Hello - called within a scope of a transaction</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_setting_properties"><a class="anchor" href="#_setting_properties"></a>Setting properties</h6>
<div class="paragraph">
<p>Narayana has been designed to be highly configurable at runtime through the use of various property attributes.
Although these attributes can be provided at runtime on the command line, it is possible (and may be more convenient) to specify them through the properties file <code>jbossts-properties.xml</code> located under the <code>/etc</code> directory of the Narayana distribution.</p>
</div>
<div class="paragraph">
<p>More details on the way to configure the behavior of Narayana can be found in the section on configuration.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_specifying_the_orb_to_use_2"><a class="anchor" href="#_specifying_the_orb_to_use_2"></a>Specifying the ORB to use</h5>
<div class="paragraph">
<p>JDK releases from 1.2.2 onwards include a minimum ORB implementation from Sun.
If using such a JDK in conjunction with another ORB it is necessary to tell the JVM which ORB to use.
This happens by specifying the <em>org.omg.CORBA.ORBClass</em> and <em>org.omg.CORBA.ORBSingletonClass</em> properties.
In earlier versions of the Narayana it was necessary to specify these properties explicitly, either on the command line of in the properties file.
However, it is no longer a requirement to do this, as the ORB Portability classes will ensure that these properties are automatically set when required.
Of course it is still possible to specify these values explicitly (and necessary if not using the ORB initialization methods)</p>
</div>
</div>
<div class="sect4">
<h5 id="_overview_of_the_distributed_transaction_processing_2"><a class="anchor" href="#_overview_of_the_distributed_transaction_processing_2"></a>Overview of the Distributed Transaction Processing</h5>
<div class="paragraph">
<p>Transaction management is one of the most crucial requirements for enterprise application development.
Most of the large enterprise applications in the domains of finance, banking and electronic commerce rely on transaction processing for delivering their business functionality.</p>
</div>
<div class="paragraph">
<p>Enterprise applications often require concurrent access to distributed data shared amongst multiple components, to perform operations on data.
Such applications should maintain integrity of data (as defined by the business rules of the application) under the following circumstances:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>distributed access to a single resource of data, and</p>
</li>
<li>
<p>access to distributed resources from a single application component.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In such cases, it may be required that a group of operations on (distributed) resources be treated as one unit of work.
In a unit of work, all the participating operations should either succeed or fail and recover together.
This problem is more complicated when</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a unit of work is implemented across a group of distributed components operating on data from multiple resources, and/or</p>
</li>
<li>
<p>the participating operations are executed sequentially or in parallel threads requiring coordination and/or synchronization.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In either case, it is required that success or failure of a unit of work be maintained by the application.
In case of a failure, all the resources should bring back the state of the data to the previous state ( <em>i.e.,</em> the state prior to the commencement of the unit of work).</p>
</div>
<div class="paragraph">
<p>From the programmer&#8217;s perspective a transaction is a scoping mechanism for a collection of actions which must complete as a unit.
It provides a simplified model for exception handling since only two outcomes are possible:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>success - meaning that all actions involved within a transaction are completed</p>
</li>
<li>
<p>failure - no actions complete</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_example_4"><a class="anchor" href="#_example_4"></a>Example</h5>
<div class="paragraph">
<p>To illustrate the reliability expected by the application, let’s consider the fund transfer example which is familiar to all of us.</p>
</div>
<div class="paragraph">
<p>The Money transfer involves two operations: Deposit and Withdrawal</p>
</div>
<div class="paragraph">
<p>The complexity of implementation doesn&#8217;t matter; money moves from one place to another.
For instance, involved accounts may be either located in the same relational table within a database or located on different databases.</p>
</div>
<div class="paragraph">
<p>A Simple transfer consists on moving money from savings to checking while a Complex transfer can be performed at the end-of-day according to a reconciliation between international banks</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-example_transfer.PNG.png" alt="jts example transfer.PNG">
</div>
</div>
<div class="sect5">
<h6 id="_what_is_a_transaction"><a class="anchor" href="#_what_is_a_transaction"></a>What is a Transaction?</h6>
<div class="paragraph">
<p>The concept of a transaction, and a transaction manager (or a transaction processing service) simplifies construction of such enterprise level distributed applications while maintaining integrity of data in a unit of work.</p>
</div>
<div class="paragraph">
<p>A transaction is a unit of work that has the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Atomicity</em>: either the whole transaction completes or nothing completes - partial completion is not permitted.</p>
</li>
<li>
<p><em>Consistency</em>: a transaction transforms the system from one consistent state to another.
In other words, On completion of a successful transaction, the data should be in a consistent state.
For example, in the case of relational databases, a consistent transaction should preserve all the integrity constraints defined on the data.</p>
</li>
<li>
<p><em>Isolation</em>: Each transaction should appear to execute independently of other transactions that may be executing concurrently in the same environment.
The effect of executing a set of transactions serially should be the same as that of running them concurrently.
This requires two things:</p>
<div class="ulist">
<ul>
<li>
<p>During the course of a transaction, intermediate (possibly inconsistent) state of the data should not be exposed to all other transactions.</p>
</li>
<li>
<p>Two concurrent transactions should not be able to operate on the same data.
Database management systems usually implement this feature using locking.</p>
</li>
</ul>
</div>
</li>
<li>
<p><em>Durability</em>: The effects of a completed transaction should always be persistent.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These properties, called as <em>ACID</em> properties, guarantee that a transaction is never incomplete, the data is never inconsistent, concurrent transactions are independent, and the effects of a transaction are persistent.</p>
</div>
</div>
<div class="sect5">
<h6 id="_transactional_concepts_2"><a class="anchor" href="#_transactional_concepts_2"></a>Transactional Concepts</h6>
<div class="sect6">
<h7 id="_transaction_components_2"><a class="anchor" href="#_transaction_components_2"></a>Transaction Components</h7>
<div class="paragraph">
<p>A collection of actions is said to be transactional if they possess the ACID properties.
These properties are assumed to be ensured, in the presence of failures; if actions involved within the transaction are performed by a Transactional System.
A transaction system includes a set of components where each of them has a particular role.
Main components are described below.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-transaction_components.PNG.png" alt="jts transaction components.PNG">
</div>
</div>
</div>
<div class="sect6">
<h7 id="_application_programs_2"><a class="anchor" href="#_application_programs_2"></a>Application Programs</h7>
<div class="paragraph">
<p>Application Programs are clients for the transactional resources.
These are the programs with which the application developer implements business transactions.
With the help of the transaction manager, these components create global transactions and operate on the transactional resources with in the scope of these transactions.
These components are not responsible for implementing mechanisms for preserving ACID properties of transactions.
However, as part of the application logic, these components generally make a decision whether to commit or rollback transactions.</p>
</div>
<div class="paragraph">
<p>Application responsibilities could be summarised as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create and demarcate transactions</p>
</li>
<li>
<p>Operate on data via resource managers</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_resource_managers"><a class="anchor" href="#_resource_managers"></a>Resource Managers</h7>
<div class="paragraph">
<p>A resource manager is, in general, a component that manages persistent and stable data storage system, and participates in the two phase commit and recovery protocols with the transaction manager.</p>
</div>
<div class="paragraph">
<p>A resource manager is typically a driver that provides two sets of interfaces: one set for the application components to get connections and operating, and the other set for participating in two phase commit and recovery protocols coordinated by a transaction manager.
This component may also, directly or indirectly, register resources with the transaction manager so that the transaction manager can keep track of all the resources participating in a transaction.
This process is called as resource enlistment.</p>
</div>
<div class="paragraph">
<p>Resource Manager responsibilities could be summarised as follows</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enlist resources with the transaction manager</p>
</li>
<li>
<p>Participate in two-phase commit and recovery protocol</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_transaction_manager"><a class="anchor" href="#_transaction_manager"></a>Transaction Manager</h7>
<div class="paragraph">
<p>The transaction manager is the core component of a transaction processing environment.
Its main responsibilities are to create transactions when requested by application components, allow resource enlistment and delistment, and to manage the two-phase commit or recovery protocol with the resource managers.</p>
</div>
<div class="paragraph">
<p>A typical transactional application begins a transaction by issuing a request to a transaction manager to initiate a transaction.
In response, the transaction manager starts a transaction and associates it with the calling thread.
The transaction manager also establishes a transaction context.
All application components and/or threads participating in the transaction share the transaction context.
The thread that initially issued the request for beginning the transaction, or, if the transaction manager allows, any other thread may eventually terminate the transaction by issuing a commit or rollback request.</p>
</div>
<div class="paragraph">
<p>Before a transaction is terminated, any number of components and/or threads may perform transactional operations on any number of transactional resources known to the transaction manager.
If allowed by the transaction manager, a transaction may be suspended or resumed before finally completing the transaction.</p>
</div>
<div class="paragraph">
<p>Once the application issues the commit request, the transaction manager prepares all the resources for a commit operation, and based on whether all resources are ready for a commit or not, issues a commit or rollback request to all the resources.</p>
</div>
<div class="paragraph">
<p>Resource Manager responsibilities could be summarised as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Establish and maintain transaction context</p>
</li>
<li>
<p>Maintain association between a transaction and the participating resources.</p>
</li>
<li>
<p>Initiate and conduct two-phase commit and recovery protocol with the resource managers.</p>
</li>
<li>
<p>Make synchronization calls to the application components before beginning and after end of the two-phase commit and recovery process</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_local_vs_distributed_transaction_2"><a class="anchor" href="#_local_vs_distributed_transaction_2"></a>Local vs. Distributed Transaction</h7>
<div class="paragraph">
<p>A transaction that involves only one transactional resource, such a database, is considered as <em>local transaction</em> , while a transaction that involves more than one transactional resource that need to be coordinated to reach a consistent state is considered as a <em>distributed transaction.</em></p>
</div>
<div class="paragraph">
<p>A transaction can be specified by what is known as transaction demarcation.
Transaction demarcation enables work done by distributed components to be bound by a global transaction.
It is a way of marking groups of operations to constitute a transaction.</p>
</div>
<div class="paragraph">
<p>The most common approach to demarcation is to mark the thread executing the operations for transaction processing.
This is called as programmatic demarcation.
The transaction so established can be suspended by unmarking the thread, and be resumed later by explicitly propagating the transaction context from the point of suspension to the point of resumption.</p>
</div>
<div class="paragraph">
<p>The transaction demarcation ends after a commit or a rollback request to the transaction manager.
The commit request directs all the participating resources managers to record the effects of the operations of the transaction permanently.
The rollback request makes the resource managers undo the effects of all operations on the transaction.</p>
</div>
</div>
<div class="sect6">
<h7 id="_transaction_context_and_propagation_2"><a class="anchor" href="#_transaction_context_and_propagation_2"></a>Transaction Context and Propagation</h7>
<div class="paragraph">
<p>Since multiple application components and resources participate in a transaction, it is necessary for the transaction manager to establish and maintain the state of the transaction as it occurs.
This is usually done in the form of transaction context.</p>
</div>
<div class="paragraph">
<p>Transaction context is an association between the transactional operations on the resources, and the components invoking the operations.
During the course of a transaction, all the threads participating in the transaction share the transaction context.
Thus the transaction context logically envelops all the operations performed on transactional resources during a transaction.
The transaction context is usually maintained transparently by the underlying transaction manager.</p>
</div>
</div>
<div class="sect6">
<h7 id="_resource_enlistment_3"><a class="anchor" href="#_resource_enlistment_3"></a>Resource Enlistment</h7>
<div class="paragraph">
<p>Resource enlistment is the process by which resource managers inform the transaction manager of their participation in a transaction.
This process enables the transaction manager to keep track of all the resources participating in a transaction.
The transaction manager uses this information to coordinate transactional work performed by the resource managers and to drive two-phase and recovery protocol.
At the end of a transaction (after a commit or rollback) the transaction manager delists the resources.</p>
</div>
</div>
<div class="sect6">
<h7 id="_two_phase_commit_2"><a class="anchor" href="#_two_phase_commit_2"></a>Two-Phase Commit</h7>
<div class="paragraph">
<p>This protocol between the transaction manager and all the resources enlisted for a transaction ensures that either all the resource managers commit the transaction or they all abort.
In this protocol, when the application requests for committing the transaction, the transaction manager issues a prepare request to all the resource managers involved.
Each of these resources may in turn send a reply indicating whether it is ready for commit or not.
Only The transaction manager issue a commit request to all the resource managers, only when all the resource managers are ready for a commit.
Otherwise, the transaction manager issues a rollback request and the transaction will be rolled back.</p>
</div>
</div>
<div class="sect6">
<h7 id="_recovery_and_logging_2"><a class="anchor" href="#_recovery_and_logging_2"></a>Recovery and Logging</h7>
<div class="paragraph">
<p>Basically, the Recovery is the mechanism which preserves the transaction atomicity in presence of failures.
The basic technique for implementing transactions in presence of failures is based on the use of logs.
That is, a transaction system has to record enough information to ensure that it can be able to return to a previous state in case of failure or to ensure that changes committed by a transaction are properly stored.</p>
</div>
<div class="paragraph">
<p>In addition to be able to store appropriate information, all participants within a distributed transaction must log similar information which allow them to take a same decision either to set data in their final state or in their initial state.</p>
</div>
<div class="paragraph">
<p>Two techniques are in general used to ensure transaction&#8217;s atomicity.
A first technique focuses on manipulated data, such the Do/Undo/Redo protocol (considered as a recovery mechanism in a centralized system), which allow a participant to set its data in their final values or to retrieve them in their initial values.
A second technique relies on a distributed protocol named the two phases commit, ensuring that all participants involved within a distributed transaction set their data either in their final values or in their initial values.
In other words all participants must commit or all must rollback.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-recovery_logs.PNG.png" alt="jts recovery logs.PNG">
</div>
</div>
<div class="paragraph">
<p>In addition to failures we refer as centralized such system crashes, communication failures due for instance to network outages or message loss have to be considered during the recovery process of a distributed transaction.</p>
</div>
<div class="paragraph">
<p>In order to provide an efficient and optimized mechanism to deal with failure, modern transactional systems typically adopt a “presume abort” strategy, which simplifies the transaction management.</p>
</div>
<div class="paragraph">
<p>The presumed abort strategy can be stated as «when in doubt, abort».
With this strategy, when the recovery mechanism has no information about the transaction, it presumes that the transaction has been aborted.</p>
</div>
<div class="paragraph">
<p>A particularity of the presumed-abort assumption allows a coordinator to not log anything before the commit decision and the participants do not to log anything before they prepare.
Then, any failure which occurs before the 2PC starts leads to abort the transaction.
Furthermore, from a coordinator&#8217;s point of view, any communication failure detected by a timeout or exception raised on sending prepare is considered as a negative vote which leads to abort the transaction.
So, within a distributed transaction, a coordinator or a participant may fail in two ways: either it crashes or it times out for a message it was expecting.
When a coordinator or a participant crashes and then restarts, it uses information on stable storage to determine the way to perform the recovery.
As we will see it the presumed-abort strategy enable an optimized behavior for the recovery.</p>
</div>
</div>
<div class="sect6">
<h7 id="_heuristic_decision_2"><a class="anchor" href="#_heuristic_decision_2"></a>Heuristic Decision</h7>
<div class="paragraph">
<p>In extremely rare cases, a resource manager may choose not to wait for the outcome from the transaction manager.
This might occur if the communications path was lost and was not likely to be restored for a very long time.
Typically, this happens as a result of human intervention and not as an arbitrary action of a resource manager.
In order to release locks and make this transaction data available to new transactions, the resource manager makes a heuristic decision, i.e. it guesses the proper transaction outcome.
When it does so, it must remember its guess until contact with the transaction manager is ultimately re-established.</p>
</div>
</div>
<div class="sect6">
<h7 id="_standards_2"><a class="anchor" href="#_standards_2"></a>Standards</h7>
<div class="paragraph">
<p>Saying that a distributed transaction can involve several distributed participants, means that these participant must be integrated within a global transaction manager which has the responsibility to ensure that all participants take a common decision to commit or rollback the distributed transaction.
The key of such integration is the existence of a common transactional interface which is understood by all participants, transaction manager and resource managers such databases.</p>
</div>
<div class="paragraph">
<p>The importance of common interfaces between participants, as well as the complexity of their implementation, becomes obvious in an open systems environment.
For this aim, various distributed transaction processing standards have been developed by international standards organizations.
Among these organizations, We list three of them which are mainly considered in the Narayana product:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The X/Open model and its successful XA interface</p>
</li>
<li>
<p>The OMG with its CORBA infrastructure and the Object Transaction Service and finally</p>
</li>
<li>
<p>The Java Community Process led by Sun with its JTA/JTS specification</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Basically these standards have proposed logical models, which divide transaction processing into several functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>those assigned to the application which ties resources together in application-specific operations</p>
</li>
<li>
<p>those assigned to the Resource manager which access physically to data stores</p>
</li>
<li>
<p>functions performed by the Transaction Manager which manages transactions, and finally</p>
</li>
<li>
<p>Communication Resource Managers which allow exchanging information with other transactional domains.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-standards.PNG.png" alt="jts standards.PNG">
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_narayana_overview"><a class="anchor" href="#_narayana_overview"></a>Narayana Overview</h5>
<div class="paragraph">
<p>Narayana assures complete, accurate business transactions for any Java based applications, including those written for the Jakarta EE and EJB frameworks.</p>
</div>
<div class="paragraph">
<p>Narayana is a 100% Java implementation of a distributed transaction management system based on the Jakarta EE Java Transaction Service (JTS) standard.
Our implementation of the JTS utilizes the Object Management Group&#8217;s (OMG) Object Transaction Service (OTS) model for transaction interoperability as recommended in the Jakarta EE and EJB standards.
Although any JTS-compliant product will allow Java objects to participate in transactions, one of the key features of Narayana is it&#8217;s 100% Java implementation.
This allows Narayana to support fully distributed transactions that can be coordinated by distributed parties.</p>
</div>
<div class="paragraph">
<p>Narayana runs can be run both as an embedded distributed service of an application server (e.g. WildFly Application Server), affording the user all the added benefits of the application server environment such as real-time load balancing, unlimited linear scalability and unmatched fault tolerance that allows you to deliver an always-on solution to your customers.
It is also available as a free-standing Java Transaction Service.</p>
</div>
<div class="paragraph">
<p>In addition to providing full compliance with the latest version of the JTS specification, Narayana leads the market in providing many advanced features such as fully distributed transactions and ORB portability with POA support.</p>
</div>
<div class="paragraph">
<p>Narayana works on a number of operating systems including Red Hat linux, Sun Solaris and Microsoft Windows XP.
It requires a Java 5 or later environment.</p>
</div>
<div class="paragraph">
<p>The Java Transaction API support for Narayana comes in two flavours:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a purely local implementation that does not require an ORB, but obviously requires all coordinated resources to reside within the same JVM.</p>
</li>
<li>
<p>a fully distributed implementation.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="_key_features"><a class="anchor" href="#_key_features"></a>Key features</h6>
<div class="ulist">
<ul>
<li>
<p>fully compliant with the Jakarta Transactions 2.0 specification:</p>
<div class="ulist">
<ul>
<li>
<p>Purely local (ORB-less) JTA offers the fastest JTA performance</p>
</li>
<li>
<p>JDBC 3 support</p>
</li>
<li>
<p>XA compliance</p>
</li>
<li>
<p>JDBC drivers for database access with full transaction support</p>
</li>
<li>
<p>Automatic crash recovery for XAResources</p>
</li>
</ul>
</div>
</li>
<li>
<p>compliance with the JTS specification and OTS 1.2 specification from the OMG</p>
<div class="ulist">
<ul>
<li>
<p>Distributed JTA implementation</p>
</li>
<li>
<p>support for distributed transactions (utilizing two-phase commit)</p>
</li>
<li>
<p>POA ORB support</p>
</li>
<li>
<p>interposition</p>
</li>
<li>
<p>transaction heuristics</p>
</li>
<li>
<p>distributed transaction manager (co-located with the transaction initiator) or transaction manager server</p>
</li>
<li>
<p>checked/unchecked transaction behaviour</p>
</li>
<li>
<p>supports both flat and nested transaction models, with nested-aware resources and resource adapters</p>
</li>
<li>
<p>independent concurrency control system with support for type-specific concurrency control</p>
</li>
<li>
<p>support for CosTransaction::Current</p>
</li>
<li>
<p>direct and indirect transaction management</p>
</li>
<li>
<p>synchronization interface</p>
</li>
<li>
<p>explicit and implicit transaction context propagation</p>
</li>
<li>
<p>automatic crash recovery</p>
</li>
<li>
<p>multi-thread aware</p>
</li>
</ul>
</div>
</li>
<li>
<p>transactional objects (TO) for Java</p>
</li>
<li>
<p>ORB independence via the ORB portability layer</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_the_sample_application"><a class="anchor" href="#_the_sample_application"></a>The Sample Application</h5>
<div class="sect5">
<h6 id="_the_banking_application"><a class="anchor" href="#_the_banking_application"></a>The Banking Application</h6>
<div class="paragraph">
<p>The sample application consists of a banking application that involves a bank able to manage accounts on behalf of clients.
Clients can obtain information on accounts and perform operations such credit, withdraw and transfer money from one account to an other.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-banking_application_1.PNG.png" alt="jts banking application 1.PNG">
</div>
<div class="title">Figure 24. The Banking Applications</div>
</div>
<div class="paragraph">
<p>The client application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Initializes the banking object.</p>
</li>
<li>
<p>Choose an operation to be performed on the banking object.
Possible operations are:</p>
<div class="ulist">
<ul>
<li>
<p>Create Account: this operation asks the bank to create a new account credit it with the first amount provided in the request.
The creation consists:</p>
<div class="ulist">
<ul>
<li>
<p>to create an Account Object, then</p>
</li>
</ul>
</div>
</li>
<li>
<p>Get Balance: this operation invokes the bank to obtain the balance of an account.</p>
<div class="ulist">
<ul>
<li>
<p>the account is first returned by the bank, then</p>
</li>
<li>
<p>the account is asked to return its balance</p>
</li>
</ul>
</div>
</li>
<li>
<p>Withdraw: this operation is invoked to withdraw money from an account.
If the final balance is negative, the withdraw is refused and the associated transaction aborted</p>
</li>
<li>
<p>Credit: this operation is performed to credit an account</p>
</li>
<li>
<p>Transfer: This operation is used to transfer money from an account to another.
If the transfer leads to get a negative balance of the debited account, the transfer is refused and the associated transaction is aborted.</p>
</li>
<li>
<p>Exit: This operation terminates the client</p>
</li>
</ul>
</div>
</li>
<li>
<p>Waits for a response.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Bank Object</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creates Account Objects using name</p>
</li>
<li>
<p>Maintains the list of created Accounts</p>
</li>
<li>
<p>Returns, when asked, the Account Object requested by the client.
If the Account doesn&#8217;t exist an exception is returned to the client.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An Account Object</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Performs operations requested by the client</p>
<div class="ulist">
<ul>
<li>
<p>credit,</p>
</li>
<li>
<p>withdraw (debit), and</p>
</li>
<li>
<p>return the current balance.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each operation provided to the client leads to the creation of a transaction; therefore in order to commit or rollback changes made on an account, a resource is associated with the account to participate to the transaction commitment protocol.
According to the final transaction decision, the resource is able to set the Account either to its initial state (in case of rollback) or to the final state (in case of commit).
From the transactional view, Figure 2 depicts of transactional components.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-banking_application_2.PNG.png" alt="jts banking application 2.PNG">
</div>
<div class="title">Figure 25. The Banking Application and the transactional Component</div>
</div>
</div>
<div class="sect5">
<h6 id="_deploying_and_testing_the_banking_application"><a class="anchor" href="#_deploying_and_testing_the_banking_application"></a>Deploying and Testing The Banking Application</h6>
<div class="paragraph">
<p>Assuming that the Narayana product has been installed, this trail provides a set of examples that show how to build transactional applications.
Two types of transactional applications are presented, those using the JTA interface and those accessing to the JTS (OTS) interfaces.</p>
</div>
<div class="paragraph">
<p>Please follow these steps before running the transactional applications</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure you have the Ant build system installed.
Ant is a Java build tool, similar to make.
It is available for free from <a href="http://ant.apache.org/" class="bare">http://ant.apache.org/</a> The sample application requires version 1.5.1 or later.</p>
</li>
<li>
<p>The <code>PATH</code> and <code>CLASSPATH</code> environment variables need to be set appropriately to use Narayana.
To make this easier, we provide a shell script <code>setup_env.sh</code> (and for Windows a batch file <code>setup_env.bat</code>) in the directory <code>&lt;jbossts_install_root&gt;/bin/</code></p>
</li>
<li>
<p>From a command prompt, cd to the directory containing the <code>build.xml</code> file (<code>&lt;jbossts_install_root&gt;/trail_map</code>) and type 'ant', unless already done in the installation section.
This will compile a set of sources files located under <code>&lt;jbossts_install_root&gt;/trail_map/src</code> then create an application .jar file named <code>jbossts-demo.jar</code> under the directory <code>&lt;jbossts_install_root&gt;/trail_map/lib</code></p>
</li>
<li>
<p>Add the generated jar file to the <code>CLASSPATH</code> environment variable.</p>
</li>
<li>
<p>The demo application is provided in several ways, accessing persistent data or not.
When JDBC is used as a mean to access a database, Oracle 9i is used.
For this aim the appropriate Oracle libraries (<code>classes12.zip</code>) should be added in the <code>CLASSPATH</code> environment variable.</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="_local_transaction_with_jta"><a class="anchor" href="#_local_transaction_with_jta"></a>Local transaction with JTA</h7>
<div class="paragraph">
<p>To configure Narayana for such transaction, edit the <code>jbossts-properties.xml</code> file and set the following properties to the appropriate values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.jta.jtaTMImplementation</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.jta.transaction.</span>
    <span class="content">arjunacore.TransactionManagerImple</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.jta.jtaUTImplementation</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.jta.transaction.</span>
    <span class="content">arjunacore.UserTransactionImple</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_distributed_transaction_with_jta"><a class="anchor" href="#_distributed_transaction_with_jta"></a>Distributed transaction with JTA</h7>
<div class="paragraph">
<p>While for a distributed transactions case, Narayana need to be configured as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.jta.jtaTMImplementation</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.jta.transaction.</span>
    <span class="content">jts.TransactionManagerImple</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.jta.jtaUTImplementation</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.jta.transaction.</span>
    <span class="content">jts.UserTransactionImple</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using JTA to create a distributed transaction need the creation of an ORB instance as done by a JTS application (see JTS versions of the banking application), the difference is in the interface used to demarcate and control transactions.</p>
</div>
</div>
<div class="sect6">
<h7 id="_the_application_programming_interfaces_used_by_the_banking_application"><a class="anchor" href="#_the_application_programming_interfaces_used_by_the_banking_application"></a>The application programming interfaces used by the Banking Application</h7>
<div class="paragraph">
<p>To illustrate the programming interfaces possibilities enabled by Narayana, the banking application is provided in several versions: a version that uses the JTA API and a second that uses JTS/OTS interfaces.</p>
</div>
<div class="paragraph">
<p>This trail focuses to understanding concepts related to the creation of transactions and the behavior of the commitment protocol, while the next trail illustrates the similar application with persistent data.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Testing the Banking application with JTA</p>
</li>
<li>
<p>Testing the Banking application with JTS</p>
</li>
</ul>
</div>
<div class="sect7">
<h8 id="_running_the_banking_application_with_jta"><a class="anchor" href="#_running_the_banking_application_with_jta"></a>Running The Banking application with JTA</h8>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Configuring Narayana</div>
<p>Program Applications that create transactions using the JTA interface may invoke as well local services as remote services.
When a remote invocation need to be performed, the current transactional context need to be propagated to the remote service in order to involve it to the transaction in progress.
Narayana allows the possibility to provide such feature using the facilities provided by JTS and ORB.
More precisely Narayana need to be configured to determine in which type of transaction, local or distributed, the JTA interface is used.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Executing the JTA sample</div>
<p>The Banking sample using JTA creates local transactions, ensure that JTA is configured for local transactions as explained above.</p>
</div>
<div class="paragraph">
<p>To launch the JTA version of the Banking application, which creates only local transactions, execute the following java program:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jta.localbank.BankClient</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once one of the program given above is launched the following lines are displayed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">-------------------------------------------------
  Bank client
-------------------------------------------------
Select an option :
   0. Quit
   1. Create a new account.
   2. Get an account information.
   3. Make a transfer.
   4. Credit an account.
   5. Withdraw from an account

Your choice :</code></pre>
</div>
</div>
<div class="paragraph">
<p>After introducing your choice, the appropriate operation is performed by the Bank object, to get the requested account, and by the account to execute the credit or withdraw or to return the current balance.
Let&#8217;s consider the following execution.</p>
</div>
<div class="paragraph">
<p>Enter the number 1 as your choice, then give the name "Foo" as the account name and "1000" as an initial value of the account to create.
You should get the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 1
- Create a new account -
------------------------
Name : Foo
Initial balance : 1000
Beginning a User transaction to create account
XA_START[]
Attempt to commit the account creation transaction
XA_END[]
XA_COMMIT (ONE_PHASE)[]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The line XA_START indicates that the AccountResource object that implements the XAResource interface and enlisted to participate in the account creation transaction, receives the indication from the Transaction Manager that the transaction has started.</p>
</li>
<li>
<p>The line XA_END indicates that the calling thread in which the AccountRessource object is associated shall be ended to enable the transaction completion as recommended by the X/Open specification.</p>
</li>
<li>
<p>Since only one AccountResource then only one XAResource is involved in the account creation transaction, the two phases needed to get a consensus in the 2PC protocol are not mandatory.
The one phase commit optimization, indicated by the "XA_COMMIT (ONE_PHASE)", is applied.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the same way create a second account with the name "Bar" and the initial balance set to 500.</p>
</div>
<div class="paragraph">
<p>As a choice now, enter "3" to make a transfer (300) from "Foo" to "Bar".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 3
- Make a transfer -
-------------------
Take money from : Foo
Put money to : Bar
Transfert amount : 300
Beginning a User transaction to get balance
XA_START[]
XA_START[]
XA_END[]
XA_PREPARE[]
XA_END[]
XA_PREPARE[]
XA_COMMIT[]
XA_COMMIT[]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Now two AccountResource objects, then two XAResource objects are enlisted with the transaction.
The displayed lines show that the two phases, prepare and commit, are applied.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any attempt to manipulate an account that it doesn&#8217;t exist leads to throw the NotExistingAccount exception and to rollback the transaction in progress.
For instance, let&#8217;s withdraw money from an account FooBar not previously created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 5
- Withdraw from an Account -
----------------------------
Give the Account name : FooBar
Amount to withdraw : 200
Beginning a User transaction to
withdraw from an account
The requested account does not exist!
ERROR - jakarta.transaction.RollbackException</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Building The Banking Application with JTA</div>
<p>From an architectural point of view of JTA, the bank client is considered as an application program able to manage transactions via the <code>jakarta.transaction.UserTransaction</code> interface.
The following portion of the code illustrates how a JTA transaction is started and terminated when the client asks to transfer money from one account to another.
This also describes what are Narayana packages that need to be used in order to obtain appropriate objects instances (such UserTransaction).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The code below is a simplified view of the BankClient.java program.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Only the transfer operation is illustrated; other operations manage transactions in the same way. (see for details the <code>src/com/arjuna/demo/jta/localbank/BankClient.java</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BankClient</span> {
    <span class="directive">private</span> Bank _bank;

    <span class="comment">// This operation is used to make a transfer</span>
    <span class="comment">//from an account to another account</span>
    <span class="directive">private</span> <span class="type">void</span> makeTransfer() {
        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Take money from : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> name_supplier = input();

        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Put money to : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> name_consumer = input();

        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Transfer amount : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> amount = input();

        <span class="type">float</span> famount = <span class="integer">0</span>;
        <span class="keyword">try</span> {
            famount = <span class="keyword">new</span> <span class="predefined-type">Float</span>(amount).floatValue();
        } <span class="keyword">catch</span> (java.lang.Exception ex) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Invalid float number, abort operation...</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">return</span>;
        }

        <span class="keyword">try</span> {
            <span class="comment">//the following instruction asks a specific {parentProduct}</span>
            <span class="comment">//class to obtain a UserTransaction instance</span>
            jakarta.transaction.UserTransaction userTran =
                    com.arjuna.ats.jta.UserTransaction.userTransaction();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Beginning a User transaction to get balance</span><span class="delimiter">&quot;</span></span>);
            userTran.begin();

            Account supplier = _bank.get_account(name_supplier);
            Account consumer = _bank.get_account(name_consumer);
            supplier.debit(famount);
            consumer.credit(famount);

            userTran.commit();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR - </span><span class="delimiter">&quot;</span></span> + e);
        }
    }
   ......
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Bank object has mainly two operations: creating an account, which is added in the account list, and returning an Account object.
No transactional instruction is performed by the Bank object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Bank</span> {
    <span class="directive">private</span> java.util.Hashtable _accounts;

    <span class="directive">public</span> Bank() {
        _accounts = <span class="keyword">new</span> java.util.Hashtable();
    }

    <span class="directive">public</span> Account create_account(<span class="predefined-type">String</span> name) {
        Account acc = <span class="keyword">new</span> Account(name);
        _accounts.put(name, acc);
        <span class="keyword">return</span> acc;
    }

    <span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name)
            <span class="directive">throws</span> NotExistingAccount {
        Account acc = (Account) _accounts.get(name);
        <span class="keyword">if</span> (acc == <span class="predefined-constant">null</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account requested does not exist</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> acc;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Account object provides mainly three methods balance, credit and withdraw.
However, in order to provide the transactional behaviour, rather than to modify the current account directly (according to credit or withdraw) this task is delegated to an AccountResource object that is able, according to the transaction outcome, to set the account value either to its initial state or its final state.</p>
</div>
<div class="paragraph">
<p>The AccountResource object is in fact an object that implements the javax.transaction.xa.XAResource, then able to participate to the transaction commitment.
For this aim, the Account object has to register or enlist the AccountResource object as a participant after having obtaining the reference of the <code>jakarta.transaction.Transaction</code> object via the <code>jakarta.transaction.TransactionManager</code> object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Account</span> {
    <span class="type">float</span> _balance;
    AccountResource accRes = <span class="predefined-constant">null</span>;

    <span class="directive">public</span> Account(<span class="predefined-type">String</span> name) {
        _name = name;
        _balance = <span class="integer">0</span>;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> getXAResource().balance();
        ;
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        getXAResource().credit(value);
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        getXAResource().debit(value);
    }

    <span class="directive">public</span> AccountResource getXAResource() {

        <span class="keyword">try</span> {
            jakarta.transaction.TransactionManager transactionManager =
                    com.arjuna.ats.jta.TransactionManager.transactionManager();
            jakarta.transaction.Transaction currentTrans =
                    transactionManager.getTransaction();

            <span class="keyword">if</span> (accRes == <span class="predefined-constant">null</span>) {
                currentTrans.enlistResource(
                        accRes = <span class="keyword">new</span> AccountResource(<span class="local-variable">this</span>, _name));
            }

            currentTrans.delistResource(accRes, <span class="predefined-type">XAResource</span>.TMSUCCESS);

        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR - </span><span class="delimiter">&quot;</span></span> + e);
        }
        <span class="keyword">return</span> accRes;
    }
   ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The AccountResource class that implements the javax.transaction.xa.XAResource interface provides similar methods as the Account class (credit, withdraw and balance) but also all methods specified by the javax.transaction.xa.XAResource.
The following portion of code describes how the methods prepare, commit and rollback are implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AccountResource</span> <span class="directive">implements</span> <span class="predefined-type">XAResource</span> {
    <span class="directive">public</span> AccountResource(Account account, <span class="predefined-type">String</span> name) {
        _name = name;
        _account = account;
        _initial_balance = account._balance;
        _current_balance = _initial_balance;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        _current_balance += value;
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        _current_balance -= value;
    }

    <span class="directive">public</span> <span class="type">void</span> commit(<span class="predefined-type">Xid</span> id, <span class="type">boolean</span> onePhase) <span class="directive">throws</span> <span class="exception">XAException</span> {
        <span class="comment">//The value of the associated Account object is modified</span>
        _account._balance = _current_balance;
    }

    <span class="directive">public</span> <span class="type">int</span> prepare(<span class="predefined-type">Xid</span> xid) <span class="directive">throws</span> <span class="exception">XAException</span> {
        <span class="keyword">if</span> (_initial_balance == _current_balance) <span class="comment">//account not modified</span>
            <span class="keyword">return</span> (XA_RDONLY);
        <span class="keyword">if</span> (_current_balance &lt; <span class="integer">0</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">XAException</span>(<span class="exception">XAException</span>.XA_RBINTEGRITY);
        <span class="comment">//If the integrity of the account is corrupted then vote rollback</span>
        <span class="keyword">return</span> (XA_OK); <span class="comment">//return OK</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">void</span> rollback(<span class="predefined-type">Xid</span> xid) <span class="directive">throws</span> <span class="exception">XAException</span> {
    <span class="comment">//Nothing is done</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">private</span> <span class="type">float</span> _initial_balance;
<span class="directive">private</span> <span class="type">float</span> _current_balance;
<span class="directive">private</span> Account _account;</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Sample Application Source Code</div>
<p>Full source code for the banking application with JTA is included to provide you with a starting point for experimentation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>src/com/arjuna/demo/jta/localbank/BankClient.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jta/localbank/Bank.java</code> &#8594; <code>Bank.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jta/localbank/Account.java</code> &#8594; <code>Account.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jta/localbank/AccountResource.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jta/localbank/NotExistingAccount.java</code> &#8594; <code>NotExistingAccount.java</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_running_the_banking_application_with_jts"><a class="anchor" href="#_running_the_banking_application_with_jts"></a>Running The Banking application with JTS</h7>
<div class="paragraph">
<p>The JTS version of the Banking application means that the Object Request Broker will be used.
The Narayana distribution is provided to work with the bundled JacORB version</p>
</div>
<div class="paragraph">
<p>To describe the possibilities provided by Narayana to build a transactional application according to the programming models defined by the OTS specification, the Banking Application is programmed in different ways.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Local transactions: The Bank Client and the Bank server are collocated in the same process.</p>
</li>
<li>
<p>Distributed Transactions: The Bank Client and the Bank Server and located on different process.
To participate within a client&#8217;s transaction, Account Objects needed to access the transactional context.
We describe the two of context propagation.</p>
<div class="ulist">
<ul>
<li>
<p>implicit context propagation, and</p>
</li>
<li>
<p>explicit context propagation.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>JTS Local Transactions&gt;</p>
</div>
<div class="paragraph">
<p>JTS Distributed Transactions</p>
</div>
<div class="sect7">
<h8 id="_running_the_banking_application_with_jts_2"><a class="anchor" href="#_running_the_banking_application_with_jts_2"></a>Running The Banking application with JTS</h8>
<div class="paragraph">
<p>The JTS version of the Banking application means that the Object Request Broker will be used.
The Narayana distribution is provided to work with the bundled JacORB version</p>
</div>
<div class="paragraph">
<p><em>Note</em> : Ensure that the jacorb jar files are added in your <code>CLASSPATH</code></p>
</div>
<div class="paragraph">
<p>To launch the JTS version of the Banking application, execute the following java program</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.localbank.BankClient</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once one of the program given above is launched the following lines are displayed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">-------------------------------------------------
   Bank client
-------------------------------------------------
Select an option :
   0. Quit
   1. Create a new account.
   2. Get an account information.
   3. Make a transfer.
   4. Credit an account.
   5. Withdraw from an account

Your choice :</code></pre>
</div>
</div>
<div class="paragraph">
<p>After introducing your choice, the appropriate operation is performed by the Bank object, to get the requested account, and by the account to execute the credit or withdraw or to return the current balance.
Let&#8217;s consider the following execution.</p>
</div>
<div class="paragraph">
<p>Enter the number 1 as your choice, then give the name "Foo" as the account name and "1000" as an initial value of the account to create.
You should get the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 1
- Create a new account -
------------------------
Name : Foo
Initial balance : 1000
Beginning a User transaction to create account
[ Connected to 192.168.0.2:4799 from local port 4924 ]
Attempt to commit the account creation transaction
/[ Resource for Foo : Commit one phase ]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Since only one AccountResource then only one CosTransaction.Resource is involved in the account creation transaction, the two phases needed to get a consensus in the 2PC protocol are not mandatory.
The one phase commit optimisation, indicated by the "Commit one phase", is applied.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the same way create a second account with the name "Bar" and the initial balance set to 500.</p>
</div>
<div class="paragraph">
<p>As a choice now, enter "3" to make a transfer (300) from "Foo" to "Bar".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 3
- Make a transfer -
-------------------

Take money from : Foo
Put money to : Bar
Transfer amount : 300
Beginning a User transaction to Transfer money
[ Resource for Foo : Prepare ]
[ Resource for Bar : Prepare ]
[ Resource for Foo : Commit ]
[ Resource for Bar : Commit ]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Now two AccountResource objects, then two CosTransactions.Resource objects are enlisted with the transaction.
The displayed lines show that the two phases, prepare and commit, are applied.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any attempt to manipulate an account that it doesn&#8217;t exist leads to throw the NotExistingAccount exception and to rollback the transaction in progress.
For instance, let&#8217;s withdraw money from an account FooBar not previously created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 5
- Withdraw from an Account -
----------------------------
Give the Account name : FooBar
Amount to withdraw : 200
Beginning a User transaction to withdraw from an account
The requested account does not exist!
ERROR - org.omg.CORBA.TRANSACTION_ROLLEDBACK:
minor code: 50001  completed: No</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Using a stand-alone Transaction Server</div>
<p>By default Narayana does not use a separate transaction manager server: transaction managers are co-located with each application process to improve performance and improve application fault-tolerance.
When running applications which require a separate transaction manager, you must set the com.arjuna.ats.jts.transactionManager property variable, in the <code>(jbossts_install_dir)/etc/jbossts-properties.xml</code> file, to YES.</p>
</div>
<div class="paragraph">
<p>In a separate window, the stand-alone Transaction Server is launched as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.jts.TransactionServer [-test]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The option <code>-test</code> allows to see the message "Ready" when the Transaction Server is started.</p>
</div>
<div class="paragraph">
<p>The Banking application presented above gives the same output.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Running The Banking application with JTS</div>
<p>The JTS version of the Banking application means that the Object Request Broker will be used.
The Narayana distribution is provided to work with the bundled JacORB version</p>
</div>
<div class="paragraph">
<p><em>Note</em> : Ensure that the jacorb jar files are added in your <code>CLASSPATH</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>In a separate window launch the Recovery Manager, as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager</code></pre>
</div>
</div>
</li>
<li>
<p>Testing the distributed transaction with <em>Implicit Propagation Context</em></p>
</li>
<li>
<p>Start the Server</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.remotebank.BankServer</code></pre>
</div>
</div>
</li>
<li>
<p>In a separate window, start the client</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.remotebank.BankClient</code></pre>
</div>
</div>
</li>
<li>
<p>Testing the distributed transaction with <em>Explicit Propagation Context</em></p>
</li>
<li>
<p>Start the Server</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.explicitremotebank.BankServer</code></pre>
</div>
</div>
</li>
<li>
<p>In a separate window, start the client</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.explicitremotebank.BankClient</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In both cases (implicit and explicit), the Bank Server, which can be stopped by hand, displays the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">The bank server is now ready...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In both cases (implicit and Explicit), the Bank Client window displays the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">-------------------------------------------------
Bank client
-------------------------------------------------
Select an option :
0. Quit
1. Create a new account.
2. Get an account information.
3. Make a transfer.
4. Credit an account.
5. Withdraw from an account

Your choice :</code></pre>
</div>
</div>
<div class="paragraph">
<p>After entering your choice, the appropriate operation is performed by the remote Bank object, to get the requested account, and by the account to execute the credit or withdraw or to return the current balance.
Let&#8217;s consider the following execution.</p>
</div>
<div class="paragraph">
<p>Enter the number 1 as your choice, then give the name "Foo" as the account name and "1000" as an initial value of the account to create.
You should get in the server window a result that terminates with the following line</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">[ Resource for Foo : Commit one phase ]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Since only one AccountResource then only one CosTransaction.Resource is involved in the account creation transaction, the two phases needed to get a consensus in the 2PC protocol are not mandatory.
The one phase commit optimisation, indicated by the "Commit one phase", is applied.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the same way create a second account with the name "Bar" and the initial balance set to 500.</p>
</div>
<div class="paragraph">
<p>As a choice now, enter in the client window "3" to make a transfer (300) from "Foo" to "Bar".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 3
- Make a transfer -
-------------------

Take money from : Foo
Put money to : Bar
Transfer amount : 300</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the Server window you should see a result with the following lines</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">[ Resource for Foo : Prepare ]
[ Resource for Bar : Prepare ]
[ Resource for Foo : Commit ]
[ Resource for Bar : Commit ]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Now two AccountResource objects, then two CosTransactions.Resource objects are enlisted with the transaction.
The displayed lines show that the two phases, prepare and commit, are applied.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any attempt to manipulate an account that it doesn&#8217;t exist leads to throw the NotExistingAccount exception and to rollback the transaction in progress.
For instance, let&#8217;s withdraw money from an account FooBar not previously created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 5
- Withdraw from an Account -
----------------------------
Amount to withdraw : 200
Beginning a User transaction to withdraw from an account
The requested account does not exist!
ERROR - org.omg.CORBA.TRANSACTION_ROLLEDBACK:
minor code: 50001 completed: No</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Using a stand-alone Transaction Server</div>
<p>By default Narayana does not use a separate transaction manager server: transaction managers are co-located with each application process to improve performance and improve application fault-tolerance.
When running applications which require a separate transaction manager, you must set the com.arjuna.ats.jts.transactionManager property variable, in the <code>jbossts-properties.xml</code> file, to YES.</p>
</div>
<div class="paragraph">
<p>In a separate window, the stand-alone Transaction Server is launched as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.jts.TransactionServer [-test]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The option <code>-test</code> allows to see the message "Ready" when the Transaction Server is started.</p>
</div>
<div class="paragraph">
<p>The Banking application presented above gives the same output.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Running the example on several machines</div>
<p>It is possible to run the Narayana Transaction Service and recovery manager processes on a different machine and have clients access these centralized services in a hub-and-spoke style architecture.</p>
</div>
<div class="paragraph">
<p>All that must be done is to provide the clients with enough information to contact the transaction service (such as the ORB&#8217;s NameService).
However, configuring the ORB is beyond the remit of this trailmap and so we shall opt for a simpler mechanism whereby the transaction services IOR is shared by access to a common file.</p>
</div>
<div class="paragraph">
<p>This trailmap stage assumes that the transaction service has been appropriately installed and configured (the <code>setenv.[bat|sh]</code> script has been ran) onto two hosts (for the purpose of explanation we shall refer to these hosts as <code>host1</code> and <code>host2</code>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Start the recovery manager in one command prompt terminal</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager [-test]</code></pre>
</div>
</div>
</li>
<li>
<p>Start the transaction service in a second command prompt terminal</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.jts.TransactionServer [-test]</code></pre>
</div>
</div>
</li>
<li>
<p>Start the transaction service and recovery manager on <code>host1</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Open a command prompt on <code>host2</code> and copy the <code>CosServices.cfg</code> file from the <code>&lt;narayana-jts_install_root&gt;/etc</code> directory on <code>host1</code>.
For example, using the popular <code>scp</code> package, open a shell prompt and issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">scp user @ host1:&lt;ats_root&gt;/etc/CosServices.cfg &lt;host2_ats_root&gt;/etc/</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Share the transaction service IOR on <code>host1</code> with <code>host2</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>See the section above entitled "Using a stand-alone Transaction Server" for more information on how to configure these application to use a remote transaction service.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Testing the distributed transaction with Implicit Propagation Context</em></p>
<div class="ulist">
<ul>
<li>
<p>Start the Server</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.remotebank.BankServer</code></pre>
</div>
</div>
</li>
<li>
<p>In a separate window, start the client</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.remotebank.BankClient</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><em>Testing the distributed transaction with Explicit Propagation Context</em></p>
<div class="ulist">
<ul>
<li>
<p>Start the Server</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.explicitremotebank.BankServer</code></pre>
</div>
</div>
</li>
<li>
<p>In a separate window, start the client</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.explicitremotebank.BankClient</code></pre>
</div>
</div>
</li>
<li>
<p>Start the Bank Server and Bank Client applications on <code>host2</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">How the Banking Application is build using JTS interfaces</div>
<p>From an architectural point of view of JTS, the bank client is considered as an application program able to manage transactions either in a direct or indirect management mode, respectively with the interfaces org.omg.CosTransactions.TransactionFactory and org.omg.CosTransactions.Terminator or with the org.omg.CosTransactions.Current interface.
Transactions created by the client in the Banking application are done in the indirect mode.</p>
</div>
<div class="paragraph">
<p>The following portion of code illustrates how a JTS transaction is started and terminated when the client asks to transfer money from one account to another.
This also describes what are Narayana packages that need to be used in order to obtain appropriate objects instances (such Current).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The code below is a simplified view of the BankClient.java program.
Only the transfer operation is illustrated; other operations manage transactions in the same way.
(see <code>../src/com/arjuna/demo/jts/localbank/BankClient.java</code> for details)</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts.OTSManager</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.internal.jts.ORBManager</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BankClient</span> {
    <span class="directive">private</span> Bank _bank; <span class="comment">//Initialised on BankClient initializations</span>
   ....

    <span class="comment">// This operation is used to make a transfer from an account to another account</span>
    private <span class="type">void</span> makeTransfer() {
        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Take money from : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> name_supplier = input();

        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Put money to : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> name_consumer = input();

        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Transfert amount : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> amount = input();

        <span class="type">float</span> famount = <span class="integer">0</span>;
        <span class="keyword">try</span> {
            famount = <span class="keyword">new</span> <span class="predefined-type">Float</span>(amount).floatValue();
        } <span class="keyword">catch</span> (java.lang.Exception ex) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Invalid float number, abort operation...</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">return</span>;
        }

        <span class="keyword">try</span> {
            <span class="comment">//the following instruction asks a specific {parentProduct} class to obtain a Current instance</span>
            Current current = OTSManager.get_current();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Beginning a User transaction to get balance</span><span class="delimiter">&quot;</span></span>);
            current.begin();

            Account supplier = _bank.get_account(name_supplier);
            Account consumer = _bank.get_account(name_consumer);
            supplier.debit(famount);
            consumer.credit(famount);

            current.commit();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR - </span><span class="delimiter">&quot;</span></span> + e);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since JTS is used invocations against an ORB are needed, such ORB and Object Adapter instantiation and initialisation.
To ensure a better portability, the ORB Portability API provides a set of methods that can be used as described below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    <span class="keyword">try</span> {
        myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);<span class="comment">// Create an ORB instance</span>
        myOA = OA.getRootOA(myORB); <span class="comment">//Obtain the Root POA</span>
        myORB.initORB(args, <span class="predefined-constant">null</span>); <span class="comment">//Initialise the ORB</span>
        myOA.initOA(); <span class="comment">//Initialise the POA</span>

        <span class="comment">// The ORBManager is a class provided by {parentProduct} to facilitate the association</span>
        <span class="comment">// of the ORB/POA with the transaction service</span>
        ORBManager.setORB(myORB);
        ORBManager.setPOA(myOA);
     ....
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        e.printStackTrace(<span class="predefined-type">System</span>.err);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Bank object has mainly two operations: creating an account, which is added in the account list, and returning an Account object.
No transactional instruction is performed by the Bank object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Bank</span> {
    <span class="directive">private</span> java.util.Hashtable _accounts;

    <span class="directive">public</span> Bank()
    {
        _accounts = <span class="keyword">new</span> java.util.Hashtable();
    }

    <span class="directive">public</span> Account create_account( <span class="predefined-type">String</span> name )
    {
        Account acc = <span class="keyword">new</span> Account(name);
        _accounts.put( name, acc );
        <span class="keyword">return</span> acc;
    }

    <span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name)
            <span class="directive">throws</span> NotExistingAccount
    {
        Account acc = ( Account ) _accounts.get( name );
        <span class="keyword">if</span> ( acc == <span class="predefined-constant">null</span> )
            <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account requested does not exist</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> acc;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Account object provides mainly three methods balance, credit and withdraw.
However, in order to provide the transactional behaviour, rather than to modify the current account directly (according to credit or withdraw) this task is delegated to an AccountResource object that is able, according to the transaction outcome, to set the account value either to its initial state or its final state.</p>
</div>
<div class="paragraph">
<p>The AccountResource object is in fact an object that implements the org.omg.CosTransactions.Resource, then able to participate to the transaction commitment.
For this aim, the Account object has to register the AccountResource object as a participant, after having obtaining the reference of the org.omg.CosTransactions.Coordinator object , itself obtained via the org.omg.CosTransactions.Control object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Account</span> {
    <span class="type">float</span> _balance;
    AccountResource accRes = <span class="predefined-constant">null</span>;

    <span class="directive">public</span> Account(<span class="predefined-type">String</span> name) {
        _name = name;
        _balance = <span class="integer">0</span>;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> getResource().balance();
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        getResource().credit(value);
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        getResource().debit(value);
    }

    <span class="directive">public</span> AccountResource getResource() {
        <span class="keyword">try</span> {
            <span class="keyword">if</span> (accRes == <span class="predefined-constant">null</span>) {
                accRes = <span class="keyword">new</span> AccountResource(<span class="local-variable">this</span>, _name);
                Resource ref = org.omg.CosTransactions.ResourceHelper.narrow(ORBManager.getPOA().corbaReference(accRes));
                <span class="comment">// Note above the possibilities provided by the ORBManager to access the POA then to obtain</span>
                <span class="comment">// the CORBA reference of the created AccountResource object</span>

                RecoveryCoordinator recoverycoordinator = OTSManager.get_current().get_control().
                        get_coordinator().register_resource(ref);

            }
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR - </span><span class="delimiter">&quot;</span></span> + e);
        }

        <span class="keyword">return</span> accRes;
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To be considered as a org.omg.CosTransactions.Resource, the AccountResource class shall extends the class org.omg.CosTransactions.ResourcePOA generated by the CORBA IDL compiler.
The AccountRessource provides similar methods as the Account class (credit, withdraw and balance) with the appropriate methods to participate to the 2PC protocol.
The following portion of code describes how the methods prepare, commit and rollback are implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AccountResource</span> <span class="directive">extends</span> org.omg.CosTransactions.ResourcePOA {
    <span class="directive">public</span> AccountResource(Account account, <span class="predefined-type">String</span> name) {
        _name = name;
        _account = account;
        _initial_balance = account._balance;
        _current_balance = _initial_balance;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        _current_balance += value;
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        _current_balance -= value;
    }

    <span class="directive">public</span> org.omg.CosTransactions.Vote prepare()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicMixed, org.omg.CosTransactions.HeuristicHazard {
        <span class="keyword">if</span> (_initial_balance == _current_balance)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteReadOnly;
        <span class="keyword">if</span> (_current_balance &lt; <span class="integer">0</span>)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteRollback;
        <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteCommit;
    }

    <span class="directive">public</span> <span class="type">void</span> rollback()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicCommit, org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        <span class="comment">//Nothing to do</span>
    }

    <span class="directive">public</span> <span class="type">void</span> commit()
            <span class="directive">throws</span> org.omg.CosTransactions.NotPrepared, org.omg.CosTransactions.HeuristicRollback,
            org.omg.CosTransactions.HeuristicMixed, org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> commit_one_phase()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    .....

    private <span class="type">float</span> _initial_balance;
    <span class="directive">private</span> <span class="type">float</span> _current_balance;
    <span class="directive">private</span> Account _account;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Sample Application Source Code</div>
<p>Full source code for the banking application is included to provide you with a starting point for experimentation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JTS Version</p>
<div class="ulist">
<ul>
<li>
<p>src/com/arjuna/demo/jts/localbank/BankClient.java</p>
</li>
<li>
<p>src/com/arjuna/demo/jts/localbank/Bank.java"&gt;Bank.java</p>
</li>
<li>
<p>src/com/arjuna/demo/jts/localbank/Account.java"&gt;Account.java</p>
</li>
<li>
<p>src/com/arjuna/demo/jts/localbank/AccountResource.java</p>
</li>
<li>
<p>src/com/arjuna/demo/jts/localbank/NotExistingAccount.java"&gt;NotExistingAccount.java</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">How the Banking Application is build using JTS interfaces</div>
<p>The bank client is an application program able to manage transactions either in a direct or indirect management mode, respectively with the interfaces org.omg.CosTransactions.TransactionFactory and org.omg.CosTransactions.Terminator or with the org.omg.CosTransactions.Current interface.
Transactions created by the client in the Banking application are done in the indirect mode.</p>
</div>
<div class="paragraph">
<p>Invoking a remote object within a CORBA environment means that the remote object implements a CORBA interface defined in a CORBA idl file.
The following Bank.idl describes the interfaces then the possible kind of distributed CORBA objects involved in the banking application.
There is no any interface that inherits the CosTransactions::TransactionalObject interface, which means that for any remote invocations the transactional context is normally not propagated.
However, since the Account object may have to register Resource objects that participate to transaction completion, a context is needed.
In the following Bank.idl file operations defined in the Account interface have explicitly in their signature the CosTransactions::Control argument meaning that it passed explicitly by the caller - in this case the Bank Client program.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">module arjuna {
    module demo {
     module jts {
      module explicitremotebank {

        <span class="type">interface</span> <span class="class">Account</span> :
        {
          <span class="type">float</span> balance(in CosTransactions::<span class="predefined-type">Control</span> ctrl);
          <span class="type">void</span> credit( in CosTransactions::<span class="predefined-type">Control</span> ctrl, in <span class="type">float</span> value );
          <span class="type">void</span> debit( in CosTransactions::<span class="predefined-type">Control</span> ctrl, in <span class="type">float</span> value );
        };

        exception NotExistingAccount
        { };

        <span class="type">interface</span> <span class="class">Bank</span>
        {
          Account create_account( in string name );
          Account get_account( in string name )
            raises( NotExistingAccount );
        };
       };
      };
     };
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following portion of code illustrates how a JTS transaction is started and terminated when the client asks to transfer money from one account to another.
This also describes what are Narayana packages that need to be used in order to obtain appropriate objects instances (such Current).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The code below is a simplified view of the <code>BankClient.java</code> program.
Only the transfer operation is illustrated; other operations manage transactions in the same way.
(see for details the <code>src/com/arjuna/demo/jts/explicitremotebank/BankClient.java</code>)</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.remotebank</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts.OTSManager</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BankClient</span> {
    <span class="directive">private</span> Bank _bank;
    ....

    <span class="comment">// This operation is used to make a transfer</span>
    <span class="comment">//from an account to another account</span>
    private <span class="type">void</span> makeTransfer() {
        <span class="comment">//get the name of the supplier(name_supplier) and</span>
        <span class="comment">// the consumer(name_consumer)</span>
        <span class="comment">// get the amount to transfer (famount)</span>
        ...
        try {
            <span class="comment">//the following instruction asks a specific</span>
            <span class="comment">//{parentProduct} class to obtain a Current instance</span>
            Current current = OTSManager.get_current();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Beginning a User transaction to get balance</span><span class="delimiter">&quot;</span></span>);
            current.begin();

            Account supplier = _bank.get_account(name_supplier);
            Account consumer = _bank.get_account(name_consumer);
            supplier.debit(current.get_control(), famount);
            <span class="comment">//The Control is explicitly propagated</span>
            consumer.credit(current.get_control(), famount);
            current.commit();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            ...
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since JTS is used invocations against an ORB are needed, such ORB and Object Adapter instantiation and initialisation.
To ensure a better portability, the ORB Portability API provides a set of methods that can be used as described below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
  ....
    myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);<span class="comment">// Create an ORB instance</span>
    myORB.initORB(args, <span class="predefined-constant">null</span>); <span class="comment">//Initialise the ORB</span>

    org.omg.CORBA.Object obj = <span class="predefined-constant">null</span>;
    <span class="keyword">try</span> {
        <span class="comment">//Read the reference string from a file then convert to Object</span>
        ....
        obj = myORB.orb().string_to_object(stringTarget);
    } <span class="keyword">catch</span> (java.io.IOException ex) {
        ...
    }
    Bank bank = BankHelper.narrow(obj);
    ....
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Bank object has mainly two operations: creating an account, which is added in the account list, and returning an Account object.
No transactional instruction is performed by the Bank object.
The following lines decribe the implementation of the Bank CORBA object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BankImpl</span> <span class="directive">extends</span> BankPOA {
    <span class="directive">public</span> BankImpl(OA oa) {
        _accounts = <span class="keyword">new</span> java.util.Hashtable();
        _oa = oa;
    }

    <span class="directive">public</span> Account create_account(<span class="predefined-type">String</span> name) {
        AccountImpl acc = <span class="keyword">new</span> AccountImpl(name);
        _accounts.put(name, acc);
        <span class="keyword">return</span> com.arjuna.demo.jts.remotebank.AccountHelper.
                narrow(_oa.corbaReference(acc));
    }

    <span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name)
            <span class="directive">throws</span> NotExistingAccount {
        AccountImpl acc = (AccountImpl) _accounts.get(name);
        <span class="keyword">if</span> (acc == <span class="predefined-constant">null</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account requested does not exist</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> com.arjuna.demo.jts.remotebank.AccountHelper.
                narrow(_oa.corbaReference(acc));
    }

    <span class="directive">private</span> java.util.Hashtable _accounts;<span class="comment">// Accounts created by the Bank</span>
    <span class="directive">private</span> OA _oa;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After having defined an implementation of the Bank object, we should now create an instance and make it available for client requests.
This is the role of the Bank Server that has the responsibility to create the ORB and the Object Adapater instances, then the Bank CORBA object that has its object reference stored in a file well known by the bank client.
The following lines describe how the Bank server is implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BankServer</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        ORB myORB = <span class="predefined-constant">null</span>;
        RootOA myOA = <span class="predefined-constant">null</span>;
        <span class="keyword">try</span> {
            myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">ServerSide</span><span class="delimiter">&quot;</span></span>);
            myOA = OA.getRootOA(myORB);
            myORB.initORB(args, <span class="predefined-constant">null</span>);
            myOA.initOA();
            ....
            BankImpl bank = <span class="keyword">new</span> BankImpl(myOA);

            <span class="predefined-type">String</span> reference = myORB.orb().
                    object_to_string(myOA.corbaReference(bank));
            <span class="comment">//Store the Object reference in the file</span>
            ...

            System.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">The bank server is now ready...</span><span class="delimiter">&quot;</span></span>);
            myOA.run();
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Account object provides mainly three methods balance, credit and withdraw.
However, in order to provide the transactional behaviour, rather than to modify the current account directly (according to credit or withdraw) this task is delegated to an AccountResource object that is able, according to the transaction outcome, to set the account value either to its initial state or its final state.</p>
</div>
<div class="paragraph">
<p>The AccountResource object is in fact an object that implements the org.omg.CosTransactions.Resource, then able to participate to the transaction commitment.
For this aim, the Account object has to register the AccountResource object as a participant, after having obtaining the reference of the org.omg.CosTransactions.Coordinator object , itself obtained via the org.omg.CosTransactions.Control object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.remotebank</span>;

<span class="keyword">import</span> <span class="include">org.omg.CosTransactions</span>.*;
<span class="keyword">import</span> ....

<span class="include">public</span> <span class="include">class</span> <span class="include">AccountImpl</span> <span class="include">extends</span> <span class="include">AccountPOA</span> {
    <span class="include">float</span> <span class="include">_balance</span>;
    AccountResource accRes = <span class="predefined-constant">null</span>;

    <span class="directive">public</span> Account(<span class="predefined-type">String</span> name) {
        _name = name;
        _balance = <span class="integer">0</span>;
    }

    <span class="directive">public</span> <span class="type">float</span> balance(<span class="predefined-type">Control</span> ctrl) {
        <span class="keyword">return</span> getResource(ctrl).balance();
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="predefined-type">Control</span> ctrl, <span class="type">float</span> value) {
        getResource(ctrl).credit(value);
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="predefined-type">Control</span> ctrl, <span class="type">float</span> value) {
        getResource(ctrl).debit(value);
    }

    <span class="directive">public</span> AccountResource getResource(<span class="predefined-type">Control</span> control) {
        <span class="keyword">try</span> {
            <span class="keyword">if</span> (accRes == <span class="predefined-constant">null</span>) {
                accRes = <span class="keyword">new</span> AccountResource(<span class="local-variable">this</span>, _name);

                <span class="comment">//The invocation on the ORB illustrates the fact that the same</span>
                <span class="comment">//ORB instance created by the Bank Server is returned.</span>
                ref = org.omg.CosTransactions.ResourceHelper.
                        narrow(OA.getRootOA(ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">ServerSide</span><span class="delimiter">&quot;</span></span>)).
                                corbaReference(accRes));
                RecoveryCoordinator recoverycoordinator =
                        control.get_coordinator().register_resource(ref);
            }
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {...}
        <span class="keyword">return</span> accRes;
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To be considered as a org.omg.CosTransactions.Resource, the AccountResource class shall extends the class org.omg.CosTransactions.ResourcePOA generated by the CORBA IDL compiler.
The AccountRessource provides similar methods as the Account class (credit, withdraw and balance) with the appropriate methods to participate to the 2PC protocol.
The following portion of code describes how the methods prepare, commit and rollback are implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AccountResource</span> <span class="directive">extends</span> org.omg.CosTransactions.ResourcePOA {
    <span class="directive">public</span> AccountResource(Account account, <span class="predefined-type">String</span> name) {
        _name = name;
        _account = account;
        _initial_balance = account._balance;
        _current_balance = _initial_balance;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        _current_balance += value;
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        _current_balance -= value;
    }

    <span class="directive">public</span> org.omg.CosTransactions.Vote prepare()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        <span class="keyword">if</span> (_initial_balance == _current_balance)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteReadOnly;
        <span class="keyword">if</span> (_current_balance &lt; <span class="integer">0</span>)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteRollback;
        <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteCommit;
    }

    <span class="directive">public</span> <span class="type">void</span> rollback()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicCommit,
            org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
            <span class="comment">//Nothing to do</span>
    }

    <span class="directive">public</span> <span class="type">void</span> commit()
            <span class="directive">throws</span> org.omg.CosTransactions.NotPrepared,
            org.omg.CosTransactions.HeuristicRollback,
            org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> commit_one_phase()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    .....

    private <span class="type">float</span> _initial_balance;
    <span class="directive">private</span> <span class="type">float</span> _current_balance;
    <span class="directive">private</span> Account _account;

}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Sample Application Source Code</div>
<p>Full source code for the banking application is included to provide you with a starting point for experimentation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JTS Version</p>
<div class="ulist">
<ul>
<li>
<p><code>src/com/arjuna/demo/jts/explicitremotebank/Bank.idl</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/explicitremotebank/BankClient.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/explicitremotebank/BankServer.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/explicitremotebank/BankImpl.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/explicitremotebank/AccountImpl.java</code> &#8594; <code>AccountImpl.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/explicitremotebank/AccountResource.java</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">How the Banking Application is build using JTS interfaces</div>
<p>The bank client is an application program able to manage transactions either in a direct or indirect management mode, respectively with the interfaces org.omg.CosTransactions.TransactionFactory and org.omg.CosTransactions.Terminator or with the org.omg.CosTransactions.Current interface.
Transactions created by the client in the Banking application are done in the indirect mode.</p>
</div>
<div class="paragraph">
<p>Invoking a remote object within a CORBA environment means that the remote object implements a CORBA interface defined in a CORBA idl file.
The following Bank.idl describes the interfaces then the possible kind of distributed CORBA objects involved in the banking application.
Only the Account interface inherits the CosTransactions::TransactionalObject interface, this means that an Account CORBA object is expected to invoked within a scope of transaction and the transactional context is implicitly propagated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">module arjuna {
   module demo {
     module jts {
      module remotebank {

        <span class="type">interface</span> <span class="class">Account</span> : CosTransactions::TransactionalObject
        {
          <span class="type">float</span> balance();
          <span class="type">void</span> credit( in <span class="type">float</span> value );
          <span class="type">void</span> debit( in <span class="type">float</span> value );
        };

        exception NotExistingAccount
        { };

        <span class="type">interface</span> <span class="class">Bank</span>
        {
          Account create_account( in string name );
          Account get_account( in string name )
            raises( NotExistingAccount );
        };
       };
      };
     };
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following portion of code illustrates how a JTS transaction is started and terminated when the client asks to transfer money from one account to another.
This also describes what are Narayana packages that need to be used in order to obtain appropriate standard JTS API objects instances (such Current).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The code below is a simplified view of the <code>BankClient.java</code> program.
Only the transfer operation is illustrated; other operations manage transactions in the same way.
(see for details the <code>src/com/arjuna/demo/jts/localbank/BankClient.java</code>)</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.remotebank</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts.OTSManager</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BankClient</span> {
    <span class="directive">private</span> Bank _bank;
   ....

    <span class="comment">// This operation is used to make a transfer</span>
    <span class="comment">// from an account to another account</span>
    private <span class="type">void</span> makeTransfer() {
        <span class="comment">//get the name of the supplier(name_supplier)</span>
        <span class="comment">// and the consumer(name_consumer)</span>
        <span class="comment">// get the amount to transfer (famount)</span>
        ...

        try {
            <span class="comment">//the following instruction asks a</span>
            <span class="comment">// specific {parentProduct} class</span>
            <span class="comment">// to obtain a Current instance</span>
            Current current = OTSManager.get_current();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Beginning a User
                    transaction to get balance</span><span class="delimiter">&quot;</span></span>);
                    current.begin();

            Account supplier = _bank.get_account(name_supplier);
            Account consumer = _bank.get_account(name_consumer);
            supplier.debit(famount);
            consumer.credit(famount);

            current.commit();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            ...
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since JTS is used invocations against an ORB are needed, such ORB and Object Adapter instantiation and initialisation.
To ensure a better portability, the ORB Portability API provides a set of methods that can be used as described below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    ....
    myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);
    myORB.initORB(args, <span class="predefined-constant">null</span>); <span class="comment">//Initialise the ORB</span>

    org.omg.CORBA.Object obj = <span class="predefined-constant">null</span>;
    <span class="keyword">try</span> {
        <span class="comment">//Read the reference string from</span>
        <span class="comment">// a file then convert to Object</span>
        ....
        obj = myORB.orb().string_to_object(stringTarget);
    } <span class="keyword">catch</span> (java.io.IOException ex) {
       ...
    }
    Bank bank = BankHelper.narrow(obj);
    ....
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Bank object has mainly two operations: creating an account, which is added in the account list, and returning an Account object.
No transactional instruction is performed by the Bank object.
The following lines decribe the implementation of the Bank CORBA object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BankImpl</span> <span class="directive">extends</span> BankPOA {
    <span class="directive">public</span> BankImpl(OA oa) {
        _accounts = <span class="keyword">new</span> java.util.Hashtable();
        _oa = oa;
    }

    <span class="directive">public</span> Account create_account(<span class="predefined-type">String</span> name) {
        AccountImpl acc = <span class="keyword">new</span> AccountImpl(name);
        _accounts.put(name, acc);
        <span class="keyword">return</span> com.arjuna.demo.jts.remotebank.AccountHelper.
                narrow(_oa.corbaReference(acc));
    }

    <span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name)
            <span class="directive">throws</span> NotExistingAccount {
        AccountImpl acc = (AccountImpl) _accounts.get(name);
        <span class="keyword">if</span> (acc == <span class="predefined-constant">null</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account requested
                    does not exist</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> com.arjuna.demo.jts.remotebank.AccountHelper.
                narrow(_oa.corbaReference(acc));
    }

    <span class="directive">private</span> java.util.Hashtable _accounts;
    <span class="comment">// Accounts created by the Bank</span>
    <span class="directive">private</span> OA _oa;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After having defined an implementation of the Bank object, we should now create an instance and make it available for client requests.
This is the role of the Bank Server that has the responsibility to create the ORB and the Object Adapater instances, then the Bank CORBA object that has its object reference stored in a file well known by the bank client.
The following lines describe how the Bank server is implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BankServer</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        ORB myORB = <span class="predefined-constant">null</span>;
        RootOA myOA = <span class="predefined-constant">null</span>;
        <span class="keyword">try</span> {
            myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">ServerSide</span><span class="delimiter">&quot;</span></span>);
            myOA = OA.getRootOA(myORB);
            myORB.initORB(args, <span class="predefined-constant">null</span>);
            myOA.initOA();
            ....
            BankImpl bank = <span class="keyword">new</span> BankImpl(myOA);

            <span class="predefined-type">String</span> reference = myORB.orb().
                    object_to_string(myOA.corbaReference(bank));
            <span class="comment">//Store the Object reference in the file</span>
            ...
            System.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">The bank server is now ready...</span><span class="delimiter">&quot;</span></span>);
            myOA.run();
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Account object provides mainly three methods balance, credit and withdraw.
However, in order to provide the transactional behaviour, rather than to modify the current account directly (according to credit or withdraw) this task is delegated to an AccountResource object that is able, according to the transaction outcome, to set the account value either to its initial state or its final state.</p>
</div>
<div class="paragraph">
<p>The AccountResource object is in fact an object that implements the org.omg.CosTransactions.Resource, then able to participate to the transaction commitment.
For this aim, the Account object has to register the AccountResource object as a participant, after having obtaining the reference of the org.omg.CosTransactions.Coordinator object , itself obtained via the org.omg.CosTransactions.Control object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.remotebank</span>;
<span class="keyword">import</span> ....

<span class="include">public</span> <span class="include">class</span> <span class="include">AccountImpl</span> <span class="include">extends</span> <span class="include">AccountPOA</span> {
    <span class="include">float</span> <span class="include">_balance</span>;
    AccountResource accRes = <span class="predefined-constant">null</span>;

    <span class="directive">public</span> Account(<span class="predefined-type">String</span> name) {
        _name = name;
        _balance = <span class="integer">0</span>;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> getResource().balance();
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        getResource().credit(value);
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        getResource().debit(value);
    }

    <span class="directive">public</span> AccountResource getResource() {
        <span class="keyword">try</span> {
            <span class="keyword">if</span> (accRes == <span class="predefined-constant">null</span>) {
                accRes = <span class="keyword">new</span> AccountResource(<span class="local-variable">this</span>, _name);
                <span class="comment">//The invocation on the ORB illustrates the</span>
                <span class="comment">// fact that the same ORB instance created</span>
                <span class="comment">// by the Bank Server is returned.</span>
                ref = org.omg.CosTransactions.ResourceHelper.
                        narrow(OA.getRootOA(ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">ServerSide</span><span class="delimiter">&quot;</span></span>)).
                                corbaReference(accRes));
                RecoveryCoordinator recoverycoordinator = OTSManager.get_current().
                        get_control().get_coordinator().register_resource(ref);

            }
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {....}
        <span class="keyword">return</span> accRes;
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To be considered as a org.omg.CosTransactions.Resource, the AccountResource class shall extends the class org.omg.CosTransactions.ResourcePOA generated by the CORBA IDL compiler.
The AccountResource provides similar methods as the Account class (credit, withdraw and balance) with the appropriate methods to participate to the 2PC protocol.
The following portion of code describes how the methods prepare, commit and rollback are implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AccountResource</span>
        <span class="directive">extends</span> org.omg.CosTransactions.ResourcePOA {
    <span class="directive">public</span> AccountResource(Account account, <span class="predefined-type">String</span> name) {
        _name = name;
        _account = account;
        _initial_balance = account._balance;
        _current_balance = _initial_balance;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        _current_balance += value;
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        _current_balance -= value;
    }

    <span class="directive">public</span> org.omg.CosTransactions.Vote prepare()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        <span class="keyword">if</span> (_initial_balance == _current_balance)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteReadOnly;
        <span class="keyword">if</span> (_current_balance &lt; <span class="integer">0</span>)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteRollback;
        <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteCommit;
    }

    <span class="directive">public</span> <span class="type">void</span> rollback()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicCommit,
            org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        <span class="comment">//Nothing to do</span>
    }

    <span class="directive">public</span> <span class="type">void</span> commit()
            <span class="directive">throws</span> org.omg.CosTransactions.NotPrepared,
            org.omg.CosTransactions.HeuristicRollback,
            org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> commit_one_phase()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    ....
    private <span class="type">float</span> _initial_balance;
    <span class="directive">private</span> <span class="type">float</span> _current_balance;
    <span class="directive">private</span> <span class="directive">final</span> Account _account;

}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Sample Application Source Code</div>
<p>Full source code for the banking application is included to provide you with a starting point for experimentation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JTS Version</p>
<div class="ulist">
<ul>
<li>
<p><code>src/com/arjuna/demo/jts/remotebank/Bank.idl"&gt;Bank.idl</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/remotebank/BankClient.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/remotebank/BankServer.java</code> &#8594; <code>BankServer.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/remotebank/BankImpl.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/remotebank/AccountImpl.java</code> &#8594; <code>AccountImpl.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/remotebank/AccountResource.java</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">How the Banking Application is build using JTS interfaces</div>
<p>From an architectural point of view of JTS, the bank client is considered as an application program able to manage transactions either in a direct or indirect management mode, respectively with the interfaces org.omg.CosTransactions.TransactionFactory and org.omg.CosTransactions.Terminator or with the org.omg.CosTransactions.Current interface.
Transactions created by the client in the Banking application are done in the indirect mode.</p>
</div>
<div class="paragraph">
<p>The following portion of code illustrates how a JTS transaction is started and terminated when the client asks to transfer money from one account to another.
This also describes what are Narayana packages that need to be used in order to obtain appropriate objects instances (such Current).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The code below is a simplified view of the <code>BankClient.java</code> program.
Only the transfer operation is illustrated; other operations manage transactions in the same way.
(see for details the <code>src/com/arjuna/demo/jts/localbank/BankClient.java</code>)</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts.OTSManager</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BankClient</span> {
    <span class="directive">private</span> Bank _bank;
    ....

    <span class="comment">// This operation is used to make</span>
    <span class="comment">//a transfer from an account to another account</span>
    private <span class="type">void</span> makeTransfer() {
        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Take money from : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> name_supplier = input();

        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Put money to : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> name_consumer = input();

        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Transfert amount : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> amount = input();

        <span class="type">float</span> famount = <span class="integer">0</span>;
        <span class="keyword">try</span> {
            famount = <span class="predefined-type">Float</span>.parseFloat(amount);
        } <span class="keyword">catch</span> (java.lang.Exception ex) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Invalid float number,
                    abort operation...</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">return</span>;
        }

        <span class="keyword">try</span> {
            <span class="comment">//the following instruction asks a specific</span>
            <span class="comment">// {parentProduct} class to obtain a Current instance</span>
            Current current = OTSManager.get_current();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Beginning a User
                    transaction to get balance</span><span class="delimiter">&quot;</span></span>);
                    current.begin();

            Account supplier = _bank.get_account(name_supplier);
            Account consumer = _bank.get_account(name_consumer);
            supplier.debit(famount);
            consumer.credit(famount);

            current.commit();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR - </span><span class="delimiter">&quot;</span></span> + e);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since JTS is used invocations against an ORB are needed, such ORB and Object Adapter instantiation and initialisation.
To ensure a better portability, the ORB Portability API provides a set of methods that can be used as described below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    <span class="keyword">try</span> {
        <span class="comment">// Create an ORB instance</span>
        myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);
        <span class="comment">//Obtain the Root POA</span>
        myOA = OA.getRootOA(myORB);
        <span class="comment">//Initialise the ORB</span>
        myORB.initORB(args, <span class="predefined-constant">null</span>);
        <span class="comment">//Initialise the POA</span>
        myOA.initOA();
        ....

    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) { ....}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Bank object has mainly two operations: creating an account, which is added in the account list, and returning an Account object.
No transactional instruction is performed by the Bank object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Bank</span> {
    <span class="directive">private</span> <span class="directive">final</span> java.util.Hashtable _accounts;

    <span class="directive">public</span> Bank() {
        _accounts = <span class="keyword">new</span> java.util.Hashtable();
    }

    <span class="directive">public</span> Account create_account(<span class="predefined-type">String</span> name) {
        Account acc = <span class="keyword">new</span> Account(name);
        _accounts.put(name, acc);
        <span class="keyword">return</span> acc;
    }

    <span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name)
            <span class="directive">throws</span> NotExistingAccount {
        Account acc = (Account) _accounts.get(name);
        <span class="keyword">if</span> (acc == <span class="predefined-constant">null</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account
                    requested does not exist</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> acc;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Account object provides mainly three methods balance, credit and withdraw.
However, in order to provide the transactional behaviour, rather than to modify the current account directly (according to credit or withdraw) this task is delegated to an AccountResource object that is able, according to the transaction outcome, to set the account value either to its initial state or its final state.</p>
</div>
<div class="paragraph">
<p>The AccountResource object is in fact an object that implements the org.omg.CosTransactions.Resource, then able to participate to the transaction commitment.
For this aim, the Account object has to register the AccountResource object as a participant, after having obtaining the reference of the org.omg.CosTransactions.Coordinator object , itself obtained via the org.omg.CosTransactions.Control object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Account</span> {
    <span class="type">float</span> _balance;
    AccountResource accRes = <span class="predefined-constant">null</span>;

    <span class="directive">public</span> Account(<span class="predefined-type">String</span> name) {
        _name = name;
        _balance = <span class="integer">0</span>;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> getResource().balance();
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        getResource().credit(value);
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        getResource().debit(value);
    }

    <span class="directive">public</span> AccountResource getResource() {
        <span class="keyword">try</span> {
            <span class="keyword">if</span> (accRes == <span class="predefined-constant">null</span>) {
                accRes = <span class="keyword">new</span> AccountResource(<span class="local-variable">this</span>, _name);
                Resource ref = org.omg.CosTransactions.ResourceHelper.
                        narrow(OA.getRootOA(ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>)).corbaReference(accRes));
                RecoveryCoordinator recoverycoordinator = OTSManager.get_current().
                        get_control().get_coordinator().register_resource(ref);
            }
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {...}
        <span class="keyword">return</span> accRes;
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To be considered as a org.omg.CosTransactions.Resource, the AccountResource class shall extends the class org.omg.CosTransactions.ResourcePOA generated by the CORBA IDL compiler.
The AccountRessource provides similar methods as the Account class (credit, withdraw and balance) with the appropriate methods to participate to the 2PC protocol.
The following portion of code describes how the methods prepare, commit and rollback are implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AccountResource</span> <span class="directive">extends</span> org.omg.CosTransactions.ResourcePOA {
    <span class="directive">public</span> AccountResource(Account account, <span class="predefined-type">String</span> name) {
        _name = name;
        _account = account;
        _initial_balance = account._balance;
        _current_balance = _initial_balance;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        _current_balance += value;
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        _current_balance -= value;
    }

    <span class="directive">public</span> org.omg.CosTransactions.Vote prepare()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        <span class="keyword">if</span> (_initial_balance == _current_balance)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteReadOnly;
        <span class="keyword">if</span> (_current_balance &lt; <span class="integer">0</span>)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteRollback;
        <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteCommit;
    }

    <span class="directive">public</span> <span class="type">void</span> rollback()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicCommit,
            org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        <span class="comment">//Nothing to do</span>
    }

    <span class="directive">public</span> <span class="type">void</span> commit()
            <span class="directive">throws</span> org.omg.CosTransactions.NotPrepared,
            org.omg.CosTransactions.HeuristicRollback,
            org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> commit_one_phase()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }
    .....
    private <span class="directive">final</span> <span class="type">float</span> _initial_balance;
    <span class="directive">private</span> <span class="type">float</span> _current_balance;
    <span class="directive">private</span> <span class="directive">final</span> Account _account;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Sample Application Source Code</div>
<p>Full source code for the banking application is included to provide you with a starting point for experimentation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JTS Version</p>
<div class="ulist">
<ul>
<li>
<p><code>src/com/arjuna/demo/jts/localbank/BankClient.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/localbank/Bank.java</code> &#8594; <code>Bank.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/localbank/Account.java</code> &#8594; <code>Account.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/localbank/AccountResource.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/localbank/NotExistingAccount.java</code> &#8594; <code>NotExistingAccount.java</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_making_the_banking_application_persistent"><a class="anchor" href="#_making_the_banking_application_persistent"></a>Making the Banking Application Persistent</h5>
<div class="paragraph">
<p>The way the banking application is built and deployed in the previous trail does not it make it persistent, in such way that any created account can be retrieved later after stopping the bank server or if the application crashes; moreover, it does not allow concurrent access to accounts without leading to inconsistent values.</p>
</div>
<div class="paragraph">
<p>Two ways will be presented in this trail on the way to build the banking application as a persistent and sharable application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using the Narayana Object For Java (TXOJ) mechanisms</p>
<div class="ulist">
<ul>
<li>
<p>Overview of the Transactional Object For Java</p>
</li>
<li>
<p>Deploying the Banking application with TXOJ mechanisms</p>
</li>
</ul>
</div>
</li>
<li>
<p>Using the JDBC API by considering the banking application as a relational database.</p>
<div class="ulist">
<ul>
<li>
<p>Developing applications with JDBC and Narayana</p>
</li>
<li>
<p>The banking application as a relational database accessed with JDBC</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_what_is_transactional_object_for_java"><a class="anchor" href="#_what_is_transactional_object_for_java"></a>What is Transactional Object For Java</h5>
<div class="paragraph">
<p>ArjunaCore exploits object-oriented techniques to present programmers with a toolkit of Java classes from which application classes can inherit to obtain desired properties, such as persistence and concurrency control.
These classes form a hierarchy, part of which is shown below.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-ArjunaCore_Classes.PNG.png" alt="jts ArjunaCore Classes.PNG">
</div>
<div class="title">Figure 26. ArjunaCore class hierarchy</div>
</div>
<div class="paragraph">
<p>Apart from specifying the scopes of transactions, and setting appropriate locks within objects, the application programmer does not have any other responsibilities: ArjunaCore and Transactional Objects for Java (TXOJ) guarantee that transactional objects will be registered with, and be driven by, the appropriate transactions, and crash recovery mechanisms are invoked automatically in the event of failures.</p>
</div>
<div class="sect5">
<h6 id="_recovery_and_persistency"><a class="anchor" href="#_recovery_and_persistency"></a>Recovery and Persistency</h6>
<div class="paragraph">
<p>Making an object persistent and recoverable means that we shall be able to store its final state or to retrieve its initial state according to the final status of a transaction even in the presence of failures.
ArjunaCore provides a set of techniques to save to and to retrieve from the Object Store states of objects.
All objects made persistent with these ArjunaCore mechanisms are assigned unique identifiers (instances of the Uid class), when they are created, and this is to identify them within the object store.
Due to common functionality for persistency and recovery required by several applications, objects are stored and retrieved from the object store using the same mechanism: the classes OutputObjectState and InputObjecState.</p>
</div>
<div class="paragraph">
<p>At the root of the class hierarchy, given in Figure 1, is the class StateManager.
This class is responsible for object activation and deactivation and object recovery.
The simplified signature of the class is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">StateManager</span> {
    <span class="directive">public</span> <span class="type">boolean</span> activate();

    <span class="directive">public</span> <span class="type">boolean</span> deactivate(<span class="type">boolean</span> commit);

    <span class="directive">public</span> Uid get_uid(); <span class="comment">// object’s identifier.</span>

    <span class="comment">// methods to be provided by a derived class</span>
    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os);

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os);

    <span class="directive">protected</span> StateManager();

    <span class="directive">protected</span> StateManager(Uid id);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Objects are assumed to be of three possible flavours.
They may simply be recoverable, in which case StateManager will attempt to generate and maintain appropriate recovery information for the object.
Such objects have lifetimes that do not exceed the application program that creates them.
Objects may be recoverable and persistent, in which case the lifetime of the object is assumed to be greater than that of the creating or accessing application, so that in addition to maintaining recovery information StateManager will attempt to automatically load (unload) any existing persistent state for the object by calling the activate (deactivate) operation at appropriate times.
Finally, objects may possess none of these capabilities, in which case no recovery information is ever kept nor is object activation/deactivation ever automatically attempted.</p>
</div>
<div class="paragraph">
<p>According to the its activation or deactivation a transactional object for Java move from a passive state to an active state and vice-versa.
The fundamental life cycle of a persistent object in TXOJ is shown in Figure 2.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-txoj_lifecycle.PNG.png" alt="jts txoj lifecycle.PNG">
</div>
<div class="title">Figure 27. The life cycle of a persistent object.</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The object is initially passive, and is stored in the object store as an instance of the class OutputObjectState.</p>
</li>
<li>
<p>When required by an application the object is automatically activated by reading it from the store using a read_committed operation and is then converted from an InputObjectState instance into a fully-fledged object by the restore_state operation of the object.</p>
</li>
<li>
<p>When the application has finished with the object it is deactivated by converting it back into an OutputObjectState instance using the save_state operation, and is then stored back into the object store as a shadow copy using write_uncommitted.
This shadow copy can be committed, overwriting the previous version, using the commit_state operation.
The existence of shadow copies is normally hidden from the programmer by the transaction system.
Object de-activation normally only occurs when the top-level transaction within which the object was activated commits.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While deactivating and activating a transactional object for java, the operations save_state and restore_state are respectively invoked.
These operations must be implemented by the programmer since StateManager cannot detect user level state changes.
This gives the programmer the ability to decide which parts of an object&#8217;s state should be made persistent.
For example, for a spreadsheet it may not be necessary to save all entries if some values can simply be recomputed.
The save_state implementation for a class Example that has two integer member variables called A and B and one String member variable called C could simply be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState o) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.save_state(o))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    <span class="keyword">try</span> {
        o.packInt(A);
        o.packInt(B);
        o.packString(C))
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>while, the corresponding restore_state implementation allowing to retrieve similar values is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState o) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.restore_state(o))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    <span class="keyword">try</span> {
        A = o.unpackInt();
        B = o.unpackInt();
        S = o.unpackString())
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Classes OutputObjectState and InputObjectState provide respectively operations to pack and unpack instances of standard Java data types.
In other words for a standard Java data type, for instance Long or Short, there are corresponding methods to pack and unpack, i.e., packLong or packShort and unpackLong or unpackShort.</p>
</div>
<div class="paragraph">
<p><em>Note:</em> it is necessary for all save_state and restore_state methods to call super.save_state and super.restore_state.
This is to cater for improvements in the crash recovery mechanisms.</p>
</div>
</div>
<div class="sect5">
<h6 id="_the_concurrency_controller"><a class="anchor" href="#_the_concurrency_controller"></a>The concurrency controller</h6>
<div class="paragraph">
<p>The concurrency controller is implemented by the class LockManager which provides sensible default behaviour while allowing the programmer to override it if deemed necessary by the particular semantics of the class being programmed.
The primary programmer interface to the concurrency controller is via the setlock operation.
By default, the runtime system enforces strict two-phase locking following a multiple reader, single writer policy on a per object basis.
However, as shown in Figure 1, by inheriting from the Lock class it is possible for programmers to provide their own lock implementations with different lock conflict rules to enable type specific concurrency control.</p>
</div>
<div class="paragraph">
<p>Lock acquisition is (of necessity) under programmer control, since just as StateManager cannot determine if an operation modifies an object, LockManager cannot determine if an operation requires a read or write lock.
Lock release, however, is under control of the system and requires no further intervention by the programmer.
This ensures that the two-phase property can be correctly maintained.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">LockManager</span> <span class="directive">extends</span> StateManager {
   <span class="directive">public</span> LockResult setlock (<span class="predefined-type">Lock</span> toSet, <span class="type">int</span> retry, <span class="type">int</span> timeout);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The LockManager class is primarily responsible for managing requests to set a lock on an object or to release a lock as appropriate.
However, since it is derived from StateManager, it can also control when some of the inherited facilities are invoked.
For example, LockManager assumes that the setting of a write lock implies that the invoking operation must be about to modify the object.
This may in turn cause recovery information to be saved if the object is recoverable.
In a similar fashion, successful lock acquisition causes activate to be invoked.</p>
</div>
<div class="paragraph">
<p>The code below shows how we may try to obtain a write lock on an object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Example</span> <span class="directive">extends</span> LockManager {
    <span class="directive">public</span> <span class="type">boolean</span> foobar() {
        AtomicAction A = <span class="keyword">new</span> AtomicAction;
        <span class="comment">/*
         * The ArjunaCore AtomicAction class is here used to create
         * a transaction. Any interface provided by the JTA or
         * JTS interfaces that allow to create transactions can
         * be used in association with the Locking mechanisms
         * described in this trail.
         */</span>
        <span class="type">boolean</span> result = <span class="predefined-constant">false</span>;

        A.begin();
        <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.WRITE), <span class="integer">0</span>) == <span class="predefined-type">Lock</span>.GRANTED) {
            <span class="comment">/*
             * Do some work, and TXOJ will
             * guarantee ACID properties.
             */</span>
            <span class="comment">// automatically aborts if fails</span>
            <span class="keyword">if</span> (A.commit() == AtomicAction.COMMITTED) {
                result = <span class="predefined-constant">true</span>;
            }
        } <span class="keyword">else</span>
            A.rollback();

        <span class="keyword">return</span> result;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_further_reading_2"><a class="anchor" href="#_further_reading_2"></a>Further Reading</h6>
<div class="paragraph">
<p>More details on Transactional Object For Java can be found in the ArjunaCore Programming Guide.</p>
</div>
</div>
<div class="sect5">
<h6 id="_making_the_banking_application_persistent_with_transactional_object_for_java"><a class="anchor" href="#_making_the_banking_application_persistent_with_transactional_object_for_java"></a>Making the Banking Application Persistent with Transactional Object For Java</h6>
<div class="paragraph">
<p>The banking application consists of a Bank object that contains a list of Account object, which in turn have a String (name) and a float (the value) as member variables.
It appears clearly that from the persistent point of view, an Account Object need to store its name and its current balance or value, while the Bank Object need to store the list of accounts that it manages.</p>
</div>
<div class="sect6">
<h7 id="_distributed_configuration"><a class="anchor" href="#_distributed_configuration"></a>Distributed Configuration</h7>
<div class="paragraph">
<p>The banking application with Transactional Object for Java (TXOJ) is configured to use JTS interfaces as the API to create the transaction, then an ORB to deploy it.
The Narayana distribution is provided to work with the bundled JacORB version</p>
</div>
<div class="paragraph">
<p><em>Note</em> : Ensure that the jacorb jar files are added in your <code>CLASSPATH</code></p>
</div>
</div>
<div class="sect6">
<h7 id="_delpoy_the_application"><a class="anchor" href="#_delpoy_the_application"></a>Delpoy the Application</h7>
<div class="ulist">
<ul>
<li>
<p>Start the Server</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.txojbank.BankServer</code></pre>
</div>
</div>
</li>
<li>
<p>In a separate window, start the client</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.txojbank.BankClient</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>As for the demonstrations presented in the previous trails, the same menu is presented for the client with a set of operations such creating an account, credit/withdraw money to/from an account and making a transfer.</p>
</div>
<div class="paragraph">
<p>Building the banking application with TXOJ tools</p>
</div>
</div>
<div class="sect6">
<h7 id="_building_the_banking_application_with_txoj"><a class="anchor" href="#_building_the_banking_application_with_txoj"></a>Building the banking application with TXOJ</h7>

</div>
<div class="sect6">
<h7 id="_the_bank_idl"><a class="anchor" href="#_the_bank_idl"></a>The Bank IDL</h7>
<div class="paragraph">
<p>Since a distributed version has been adopted to present the application with Transactional Object for Java, an IDL file named Bank.idl described below is needed.
The difference with the Bank.idl presented in previous trails is the fact that the Bank interface inherits the CosTransactions::TransactionalObject interface.
Since we consider now that a Bank object need to modify its list in a transactional, we consider now a Bank object as a CORBA transactional.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">module arjuna {
   module demo {
     module jts {
      module txojbank {

        <span class="type">interface</span> <span class="class">Account</span> : CosTransactions::TransactionalObject
        {
          <span class="type">float</span> balance();
          <span class="type">void</span> credit( in <span class="type">float</span> value );
          <span class="type">void</span> debit( in <span class="type">float</span> value );
        };

        exception NotExistingAccount
        { };

        <span class="type">interface</span> <span class="class">Bank</span> : CosTransactions::TransactionalObject
        {
          Account create_account( in string name );
          Account get_account( in string name )
            raises( NotExistingAccount );
        };
       };
      };
     };
};</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The client program</p>
<div class="paragraph">
<p>Basically the client program (<code>src/com/arjuna/demo/jts/txojbank/BankClient.java</code>) is equivalent to the one described in the distributed jts version with implicit propagation, the difference is on the package name.</p>
</div>
</li>
<li>
<p>Implementing the Account Interface</p>
</li>
<li>
<p>Implementing the Bank Interface</p>
</li>
<li>
<p>Implementing the Bank Server.</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_implementing_the_account_interface"><a class="anchor" href="#_implementing_the_account_interface"></a>Implementing the Account interface</h7>
<div class="paragraph">
<p>To take benefit from the persistency and locking mechanism provided by ArjunaCore, a user class can inherit from the appropriate class (StateManager for recovery, and LockManager for recovery and concurrency control).
The AccountImpl class that implements the Account interface inherits the LockManager and implements the AccountOperations interface generated by the CORBA IDL compiler.
Since multiple inheritance is not allowed in Java, inheriting the AccountPOA class, as made in simple jts remote version, in addition to the LockManager is not possible.
That we use in this version a CORBA TIE mechanism to associate a servant to an CORBA object reference.</p>
</div>
<div class="paragraph">
<p>The Java interface definition of the AccountImpl class is given below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AccountImpl</span> <span class="directive">extends</span> LockManager <span class="directive">implements</span> AccountOperations {
    <span class="type">float</span> _balance;
    <span class="predefined-type">String</span> _name;

    <span class="directive">public</span> AccountImpl(<span class="predefined-type">String</span> name);

    <span class="directive">public</span> AccountImpl(Uid uid);

    <span class="directive">protected</span> <span class="type">void</span> finalize();

    <span class="directive">public</span> <span class="type">float</span> balance();

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value);

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value);

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="predefined-type">String</span> type();
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Constructors and Destructor</p>
<div class="paragraph">
<p>To use an existing persistent object requires the use of a special constructor that is required to take the Uid of the persistent object; the implementation of such a constructor is given below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> AccountImpl(Uid uid) {
    <span class="local-variable">super</span>(uid);
    <span class="comment">// Invoking super will lead to invoke the</span>
    <span class="comment">// restore_state method of this AccountImpl class</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is no particular behaviour applied by the Constructor with the Uid parameter The following constructor is used for a new Account creation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> AccountImpl(<span class="predefined-type">String</span> name ) {
    <span class="local-variable">super</span>(ObjectType.ANDPERSISTENT);
    _name = name;
    _balance = <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The destructor of the queue class is only required to call the terminate operation of LockManager.</p>
</div>
</li>
<li>
<p>save_state, restore_state and type</p>
<div class="paragraph">
<p>The implementations of save_state and restore_state are relatively simple for this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.save_state(os, ObjectType))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;

    <span class="keyword">try</span> {
        os.packString(_name);
        os.packFloat(_balance);
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.restore_state(os, ObjectType))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;

    <span class="keyword">try</span> {
        _name = os.unpackString();
        _balance = os.unpackFloat();
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the AccountImpl class is derived from the LockManager class, the operation type should be:</p>
</div>
</li>
<li>
<p>account management operations</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">float</span> balance() {
    <span class="type">float</span> result = <span class="integer">0</span>;
    <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.READ), <span class="integer">0</span>) == LockResult.GRANTED) {
        result = _balance;
    }
    ...

    return result;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the balance operation consists only to get the current balance, acquiring a lock in READ mode is enough.
This is not the case of the credit and debit methods that need to modify the current balance, that is a WRITE mode is needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
    <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.WRITE), <span class="integer">0</span>) == LockResult.GRANTED) {
        _balance += value;
    }
    ...
}

<span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
    <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.WRITE), <span class="integer">0</span>) == LockResult.GRANTED) {
        _balance -= value;
    }
    ...
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_sample_application_source_code"><a class="anchor" href="#_sample_application_source_code"></a>Sample Application Source Code</h7>
<div class="paragraph">
<p>Full source code for the <code>src/com/arjuna/demo/jts/txojbank/AccountImpl.java</code> &#8594; AccountImpl class is included to provide you with a starting point for experimentation.</p>
</div>
</div>
<div class="sect6">
<h7 id="_implementing_the_bank_interface"><a class="anchor" href="#_implementing_the_bank_interface"></a>Implementing the Bank interface</h7>
<div class="paragraph">
<p>To take benefit from the persistency and locking mechanism provided by ArjunaCore, a user class can inherit from the appropriate class (StateManager for recovery, and LockManager for recovery and concurrency control).
The BankImpl class that implements the Bank interface inherits the LockManager and implements the BankOperations interface generated by the CORBA IDL compiler.
Since multiple inheritance is not allowed in Java, inheriting the BankPOA class, as made in simple jts remote version, in addition to the LockManager is not possible.
That we use in this version a CORBA TIE mechanism to associate a servant to an CORBA object reference.</p>
</div>
<div class="paragraph">
<p>The Java interface definition of the BankImpl class is given below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BankImpl</span> <span class="directive">extends</span> LockManager <span class="directive">implements</span> BankOperations {
    <span class="directive">public</span> BankImpl(OA oa);

    <span class="directive">public</span> BankImpl(Uid uid, OA oa);

    <span class="directive">public</span> BankImpl(Uid uid);

    <span class="directive">public</span> Account create_account(<span class="predefined-type">String</span> name);

    <span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name);

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="predefined-type">String</span> type();

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> ACCOUNT_SIZE = <span class="integer">10</span>;
    <span class="comment">// ACCOUNT_SIZE is the maximum number of accounts</span>
    <span class="directive">private</span> <span class="predefined-type">String</span><span class="type">[]</span> accounts;
    <span class="directive">private</span> <span class="type">int</span> numberOfAccounts;
    <span class="directive">private</span> ORB _orb;
    <span class="directive">private</span> OA _oa;
    <span class="directive">private</span> java.util.Hashtable _accounts; <span class="comment">//The list of accounts</span>
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Constructors and Destructor</p>
<div class="paragraph">
<p>To use an existing persistent object requires the use of a special constructor that is required to take the Uid of the persistent object; the implementation of such a constructor is given below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> BankImpl(Uid uid) {
    <span class="local-variable">super</span>(uid);
    _accounts = <span class="keyword">new</span> java.util.Hashtable();
    numberOfAccounts = <span class="integer">0</span>;
    accounts = <span class="keyword">new</span> <span class="predefined-type">String</span>[ACCOUNT_SIZE];
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following constructor is invoked during the first creation of the Bank Object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> BankImpl(OA oa) {
    <span class="local-variable">super</span>(ObjectType.ANDPERSISTENT);
    _accounts = <span class="keyword">new</span> java.util.Hashtable();
    _oa = oa;
    numberOfAccounts = <span class="integer">0</span>;
    accounts = <span class="keyword">new</span> <span class="predefined-type">String</span>[ACCOUNT_SIZE];
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following constructor is invoked on successive BankServer restart.
A bank already exists and should be recreated.
Invoking super or the constructor of the inherited class leads to execute the restore_state method, described below, of the BankImpl class to rebuild the list of accounts previously created, if any.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> BankImpl(Uid uid, OA oa) {
    <span class="local-variable">super</span>(uid);
    _accounts = <span class="keyword">new</span> java.util.Hashtable();
    _oa = oa;
    numberOfAccounts = <span class="integer">0</span>;
    accounts = <span class="keyword">new</span> <span class="predefined-type">String</span>[ACCOUNT_SIZE];
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The destructor of the queue class is only required to call the terminate operation of LockManager.</p>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">protected</span> <span class="type">void</span> finalize() {
    <span class="local-variable">super</span>.terminate();
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>account management operations</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> Account create_account(<span class="predefined-type">String</span> name) {
    AccountImpl acc;
    AccountPOA account = <span class="predefined-constant">null</span>;
    <span class="comment">//Attempt to obtain the lock for change</span>
    <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.WRITE), <span class="integer">0</span>) == LockResult.GRANTED) {
        <span class="comment">//Check if the maximum number of accounts is not reached</span>
        <span class="keyword">if</span> (numberOfAccounts &lt; ACCOUNT_SIZE) {
            acc = <span class="keyword">new</span> AccountImpl(name); <span class="comment">//Create a new account</span>
            <span class="comment">//Use the TIE mechanism to create a CORBA object</span>
            account = <span class="keyword">new</span> AccountPOATie(acc);
            <span class="comment">//Add the account to the list of accounts that</span>
            <span class="comment">//facilitate to retrieve accounts</span>
            _accounts.put(name, acc);
            <span class="comment">//The Uid of the created account is put in the array</span>
            accounts[numberOfAccounts] = acc.get_uid().toString();
            numberOfAccounts++;
        }
    }
    <span class="keyword">return</span> com.arjuna.demo.jts.txojbank.
            AccountHelper.narrow(_oa.corbaReference(account));
}

<span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name)
        <span class="directive">throws</span> NotExistingAccount {
    <span class="comment">// Only the hashtable list is used to retrieve the account</span>
    AccountImpl acc = (AccountImpl) _accounts.get(name);
    AccountPOA account = <span class="keyword">new</span> AccountPOATie(acc);
    <span class="keyword">if</span> (acc == <span class="predefined-constant">null</span>)
        <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account
                requested does not exist</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> com.arjuna.demo.jts.txojbank.
            AccountHelper.narrow(_oa.corbaReference(account));
}</code></pre>
</div>
</div>
</li>
<li>
<p>save_state, restore_state and type</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.save_state(os, ObjectType))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;

    <span class="keyword">try</span> {
        os.packInt(numberOfAccounts);
        <span class="keyword">if</span> (numberOfAccounts &gt; <span class="integer">0</span>) {
            <span class="comment">// All Uid located in the array will be saved</span>
            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; numberOfAccounts; i++)
                os.packString(accounts[i]);
        }
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.restore_state(os, ObjectType)) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
    <span class="keyword">try</span> {
        numberOfAccounts = os.unpackInt();

        <span class="keyword">if</span> (numberOfAccounts &gt; <span class="integer">0</span>) {
            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; numberOfAccounts; i++) {
                accounts[i] = os.unpackString();
                <span class="comment">//each stored Uid is re-used to recreate</span>
                <span class="comment">//a stored account object</span>
                AccountImpl acc = <span class="keyword">new</span> AccountImpl(<span class="keyword">new</span> Uid(accounts[i]));
                acc.activate();
                <span class="comment">//Once recreated the account object</span>
                <span class="comment">//is activated and added to the list.</span>
                _accounts.put(acc.getName(), acc);
            }
        }
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="predefined-type">String</span> type () {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/StateManager/LockManager/BankServer</span><span class="delimiter">&quot;</span></span>;
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_sample_application_source_code_2"><a class="anchor" href="#_sample_application_source_code_2"></a>Sample Application Source Code</h7>
<div class="paragraph">
<p>Full source code for the <code>src/com/arjuna/demo/jts/txojbank/BankImpl.java</code> &#8594; BankImpl class is included to provide you with a starting point for experimentation.</p>
</div>
</div>
<div class="sect6">
<h7 id="_implementing_the_bankserver"><a class="anchor" href="#_implementing_the_bankserver"></a>Implementing the BankServer</h7>
<div class="paragraph">
<p>The role of the BankServer class is mainly to initialise the ORB and the Object Adapter and to create the default Bank object responsible to create banking accounts.</p>
</div>
<div class="paragraph">
<p>Globally, the BankServer has the following structure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">ServerSide</span><span class="delimiter">&quot;</span></span>);
myOA = OA.getRootOA(myORB);
myORB.initORB(args, <span class="predefined-constant">null</span>);
myOA.initOA();
...</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Initialise the ORB</p>
<div class="paragraph">
<p>This done using the ORB Portability API</p>
</div>
</li>
<li>
<p>Create the BankImpl object, an instance that implements the Bank interface.
Two ways are provided to build such Bank object according to the fact it&#8217;s the first time we create such object or not.
This depends on the existence or not of the file named "</p>
<div class="ulist">
<ul>
<li>
<p></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">...
java.io.FileInputStream file = <span class="keyword">new</span> java.io.FileInputStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">UidBankFile</span><span class="delimiter">&quot;</span></span>);
java.io.InputStreamReader input = <span class="keyword">new</span> java.io.InputStreamReader(file);
java.io.BufferedReader reader = <span class="keyword">new</span> java.io.BufferedReader(input);
<span class="predefined-type">String</span> stringUid = reader.readLine();
file.close();
_bank = <span class="keyword">new</span> BankImpl(<span class="keyword">new</span> Uid(stringUid), myOA);
<span class="type">boolean</span> result =_bank.activate();
...</code></pre>
</div>
</div>
</li>
<li>
<p>If the file does not exist, a new BankImpl object is created, then the Uid of the created object is stored in the file named "UidBankFile"</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">...
_bank = <span class="keyword">new</span> BankImpl(myOA);
java.io.FileOutputStream file = <span class="keyword">new</span> java.io.FileOutputStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">UidBankFile</span><span class="delimiter">&quot;</span></span>);
java.io.PrintStream pfile=<span class="keyword">new</span> java.io.PrintStream(file);
pfile.println(_bank.get_uid().toString());
file.close();
...</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Store the CORBA object reference of the BankImpl object in a file in such way the client can retrieve it from that file.</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_sample_application_source_code_3"><a class="anchor" href="#_sample_application_source_code_3"></a>Sample Application Source Code</h7>
<div class="paragraph">
<p>Full source code for the <code>src/com/arjuna/demo/jts/txojbank/BankServer.java</code> &#8594; <code>BankServer</code> class is included to provide you with a starting point for experimentation.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_developing_applications_with_jdbc_and_narayana_jts"><a class="anchor" href="#_developing_applications_with_jdbc_and_narayana_jts"></a>Developing applications with JDBC and Narayana JTS</h6>
<div class="paragraph">
<p>Narayana JTS supports the construction of both local and distributed transactional applications which access databases using the JDBC APIs.
JDBC supports two-phase commit of transactions, and is similar to the XA X/Open standard.
The JDBC support is found in the com.arjuna.ats.jdbc package.</p>
</div>
<div class="sect6">
<h7 id="_transactional_driver"><a class="anchor" href="#_transactional_driver"></a>Transactional Driver</h7>
<div class="paragraph">
<p>The Narayana JTS approach to incorporating JDBC connections within transactions is to provide transactional JDBC drivers through which all interactions occur.
These drivers intercept all invocations and ensure that they are registered with, and driven by, appropriate transactions.
There is a single type of transactional driver through which any JDBC driver can be driven; obviously if the database is not transactional then ACID properties cannot be guaranteed.
This driver is com.arjuna.ats.jdbc.TransactionalDriver, which implements the java.sql.Driver interface.</p>
</div>
<div class="paragraph">
<p>The driver may be directly instantiated and used within an application.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"> TransactionalDriver arjunaJDBC2Driver = <span class="keyword">new</span> TransactionalDriver();</code></pre>
</div>
</div>
<div class="paragraph">
<p>It can be registered with the JDBC driver manager (<code>java.sql.DriverManager</code>) by adding them to the Java system properties.
The <code>jdbc.drivers</code> property contains a list of driver class names, separated by colons, that are loaded by the JDBC driver manager when it is initialised, for instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">jdbc.drivers=foo.bar.Driver:mydata.sql.Driver:bar.test.myDriver</code></pre>
</div>
</div>
<div class="paragraph">
<p>On running an application, it is the DriverManager&#8217;s responsibility to load all the drivers found in the system property jdbc.drivers.
For example, this is where the driver for the Oracle database may be defined.
When opening a connection to a database it is the DriverManager' s role to choose the most appropriate driver from the previously loaded drivers.</p>
</div>
<div class="paragraph">
<p>A program can also explicitly load JDBC drivers at any time.
For example, the <code>my.sql.Driver</code> is loaded with the following statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="predefined-type">Class</span>.forName(<span class="string"><span class="delimiter">&quot;</span><span class="content">my.sql.Driver</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Calling Class.forName() will automatically register the driver with the JDBC driver manager.
It is also possible to explicitly create an instance of the JDBC driver using the registerDriver method of the DriverManager.
This is the case for instance for the TransactionalDriver that can be registered as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">TransactionalDriver arjunaJDBC2Driver = <span class="keyword">new</span> TransactionalDriver();
<span class="predefined-type">DriverManager</span>.registerDriver(arjunaJDBC2Driver);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you have loaded a driver, it is available for making a connection with a DBMS.</p>
</div>
</div>
<div class="sect6">
<h7 id="_making_connections"><a class="anchor" href="#_making_connections"></a>Making Connections</h7>
<div class="paragraph">
<p>Once a driver is loaded and ready for a connection to be made, instances of a Connection class can be created using the getConnection method on the DriverManager, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="predefined-type">Connection</span> con = <span class="predefined-type">DriverManager</span>.getConnection(url, username, password);</code></pre>
</div>
</div>
<div class="paragraph">
<p>From its version 2.0, the JDBC API has introduced a new way to obtain instances of the Connection class.
This is the case of the interfaces DataSource and XADataSource that creates transactional connections.
When using a JDBC 2.0 driver, Narayana will use the appropriate DataSource whenever a connection to the database is made.
It will then obtain XAResources and register them with the transaction via the JTA interfaces.
It is these XAResources which the transaction service will use when the transaction terminates in order to drive the database to either commit or rollback the changes made via the JDBC connection.</p>
</div>
<div class="paragraph">
<p>There are two ways in which the Narayana JDBC 2.0 support can obtain XADataSources.
These will be explained in the following sections.
Note, for simplicity we shall assume that the JDBC 2.0 driver is instantiated directly by the application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java Naming and Directory Interface (JNDI)</p>
<div class="paragraph">
<p>To get the ArjunaJDBC2Driver class to use a JNDI registered XADataSource it is first necessary to create the XADataSource instance and store it in an appropriate JNDI implementation.
Details of how to do this can be found in the JDBC 2.0 tutorial available at JavaSoft.
An example is show below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="predefined-type">XADataSource</span> ds = MyXADataSource();
<span class="predefined-type">Hashtable</span> env = <span class="keyword">new</span> <span class="predefined-type">Hashtable</span>();
<span class="predefined-type">String</span> initialCtx = PropertyManager.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Context.INITIAL_CONTEXT_FACTORY</span><span class="delimiter">&quot;</span></span>);
env.put(<span class="predefined-type">Context</span>.INITIAL_CONTEXT_FACTORY, initialCtx);
initialContext ctx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>(env);
ctx.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc/foo</span><span class="delimiter">&quot;</span></span>, ds);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where the Context.INITIAL_CONTEXT_FACTORY property is the JNDI way of specifying the type of JNDI implementation to use.</p>
</div>
<div class="paragraph">
<p>Then the application must pass an appropriate connection URL to the JDBC 2.0 driver:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="predefined-type">Properties</span> dbProps = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
dbProps.setProperty(TransactionalDriver.userName, <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>);
dbProps.setProperty(TransactionalDriver.password, <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>);
TransactionalDriver arjunaJDBC2Driver = <span class="keyword">new</span> TransactionalDriver();
<span class="predefined-type">Connection</span> connection = arjunaJDBC2Driver.connect(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:arjuna:jdbc/foo</span><span class="delimiter">&quot;</span></span>, dbProps);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JNDI URL must be pre-pended with jdbc:arjuna: in order for the ArjunaJDBC2Driver to recognise that the DataSource must participate within transactions and be driven accordingly.</p>
</div>
</li>
<li>
<p>Dynamic class instantiation</p>
<div class="paragraph">
<p>Many JDBC implementations provide proprietary implementations of XADataSources that provide non-standard extensions to the specification.
In order to allow the application to remain isolated from the actual JDBC 2.0 implementation it is using and yet continue to be able to use these extensions, Narayana hides the details of these proprietary implementations using dynamic class instantiation.
In addition, the use of JNDI is not required when using this mechanism because the actual implementation of the XADataSource will be directly instantiated, albeit in a manner which will not tie an application or driver to a specific implementation.
Narayana therefore has several classes which are for specific JDBC implementations, and these can be selected at runtime by the application setting the dynamicClass property appropriately:</p>
</div>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Database Type</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Property Name</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloudscape 3.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.internal.jdbc.drivers.cloudscape_3_6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequelink 5.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.internal.jdbc.drivers.sequelink_5_1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Oracle 8.1.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.internal.jdbc.drivers.oracle_8_1_6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQL Server 2000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.internal.jdbc.drivers.sqlserver_2_2</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The application code must specify which dynamic class the TransactionalDriver should instantiate when setting up the connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Properties</span> dbProps = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
dbProps.setProperty(TransactionalDriver.userName, <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>);
dbProps.setProperty(TransactionalDriver.password, <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>);
dbProps.setProperty(TransactionalDriver.dynamicClass,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.jdbc.drivers.sequelink_5_0</span><span class="delimiter">&quot;</span></span>);
TransactionalDriver arjunaJDBC2Driver = <span class="keyword">new</span> TransactionalDriver();
<span class="predefined-type">Connection</span> connection = arjunaJDBC2Driver.connect(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:arjuna:
        sequelink/*:host:port;databaseName=foo</span><span class="delimiter">&quot;</span></span>,dbProperties*/);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note on properties used by the <code>com.arjuna.ats.jdbc.TransactionalDriver</code> class</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>userName</em>: the user name to use when attempting to connect to the database.</p>
</li>
<li>
<p><em>password</em>: the password to use when attempting to connect to the database.</p>
</li>
<li>
<p><em>createDb</em>: if set to true, the driver will attempt to create the database when it connects.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This may not be supported by all JDBC 2.0 implementations.
</td>
</tr>
</table>
</div>
</li>
<li>
<p><em>dynamicClass</em>: this specifies a class to instantiate to connect to the database, rather than using JNDI.</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_using_the_connection"><a class="anchor" href="#_using_the_connection"></a>Using the Connection</h7>
<div class="paragraph">
<p>Once the connection has been established (for example, using the <code>java.sql.DriverManager.getConnection</code> method), all operations on the connection will be monitored by Narayana.
Once created, the driver and any connection can be used in the same way as any other JDBC driver or connection.</p>
</div>
<div class="paragraph">
<p>Narayana connections can be used within multiple different transactions simultaneously, i.e., different threads, with different notions of the current transaction, may use the same JDBC connection. Narayana does connection pooling for each transaction within the JDBC connection.
So, although multiple threads may use the same instance of the JDBC connection, internally this may be using a different connection instance per transaction.
With the exception of close, all operations performed on the connection at the application level will only be performed on this transaction-specific connection.</p>
</div>
<div class="paragraph">
<p>Narayana will automatically register the JDBC driver connection with the transaction via an appropriate resource . When the transaction terminates, this resource will be responsible for either committing or rolling back any changes made to the underlying database via appropriate calls on the JDBC driver.</p>
</div>
</div>
<div class="sect6">
<h7 id="_further_reading_3"><a class="anchor" href="#_further_reading_3"></a>Further reading</h7>
<div class="paragraph">
<p>More details on the way to manage applications using the JDBC API can be found in the Narayana Programming Guide.</p>
</div>
</div>
<div class="sect6">
<h7 id="_the_banking_application_as_a_relational_database_accessed_with_jdbc"><a class="anchor" href="#_the_banking_application_as_a_relational_database_accessed_with_jdbc"></a>The banking application as a relational database accessed with JDBC</h7>
<div class="paragraph">
<p>In regards to the its structure in the previous trails, the banking application described here has been slightly simplified.
In this version creating local JTA transactions, accounts managed by a bank object are in fact instances or tuples within a SQL relational table named "accounts".
When the Bank object is requested for instance to create an account or to get information on an account, the Bank object performs SQL statement such SQL INSERT or SQL SELECT.</p>
</div>
</div>
<div class="sect6">
<h7 id="_deploy_the_application"><a class="anchor" href="#_deploy_the_application"></a>Deploy the application</h7>
<div class="paragraph">
<p>Executing the demonstration consists to launch the folowing program</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jta.jdbcbank.BankClient  -host &lt;hostName&gt;
  -port portNumber  -username &lt;userName&gt;  -dbName &lt;DBName&gt;
  -password &lt;password&gt; -clean|-create</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>hostName</em> - the name of the machine where is located the database</p>
</li>
<li>
<p><em>userName</em> - the user name used to access the database</p>
</li>
<li>
<p><em>password</em> - the password used to access to database</p>
</li>
<li>
<p><em>DBName</em> - the database name</p>
</li>
<li>
<p><em>clean</em> - the existing relational table will be deleted then created</p>
</li>
<li>
<p><em>create</em> - a new relational table will be created</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Due to an issue with Oracle, it is possible that an XA exception is thrown when attempting to perform this test (see Release Notes).
If an xa error is returned you can use the following property property <em>com.arjuna.ats.jdbc.isolationLevel</em> set to <em>TRANSACTION_READ_COMMITTED</em> .
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This property can be added in previous command as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java -Dcom.arjuna.ats.jdbc.isolationLevel=TRANSACTION_READ_COMMITTED
  com.arjuna.demo.jta.jdbcbank.BankClient  -host &lt;hostName&gt;
  -port portNumber  -userName &lt;userName&gt;
  -password &lt;password&gt; -clean|-create</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_how_jdbc_is_used"><a class="anchor" href="#_how_jdbc_is_used"></a>How JDBC is used</h7>
<div class="paragraph">
<p>The following Banking application illustrates some methods that use the JDBC API.
In this application, the way to create a jdbc connection is made via an XADataSource obtained with JNDI operations, es explained in the previous trail jdbc introduction The BankClient class instantiates an XADataSource and bind it to a jndi naming in order to be retrieved to create transactional connections.
This portion of code illustrates how this made against oracle (tested on version 9i).
A similar code could tested against an other database by providng the appropriate XADataSource implementation.
Details of the BankClient class can be found in the file <code>src/com/arjuna/demo/jta/jdbcbank/BankClient.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.jdbcbank</span>;

<span class="keyword">import</span> <span class="include">javax.naming</span> .*;
        <span class="keyword">import</span> <span class="include">java.util.Hashtable</span>;
  <span class="keyword">import</span> <span class="include">oracle.jdbc.xa.client.OracleXADataSource</span>;
  <span class="keyword">import</span> <span class="include">com.arjuna.ats.jdbc.common.jdbcPropertyManager</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BankClient</span> {
    .....

    public <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        <span class="comment">//Provide the apporopriate information to access the database</span>
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; args.length; i++) {
            <span class="keyword">if</span> (args[i].compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">-host</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>)
                host = args[i + <span class="integer">1</span>]
            <span class="keyword">if</span> (args[i].compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">-port</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>)
                port = args[i + <span class="integer">1</span>];
            <span class="keyword">if</span> (args[i].compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">-username</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>)
                user = args[i + <span class="integer">1</span>];
            <span class="keyword">if</span> (args[i].compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">-password</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>)
                password = args[i + <span class="integer">1</span>];
            <span class="keyword">if</span> (args[i].compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">-dbName</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>)
                dbName = args[i + <span class="integer">1</span>];
            ....
        }

        <span class="keyword">try</span> {
            <span class="comment">// create DataSource</span>
            OracleXADataSource ds = <span class="keyword">new</span> OracleXADataSource();
            ds.setURL(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:oracle:thin:@</span><span class="delimiter">&quot;</span></span> + host + <span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span> + port + <span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span> + dbName);

            <span class="comment">// now stick it into JNDI</span>
            <span class="predefined-type">Hashtable</span> env = <span class="keyword">new</span> <span class="predefined-type">Hashtable</span>();
            env.put(<span class="predefined-type">Context</span>.INITIAL_CONTEXT_FACTORY,
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">com.sun.jndi.fscontext.RefFSContextFactory</span><span class="delimiter">&quot;</span></span>);
            env.put(<span class="predefined-type">Context</span>.PROVIDER_URL, <span class="string"><span class="delimiter">&quot;</span><span class="content">file:/tmp/JNDI</span><span class="delimiter">&quot;</span></span>);
            <span class="predefined-type">InitialContext</span> ctx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>(env);
            ctx.rebind(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc/DB</span><span class="delimiter">&quot;</span></span>, ds);
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
        }
        <span class="comment">//Set the jndi information to be user by the Arjuna JDBC Property Manager</span>
        jdbcPropertyManager.propertyManager.setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Context.INITIAL_CONTEXT_FACTORY</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">com.sun.jndi.fscontext.RefFSContextFactory</span><span class="delimiter">&quot;</span></span>);
        jdbcPropertyManager.propertyManager.setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Context.PROVIDER_URL</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">file:/tmp/JNDI</span><span class="delimiter">&quot;</span></span>);

        Bank bank = <span class="keyword">new</span> Bank();
        BankClient client = <span class="keyword">new</span> BankClient(bank);

    }

    ....</code></pre>
</div>
</div>
<div class="paragraph">
<p>While the BankClient class is responsible to obtain information to access the database, tocreate the XADataSource and bind it to jndi, and also to get order from a user (create_account, debit, transfer, ..), the Bank class is resposnible to create jdbc connections to perform user&#8217;s requests.
The Bank class is illustarted below where.
All methods are not illusrated here but have a similar behavior; they could be found in details in the <code>src/com/arjuna/demo/jta/jdbcbank/Bank.java</code> &#8594; <code>Bank.java</code> program.
Note that for simplicity, much error checking code has been removed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">    <span class="directive">public</span> Bank() {
        <span class="keyword">try</span> {
            <span class="predefined-type">DriverManager</span>.registerDriver(<span class="keyword">new</span> TransactionalDriver());
            dbProperties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
            dbProperties.put(TransactionalDriver.userName, user);
            dbProperties.put(TransactionalDriver.password, password);
            arjunaJDBC2Driver = <span class="keyword">new</span> TransactionalDriver(); <span class="comment">//</span>
            create_table();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            e.printStackTrace();
            <span class="predefined-type">System</span>.exit(<span class="integer">0</span>);
        }

        _accounts = <span class="keyword">new</span> java.util.Hashtable();
        reuseConnection = <span class="predefined-constant">true</span>;
    }

    <span class="directive">public</span> <span class="type">void</span> create_account(<span class="predefined-type">String</span> _name, <span class="type">float</span> _value) {
        <span class="keyword">try</span> {
            <span class="predefined-type">Connection</span> conne = arjunaJDBC2Driver.connect(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:arjuna:jdbc/DB</span><span class="delimiter">&quot;</span></span>, dbProperties);
            <span class="predefined-type">Statement</span> stmtx = conne.createStatement(); <span class="comment">// tx statement</span>
            stmtx.executeUpdate
                    (<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO accounts (name, value)
                            VALUES('</span><span class="delimiter">&quot;</span></span>+_name+<span class="string"><span class="delimiter">&quot;</span><span class="content">', </span><span class="delimiter">&quot;</span></span>+_value+<span class="string"><span class="delimiter">&quot;</span><span class="content">)</span><span class="delimiter">&quot;</span></span>);
        } <span class="keyword">catch</span> (<span class="exception">SQLException</span> e) {
            e.printStackTrace();
        }
    }

    <span class="directive">public</span> <span class="type">float</span> get_balance(<span class="predefined-type">String</span> _name)
            <span class="directive">throws</span> NotExistingAccount {
        <span class="type">float</span> theBalance = <span class="integer">0</span>;
        <span class="keyword">try</span> {
            <span class="predefined-type">Connection</span> conne = arjunaJDBC2Driver.connect(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:arjuna:jdbc/DB</span><span class="delimiter">&quot;</span></span>, dbProperties);
            <span class="predefined-type">Statement</span> stmtx = conne.createStatement(); <span class="comment">// tx statement</span>
            <span class="predefined-type">ResultSet</span> rs = stmtx.executeQuery
                    (<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT value from accounts
                            WHERE name = '</span><span class="delimiter">&quot;</span></span>+_name+<span class="string"><span class="delimiter">&quot;</span><span class="content">'</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">while</span> (rs.next()) {
                theBalance = rs.getFloat(<span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
            }
        } <span class="keyword">catch</span> (<span class="exception">SQLException</span> e) {
            e.printStackTrace();
            <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account requested does not exist</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="keyword">return</span> theBalance;
    }

    ....
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_note"><a class="anchor" href="#_note"></a>Note</h7>
<div class="paragraph">
<p>Although, this version of the banking application creates JTA local transactions, the way to manipulate JDBC API and the associated Narayana mechanisms in the case of distributed transactions is the same.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_recovery_from_failure_examples"><a class="anchor" href="#_recovery_from_failure_examples"></a>Recovery From Failure Examples</h5>
<div class="sect5">
<h6 id="_introduction_5"><a class="anchor" href="#_introduction_5"></a>Introduction</h6>
<div class="paragraph">
<p>Recovery is the mechanism which preserves the transaction atomicity in presence of failures.
The basic technique for implementing transactions in presence of failures is based on the use of logs.
That is, a transaction system has to record enough information to ensure that it can be able to return to a previous state in case of failure or to ensure that changes committed by a transaction are properly stored.</p>
</div>
<div class="paragraph">
<p>Narayana ensures that results of a transaction are applied consistently to all resources involved in a transaction, even in the presence of failure.
To recover from failure, Narayana relies on its Recovery Manager.</p>
</div>
<div class="paragraph">
<p>Basically, the Recovery Manager is a daemon process that invokes a set of well known Recovery Modules periodically in two steps; a first to determine transactions in doubt state and a second step to continue the completion of those transactions found in the first step.
Since different type of resources may be involved in a transaction, different type of Recovery Modules may exist. Narayana provides several type of modules that manage resources according to their position in the transaction tree (root, subordinate, leaf) or the nature of the data itself, transactional object for java or XAResource as seen in the previous trail.</p>
</div>
<div class="paragraph">
<p>Whatever the nature of the involved resource, recovery is based on information or logs held in the Object Store, which contains specific subdirectory holding information according to the nature of the participant.</p>
</div>
</div>
<div class="sect5">
<h6 id="_running_the_recovery_manager"><a class="anchor" href="#_running_the_recovery_manager"></a>Running the Recovery Manager</h6>
<div class="paragraph">
<p><em>This section provides only brief information on running the recovery manager from provided scripts.
For complete information on the recovery manager (including how to configure it), see the Narayana recovery information.</em></p>
</div>
<div class="sect6">
<h7 id="_windows"><a class="anchor" href="#_windows"></a>Windows</h7>
<div class="paragraph">
<p>To run the Recovery Manager as a Windows service, simply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open a command prompt</p>
</li>
<li>
<p>cd to the directory &lt;jbossts_install_root&gt;\services\bin\windows</p>
</li>
<li>
<p>Type InstallRecoveryManagerService-NT.bat</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This directory also contains the uninstall script which is ran in the same manner.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To launch the Recovery Manager as a Windows process, simply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open a command prompt</p>
</li>
<li>
<p>cd to the directory &lt;jbossts_install_root&gt;\services\bin\windows</p>
</li>
<li>
<p>Type recoverymanagerservice.bat</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_unix"><a class="anchor" href="#_unix"></a>UNIX</h7>
<div class="paragraph">
<p>To launch the Recovery Manager on a Linux/UNIX platform, simply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open a command prompt</p>
</li>
<li>
<p>cd to the directory &lt;jbossts_install_root&gt;\services\bin\[platform]</p>
</li>
<li>
<p>Type recoverymanagerservice.sh start</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To uninstall the recovery manager, rerun the script specifying the stop flag.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_the_recovery_process_and_xaresources"><a class="anchor" href="#_the_recovery_process_and_xaresources"></a>The Recovery Process and XAResources</h6>
<div class="paragraph">
<p>The Narayana recovery manager provides support for recovering XAResources whether or not they are Serializable.
XAResources that <em>do</em> implement the Serializable interface are handled without requiring additional programmer defined classes.
For those XAResources that need to recover but which cannot implement Serializable, it is possible to provide a small class which is used to help recover them.</p>
</div>
<div class="paragraph">
<p>This example shows the Narayana recovery manager recovering a Serializable XAResource and a non-Serializable XAResource.</p>
</div>
<div class="sect6">
<h7 id="_the_demos_components"><a class="anchor" href="#_the_demos_components"></a>The demo&#8217;s components</h7>
<div class="paragraph">
<p>The application consists of four classes.
Each class is well documented and it is recommended that the provided code is inspected to gain useful insight into some of the nuances of the recovery process.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The code of the main class that controls the application (<code>src/com/arjuna/demo/recovery/xaresource/TestXAResourceRecovery.java</code> &#8594; <code>TestRecoveryModule.java</code>), allows the user to specify a number of options: <code>[-waitForRecovery] [-useExternalRecoveryManager]</code></p>
</li>
<li>
<p>Programmer-defined support of the Serializable XAResource is only required in the XAResource implementation class <code>src/com/arjuna/demo/recovery/xaresource/ExampleXAResource.java</code> &#8594; <code>ExampleXAResource.java</code></p>
</li>
<li>
<p>Programmer-defined support of the non-Serializable XAResource is required both in the XAResource implementation class <code>src/com/arjuna/demo/recovery/xaresource/NonSerializableExampleXAResource.java</code> &#8594; <code>NonSerializableExampleXAResource</code>, and in a class that implements a helper for the Narayana recovery process <code>src/com/arjuna/demo/recovery/xaresource/NonSerializableExampleXAResourceRecovery.java</code> &#8594; <code>NonSerializableExampleXAResourceRecovery.java</code></p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_xaresourcerecovery_registration"><a class="anchor" href="#_xaresourcerecovery_registration"></a>XAResourceRecovery registration</h7>
<div class="paragraph">
<p>When recovering from failures, Narayana requires the ability to reconnect to the resource managers that were in use prior to the failures in order to resolve any outstanding transactions.
In order to recreate those connections for non-Serializable XAResources it is necessary to provide implementations of the following Narayana interface com.arjuna.ats.jta.recovery.XAResourceRecovery.</p>
</div>
<div class="paragraph">
<p>To inform the recovery system about each of the XAResourceRecovery instances, it is necessary to specify their class names through property variables in the <code>jbossts-properties.xml</code> file.
Any property variable which starts with the name XAResourceRecovery will be assumed to represent one of these instances, and its value should be the class name.</p>
</div>
<div class="paragraph">
<p>When running XA transaction recovery it is necessary to tell Narayana which types of Xid it can recover.
Each Xid that Narayana creates has a unique node identifier encoded within it and Narayana will only recover transactions and states that match a specified node identifier.
The node identifier to use should be provided to Narayana via a property that starts with the name com.arjuna.ats.jta.xaRecoveryNode (multiple values may be provided).
A value of * will force Narayana to recover (and possibly rollback) all transactions irrespective of their node identifier and should be used with caution.</p>
</div>
<div class="paragraph">
<p>The recovery module for the non-Serializable XAResource must be deployed in order to provide support to recover the non-Serializable XAResource.
If this step was missed out the Serializable XAResource would recover OK but Narayana would have no knowledge of the non-Serializable XAResource and so it could not recover it.
To register the non-Serializable XAResource XAResourceRecovery module, add an entry to the <code>jbossts-properties.xml</code>.</p>
</div>
<div class="paragraph">
<p>Under the element <code>&lt;properties depends="jts" name="jta"&gt;</code>, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.jta.recovery.XAResourceRecovery1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.demo.recovery.xaresource.NonSerializableExampleXAResourceRecovery</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.jta.xaRecoveryNode</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="sect7">
<h8 id="_configure_the_recovery_manager_scan_period"><a class="anchor" href="#_configure_the_recovery_manager_scan_period"></a>Configure the recovery manager scan period</h8>
<div class="paragraph">
<p>By default, the recovery manager is configured to perform a pass over resources to be recovered every two minutes.
It will then wait for ten seconds before re-checking the resources.
Although the test will run OK with this configuration, it is possible to configure the recovery manager scan times to reduce the time waiting.
To configure the intervals, edit the <code>jbossts-properties.xml</code> as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Edit the property "com.arjuna.ats.arjuna.recovery.periodicRecoveryPeriod" to change the value from 120 to 5.</p>
</li>
<li>
<p>Edit the property "com.arjuna.ats.arjuna.recovery.recoveryBackoffPeriod" to change the value from 10 to 5.</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_specify_the_transaction_manager_type_to_use"><a class="anchor" href="#_specify_the_transaction_manager_type_to_use"></a>Specify the transaction manager type to use</h8>
<div class="paragraph">
<p>The recovery manager will work in the same manner for either the JTA or JTS implementation.
By default Narayana is configured to use a JTS transaction manager, in order to configure it to use a JTA transaction manager a change must again be made to the <code>jbossts-properties.xml</code>.
<em>See "Testing JTA" for more information on how to configure the Narayana transaction manager to use JTA rather than JTS.</em></p>
</div>
<div class="paragraph">
<p><em>If you do change the transaction manager type remember to reconfigure the recovery manager as follows:</em></p>
</div>
<div class="paragraph">
<p>If you are using the ArjunaCore (raw JTA) transaction manager implementation comment out the element in <code>jbossts-properties.xml</code> containing the following text:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">internal.jta.recovery.jts.XARecoveryModule</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using the JTS transaction manager implementation comment out the element in <code>jbossts-properties.xml</code> containing the following text:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">internal.jta.recovery.arjunacore.XARecoveryModule</code></pre>
</div>
</div>
</div>
<div class="sect7">
<h8 id="_launching_the_demo"><a class="anchor" href="#_launching_the_demo"></a>Launching the demo</h8>
<div class="paragraph">
<p>To launch the Test Recovery Module, execute the following java program</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open a command prompt</p>
</li>
<li>
<p>cd to the directory <code>&lt;jbossts_install_root&gt;\trail_map</code></p>
</li>
<li>
<p>Type <code>java com.arjuna.demo.recovery.xaresource.TestXAResourceRecovery</code></p>
</li>
<li>
<p>View the output noting the crash during commit.</p>
</li>
<li>
<p>Inspect the current working directory to note that the applications have created several log files which you may like to review.</p>
</li>
<li>
<p>Type <code>java com.arjuna.demo.recovery.xaresource.TestXAResourceRecovery -waitForRecovery</code></p>
</li>
<li>
<p>Wait for the two resources to be recovered and committed.</p>
</li>
<li>
<p>Re-review the log files from the working directory, if wanted.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As you can see, the Serializable XAResource does not need it&#8217;s recover() method called as the transaction manager is aware of all the information about this resource.
</td>
</tr>
</table>
</div>
</div>
<div class="sect7">
<h8 id="_the_recovery_process_and_abstractrecords"><a class="anchor" href="#_the_recovery_process_and_abstractrecords"></a>The Recovery Process and AbstractRecords</h8>
<div class="paragraph">
<p><em>WARNING: Implementing a RecoveryModule and AbstractRecord is a very advanced feature of the transaction service.
It should only be performed by users familiar with the all the concepts used in the Narayana product.
Please see the ArjunaCore guide for more information about RecoveryModules and AbstractRecords.</em></p>
</div>
<div class="paragraph">
<p>The following sample gives an overview how the Recovery Manager invokes a module to recover from failure.
This basic sample does not aim to present a complete process to recover from failure, but mainly to illustrate the way to implement a recovery module.
More details can be found in "Failure Recovery Guide".</p>
</div>
<div class="paragraph">
<p>The application used here consists to create an atomic transaction, to register a participant within the created transaction and finally to terminate it either by commit or abort.
A set of arguments are provided:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to decide committing or aborting the transaction,</p>
</li>
<li>
<p>to decide generating a crash during the commitment process.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">The demo&#8217;s components</div>
<p>The application consists of three programs</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The code of the main class that control the application (<code>src/com/arjuna/demo/recoverymodule/TestRecoveryModule.java</code> &#8594; <code>TestRecoveryModule.java</code>), which consists to give the choice to either commit or abort the transaction and also to generate a crash.</p>
</li>
<li>
<p>The registered participant (<code>src/com/arjuna/demo/recoverymodule/SimpleRecord.java</code> &#8594; <code>SimpleRecord.java</code>) has the following behaviour:</p>
<div class="ulist">
<ul>
<li>
<p>During the prepare phase, it writes a simple message - "I&#8217;m prepared" - on the disk such message is written in a well known file</p>
</li>
<li>
<p>During the commit phase, it writes another message - "I&#8217;m committed" - in the same file used during prepare</p>
</li>
<li>
<p>If it receives an abort message, it removes from the disk the file used for prepare if any.</p>
</li>
<li>
<p>if a crash has been decided for the test, then it crashes during the commit phase - the file remains with the message "I&#8217;m prepared".</p>
</li>
</ul>
</div>
</li>
<li>
<p>A Recovery Module (<code>src/com/arjuna/demo/recoverymodule/SimpleRecoveryModule.java</code> &#8594; <code>SimpleRecoveryModule.java</code>) that consists to read the content of the file used to store the status of the participant, to determine that status and print a message indicating if a recovery action is needed or not.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using the provided Narayana Recovery Modules ensures that resources are correctly recovered.
This sample illustrates how to define and register its own module.
It&#8217;s the responsibility of the module to re-create the appropriate objects using information retrieved from a log.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Recovery Module registration</div>
<p>The recovery module should now be deployed in order to be called by the Recovery Manager.
To do so, we just need to add an entry in the <code>jbossts-properties.xml</code> by adding a new property as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryExtension&lt;i</span></span><span class="error">&gt;</span>&quot; value=&quot;com.arjuna.demo.recoverymodule.SimpleRecoveryModule&quot;/<span class="error">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Where &lt;i&gt; represent the new occurrence number that follows the last that already exists in the file.
Once started, the Recovery Manager will automatically load the added Recovery module.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Starting the Recovery Manager</div>
<p>In a separate window launch the Recovery Manager, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager -test</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Launching the demo</div>
<p>To launch the Test Recovery Module, execute the following java program</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.recoverymodule.TestRecoveryModule
  [-commit|-abort] [-crash]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_failure_recovery"><a class="anchor" href="#_failure_recovery"></a>2.8. Failure Recovery</h3>
<div class="paragraph">
<p>The failure recovery subsystem of Narayana ensure that results of a transaction are applied consistently to all resources affected by the transaction, even if any of the application processes or the hardware hosting them crash or lose network connectivity.
In the case of hardware crashes or network failures, the recovery does not take place until the system or network are restored, but the original application does not need to be restarted.
Recovery is handled by the Recovery Manager process.
For recover to take place, information about the transaction and the resources involved needs to survive the failure and be accessible afterward.
This information is held in the <code>ActionStore</code>, which is part of the <code>ObjectStore</code>.
If the <code>ObjectStore</code> is destroyed or modified, recovery may not be possible.</p>
</div>
<div class="paragraph">
<p>Until the recovery procedures are complete, resources affected by a transaction which was in progress at the time of the failure may be inaccessible.
Database resources may report this as as tables or rows held by in-doubt transactions.
For TXOJ resources, an attempt to activate the Transactional Object, such as when trying to get a lock, fails.</p>
</div>
<div class="sect3">
<h4 id="_configuring_the_failure_recovery_subsystem_for_your_orb"><a class="anchor" href="#_configuring_the_failure_recovery_subsystem_for_your_orb"></a>2.8.1. Configuring the failure recovery subsystem for your ORB</h4>
<div class="paragraph">
<p>Although some ORB-specific configuration is necessary to configure the ORB sub-system, the basic settings are ORB-independent.
The configuration which applies to Narayana is in the <code>RecoveryManager-properties.xml</code> file and the <code>orportability-properties.xml</code> file.
Contents of each file are below.</p>
</div>
<div class="listingblock">
<div class="title">RecoverManager-properties.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.recoveryActivatorClassNames</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    com.arjuna.ats.internal.jts.orbspecific.recovery.RecoveryEnablement
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">orportability-properties.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.orbportability.orb.PostInit2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>com.arjuna.ats.internal.jts.recovery.RecoveryInit<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These entries cause instances of the named classes to be loaded.
The named classes then load the ORB-specific classes needed and perform other initialization.
This enables failure recovery for transactions initiated by or involving applications using this property file.
The default <code>RecoveryManager-properties.xml</code> file and <code>orportability-properties.xml</code> with the distribution include these entries.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Failure recovery is NOT supported with the JavaIDL ORB that is part of JDK.
Failure recovery is supported for JacOrb only.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To disable recovery, remove or comment out the <code>RecoveryEnablement</code> line in the property file.</p>
</div>
</div>
<div class="sect3">
<h4 id="_jts_specific_recovery"><a class="anchor" href="#_jts_specific_recovery"></a>2.8.2. JTS specific recovery</h4>
<div class="sect4">
<h5 id="_xa_resource_recovery"><a class="anchor" href="#_xa_resource_recovery"></a>XA resource recovery</h5>
<div class="paragraph">
<p>Recovery of XA resources accessed via JDBC is handled by the <code>XARecoveryModule</code>. This module includes both transaction-initiated and resource-initiated recovery.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Transaction-initiated recovery is possible where the particular transaction branch progressed far enough for a <code>JTA_ResourceRecord</code> to be written in the ObjectStore.
The record contains the information needed to link the transaction to information known by the rest of Narayana in the database.</p>
</li>
<li>
<p>Resource-initiated recovery is necessary for branches where a failure occurred after the database made a persistent record of the transaction, but before the <code>JTA_ResourceRecord</code> was written.
Resource-initiated recovery is also necessary for datasources for which it is impossible to hold information in the <code>JTA_ResourceRecord</code> that allows the recreation in the RecoveryManager of the <code>XAConnection</code> or <code>XAResource</code> used in the original application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Transaction-initiated recovery is automatic.
The <code>XARecoveryModule</code> finds the <code>JTA_ResourceRecord</code> which needs recovery, using the two-pass mechanism described above.
It then uses the normal recovery mechanisms to find the status of the transaction the resource was involved in, by running <code>replay_completion</code> on the <code>RecoveryCoordinator</code> for the transaction branch.
Next, it creates or recreates the appropriate <code>XAResource</code> and issues <code>commit</code> or <code>rollback</code> on it as appropriate.
The <code>XAResource</code> creation uses the same database name, username, password, and other information as the application.</p>
</div>
<div class="paragraph">
<p>Resource-initiated recovery must be specifically configured, by supplying the <code>RecoveryManager</code> with the appropriate information for it to interrogate all the <code>XADataSources</code> accessed by any Narayana application.
The access to each <code>XADataSource</code> is handled by a class that implements the <code>com.arjuna.ats.jta.recovery.XAResourceRecovery</code> interface.
Instances of this class are dynamically loaded, as controlled by property <code>JTAEnvironmentBean.xaResourceRecoveryInstances</code> .</p>
</div>
<div class="paragraph">
<p>The <code>XARecoveryModule</code> uses the <code>XAResourceRecovery</code> implementation to get an <code>XAResource</code> to the target datasource.
On each invocation of periodicWorkSecondPass`, the recovery module issues an <code>XAResource.recover</code> request.
This request returns a list of the transaction identifiers that are known to the datasource and are in an in-doubt state.
The list of these in-doubt Xids is compared across multiple passes, using <code>periodicWorkSecondPass-es</code>.
Any Xid that appears in both lists, and for which no <code>JTA_ResourceRecord</code> is found by the intervening transaction-initiated recovery, is assumed to belong to a transaction involved in a crash before any <code>JTA_Resource_Record</code> was written, and a <code>rollback</code> is issued for that transaction on the <code>XAResource</code>.</p>
</div>
<div class="paragraph">
<p>This double-scan mechanism is used because it is possible the Xid was obtained from the datasource just as the original application process was about to create the corresponding JTA_ResourceRecord.
The interval between the scans should allow time for the record to be written unless the application crashes (and if it does, rollback is the right answer).</p>
</div>
<div class="paragraph">
<p>An <code>XAResourceRecovery</code> implementation class can contain all the information needed to perform recovery to a specific datasource.
Alternatively, a single class can handle multiple datasources which have some similar features.
The constructor of the implementation class must have an empty parameter list, because it is loaded dynamically.
The interface includes an <code>initialise</code> method, which passes in further information as a <code>string</code>.
The content of the string is taken from the property value that provides the class name.
Everything after the first semi-colon is passed as the value of the string.
The <code>XAResourceRecovery</code> implementation class determines how to use the string.</p>
</div>
<div class="paragraph">
<p>An <code>XAResourceRecovery</code> implementation class, <code>com.arjuna.ats.internal.jdbc.recovery.BasicXARecovery</code>, supports resource-initiated recovery for any XADataSource.
For this class, the string received in method <code>initialise</code> is assumed to contain the number of connections to recover, and the name of the properties file containing the dynamic class name, the database username, the database password and the database connection URL.
The following example is for an Oracle 8.1.6 database accessed via the Sequelink 5.1 driver:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>XAConnectionRecoveryEmpay=com.arjuna.ats.internal.jdbc.recovery.BasicXARecovery;2;OraRecoveryInfo</pre>
</div>
</div>
<div class="paragraph">
<p>This implementation is only meant as an example, because it relies upon usernames and passwords appearing in plain text properties files.
You can create your own implementations of <code>XAConnectionRecovery</code>.
See the javadocs and the example <code>com.arjuna.ats.internal.jdbc.recovery.BasicXARecovery</code>.</p>
</div>
<div class="listingblock">
<div class="title">XAConnectionRecovery implementation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.arjuna.ats.internal.jdbc.recovery</span>;

<span class="keyword">import</span> <span class="include">com.arjuna.ats.jdbc.TransactionalDriver</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jdbc.common.jdbcPropertyManager</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jdbc.logging.jdbcLogger</span>;

<span class="keyword">import</span> <span class="include">com.arjuna.ats.internal.jdbc</span>.*;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jta.recovery.XAConnectionRecovery</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.arjuna.common</span>.*;
<span class="keyword">import</span> <span class="include">com.arjuna.common.util.logging</span>.*;

<span class="keyword">import</span> <span class="include">java.sql</span>.*;
<span class="keyword">import</span> <span class="include">javax.sql</span>.*;

<span class="keyword">import</span> <span class="include">jakarta.transaction</span>.*;

<span class="keyword">import</span> <span class="include">javax.transaction.xa</span>.*;
<span class="keyword">import</span> <span class="include">java.util</span>.*;

<span class="keyword">import</span> <span class="include">java.lang.NumberFormatException</span>;

<span class="comment">/**
 * This class implements the XAConnectionRecovery interface for XAResources.
 * The parameter supplied in setParameters can contain arbitrary information
 * necessary to initialise the class once created. In this instance it contains
 * the name of the property file in which the db connection information is
 * specified, as well as the number of connections that this file contains
 * information on (separated by ;).
 * &lt;p&gt;
 * IMPORTANT: this is only an *example* of the sorts of things an
 * XAConnectionRecovery implementor could do. This implementation uses
 * a property file which is assumed to contain sufficient information to
 * recreate connections used during the normal run of an application so that
 * we can perform recovery on them. It is not recommended that information such
 * as user name and password appear in such a raw text format as it opens up
 * a potential security hole.
 * &lt;p&gt;
 * The db parameters specified in the property file are assumed to be
 * in the format:
 * &lt;p&gt;
 * DB_x_DatabaseURL=
 * DB_x_DatabaseUser=
 * DB_x_DatabasePassword=
 * DB_x_DatabaseDynamicClass=
 * &lt;p&gt;
 * DB_JNDI_x_DatabaseURL=
 * DB_JNDI_x_DatabaseUser=
 * DB_JNDI_x_DatabasePassword=
 * &lt;p&gt;
 * where x is the number of the connection information.
 *
 * @since JTS 2.1.
 */</span>

<span class="directive">public</span> <span class="type">class</span> <span class="class">BasicXARecovery</span> <span class="directive">implements</span> XAConnectionRecovery {
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> dbTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">DB_</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> urlTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">_DatabaseURL</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> passwordTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">_DatabasePassword</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> userTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">_DatabaseUser</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> dynamicClassTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">_DatabaseDynamicClass</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> jndiTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">JNDI_</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">char</span> BREAKCHARACTER = <span class="string"><span class="delimiter">'</span><span class="content">;</span><span class="delimiter">'</span></span>;  <span class="comment">// delimiter for parameters</span>
    <span class="directive">private</span> <span class="type">int</span> numberOfConnections;
    <span class="directive">private</span> <span class="type">int</span> connectionIndex;
    <span class="directive">private</span> <span class="predefined-type">Properties</span> props;
    <span class="comment">/*
     * Some XAConnectionRecovery implementations will do their startup work
     * here, and then do little or nothing in setDetails. Since this one needs
     * to know dynamic class name, the constructor does nothing.
     */</span>
    <span class="directive">public</span> BasicXARecovery() <span class="directive">throws</span> <span class="exception">SQLException</span> {
        numberOfConnections = <span class="integer">1</span>;
        connectionIndex = <span class="integer">0</span>;
        props = <span class="predefined-constant">null</span>;
    }

    <span class="comment">/**
     * The recovery module will have chopped off this class name already.
     * The parameter should specify a property file from which the url,
     * user name, password, etc. can be read.
     */</span>

    <span class="directive">public</span> <span class="type">boolean</span> initialise(<span class="predefined-type">String</span> parameter) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="type">int</span> breakPosition = parameter.indexOf(BREAKCHARACTER);
        <span class="predefined-type">String</span> fileName = parameter;

        <span class="keyword">if</span> (breakPosition != -<span class="integer">1</span>) {
            fileName = parameter.substring(<span class="integer">0</span>, breakPosition - <span class="integer">1</span>);

            <span class="keyword">try</span> {
                numberOfConnections = <span class="predefined-type">Integer</span>.parseInt(parameter.substring(breakPosition + <span class="integer">1</span>));
            } <span class="keyword">catch</span> (<span class="exception">NumberFormatException</span> e) {
                <span class="comment">//Produce a Warning Message</span>
                <span class="keyword">return</span> <span class="predefined-constant">false</span>;
            }
        }

        PropertyManager.addPropertiesFile(fileName);

        <span class="keyword">try</span> {
            PropertyManager.loadProperties(<span class="predefined-constant">true</span>);

            props = PropertyManager.getProperties();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="comment">//Produce a Warning Message</span>

            <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        }

        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    }

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="predefined-type">XAConnection</span> getConnection() <span class="directive">throws</span> <span class="exception">SQLException</span> {
        JDBC2RecoveryConnection conn = <span class="predefined-constant">null</span>;

        <span class="keyword">if</span> (hasMoreConnections()) {
            connectionIndex++;

            conn = getStandardConnection();

            <span class="keyword">if</span> (conn == <span class="predefined-constant">null</span>)
                conn = getJNDIConnection();

            <span class="keyword">if</span> (conn == <span class="predefined-constant">null</span>)
            <span class="comment">//Produce a Warning message</span>
        }

        <span class="keyword">return</span> conn;
    }

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> hasMoreConnections() {
        <span class="keyword">if</span> (connectionIndex == numberOfConnections)
            <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        <span class="keyword">else</span>
            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    }

    <span class="directive">private</span> <span class="directive">final</span> JDBC2RecoveryConnection getStandardConnection() <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="predefined-type">String</span> number = <span class="keyword">new</span> <span class="predefined-type">String</span>(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> + connectionIndex);
        <span class="predefined-type">String</span> url = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + number + urlTag);
        <span class="predefined-type">String</span> password = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + number + passwordTag);
        <span class="predefined-type">String</span> user = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + number + userTag);
        <span class="predefined-type">String</span> dynamicClass = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + number + dynamicClassTag);
        <span class="predefined-type">Properties</span> dbProperties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
        <span class="predefined-type">String</span> theUser = props.getProperty(user);
        <span class="predefined-type">String</span> thePassword = props.getProperty(password);

        <span class="keyword">if</span> (theUser != <span class="predefined-constant">null</span>) {
            dbProperties.put(ArjunaJDBC2Driver.userName, theUser);
            dbProperties.put(ArjunaJDBC2Driver.password, thePassword);

            <span class="predefined-type">String</span> dc = props.getProperty(dynamicClass);

            <span class="keyword">if</span> (dc != <span class="predefined-constant">null</span>)
                dbProperties.put(ArjunaJDBC2Driver.dynamicClass, dc);

            <span class="keyword">return</span> <span class="keyword">new</span> JDBC2RecoveryConnection(url, dbProperties);
        } <span class="keyword">else</span>
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }

    <span class="comment">/*
     * Example:
     *
     * DB2_DatabaseURL=jdbc\:arjuna\:sequelink\://qa02\:20001
     * DB2_DatabaseUser=tester2
     * DB2_DatabasePassword=tester
     * DB2_DatabaseDynamicClass=
     *      com.arjuna.ats.internal.jdbc.drivers.sequelink_5_1
     *
     * DB_JNDI_DatabaseURL=jdbc\:arjuna\:jndi
     * DB_JNDI_DatabaseUser=tester1
     * DB_JNDI_DatabasePassword=tester
     * DB_JNDI_DatabaseName=empay
     * DB_JNDI_Host=qa02
     * DB_JNDI_Port=20000
     */</span>

    <span class="directive">private</span> <span class="directive">final</span> JDBC2RecoveryConnection getJNDIConnection() <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="predefined-type">String</span> number = <span class="keyword">new</span> <span class="predefined-type">String</span>(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> + connectionIndex);
        <span class="predefined-type">String</span> url = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + jndiTag + number + urlTag);
        <span class="predefined-type">String</span> password = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + jndiTag + number + passwordTag);
        <span class="predefined-type">String</span> user = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + jndiTag + number + userTag);
        <span class="predefined-type">Properties</span> dbProperties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
        <span class="predefined-type">String</span> theUser = props.getProperty(user);
        <span class="predefined-type">String</span> thePassword = props.getProperty(password);

        <span class="keyword">if</span> (theUser != <span class="predefined-constant">null</span>) {
            dbProperties.put(ArjunaJDBC2Driver.userName, theUser);
            dbProperties.put(ArjunaJDBC2Driver.password, thePassword);
            <span class="keyword">return</span> <span class="keyword">new</span> JDBC2RecoveryConnection(url, dbProperties);
        } <span class="keyword">else</span>
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Multiple recovery domains and resource-initiated recovery</div>
<code>XAResource.recover</code> returns the list of all transactions that are in-doubt with in the datasource.
If multiple recovery domains are used with a single datasource, resource-initiated recovery sees transactions from other domains.
Since it does not have a <code>JTA_ResourceRecord</code> available, it rolls back the transaction in the database, if the Xid appears in successive recover calls.
To suppress resource-initiated recovery, do not supply an <code>XAConnectionRecovery</code> property, or confine it to one recovery domain.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_recovery_behavior"><a class="anchor" href="#_recovery_behavior"></a>Recovery behavior</h5>
<div class="paragraph">
<p>Property <code>OTS_ISSUE_RECOVERY_ROLLBACK</code> controls whether the <code>RecoveryManager</code> explicitly issues a rollback request when <code>replay_completion</code> asks for the status of a transaction that is unknown.
According to the <code>presume-abort</code> mechanism used by OTS and JTS, the transaction can be assumed to have rolled back, and this is the response returned to the Resource`, including a subordinate coordinator, in this case.
The <code>Resource</code> should then apply that result to the underlying resources.
However, it is also legitimate for the superior to issue a rollback, if <code>OTS_ISSUE_RECOVERY_ROLLBACK</code> is set to <code>YES</code>.</p>
</div>
<div class="paragraph">
<p>The OTS transaction identification mechanism makes it possible for a transaction coordinator to hold a <code>Resource</code> reference that will never be usable.
This can occur in two cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The process holding the <code>Resource</code> crashes before receiving the commit or rollback request from the coordinator.</p>
</li>
<li>
<p>The <code>Resource</code> receives the commit or rollback, and responds.
However, the message is lost or the coordinator process has crashed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the first case, the <code>RecoveryManager</code> for the <code>Resource``ObjectStore</code> eventually reconstructs a new <code>Resource</code> (with a different CORBA object reference (IOR), and issues a <code>replay_completion</code> request containing the new <code>Resource</code> IOR.
The <code>RecoveryManager</code> for the coordinator substitutes this in place of the original, useless one, and issues <code>commit</code> to the new reconstructed <code>Resource</code>.
The <code>Resource</code> has to have been in a commit state, or there would be no transaction intention list.
Until the <code>replay_completion</code> is received, the <code>RecoveryManager</code> tries to send <code>commit</code> to its <code>Resource</code> reference.
This will fail with a CORBA System Exception.
Which exception depends on the ORB and other details.</p>
</div>
<div class="paragraph">
<p>In the second case, the <code>Resource</code> no longer exists.
The <code>RecoveryManager</code> at the coordinator will never get through, and will receive System Exceptions forever.</p>
</div>
<div class="paragraph">
<p>The <code>RecoveryManager</code> cannot distinguish these two cases by any protocol mechanism.
There is a perceptible cost in repeatedly attempting to send the commit to an inaccessible <code>Resource</code>. In particular, the timeouts involved will extend the recovery iteration time, and thus potentially leave resources inaccessible for longer.</p>
</div>
<div class="paragraph">
<p>To avoid this, the <code>RecoveryManager</code> only attempts to send <code>commit</code> to a <code>Resource</code> a limited number of times.
After that, it considers the transaction assumed complete.
It retains the information about the transaction, by changing the object type in the ActionStore`, and if the <code>Resource</code> eventually does wake up and a <code>replay_completion</code> request is received, the <code>RecoveryManager</code> activates the transaction and issues the commit request to the new Resource IOR.
The number of times the <code>RecoveryManager</code> attempts to issue <code>commit</code> as part of the periodic recovery is controlled by the property variable <code>COMMITTED_TRANSACTION_RETRY_LIMIT</code>, and defaults to <code>3</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_expired_entry_removal_2"><a class="anchor" href="#_expired_entry_removal_2"></a>Expired entry removal</h5>
<div class="paragraph">
<p>The operation of the recovery subsystem causes some entries to be made in the <code>ObjectStore</code> that are not removed in normal progress.
The <code>RecoveryManager</code> has a facility for scanning for these and removing items that are very old.
Scans and removals are performed by implementations of the <code>&gt;com.arjuna.ats.arjuna.recovery.ExpiryScanner</code>.
Implementations of this interface are loaded by giving the class names as the value of the property <code>RecoveryEnvironmentBean.expiryScannerClassNames</code>.
The <code>RecoveryManager</code> calls the <code>scan</code> method on each loaded <code>ExpiryScanner</code> implementation at an interval determined by the property <code>RecoveryEnvironmentBean.expiryScanInterval</code>.
This value is given in hours, and defaults to <code>12</code>.
A property value of <code>0</code> disables any expiry scanning.
If the value as supplied is positive, the first scan is performed when <code>RecoveryManager</code> starts.
If the value is negative, the first scan is delayed until after the first interval, using the absolute value.</p>
</div>
<div class="paragraph">
<p>There are two kinds of item that are scanned for expiry:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contact items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One contact item is created by every application process that uses Narayana.
They contain the information that the <code>RecoveryManager</code> uses to determine if the process that initiated the transaction is still alive, and what the transaction status is.
The expiry time for these is set by the property <code>RecoveryEnvironmentBean.transactionStatusManagerExpiryTime</code>, which is expressed in hours.
The default is <code>12</code> , and <code>0</code> suppresses the expiration.
This is the interval after which a process that cannot be contacted is considered to be dead.
It should be long enough to avoid accidentally removing valid entries due to short-lived transient errors such as network downtime.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Assumed complete transactions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The expiry time is counted from when the transactions were assumed to be complete.
A <code>replay_completion</code> request resets the clock.
The risk with removing assumed complete transactions it that a prolonged communication outage means that a remote <code>Resource</code> cannot connect to the <code>RecoveryManager</code> for the parent transaction.
If the assumed complete transaction entry is expired before the communications are recovered, the eventual <code>replay_completion</code> will find no information and the <code>Resource</code> will be rolled back, although the transaction committed.
Consequently, the expiry time for assumed complete transactions should be set to a value that exceeds any anticipated network outage.
The parameter is <code>ASSUMED_COMPLETE_EXPIRY_TIME</code>.
It is expressed in hours, with <code>240</code> being the default, and <code>0</code> meaning never to expire.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">ExpiryScanner properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.expiryScannerClassNames</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    com.arjuna.ats.internal.arjuna.recovery.ExpiredTransactionStatusManagerScanner
    com.arjuna.ats.internal.jts.recovery.contact.ExpiredContactScanner
    com.arjuna.ats.internal.jts.recovery.transactions.ExpiredToplevelScanner
    com.arjuna.ats.internal.jts.recovery.transactions.ExpiredServerScanner
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two `ExpiryScannner&#8217;s for the assumed complete transactions, because there are different types in the ActionStore.</p>
</div>
</div>
<div class="sect4">
<h5 id="_recovery_domains"><a class="anchor" href="#_recovery_domains"></a>Recovery domains</h5>
<div class="paragraph">
<p>A key part of the recovery subsystem is that the <code>RecoveryManager</code> hosts the OTS <code>RecoveryCoordinator</code> objects that handle recovery for transactions initiated in application processes.
Information passes between the application process and the <code>RecoveryManager</code> in one of three ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>RecoveryCoordinator</code> object references (IORs) are created in the application process.
They contain information identifying the transaction in the object key.
They pass the object key to the <code>Resource</code> objects, and the <code>RecoveryManager</code> receives it.</p>
</li>
<li>
<p>The application process and the <code>RecoveryManager</code> access the same <code>jbossts-properties.xml</code>, and therefore use the same <code>ObjectStore</code>.</p>
</li>
<li>
<p>The <code>RecoveryCoordinator</code> invokes CORBA directly in the application, using information in the contact items.
Contact items are kept in the <code>ObjectStore</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Multiple recovery domains may useful if you are doing a migration, and separate <code>ObjectStores</code> are useful.
However, multiple RecoveryManagers can cause problems with XA datasources if resource-initiated recovery is active on any of them.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_status_and_replay_comparison"><a class="anchor" href="#_transaction_status_and_replay_comparison"></a>2.8.3. Transaction status and <code>replay_comparison</code></h4>
<div class="paragraph">
<p>When a transaction successfully commits, the transaction log is removed from the system.
The log is no longer required, since all registered Resources have responded successfully to the two-phase commit sequence.
However, if a <code>Resource</code> calls <code>replay_completion</code> on the <code>RecoveryCoordinator</code> after the transaction it represents commits, the status returned is <code>StatusRolledback</code>.
The transaction system does not keep a record of committed transactions, and assumes that in the absence of a transaction log, the transaction must have rolled back.
This is in line with the <code>presumed abort protocol</code> used by the OTS.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jta_and_jts"><a class="anchor" href="#_jta_and_jts"></a>2.9. JTA and JTS</h3>
<div class="sect3">
<h4 id="_distributed_jta"><a class="anchor" href="#_distributed_jta"></a>2.9.1. Distributed JTA</h4>
<div class="paragraph">
<p>This guide describes how to use the JTA interfaces for purely local transactions.
This is a high-performance implementation, but you can only use it to execute transactions within the same process.
If you need support for distributed transactions, the JTA needs to use the JTS.
Another advantage of this approach is interoperability with other JTS-compliant transaction systems.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you use the JTS and JTA interfaces to manage the same transactions, the JTA needs to be configured to be aware of the JTS.
Otherwise, local transactions will be unaware of their JTS counterparts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You need to do this configuration manually, because some applications may be using Narayana in a purely local manner, or may need to differentiate between transactions managed by JTS and JTA.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Making the JTA interfaces JTS-aware</div>
<ol class="arabic">
<li>
<p>Set <code>JTAEnvironmentBean.jtaTMImplementation</code> to <code>com.arjuna.ats.internal.jta.transaction.jts.TransactionManagerImple</code>.</p>
</li>
<li>
<p>Set <code>JTAEnvironmentBean.jtaUTImplementation</code> to <code>com.arjuna.ats.internal.jta.transaction.jts.UserTransactionImple</code>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_orb_specific_configuration"><a class="anchor" href="#_orb_specific_configuration"></a>2.10. ORB-specific configuration</h3>
<div class="sect3">
<h4 id="_jacorb_2"><a class="anchor" href="#_jacorb_2"></a>2.10.1. JacORB</h4>
<div class="paragraph">
<p>Take care to use only the patched version of JacORB shipped with Narayana.
Correct functioning of the transaction system, particularly with regard to crash recovery, is unlikely to work with an unpatched JacORB.
For each deployment of JacORB, ensure that the <code>jacorb.implname</code> in the <code>jacorb.properties</code> file is unique.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_orb_portability_2"><a class="anchor" href="#_orb_portability_2"></a>3. ORB Portability</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_orb_portability_introduction"><a class="anchor" href="#_orb_portability_introduction"></a>3.1. ORB Portability Introduction</h3>
<div class="paragraph">
<p>This part of the guide contains information on how to use the ORB Portability Layer.
Although the CORBA specification is a standard, it is written in such a way that allows for a wide variety of implementations.
Unless writing extremely simple applications, differences between ORB implementations tend to produce code which cannot easily be moved between ORBs.
This is especially true for server-side code, which suffers from the widest variation between ORBs.
There have also been a number of revisions of the Java language mapping for IDL and for CORBA itself.
Many ORBs currently in use support different versions of CORBA and/or the Java language mapping.</p>
</div>
<div class="paragraph">
<p>The Narayana only supports the new Portable Object Adapter (POA) architecture described in the CORBA 2.3 specification as a replacement for the Basic Object Adapter (BOA).
Unlike the BOA, which was weakly specified and led to a number of different (and often conflicting) implementations, the POA was deliberately designed to reduce the differences between ORB implementations, and thus minimize the amount of re-coding that would need to be done when porting applications from one ORB to another.
However, there is still scope for slight differences between ORB implementations, notably in the area of threading.
Note, instead of talking about the POA, this manual will consider the Object Adapter (OA).</p>
</div>
<div class="paragraph">
<p>Because the Narayana must be able to run on a number of different ORBs, we have developed an ORB portability interface which allows entire applications to be moved between ORBs with little or no modifications.
This portability interface is available to the application programmer in the form of several Java classes.
Note, the classes to be described in this document are located in the <code>com.arjuna.orbportability</code> package.</p>
</div>
</div>
<div class="sect2">
<h3 id="_orb_portability_api"><a class="anchor" href="#_orb_portability_api"></a>3.2. ORB Portability API</h3>
<div class="sect3">
<h4 id="_using_the_orb_and_oa"><a class="anchor" href="#_using_the_orb_and_oa"></a>3.2.1. Using the ORB and OA</h4>
<div class="paragraph">
<p>The <code>ORB</code> class shown below provides a uniform way of using the ORB.
There are methods for obtaining a reference to the ORB, and for placing the application into a mode where it listens for incoming connections.
There are also methods for registering application-specific classes to be invoked before or after ORB initialisation.
Note, some of the methods are not supported on all ORBs, and in this situation, a suitable exception will be thrown.
The ORB class is a factory class which has no public constructor.
To create an instance of an ORB you must call the getInstance method passing a unique name as a parameter.
If this unique name has not been passed in a previous call to <code>getInstance</code> you will be returned a new ORB instance.
Two invocations of getInstance made with the same unique name, within the same JVM, will return the same ORB instance.</p>
</div>
<div class="listingblock">
<div class="title"><em>ORB.java</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ORB</span> {
    <span class="directive">public</span> <span class="directive">static</span> ORB getInstance(<span class="predefined-type">String</span> uniqueId);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initORB() <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initORB(<span class="predefined-type">Applet</span> a, <span class="predefined-type">Properties</span> p) <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initORB(<span class="predefined-type">String</span><span class="type">[]</span> s, <span class="predefined-type">Properties</span> p) <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> org.omg.CORBA.ORB orb();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setOrb(org.omg.CORBA.ORB theORB);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> shutdown();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> addAttribute(<span class="predefined-type">Attribute</span> p);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> addPreShutdown(PreShutdown c);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> addPostShutdown(PostShutdown c);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> destroy() <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="type">void</span> run();

    <span class="directive">public</span> <span class="type">void</span> run(<span class="predefined-type">String</span> name);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We shall now describe the various methods of the ORB class.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>initORB</code>: given the various parameters, this method initialises the ORB and retains a reference to it within the ORB class.
This method should be used in preference to the raw ORB interface since the Narayana requires a reference to the ORB.
If this method is not used, setOrb must be called prior to using Narayana.</p>
</li>
<li>
<p><code>orb</code>: this method returns a reference to the ORB.
After shutdown is called this reference may be null.</p>
</li>
<li>
<p><code>shutdown</code>: where supported, this method cleanly shuts down the ORB.
Any pre- and post- ORB shutdown classes which have been registered will also be called.
See the section titled ORB and OA Initialisation.
This method must be called prior to application termination.
It is the application programmer&#8217;s responsibility to ensure that no objects or threads continue to exist which require access to the ORB.
It is ORB implementation dependant whether outstanding references to the ORB remain useable after this call.</p>
</li>
<li>
<p><code>addAttribute</code>: this method allows the application to register classes with Narayana which will be called either before, or after the ORB has been initialised.
See the section titled ORB and OA Initialisation.
If the ORB has already been initialised then the attribute object will not be added, and false will be returned.</p>
</li>
<li>
<p><code>run</code>: these methods place the ORB into a listening mode, where it waits for incoming invocations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The OA classes shown below provide a uniform way of using Object Adapters (OA).
There are methods for obtaining a reference to the OA.
There are also methods for registering application-specific classes to be invoked before or after OA initialisation.
Note, some of the methods are not supported on all ORBs, and in this situation, a suitable exception will be thrown.
The OA class is an abstract class and provides the basic interface to an Object Adapter.
It has two sub-classes <code>RootOA</code> and <code>ChildOA</code>, these classes expose the interfaces specific to the root Object Adapter and a child Object Adapter respectively.
From the <code>RootOA</code> you can obtain a reference to the <code>RootOA</code> for a given ORB by using the static method get`RootOA`.
To create a <code>ChildOA</code> instance use the createPOA method on the <code>RootOA</code>.</p>
</div>
<div class="listingblock">
<div class="title"><em>OA.java</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">OA</span> {
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="directive">static</span> RootOA getRootOA(ORB associatedORB);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initPOA() <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initPOA(<span class="predefined-type">String</span><span class="type">[]</span> args) <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initOA() <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initOA(<span class="predefined-type">String</span><span class="type">[]</span> args) <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> ChildOA createPOA(
            <span class="predefined-type">String</span> adapterName, PolicyList policies)
            <span class="directive">throws</span> AdapterAlreadyExists, InvalidPolicy;

    <span class="directive">public</span> <span class="directive">synchronized</span> org.omg.PortableServer.POA rootPoa();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setPoa(org.omg.PortableServer.POA thePOA);

    <span class="directive">public</span> <span class="directive">synchronized</span> org.omg.PortableServer.POA poa(<span class="predefined-type">String</span> adapterName);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setPoa(<span class="predefined-type">String</span> adapterName, org.omg.PortableServer.POA thePOA);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> addAttribute(OAAttribute p);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> addPreShutdown(OAPreShutdown c);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> addPostShutdown(OAPostShutdown c);
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">RootOA</span> <span class="directive">extends</span> OA {
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> destroy() <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> org.omg.CORBA.Object corbaReference(Servant obj);

    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady(Servant obj, <span class="type">byte</span><span class="type">[]</span> id);

    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady(Servant obj);

    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject(org.omg.CORBA.Object obj);

    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject(Servant obj);
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">ChildOA</span> <span class="directive">extends</span> OA {
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setRootPoa(POA thePOA);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> destroy() <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> org.omg.CORBA.Object corbaReference(Servant obj);

    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady(Servant obj, <span class="type">byte</span><span class="type">[]</span> id) <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady(Servant obj) <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject(org.omg.CORBA.Object obj);

    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject(Servant obj);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We shall now describe the various methods of the OA class.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>initPOA</code>: this method activates the POA, if this method is called on the <code>RootPOA</code> the POA with the name <code>RootPOA</code> will be activated.</p>
</li>
<li>
<p><code>createPOA</code>: if a child POA with the specified name for the current POA has not already been created then this method will create and activate one, otherwise <code>AdapterAlreadyExists</code> will be thrown.
This method returns a <code>ChildOA</code> object.</p>
</li>
<li>
<p><code>initOA</code>: this method calls the initPOA method and has been retained for backwards compatibility.</p>
</li>
<li>
<p><code>rootPoa</code>: this method returns a reference to the root POA.
After destroy is called on the root POA this reference may be null.</p>
</li>
<li>
<p><code>poa</code>: this method returns a reference to the POA.
After destroy is called this reference may be null.</p>
</li>
<li>
<p><code>destroy</code>: this method destroys the current POA, if this method is called on a <code>RootPOA</code> instance then the root POA will be destroyed along with its children.</p>
</li>
<li>
<p><code>shutdown</code>: this method shuts down the POA.</p>
</li>
<li>
<p><code>addAttribute</code>: this method allows the application to register classes with Narayana which will be called either before or after the OA has been initialised.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See below.
If the OA has already been initialised then the attribute object will not be added, and false will be returned.</p>
</div>
<div class="sect4">
<h5 id="_orb_and_oa_initialisation"><a class="anchor" href="#_orb_and_oa_initialisation"></a>ORB and OA Initialisation</h5>
<div class="paragraph">
<p>It is possible to register application-specific code with the ORB portability library which can be executed either before or after the ORB or OA are initialised.
Application programs can inherit from either <code>com.arjuna.orbportability.orb.Attribute</code> or <code>com.arjuna.orbportability.oa.Attribute</code> and pass these instances to the addAttribute method of the ORB/OA classes respectively:</p>
</div>
<div class="listingblock">
<div class="title"><em>Attribute.java</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.arjuna.orbportability.orb</span>;

<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">Attribute</span> {
    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">void</span> initialise(<span class="predefined-type">String</span><span class="type">[]</span> params);

    <span class="directive">public</span> <span class="type">boolean</span> postORBInit();
}

<span class="keyword">package</span> <span class="namespace">com.arjuna.orbportability.oa</span>;

<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">OAAttribute</span> {
    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">void</span> initialise(<span class="predefined-type">String</span><span class="type">[]</span> params);

    <span class="directive">public</span> <span class="type">boolean</span> postOAInit();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the <code>postORBInit/postOAInit</code> methods return true, which means that any instances of derived classes will be invoked after either the ORB or OA have been initialised.
By redefining this to return false, a particular instance will be invoked before either the ORB or OA have been initialised.</p>
</div>
<div class="paragraph">
<p>When invoked, each registered instance will be provided with the exact String parameters passed to the initialise method for the ORB/OA.</p>
</div>
</div>
<div class="sect4">
<h5 id="_orb_and_oa_shutdown"><a class="anchor" href="#_orb_and_oa_shutdown"></a>ORB and OA shutdown</h5>
<div class="paragraph">
<p>It is possible to register application-specific code (via the <code>addPreShutdown/addPostShutdown</code> methods) with the ORB portability library which will be executed prior to, or after, shutting down the ORB.
The pre/post interfaces which are to be registered have a single work method, taking no parameters and returning no results.
When the ORB and OA are being shut down (using <code>shutdown/destroy</code> ), each registered class will have its work method invoked.</p>
</div>
<div class="listingblock">
<div class="title"><em>Shutdown.java</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">PreShutdown</span> {
    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">void</span> work();
}

<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">PostShutdown</span> {
    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">void</span> work();
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_specifying_the_orb_to_use_3"><a class="anchor" href="#_specifying_the_orb_to_use_3"></a>Specifying the ORB to use</h5>
<div class="paragraph">
<p>JDK releases from 1.2.2 onwards include a minimum ORB implementation from Sun.
If using such a JDK in conjunction with another ORB it is necessary to tell the JVM which ORB to use.
This happens by specifying the <code>org.omg.CORBA.ORBClass</code> and <code>org.omg.CORBA.ORBSingletonClass</code> properties.
The ORB Portability classes will ensure that these properties are automatically set when required, i.e., during ORB initialisation.
Of course, it is still possible to specify these values explicitly (and necessary if not using the ORB initialisation methods).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
if you do not use the ORB Portability classes for ORB initialisation then it will still be necessary to set these properties.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The ORB portability library attempts to detect which ORB is in use, it does this by looking for the ORB implementation class for each ORB it supports.
This means that if there are classes for more than one ORB in the classpath the wrong ORB can be detected.
Therefore, it is best to only have one ORB in your classpath.
If it is necessary to have multiple ORBs in the classpath then the property <code>OrbPortabilityEnvironmentBean.orbImplementation</code> must be set to the value specified in the table below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ORB</th>
<th class="tableblock halign-left valign-top">Property Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JacORB v2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.orbportability.internal.orbspecific.jacorb.orb.implementations.jacorb_2_0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDK miniORB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.orbportability.internal.orbspecific.javaidl.orb.implementations.javaidl_1_4</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_initialisation_code"><a class="anchor" href="#_initialisation_code"></a>Initialisation code</h5>
<div class="paragraph">
<p>The Narayana requires specialised code to be instantiated before and after the ORB and the OA are initialised.
This code can be provided at runtime through the use of <code>OrbPortabilityEnvironmentBean.orbInitializationProperties</code>.
This mechanism is also available to programmers who can register arbitrary code which the ORB Portability will guarantee to be instantiated either before or after ORB/OA initialisation.
For each application (and each execution of the same application) the programmer can simultaneously provide multiple Java classes which are instantiated before and after the ORB and or OA is initialised.
There are few restrictions on the types and numbers of classes which can be passed to an application at execution time.
All classes which are to be instantiated must have a public default constructor, i.e., a constructor which takes no parameters.
The classes can have any name.
The property names used must follow the format specified below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com..orbportability.orb.PreInit</code> – this property is used to specify a global pre-initialisation routine which will be run before any ORB is initialised.</p>
</li>
<li>
<p><code>com..orbportability.orb.PostInit</code> – this property is used to specify a global post-initialisation routine which will be run after any ORB is initialised.</p>
</li>
<li>
<p><code>com..orbportability.orb.&lt;ORB NAME&gt;.PreInit</code> – this property is used to specify a pre-initialisation routine which will be run when an ORB with the given name is initialised.</p>
</li>
<li>
<p><code>com..orbportability.orb.&lt;ORB NAME&gt;.PostInit</code> – this property is used to specify a post-initialisation routine which will be run after an ORB with the given name is initialised.</p>
</li>
<li>
<p><code>com..orbportability.oa.PreInit</code> – this property is used to specify a global pre-initialisation routine which will be run before any OA is initialised.</p>
</li>
<li>
<p><code>com..orbportability.oa.PostInit</code> – this property is used to specify a global post-initialisation routine which will be run after any OA is initialised,</p>
</li>
<li>
<p><code>com..orbportability.oa.&lt;ORB NAME&gt;.PreInit</code> – this property is used to specify a pre-initialisation routine which will be run before an OA with the given name is initialised</p>
</li>
<li>
<p><code>com..orbportability.oa.&lt;ORB NAME&gt;.PostInit</code> – this property is used to specify a pre-initialisation routine which will be run after an OA with the given name is initialised</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pre and post initialisation can be arbitrarily combined, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java –DorbPortabilityEnvironmentBean.orbInitializationProperties=”com..orbportability.orb.PreInit=org.foo.AllORBPreInit
  com..orbportability.orb.MyORB.PostInit=org.foo.MyOrbPostInit
  com..orbportability.oa.PostInit=orb.foo.AllOAPostInit” org.foo.MyMainClass</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_locating_objects_and_services"><a class="anchor" href="#_locating_objects_and_services"></a>Locating Objects and Services</h5>
<div class="paragraph">
<p>Locating and binding to distributed objects within CORBA can be ORB specific.
For example, many ORBs provide implementations of the naming service, whereas some others may rely upon proprietary mechanisms.
Having to deal with the many possible ways of binding to objects can be a difficult task, especially if portable applications are to be constructed.
ORB Portability provides the Services class in order to provide a more manageable, and portable binding mechanism.
The implementation of this class takes care of any ORB specific locations mechanisms, and provides a single interface to a range of different object location implementations.</p>
</div>
<div class="listingblock">
<div class="title"><em>Services.java</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Services</span> {
    <span class="comment">/**
     * The various means used to locate a service.
     */</span>

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> RESOLVE_INITIAL_REFERENCES = <span class="integer">0</span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> NAME_SERVICE = <span class="integer">1</span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> CONFIGURATION_FILE = <span class="integer">2</span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> FILE = <span class="integer">3</span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> NAMED_CONNECT = <span class="integer">4</span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> BIND_CONNECT = <span class="integer">5</span>;

    <span class="directive">public</span> <span class="directive">static</span> org.omg.CORBA.Object getService(
            <span class="predefined-type">String</span> serviceName, <span class="predefined-type">Object</span><span class="type">[]</span> params,
            <span class="type">int</span> mechanism) <span class="directive">throws</span> InvalidName,
            CannotProceed, NotFound, <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">static</span> org.omg.CORBA.Object getService(
            <span class="predefined-type">String</span> serviceName, <span class="predefined-type">Object</span><span class="type">[]</span> params)
            <span class="directive">throws</span> InvalidName, CannotProceed, NotFound,
            <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> registerService(
            org.omg.CORBA.Object objRef,
            <span class="predefined-type">String</span> serviceName, <span class="predefined-type">Object</span><span class="type">[]</span> params,
            <span class="type">int</span> mechanism) <span class="directive">throws</span> InvalidName, <span class="exception">IOException</span>,
            CannotProceed, NotFound;

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> registerService(
            org.omg.CORBA.Object objRef,
            <span class="predefined-type">String</span> serviceName, <span class="predefined-type">Object</span><span class="type">[]</span> params)
            <span class="directive">throws</span> InvalidName, <span class="exception">IOException</span>, CannotProceed,
            NotFound;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are currently several different object location and binding mechanisms supported by Services (not all of which are supported by all ORBs, in which case a suitable exception will be thrown):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>RESOLVE_INITIAL_REFERENCES</em>: if the ORB supported <code>resolve_initial_references</code>, then Services will attempt to use this to locate the object.</p>
</li>
<li>
<p><em>NAME_SERVICE</em>: Services will contact the name service for the object.
The name service will be located using <code>resolve_initial_references</code>.</p>
</li>
<li>
<p><em>CONFIGURATION_FILE</em>: as described in the Using the OTS Manual, the Narayana supports an initial reference file where references for specific services and objects can be stored and used at runtime.
The file, <code>CosServices.cfg</code>, consists of two columns: the service name (in the case of the OTS server TransactionService) and the IOR, separated by a single space.
<code>CosServices.cfg</code> is located at runtime by the <code>OrbPortabilityEnvironmentBean</code> properties <code>initialReferencesRoot</code> (a directory, defaulting to the current working directory) and <code>initialReferencesFile</code> (a name relative to the directory, <code>CosServices.cfg</code> by default).</p>
</li>
<li>
<p><em>FILE</em> : object IORs can be read from, and written to, application-specific files.
The service name is used as the file name.</p>
</li>
<li>
<p><em>NAMED_CONNECT</em> : some ORBs support proprietary location and binding mechanisms.</p>
</li>
<li>
<p><em>BIND_CONNECT</em> : some ORBs support the bind operation for locating services.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We shall now describe the various methods supported by the Services class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>getService</em>: given the name of the object or service to be located (serviceName), and the type of mechanism to be used (mechanism), the programmer must also supply location mechanism specific parameters in the form of params.
If the name service is being used, then params[0] should be the String kind field.</p>
</li>
<li>
<p><em>getService</em>: the second form of this method does not require a location mechanism to be supplied, and will use an ORB specific default.
The default for each ORB is shown in Table 2.</p>
</li>
<li>
<p><em>registerService</em>: given the object to be registered, the name it should be registered with, and the mechanism to use to register it, the application programmer must specify location mechanism specific parameters in the form of params.
If the name service is being used, then params[0] should be the String kind field.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_orb_location_mechanisms"><a class="anchor" href="#_orb_location_mechanisms"></a>ORB location mechanisms</h5>
<div class="paragraph">
<p>The following table summarises the different location mechanisms that ORB Portability supports for each ORB via the Services class:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Location Mechanism</th>
<th class="tableblock halign-left valign-top">ORB</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONFIGURATION_FILE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All available ORBs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FILE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All available ORBs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIND_CONNECT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If a location mechanism isn&#8217;t specified then the default is the configuration file.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_quick_start_to_jtsots"><a class="anchor" href="#_quick_start_to_jtsots"></a>3.3. Quick Start to JTS/OTS</h3>
<div class="sect3">
<h4 id="_introduction_6"><a class="anchor" href="#_introduction_6"></a>3.3.1. Introduction</h4>
<div class="paragraph">
<p>This chapter will briefly cover the key features required to construct a basic OTS application using the raw OTS interfaces defined by the OMG specification.
It is assumed that the reader is familiar with the concepts of the JTS/OTS and has read the relevant ORB specific portions of the Narayana.
Programmer&#8217;s Guide.
Further topics and the advanced facilities provided by Narayana will be described in subsequent sections of this manual; references to chapters in the other manuals of the document set will be given in the relevant sections.</p>
</div>
</div>
<div class="sect3">
<h4 id="_package_layout"><a class="anchor" href="#_package_layout"></a>3.3.2. Package layout</h4>
<div class="paragraph">
<p>The key Java packages (and corresponding jar files) for writing basic OTS applications are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.arjuna.orbportability</code>: this package contains the classes which constitute the ORB portability library and other useful utility classes.</p>
</li>
<li>
<p><code>org.omg.CosTransactions</code>: this package contains the classes which make up the CosTransactions.idl module.</p>
</li>
<li>
<p><code>com.arjuna.ats.jts</code>: this package contains the Narayana implementations of the JTS and JTA.</p>
</li>
<li>
<p><code>com.arjuna.ats.arjuna</code>: this package contains further classes necessary for the Narayana implementation of the JTS.</p>
</li>
<li>
<p><code>com.arjuna.ats.jta</code>: this package contains local and remote JTA implementation support.</p>
</li>
<li>
<p><code>com.arjuna.ats.jdbc</code>: this package contains transactional JDBC support.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of these packages appear in the lib directory of the Narayana installation, and should be added to the programmer&#8217;s CLASSPATH.</p>
</div>
<div class="paragraph">
<p>In order to fully utilize all of the facilities available within Narayana, it will be necessary to add the some additional jar files to your classpath.
See <code>bin/setup-env.sh</code> or <code>bin\setup-env.bat</code> for details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_setting_properties_2"><a class="anchor" href="#_setting_properties_2"></a>3.3.3. Setting properties</h4>
<div class="paragraph">
<p>Narayana has been designed to be highly configurable at runtime through the use of various property attributes, which will be described in subsequent sections.
Although these attributes can be provided at runtime on the command line, it is possible (and may be more convenient) to specify them through the single properties file <code>Narayana-properties.xml</code>.
At runtime Narayana looks for its property file in the following order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a location specified by a system property, allowing the normal search path to be overridden.</p>
</li>
<li>
<p>the current working directory, i.e., where the application was executed from.</p>
</li>
<li>
<p>the user&#8217;s home directory.</p>
</li>
<li>
<p><code>java.home</code></p>
</li>
<li>
<p>the <code>CLASSPATH</code>, which normally includes the installations etc dir</p>
</li>
<li>
<p>A default set of properties embedded in the .jar file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Where properties are defined in both the system properties e.g. <code>-Dfoo=bar</code> and in the properties file, the value from the system property takes precedence.
This facilitates overriding individual properties easily on the command line.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_and_terminating_the_orb_and_boapoa"><a class="anchor" href="#_starting_and_terminating_the_orb_and_boapoa"></a>3.3.4. Starting and terminating the ORB and BOA/POA</h4>
<div class="paragraph">
<p>It is important that Narayana is correctly initialised prior to any application object being created.
In order to guarantee this, the programmer must use the <code>initORB</code> and <code>initBOA</code>/<code>initPOA</code> methods of the <code>ORBInterface</code> class described in the ORB Portability Manual.
Using the <code>ORB_init</code> and <code>BOA_init</code>/<code>create_POA</code> methods provided by the underlying ORB will not be sufficient, and may lead to incorrectly operating applications.
For example:</p>
</div>
<div class="listingblock">
<div class="title">Initialize ORB</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    ORBInterface.initORB(args, <span class="predefined-constant">null</span>);
    ORBInterface.initOA();
    <span class="comment">//        . . .</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ORBInterface</code> class has operations <code>orb()</code> and <code>boa()</code>/<code>poa()</code>/<code>rootPoa()</code> for returning references to the orb and boa/child POA/root POA respectively after initialization has been performed.
If the ORB being used does not support the BOA (e.g., Sun&#8217;s JDK 1.2) then <code>boa()</code> does not appear in the class definition, and initBOA will do nothing.</p>
</div>
<div class="paragraph">
<p>In addition, it is necessary to use shutdownOA and shutdownORB (in that order) prior to terminating an application to allow Narayana to perform necessary cleanup routines.
<code>shutdownOA</code> routine will either shutdown the BOA or the POA depending upon the ORB being used.</p>
</div>
<div class="listingblock">
<div class="title">Shutdown ORB</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    <span class="comment">// . . .</span>
    ORBInterface.shutdownOA();
    ORBInterface.shutdownORB();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>No further CORBA objects should be used once shutdown has been called.
It will be necessary to re-initialise the BOA/POA and ORB in such an event.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the rest of this document we shall use the term Object Adapter to mean either the Basic Object Adapter (BOA) or the Portable Object Adapter (POA).
In addition, where possible we shall use the ORB Portability classes which attempt to mask the differences between POA and BOA.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_specifying_the_object_store_location"><a class="anchor" href="#_specifying_the_object_store_location"></a>3.3.5. Specifying the object store location</h4>
<div class="paragraph">
<p>Narayana requires an object store in order to persistently record the outcomes of transactions in the event of failures.
In order to specify the location of the object store it is necessary to specify the location when the application is executed; for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java –DObjectStoreEnvironmentBean.objectStoreDir=/var/tmp/ObjectStore myprogram</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default location is a directory under the current execution directory.</p>
</div>
<div class="paragraph">
<p>By default, all object states will be stored within the defaultStore subdirectory of the object store root, e.g., <code>/usr/local/Arjuna/TransactionService/ObjectStore/defaultStore</code>.
However, this subdirectory can be changed by setting the <code>ObjectStoreEnvironmentBean.localOSRoot</code> property variable accordingly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implicit_transaction_propagation_and_interposition"><a class="anchor" href="#_implicit_transaction_propagation_and_interposition"></a>3.3.6. Implicit transaction propagation and interposition</h4>
<div class="paragraph">
<p>Transactions can be created within one domain (e.g., process) and used within another.
Therefore, information about a transaction (the transaction context) needs to be propagated between these domains.
This can be accomplished in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Explicit propagation</em> means that an application propagates a transaction context by passing context objects (instances of the Control interface or the PropagationContext structure) defined by the Transaction Service as explicit parameters.
Note, for efficiency reasons it is recommended that the PropagationContext be passed, rather than the Control.</p>
</li>
<li>
<p><em>Implicit propagation</em> means that requests on objects are implicitly associated with the client&#8217;s transaction; they share the client&#8217;s transaction context.
The context is transmitted implicitly to the objects, without direct client intervention.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OTS objects supporting the Control interface are standard CORBA objects.
When the interface is passed as a parameter in some operation call to a remote server only an object reference is passed.
This ensures that any operations that the remote object performs on the interface (such as registering resources as participants within the transaction) are performed on the real object.
However, this can have substantial penalties for the application if it frequently uses these interfaces due to the overheads of remote invocation.
To avoid this overhead Narayana supports interposition, whereby the server creates a local object which acts as a proxy for the remote transaction and fields all requests that would normally have been passed back to the originator.
This surrogate registers itself with the original transaction coordinator to enable it to correctly participate in the termination of the transaction.
Interposed coordinators effectively form a tree structure with their parent coordinators.
This is shown in the figure below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/interposition.gif" alt="interposition">
</div>
<div class="title">Figure 28. Interposition relationship</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>implicit transaction propagation does not imply interposition will be used at the server, but (typically) interposition requires implicit propagation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If implicit context propagation and interposition are required, then the programmer must ensure that Narayana is correctly initialised prior to objects being created; obviously it is necessary for both client and server to agree on which, if any, protocol (implicit or interposition) is being used.
Implicit context propagation is only possible on those ORBs which either support filters/interceptors, or the CosTSPortability interface.
Currently this is JacORB and the JDK miniORB.
Depending upon which type of functionality is required, the programmer must perform the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implicit context propagation: set the <code>JTSEnvironmentBean.contextPropMode</code> property variable to <code>CONTEXT</code>.</p>
</li>
<li>
<p>Interposition: set the <code>JTSEnvironmentBean.contextPropMode</code> property variable to <code>INTERPOSITION</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If using the Narayana advanced API then interposition is <em>required</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_obtaining_current"><a class="anchor" href="#_obtaining_current"></a>3.3.7. Obtaining Current</h4>
<div class="paragraph">
<p>The Current pseudo object can be obtained from the <code>com.arjuna.ats.jts.OTSManager</code> class using its <code>get_current()</code> method.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_termination"><a class="anchor" href="#_transaction_termination"></a>3.3.8. Transaction termination</h4>
<div class="paragraph">
<p>It is implementation dependant as to how long a Control remains able to access a transaction after it terminates.
In Narayana, if using the Current interface then all information about a transaction is destroyed when it terminates.
Therefore, the programmer should not use any Control references to the transaction after issuing the commit/rollback operations.</p>
</div>
<div class="paragraph">
<p>However, if the transaction is terminated explicitly using the Terminator interface then information about the transaction will be removed when all outstanding references to it are destroyed.
However, the programmer can signal that the transaction information is no longer required using the destroyControl method of the OTS class in the <code>com.arjuna.CosTransactions</code> package.
Once the program has indicated that the transaction information is no longer required, the same restrictions to using Control references apply as described above.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_factory_2"><a class="anchor" href="#_transaction_factory_2"></a>3.3.9. Transaction factory</h4>
<div class="paragraph">
<p>By default, Narayana does not use a separate transaction manager when creating transactions through the Current interface.
Each transactional client essentially has its own transaction manager (<code>TransactionFactory</code>) which is co-located with it.
By setting the <code>com.arjuna.ats.jts.transactionManager</code> property variable to YES this can be overridden at runtime.
The transaction factory is located in the bin directory of the Narayana distribution, and should be started by executing the <code>start-transaction-service</code> script located in <code>&lt;ats_root&gt;/bin</code>.</p>
</div>
<div class="paragraph">
<p>Typically Current locates the factory using the <code>CosServices.cfg</code> file.
This file is similar to <code>resolve_initial_references</code>, and is automatically updated (or created) when the transaction factory is started on a particular machine.
This file must be copied to the installation of all machines which require to share the same transaction factory.
<code>CosServices.cfg</code> is located at runtime by the <code>OrbPortabilityEnvironmentBean</code> properties <code>initialReferencesRoot</code> (a directory, defaulting to the current working directory) and <code>initialReferencesFile</code> (a name relative to the directory,<code>CosServices.cfg</code> by default).</p>
</div>
<div class="paragraph">
<p>It is possible to override the default location mechanism by using the <code>OrbPortabilityEnvironmentBean.resolveService</code> property variable.
This can have one of the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CONFIGURATION_FILE</code>: the default, this causes the system to use the <code>CosServices.cfg</code> file.</p>
</li>
<li>
<p><code>NAME_SERVICE</code>: Narayana will attempt to use a name service to locate the transaction factory.
If this is not supported, an exception will be thrown.</p>
</li>
<li>
<p><code>BIND_CONNECT</code>: Narayana will use the ORB-specific bind mechanism.
If this is not supported, an exception will be thrown.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If <code>OrbPortabilityEnvironmentBean.resolveService</code> is specified when the transaction factory is run, then the factory will register itself with the specified resolution mechanism.</p>
</div>
</div>
<div class="sect3">
<h4 id="_recovery_manager"><a class="anchor" href="#_recovery_manager"></a>3.3.10. Recovery manager</h4>
<div class="paragraph">
<p>You will need to start the recovery manager subsystem to ensure that transactions are recovered despite failures.
In order to do this, you should run the <code>start-recovery-manager</code> script in <code>&lt;ats_root&gt;/bin</code>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-10-16 15:47:44 +0200
</div>
</div>
</body>
</html>