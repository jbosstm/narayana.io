<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Quick Start to JTS/OTS</title>
<style>
@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";
@import "https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css";

h6 > .content > .title,h7,h8,h9 {
    font-family:"Open Sans","DejaVu Sans",sans-serif;
    font-weight:normal;
    font-size:.85em;
    font-style:normal;
    color:#ba8425;
    text-rendering:optimizeLegibility;
    margin-top:1em;
    margin-bottom:1em;
    line-height:2em
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Quick Start to JTS/OTS</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_package_layout">Package layout</a></li>
<li><a href="#_setting_properties">Setting properties</a></li>
<li><a href="#_starting_and_terminating_the_orb_and_boapoa">Starting and terminating the ORB and BOA/POA</a></li>
<li><a href="#_specifying_the_object_store_location">Specifying the object store location</a></li>
<li><a href="#_implicit_transaction_propagation_and_interposition">Implicit transaction propagation and interposition</a></li>
<li><a href="#_obtaining_current">Obtaining Current</a></li>
<li><a href="#_transaction_termination">Transaction termination</a></li>
<li><a href="#_transaction_factory">Transaction factory</a></li>
<li><a href="#_recovery_manager">Recovery manager</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter will briefly cover the key features required to construct a basic OTS application using the raw OTS interfaces defined by the OMG specification.
It is assumed that the reader is familiar with the concepts of the JTS/OTS and has read the relevant ORB specific portions of the Narayana.
Programmer&#8217;s Guide.
Further topics and the advanced facilities provided by Narayana will be described in subsequent sections of this manual; references to chapters in the other manuals of the document set will be given in the relevant sections.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_package_layout"><a class="anchor" href="#_package_layout"></a>Package layout</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The key Java packages (and corresponding jar files) for writing basic OTS applications are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.arjuna.orbportability</code>: this package contains the classes which constitute the ORB portability library and other useful utility classes.</p>
</li>
<li>
<p><code>org.omg.CosTransactions</code>: this package contains the classes which make up the CosTransactions.idl module.</p>
</li>
<li>
<p><code>com.arjuna.ats.jts</code>: this package contains the Narayana implementations of the JTS and JTA.</p>
</li>
<li>
<p><code>com.arjuna.ats.arjuna</code>: this package contains further classes necessary for the Narayana implementation of the JTS.</p>
</li>
<li>
<p><code>com.arjuna.ats.jta</code>: this package contains local and remote JTA implementation support.</p>
</li>
<li>
<p><code>com.arjuna.ats.jdbc</code>: this package contains transactional JDBC support.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of these packages appear in the lib directory of the Narayana installation, and should be added to the programmer&#8217;s CLASSPATH.</p>
</div>
<div class="paragraph">
<p>In order to fully utilize all of the facilities available within Narayana, it will be necessary to add the some additional jar files to your classpath.
See <code>bin/setup-env.sh</code> or <code>bin\setup-env.bat</code> for details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_properties"><a class="anchor" href="#_setting_properties"></a>Setting properties</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Narayana has been designed to be highly configurable at runtime through the use of various property attributes, which will be described in subsequent sections.
Although these attributes can be provided at runtime on the command line, it is possible (and may be more convenient) to specify them through the single properties file <code>Narayana-properties.xml</code>.
At runtime Narayana looks for its property file in the following order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a location specified by a system property, allowing the normal search path to be overridden.</p>
</li>
<li>
<p>the current working directory, i.e., where the application was executed from.</p>
</li>
<li>
<p>the user&#8217;s home directory.</p>
</li>
<li>
<p><code>java.home</code></p>
</li>
<li>
<p>the <code>CLASSPATH</code>, which normally includes the installations etc dir</p>
</li>
<li>
<p>A default set of properties embedded in the .jar file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Where properties are defined in both the system properties e.g. <code>-Dfoo=bar</code> and in the properties file, the value from the system property takes precedence.
This facilitates overriding individual properties easily on the command line.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_starting_and_terminating_the_orb_and_boapoa"><a class="anchor" href="#_starting_and_terminating_the_orb_and_boapoa"></a>Starting and terminating the ORB and BOA/POA</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is important that Narayana is correctly initialised prior to any application object being created.
In order to guarantee this, the programmer must use the <code>initORB</code> and <code>initBOA</code>/<code>initPOA</code> methods of the <code>ORBInterface</code> class described in the ORB Portability Manual.
Using the <code>ORB_init</code> and <code>BOA_init</code>/<code>create_POA</code> methods provided by the underlying ORB will not be sufficient, and may lead to incorrectly operating applications.
For example:</p>
</div>
<div class="listingblock">
<div class="title">Initialize ORB</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    ORBInterface.initORB(args, <span class="predefined-constant">null</span>);
    ORBInterface.initOA();
    <span class="comment">//        . . .</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ORBInterface</code> class has operations <code>orb()</code> and <code>boa()</code>/<code>poa()</code>/<code>rootPoa()</code> for returning references to the orb and boa/child POA/root POA respectively after initialization has been performed.
If the ORB being used does not support the BOA (e.g., Sun&#8217;s JDK 1.2) then <code>boa()</code> does not appear in the class definition, and initBOA will do nothing.</p>
</div>
<div class="paragraph">
<p>In addition, it is necessary to use shutdownOA and shutdownORB (in that order) prior to terminating an application to allow Narayana to perform necessary cleanup routines.
<code>shutdownOA</code> routine will either shutdown the BOA or the POA depending upon the ORB being used.</p>
</div>
<div class="listingblock">
<div class="title">Shutdown ORB</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    <span class="comment">// . . .</span>
    ORBInterface.shutdownOA();
    ORBInterface.shutdownORB();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>No further CORBA objects should be used once shutdown has been called.
It will be necessary to re-initialise the BOA/POA and ORB in such an event.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the rest of this document we shall use the term Object Adapter to mean either the Basic Object Adapter (BOA) or the Portable Object Adapter (POA).
In addition, where possible we shall use the ORB Portability classes which attempt to mask the differences between POA and BOA.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_specifying_the_object_store_location"><a class="anchor" href="#_specifying_the_object_store_location"></a>Specifying the object store location</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Narayana requires an object store in order to persistently record the outcomes of transactions in the event of failures.
In order to specify the location of the object store it is necessary to specify the location when the application is executed; for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java –DObjectStoreEnvironmentBean.objectStoreDir=/var/tmp/ObjectStore myprogram</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default location is a directory under the current execution directory.</p>
</div>
<div class="paragraph">
<p>By default, all object states will be stored within the defaultStore subdirectory of the object store root, e.g., <code>/usr/local/Arjuna/TransactionService/ObjectStore/defaultStore</code>.
However, this subdirectory can be changed by setting the <code>ObjectStoreEnvironmentBean.localOSRoot</code> property variable accordingly.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implicit_transaction_propagation_and_interposition"><a class="anchor" href="#_implicit_transaction_propagation_and_interposition"></a>Implicit transaction propagation and interposition</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Transactions can be created within one domain (e.g., process) and used within another.
Therefore, information about a transaction (the transaction context) needs to be propagated between these domains.
This can be accomplished in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Explicit propagation</em> means that an application propagates a transaction context by passing context objects (instances of the Control interface or the PropagationContext structure) defined by the Transaction Service as explicit parameters.
Note, for efficiency reasons it is recommended that the PropagationContext be passed, rather than the Control.</p>
</li>
<li>
<p><em>Implicit propagation</em> means that requests on objects are implicitly associated with the client&#8217;s transaction; they share the client&#8217;s transaction context.
The context is transmitted implicitly to the objects, without direct client intervention.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OTS objects supporting the Control interface are standard CORBA objects.
When the interface is passed as a parameter in some operation call to a remote server only an object reference is passed.
This ensures that any operations that the remote object performs on the interface (such as registering resources as participants within the transaction) are performed on the real object.
However, this can have substantial penalties for the application if it frequently uses these interfaces due to the overheads of remote invocation.
To avoid this overhead Narayana supports interposition, whereby the server creates a local object which acts as a proxy for the remote transaction and fields all requests that would normally have been passed back to the originator.
This surrogate registers itself with the original transaction coordinator to enable it to correctly participate in the termination of the transaction.
Interposed coordinators effectively form a tree structure with their parent coordinators.
This is shown in the figure below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/interposition.gif" alt="interposition">
</div>
<div class="title">Figure 1. Interposition relationship</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>implicit transaction propagation does not imply interposition will be used at the server, but (typically) interposition requires implicit propagation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If implicit context propagation and interposition are required, then the programmer must ensure that Narayana is correctly initialised prior to objects being created; obviously it is necessary for both client and server to agree on which, if any, protocol (implicit or interposition) is being used.
Implicit context propagation is only possible on those ORBs which either support filters/interceptors, or the CosTSPortability interface.
Currently this is JacORB and the JDK miniORB.
Depending upon which type of functionality is required, the programmer must perform the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implicit context propagation: set the <code>JTSEnvironmentBean.contextPropMode</code> property variable to <code>CONTEXT</code>.</p>
</li>
<li>
<p>Interposition: set the <code>JTSEnvironmentBean.contextPropMode</code> property variable to <code>INTERPOSITION</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If using the Narayana advanced API then interposition is <em>required</em>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_obtaining_current"><a class="anchor" href="#_obtaining_current"></a>Obtaining Current</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Current pseudo object can be obtained from the <code>com.arjuna.ats.jts.OTSManager</code> class using its <code>get_current()</code> method.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transaction_termination"><a class="anchor" href="#_transaction_termination"></a>Transaction termination</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is implementation dependant as to how long a Control remains able to access a transaction after it terminates.
In Narayana, if using the Current interface then all information about a transaction is destroyed when it terminates.
Therefore, the programmer should not use any Control references to the transaction after issuing the commit/rollback operations.</p>
</div>
<div class="paragraph">
<p>However, if the transaction is terminated explicitly using the Terminator interface then information about the transaction will be removed when all outstanding references to it are destroyed.
However, the programmer can signal that the transaction information is no longer required using the destroyControl method of the OTS class in the <code>com.arjuna.CosTransactions</code> package.
Once the program has indicated that the transaction information is no longer required, the same restrictions to using Control references apply as described above.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transaction_factory"><a class="anchor" href="#_transaction_factory"></a>Transaction factory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, Narayana does not use a separate transaction manager when creating transactions through the Current interface.
Each transactional client essentially has its own transaction manager (<code>TransactionFactory</code>) which is co-located with it.
By setting the <code>com.arjuna.ats.jts.transactionManager</code> property variable to YES this can be overridden at runtime.
The transaction factory is located in the bin directory of the Narayana distribution, and should be started by executing the <code>start-transaction-service</code> script located in <code>&lt;ats_root&gt;/bin</code>.</p>
</div>
<div class="paragraph">
<p>Typically Current locates the factory using the <code>CosServices.cfg</code> file.
This file is similar to <code>resolve_initial_references</code>, and is automatically updated (or created) when the transaction factory is started on a particular machine.
This file must be copied to the installation of all machines which require to share the same transaction factory.
<code>CosServices.cfg</code> is located at runtime by the <code>OrbPortabilityEnvironmentBean</code> properties <code>initialReferencesRoot</code> (a directory, defaulting to the current working directory) and <code>initialReferencesFile</code> (a name relative to the directory,<code>CosServices.cfg</code> by default).</p>
</div>
<div class="paragraph">
<p>It is possible to override the default location mechanism by using the <code>OrbPortabilityEnvironmentBean.resolveService</code> property variable.
This can have one of the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CONFIGURATION_FILE</code>: the default, this causes the system to use the <code>CosServices.cfg</code> file.</p>
</li>
<li>
<p><code>NAME_SERVICE</code>: Narayana will attempt to use a name service to locate the transaction factory.
If this is not supported, an exception will be thrown.</p>
</li>
<li>
<p><code>BIND_CONNECT</code>: Narayana will use the ORB-specific bind mechanism.
If this is not supported, an exception will be thrown.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If <code>OrbPortabilityEnvironmentBean.resolveService</code> is specified when the transaction factory is run, then the factory will register itself with the specified resolution mechanism.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recovery_manager"><a class="anchor" href="#_recovery_manager"></a>Recovery manager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You will need to start the recovery manager subsystem to ensure that transactions are recovered despite failures.
In order to do this, you should run the <code>start-recovery-manager</code> script in <code>&lt;ats_root&gt;/bin</code>.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-10-16 15:47:44 +0200
</div>
</div>
</body>
</html>