<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Example</title>
<style>
@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";
@import "https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css";

h6 > .content > .title,h7,h8,h9 {
    font-family:"Open Sans","DejaVu Sans",sans-serif;
    font-weight:normal;
    font-size:.85em;
    font-style:normal;
    color:#ba8425;
    text-rendering:optimizeLegibility;
    margin-top:1em;
    margin-bottom:1em;
    line-height:2em
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Example</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_the_basic_example">The basic example</a>
<ul class="sectlevel2">
<li><a href="#_example_implementation_of_the_interface">Example implementation of the interface</a></li>
</ul>
</li>
<li><a href="#_default_settings">Default settings</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This example illustrates the concepts and the implementation details for a simple client/server example using implicit context propagation and indirect context management.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_basic_example"><a class="anchor" href="#_the_basic_example"></a>The basic example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This example only includes a single unit of work within the scope of the transaction.
Consequently, only a one-phase commit is needed.</p>
</div>
<div class="paragraph">
<p>The client and server processes are both invoked using the <code>implicit propagation</code> and <code>interposition</code> command-line options.</p>
</div>
<div class="paragraph">
<p>For the purposes of this worked example, a single method implements the <code>DemoInterface</code> interface.
This method is used in the DemoClient program.</p>
</div>
<div class="listingblock">
<div class="title">idl interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="error">#</span>include &lt;idl/CosTransactions.idl&gt;
<span class="error">#</span>pragma javaPackage <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>

module Demo {
    exception DemoException {};

    <span class="type">interface</span> <span class="class">DemoInterface</span> : CosTransactions::TransactionalObject {
        <span class="type">void</span> work() raises (DemoException);
    }
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_example_implementation_of_the_interface"><a class="anchor" href="#_example_implementation_of_the_interface"></a>Example implementation of the interface</h3>
<div class="paragraph">
<p>This section deals with the pieces needed to implement the example interface.</p>
</div>
<div class="sect3">
<h4 id="_resource"><a class="anchor" href="#_resource"></a>Resource</h4>
<div class="paragraph">
<p>The example overrides the methods of the <code>Resource</code> implementation class.
The <code>DemoResource</code> implementation includes the placement of <code>System.out.println</code> statements at judicious points, to highlight when a particular method is invoked.</p>
</div>
<div class="paragraph">
<p>Only a single unit of work is included within the scope of the transaction.
Therefore, the <code>prepare</code> or <code>commit</code> methods should never be invoked, but the <code>commit_one_phase</code> method should be invoked.</p>
</div>
<div class="listingblock">
<div class="title">DemoResource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.omg.CosTransactions</span>.*;
<span class="keyword">import</span> <span class="include">org.omg.CORBA.SystemException</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoResource</span> <span class="directive">extends</span> org.omg.CosTransactions.ResourcePOA {
    <span class="directive">public</span> Vote prepare() <span class="directive">throws</span> HeuristicMixed, HeuristicHazard, SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">prepare called</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> Vote.VoteCommit;
    }

    <span class="directive">public</span> <span class="type">void</span> rollback() <span class="directive">throws</span> HeuristicCommit, HeuristicMixed, HeuristicHazard, SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">rollback called</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> commit() <span class="directive">throws</span> NotPrepared, HeuristicRollback, HeuristicMixed, HeuristicHazard, SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">commit called</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> commit_one_phase() <span class="directive">throws</span> HeuristicHazard, SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">commit_one_phase called</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> forget() <span class="directive">throws</span> SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">forget called</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_transactional_implementation"><a class="anchor" href="#_transactional_implementation"></a>Transactional implementation</h4>
<div class="paragraph">
<p>At this stage, the <em>Demo.idl</em> has been processed by the ORB&#8217;s idl compiler to generate the necessary client and server package.</p>
</div>
<div class="paragraph">
<p>Line 14 returns the transactional context for the <code>Current</code> pseudo object.
After obtaining a <code>Control</code> object, you can derive the Coordinator object (line 16).</p>
</div>
<div class="paragraph">
<p>Lines 17 and 19 create a resource for the transaction, and then inform the ORB that the resource is ready to receive incoming method invocations.</p>
</div>
<div class="paragraph">
<p>Line 20 uses the <code>Coordinator</code> to register a <code>DemoResource</code> object as a participant in the transaction.
When the transaction terminates, the resource receives requests to commit or rollback the updates performed as part of the transaction.</p>
</div>
<div class="listingblock">
<div class="title">Transactional implementation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">Demo</span>.*;
<span class="keyword">import</span> <span class="include">org.omg.CosTransactions</span>.*;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts</span>.*;
<span class="keyword">import</span> <span class="include">com.arjuna.orbportability</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoImplementation</span> <span class="directive">extends</span> Demo.DemoInterfacePOA {
    <span class="directive">public</span> <span class="type">void</span> work() <span class="directive">throws</span> DemoException {
        <span class="keyword">try</span> {

            <span class="predefined-type">Control</span> control = OTSManager.get_current().get_control();

            Coordinator coordinator = control.get_coordinator();
            DemoResource resource = <span class="keyword">new</span> DemoResource();

            ORBManager.getPOA().objectIsReady(resource);
            coordinator.register_resource(resource);

        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="keyword">throw</span> <span class="keyword">new</span> DemoException();
        }
    }
}          </code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_server_implementation"><a class="anchor" href="#_server_implementation"></a>Server implementation</h4>
<div class="paragraph">
<p>First, you need to to initialize the ORB and the POA.
Lines 10 through 14 accomplish these tasks.</p>
</div>
<div class="paragraph">
<p>The servant class <code>DemoImplementation</code> contains the implementation code for the <code>DemoInterface</code> interface.
The servant services a particular client request.
Line 16 instantiates a servant object for the subsequent servicing of client requests.</p>
</div>
<div class="paragraph">
<p>Once a servant is instantiated, connect the servant to the POA, so that it can recognize the invocations on it, and pass the invocations to the correct servant.
Line 18 performs this task.</p>
</div>
<div class="paragraph">
<p>Lines 20 through to 21 registers the service through the default naming mechanism.
More information about the options available can be found in the ORB Portability Guide.</p>
</div>
<div class="paragraph">
<p>If this registration is successful, line 23 outputs a <code>sanity check</code> message.</p>
</div>
<div class="paragraph">
<p>Finally, line 25 places the server process into a state where it can begin to accept requests from client processes.</p>
</div>
<div class="listingblock">
<div class="title">DemoServer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.io</span>.*;

<span class="keyword">import</span> <span class="include">com.arjuna.orbportability</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoServer</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        <span class="keyword">try</span> {
            ORB myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>).initORB(args, <span class="predefined-constant">null</span>);
            RootOA myOA = OA.getRootOA(myORB).myORB.initOA();

            ORBManager.setORB(myORB);
            ORBManager.setPOA(myOA);

            DemoImplementation obj = <span class="keyword">new</span> DemoImplementation();

            myOA.objectIsReady(obj);

            Services serv = <span class="keyword">new</span> Services(myORB);
            serv.registerService(myOA.corbaReference(obj), <span class="string"><span class="delimiter">&quot;</span><span class="content">DemoObjReference</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>);

            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Object published.</span><span class="delimiter">&quot;</span></span>);

            myOA.run();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(e);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After the server compiles, you can use the command line options defined below to start a server process.
By specifying the usage of a filter on the command line, you can override settings in the <em>TransactionService.properties</em> file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>if you specify the interposition filter, you also imply usage of implicit context propagation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_client_implementation"><a class="anchor" href="#_client_implementation"></a>Client implementation</h4>
<div class="paragraph">
<p>The client, like the server, requires you to first initialize the ORB and the POA.
Lines 14 through 18 accomplish these tasks.</p>
</div>
<div class="paragraph">
<p>After a server process is started, you can obtain the object reference through the default publication mechanism used to publish it in the server.
This is done in lines 20 and 21.
Initially the reference is an instance of <code>Object</code>.
However, to invoke a method on the servant object, you need to narrow this instance to an instance of the <code>DemoInterface</code> interface.
This is shown in line 21.</p>
</div>
<div class="paragraph">
<p>Once we have a reference to this servant object, we can start a transaction (line 23), perform a unit of work (line 25) and commit the transaction (line 27).</p>
</div>
<div class="listingblock">
<div class="title">DemoClient</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">Demo</span>.*;

<span class="keyword">import</span> <span class="include">java.io</span>.*;

<span class="keyword">import</span> <span class="include">com.arjuna.orbportability</span>.*;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts</span>.*;
<span class="keyword">import</span> <span class="include">org.omg.CosTransactions</span>.*;
<span class="keyword">import</span> <span class="include">org.omg</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoClient</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        <span class="keyword">try</span> {
            ORB myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>).initORB(args, <span class="predefined-constant">null</span>);
            RootOA myOA = OA.getRootOA(myORB).myORB.initOA();

            ORBManager.setORB(myORB);
            ORBManager.setPOA(myOA);

            Services serv = <span class="keyword">new</span> Services(myORB);
            DemoInterface d = (DemoInterface) DemoInterfaceHelper.narrow(serv.getService(<span class="string"><span class="delimiter">&quot;</span><span class="content">DemoObjReference</span><span class="delimiter">&quot;</span></span>));

            OTS.get_current().begin();

            d.work();

            OTS.get_current().commit(<span class="predefined-constant">true</span>);
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(e);
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sequence_diagram"><a class="anchor" href="#_sequence_diagram"></a>Sequence diagram</h4>
<div class="paragraph">
<p>The sequence diagram illustrates the method invocations that occur between the client and server.
The following aspects are important:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You do not need to pass the transactional context as a parameter in method <code>work</code>, since you are using implicit context propagation.</p>
</li>
<li>
<p>Specifying the use of interposition when the client and server processes are started, by using appropriate filters and interceptors, creates an interposed coordinator that the servant process can use, negating any requirement for cross-process invocations.
The interposed coordinator is automatically registered with the root coordinator at the client.</p>
</li>
<li>
<p>The resource that commits or rolls back modifications made to the transactional object is associated, or registered, with the interposed coordinator.</p>
</li>
<li>
<p>The <code>commit</code> invocation in the client process calls the root coordinator.
The root coordinator calls the interposed coordinator, which in turn calls the <code>commit_one_phase</code> method for the resource.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-sequence-diagram.png" alt="jts sequence diagram">
</div>
<div class="title">Figure 1. Sequence Diagram</div>
</div>
</div>
<div class="sect3">
<h4 id="_interpretation_of_output"><a class="anchor" href="#_interpretation_of_output"></a>Interpretation of output</h4>
<div class="paragraph">
<p>The server process first stringifies the servant instance, and writes the servant IOR to a temporary file.
The first line of output is the sanity check that the operation was successful.</p>
</div>
<div class="paragraph">
<p>In this simplified example, the coordinator object has only a single registered resource.
Consequently, it performs a <code>commit_one_phase</code> operation on the resource object, instead of performing a <code>prepare</code> operation, followed by a <code>commit</code> or <code>rollback</code>.</p>
</div>
<div class="paragraph">
<p>The output is identical, regardless of whether implicit context propagation or interposition is used, since interposition is essentially performance aid.
Ordinarily, you may need to do a lot of marshaling between a client and server process.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Server output</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>Object reference written to file
commit_one_phase called</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_default_settings"><a class="anchor" href="#_default_settings"></a>Default settings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>These settings are defaults, and you can override them at run-time by using property variables, or in the properties file in the <code>etc/</code> directory of the installation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Unless a CORBA object is derived from <code>CosTransactions::TransactionalObject</code>,you do not need to propagate any context.
In order to preserve distribution transparency, Narayana defaults to always propagating a transaction context when calling remote objects, regardless of whether they are marked as transactional objects.
You can override this by setting the <code>com.arjuna.ats.jts.alwaysPropagateContext</code> property variable to <code>NO</code>.</p>
</li>
<li>
<p>If an object is derived from <code>CosTransactions::TransactionalObject</code>, and no client context is present when an invocation is made, Narayana transmits a null context.
Subsequent transactions begun by the object are top-level.
If a context is required, then set the <code>com.arjuna.ats.jts.needTranContext</code> property variable to <code>YES</code>, in which case Narayana raises the <em>TransactionRequired</em> exception.</p>
</li>
<li>
<p>Narayana needs a persistent object store, so that it can record information about transactions in the event of failures.
If all transactions complete successfully, this object store has no entries.
The default location for this must be set using the <code>ObjectStoreEnvironmentBean.objectStoreDir</code> variable in the properties file.</p>
</li>
<li>
<p>If you use a separate transaction manager for <code>Current</code>, its location is obtained from the <em>CosServices.cfg</em> file.
<em>CosServices.cfg</em> is located at runtime by the <code>OrbPortabilityEnvironmentBean</code> properties <code>initialReferencesRoot</code> and <code>initialReferencesFile</code>.
The former is a directory, defaulting to the current working directory.
The latter is a file name, relative to the directory.
The default value is <code>CosServices.cfg</code> .</p>
</li>
<li>
<p>Checked transactions are not enabled by default.
This means that threads other than the transaction creator may terminate the transaction, and no check is made to ensure all outstanding requests have finished prior to transaction termination.
To override this, set the <code>JTSEnvironmentBean.checkedTransactions</code> property variable to <code>YES</code>.</p>
</li>
<li>
<p></p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As of Narayana 4.5, transaction timeouts are unified across all transaction components and are controlled by ArjunaCore.
The old JTS configuration property com.arjuna.ats.jts.defaultTimeout still remains but is deprecated.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>if a value of <code>0</code> is specified for the timeout of a top-level transaction, or no timeout is specified, Narayana does not impose any timeout on the transaction.
To override this default timeout, set the <code>CoordinatorEnvironmentBean.defaultTimeout</code> property variable to the required timeout value in seconds.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-10-16 15:47:44 +0200
</div>
</div>
</body>
</html>