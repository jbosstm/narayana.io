<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Hints and tips</title>
<style>
@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";
@import "https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css";

h6 > .content > .title,h7,h8,h9 {
    font-family:"Open Sans","DejaVu Sans",sans-serif;
    font-weight:normal;
    font-size:.85em;
    font-style:normal;
    color:#ba8425;
    text-rendering:optimizeLegibility;
    margin-top:1em;
    margin-bottom:1em;
    line-height:2em
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Hints and tips</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_general">General</a>
<ul class="sectlevel2">
<li><a href="#_using_transactions_in_constructors">Using transactions in constructors</a></li>
<li><a href="#_save_state_and_restore_state_methods"><code>save_state</code> and <code>restore_state</code> methods</a></li>
<li><a href="#_direct_use_of_statemanager">Direct use of StateManager</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_general"><a class="anchor" href="#_general"></a>General</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_using_transactions_in_constructors"><a class="anchor" href="#_using_transactions_in_constructors"></a>Using transactions in constructors</h3>
<div class="paragraph">
<p>Examples throughout this manual use transactions in the implementation of constructors for new persistent objects.
This is deliberate because it guarantees correct propagation of the state of the object to the object store.
The state of a modified persistent object is only written to the object store when the top-level transaction commits.
Thus, if the constructor transaction is top-level and it commits, the newly-created object is written to the store and becomes available immediately.
If, however, the constructor transaction commits but is nested because another transaction that was started prior to object creation is running, the state is written only if all of the parent transactions commit.</p>
</div>
<div class="paragraph">
<p>On the other hand, if the constructor does not use transactions, inconsistencies in the system can arise.
For example, if no transaction is active when the object is created, its state is not saved to the store until the next time the object is modified under the control of some transaction.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Nested Transactions In Constructors</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AtomicAction A = <span class="keyword">new</span> AtomicAction();
<span class="predefined-type">Object</span> obj1;
<span class="predefined-type">Object</span> obj2;

<span class="comment">// create new object</span>
obj1 = <span class="keyword">new</span> <span class="predefined-type">Object</span>();
<span class="comment">// existing object</span>
obj2 = <span class="keyword">new</span> <span class="predefined-type">Object</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">old</span><span class="delimiter">&quot;</span></span>);

A.begin(<span class="integer">0</span>);
<span class="comment">// obj2 now contains reference to obj1</span>
obj2.remember(obj1.get_uid());
<span class="comment">// obj2 saved but obj1 is not</span>
A.commit(<span class="predefined-constant">true</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The two objects are created outside of the control of the top-level action <em>A</em> .
<em>obj1</em> is a new object.
<em>obj2</em> is an old existing object.
When the <code>remember</code> operation of <em>obj2</em> is invoked, the object will be activated and the <code>Uid</code> of <em>obj1</em> remembered.
Since this action commits, the persistent state of <em>obj2</em> may now contain the <code>Uid</code> of <em>obj1</em>.
However, the state of <em>obj1</em> itself has not been saved since it has not been manipulated under the control of any action.
In fact, unless it is modified under the control of an action later in the application, it will never be saved.
If, however, the constructor had used an atomic action, the state of <em>obj1</em> would have automatically been saved at the time it was constructed and this inconsistency could not arise.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_save_state_and_restore_state_methods"><a class="anchor" href="#_save_state_and_restore_state_methods"></a><code>save_state</code> and <code>restore_state</code> methods</h3>
<div class="paragraph">
<p>ArjunaCore may invoke the user-defined <code>save_state</code> operation of an object at any time during the lifetime of an object, including during the execution of the body of the object’s constructor.
This is particularly a possibility if it uses atomic actions.
It is important, therefore, that all of the variables saved by <code>save_state</code> are correctly initialized.
Exercise caution when writing the <code>save_state</code> and <code>restore_state</code> operations, to ensure that no transactions are started, either explicitly in the operation, or implicitly through use of some other operation.
The reason for this restriction is that ArjunaCore may invoke <code>restore_state</code> as part of its commit processing.
This would result in the attempt to execute an atomic transaction during the commit or abort phase of another transaction.
This might violate the atomicity properties of the transaction being committed or aborted, and is thus discouraged.
In order to support crash recovery for persistent objects, all <code>save_state</code> and <code>restore_state</code> methods of user objects must call <code>super.save_state</code> and <code>super.restore_state</code>.</p>
</div>
<div class="sect3">
<h4 id="_packing_objects"><a class="anchor" href="#_packing_objects"></a>Packing objects</h4>
<div class="paragraph">
<p>All of the basic types of Java (<code>int</code>, <code>long</code>, etc.) can be saved and restored from an <code>InputObjectState</code> or <code>OutputObjectState</code> instance by using the pack and unpack routines provided by <code>InputObjectState</code> and <code>OutputObjectState</code>.
However, packing and unpacking objects should be handled differently.
This is because packing objects brings in the additional problems of aliasing.
Aliasing happens when two different object references may point at the same item.
For example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Aliasing</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> Test(<span class="predefined-type">String</span> s) {
    s1 = s;
    s2 = s;
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">Test</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> s1;
    ...
    private <span class="predefined-type">String</span> s2;
    <span class="directive">public</span> Test(<span class="predefined-type">String</span> s);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, both <code>s1</code> and <code>s2</code> point at the same string.
A naive implementation of <code>save_state</code> might copy the string twice.
From a <code>save_state</code> perspective this is simply inefficient.
However, <code>restore_state</code> would unpack the two strings into different areas of memory, destroying the original aliasing information.
The current version of ArjunaCore packs and unpacks separate object references.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_direct_use_of_statemanager"><a class="anchor" href="#_direct_use_of_statemanager"></a>Direct use of StateManager</h3>
<div class="paragraph">
<p>The examples throughout this manual derive user classes from <code>LockManager</code>. These are two important reasons for this.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Firstly, and most importantly, the serializability constraints of atomic actions require it.</p>
</li>
<li>
<p>It reduces the need for programmer intervention.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>However, if you only require access to ArjunaCore&#8217;s persistence and recovery mechanisms, direct derivation of a user class from <code>StateManager</code> is possible.</p>
</div>
<div class="paragraph">
<p>Classes derived directly from <code>StateManager</code> must make use of its state management mechanisms explicitly.
These interactions are normally undertaken by <code>LockManager</code>.
From a programmer&#8217;s point of view this amounts to making appropriate use of the operations <code>activate</code>, <code>deactivate</code>, and <code>modified</code>, since <code>StateManager</code> 's constructors are effectively identical to those of <code>LockManager</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. <code>activate</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">boolean</span> activate()

<span class="type">boolean</span> activate(<span class="predefined-type">String</span> storeRoot)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Activate loads an object from the object store.
The object’s UID must already have been set via the constructor and the object must exist in the store.
If the object is successfully read then restore_state is called to build the object in memory.
Activate is idempotent so that once an object has been activated further calls are ignored.
The parameter represents the root name of the object store to search for the object.
A value of null means use the default store.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 4. <code>deactivate</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">boolean</span> deactivate()

<span class="type">boolean</span> deactivate(<span class="predefined-type">String</span> storeRoot)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The inverse of activate.
First calls save_state to build the compacted image of the object which is then saved in the object store.
Objects are only saved if they have been modified since they were activated.
The parameter represents the root name of the object store into which the object should be saved.
A value of null means use the default store.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 5. <code>modified</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">void</span> modified()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Must be called prior to modifying the object in memory.
If it is not called, the object will not be saved in the object store by <code>deactivate</code>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-09-27 14:38:03 +0100
</div>
</div>
</body>
</html>