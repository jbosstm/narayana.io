<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Narayana Project Documentation</title>
<style>
@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";
@import "https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css";

h6 > .content > .title,h7,h8,h9 {
    font-family:"Open Sans","DejaVu Sans",sans-serif;
    font-weight:normal;
    font-size:.85em;
    font-style:normal;
    color:#ba8425;
    text-rendering:optimizeLegibility;
    margin-top:1em;
    margin-bottom:1em;
    line-height:2em
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Narayana Project Documentation</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_document_conventions">Document Conventions</a></li>
<li><a href="#_we_need_feedback">We Need Feedback!</a></li>
</ul>
</li>
<li><a href="#_general_procedures">1. General Procedures</a>
<ul class="sectlevel2">
<li><a href="#_administration">1.1. Administration</a></li>
<li><a href="#_installation">1.2. Installation</a></li>
<li><a href="#_upgrade">1.3. Upgrade</a></li>
</ul>
</li>
<li><a href="#_narayana_core">2. Narayana Core</a>
<ul class="sectlevel2">
<li><a href="#_overview">2.1. Overview</a></li>
<li><a href="#_using_arjunacore">2.2. Using ArjunaCore</a></li>
<li><a href="#_advanced_transaction_issues_with_arjunacore">2.3. Advanced transaction issues with ArjunaCore</a></li>
<li><a href="#_hints_and_tips">2.4. Hints and tips</a></li>
<li><a href="#_constructing_a_transactional_objects_for_java_application">2.5. Constructing a Transactional Objects for Java application</a></li>
<li><a href="#_failure_recovery">2.6. Failure Recovery</a></li>
</ul>
</li>
<li><a href="#_jta">3. JTA</a>
<ul class="sectlevel2">
<li><a href="#_administration_2">3.1. Administration</a></li>
<li><a href="#_development">3.2. Development</a></li>
<li><a href="#_installation_2">3.3. Installation</a></li>
</ul>
</li>
<li><a href="#_jts">4. JTS</a>
<ul class="sectlevel2">
<li><a href="#_administration_3">4.1. Administration</a></li>
<li><a href="#_development_2">4.2. Development</a></li>
<li><a href="#_orb_portability_2">4.3. ORB Portability</a></li>
</ul>
</li>
<li><a href="#_xts">5. XTS</a>
<ul class="sectlevel2">
<li><a href="#_introduction_10">5.1. Introduction</a></li>
<li><a href="#_transactions_overview">5.2. Transactions Overview</a></li>
<li><a href="#_overview_of_protocols_used_by_xts">5.3. Overview of Protocols Used by XTS</a></li>
</ul>
</li>
<li><a href="#_long_running_actions_lra">6. Long Running Actions (LRA)</a>
<ul class="sectlevel2">
<li><a href="#_overview_2">6.1. Overview</a></li>
<li><a href="#_jax_rs_services">6.2. JAX-RS services</a></li>
<li><a href="#_non_jax_rs_services">6.3. Non JAX-RS services</a></li>
<li><a href="#lra_examples">6.4. Examples</a></li>
<li><a href="#lra_integration">6.5. Runtime Integration</a></li>
</ul>
</li>
<li><a href="#_rts">7. RTS</a>
<ul class="sectlevel2">
<li><a href="#_overview_3">7.1. Overview</a></li>
<li><a href="#_transaction_model">7.2. Transaction Model</a></li>
<li><a href="#client_responsibilities">7.3. Client Responsibilities</a></li>
<li><a href="#_service_responsibilities">7.4. Service Responsibilities</a></li>
<li><a href="#_container_integration">7.5. Container Integration</a></li>
<li><a href="#_examples_5">7.6. Examples</a></li>
<li><a href="#_interoperating_with_other_transaction_models">7.7. Interoperating With Other Transaction Models</a></li>
</ul>
</li>
<li><a href="#_stm">8. STM</a>
<ul class="sectlevel2">
<li><a href="#_an_stm_example">8.1. An STM Example</a></li>
<li><a href="#_annotations">8.2. Annotations</a></li>
<li><a href="#_containers_volatility_and_durability">8.3. Containers, Volatility and Durability</a></li>
<li><a href="#_sharing_stm_objects">8.4. Sharing STM Objects</a></li>
<li><a href="#_state_management_2">8.5. State Management</a></li>
<li><a href="#_optimistic_concurrency_control">8.6. Optimistic Concurrency Control</a></li>
<li><a href="#_a_typical_use_case">8.7. A Typical Use Case</a></li>
</ul>
</li>
<li><a href="#_compensating_transactions">9. Compensating transactions</a>
<ul class="sectlevel2">
<li><a href="#_overview_4">9.1. Overview</a></li>
<li><a href="#_compensations_framework">9.2. Compensations Framework</a></li>
<li><a href="#_resources">9.3. Resources</a></li>
<li><a href="#_notes">9.4. Notes</a></li>
</ul>
</li>
<li><a href="#_osgi">10. OSGi</a>
<ul class="sectlevel2">
<li><a href="#chap_integrate_with_karaf">10.1. Integrate with Karaf</a></li>
</ul>
</li>
<li><a href="#_appendixes">11. Appendixes</a>
<ul class="sectlevel2">
<li><a href="#_object_store_implementations">Appendix A: Object store implementations</a></li>
<li><a href="#_core_class_definitions">Appendix B: Core Class Definitions</a></li>
<li><a href="#_idl_definitions">Appendix C: IDL definitions</a></li>
<li><a href="#_transaction_statuses">Appendix D: REST-AT Transaction Statuses</a></li>
<li><a href="#_qa_testsuite">Appendix E: QA Testsuite</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Copyright &#169; The Narayana Authors</p>
</div>
<div class="paragraph">
<p>SPDX short identifier: <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache-2.0</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Narayana Project Documentation contains information on how to use Narayana to develop applications that use transaction technology to manage business processes.</p>
</div>
<div class="sect2">
<h3 id="_document_conventions"><a class="anchor" href="#_document_conventions"></a>Document Conventions</h3>
<div class="paragraph">
<p>This manual uses several conventions to highlight certain words and phrases and draw attention to specific pieces of information.</p>
</div>
<div class="paragraph">
<p>In PDF and paper editions, this manual uses typefaces drawn from the <a href="https://fedorahosted.org/liberation-fonts/">Liberation Fonts</a> set.
The Liberation Fonts set is also used in HTML editions if the set is installed on your system.
If not, alternative but equivalent typefaces are displayed.
Note: Red Hat Enterprise Linux 5 and later includes the Liberation Fonts set by default.</p>
</div>
<div class="sect3">
<h4 id="_typographic_conventions"><a class="anchor" href="#_typographic_conventions"></a>Typographic Conventions</h4>
<div class="paragraph">
<p>Four typographic conventions are used to call attention to specific words and phrases.
These conventions, and the circumstances they apply to, are as follows.</p>
</div>
<div class="paragraph">
<p><code>Mono-spaced Bold</code></p>
</div>
<div class="paragraph">
<p>Used to highlight system input, including shell commands, file names and paths.
Also used to highlight keycaps and key combinations.
For example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>To see the contents of the file <em>my_next_bestselling_novel</em> in your current working directory, enter the <code>cat my_next_bestselling_novel</code> command at the shell prompt and press <code>Enter</code> to execute the command.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The above includes a file name, a shell command and a keycap, all presented in mono-spaced bold and all distinguishable thanks to context.</p>
</div>
<div class="paragraph">
<p>Key combinations can be distinguished from keycaps by the hyphen connecting each part of a key combination.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Press `Enter` to execute the command.

Press
// &lt;keycombo&gt;
//   &lt;keycap&gt;Ctrl&lt;/keycap&gt;
//   &lt;keycap&gt;Alt&lt;/keycap&gt;
//   &lt;keycap&gt;F2&lt;/keycap&gt;
// &lt;/keycombo&gt;
 to switch to the first virtual terminal.
Press
// &lt;keycombo&gt;
//   &lt;keycap&gt;Ctrl&lt;/keycap&gt;
//   &lt;keycap&gt;Alt&lt;/keycap&gt;
//   &lt;keycap&gt;F1&lt;/keycap&gt;
// &lt;/keycombo&gt;
 to return to your X-Windows session.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first paragraph highlights the particular keycap to press.
The second highlights two key combinations (each a set of three keycaps with each set pressed simultaneously).</p>
</div>
<div class="paragraph">
<p>If source code is discussed, class names, methods, functions, variable names and returned values mentioned within a paragraph will be presented as above, in <code>mono-spaced bold</code>.
For example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>File-related classes include <code>filesystem</code> for file systems, <code>file</code> for files, and <code>dir</code> for directories.
Each class has its own associated set of permissions.</p>
</div>
</div>
</div>
<div class="paragraph">
<p><code>Proportional Bold</code></p>
</div>
<div class="paragraph">
<p>This denotes words or phrases encountered on a system, including application names; dialog box text; labeled buttons; check-box and radio button labels; menu titles and sub-menu titles.
For example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Choose <code>Preferences &gt; Mouse</code> from the main menu bar to launch <code>Mouse Preferences</code>.
In the <code>Buttons tab</code>, click the <code>Left-handed mouse</code> check box and click <code>Close</code> to switch the primary mouse button from the left to the right (making the mouse suitable for use in the left hand).</p>
</div>
<div class="paragraph">
<p>To insert a special character into a <code>gedit</code> file, choose <code>Accessories &gt; Character Map</code> from the main menu bar.
Next, choose <code>Find</code> from the <code>Character Map</code> menu bar, type the name of the character in the <code>Search</code> field and click <code>Next</code>.
The character you sought will be highlighted in the <code>Character Table</code>.
Double-click this highlighted character to place it in the <code>Text to copy</code> field and then click the <code>Copy</code> button.
Now switch back to your document and choose <code>Paste</code> from the <code>gedit</code> menu bar.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The above text includes application names; system-wide menu names and items; application-specific menu names; and buttons and text found within a GUI interface, all presented in proportional bold and all distinguishable by context.</p>
</div>
<div class="paragraph">
<p><code>Mono-spaced Bold Italic</code> or <code>Proportional Bold Italic</code></p>
</div>
<div class="paragraph">
<p>Whether mono-spaced bold or proportional bold, the addition of italics indicates replaceable or variable text.
Italics denotes text you do not input literally or displayed text that changes depending on circumstance.
For example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>To connect to a remote machine using ssh, type <code>ssh <a href="mailto:username@domain.name">username@domain.name</a></code> at a shell prompt.
If the remote machine is <em>example.com</em> and your username on that machine is john, type <code>ssh <a href="mailto:john@example.com">john@example.com</a></code>.</p>
</div>
<div class="paragraph">
<p>The <code>mount -o remount file-system</code> command remounts the named file system.
For example, to remount the <code>/home file system</code>, the command is <code>mount -o remount /home</code>.</p>
</div>
<div class="paragraph">
<p>To see the version of a currently installed package, use the <code>rpm -q package</code> command.
It will return a result as follows: <code>package-version-release</code>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Note the words in bold italics above -username, domain.name, file-system, package, version and release.
Each word is a placeholder, either for text you enter when issuing a command or for text displayed by the system.</p>
</div>
<div class="paragraph">
<p>Aside from standard usage for presenting the title of a work, italics denotes the first use of a new and important term.
For example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>This documentation uses <em>Asciidoc</em>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pull_quote_conventions"><a class="anchor" href="#_pull_quote_conventions"></a>Pull-quote Conventions</h4>
<div class="paragraph">
<p>Terminal output and source code listings are set off visually from the surrounding text.</p>
</div>
<div class="paragraph">
<p>Output sent to a terminal is set in <code>mono-spaced roman</code> and presented thus:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>books        Desktop   documentation  drafts  mss    photos   stuff  svn
books_tests  Desktop1  downloads      images  notes  scripts  svgs</pre>
</div>
</div>
<div class="paragraph">
<p>Source-code listings are also set in <code>mono-spaced roman</code> but add syntax highlighting as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.jboss.book.jca.ex1</span>;

<span class="keyword">import</span> <span class="include">javax.naming.InitialContext</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">ExClient</span> {
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span> args<span class="type">[]</span>) <span class="directive">throws</span> <span class="exception">Exception</span> {
       <span class="predefined-type">InitialContext</span> iniCtx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>();
       <span class="predefined-type">Object</span>         ref    = iniCtx.lookup(<span class="string"><span class="delimiter">&quot;</span><span class="content">EchoBean</span><span class="delimiter">&quot;</span></span>);
       EchoHome       home   = (EchoHome) ref;
       Echo           echo   = home.create();

       <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Created Echo</span><span class="delimiter">&quot;</span></span>);

       <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Echo.echo('Hello') = </span><span class="delimiter">&quot;</span></span> + echo.echo(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello</span><span class="delimiter">&quot;</span></span>));
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notes_and_warnings"><a class="anchor" href="#_notes_and_warnings"></a>Notes and Warnings</h4>
<div class="paragraph">
<p>Finally, we use three visual styles to draw attention to information that might otherwise be overlooked.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Note</div>
<div class="paragraph">
<p>Notes are tips, shortcuts or alternative approaches to the task at hand.
Ignoring a note should have no negative consequences, but you might miss out on a trick that makes your life easier.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Important</div>
<div class="paragraph">
<p>Important boxes detail things that are easily missed: configuration changes that only apply to the current session, or services that need restarting before an update will apply.
Ignoring a box labeled 'Important' will not cause data loss but may cause irritation and frustration.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Warning</div>
<div class="paragraph">
<p>Warnings should not be ignored.
Ignoring warnings will most likely cause data loss.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_we_need_feedback"><a class="anchor" href="#_we_need_feedback"></a>We Need Feedback!</h3>
<div class="paragraph">
<p>Please feel free to raise any issues you find with this document in our <a href="https://issues.redhat.com/browse/JBTM">issue tracking system</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_general_procedures"><a class="anchor" href="#_general_procedures"></a>1. General Procedures</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_administration"><a class="anchor" href="#_administration"></a>1.1. Administration</h3>
<div class="sect3">
<h4 id="_introduction_2"><a class="anchor" href="#_introduction_2"></a>1.1.1. Introduction</h4>
<div class="paragraph">
<p>Apart from ensuring that the run-time system is executing normally, there is little continuous administration needed for the Narayana software.
Refer to <a href="#important_points_for_administrators">Important Points for Administrators</a> for some specific concerns.</p>
</div>
<div id="important_points_for_administrators" class="ulist">
<div class="title">Important Points for Administrators</div>
<ul>
<li>
<p>The present implementation of the Narayana system provides no security or protection for data.
The objects stored in the Narayana object store are (typically) owned by the user who ran the application that created them.
The Object Store and Object Manager facilities make no attempt to enforce even the limited form of protection that Unix/Windows provides.
There is no checking of user or group IDs on access to objects for either reading or writing.</p>
</li>
<li>
<p>Persistent objects created in the Object Store never go away unless the StateManager.destroy method is invoked on the object or some application program explicitly deletes them.
This means that the Object Store gradually accumulates garbage (especially during application development and testing phases).
At present we have no automated garbage collection facility.
Further, we have not addressed the problem of dangling references.
That is, a persistent object, <code>A</code>, may have stored a Uid for another persistent object, <code>B</code>, in its passive representation on disk.
There is nothing to prevent an application from deleting <code>B</code> even though <code>A</code> still contains a reference to it.
When <code>A</code> is next activated and attempts to access <code>B</code>, a run-time error will occur.</p>
</li>
<li>
<p>There is presently no support for version control of objects or database reconfiguration in the event of class structure changes.
This is a complex research area that we have not addressed.
At present, if you change the definition of a class of persistent objects, you are entirely responsible for ensuring that existing instances of the object in the Object Store are converted to the new representation.
The Narayana software can neither detect nor correct references to old object state by new operation versions or vice versa.</p>
</li>
<li>
<p>Object store management is critically important to the transaction service.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_objectstore_management"><a class="anchor" href="#_objectstore_management"></a>1.1.2. ObjectStore Management</h4>
<div class="paragraph">
<p>Within the transaction service installation, the object store is updated regularly whenever transactions are created, or when <em>Transactional Objects for Java</em> is used.
In a failure-free environment, the only object states which should reside within the object store are those representing objects created with the <em>Transactional Objects for Java</em> API.</p>
</div>
<div class="paragraph">
<p>However, if failures occur, transaction logs may remain in the object store until crash recovery facilities have resolved the transactions they represent.
As such it is very important that the contents of the object store are not deleted without due care and attention, as this will make it impossible to resolve in doubt transactions.
In addition, if multiple users share the same object store it is important that they realize this and do not simply delete the contents of the object store assuming it is an exclusive resource.</p>
</div>
</div>
<div class="sect3">
<h4 id="_narayana_runtime_information"><a class="anchor" href="#_narayana_runtime_information"></a>1.1.3. Narayana Runtime Information</h4>
<div class="paragraph">
<p>Compile-time configuration information is available via class <code>com.arjuna.common.util.ConfigurationInfo</code>.
Runtime configuration is embodied in the various <code>name EnvironmentBean</code> classes where name refers to the particular configuration category (see the configuration section of the user guide).
These beans have corresponding MBean interfaces and may be linked to JMX for remote inspection of the configuration if desired.</p>
</div>
</div>
<div class="sect3">
<h4 id="_failure_recovery_administration"><a class="anchor" href="#_failure_recovery_administration"></a>1.1.4. Failure Recovery Administration</h4>
<div class="paragraph">
<p>The failure recovery subsystem of Narayana will ensure that results of a transaction are applied consistently to all resources affected by the transaction, even if any of the application processes or the machine hosting them crash or lose network connectivity.
In the case of machine (system) crash or network failure, the recovery will not take place until the system or network are restored, but the original application does not need to be restarted.
Recovery responsibility is delegated to <a href="#recovery-manager">The Recovery Manager</a>.
Recovery after failure requires that information about the transaction and the resources involved survives the failure and is accessible afterward: this information is held in the <code>ActionStore</code>, which is part of the <code>ObjectStore</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <code>ObjectStore</code> is destroyed or modified, recovery may not be possible.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Until the recovery procedures are complete, resources affected by a transaction that was in progress at the time of the failure may be inaccessible.
For database resources, this may be reported as tables or rows held by “in-doubt transactions”.
For <em>TransactionalObjects for Java</em> resources, an attempt to activate the <code>Transactional Object</code> (as when trying to get a lock) will fail.</p>
</div>
<div class="sect4">
<h5 id="recovery-manager"><a class="anchor" href="#recovery-manager"></a>The Recovery Manager</h5>
<div class="paragraph">
<p>The failure recovery subsystem of Narayana requires that the stand-alone Recovery Manager process be running for each <code>ObjectStore</code> (typically one for each node on the network that is running Narayana applications).
The <code>RecoveryManager</code> file is located in the Narayana JAR file within the package <code>com.arjuna.ats.arjuna.recovery.RecoveryManager</code>.
To start the Recovery Manager issue the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>-test</code> flag is used with the Recovery Manager then it will display a <code>Ready</code> message when initialized, i.e.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager -test</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuring_the_recovery_manager"><a class="anchor" href="#_configuring_the_recovery_manager"></a>Configuring the Recovery Manager</h5>
<div class="paragraph">
<p>The <code>RecoveryManager</code> reads the properties defined in the <code>jbossts-properties.xml</code> file.</p>
</div>
<div class="paragraph">
<p>A default version of <code>jbossts-properties.xml</code> is supplied with the distribution.
This can be used without modification, except possibly the debug tracing fields, as shown in <a href="#recovery_manager_output">Output</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="recovery_manager_output"><a class="anchor" href="#recovery_manager_output"></a>Output</h5>
<div class="paragraph">
<p>It is likely that installations will want to have some form of output from the <code>RecoveryManager</code>, to provide a record of what recovery activity has taken place.
<code>RecoveryManager</code> uses the logging mechanism provided by <em>jboss logging</em>, which provides a high level interface that hides differences that exist between existing logging APIs such Jakarta log4j or JDK logging API.</p>
</div>
<div class="paragraph">
<p>The configuration of <em>jboss logging</em> depends on the underlying logging framework that is used, which is determined by the availability and ordering of alternatives on the classpath.
Please, consult the <em>jboss logging</em> documentation for details.
Each log message has an associated log Level, that gives the importance and urgency of a log message.
The set of possible Log Levels, in order of least severity, and highest verbosity, is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>TRACE</code></p>
</li>
<li>
<p><code>DEBUG</code></p>
</li>
<li>
<p><code>INFO</code></p>
</li>
<li>
<p><code>WARN</code></p>
</li>
<li>
<p><code>ERROR</code></p>
</li>
<li>
<p><code>FATAL</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Messages describing the start and the periodical behavior made by the <code>RecoveryManager</code> are output using the <code>INFO</code> level.
If other debug tracing is wanted, the finer debug or trace levels should be set appropriately.</p>
</div>
<div class="paragraph">
<p>Setting the normal recovery messages to the <code>INFO</code> level allows the <code>RecoveryManager</code> to produce a moderate level of reporting.
If nothing is going on, it just reports the entry into each module for each periodic pass.
To disable <code>INFO</code> messages produced by the Recovery Manager, the logging level could be set to the higher level of <code>ERROR</code>, which means that the <code>RecoveryManager</code> will only produce <code>ERROR</code>, <code>WARNING</code>, or <code>FATAL</code> messages.</p>
</div>
</div>
<div class="sect4">
<h5 id="_periodic_recovery"><a class="anchor" href="#_periodic_recovery"></a>Periodic Recovery</h5>
<div class="paragraph">
<p>The <code>RecoveryManager</code> scans the <code>ObjectStore</code> and other locations of information, looking for transactions and resources that require, or may require recovery.
The scans and recovery processing are performed by recovery modules.
These recovery modules are instances of classes that implement the <code>com.arjuna.ats.arjuna.recovery.RecoveryModule</code> interface.
Each module has responsibility for a particular category of transaction or resource.
The set of recovery modules used is dynamically loaded, using properties found in the <code>RecoveryManager</code> property file.</p>
</div>
<div class="paragraph">
<p>The interface has two methods: <code>periodicWorkFirstPass</code> and <code>periodicWorkSecondPass</code>.
At an interval defined by property <code>com.arjuna.ats.arjuna.recovery.periodicRecoveryPeriod</code>, the <code>RecoveryManager</code> calls the first pass method on each property, then waits for a brief period, defined by property <code>com.arjuna.ats.arjuna.recovery.recoveryBackoffPeriod</code>.
Next, it calls the second pass of each module.
Typically, in the first pass, the module scans the relevant part of the <code>ObjectStore</code> to find transactions or resources that are in-doubt.
An in-doubt transaction may be part of the way through the commitment process, for instance.
On the second pass, if any of the same items are still in-doubt, the original application process may have crashed, and the item is a candidate for recovery.</p>
</div>
<div class="paragraph">
<p>An attempt by the <code>RecoveryManager</code> to recover a transaction that is still progressing in the original process is likely to break the consistency.
Accordingly, the recovery modules use a mechanism, implemented in the <code>com.arjuna.ats.arjuna.recovery.TransactionStatusManager</code> package, to check to see if the original process is still alive, and if the transaction is still in progress.
The <code>RecoveryManager</code> only proceeds with recovery if the original process has gone, or, if still alive, the transaction is completed.
If a server process or machine crashes, but the transaction-initiating process survives, the transaction completes, usually generating a warning.
Recovery of such a transaction is the responsibility of the <code>RecoveryManager</code>.</p>
</div>
<div class="paragraph">
<p>It is clearly important to set the interval periods appropriately.
The total iteration time will be the sum of the <code>periodicRecoveryPeriod</code> and <code>recoveryBackoffPeriod</code> properties, and the length of time it takes to scan the stores and to attempt recovery of any in-doubt transactions found, for all the recovery modules.
The recovery attempt time may include connection timeouts while trying to communicate with processes or machines that have crashed or are inaccessible.
There are mechanisms in the recovery system to avoid trying to recover the same transaction indefinitely.
The total iteration time affects how long a resource will remain inaccessible after a failure. – <code>periodicRecoveryPeriod</code> should be set accordingly.
Its default is 120 seconds.
The <code>recoveryBackoffPeriod</code> can be comparatively short, and defaults to 10 seconds.
Its purpose is mainly to reduce the number of transactions that are candidates for recovery and which thus require a call to the original process to see if they are still in progress.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In previous versions of Narayana, there was no contact mechanism, and the back-off period needed to be long enough to avoid catching transactions in flight at all.
From 3.0, there is no such risk.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Two recovery modules, implementations of the <code>com.arjuna.ats.arjuna.recovery.RecoveryModule</code> interface, are supplied with Narayana.
These modules support various aspects of transaction recovery, including JDBC recovery.
It is possible for advanced users to create their own recovery modules and register them with the Recovery Manager.
The recovery modules are registered with the <code>RecoveryManager</code> using <code>RecoveryEnvironmentBean.recoveryModuleClassNames</code>.
These will be invoked on each pass of the periodic recovery in the sort-order of the property names – it is thus possible to predict the ordering, but a failure in an application process might occur while a periodic recovery pass is in progress.
The default Recovery Extension settings are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.recoveryModuleClassNames</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    com.arjuna.ats.internal.arjuna.recovery.AtomicActionRecoveryModule
    com.arjuna.ats.internal.txoj.recovery.TORecoveryModule
    com.arjuna.ats.internal.jts.recovery.transactions.TopLevelTransactionRecoveryModule
    com.arjuna.ats.internal.jts.recovery.transactions.ServerTransactionRecoveryModule
    com.arjuna.ats.internal.jta.recovery.jts.XARecoveryModule
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_expired_entry_removal"><a class="anchor" href="#_expired_entry_removal"></a>Expired Entry Removal</h5>
<div class="paragraph">
<p>The operation of the recovery subsystem cause some entries to be made in the <code>ObjectStore</code> that are not removed in normal progress.
The <code>RecoveryManager</code> has a facility for scanning for these and removing items that are very old.
Scans and removals are performed by implementations of the <code>com.arjuna.ats.arjuna.recovery.ExpiryScanner</code> interface.
These implementations are loaded by giving the class names as the value of a property <code>RecoveryEnvironmentBean.expiryScannerClassNames</code>.
The <code>RecoveryManager</code> calls the <code>scan()</code> method on each loaded Expiry Scanner implementation at an interval determined by the property <code>RecoveryEnvironmentBean.expiryScanInterval</code>.
This value is given in hours, and defaults to 12hours.
An <code>expiryScanInterval</code> value of zero suppresses any expiry scanning.
If the value supplied is positive, the first scan is performed when <code>RecoveryManager</code> starts.
If the value is negative, the first scan is delayed until after the first interval, using the absolute value.</p>
</div>
<div class="paragraph">
<p>The kinds of item that are scanned for expiry are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">TransactionStatusManager items</dt>
<dd>
<p>One <code>TransactionStatusManager</code> item is created by every application process that uses Narayana.
It contains the information that allows the <code>RecoveryManager</code> to determine if the process that initiated the transaction is still alive, and its status.
The expiry time for these items is set by the property <code>com.arjuna.ats.arjuna.recovery.transactionStatusManagerExpiryTime</code>, expressed in hours.
The default is 12, and 0 (zero) means never to expire.The expiry time should be greater than the lifetime of any single processes using Narayana .</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The Expiry Scanner properties for these are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.expiryScannerClassNames</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    com.arjuna.ats.internal.arjuna.recovery.ExpiredTransactionStatusManagerScanner
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_errors_and_exceptions"><a class="anchor" href="#_errors_and_exceptions"></a>1.1.5. Errors and Exceptions</h4>
<div class="paragraph">
<p>This section covers the types and causes of errors and exceptions which may be thrown or reported during a transactional application.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<div class="title">Errors and Exceptions</div>
<dl>
<dt class="hdlist1"><code>NO_MEMORY</code></dt>
<dd>
<p>The application has run out of memory, and has thrown an <code>OutOfMemoryError</code> exception.
Narayana has attempted to do some cleanup, by running the garbage collector, before re-throwing the exception.
This is probably a transient problem and retrying the invocation should succeed.</p>
</dd>
<dt class="hdlist1"><code>com.arjuna.ats.arjuna.exceptions.FatalError</code></dt>
<dd>
<p>An error has occurred, and the error is of such severity that the transaction system must shut down.
Prior to this error being thrown the transaction service ensures that all running transactions have rolled back.
If an application catches this error, it should tidy up and exit.
If further work is attempted, application consistency may be violated.</p>
</dd>
<dt class="hdlist1"><code>com.arjuna.ats.arjuna.exceptions.ObjectStoreError</code></dt>
<dd>
<p>An error occurred while the transaction service attempted to use the object store.
Further forward progress is not possible.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>Object store warnings about access problems on states may occur during the normal execution of crash recovery.
This is the result of multiple concurrent attempts to perform recovery on the same transaction.
It can be safely ignored.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installation"><a class="anchor" href="#_installation"></a>1.2. Installation</h3>
<div class="sect3">
<h4 id="_preparing_your_system"><a class="anchor" href="#_preparing_your_system"></a>1.2.1. Preparing Your System</h4>
<div class="sect4">
<h5 id="_pre_installation_steps"><a class="anchor" href="#_pre_installation_steps"></a>Pre-Installation Steps</h5>
<div class="paragraph">
<p>Before installing the Narayana software, we recommend the following administrative steps be taken, assuming a default configuration for Narayana.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install the distribution into the required location.</p>
<div class="paragraph">
<p>Typically, the distribution is extracted from a <code>.ZIP</code> file.</p>
</div>
</li>
<li>
<p>Specify the Location for the Object Store</p>
<div class="paragraph">
<p>Narayana requires a minimum object store for storing the outcome of transactions in the event of system crashes.
The location of this should be specified in the properties file using the <code>ObjectStoreEnvironmentBean.objectStoreDir</code> key or by using environment variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java –DObjectStoreEnvironmentBean.objectStoreDir =C:\temp foo.</code></pre>
</div>
</div>
</li>
<li>
<p>Optional: Specify the sub-directory within the Object Store root.</p>
<div class="paragraph">
<p>By default, all object states will be stored within the <code>defaultStore</code> sub-directory of the object store root.
For instance, if the object store root is <code>/usr/local/Arjuna/TransactionService/ObjectStore</code>, the subdirectory <code>/usr/local/Arjuna/TransactionService/ObjectStore/defaultStore/</code> is used.</p>
</div>
<div class="paragraph">
<p>To change this subdirectory, set the <code>ObjectStoreEnvironmentBean.localOSRoot</code> or <code>com.arjuna.ats.arjuna.objectstore.localOSRoot</code> property variable accordingly.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_operating_system_services"><a class="anchor" href="#_operating_system_services"></a>1.2.2. Operating System Services</h4>
<div class="sect4">
<h5 id="_microsoft_windows_server"><a class="anchor" href="#_microsoft_windows_server"></a>Microsoft Windows Server</h5>
<div class="paragraph">
<p>Four scripts, located in the <code>Services\bin\windows</code> folder, install and uninstall the recovery manager and transaction server services.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<div class="title">Installation Scripts for Microsoft Windows</div>
<dl>
<dt class="hdlist1">Recovery Manager Service</dt>
<dd>
<p><code>InstallRecoveryManagerService-NT.bat</code></p>
</dd>
<dt class="hdlist1">Transaction Server</dt>
<dd>
<p><code>InstallTransactionServiceService-NT.bat</code></p>
</dd>
</dl>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<div class="title">Uninstallation Scripts for Microsoft Windows</div>
<dl>
<dt class="hdlist1">Recovery Manager Service</dt>
<dd>
<p><code>UninstallRecoveryManagerService-NT.bat</code></p>
</dd>
<dt class="hdlist1">Transaction Server</dt>
<dd>
<p><code>UninstallTransactionServerService-NT.bat</code></p>
</dd>
</dl>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Each of the scripts requires administrative privileges.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After running any of the scripts, a status message indicates success or failure.</p>
</div>
</div>
<div class="sect4">
<h5 id="_linux_unix"><a class="anchor" href="#_linux_unix"></a>Linux / UNIX</h5>
<div class="sect5">
<h6 id="_installing_services_in_linuxunix"><a class="anchor" href="#_installing_services_in_linuxunix"></a>Installing Services in Linux/UNIX:</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log into the system with <code>root</code> privileges.</p>
<div class="paragraph">
<p>The installer needs these privileges to create files in <code>/etc</code>.</p>
</div>
</li>
<li>
<p>Change to <code>JBOSS_HOME/services/installer</code> directory.</p>
<div class="paragraph">
<p><code>JBOSS_HOME</code> refers to the directory where you extracted Narayana.</p>
</div>
</li>
<li>
<p>Set the <code>JAVA_HOME</code> variable, if necessary.</p>
<div class="paragraph">
<p>Set the <code>JAVA_HOME</code> variable to the base directory of the JVM the service will use.
The <code>base directory</code> is the directory above <code>bin/java</code>.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Bash: <code>export JAVA_HOME="/opt/java"</code></p>
<div class="paragraph">
<p>CSH: <code>setenv JAVA_HOME="/opt/java"</code></p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Run the installer script.</p>
<div class="paragraph">
<p><code>./install_service.sh</code></p>
</div>
</li>
<li>
<p>The start-up and shut-down scripts are installed.</p>
<div class="paragraph">
<p>Information similar to the output below is displayed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Adding $JAVA_HOME (/opt/java) to $PATH in
/opt/arjuna/ats-3.2/services/bin/solaris/recoverymanagerservice.sh
Adding $JAVA_HOME (/opt/java) to $PATH in
/opt/arjuna/ats-3.2/services/bin/solaris/transactionserverservice.sh
Installing shutdown scripts into /etc/rcS.d:
K01recoverymanagerservice
K00transactionserverservice
Installing shutdown scripts into /etc/rc0.d:
K01recoverymanagerservice
K00transactionserverservice
Installing shutdown scripts into /etc/rc1.d:
K01recoverymanagerservice
K00transactionserverservice
Installing shutdown scripts into /etc/rc2.d:
K01recoverymanagerservice
K00transactionserverservice
Installing startup scripts into /etc/rc3.d:
S98recoverymanagerservice
S99transactionserverservice</code></pre>
</div>
</div>
<div class="paragraph">
<p>The start-up and shut-down scripts are installed for each run-level.
Depending on your specific operating system, you may need to explicitly enable the services for automatic start-up.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="_uninstalling_services_in_linuxunix"><a class="anchor" href="#_uninstalling_services_in_linuxunix"></a>Uninstalling Services in Linux/UNIX</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log into the system with <code>root</code> privileges.</p>
<div class="paragraph">
<p>The installer needs these privileges to delete files in <code>/etc</code>.</p>
</div>
</li>
<li>
<p>Change to <code>JBOSS_HOME/services/installer</code> directory.</p>
<div class="paragraph">
<p><code>JBOSS_HOME</code> refers to the directory where you extracted Narayana.</p>
</div>
</li>
<li>
<p>Run the installation script with the <code>-u</code> option.</p>
<div class="paragraph">
<p><code>./install_services.sh -u</code></p>
</div>
</li>
<li>
<p>The start-up and shut-down scripts are removed.</p>
<div class="paragraph">
<p>Messages like the ones below indicate that the start-up and shut-down scripts have been removed successfully.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Removing startup scripts from /etc/rc3.d:
S98recoverymanagerservice
S99transactionserverservice
Removing shutdown scripts from /etc/rcS.d:
K01recoverymanagerservice
K00transactionserverservice
Removing shutdown scripts from /etc/rc0.d:
K01recoverymanagerservice
K00transactionserverservice
Removing shutdown scripts from /etc/rc1.d:
K01recoverymanagerservice
K00transactionserverservice
Removing shutdown scripts from /etc/rc2.d:
K01recoverymanagerservice
K00transactionserverservice</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_logging"><a class="anchor" href="#_logging"></a>1.2.3. Logging</h4>
<div class="paragraph">
<p>The recovery manager and the transaction server services produce log files which are located in the <code>services/logs/</code> directory.
Two log files are created per service.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>&lt;service-name&gt;-service.log</code></dt>
<dd>
<p>Contains information regarding whether the service is stopped, started, restarted, or in another state.</p>
</dd>
<dt class="hdlist1"><code>&lt;service-name&gt;.log</code></dt>
<dd>
<p>Contains information logged from the actual service.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To configure what information is logged in these files, edit the appropriate LOG4J configuration files located in <code>services/config/</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_additional_jar_requirements"><a class="anchor" href="#_additional_jar_requirements"></a>1.2.4. Additional JAR Requirements</h4>
<div class="paragraph">
<p>To use all of the facilities available within Narayana, you need to add all of the JAR files contained in the <code>lib/</code> directory of the distribution to the <code>CLASSPATH</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_chap_jbossjta_installation_guide_test_chapter"><a class="anchor" href="#_chap_jbossjta_installation_guide_test_chapter"></a>1.2.5. Setting Properties</h4>
<div class="paragraph">
<p>Narayana has been designed to be highly configurable at runtime through the use of various property attributes.
Although these attributes can be provided at runtime on the command line, it may be more convenient to specify them through a single properties file or via <code>setter</code> methods on the beans.
At runtime, Narayana looks for the file <code>jbossts-properties.xml</code>, in a specific search order.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A location specified by a system property, allowing the normal search path to be overridden.</p>
</li>
<li>
<p>The directory from which the application was executed.</p>
</li>
<li>
<p>The home directory of the user that launched Narayana.</p>
</li>
<li>
<p><code>java.home</code></p>
</li>
<li>
<p>The <code>CLASSPATH</code>, which normally includes the installation&#8217;s <code>etc/</code> directory.</p>
</li>
<li>
<p>A default set of properties embedded in the <code>JAR</code> file.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Where properties are defined in both the system properties by using the <code>-D</code> switch, and in the properties file, the value from the system property takes precedence.
This facilitates overriding individual properties easily on the command line.</p>
</div>
<div class="paragraph">
<p>The properties file uses <code>java.uil.Properties</code> XML format, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CoordinatorEnvironmentBean.asyncCommit</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>NO<span class="tag">&lt;/entry&gt;</span>
<span class="tag">&lt;entyr</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ObjectStoreEnvironmentBean.objectStoreDir</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>/var/ObjectStore<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can override the name of the properties file at runtime by specifying a new file using the <code>com.arjuna.ats.arjuna.common.propertiesFile</code> attribute variable.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Unlike earlier releases, there is no longer one properties file name per module.
These properties file name key is now global for all Narayana components in the JVM.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_upgrade"><a class="anchor" href="#_upgrade"></a>1.3. Upgrade</h3>
<div class="paragraph">
<p>To upgrade to the latest version of the Narayana software, replace all currently used Narayana jars with their latest versions.
However, before replacing the jars, ensure that all pending transactions are either completed or recovered.
It is essential that the Object Store is empty before transitioning to a newer version of Narayana.
This precaution is necessary because a newer version of Narayana may potentially break compatibility with older information stored in the Object Store, making that data unusable.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_narayana_core"><a class="anchor" href="#_narayana_core"></a>2. Narayana Core</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview"><a class="anchor" href="#_overview"></a>2.1. Overview</h3>
<div class="paragraph">
<p>A transaction is a unit of work that encapsulates multiple database actions such that either all the encapsulated actions fail or all succeed.</p>
</div>
<div class="paragraph">
<p>Transactions ensure data integrity when an application interacts with multiple datasources.</p>
</div>
<div class="paragraph">
<p>This chapter contains a description of the use of the ArjunaCore transaction engine and the <em>Transactional Objects for Java</em> (TXOJ) classes and facilities.
The classes mentioned in this chapter are the key to writing fault-tolerant applications using transactions.
Thus, they are described and then applied in the construction of a simple application.
The classes to be described in this chapter can be found in the <code>com.arjuna.ats.txoj</code> and <code>com.arjuna.ats.arjuna</code> packages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Stand-Alone Transaction Manager</div>
<div class="paragraph">
<p>Although Narayana can be embedded in various containers, such as WildFly Application Server, it remains a stand-alone transaction manager as well.
There are no dependencies between the core Narayana and any container implementations.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_arjunacore_the_transaction_engine"><a class="anchor" href="#_arjunacore_the_transaction_engine"></a>2.1.1. ArjunaCore: The Transaction Engine</h4>
<div class="paragraph">
<p>In keeping with the object-oriented view, the mechanisms needed to construct reliable distributed applications are presented to programmers in an object-oriented manner.
Some mechanisms need to be inherited, for example, concurrency control and state management.
Other mechanisms, such as object storage and transactions, are implemented as ArjunaCore objects that are created and manipulated like any other object.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When the manual talks about using persistence and concurrency control facilities it assumes that the Transactional Objects for Java (TXOJ) classes are being used.
If this is not the case then the programmer is responsible for all of these issues.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ArjunaCore exploits object-oriented techniques to present programmers with a toolkit of Java classes from which application classes can inherit to obtain desired properties, such as persistence and concurrency control.
These classes form a hierarchy, part of which is shown in <a href="#_txcore_class_hierarchy">ArjunaCore Class Hierarchy</a> and which will be described later in this document.</p>
</div>
<div id="_txcore_class_hierarchy" class="imageblock text-center">
<div class="content">
<img src="images/core-txcore_class_hierarchy.png" alt="core txcore class hierarchy">
</div>
<div class="title">Figure 1. ArjunaCore Class Hierarchy</div>
</div>
<div class="paragraph">
<p>Apart from specifying the scopes of transactions, and setting appropriate locks within objects, the application programmer does not have any other responsibilities: <em>ArjunaCore</em> and <em>TXOJ</em> guarantee that transactional objects will be registered with, and be driven by, the appropriate transactions, and crash recovery mechanisms are invoked automatically in the event of failures.</p>
</div>
</div>
<div class="sect3">
<h4 id="_saving_object_states"><a class="anchor" href="#_saving_object_states"></a>2.1.2. Saving object states</h4>
<div class="paragraph">
<p>ArjunaCore needs to be able to remember the state of an object for several purposes.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">recovery</dt>
<dd>
<p>The state represents some past state of the object.</p>
</dd>
<dt class="hdlist1">persistence</dt>
<dd>
<p>The state represents the final state of an object at application termination.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Since these requirements have common functionality they are all implemented using the same mechanism: the classes <code>InputObjectState</code> and <code>OutputObjectState</code>.
The classes maintain an internal array into which instances of the standard types can be contiguously packed or unpacked using appropriate <code>pack</code> or <code>unpack</code> operations.
This buffer is automatically resized as required should it have insufficient space.
The instances are all stored in the buffer in a standard form called <em>network byte order</em>, making them machine independent.
Any other architecture-independent format, such as XDR or ASN.1, can be implemented simply by replacing the operations with ones appropriate to the encoding required.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_object_store"><a class="anchor" href="#_the_object_store"></a>2.1.3. The object store</h4>
<div class="paragraph">
<p>Implementations of persistence can be affected by restrictions imposed by the Java SecurityManager.
Therefore, the object store provided with ArjunaCore is implemented using the techniques of interface and implementation.
The current distribution includes implementations which write object states to the local file system or database, and remote implementations, where the interface uses a client stub (proxy) to remote services.</p>
</div>
<div class="paragraph">
<p>Persistent objects are assigned unique identifiers, which are instances of the <code>Uid</code> class, when they are created.
These identifiers are used to identify them within the object store.
States are read using the <code>read_committed</code> operation and written by the <code>write_committed</code> and <code>write_uncommitted</code> operations.</p>
</div>
</div>
<div class="sect3">
<h4 id="_recovery_and_persistence"><a class="anchor" href="#_recovery_and_persistence"></a>2.1.4. Recovery and persistence</h4>
<div class="paragraph">
<p>At the root of the class hierarchy is the class <code>StateManager</code>. <code>StateManager</code> is responsible for object activation and deactivation, as well as object recovery.
Refer to <a href="#statemanager_signature">Simplified signature of the <code>StateManager</code> class</a> for the simplified signature of the class.</p>
</div>
<div id="statemanager_signature" class="listingblock">
<div class="title">Simplified signature of the <code>StateManager</code> class</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">StateManager</span> {
    <span class="directive">protected</span> StateManager();

    <span class="directive">protected</span> StateManager(Uid id);

    <span class="directive">public</span> <span class="type">boolean</span> activate();

    <span class="comment">// methods to be provided by a derived class</span>

    <span class="directive">public</span> <span class="type">boolean</span> deactivate(<span class="type">boolean</span> commit);

    <span class="comment">// object’s identifier.</span>
    <span class="directive">public</span> Uid get_uid();

    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os);

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Objects are assumed to be of three possible flavors.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Recoverable</dt>
<dd>
<p><code>StateManager</code> attempts to generate and maintain appropriate recovery information for the object.
Such objects have lifetimes that do not exceed the application program that creates them.</p>
</dd>
<dt class="hdlist1">Recoverable and Persistent</dt>
<dd>
<p>The lifetime of the object is assumed to be greater than that of the creating or accessing application, so that in addition to maintaining recovery information, <code>StateManager</code> attempts to automatically load or unload any existing persistent state for the object by calling the <code>activate</code> or <code>deactivate</code> operation at appropriate times.</p>
</dd>
<dt class="hdlist1">Neither Recoverable nor Persistent</dt>
<dd>
<p>No recovery information is ever kept, nor is object activation or deactivation ever automatically attempted.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If an object is <code>recoverable</code> or <code>recoverable and persistent</code>, then <code>StateManager</code> invokes the operations <code>save_state</code> while performing <code>deactivate</code>, and <code>restore_state</code> while performing <code>activate</code> at various points during the execution of the application.
These operations must be implemented by the programmer since <code>StateManager</code> cannot detect user-level state changes.
This gives the programmer the ability to decide which parts of an object’s state should be made persistent.
For example, for a spreadsheet it may not be necessary to save all entries if some values can simply be recomputed.
The <code>save_state</code> implementation for a class <code>Example</code> that has integer member variables called A, B and C might be implemented as:</p>
</div>
<div class="listingblock">
<div class="title"><code>save_state</code> Implementation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState o) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.save_state(o))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;

    <span class="keyword">try</span> {
        o.packInt(A);
        o.packInt(B);
        o.packInt(C));
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }

    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>it is necessary for all <code>save_state</code> and <code>restore_state</code> methods to call <code>super.save_state</code> and <code>super.restore_state</code>.
This is to cater for improvements in the crash recovery mechanisms.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_life_cycle_of_a_transactional_object_for_java"><a class="anchor" href="#_the_life_cycle_of_a_transactional_object_for_java"></a>2.1.5. The life cycle of a Transactional Object for Java</h4>
<div class="paragraph">
<p>A persistent object not in use is assumed to be held in a passive state, with its state residing in an object store and activated on demand.
The fundamental life cycle of a persistent object in TXOJ is shown in <a href="#txoj-lifecycle">Life cycle of a persistent Object in TXOJ</a> .</p>
</div>
<div id="_txoj_lifecycle" class="imageblock text-center">
<div class="content">
<img src="images/core-txoj-lifecycle.png" alt="core txoj lifecycle">
</div>
<div class="title">Figure 2. Life cycle of a persistent Object in TXOJ</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>During its lifetime, a persistent object may be made active then passive many times.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_concurrency_controller"><a class="anchor" href="#_the_concurrency_controller"></a>2.1.6. The concurrency controller</h4>
<div class="paragraph">
<p>The concurrency controller is implemented by the class <code>LockManager</code>, which provides sensible default behavior while allowing the programmer to override it if deemed necessary by the particular semantics of the class being programmed.
As with <code>StateManager</code> and persistence, concurrency control implementations are accessed through interfaces.
As well as providing access to remote services, the current implementations of concurrency control available to interfaces include:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Local disk/database implementation</dt>
<dd>
<p>Locks are made persistent by being written to the local file system or database.</p>
</dd>
<dt class="hdlist1">A purely local implementation</dt>
<dd>
<p>Locks are maintained within the memory of the virtual machine which created them.
This implementation has better performance than when writing locks to the local disk, but objects cannot be shared between virtual machines.
Importantly, it is a basic Java object with no requirements which can be affected by the SecurityManager.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The primary programmer interface to the concurrency controller is via the <code>setlock</code> operation.
By default, the runtime system enforces strict two-phase locking following a multiple reader, single writer policy on a per-object basis.
However, as shown in <a href="#_txcore_class_hierarchy">ArjunaCore Class Hierarchy</a>, by inheriting from the <code>Lock</code> class, you can provide your own lock implementations with different lock conflict rules to enable type specific concurrency control.</p>
</div>
<div class="paragraph">
<p>Lock acquisition is, of necessity, under programmer control, since just as <code>StateManager</code> cannot determine if an operation modifies an object, <code>LockManager</code> cannot determine if an operation requires a read or write lock.
Lock release, however, is under control of the system and requires no further intervention by the programmer.
This ensures that the two-phase property can be correctly maintained.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">LockResult</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> GRANTED;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> REFUSED;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> RELEASED;
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">ConflictType</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> CONFLICT;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> COMPATIBLE;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> PRESENT;
}

<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">LockManager</span> <span class="directive">extends</span> StateManager {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> defaultRetry;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> defaultTimeout;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> waitTotalTimeout;

    <span class="directive">protected</span> LockManager();

    <span class="directive">protected</span> LockManager(<span class="type">int</span> ot);

    <span class="directive">protected</span> LockManager(<span class="type">int</span> ot, <span class="type">int</span> objectModel);

    <span class="directive">protected</span> LockManager(Uid storeUid);

    <span class="directive">protected</span> LockManager(Uid storeUid, <span class="type">int</span> ot);

    <span class="directive">protected</span> LockManager(Uid storeUid, <span class="type">int</span> ot, <span class="type">int</span> objectModel);

    <span class="directive">public</span> <span class="directive">final</span> <span class="directive">synchronized</span> <span class="type">boolean</span> releaselock(Uid lockUid);

    <span class="directive">public</span> <span class="directive">final</span> <span class="directive">synchronized</span> <span class="type">int</span> setlock(<span class="predefined-type">Lock</span> toSet);

    <span class="directive">public</span> <span class="directive">final</span> <span class="directive">synchronized</span> <span class="type">int</span> setlock(<span class="predefined-type">Lock</span> toSet, <span class="type">int</span> retry);

    <span class="directive">public</span> <span class="directive">final</span> <span class="directive">synchronized</span> <span class="type">int</span> setlock(<span class="predefined-type">Lock</span> toSet, <span class="type">int</span> retry, <span class="type">int</span> sleepTime);

    <span class="directive">public</span> <span class="type">void</span> print(<span class="predefined-type">PrintStream</span> strm);

    <span class="directive">public</span> <span class="predefined-type">String</span> type();

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">protected</span> <span class="type">void</span> terminate();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>LockManager</code> class is primarily responsible for managing requests to set a lock on an object or to release a lock as appropriate.
However, since it is derived from <code>StateManager</code>, it can also control when some of the inherited facilities are invoked.
For example, <code>LockManager</code> assumes that the setting of a write lock implies that the invoking operation must be about to modify the object.
This may in turn cause recovery information to be saved if the object is recoverable.
In a similar fashion, successful lock acquisition causes <code>activate</code> to be invoked.</p>
</div>
<div class="listingblock">
<div class="title">This example class shows how to try to obtain a write lock on an object.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Example</span> <span class="directive">extends</span> LockManager {
    <span class="directive">public</span> <span class="type">boolean</span> foobar() {
        AtomicAction A = <span class="keyword">new</span> AtomicAction;
        <span class="type">boolean</span> result = <span class="predefined-constant">false</span>;

        A.begin();

        <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.WRITE), <span class="integer">0</span>) == <span class="predefined-type">Lock</span>.GRANTED) {
            <span class="comment">/*
             * Do some work, and TXOJ will
             * guarantee ACID properties.
             */</span>

            <span class="comment">// automatically aborts if fails</span>

            <span class="keyword">if</span> (A.commit() == AtomicAction.COMMITTED) {
                result = <span class="predefined-constant">true</span>;
            }
        } <span class="keyword">else</span>
            A.rollback();

        <span class="keyword">return</span> result;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_transactional_protocol_engine"><a class="anchor" href="#_the_transactional_protocol_engine"></a>2.1.7. The transactional protocol engine</h4>
<div class="paragraph">
<p>The transaction protocol engine is represented by the <code>AtomicAction</code> class, which uses <code>StateManager</code> to record sufficient information for crash recovery mechanisms to complete the transaction in the event of failures.
It has methods for starting and terminating the transaction, and, for those situations where programmers need to implement their own resources, methods for registering them with the current transaction.
Because ArjunaCore supports sub-transactions, if a transaction is begun within the scope of an already executing transaction it will automatically be nested.</p>
</div>
<div class="paragraph">
<p>You can use ArjunaCore with multi-threaded applications.
Each thread within an application can share a transaction or execute within its own transaction.
Therefore, all ArjunaCore classes are also thread-safe.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Relationships Between Activation, Termination, and Commitment</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">{
    ...
    <span class="comment">/* (i) bind to &quot;old&quot; persistent object A */</span>
    O1 objct1 = <span class="keyword">new</span> objct1(<span class="predefined-type">Name</span> - A);
    <span class="comment">/* create a &quot;new&quot; persistent object */</span>
    O2 objct2 = <span class="keyword">new</span> objct2();
    <span class="comment">/* (ii) start of atomic action */</span>
    OTS.current().begin();
    <span class="comment">/* (iii) object activation and invocations */</span>
    objct1.op(...);
    objct2.op(...);
    ...
    <span class="comment">/* (iv) tx commits &amp; objects deactivated */</span>
    OTS.current().commit(<span class="predefined-constant">true</span>);
}
<span class="comment">/* (v) */</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">(i) Creation of bindings to persistent objects</dt>
<dd>
<p>This could involve the creation of stub objects and a call to remote objects.
Here, we re-bind to an existing persistent object identified by <code>Name-A</code>, and a new persistent object.
A naming system for remote objects maintains the mapping between object names and locations and is described in a later chapter.</p>
</dd>
<dt class="hdlist1">(ii) Start of the atomic transaction</dt>
<dt class="hdlist1">(iii) Operation invocations</dt>
<dd>
<p>As a part of a given invocation, the object implementation is responsible to ensure that it is locked in read or write mode, assuming no lock conflict, and initialized, if necessary, with the latest committed state from the object store.
The first time a lock is acquired on an object within a transaction the object’s state is acquired, if possible, from the object store.</p>
</dd>
<dt class="hdlist1">(iv) Commit of the top-level action</dt>
<dd>
<p>This includes updating of the state of any modified objects in the object store.</p>
</dd>
<dt class="hdlist1">(v) Breaking of the previously created bindings</dt>
</dl>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_class_hierarchy"><a class="anchor" href="#_the_class_hierarchy"></a>2.1.8. The class hierarchy</h4>
<div class="paragraph">
<p>The principal classes which make up the class hierarchy of ArjunaCore are depicted below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>StateManager</code></p>
<div class="ulist">
<ul>
<li>
<p><code>LockManager</code></p>
<div class="ulist">
<ul>
<li>
<p>User-Defined Classes</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>Lock</code></p>
<div class="ulist">
<ul>
<li>
<p>User-Defined Classes</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>AbstractRecord</code></p>
<div class="ulist">
<ul>
<li>
<p><code>RecoveryRecord</code></p>
</li>
<li>
<p><code>LockRecord</code></p>
</li>
<li>
<p><code>RecordList</code></p>
</li>
<li>
<p>Other management record types</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>AtomicAction</code></p>
<div class="ulist">
<ul>
<li>
<p><code>TopLevelTransaction</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>Input/OutputObjectBuffer</code></p>
<div class="ulist">
<ul>
<li>
<p><code>Input/OutputObjectState</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ObjectStore</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Programmers of fault-tolerant applications will be primarily concerned with the classes <code>LockManager</code>, <code>Lock</code>, and <code>AtomicAction</code>. Other classes important to a programmer are <code>Uid</code> and <code>ObjectState</code>.</p>
</div>
<div class="paragraph">
<p>Most ArjunaCore classes are derived from the base class <code>StateManager</code>, which provides primitive facilities necessary for managing persistent and recoverable objects.
These facilities include support for the activation and de-activation of objects, and state-based object recovery.</p>
</div>
<div class="paragraph">
<p>The class <code>LockManager</code> uses the facilities of <code>StateManager</code> and <code>Lock</code> to provide the concurrency control required for implementing the serializability property of atomic actions.
The concurrency control consists of two-phase locking in the current implementation.
The implementation of atomic action facilities is supported by <code>AtomicAction</code> and <code>TopLevelTransaction</code>.</p>
</div>
<div class="paragraph">
<p>Consider a simple example.
Assume that <code>Example</code> is a user-defined persistent class suitably derived from the <code>LockManager</code>. An application containing an atomic transaction <code>Trans</code> accesses an object called <code>O</code> of type <code>Example</code>, by invoking the operation <code>op1</code>, which involves state changes to <code>O</code>. The serializability property requires that a write lock must be acquired on <code>O</code> before it is modified.
Therefore, the body of <code>op1</code> should contain a call to the <code>setlock</code> operation of the concurrency controller.</p>
</div>
<div class="listingblock">
<div class="title">Simple Concurrency Control</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">boolean</span> op1(...) {
    <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.WRITE) == LockResult.GRANTED)
    {
        <span class="comment">// actual state change operations follow </span>
        ...
    }
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_steps_followed_by_the_operation_setlock"><a class="anchor" href="#_steps_followed_by_the_operation_setlock"></a>Steps followed by the operation <code>setlock</code></h5>
<div class="paragraph">
<p>The operation <code>setlock</code>, provided by the <code>LockManager</code> class, performs the following functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check write lock compatibility with the currently held locks, and if allowed, continue.</p>
</li>
<li>
<p>Call the StateManager operation <code>activate</code>. <code>activate</code> will load, if not done already, the latest persistent state of <code>O</code> from the object store, then call the <code>StateManager</code> operation <code>modified</code>, which has the effect of creating an instance of either <code>RecoveryRecord</code> or <code>PersistenceRecord</code> for <code>O</code>, depending upon whether <code>O</code> was persistent or not.
The Lock is a WRITE lock so the old state of the object must be retained prior to modification.
The record is then inserted into the RecordList of Trans.</p>
</li>
<li>
<p>Create and insert a <code>LockRecord</code> instance in the <code>RecordList</code> of <code>Trans</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now suppose that action <code>Trans</code> is aborted sometime after the lock has been acquired.
Then the <code>rollback</code> operation of <code>AtomicAction</code> will process the <code>RecordList</code> instance associated with <code>Trans</code> by invoking an appropriate <code>Abort</code> operation on the various records.
The implementation of this operation by the <code>LockRecord</code> class will release the WRITE lock while that of <code>RecoveryRecord</code> or <code>PersistenceRecord</code> will restore the prior state of <code>O</code>.</p>
</div>
<div class="paragraph">
<p>It is important to realize that all of the above work is automatically being performed by ArjunaCore on behalf of the application programmer.
The programmer need only start the transaction and set an appropriate lock; ArjunaCore and <em>TXOJ</em> take care of participant registration, persistence, concurrency control and recovery.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_arjunacore"><a class="anchor" href="#_using_arjunacore"></a>2.2. Using ArjunaCore</h3>
<div class="paragraph">
<p>This section describes <em>ArjunaCore</em> and <em>Transactional Objects for Java</em> (TXOJ) in more detail, and shows how to use ArjunaCore to construct transactional applications.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In previous releases ArjunaCore was often referred to as TxCore.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_state_management"><a class="anchor" href="#_state_management"></a>2.2.1. State management</h4>
<div class="sect4">
<h5 id="_object_states"><a class="anchor" href="#_object_states"></a>Object states</h5>
<div class="paragraph">
<p>ArjunaCore needs to be able to remember the state of an object for several purposes, including recovery (the state represents some past state of the object), and for persistence (the state represents the final state of an object at application termination).
Since all of these requirements require common functionality they are all implemented using the same mechanism - the classes Input/OutputObjectState and Input/OutputBuffer.</p>
</div>
<div class="listingblock">
<div class="title"><code>OutputBuffer</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">OutputBuffer</span> {
    <span class="directive">public</span> OutputBuffer();

    <span class="directive">public</span> <span class="directive">final</span> <span class="directive">synchronized</span> <span class="type">boolean</span> valid();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">byte</span><span class="type">[]</span> buffer();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">int</span> length();

    <span class="comment">/* pack operations for standard Java types */</span>

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packByte(<span class="type">byte</span> b) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packBytes(<span class="type">byte</span><span class="type">[]</span> b) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packBoolean(<span class="type">boolean</span> b) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packChar(<span class="type">char</span> c) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packShort(<span class="type">short</span> s) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packInt(<span class="type">int</span> i) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packLong(<span class="type">long</span> l) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packFloat(<span class="type">float</span> f) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packDouble(<span class="type">double</span> d) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packString(<span class="predefined-type">String</span> s) <span class="directive">throws</span> <span class="exception">IOException</span>;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>InputBuffer</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">InputBuffer</span> {
    <span class="directive">public</span> InputBuffer();

    <span class="directive">public</span> <span class="directive">final</span> <span class="directive">synchronized</span> <span class="type">boolean</span> valid();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">byte</span><span class="type">[]</span> buffer();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">int</span> length();

    <span class="comment">/* unpack operations for standard Java types */</span>

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">byte</span> unpackByte() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">byte</span><span class="type">[]</span> unpackBytes() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> unpackBoolean() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">char</span> unpackChar() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">short</span> unpackShort() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">int</span> unpackInt() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">long</span> unpackLong() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">float</span> unpackFloat() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">double</span> unpackDouble() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="predefined-type">String</span> unpackString() <span class="directive">throws</span> <span class="exception">IOException</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>InputBuffer</code> and <code>OutputBuffer</code> classes maintain an internal array into which instances of the standard Java types can be contiguously packed or unpacked, using the <code>pack</code> or <code>unpack</code> operations.
This buffer is automatically resized as required should it have insufficient space.
The instances are all stored in the buffer in a standard form called <em>network byte order</em> to make them machine independent.</p>
</div>
<div class="listingblock">
<div class="title"><code>OutputObjectState</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">OutputObjectState</span> <span class="directive">extends</span> OutputBuffer {
    <span class="directive">public</span> OutputObjectState(Uid newUid, <span class="predefined-type">String</span> typeName);

    <span class="directive">public</span> <span class="type">boolean</span> notempty();

    <span class="directive">public</span> <span class="type">int</span> size();

    <span class="directive">public</span> Uid stateUid();

    <span class="directive">public</span> <span class="predefined-type">String</span> type();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">InputObjectState</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">InputObjectState</span> <span class="directive">extends</span> InputBuffer {
    <span class="directive">public</span> OutputObjectState(Uid newUid, <span class="predefined-type">String</span> typeName, <span class="type">byte</span><span class="type">[]</span> b);

    <span class="directive">public</span> <span class="type">boolean</span> notempty();

    <span class="directive">public</span> <span class="type">int</span> size();

    <span class="directive">public</span> Uid stateUid();

    <span class="directive">public</span> <span class="predefined-type">String</span> type();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>InputObjectState</code> and <code>OutputObjectState</code> classes provides all the functionality of <code>InputBuffer</code> and <code>OutputBuffer</code>, through inheritance, and add two additional instance variables that signify the Uid and type of the object for which the <code>InputObjectStat</code> or <code>OutputObjectState</code> instance is a compressed image.
These are used when accessing the object store during storage and retrieval of the object state.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_object_store_2"><a class="anchor" href="#_the_object_store_2"></a>2.2.2. The object store</h4>
<div class="paragraph">
<p>The object store provided with ArjunaCore deliberately has a fairly restricted interface so that it can be implemented in a variety of ways.
For example, object stores are implemented in shared memory, on the Unix file system (in several different forms), and as a remotely accessible store.
More complete information about the object stores available in ArjunaCore can be found in the Appendix.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As with all ArjunaCore classes, the default object stores are pure Java implementations.
To access the shared memory and other more complex object store implementations, you need to use native methods.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All of the object stores hold and retrieve instances of the class <code>InputObjectState</code> or <code>OutputObjectState</code>.
These instances are named by the Uid and Type of the object that they represent.
States are read using the <code>read_committed</code> operation and written by the system using the <code>write_uncommitted</code> operation.
Under normal operation new object states do not overwrite old object states but are written to the store as shadow copies.
These shadows replace the original only when the <code>commit_state</code> operation is invoked.
Normally all interaction with the object store is performed by ArjunaCore system components as appropriate thus the existence of any shadow versions of objects in the store are hidden from the programmer.</p>
</div>
<div class="listingblock">
<div class="title">StateStatus</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> StateStatus {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_COMMITTED;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_UNCOMMITTED;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_COMMITTED_HIDDEN;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_UNCOMMITTED_HIDDEN;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_UNKNOWN;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ObjectStore</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">ObjectStore</span> {
    <span class="comment">/* The abstract interface */</span>
    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">boolean</span> commit_state(Uid u, <span class="predefined-type">String</span> name) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">abstract</span> InputObjectState read_committed(Uid u, <span class="predefined-type">String</span> name) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">boolean</span> write_uncommitted(Uid u, <span class="predefined-type">String</span> name, OutputObjectState os) <span class="directive">throws</span> ObjectStoreException;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a transactional object is committing, it must make certain state changes persistent, so it can recover in the event of a failure and either continue to commit, or rollback.
When using <code>TXOJ</code>, ArjunaCore will take care of this automatically.
To guarantee <em>ACID</em> properties, these state changes must be flushed to the persistence store implementation before the transaction can proceed to commit.
Otherwise, the application may assume that the transaction has committed when in fact the state changes may still reside within an operating system cache, and may be lost by a subsequent machine failure.
By default, ArjunaCore ensures that such state changes are flushed.
However, doing so can impose a significant performance penalty on the application.</p>
</div>
<div class="paragraph">
<p>To prevent transactional object state flushes, set the <code>ObjectStoreEnvironmentBean.objectStoreSync</code> variable to <code>OFF</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_selecting_an_object_store_implementation"><a class="anchor" href="#_selecting_an_object_store_implementation"></a>2.2.3. Selecting an object store implementation</h4>
<div class="paragraph">
<p>ArjunaCore comes with support for several different object store implementations.
The Appendix describes these implementations, how to select and configure a given implementation on a per-object basis using the <code>ObjectStoreEnvironmentBean.objectStoreType</code> property variable, and indicates how additional implementations can be provided.</p>
</div>
<div class="sect4">
<h5 id="_statemanager"><a class="anchor" href="#_statemanager"></a>StateManager</h5>
<div class="paragraph">
<p>The ArjunaCore class <code>StateManager</code> manages the state of an object and provides all of the basic support mechanisms required by an object for state management purposes. <code>StateManager</code> is responsible for creating and registering appropriate resources concerned with the persistence and recovery of the transactional object.
If a transaction is nested, then <code>StateManager</code> will also propagate these resources between child transactions and their parents at commit time.</p>
</div>
<div class="paragraph">
<p>Objects are assumed to be of three possible flavors.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<div class="title">Three Flavors of Objects</div>
<dl>
<dt class="hdlist1">Recoverable</dt>
<dd>
<p><code>StateManager</code> attempts to generate and maintain appropriate recovery information for the object.
Such objects have lifetimes that do not exceed the application program that creates them.</p>
</dd>
<dt class="hdlist1">Recoverable and Persistent</dt>
<dd>
<p>The lifetime of the object is assumed to be greater than that of the creating or accessing application, so that in addition to maintaining recovery information, <code>StateManager</code> attempts to automatically load or unload any existing persistent state for the object by calling the <code>activate</code> or <code>deactivate</code> operation at appropriate times.</p>
</dd>
<dt class="hdlist1">Neither Recoverable nor Persistent</dt>
<dd>
<p>No recovery information is ever kept, nor is object activation or deactivation ever automatically attempted.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>This object property is selected at object construction time and cannot be changed thereafter.
Thus, an object cannot gain (or lose) recovery capabilities at some arbitrary point during its lifetime.</p>
</div>
<div class="listingblock">
<div class="title">Object Store Implementation Using <code>StateManager</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ObjectStatus</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> PASSIVE;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> PASSIVE_NEW;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> ACTIVE;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> ACTIVE_NEW;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> UNKNOWN_STATUS;
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">ObjectType</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> RECOVERABLE;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> ANDPERSISTENT;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> NEITHER;
}

<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">StateManager</span> {
    <span class="directive">protected</span> StateManager();

    <span class="directive">protected</span> StateManager(<span class="type">int</span> ObjectType, <span class="type">int</span> objectModel);

    <span class="directive">protected</span> StateManager(Uid uid);

    <span class="directive">protected</span> StateManager(Uid uid, <span class="type">int</span> objectModel);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> activate();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> activate(<span class="predefined-type">String</span> storeRoot);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> deactivate();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> deactivate(<span class="predefined-type">String</span> storeRoot, <span class="type">boolean</span> commit);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> destroy();
    ...

    public <span class="directive">final</span> Uid get_uid();

    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="predefined-type">String</span> type();
    ...

    protected <span class="directive">final</span> <span class="type">void</span> modified();
    ...
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">ObjectModel</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> SINGLE;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> MULTIPLE;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If an object is recoverable or persistent, <code>StateManager</code> will invoke the operations <code>save_state</code> (while performing deactivation), <code>restore_state</code> (while performing activation), and <code>type</code> at various points during the execution of the application.
These operations must be implemented by the programmer since <code>StateManager</code> does not have access to a runtime description of the layout of an arbitrary Java object in memory and thus cannot implement a default policy for converting the in memory version of the object to its passive form.
However, the capabilities provided by <code>InputObjectState</code> and <code>OutputObjectState</code> make the writing of these routines fairly simple.
For example, the <code>save_state</code> implementation for a class <code>Example</code> that had member variables called <code>A</code>, <code>B</code>, and <code>C</code> could simply be <a href="#example_methods_for_StateManager">the example implementation of <code>StateManager</code></a>.</p>
</div>
<div id="example_methods_for_StateManager" class="listingblock">
<div class="title">Example implementation of <code>StateManager</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.save_state(os, ObjectType))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;

    <span class="keyword">try</span> {
        os.packInt(A);
        os.packString(B);
        os.packFloat(C);

        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to support crash recovery for persistent objects, all <code>save_state</code> and <code>restore_state</code> methods of user objects must call <code>super.save_state</code> and <code>super.restore_state</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>type</code> method is used to determine the location in the object store where the state of instances of that class will be saved and ultimately restored.
This location can actually be any valid string.
However, you should avoid using the hash character (#) as this is reserved for special directories that ArjunaCore requires.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>get_uid</code> operation of <code>StateManager</code> provides read-only access to an object’s internal system name for whatever purpose the programmer requires, such as registration of the name in a name server.
The value of the internal system name can only be set when an object is initially constructed, either by the provision of an explicit parameter or by generating a new identifier when the object is created.</p>
</div>
<div class="paragraph">
<p>The <code>destroy</code> method can be used to remove the object’s state from the object store.
This is an atomic operation, and therefore will only remove the state if the top-level transaction within which it is invoked eventually commits.
The programmer must obtain exclusive access to the object prior to invoking this operation.</p>
</div>
<div class="paragraph">
<p>Since object recovery and persistence essentially have complimentary requirements (the only difference being where state information is stored and for what purpose), <code>StateManager</code> effectively combines the management of these two properties into a single mechanism.
It uses instances of the classes <code>InputObjectState</code> and <code>OutputObjectState</code> both for recovery and persistence purposes.
An additional argument passed to the <code>save_state</code> and <code>restore_state</code> operations allows the programmer to determine the purpose for which any given invocation is being made.
This allows different information to be saved for recovery and persistence purposes.</p>
</div>
</div>
<div class="sect4">
<h5 id="_object_models"><a class="anchor" href="#_object_models"></a>Object models</h5>
<div class="paragraph">
<p>ArjunaCore supports two models for objects, which affect how an objects state and concurrency control are implemented.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<div class="title">ArjunaCore Object Models</div>
<dl>
<dt class="hdlist1">Single</dt>
<dd>
<p>Only a single copy of the object exists within the application.
This copy resides within a single JVM, and all clients must address their invocations to this server.
This model provides better performance, but represents a single point of failure, and in a multi-threaded environment may not protect the object from corruption if a single thread fails.</p>
</dd>
</dl>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/appendix-single_object_model.png" alt="appendix single object model">
</div>
<div class="title">Figure 3. Single Object Model</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Multiple</dt>
<dd>
<p>Logically, a single instance of the object exists, but copies of it are distributed across different JVMs.
The performance of this model is worse than the SINGLE model, but it provides better failure isolation.</p>
</dd>
</dl>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/appendix-multiple_object_model.png" alt="appendix multiple object model">
</div>
<div class="title">Figure 4. Multiple Object Model</div>
</div>
<div class="paragraph">
<p>The default model is SINGLE.
The programmer can override this on a per-object basis by using the appropriate constructor.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h5>
<div class="paragraph">
<p>In summary, the ArjunaCore class <code>StateManager</code> manages the state of an object and provides all of the basic support mechanisms required by an object for state management purposes.
Some operations must be defined by the class developer.
These operations are: <code>save_state</code>, <code>restore_state</code>, and <code>type</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code><strong>boolean save_state (OutputObjectState state, int objectType)</strong></code></dt>
<dd>
<p>Invoked whenever the state of an object might need to be saved for future use, primarily for recovery or persistence purposes.
The <code>objectType</code> parameter indicates the reason that <code>save_state</code> was invoked by ArjunaCore.
This enables the programmer to save different pieces of information into the <code>OutputObjectState</code> supplied as the first parameter depending upon whether the state is needed for recovery or persistence purposes.
For example, pointers to other ArjunaCore objects might be saved simply as pointers for recovery purposes but as <code>Uid</code> s for persistence purposes.
As shown earlier, the <code>OutputObjectState</code> class provides convenient operations to allow the saving of instances of all of the basic types in Java.
In order to support crash recovery for persistent objects it is necessary for all <code>save_state</code> methods to call <code>super.save_state</code>.</p>
<div class="paragraph">
<p><code>save_state</code> assumes that an object is internally consistent and that all variables saved have valid values.
It is the programmer&#8217;s responsibility to ensure that this is the case.</p>
</div>
</dd>
<dt class="hdlist1"><code><strong>boolean restore_state (InputObjectState state, int objectType)</strong></code></dt>
<dd>
<p>Invoked whenever the state of an object needs to be restored to the one supplied.
Once again the second parameter allows different interpretations of the supplied state.
In order to support crash recovery for persistent objects it is necessary for all <code>restore_state</code> methods to call <code>super.restore_state</code>.</p>
</dd>
<dt class="hdlist1"><code><strong>String type ()</strong></code></dt>
<dd>
<p>The ArjunaCore persistence mechanism requires a means of determining the type of an object as a string so that it can save or restore the state of the object into or from the object store.
By convention this information indicates the position of the class in the hierarchy.
For example, <code>/StateManager/LockManager/Object</code>.</p>
<div class="paragraph">
<p>The <code>type</code> method is used to determine the location in the object store where the state of instances of that class will be saved and ultimately restored.
This can actually be any valid string.
However, you should avoid using the hash character (#) as this is reserved for special directories that ArjunaCore requires.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_example"><a class="anchor" href="#_example"></a>Example</h5>
<div class="paragraph">
<p>Consider the following basic <code>Array</code> class derived from the <code>StateManager</code> class.
In this example, to illustrate saving and restoring of an object’s state, the <code>highestIndex</code> variable is used to keep track of the highest element of the array that has a non-zero value.</p>
</div>
<div id="array-example" class="listingblock">
<div class="title"><code>Array</code> Class</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Array</span> <span class="directive">extends</span> StateManager {
    <span class="directive">public</span> <span class="predefined-type">Array</span> ();
    <span class="directive">public</span> <span class="predefined-type">Array</span> (Uid objUid);

    <span class="directive">public</span> <span class="type">void</span> finalize {
        <span class="local-variable">super</span>.terminate();
        <span class="local-variable">super</span>.finalize();
    }

    <span class="comment">/* Class specific operations. */</span>

    <span class="directive">public</span> <span class="type">boolean</span> set (<span class="type">int</span> index, <span class="type">int</span> value);
    <span class="directive">public</span> <span class="type">int</span> get (<span class="type">int</span> index);

    <span class="comment">/* State management specific operations. */</span>

    <span class="directive">public</span> <span class="type">boolean</span> save_state (OutputObjectState os, <span class="type">int</span> ObjectType);
    <span class="directive">public</span> <span class="type">boolean</span> restore_state (InputObjectState os, <span class="type">int</span> ObjectType);
    <span class="directive">public</span> <span class="predefined-type">String</span> type ();

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> ARRAY_SIZE = <span class="integer">10</span>;

    <span class="directive">private</span> <span class="type">int</span><span class="type">[]</span> elements = <span class="keyword">new</span> <span class="type">int</span>[ARRAY_SIZE];
    <span class="directive">private</span> <span class="type">int</span> highestIndex;

    <span class="comment">/* The save_state, restore_state and type operations can be defined as follows: */</span>

    <span class="comment">/* Ignore ObjectType parameter for simplicity */</span>
    <span class="directive">public</span> <span class="type">boolean</span> save_state (OutputObjectState os, <span class="type">int</span> ObjectType) {
        <span class="keyword">if</span> (!<span class="local-variable">super</span>.save_state(os, ObjectType))
            <span class="keyword">return</span> <span class="predefined-constant">false</span>;

        <span class="keyword">try</span> {
            packInt(highestIndex);

            <span class="comment">// Traverse array state that we wish to save. Only save active elements</span>

            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt;= highestIndex; i++)
                os.packInt(elements[i]);

            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
            <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        }
    }

    <span class="directive">public</span> <span class="type">boolean</span> restore_state (InputObjectState os, <span class="type">int</span> ObjectType) {
        <span class="keyword">if</span> (!<span class="local-variable">super</span>.restore_state(os, ObjectType))
            <span class="keyword">return</span> <span class="predefined-constant">false</span>;

        <span class="keyword">try</span> {
            <span class="type">int</span> i = <span class="integer">0</span>;

            highestIndex = os.unpackInt();

            <span class="keyword">while</span> (i &lt; ARRAY_SIZE) {
                <span class="keyword">if</span> (i &lt;= highestIndex)
                    elements[i] =  os.unpackInt();
                <span class="keyword">else</span>
                    elements[i] = <span class="integer">0</span>;
                i++;
            }

            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
            <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        }
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> type () {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/StateManager/Array</span><span class="delimiter">&quot;</span></span>;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lock_management_and_concurrency_control"><a class="anchor" href="#_lock_management_and_concurrency_control"></a>2.2.4. Lock management and concurrency control</h4>
<div class="paragraph">
<p>Concurrency control information within ArjunaCore is maintained by locks.
Locks which are required to be shared between objects in different processes may be held within a lock store, similar to the object store facility presented previously.
The lock store provided with ArjunaCore deliberately has a fairly restricted interface so that it can be implemented in a variety of ways.
For example, lock stores are implemented in shared memory, on the Unix file system (in several different forms), and as a remotely accessible store.
More information about the object stores available in ArjunaCore can be found in the Appendix.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As with all ArjunaCore classes, the default lock stores are pure Java implementations.
To access the shared memory and other more complex lock store implementations it is necessary to use native methods.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><code>LockStore</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">LockStore</span> {
    <span class="directive">public</span> <span class="directive">abstract</span> InputObjectState read_state(Uid u, <span class="predefined-type">String</span> tName) <span class="directive">throws</span> LockStoreException;

    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">boolean</span> remove_state(Uid u, <span class="predefined-type">String</span> tname);

    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">boolean</span> write_committed(Uid u, <span class="predefined-type">String</span> tName, OutputObjectState state);
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_selecting_a_lock_store_implementation"><a class="anchor" href="#_selecting_a_lock_store_implementation"></a>Selecting a lock store implementation</h5>
<div class="paragraph">
<p>ArjunaCore comes with support for several different object store implementations.
If the object model being used is SINGLE, then no lock store is required for maintaining locks, since the information about the object is not exported from it.
However, if the MULTIPLE model is used, then different run-time environments (processes, Java virtual machines) may need to share concurrency control information.
The implementation type of the lock store to use can be specified for all objects within a given execution environment using the <code>TxojEnvironmentBean.lockStoreType</code> property variable.
Currently, this can have one of the following values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">BasicLockStore</dt>
<dd>
<p>This is an in-memory implementation which does not, by default, allow sharing of stored information between execution environments.
The application programmer is responsible for sharing the store information.</p>
</dd>
<dt class="hdlist1">BasicPersistentLockStore</dt>
<dd>
<p>This is the default implementation, and stores locking information within the local file system.
Therefore execution environments that share the same file store can share concurrency control information.
The root of the file system into which locking information is written is the <code>LockStore</code> directory within the ArjunaCore installation directory.
You can override this at runtime by setting the <code>TxojEnvironmentBean.lockStoreDir</code> property variable accordingly, or placing the location within the <code>CLASSPATH</code>.</p>
</dd>
</dl>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java -D TxojEnvironmentBean.lockStoreDir=/var/tmp/LockStore myprogram
java –classpath $CLASSPATH;/var/tmp/LockStore myprogram</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If neither of these approaches is taken, then the default location will be at the same level as the <code>etc</code> directory of the installation.</p>
</div>
</div>
<div class="sect4">
<h5 id="_lockmanager"><a class="anchor" href="#_lockmanager"></a>LockManager</h5>
<div class="paragraph">
<p>The concurrency controller is implemented by the class <code>LockManager</code>, which provides sensible default behavior, while allowing the programmer to override it if deemed necessary by the particular semantics of the class being programmed.
The primary programmer interface to the concurrency controller is via the <code>setlock</code> operation.
By default, the ArjunaCore runtime system enforces strict two-phase locking following a multiple reader, single writer policy on a per-object basis.
Lock acquisition is under programmer control, since just as <code>StateManager</code> cannot determine if an operation modifies an object, <code>LockManager</code> cannot determine if an operation requires a read or write lock.
Lock release, however, is normally under control of the system and requires no further intervention by the programmer.
This ensures that the two-phase property can be correctly maintained.</p>
</div>
<div class="paragraph">
<p>The <code>LockManager</code> class is primarily responsible for managing requests to set a lock on an object or to release a lock as appropriate.
However, since it is derived from <code>StateManager</code>, it can also control when some of the inherited facilities are invoked.
For example, if a request to set a write lock is granted, then <code>LockManager</code> invokes modified directly assuming that the setting of a write lock implies that the invoking operation must be about to modify the object.
This may in turn cause recovery information to be saved if the object is recoverable.
In a similar fashion, successful lock acquisition causes activate to be invoked.</p>
</div>
<div class="paragraph">
<p>Therefore, <code>LockManager</code> is directly responsible for activating and deactivating persistent objects, as well as registering <code>Resources</code> for managing concurrency control.
By driving the <code>StateManager</code> class, it is also responsible for registering <code>Resources</code> for persistent or recoverable state manipulation and object recovery.
The application programmer simply sets appropriate locks, starts and ends transactions, and extends the <code>save_state</code> and <code>restore_state</code> methods of <code>StateManager</code>.</p>
</div>
<div class="listingblock">
<div class="title"><code>LockResult</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">LockResult</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> GRANTED;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> REFUSED;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> RELEASED;
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">ConflictType</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> CONFLICT;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> COMPATIBLE;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> PRESENT;
}

<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">LockManager</span> <span class="directive">extends</span> StateManager {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> defaultTimeout;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> defaultRetry;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> waitTotalTimeout;

    <span class="directive">protected</span> LockManager();

    <span class="directive">protected</span> LockManager(<span class="type">int</span> ObjectType, <span class="type">int</span> objectModel);

    <span class="directive">protected</span> LockManager(Uid storeUid);

    <span class="directive">protected</span> LockManager(Uid storeUid, <span class="type">int</span> ObjectType, <span class="type">int</span> objectModel);

    <span class="comment">/* abstract methods inherited from StateManager */</span>

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">int</span> setlock(<span class="predefined-type">Lock</span> l);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">int</span> setlock(<span class="predefined-type">Lock</span> l, <span class="type">int</span> retry);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">int</span> setlock(<span class="predefined-type">Lock</span> l, <span class="type">int</span> retry, <span class="type">int</span> sleepTime);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> releaselock(Uid uid);

    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="predefined-type">String</span> type();
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>setlock</code> operation must be parametrized with the type of lock required (READ or WRITE), and the number of retries to acquire the lock before giving up.
If a lock conflict occurs, one of the following scenarios will take place:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the retry value is equal to <code>LockManager.waitTotalTimeout</code>, then the thread which called <code>setlock</code> will be blocked until the lock is released, or the total timeout specified has elapsed, and in which <code>REFUSED</code> will be returned.</p>
</li>
<li>
<p>If the lock cannot be obtained initially then <code>LockManager</code> will try for the specified number of retries, waiting for the specified timeout value between each failed attempt.
The default is 100 attempts, each attempt being separated by a 0.25 seconds delay.
The time between retries is specified in micro-seconds.</p>
</li>
<li>
<p>If a lock conflict occurs the current implementation simply times out lock requests, thereby preventing deadlocks, rather than providing a full deadlock detection scheme.
If the requested lock is obtained, the <code>setlock</code> operation will return the value <code>GRANTED</code>, otherwise the value <code>REFUSED</code> is returned.
It is the responsibility of the programmer to ensure that the remainder of the code for an operation is only executed if a lock request is granted.
Below are examples of the use of the <code>setlock</code> operation.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title"><code>setlock</code> method usage</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Will attempt to set a write lock 11 times (10 retries) on the object before giving up.</span>
res = setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(WRITE), <span class="integer">10</span>);
<span class="comment">// Will attempt to set a read lock 1 time (no retries) on the object before giving up.</span>
res = setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(READ), <span class="integer">0</span>);
<span class="comment">// Will attempt to set a write lock 101 times (default of 100 retries) on the object before giving up.</span>
res = setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(WRITE);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The concurrency control mechanism is integrated into the atomic action mechanism, thus ensuring that as locks are granted on an object appropriate information is registered with the currently running atomic action to ensure that the locks are released at the correct time.
This frees the programmer from the burden of explicitly freeing any acquired locks if they were acquired within atomic actions.
However, if locks are acquired on an object outside of the scope of an atomic action, it is the programmer&#8217;s responsibility to release the locks when required, using the corresponding <code>releaselock</code> operation.</p>
</div>
</div>
<div class="sect4">
<h5 id="_locking_policy"><a class="anchor" href="#_locking_policy"></a>Locking policy</h5>
<div class="paragraph">
<p>Unlike many other systems, locks in ArjunaCore are not special system types.
Instead they are simply instances of other ArjunaCore objects (the class <code>Lock</code> which is also derived from <code>StateManager</code> so that locks may be made persistent if required and can also be named in a simple fashion).
Furthermore, <code>LockManager</code> deliberately has no knowledge of the semantics of the actual policy by which lock requests are granted.
Such information is maintained by the actual <code>Lock</code> class instances which provide operations (the <code>conflictsWith</code> operation) by which <code>LockManager</code> can determine if two locks conflict or not.
This separation is important in that it allows the programmer to derive new lock types from the basic <code>Lock</code> class and by providing appropriate definitions of the conflict operations enhanced levels of concurrency may be possible.</p>
</div>
<div class="listingblock">
<div class="title">`LockMode`Class</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">LockMode</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> READ;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> WRITE;
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">LockStatus</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> LOCKFREE;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> LOCKHELD;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> LOCKRETAINED;
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">Lock</span> <span class="directive">extends</span> StateManager {
    <span class="directive">public</span> <span class="predefined-type">Lock</span>(<span class="type">int</span> lockMode);

    <span class="directive">public</span> <span class="type">boolean</span> conflictsWith(<span class="predefined-type">Lock</span> otherLock);

    <span class="directive">public</span> <span class="type">boolean</span> modifiesObject();

    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="predefined-type">String</span> type();
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Lock</code> class provides a <code>modifiesObject</code> operation which <code>LockManager</code> uses to determine if granting this locking request requires a call on modified.
This operation is provided so that locking modes other than simple read and write can be supported.
The supplied <code>Lock</code> class supports the traditional multiple reader/single writer policy.</p>
</div>
</div>
<div class="sect4">
<h5 id="_object_constructor_and_finalizer"><a class="anchor" href="#_object_constructor_and_finalizer"></a>Object constructor and finalizer</h5>
<div class="paragraph">
<p>Recall that ArjunaCore objects can be recoverable, recoverable and persistent, or neither.
Additionally, each object possesses a unique internal name.
These attributes can only be set when that object is constructed.
Thus <code>LockManager</code> provides two protected constructors for use by derived classes, each of which fulfills a distinct purpose.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<div class="title">Protected Constructors Provided by <code>LockManager</code></div>
<dl>
<dt class="hdlist1"><code><strong>LockManager ()</strong></code></dt>
<dd>
<p>This constructor allows the creation of new objects, having no prior state.</p>
</dd>
<dt class="hdlist1"><code><strong>LockManager (int objectType, int objectModel)</strong></code></dt>
<dd>
<p>As above, this constructor allows the creation of new objects having no prior state. exist.
The <code>objectType</code> parameter determines whether an object is simply recoverable (indicated by <code>RECOVERABLE</code>), recoverable and persistent (indicated by <code>ANDPERSISTENT</code>), or neither (indicated by <code>NEITHER</code>).
If an object is marked as being persistent then the state of the object will be stored in one of the object stores.
The shared parameter only has meaning if it is <code>RECOVERABLE</code>. If the object model is <code>SINGLE</code> (the default behavior) then the recoverable state of the object is maintained within the object itself, and has no external representation).
Otherwise, an in-memory (volatile) object store is used to store the state of the object between atomic actions.</p>
<div class="paragraph">
<p>Constructors for new persistent objects should make use of atomic actions within themselves.
This will ensure that the state of the object is automatically written to the object store either when the action in the constructor commits or, if an enclosing action exists, when the appropriate top-level action commits.
Later examples in this chapter illustrate this point further.</p>
</div>
</dd>
<dt class="hdlist1"><code><strong>LockManager (Uid objUid)</strong></code></dt>
<dd>
<p>This constructor allows access to an existing persistent object, whose internal name is given by the <code>objUid</code> parameter.
Objects constructed using this operation will normally have their prior state (identified by <code>objUid</code>) loaded from an object store automatically by the system.</p>
</dd>
<dt class="hdlist1"><code><strong>LockManager (Uid objUid, int objectModel)</strong></code></dt>
<dd>
<p>As above, this constructor allows access to an existing persistent object, whose internal name is given by the <code>objUid</code> parameter.
Objects constructed using this operation will normally have their prior state (identified by <code>objUid</code> ) loaded from an object store automatically by the system.
If the object model is <code>SINGLE</code> (the default behavior), then the object will not be reactivated at the start of each top-level transaction.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>The finalizer of a programmer-defined class must invoke the inherited operation <code>terminate</code> to inform the state management mechanism that the object is about to be destroyed.
Otherwise, unpredictable results may occur.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_advanced_transaction_issues_with_arjunacore"><a class="anchor" href="#_advanced_transaction_issues_with_arjunacore"></a>2.3. Advanced transaction issues with ArjunaCore</h3>
<div class="paragraph">
<p>Atomic actions (transactions) can be used by both application programmers and class developers.
Thus, entire operations (or parts of operations) can be made atomic as required by the semantics of a particular operation.
This chapter will describe some of the more subtle issues involved with using transactions in general and ArjunaCore in particular.</p>
</div>
<div class="sect3">
<h4 id="_last_resource_commit_optimization_lrco"><a class="anchor" href="#_last_resource_commit_optimization_lrco"></a>2.3.1. Last resource commit optimization (LRCO)</h4>
<div class="paragraph">
<p>In some cases it may be necessary to enlist participants that are not two-phase commit aware into a two-phase commit transaction.
If there is only a single resource then there is no need for two-phase commit.
However, if there are multiple resources in the transaction, the <em>Last Resource Commit Optimization</em> (LRCO) comes into play.
It is possible for a single resource that is one-phase aware (i.e., can only commit or roll back, with no prepare), to be enlisted in a transaction with two-phase commit aware resources.
This feature is implemented by logging the decision to commit after committing the one-phase aware participant: The coordinator asks each two-phase aware participant if they are able to prepare and if they all vote yes then the one-phase aware participant is asked to commit.
If the one-phase aware participant commits successfully then the decision to commit is logged and then commit is called on each two-phase aware participant.
A heuristic outcome will occur if the coordinator fails before logging its commit decision but after the one-phase participant has committed since each two-phase aware participant will eventually rollback (as required under <em>presumed `abort`</em> semantics).
This strategy delays the logging of the decision to commit so that in failure scenarios we have avoided a write operation.
But this choice does mean that there is no record in the system of the fact that a heuristic outcome has occurred.</p>
</div>
<div class="paragraph">
<p>In order to utilize the LRCO, your participant must implement the <code>com.arjuna.ats.arjuna.coordinator.OnePhase</code> interface and be registered with the transaction through the <code>BasicAction.add</code> operation.
Since this operation expects instances of <code>AbstractRecord</code>, you must create an instance of <code>com.arjuna.ats.arjuna.LastResourceRecord</code> and give your participant as the constructor parameter.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Class <code>com.arjuna.ats.arjuna.LastResourceRecord</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">try</span> {
    <span class="type">boolean</span> success = <span class="predefined-constant">false</span>;
    AtomicAction A = <span class="keyword">new</span> AtomicAction();
    <span class="comment">// used OnePhase interface</span>
    OnePhase opRes = <span class="keyword">new</span> OnePhase();

    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Starting top-level action.</span><span class="delimiter">&quot;</span></span>);

    A.begin();
    A.add(<span class="keyword">new</span> LastResourceRecord(opRes));
    A.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">other participants</span><span class="delimiter">&quot;</span></span>);

    A.commit();
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_heuristic_outcomes"><a class="anchor" href="#_heuristic_outcomes"></a>2.3.2. Heuristic outcomes</h4>
<div class="paragraph">
<p>In some situations the application thread may not want to be informed of heuristics during completion.
However, it is possible some other component in the application, thread or admin may still want to be informed.
Therefore, special participants can be registered with the transaction which are triggered during the Synchronization phase and given the true outcome of the transaction.
We do not dictate a specific implementation for what these participants do with the information (e.g., OTS allows for the CORBA Notification Service to be used).</p>
</div>
<div class="paragraph">
<p>To use this capability, create classes derived from the HeuristicNotification class and define the heuristicOutcome method to use whatever mechanism makes sense for your application.
Instances of this class should be registered with the tranasction as Synchronizations.</p>
</div>
</div>
<div class="sect3">
<h4 id="_nested_transactions"><a class="anchor" href="#_nested_transactions"></a>2.3.3. Nested transactions</h4>
<div class="paragraph">
<p>There are no special constructs for nesting of transactions.
If an action is begun while another action is running then it is automatically nested.
This allows for a modular structure to applications, whereby objects can be implemented using atomic actions within their operations without the application programmer having to worry about the applications which use them, and whether or not the applications will use atomic actions as well.
Thus, in some applications actions may be top-level, whereas in others they may be nested.
Objects written in this way can then be shared between application programmers, and ArjunaCore will guarantee their consistency.</p>
</div>
<div class="paragraph">
<p>If a nested action is aborted, all of its work will be undone, although strict two-phase locking means that any locks it may have obtained will be retained until the top-level action commits or aborts.
If a nested action commits then the work it has performed will only be committed by the system if the top-level action commits.
If the top-level action aborts then all of the work will be undone.</p>
</div>
<div class="paragraph">
<p>The committing or aborting of a nested action does not automatically affect the outcome of the action within which it is nested.
This is application dependent, and allows a programmer to structure atomic actions to contain faults, undo work, etc.</p>
</div>
</div>
<div class="sect3">
<h4 id="_asynchronously_committing_a_transaction"><a class="anchor" href="#_asynchronously_committing_a_transaction"></a>2.3.4. Asynchronously committing a transaction</h4>
<div class="paragraph">
<p>By default, the Transaction Service executes the <code>commit</code> protocol of a top-level transaction in a synchronous manner.
All registered resources will be told to prepare in order by a single thread, and then they will be told to commit or rollback.
A similar comment applies to the volatile phase of the protocol which provides a synchronization mechanism that allows an interested party to be notified before and after the transaction completes.
This has several possible disadvantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the case of many registered synchronizations, the <code>beforeSynchronization</code> operation can logically be invoked in parallel on each non interposed synchronization (and similary for the interposed synchronizations).
The disadvantage is that if an “early” synchronization in the list of registered resource forces a rollback by throwing an unchecked exception, possibly many beforeCompletion operations will have been made needlessly.</p>
</li>
<li>
<p>In the case of many registered resources, the <code>prepare</code> operation can logically be invoked in parallel on each resource.
The disadvantage is that if an “early” resource in the list of registered resource forces a rollback during <code>prepare</code>, possibly many prepare operations will have been made needlessly.</p>
</li>
<li>
<p>In the case where heuristic reporting is not required by the application, the second phase of the commit protocol (including any afterCompletion synchronizations) can be done asynchronously, since its success or failure is not important to the outcome of the transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore, Narayana provides runtime options to enable possible threading optimizations.
By setting the <code>CoordinatorEnvironmentBean.asyncBeforeSynchronization</code> environment variable to <code>YES</code>, during the <code>beforeSynchronization</code> phase a separate thread will be created for each synchronization registered with the transaction.
By setting the <code>CoordinatorEnvironmentBean.asyncPrepare</code> environment variable to <code>YES</code>, during the <code>prepare</code> phase a separate thread will be created for each registered participant within the transaction.
By setting <code>CoordinatorEnvironmentBean.asyncCommit</code> to <code>YES</code>, a separate thread will be created to complete the second phase of the transaction provided knowledge about heuristics outcomes is not required.
By setting the <code>CoordinatorEnvironmentBean.asyncAfterSynchronization</code> environment variable to <code>YES</code>, during the <code>afterSynchronization</code> phase a separate thread will be created for each synchronization registered with the transaction provided knowledge about heuristics outcomes is not required.</p>
</div>
</div>
<div class="sect3">
<h4 id="_independent_top_level_transactions"><a class="anchor" href="#_independent_top_level_transactions"></a>2.3.5. Independent top-level transactions</h4>
<div class="paragraph">
<p>In addition to normal top-level and nested atomic actions, ArjunaCore also supports independent top-level actions, which can be used to relax strict serializability in a controlled manner.
An independent top-level action can be executed from anywhere within another atomic action and behaves exactly like a normal top-level action.
Its results are made permanent when it commits and will not be undone if any of the actions within which it was originally nested abort.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Independent Top-Level Action</div>
<div class="content">
<div class="imageblock text-center">
<div class="content">
<img src="images/core-independent_top_level_action.png" alt="core independent top level action">
</div>
</div>
<div class="paragraph">
<p>A typical nesting of atomic actions, where action B is nested within action A.
Although atomic action C is logically nested within action B (it had its Begin operation invoked while B was active) because it is an independent top-level action, it will commit or abort independently of the other actions within the structure.
Because of the nature of independent top-level actions they should be used with caution and only in situations where their use has been carefully examined.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Top-level actions can be used within an application by declaring and using instances of the class <code>TopLevelTransaction</code>.
They are used in exactly the same way as other transactions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transactions_within_save_stateand_restore_state_methods"><a class="anchor" href="#_transactions_within_save_stateand_restore_state_methods"></a>2.3.6. Transactions within <code>save_state`and `restore_state</code> methods</h4>
<div class="paragraph">
<p>Exercise caution when writing the <code>save_state</code> and <code>restore_state</code> operations to ensure that no atomic actions are started, either explicitly in the operation or implicitly through use of some other operation.
This restriction arises due to the fact that ArjunaCore may invoke <code>restore_state</code> as part of its commit processing resulting in the attempt to execute an atomic action during the commit or abort phase of another action.
This might violate the atomicity properties of the action being committed or aborted and is thus discouraged.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>If we consider the <a href="using_txcore.html#array-example"><code>Array</code> class</a> given previously, the <code>set</code> and <code>get</code> operations could be implemented as shown below.</p>
</div>
<div class="paragraph">
<p>This is a simplification of the code, ignoring error conditions and exceptions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">boolean</span> set(<span class="type">int</span> index, <span class="type">int</span> value) {
    <span class="type">boolean</span> result = <span class="predefined-constant">false</span>;
    AtomicAction A = <span class="keyword">new</span> AtomicAction();

    A.begin();

    <span class="comment">// We need to set a WRITE lock as we want to modify the state.</span>

    <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.WRITE), <span class="integer">0</span>) == LockResult.GRANTED) {
        elements[index] = value;
        <span class="keyword">if</span> ((value &gt; <span class="integer">0</span>) &amp;&amp; (index &gt; highestIndex
        highestIndex = index;
        A.commit(<span class="predefined-constant">true</span>);
        result = <span class="predefined-constant">true</span>;
    } <span class="keyword">else</span>
        A.rollback();

    <span class="keyword">return</span> result;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// assume -1 means error</span>
<span class="directive">public</span> <span class="type">int</span> get(<span class="type">int</span> index) {
    AtomicAction A = <span class="keyword">new</span> AtomicAction();

    A.begin();

    <span class="comment">// We only need a READ lock as the state is unchanged.</span>

    <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.READ), <span class="integer">0</span>) == LockResult.GRANTED) {
        A.commit(<span class="predefined-constant">true</span>);

        <span class="keyword">return</span> elements[index];
    } <span class="keyword">else</span>
        A.rollback();

    <span class="keyword">return</span> -<span class="integer">1</span>;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_garbage_collecting_objects"><a class="anchor" href="#_garbage_collecting_objects"></a>2.3.7. Garbage collecting objects</h4>
<div class="paragraph">
<p>Java objects are deleted when the garbage collector determines that they are no longer required.
Deleting an object that is currently under the control of a transaction must be approached with caution since if the object is being manipulated within a transaction its fate is effectively determined by the transaction.
Therefore, regardless of the references to a transactional object maintained by an application, ArjunaCore will always retain its own references to ensure that the object is not garbage collected until after any transaction has terminated.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_timeouts"><a class="anchor" href="#_transaction_timeouts"></a>2.3.8. Transaction timeouts</h4>
<div class="paragraph">
<p>By default, transactions live until they are terminated by the application that created them or a failure occurs.
However, it is possible to set a timeout (in seconds) on a per-transaction basis such that if the transaction has not terminated before the timeout expires it will be automatically rolled back.</p>
</div>
<div class="paragraph">
<p>In ArjunaCore, the timeout value is provided as a parameter to the <code>AtomicAction</code> constructor.
If a value of <code>AtomicAction.NO_TIMEOUT</code> is provided (the default) then the transaction will not be automatically timed out.
Any other positive value is assumed to be the timeout for the transaction (in seconds).
A value of zero is taken to be a global default timeout, which can be provided by the property <code>CoordinatorEnvironmentBean.defaultTimeout</code>, which has a default value of 60 seconds.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Default timeout values for other Narayana components, such as JTS, may be different and you should consult the relevant documentation to be sure.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When a top-level transaction is created with a non-zero timeout, it is subject to being rolled back if it has not completed within the specified number of seconds. Narayana uses a separate reaper thread which monitors all locally created transactions, and forces them to roll back if their timeouts elapse.
If the transaction cannot be rolled back at that point, the reaper will force it into a rollback-only state so that it will eventually be rolled back.</p>
</div>
<div class="paragraph">
<p>By default this thread is dynamically scheduled to awake according to the timeout values for any transactions created, ensuring the most timely termination of transactions.
It may alternatively be configured to awake at a fixed interval, which can reduce overhead at the cost of less accurate rollback timing.
For periodic operation, change the <code>CoordinatorEnvironmentBean.txReaperMode</code> property from its default value of <code>DYNAMIC</code> to <code>PERIODIC</code> and set the interval between runs, in milliseconds, using the property <code>CoordinatorEnvironmentBean.txReaperTimeout</code>.
The default interval in <code>PERIODIC</code> mode is <code>120000</code> milliseconds.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In earlier versions the <code>PERIODIC</code> mode was known as <code>NORMAL</code> and was the default behavior.
The use of the configuration value <code>NORMAL</code> is deprecated and <code>PERIODIC</code> should be used instead if the old scheduling behavior is still required.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If a value of <code>0</code> is specified for the timeout of a top-level transaction, or no timeout is specified, then Narayana will not impose any timeout on the transaction, and the transaction will be allowed to run indefinitely.
This default timeout can be overridden by setting the <code>CoordinatorEnvironmentBean.defaultTimeout</code> property variable when using to the required timeout value in seconds, when using ArjunaCore, ArjunaJTA or ArjunaJTS.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As of JBoss Transaction Service 4.5, transaction timeouts have been unified across all transaction components and are controlled by ArjunaCore.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_monitoring_transaction_timeouts"><a class="anchor" href="#_monitoring_transaction_timeouts"></a>Monitoring transaction timeouts</h5>
<div class="paragraph">
<p>If you want to be informed when a transaction is rolled back or forced into a rollback-only mode by the reaper, you can create a class that inherits from class <code>com.arjuna.ats.arjuna.coordinator.listener.ReaperMonitor</code> and overrides the <code>rolledBack</code> and <code>markedRollbackOnly</code> methods.
When registered with the reaper via the <code>TransactionReaper.addListener</code> method, the reaper will invoke one of these methods depending upon how it tries to terminate the transaction.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The reaper will not inform you if the transaction is terminated (committed or rolled back) outside of its control, such as by the application.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hints_and_tips"><a class="anchor" href="#_hints_and_tips"></a>2.4. Hints and tips</h3>
<div class="sect3">
<h4 id="_general"><a class="anchor" href="#_general"></a>2.4.1. General</h4>
<div class="sect4">
<h5 id="_using_transactions_in_constructors"><a class="anchor" href="#_using_transactions_in_constructors"></a>Using transactions in constructors</h5>
<div class="paragraph">
<p>Examples throughout this manual use transactions in the implementation of constructors for new persistent objects.
This is deliberate because it guarantees correct propagation of the state of the object to the object store.
The state of a modified persistent object is only written to the object store when the top-level transaction commits.
Thus, if the constructor transaction is top-level and it commits, the newly-created object is written to the store and becomes available immediately.
If, however, the constructor transaction commits but is nested because another transaction that was started prior to object creation is running, the state is written only if all of the parent transactions commit.</p>
</div>
<div class="paragraph">
<p>On the other hand, if the constructor does not use transactions, inconsistencies in the system can arise.
For example, if no transaction is active when the object is created, its state is not saved to the store until the next time the object is modified under the control of some transaction.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Nested Transactions In Constructors</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AtomicAction A = <span class="keyword">new</span> AtomicAction();
<span class="predefined-type">Object</span> obj1;
<span class="predefined-type">Object</span> obj2;

<span class="comment">// create new object</span>
obj1 = <span class="keyword">new</span> <span class="predefined-type">Object</span>();
<span class="comment">// existing object</span>
obj2 = <span class="keyword">new</span> <span class="predefined-type">Object</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">old</span><span class="delimiter">&quot;</span></span>);

A.begin(<span class="integer">0</span>);
<span class="comment">// obj2 now contains reference to obj1</span>
obj2.remember(obj1.get_uid());
<span class="comment">// obj2 saved but obj1 is not</span>
A.commit(<span class="predefined-constant">true</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The two objects are created outside of the control of the top-level action <em>A</em> .
<em>obj1</em> is a new object.
<em>obj2</em> is an old existing object.
When the <code>remember</code> operation of <em>obj2</em> is invoked, the object will be activated and the <code>Uid</code> of <em>obj1</em> remembered.
Since this action commits, the persistent state of <em>obj2</em> may now contain the <code>Uid</code> of <em>obj1</em>.
However, the state of <em>obj1</em> itself has not been saved since it has not been manipulated under the control of any action.
In fact, unless it is modified under the control of an action later in the application, it will never be saved.
If, however, the constructor had used an atomic action, the state of <em>obj1</em> would have automatically been saved at the time it was constructed and this inconsistency could not arise.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_save_state_and_restore_state_methods"><a class="anchor" href="#_save_state_and_restore_state_methods"></a><code>save_state</code> and <code>restore_state</code> methods</h5>
<div class="paragraph">
<p>ArjunaCore may invoke the user-defined <code>save_state</code> operation of an object at any time during the lifetime of an object, including during the execution of the body of the object’s constructor.
This is particularly a possibility if it uses atomic actions.
It is important, therefore, that all of the variables saved by <code>save_state</code> are correctly initialized.
Exercise caution when writing the <code>save_state</code> and <code>restore_state</code> operations, to ensure that no transactions are started, either explicitly in the operation, or implicitly through use of some other operation.
The reason for this restriction is that ArjunaCore may invoke <code>restore_state</code> as part of its commit processing.
This would result in the attempt to execute an atomic transaction during the commit or abort phase of another transaction.
This might violate the atomicity properties of the transaction being committed or aborted, and is thus discouraged.
In order to support crash recovery for persistent objects, all <code>save_state</code> and <code>restore_state</code> methods of user objects must call <code>super.save_state</code> and <code>super.restore_state</code>.</p>
</div>
<div class="sect5">
<h6 id="_packing_objects"><a class="anchor" href="#_packing_objects"></a>Packing objects</h6>
<div class="paragraph">
<p>All of the basic types of Java (<code>int</code>, <code>long</code>, etc.) can be saved and restored from an <code>InputObjectState</code> or <code>OutputObjectState</code> instance by using the pack and unpack routines provided by <code>InputObjectState</code> and <code>OutputObjectState</code>.
However, packing and unpacking objects should be handled differently.
This is because packing objects brings in the additional problems of aliasing.
Aliasing happens when two different object references may point at the same item.
For example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Aliasing</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> Test(<span class="predefined-type">String</span> s) {
    s1 = s;
    s2 = s;
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">Test</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> s1;
    ...
    private <span class="predefined-type">String</span> s2;
    <span class="directive">public</span> Test(<span class="predefined-type">String</span> s);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, both <code>s1</code> and <code>s2</code> point at the same string.
A naive implementation of <code>save_state</code> might copy the string twice.
From a <code>save_state</code> perspective this is simply inefficient.
However, <code>restore_state</code> would unpack the two strings into different areas of memory, destroying the original aliasing information.
The current version of ArjunaCore packs and unpacks separate object references.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_direct_use_of_statemanager"><a class="anchor" href="#_direct_use_of_statemanager"></a>Direct use of StateManager</h5>
<div class="paragraph">
<p>The examples throughout this manual derive user classes from <code>LockManager</code>. These are two important reasons for this.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Firstly, and most importantly, the serializability constraints of atomic actions require it.</p>
</li>
<li>
<p>It reduces the need for programmer intervention.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>However, if you only require access to ArjunaCore&#8217;s persistence and recovery mechanisms, direct derivation of a user class from <code>StateManager</code> is possible.</p>
</div>
<div class="paragraph">
<p>Classes derived directly from <code>StateManager</code> must make use of its state management mechanisms explicitly.
These interactions are normally undertaken by <code>LockManager</code>.
From a programmer&#8217;s point of view this amounts to making appropriate use of the operations <code>activate</code>, <code>deactivate</code>, and <code>modified</code>, since <code>StateManager</code> 's constructors are effectively identical to those of <code>LockManager</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. <code>activate</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">boolean</span> activate()

<span class="type">boolean</span> activate(<span class="predefined-type">String</span> storeRoot)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Activate loads an object from the object store.
The object’s UID must already have been set via the constructor and the object must exist in the store.
If the object is successfully read then restore_state is called to build the object in memory.
Activate is idempotent so that once an object has been activated further calls are ignored.
The parameter represents the root name of the object store to search for the object.
A value of null means use the default store.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 6. <code>deactivate</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">boolean</span> deactivate()

<span class="type">boolean</span> deactivate(<span class="predefined-type">String</span> storeRoot)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The inverse of activate.
First calls save_state to build the compacted image of the object which is then saved in the object store.
Objects are only saved if they have been modified since they were activated.
The parameter represents the root name of the object store into which the object should be saved.
A value of null means use the default store.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 7. <code>modified</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">void</span> modified()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Must be called prior to modifying the object in memory.
If it is not called, the object will not be saved in the object store by <code>deactivate</code>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_constructing_a_transactional_objects_for_java_application"><a class="anchor" href="#_constructing_a_transactional_objects_for_java_application"></a>2.5. Constructing a Transactional Objects for Java application</h3>
<div class="sect3">
<h4 id="_development_phases_of_a_arjunacore_application"><a class="anchor" href="#_development_phases_of_a_arjunacore_application"></a>2.5.1. Development Phases of a ArjunaCore Application</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, develop new classes with characteristics like persistence, recoverability, and concurrency control.</p>
</li>
<li>
<p>Then develop the applications that make use of the new classes of objects.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Although these two phases may be performed in parallel and by a single person, this guide refers to the first step as the job of the class developer, and the second as the job of the applications developer.
The class developer defines appropriate <code>save_state</code> and <code>restore_state</code> operations for the class, sets appropriate locks in operations, and invokes the appropriate ArjunaCore class constructors.
The applications developer defines the general structure of the application, particularly with regard to the use of atomic actions.</p>
</div>
<div class="paragraph">
<p>This chapter outlines a simple application, a simple FIFO Queue class for integer values.
The Queue is implemented with a doubly linked list structure, and is implemented as a single object.
This example is used throughout the rest of this manual to illustrate the various mechanisms provided by ArjunaCore.
Although this is an unrealistic example application, it illustrates all of the ArjunaCore modifications without requiring in depth knowledge of the application code.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The application is assumed not to be distributed.
To allow for distribution, context information must be propagated either implicitly or explicitly.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_queue_description"><a class="anchor" href="#_queue_description"></a>2.5.2. Queue description</h4>
<div class="paragraph">
<p>The queue is a traditional FIFO queue, where elements are added to the front and removed from the back.
The operations provided by the queue class allow the values to be placed on to the queue (<code>enqueue</code>) and to be removed from it (<code>dequeue</code>), and values of elements in the queue can also be changed or inspected.
In this example implementation, an array represents the queue.
A limit of <code>QUEUE_SIZE</code> elements has been imposed for this example.</p>
</div>
<div class="listingblock">
<div class="title">Java interface definition of class <code>queue</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">TransactionalQueue</span> <span class="directive">extends</span> LockManager {
    <span class="comment">// maximum size of the queue</span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> QUEUE_SIZE = <span class="integer">40</span>;
    <span class="directive">private</span> <span class="type">int</span> numberOfElements;

    <span class="directive">public</span> TransactionalQueue(Uid uid);

    <span class="directive">public</span> TransactionalQueue();

    <span class="directive">public</span> <span class="type">void</span> finalize();

    <span class="directive">public</span> <span class="type">void</span> enqueue(<span class="type">int</span> v) <span class="directive">throws</span> OverFlow, UnderFlow, QueueError, Conflict;

    <span class="directive">public</span> <span class="type">int</span> dequeue() <span class="directive">throws</span> OverFlow, UnderFlow, QueueError, Conflict;

    <span class="directive">public</span> <span class="type">int</span> queueSize();

    <span class="directive">public</span> <span class="type">int</span> inspectValue(<span class="type">int</span> i) <span class="directive">throws</span> OverFlow, UnderFlow, QueueError, Conflict;

    <span class="directive">public</span> <span class="type">void</span> setValue(<span class="type">int</span> i, <span class="type">int</span> v) <span class="directive">throws</span> OverFlow, UnderFlow, QueueError, Conflict;

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">private</span> <span class="type">int</span>[QUEUE_SIZE] elements;

    <span class="directive">public</span> <span class="predefined-type">String</span> type();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_constructors_and_finalizers"><a class="anchor" href="#_constructors_and_finalizers"></a>2.5.3. Constructors and finalizers</h4>
<div class="paragraph">
<p>Using an existing persistent object requires the use of a special constructor that takes the Uid of the persistent object, as shown in <a href="#example_transactionalqueue">Class <code>TransactionalQueue</code></a>.</p>
</div>
<div id="example_transactionalqueue" class="listingblock">
<div class="title">Class <code>TransactionalQueue</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">The constructor
persistent o
that createsbject
<span class="directive">public</span> Tra
a <span class="keyword">new</span>
is similarnsactionalQueue(Uid u) {
    <span class="local-variable">super</span>(u);

    numberOfElements = <span class="integer">0</span>;
}:

<span class="directive">public</span> TransactionalQueue() {
    <span class="local-variable">super</span>(ObjectType.ANDPERSISTENT);

    numberOfElements = <span class="integer">0</span>;

    <span class="keyword">try</span> {
        AtomicAction A = <span class="keyword">new</span> AtomicAction();

        <span class="comment">// Try to start atomic action</span>
        A.begin(<span class="integer">0</span>);

        <span class="comment">// Try to set lock</span>

        <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.WRITE), <span class="integer">0</span>) == LockResult.GRANTED) {
            <span class="comment">// Commit</span>
            A.commit(<span class="predefined-constant">true</span>);
        } <span class="keyword">else</span>
            <span class="comment">// Lock refused so abort the atomic action</span>
            A.rollback();
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Object construction error: </span><span class="delimiter">&quot;</span></span>+e);
        <span class="predefined-type">System</span>.exit(<span class="integer">1</span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The use of an atomic action within the constructor for a new object follows the guidelines outlined earlier and ensures that the object’s state will be written to the object store when the appropriate top level atomic action commits (which will either be the action A or some enclosing action active when the TransactionalQueue was constructed).
The use of atomic actions in a constructor is simple: an action must first be declared and its begin operation invoked; the operation must then set an appropriate lock on the object (in this case a WRITE lock must be acquired), then the main body of the constructor is executed.
If this is successful the atomic action can be committed, otherwise it is aborted.</p>
</div>
<div class="paragraph">
<p>The finalizer of the <code>queue</code> class is only required to call the <code>terminate</code> and <code>finalizer</code> operations of <code>LockManager</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> finalize() {
    <span class="local-variable">super</span>.terminate();
    <span class="local-variable">super</span>.finalize();
}     </code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_required_methods"><a class="anchor" href="#_required_methods"></a>2.5.4. Required methods</h4>
<div class="sect4">
<h5 id="_save_state_restore_state_and_type"><a class="anchor" href="#_save_state_restore_state_and_type"></a><code>save_state</code>, <code>restore_state</code>, and <code>type</code></h5>
<div class="listingblock">
<div class="title">Method <code>save_state</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.save_state(os, ObjectType))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;

    <span class="keyword">try</span> {
        os.packInt(numberOfElements);

        <span class="keyword">if</span> (numberOfElements &gt; <span class="integer">0</span>) {
            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; numberOfElements; i++)
                os.packInt(elements[i]);
        }

        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Method <code>restore_state</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.restore_state(os, ObjectType))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;

    <span class="keyword">try</span> {
        numberOfElements = os.unpackInt();

        <span class="keyword">if</span> (numberOfElements &gt; <span class="integer">0</span>) {
            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; numberOfElements; i++)
                elements[i] = os.unpackInt();
        }

        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
}</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 8. Method <code>type</code></div>
<div class="content">
<div class="paragraph">
<p>Because the Queue class is derived from the LockManager class, the operation type should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="predefined-type">String</span> type() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/StateManager/LockManager/TransactionalQueue</span><span class="delimiter">&quot;</span></span>;
}       </code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_enqueueand_dequeue_methods"><a class="anchor" href="#_enqueueand_dequeue_methods"></a><code>enqueue`and `dequeue</code> methods</h5>
<div class="paragraph">
<p>If the operations of the <code>queue</code> class are to be coded as atomic actions, then the enqueue operation might have the structure given below.
The <code>dequeue</code> operation is similarly structured, but is not implemented here.</p>
</div>
<div class="listingblock">
<div class="title">Method <code>enqueue</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> enqueue(<span class="type">int</span> v) <span class="directive">throws</span> OverFlow, UnderFlow, QueueError {
    AtomicAction A = <span class="keyword">new</span> AtomicAction();
    <span class="type">boolean</span> res = <span class="predefined-constant">false</span>;

    <span class="keyword">try</span> {
        A.begin(<span class="integer">0</span>);

        <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.WRITE), <span class="integer">0</span>) == LockResult.GRANTED) {
            <span class="keyword">if</span> (numberOfElements &lt; QUEUE_SIZE) {
                elements[numberOfElements] = v;
                numberOfElements++;
                res = <span class="predefined-constant">true</span>;
            } <span class="keyword">else</span> {
                A.rollback();
                <span class="keyword">throw</span> <span class="keyword">new</span> UnderFlow();
            }
        }

        <span class="keyword">if</span> (res)
            A.commit(<span class="predefined-constant">true</span>);
        <span class="keyword">else</span> {
            A.rollback();
            <span class="keyword">throw</span> <span class="keyword">new</span> Conflict();
        }
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e1) {
        <span class="keyword">throw</span> <span class="keyword">new</span> QueueError();
    }
}       </code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_queuesize_method"><a class="anchor" href="#_queuesize_method"></a><code>queueSize</code> method</h5>
<div class="listingblock">
<div class="title">Method <code>queueSize</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">int</span> queueSize() <span class="directive">throws</span> QueueError, Conflict {
    AtomicAction A = <span class="keyword">new</span> AtomicAction();
    <span class="type">int</span> size = -<span class="integer">1</span>;

    <span class="keyword">try</span> {
        A.begin(<span class="integer">0</span>);

        <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.READ), <span class="integer">0</span>) == LockResult.GRANTED)
            size = numberOfElements;

        <span class="keyword">if</span> (size != -<span class="integer">1</span>)
            A.commit(<span class="predefined-constant">true</span>);
        <span class="keyword">else</span> {
            A.rollback();

            <span class="keyword">throw</span> <span class="keyword">new</span> Conflict();
        }
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e1) {
        <span class="keyword">throw</span> <span class="keyword">new</span> QueueError();
    }

    <span class="keyword">return</span> size;
}       </code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_inspectvalue_and_setvalue_methods"><a class="anchor" href="#_inspectvalue_and_setvalue_methods"></a><code>inspectValue</code> and <code>setValue</code> methods</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>setValue</code> method is not implemented here, but is similar in structure to <a href="#example_queue_inspectvalue">Method <code>inspectValue</code></a> .</p>
</div>
</td>
</tr>
</table>
</div>
<div id="example_queue_inspectvalue" class="listingblock">
<div class="title">Method <code>inspectValue</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">int</span> inspectValue(<span class="type">int</span> index) <span class="directive">throws</span> UnderFlow,
        OverFlow, Conflict, QueueError {
    AtomicAction A = <span class="keyword">new</span> AtomicAction();
    <span class="type">boolean</span> res = <span class="predefined-constant">false</span>;
    <span class="type">int</span> val = -<span class="integer">1</span>;

    <span class="keyword">try</span> {
        A.begin();

        <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.READ), <span class="integer">0</span>) == LockResult.GRANTED) {
            <span class="keyword">if</span> (index &lt; <span class="integer">0</span>) {
                A.rollback();
                <span class="keyword">throw</span> <span class="keyword">new</span> UnderFlow();
            } <span class="keyword">else</span> {
                <span class="comment">// array is 0 - numberOfElements -1</span>

                <span class="keyword">if</span> (index &gt; numberOfElements - <span class="integer">1</span>) {
                    A.rollback();
                    <span class="keyword">throw</span> <span class="keyword">new</span> OverFlow();
                } <span class="keyword">else</span> {
                    val = elements[index];
                    res = <span class="predefined-constant">true</span>;
                }
            }
        }

        <span class="keyword">if</span> (res)
            A.commit(<span class="predefined-constant">true</span>);
        <span class="keyword">else</span> {
            A.rollback();
            <span class="keyword">throw</span> <span class="keyword">new</span> Conflict();
        }
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e1) {
        <span class="keyword">throw</span> <span class="keyword">new</span> QueueError();
    }

    <span class="keyword">return</span> val;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_client"><a class="anchor" href="#_the_client"></a>2.5.5. The client</h4>
<div class="paragraph">
<p>Rather than show all of the code for the client, this example concentrates on a representative portion.
Before invoking operations on the object, the client must first bind to the object.
In the local case this simply requires the client to create an instance of the object.</p>
</div>
<div class="listingblock">
<div class="title">Binding to the Object</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    TransactionalQueue myQueue = <span class="keyword">new</span> TransactionalQueue();
    <span class="comment">// Before invoking one of the queue’s operations, the client starts a transaction.The queueSize operation is</span>
    shown below:
    AtomicAction A = <span class="keyword">new</span> AtomicAction();
    <span class="type">int</span> size = <span class="integer">0</span>;

    <span class="keyword">try</span> {
        A.begin(<span class="integer">0</span>);

        <span class="keyword">try</span> {
            size = queue.queueSize();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        }

        <span class="keyword">if</span> (size &gt;= <span class="integer">0</span>) {
            A.commit(<span class="predefined-constant">true</span>);

            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Size of queue: </span><span class="delimiter">&quot;</span></span>+size);
        } <span class="keyword">else</span>
            A.rollback();
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Caught unexpected exception !</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_comments"><a class="anchor" href="#_comments"></a>2.5.6. Comments</h4>
<div class="paragraph">
<p>Since the <em>queue</em> object is persistent, the state of the object survives any failures of the node on which it is located.
The state of the object that survives is the state produced by the last top-level committed atomic action performed on the object.
If an application intends to perform two <code>enqueue</code> operations atomically, for example, you can nest the <code>enqueue</code> operations in another enclosing atomic action.
In addition, concurrent operations on such a persistent object are serialized, preventing inconsistencies in the state of the object.</p>
</div>
<div class="paragraph">
<p>However, since the elements of the <em>queue</em> objects are not individually concurrency controlled, certain combinations of concurrent operation invocations are executed serially, even though logically they could be executed concurrently.
An example of this is modifying the states of two different elements in the queue.
The platform Development Guide addresses some of these issues.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_failure_recovery"><a class="anchor" href="#_failure_recovery"></a>2.6. Failure Recovery</h3>
<div class="paragraph">
<p>In this chapter we shall cover information on failure recovery that is specific to ArjunaCore, TXOJ, or using Narayana outside the scope of a supported application server.</p>
</div>
<div class="sect3">
<h4 id="_embedding_the_recovery_manager"><a class="anchor" href="#_embedding_the_recovery_manager"></a>2.6.1. Embedding the Recovery Manager</h4>
<div class="paragraph">
<p>In some situations it may be required to embed the <code>RecoveryManager</code> in the same process as the transaction service.
In this case you can create an instance of the <code>RecoveryManager</code> through the manager method on <code>com.arjuna.ats.arjuna.recovery.RecoveryManager</code>.
A <code>RecoveryManager</code> can be created in one of two modes, selected via the parameter to the manager method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>i.
<code>INDIRECT_MANAGEMENT</code>: the manager runs periodically but can also be instructed to run when desired via the scan operation or through the RecoveryDriver class to be described below.</p>
</li>
<li>
<p>ii.
<code>DIRECT_MANAGEMENT</code>: the manager does not run periodically and must be driven directly via the scan operation or RecoveryDriver.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, the recovery manager listens on the first available port on a given machine.
If you wish to control the port number that it uses, you can specify this using the <code>com.arjuna.ats.arjuna.recovery.recoveryPort</code> attribute.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_additional_recovery_module_classes"><a class="anchor" href="#_additional_recovery_module_classes"></a>Additional Recovery Module Classes</h5>
<div class="paragraph">
<p>Narayana provides a set of recovery modules that are responsible to manage recovery according to the nature of the participant and its position in a transactional tree.
The provided classes over and above the ones covered elsewhere (that all implements the RecoveryModule interface) are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.arjuna.ats.internal.txoj.recovery.TORecoveryModule</code></p>
<div class="paragraph">
<p>Recovers Transactional Objects for Java.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_understanding_recovery_modules"><a class="anchor" href="#_understanding_recovery_modules"></a>2.6.2. Understanding Recovery Modules</h4>
<div class="paragraph">
<p>The failure recovery subsystem of Narayana will ensure that results of a transaction are applied consistently to all resources affected by the transaction, even if any of the application processes or the machine hosting them crash or lose network connectivity.
In the case of machine (system) crash or network failure, the recovery will not take place until the system or network are restored, but the original application does not need to be restarted – recovery responsibility is delegated to the Recovery Manager process (see below).
Recovery after failure requires that information about the transaction and the resources involved survives the failure and is accessible afterward: this information is held in the ActionStore, which is part of the <code>ObjectStore</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <code>ObjectStore</code> is destroyed or modified, recovery may not be possible.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Until the recovery procedures are complete, resources affected by a transaction that was in progress at the time of the failure may be inaccessible.
For database resources, this may be reported as tables or rows held by &#8220;in-doubt transactions&#8221;.
For TransactionalObjects for Java resources, an attempt to activate the Transactional Object (as when trying to get a lock) will fail.</p>
</div>
<div class="sect4">
<h5 id="_the_recovery_manager"><a class="anchor" href="#_the_recovery_manager"></a>The Recovery Manager</h5>
<div class="paragraph">
<p>The failure recovery subsystem of Narayana requires that the stand-alone Recovery Manager process be running for each <code>ObjectStore</code> (typically one for each node on the network that is running Narayana applications).
The <code>RecoveryManager</code> file is located in the package <code>com.arjuna.ats.arjuna.recovery.RecoveryManager</code>.
To start the Recovery Manager issue the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the -test flag is used with the Recovery Manager then it will display a &#8220;Ready&#8221; message when initialised, i.e.,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager -test</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuring_the_recovery_manager_2"><a class="anchor" href="#_configuring_the_recovery_manager_2"></a>Configuring the Recovery Manager</h5>
<div class="paragraph">
<p>The <code>RecoveryManager</code> reads the properties defined in the arjuna.properties file and then also reads the property file <code>RecoveryManager.properties</code>, from the same directory as it found the arjuna properties file.
An entry for a property in the <code>RecoveryManager</code> properties file will override an entry for the same property in the main TransactionService properties file.
Most of the entries are specific to the Recovery Manager.</p>
</div>
<div class="paragraph">
<p>A default version of <code>RecoveryManager.properties</code> is supplied with the distribution – this can be used without modification, except possibly the debug tracing fields (see below, Output).
The rest of this section discusses the issues relevant in setting the properties to other values (in the order of their appearance in the default version of the file).</p>
</div>
</div>
<div class="sect4">
<h5 id="_periodic_recovery_2"><a class="anchor" href="#_periodic_recovery_2"></a>Periodic Recovery</h5>
<div class="paragraph">
<p>The <code>RecoveryManager</code> scans the <code>ObjectStore</code> and other locations of information, looking for transactions and resources that require, or may require recovery.
The scans and recovery processing are performed by recovery modules, (instances of classes that implement the <code>com.arjuna.ats.arjuna.recovery.RecoveryModule</code> interface), each with responsibility for a particular category of transaction or resource.
The set of recovery modules used are dynamically loaded, using properties found in the <code>RecoveryManager</code> property file.</p>
</div>
<div class="paragraph">
<p>The interface has two methods: <code>periodicWorkFirstPass</code> and <code>periodicWorkSecondPass</code>.
At an interval (defined by property <code>com.arjuna.ats.arjuna.recovery.periodicRecoveryPeriod</code>), the <code>RecoveryManager</code> will call the first pass method on each property, then wait for a brief period (defined by property <code>com.arjuna.ats.arjuna.recovery.recoveryBackoffPeriod</code>), then call the second pass of each module.
Typically, in the first pass, the module scans (e.g. the relevant part of the <code>ObjectStore</code>) to find transactions or resources that are in-doubt (i.e. are part way through the commitment process).
On the second pass, if any of the same items are still in-doubt, it is possible the original application process has crashed and the item is a candidate for recovery.</p>
</div>
<div class="paragraph">
<p>An attempt, by the <code>RecoveryManager</code>, to recover a transaction that is still progressing in the original process(es) is likely to break the consistency.
Accordingly, the recovery modules use a mechanism (implemented in the <code>com.arjuna.ats.arjuna.recovery.TransactionStatusManager</code> package) to check to see if the original process is still alive, and if the transaction is still in progress.
The <code>RecoveryManager</code> only proceeds with recovery if the original process has gone, or, if still alive, the transaction is completed.
(If a server process or machine crashes, but the transaction-initiating process survives, the transaction will complete, usually generating a warning.
Recovery of such a transaction is the <code>RecoveryManager</code>’s responsibility).</p>
</div>
<div class="paragraph">
<p>It is clearly important to set the interval periods appropriately.
The total iteration time will be the sum of the <code>periodicRecoveryPeriod</code>, <code>recoveryBackoffPeriod</code> and the length of time it takes to scan the stores and to attempt recovery of any in-doubt transactions found, for all the recovery modules.
The recovery attempt time may include connection timeouts while trying to communicate with processes or machines that have crashed or are inaccessible (which is why there are mechanisms in the recovery system to avoid trying to recover the same transaction forever).
The total iteration time will affect how long a resource will remain inaccessible after a failure – <code>periodicRecoveryPeriod</code> should be set accordingly (default is 120 seconds).
The <code>recoveryBackoffPeriod</code> can be comparatively short (default is 10 seconds) – its purpose is mainly to reduce the number of transactions that are candidates for recovery and which thus require a “call to the original process to see if they are still in progress</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In previous versions of Narayana there was no contact mechanism, and the backoff period had to be long enough to avoid catching transactions in flight at all.
From 3.0, there is no such risk.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Two recovery modules (implementations of the <code>com.arjuna.ats.arjuna.recovery.RecoveryModule</code> interface) are supplied with Narayana, supporting various aspects of transaction recovery including JDBC recovery.
It is possible for advanced users to create their own recovery modules and register them with the Recovery Manager.
The recovery modules are registered with the <code>RecoveryManager</code> using <code>RecoveryEnvironmentBean.recoveryExtensions</code>.
These will be invoked on each pass of the periodic recovery in the sort-order of the property names – it is thus possible to predict the ordering (but note that a failure in an application process might occur while a periodic recovery pass is in progress).
The default Recovery Extension settings are:</p>
</div>
<div class="listingblock">
<div class="title">Recovery Environment Bean XML</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.recoveryExtensions</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    com.arjuna.ats.internal.arjuna.recovery.AtomicActionRecoveryModule
    com.arjuna.ats.internal.txoj.recovery.TORecoveryModule
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_expired_entry_removal_2"><a class="anchor" href="#_expired_entry_removal_2"></a>Expired entry removal</h5>
<div class="paragraph">
<p>The operation of the recovery subsystem will cause some entries to be made in the <code>ObjectStore</code> that will not be removed in normal progress.
The RecoveryManager has a facility for scanning for these and removing items that are very old.
Scans and removals are performed by implementations of the <code>com.arjuna.ats.arjuna.recovery.ExpiryScanner</code> interface.
Implementations of this interface are loaded by giving the class names as the value of a property <code>RecoveryEnvironmentBean.expiryScanners</code>.
The <code>RecoveryManager</code> calls the <code>scan()</code> method on each loaded Expiry Scanner implementation at an interval determined by the property <code>RecoveryEnvironmentBean.expiryScanInterval</code>”.
This value is given in hours – default is 12.
An expiryScanInterval value of zero will suppress any expiry scanning.
If the value as supplied is positive, the first scan is performed when <code>RecoveryManager</code> starts; if the value is negative, the first scan is delayed until after the first interval (using the absolute value)</p>
</div>
<div class="paragraph">
<p>The kinds of item that are scanned for expiry are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>TransactionStatusManager</code> items</dt>
<dd>
<p>one of these is created by every application process that uses Narayana – they contain the information that allows the <code>RecoveryManager</code> to determine if the process that initiated the transaction is still alive, and what the transaction status is.
The expiry time for these is set by the property <code>com.arjuna.ats.arjuna.recovery.transactionStatusManagerExpiryTime</code> (in hours – default is 12, zero means never expire).
The expiry time should be greater than the lifetime of any single Narayana-using process.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The Expiry Scanner properties for these are:</p>
</div>
<div class="listingblock">
<div class="title">Recovery Environment Bean XML</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.expiryScanners</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    com.arjuna.ats.internal.arjuna.recovery.ExpiredTransactionStatusManagerScanner
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To illustrate the behavior of a recovery module, the following pseudo code describes the basic algorithm used for Atomic Action transactions and Transactional Objects for java.</p>
</div>
<div class="listingblock">
<div class="title">AtomicAction pseudo code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">First Pass:
&lt; create a collection containing all transactions currently in the log &gt;

Second Pass:
while &lt; there are transactions in the collection &gt;
do
 if &lt; the intention list for the transaction still exists &gt;
 then
   &lt; create new transaction cached item &gt;
   &lt; obtain the status of the transaction &gt;

   if &lt; the transaction is not in progress (ie phase 2 has finished ) &gt;
   then
     &lt; replay phase two of the commit protocol &gt;
   endif.
 endif.
end while.</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Transactional Object pseudo code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">First Pass:
&lt; Create a hash table for uncommitted transactional objects. &gt;
&lt; Read in all transactional objects within the object store. &gt;
while &lt; there are transactional objects &gt;
do
   if &lt; the transactional object has an Uncommited status in the object store &gt;
   then
      &lt; add the transactional Object o the hash table for uncommitted transactional objects&gt;
   end if.
end while.

Second Pass:
while &lt; there are transactions in the hash table for uncommitted transactional objects &gt;
do
   if &lt; the transaction is still in the Uncommitted state &gt;
   then
      if &lt; the transaction is not in the Transaction Cache &gt;
      then
         &lt; check the status of the transaction with the original application process &gt;
         if &lt; the status is Rolled Back or the application process is inactive &gt;
            &lt; rollback the transaction by removing the Uncommitted status from the Object Store &gt;
         endif.
      endif.
   endif.
end while.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_writing_a_recovery_module"><a class="anchor" href="#_writing_a_recovery_module"></a>2.6.3. Writing a Recovery Module</h4>
<div class="paragraph">
<p>In order to recover from failure, we have seen that the Recovery Manager contacts recovery modules by invoking periodically the methods <code>periodicWorkFirstPass</code> and <code>periodicWorkSecondPass</code>.
Each Recovery Module is then able to manage recovery according the type of resources that need to be recovered.
The Narayana product is shipped with a set of recovery modules (<code>TOReceveryModule</code>, <code>XARecoveryModule</code>…), but it is possible for a user to define its own recovery module that fit his application.
The following basic example illustrates the steps needed to build such recovery module</p>
</div>
<div class="sect4">
<h5 id="_a_basic_scenario"><a class="anchor" href="#_a_basic_scenario"></a>A basic scenario</h5>
<div class="paragraph">
<p>This basic example does not aim to present a complete process to recover from failure, but mainly to illustrate the way to implement a recovery module.</p>
</div>
<div class="paragraph">
<p>The application used here consists to create an atomic transaction, to register a participant within the created transaction and finally to terminate it either by commit or abort.
A set of arguments are provided:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to decide to commit or abort the transaction,</p>
</li>
<li>
<p>to decide generating a crash during the commitment process.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The code of the main class that control the application is given below</p>
</div>
<div class="listingblock">
<div class="title">TestRecoveryModule.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.recoverymodule</span>;

<span class="keyword">import</span> <span class="include">com.arjuna.ats.arjuna.AtomicAction</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.arjuna.coordinator</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">TestRecoveryModule</span> {
    <span class="directive">protected</span> <span class="directive">static</span> <span class="type">boolean</span> _commit = <span class="predefined-constant">true</span>;
    <span class="directive">protected</span> <span class="directive">static</span> <span class="type">boolean</span> _crash = <span class="predefined-constant">false</span>;

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span> args<span class="type">[]</span>) {
        <span class="keyword">try</span> {
            AtomicAction tx = <span class="keyword">new</span> AtomicAction();
            <span class="comment">// Top level begin</span>
            tx.begin();

            <span class="comment">// enlist the participant</span>
            tx.add(SimpleRecord.create());

            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">About to complete the transaction </span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; args.length; i++) {
                <span class="keyword">if</span> ((args[i].compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">-commit</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>))
                    _commit = <span class="predefined-constant">true</span>;
                <span class="keyword">if</span> ((args[i].compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">-rollback</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>))
                    _commit = <span class="predefined-constant">false</span>;
                <span class="keyword">if</span> ((args[i].compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">-crash</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>))
                    _crash = <span class="predefined-constant">true</span>;
            }
            <span class="keyword">if</span> (_commit)
                <span class="comment">// Top level commit</span>
                tx.commit();
            <span class="keyword">else</span>
                <span class="comment">// Top level rollback</span>
                tx.abort();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            e.printStackTrace();
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The registered participant has the following behavior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>During the prepare phase, it writes a simple message - “I’m prepared”- on the disk such The message is written in a well known file</p>
</li>
<li>
<p>During the commit phase, it writes another message - “I’m committed”- in the same file used during prepare</p>
</li>
<li>
<p>If it receives an abort message, it removes from the disk the file used for prepare if any.</p>
</li>
<li>
<p>If a crash has been decided for the test, then it crashes during the commit phase – the file remains with the message “I’m prepared”.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The main portion of the code illustrating such behavior is described hereafter.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The location of the file given in variable filename can be changed</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">SimpleRecord.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.recoverymodule</span>;

<span class="keyword">import</span> <span class="include">com.arjuna.ats.arjuna.coordinator</span>.*;

<span class="keyword">import</span> <span class="include">java.io.File</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleRecord</span> <span class="directive">extends</span> AbstractRecord {
    <span class="directive">public</span> <span class="predefined-type">String</span> filename = <span class="string"><span class="delimiter">&quot;</span><span class="content">c:/tmp/RecordState</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">public</span> SimpleRecord() {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Creating new resource</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="directive">static</span> AbstractRecord create() {
        <span class="keyword">return</span> <span class="keyword">new</span> SimpleRecord();
    }

    <span class="directive">public</span> <span class="type">int</span> topLevelAbort() {
        <span class="keyword">try</span> {
            <span class="predefined-type">File</span> fd = <span class="keyword">new</span> <span class="predefined-type">File</span>(filename);
            <span class="keyword">if</span> (fd.exists()) {
                <span class="keyword">if</span> (fd.delete())
                    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">File Deleted</span><span class="delimiter">&quot;</span></span>);
            }
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
            <span class="comment">// …</span>
        }
        <span class="keyword">return</span> TwoPhaseOutcome.FINISH_OK;
    }

    <span class="directive">public</span> <span class="type">int</span> topLevelCommit() {
        <span class="keyword">if</span> (TestRecoveryModule._crash)
            <span class="predefined-type">System</span>.exit(<span class="integer">0</span>);
        <span class="keyword">try</span> {
            java.io.FileOutputStream file = <span class="keyword">new</span> java.io.FileOutputStream(
                    filename);
            java.io.PrintStream pfile = <span class="keyword">new</span> java.io.PrintStream(
                    file);
            pfile.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">I'm Committed</span><span class="delimiter">&quot;</span></span>);
            file.close();
        } <span class="keyword">catch</span> (java.io.IOException ex) {
            <span class="comment">// ...</span>
        }
        <span class="keyword">return</span> TwoPhaseOutcome.FINISH_OK;
    }

    <span class="directive">public</span> <span class="type">int</span> topLevelPrepare() {
        <span class="keyword">try</span> {
            java.io.FileOutputStream file = <span class="keyword">new</span> java.io.FileOutputStream(
                    filename);
            java.io.PrintStream pfile = <span class="keyword">new</span> java.io.PrintStream(
                    file);
            pfile.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">I'm prepared</span><span class="delimiter">&quot;</span></span>);
            file.close();
        } <span class="keyword">catch</span> (java.io.IOException ex) {
            <span class="comment">// ...</span>
        }
        <span class="keyword">return</span> TwoPhaseOutcome.PREPARE_OK;
    }
    <span class="comment">// …</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The role of the Recovery Module in such application consists to read the content of the file used to store the status of the participant, to determine that status and print a message indicating if a recovery action is needed or not.</p>
</div>
<div class="listingblock">
<div class="title">SimpleRecoveryModule.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.recoverymodule</span>;

<span class="keyword">import</span> <span class="include">com.arjuna.ats.arjuna.recovery.RecoveryModule</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleRecoveryModule</span> <span class="directive">implements</span> RecoveryModule {
    <span class="directive">public</span> <span class="predefined-type">String</span> filename = <span class="string"><span class="delimiter">&quot;</span><span class="content">c:/tmp/RecordState</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">public</span> SimpleRecoveryModule() {
        <span class="predefined-type">System</span>.out
                .println(<span class="string"><span class="delimiter">&quot;</span><span class="content">The SimpleRecoveryModule is loaded</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> periodicWorkFirstPass() {
        <span class="keyword">try</span> {
            java.io.FileInputStream file = <span class="keyword">new</span> java.io.FileInputStream(
                    filename);
            java.io.InputStreamReader input = <span class="keyword">new</span> java.io.InputStreamReader(
                    file);
            java.io.BufferedReader reader = <span class="keyword">new</span> java.io.BufferedReader(
                    input);
            <span class="predefined-type">String</span> stringState = reader.readLine();
            <span class="keyword">if</span> (stringState.compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">I'm prepared</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>)
                <span class="predefined-type">System</span>.out
                        .println(<span class="string"><span class="delimiter">&quot;</span><span class="content">The transaction is in the prepared state</span><span class="delimiter">&quot;</span></span>);
            file.close();
        } <span class="keyword">catch</span> (java.io.IOException ex) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Nothing found on the Disk</span><span class="delimiter">&quot;</span></span>);
        }
    }

    <span class="directive">public</span> <span class="type">void</span> periodicWorkSecondPass() {
        <span class="keyword">try</span> {
            java.io.FileInputStream file = <span class="keyword">new</span> java.io.FileInputStream(
                    filename);
            java.io.InputStreamReader input = <span class="keyword">new</span> java.io.InputStreamReader(
                    file);
            java.io.BufferedReader reader = <span class="keyword">new</span> java.io.BufferedReader(
                    input);
            <span class="predefined-type">String</span> stringState = reader.readLine();
            <span class="keyword">if</span> (stringState.compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">I'm prepared</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>) {
                <span class="predefined-type">System</span>.out
                        .println(<span class="string"><span class="delimiter">&quot;</span><span class="content">The record is still in the prepared state</span><span class="delimiter">&quot;</span></span>);
                <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">– Recovery is needed</span><span class="delimiter">&quot;</span></span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (stringState
                    .compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">I'm Committed</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>) {
                <span class="predefined-type">System</span>.out
                        .println(<span class="string"><span class="delimiter">&quot;</span><span class="content">The transaction has completed and committed</span><span class="delimiter">&quot;</span></span>);
            }
            file.close();
        } <span class="keyword">catch</span> (java.io.IOException ex) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Nothing found on the Disk</span><span class="delimiter">&quot;</span></span>);
            <span class="predefined-type">System</span>.out
                    .println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Either there was no transaction</span><span class="delimiter">&quot;</span></span>);
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">or it as been rolled back</span><span class="delimiter">&quot;</span></span>);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The recovery module should now be deployed in order to be called by the Recovery Manager.
To do so, we just need to add an entry in the config file for the extension:</p>
</div>
<div class="listingblock">
<div class="title">Recovery Environment Bean Recovery Extensions XML</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.recoveryExtenstions</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    com.arjuna.demo.recoverymodule.SimpleRecoveryModule
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once started, the Recovery Manager will automatically load the listed Recovery modules.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The source of the code can be retrieved under the trailmap directory of the Narayana installation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_another_scenario"><a class="anchor" href="#_another_scenario"></a>Another scenario</h5>
<div class="paragraph">
<p>As mentioned, the basic application presented above does not present the complete process to recover from failure, but it was just presented to describe how the build a recovery module.
In case of the OTS protocol, let’s consider how a recovery module that manages recovery of OTS resources can be configured.</p>
</div>
<div class="paragraph">
<p>To manage recovery in case of failure, the OTS specification has defined a recovery protocol.
Transaction’s participants in a doubt status could use the <code>RecoveryCoordinator</code> to determine the status of the transaction.
According to that transaction status, those participants can take appropriate decision either by roll backing or committing.
Asking the <code>RecoveryCoordinator</code> object to determine the status consists of invoke the <code>replay_completion</code> operation on the <code>RecoveryCoordinator</code>.</p>
</div>
<div class="paragraph">
<p>For each OTS Resource in a doubt status, it is well known which RecoveyCoordinator to invoke to determine the status of the transaction in which the Resource is involved – It’s the <code>RecoveryCoordinator</code> returned during the Resource registration process.
Retrieving such <code>RecoveryCoordinator</code> per resource means that it has been stored in addition to other information describing the resource.</p>
</div>
<div class="paragraph">
<p>A recovery module dedicated to recover OTS Resources could have the following behavior.
When requested by the recovery Manager on the first pass it retrieves from the disk the list of resources that are in the doubt status.
During the second pass, if the resources that were retrieved in the first pass still remain in the disk then they are considered as candidates for recovery.
Therefore, the Recovery Module retrieves for each candidate its associated <code>RecoveryCoordinator</code> and invokes the replay_completion operation that the status of the transaction.
According to the returned status, an appropriate action would be taken (for instance, rollback the resource is the status is aborted or inactive).</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jta"><a class="anchor" href="#_jta"></a>3. JTA</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_administration_2"><a class="anchor" href="#_administration_2"></a>3.1. Administration</h3>
<div class="sect3">
<h4 id="jta_introduction"><a class="anchor" href="#jta_introduction"></a>3.1.1. Introduction</h4>
<div class="paragraph">
<p>The notions explained here are to be considered as extensions of what has already been presented in the <a href="#important_points_for_administrators">General Procedures' Administration section</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_and_stopping_the_transaction_manager"><a class="anchor" href="#_starting_and_stopping_the_transaction_manager"></a>3.1.2. Starting and Stopping the Transaction Manager</h4>
<div class="paragraph">
<p>By default, the transaction manager starts up in an active state such that new transactions can be created immediately.
If you wish to have more control over this it is possible to set the <code>CoordinatorEnvironmentBean.startDisabled</code> configuration option to <code>YES</code> and in which case no transactions can be created until the transaction manager is enabled via a call to method <code>TxControl.enable</code>).</p>
</div>
<div class="paragraph">
<p>It is possible to stop the creation of new transactions at any time by calling method <code>TxControl.disable</code>.
Transactions that are currently executing will not be affected.
By default, recovery will be allowed to continue and the transaction system will still be available to manage recovery requests from other instances in a distributed environment.
(See the Failure Recovery Guide for further details).
However, if you wish to disable recovery as well as remove any resources it maintains, then you can pass <code>true</code> to method <code>TxControl.disable</code>; the default is to use <code>false</code>.</p>
</div>
<div class="paragraph">
<p>If you wish to shut the system down completely then it may also be necessary to terminate the background transaction reaper (see the Programmers Guide for information about what the reaper does).
In order to do this you may want to first prevent the creation of new transactions (if you are not creating transactions with timeouts then this step is not necessary) using method <code>TxControl.disable</code>.
Then you should call method <code>TransactionReaper.terminate</code>.
This method takes a Boolean parameter: if <code>true</code> then the method will wait for the normal timeout periods associated with any transactions to expire before terminating the transactions; if <code>false</code> then transactions will be forced to terminate (rollback or have their outcome set such that they can only ever rollback) immediately.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>if you intend to restart the recovery manager later after having terminated, it then you MUST use the <code>TransactionReapear.terminate</code> method with asynchronous behavior set to <code>false</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_selecting_the_jta_implementation"><a class="anchor" href="#_selecting_the_jta_implementation"></a>3.1.3. Selecting the JTA implementation</h4>
<div class="paragraph">
<p>Two variants of the JTA implementation are accessible through the same interface.
These are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Purely local JTA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only non-distributed JTA transactions are executed. This is the only version available with the Narayana distribution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remote, CORBA-based JTA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executes distributed JTA transactions. This functionality is provided by the JTS distribution and requires a supported CORBA ORB. Consult the JTS Installation and Administration Guide for more information.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Both of these implementations are fully compatible with the transactional JDBC driver.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the property <code>JTAEnvironmentBean.jtaTMImplementation</code> to value <code>com.arjuna.ats.internal.jta.transaction.arjunacore.TransactionManagerImple</code>.</p>
</li>
<li>
<p>Set the property <code>JTAEnvironmentBean.jtaUTImplementation</code> to value <code>com.arjuna.ats.internal.jta.transaction.arjunacore.UserTransactionImple</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These settings are the default values for the properties, so nothing needs to be changed to use the local implementation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_development"><a class="anchor" href="#_development"></a>3.2. Development</h3>
<div class="sect3">
<h4 id="_jdbc_and_transactions"><a class="anchor" href="#_jdbc_and_transactions"></a>3.2.1. JDBC and Transactions</h4>
<div class="sect4">
<h5 id="_using_the_transactional_jdbc_driver"><a class="anchor" href="#_using_the_transactional_jdbc_driver"></a>Using the transactional JDBC driver</h5>
<div class="paragraph">
<p>Narayana supports construction of both local and distributed transactional applications which access databases using the JDBC APIs.
JDBC supports two-phase commit of transactions, and is similar to the XA X/Open standard. Narayana provides JDBC support in package <code>com.arjuna.ats.jdbc</code>.
A list of the tested drivers is available from the Narayana website.</p>
</div>
<div class="paragraph">
<p>Only use the transactional JDBC support provided in package <code>com.arjuna.ats.jdbc</code> when you are using Narayana outside of an application server, such as WildFly Application Server, or another container.
Otherwise, use the JDBC support provided by your application server or container.</p>
</div>
<div class="sect5">
<h6 id="_managing_transactions"><a class="anchor" href="#_managing_transactions"></a>Managing transactions</h6>
<div class="paragraph">
<p>Narayana needs the ability to associate work performed on a JDBC connection with a specific transaction.
Therefore, applications need to use a combination of implicit transaction propagation and indirect transaction management.
For each JDBC connection, Narayana must be able to determine the invoking thread&#8217;s current transaction context.</p>
</div>
</div>
<div class="sect5">
<h6 id="_restrictions"><a class="anchor" href="#_restrictions"></a>Restrictions</h6>
<div class="paragraph">
<p>Nested transactions are not supported by JDBC.
If you try to use a JDBC connection within a subtransaction, Narayana throws a suitable exception and no work is allowed on that connection.
However, if you need nested transactions, and are comfortable with straying from the JDBC standard, you can set property <code>com.arjuna.ats.jta.supportSubtransactions</code> property to <code>YES</code>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_transactional_drivers"><a class="anchor" href="#_transactional_drivers"></a>Transactional drivers</h5>
<div class="paragraph">
<p>The approach Narayana takes for incorporating JDBC connections within transactions is to provide transactional JDBC drivers as conduits for all interactions.
These drivers intercept all invocations and ensure that they are registered with, and driven by, appropriate transactions.
The driver <code>com.arjuna.ats.jdbc.TransactionalDriver</code> handles all JDBC drivers, implementing the <code>java.sql.Driver</code> interface.
If the database is not transactional, ACID properties cannot be guaranteed.</p>
</div>
<div class="sect5">
<h6 id="_loading_drivers"><a class="anchor" href="#_loading_drivers"></a>Loading drivers</h6>
<div class="listingblock">
<div class="title">Instantiating and using the driver within an application</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TransactionalDriver arjunaJDBC2Driver = <span class="keyword">new</span> TransactionalDriver(); </code></pre>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 9. Registering the drivers with the JDBC driver manager using the Java system properties</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Properties</span> p = <span class="predefined-type">System</span>.getProperties();

<span class="keyword">switch</span> (dbType) {
<span class="keyword">case</span> MYSQL:
    p.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc.drivers</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">com.mysql.jdbc.Driver</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">break</span>;
<span class="keyword">case</span> PGSQL:
    p.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc.drivers</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.postgresql.Driver</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">break</span>;
}

<span class="predefined-type">System</span>.setProperties(p);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The jdbc.drivers property contains a colon-separated list of driver class names, which the JDBC driver manager loads when it is initialized.
After the driver is loaded, you can use it to make a connection with a database.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 10. Using the <code>Class.forName</code> method</div>
<div class="content">
<div class="paragraph">
<p>Calling <code>Class.forName()</code> automatically registers the driver with the JDBC driver manager.
It is also possible to explicitly create an instance of the JDBC driver.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">sun.jdbc.odbc.JdbcOdbcDriver drv = <span class="keyword">new</span> sun.jdbc.odbc.JdbcOdbcDriver();

<span class="predefined-type">DriverManager</span>.registerDriver(drv);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_connections"><a class="anchor" href="#_connections"></a>Connections</h5>
<div class="paragraph">
<p>Because Narayana provides JDBC connectivity via its own JDBC driver, application code can support transactions with relatively small code changes.
Typically, the application programmer only needs to start and terminate transactions.</p>
</div>
<div class="sect5">
<h6 id="_jdbc"><a class="anchor" href="#_jdbc"></a>JDBC</h6>
<div class="paragraph">
<p>The Narayana driver accepts the following properties, all located in class <code>com.arjuna.ats.jdbc.TransactionalDriver</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the database username</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the database password</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">createDb</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">creates the database automatically if set to <code>true</code>. Not all JDBC implementations support this.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dynamicClass</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">specifies a class to instantiate to connect to the database, instead of using JNDI.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="_xadatasources"><a class="anchor" href="#_xadatasources"></a>XADataSources</h6>
<div class="paragraph">
<p>JDBC connections are created from appropriate DataSources.
Connections which participate in distributed transactions are obtained from XADataSources.
When using a JDBC driver, Narayana uses the appropriate <code>DataSource</code> whenever a connection to the database is made.
It then obtains XAResources and registers them with the transaction via the JTA interfaces.
The transaction service uses these XAResources when the transaction terminates in order to drive the database to either commit or roll back the changes made via the JDBC connection.</p>
</div>
<div class="paragraph">
<p>Narayana JDBC support can obtain XADataSources through the Java Naming and Directory Interface (JNDI) or dynamic class instantiation.</p>
</div>
<div class="sect6">
<h7 id="_java_naming_and_directory_interface_jndi"><a class="anchor" href="#_java_naming_and_directory_interface_jndi"></a>Java naming and directory interface (JNDI)</h7>
<div class="paragraph">
<p>A JDBC driver can use arbitrary <code>DataSources</code> without having to know specific details about their implementations, by using JNDI.
A specific <code>DataSource</code> or <code>XADataSource</code> can be created and registered with an appropriate JNDI implementation, and the application, or JDBC driver, can later bind to and use it.
Since JNDI only allows the application to see the <code>DataSource</code> or <code>XADataSource</code> as an instance of the interface (e.g., <code>javax.sql.XADataSource</code>) rather than as an instance of the implementation class (e.g., <code>com.mydb.myXADataSource</code>), the application is not tied at build-time to only use a specific implementation.</p>
</div>
<div class="paragraph">
<p>For the <code>TransactionalDriver</code> class to use a JNDI-registered <code>XADataSource</code>, you need to create the <code>XADataSource</code> instance and store it in an appropriate JNDI implementation.
Details of how to do this can be found in the JDBC tutorial available at the Java website.</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. Storing a datasource in a JNDI implementation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">XADataSource</span> ds = MyXADataSource();
<span class="predefined-type">Hashtable</span> env = <span class="keyword">new</span> <span class="predefined-type">Hashtable</span>();
<span class="predefined-type">String</span> initialCtx = PropertyManager.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Context.INITIAL_CONTEXT_FACTORY</span><span class="delimiter">&quot;</span></span>);

env.put(<span class="predefined-type">Context</span>.INITIAL_CONTEXT_FACTORY, initialCtx);

initialContext ctx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>(env);

ctx.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc/foo</span><span class="delimiter">&quot;</span></span>, ds);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Context.INITIAL_CONTEXT_FACTORY</code> property is the JNDI way of specifying the type of JNDI implementation to use.</p>
</div>
<div class="paragraph">
<p>The application must pass an appropriate connection URL to the JDBC driver:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Properties</span> dbProps = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();

dbProps.setProperty(TransactionalDriver.userName, <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>);
dbProps.setProperty(TransactionalDriver.password, <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// the driver uses its own JNDI context info, remember to set it up:</span>
jdbcPropertyManager.propertyManager.setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Context.INITIAL_CONTEXT_FACTORY</span><span class="delimiter">&quot;</span></span>, initialCtx);
jdbcPropertyManager.propertyManager.setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Context.PROVIDER_URL</span><span class="delimiter">&quot;</span></span>, myUrl);

TransactionalDriver arjunaJDBCDriver = <span class="keyword">new</span> TransactionalDriver();
<span class="predefined-type">Connection</span> connection = arjunaJDBCDriver.connect(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:arjuna:jdbc/foo</span><span class="delimiter">&quot;</span></span>, dbProps);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JNDI URL must be pre-pended with <code>jdbc:arjuna:</code> in order for the <code>TransactionalDriver</code> to recognize that the <code>DataSource</code> must participate within transactions and be driven accordingly.</p>
</div>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_dynamic_class_instantiation"><a class="anchor" href="#_dynamic_class_instantiation"></a>Dynamic class instantiation</h7>
<div class="paragraph">
<p>If a JNDI implementation is not available. you can specify an implementation of the <code>DynamicClass</code> interface, which is used to get the <code>XADataSource</code> object.
This is not recommended, but provides a fallback for environments where use of JNDI is not feasible.</p>
</div>
<div class="paragraph">
<p>Use the property <code>TransactionalDriver.dynamicClass</code> to specify the implementation to use.
An example is <code>PropertyFileDynamicClass</code>, a DynamicClass implementation that reads the <code>XADataSource</code> implementation class name and configuration properties from a file, then instantiates and configures it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Deprecated class</div>
<div class="paragraph">
<p>The oracle_8_1_6 dynamic class is deprecated and should not be used.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 12. Instantiating a dynamic class</div>
<div class="content">
<div class="paragraph">
<p>The application code must specify which dynamic class the TransactionalDriver should instantiate when setting up the connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Properties</span> dbProps = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();

dbProps.setProperty(TransactionalDriver.userName, <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>);
dbProps.setProperty(TransactionalDriver.password, <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>);
dbProps.setProperty(TransactionalDriver.dynamicClass, <span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.jdbc.drivers.PropertyFileDynamicClass</span><span class="delimiter">&quot;</span></span>);

TransactionalDriver arjunaJDBC2Driver = <span class="keyword">new</span> TransactionalDriver();
<span class="predefined-type">Connection</span> connection = arjunaJDBC2Driver.connect(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:arjuna:/path/to/property/file</span><span class="delimiter">&quot;</span></span>, dbProperties);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_using_the_connection"><a class="anchor" href="#_using_the_connection"></a>Using the connection</h6>
<div class="paragraph">
<p>Once the connection is established, all operations on the connection are monitored by Narayana. you do not need to use the transactional connection within transactions.
If a transaction is not present when the connection is used, then operations are performed directly on the database.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>JDBC does not support subtransactions.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can use transaction timeouts to automatically terminate transactions if a connection is not terminated within an appropriate period.</p>
</div>
<div class="paragraph">
<p>You can use Narayana connections within multiple transactions simultaneously.
An example would be different threads, with different notions of the current transaction. Narayana does connection pooling for each transaction within the JDBC connection.
Although multiple threads may use the same instance of the JDBC connection, internally there may be a separate connection for each transaction.
With the exception of method <code>close</code>, all operations performed on the connection at the application level are only performed on this transaction-specific connection.</p>
</div>
<div class="paragraph">
<p>Narayana automatically registers the JDBC driver connection with the transaction via an appropriate resource.
When the transaction terminates, this resource either commits or rolls back any changes made to the underlying database via appropriate calls on the JDBC driver.</p>
</div>
<div class="paragraph">
<p>Once created, the driver and any connection can be used in the same way as any other JDBC driver or connection.</p>
</div>
<div class="listingblock">
<div class="title">Creating and using a connection</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Statement</span> stmt = conn.createStatement();

<span class="keyword">try</span> {
    stmt.executeUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE TABLE test_table (a INTEGER,b INTEGER)</span><span class="delimiter">&quot;</span></span>);
} <span class="keyword">catch</span> (<span class="exception">SQLException</span> e) {
    <span class="comment">// table already exists</span>
}

stmt.executeUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO test_table (a, b) VALUES (1,2)</span><span class="delimiter">&quot;</span></span>);

<span class="predefined-type">ResultSet</span> res1 = stmt.executeQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM test_table</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_connection_pooling"><a class="anchor" href="#_connection_pooling"></a>Connection pooling</h6>
<div class="paragraph">
<p>For each username and password, Narayana maintains a single instance of each connection for as long as that connection is in use.
Subsequent requests for the same connection get a reference to the original connection, rather than a new instance.
You can try to close the connection, but the connection will only actually be closed when all users (including transactions) have either finished with the connection, or issued <code>close</code> calls.</p>
</div>
</div>
<div class="sect5">
<h6 id="_reusing_connections"><a class="anchor" href="#_reusing_connections"></a>Reusing connections</h6>
<div class="paragraph">
<p>Some JDBC drivers allow the reuse of a connection for multiple different transactions once a given transaction completes.
Unfortunately this is not a common feature, and other drivers require a new connection to be obtained for each new transaction.
By default, the Narayana transactional driver always obtains a new connection for each new transaction.
However, if an existing connection is available and is currently unused, Narayana can reuse this connection.
To turn on this feature, add option <code>reuseconnection=true</code> to the JDBC URL.
For instance, <code>jdbc:arjuna:sequelink://host:port;databaseName=foo;reuseconnection=true</code></p>
</div>
</div>
<div class="sect5">
<h6 id="_terminating_the_transaction"><a class="anchor" href="#_terminating_the_transaction"></a>Terminating the transaction</h6>
<div class="paragraph">
<p>When a transaction with an associated JDBC connection terminates, because of the application or because a transaction timeout expires, Narayana uses the JDBC driver to drive the database to either commit or roll back any changes made to it.
This happens transparently to the application.</p>
</div>
</div>
<div class="sect5">
<h6 id="_autocommit"><a class="anchor" href="#_autocommit"></a>AutoCommit</h6>
<div class="paragraph">
<p>If property <code>AutoCommit</code> of the interface <code>java.sql.Connection</code> is set to <code>true</code> for JDBC, the execution of every SQL statement is a separate top-level transaction, and it is not possible to group multiple statements to be managed within a single OTS transaction.
Therefore, Narayana disables <code>AutoCommit</code> on JDBC connections before they can be used.
If <code>AutoCommit</code> is later set to <code>true</code> by the application, Narayana throws the <code>java.sql.SQLException</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_setting_isolation_levels"><a class="anchor" href="#_setting_isolation_levels"></a>Setting isolation levels</h6>
<div class="paragraph">
<p>When you use the Narayana JDBC driver, you may need to set the underlying transaction isolation level on the XA connection.
By default, this is set to <code>TRANSACTION_SERIALIZABLE</code>, but another value may be more appropriate for your application.
To change it, set the property <code>com.arjuna.ats.jdbc.isolationLevel</code> to the appropriate isolation level in string form.
Example values are <code>TRANSACTION_READ_COMMITTED</code> or <code>TRANSACTION_REPEATABLE_READ</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Currently, this property applies to all XA connections created in the JVM.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_examples"><a class="anchor" href="#_examples"></a>3.2.2. Examples</h4>
<div class="sect4">
<h5 id="_jdbc_example"><a class="anchor" href="#_jdbc_example"></a>JDBC example</h5>
<div class="paragraph">
<p>This simplified example assumes that you are using the transactional JDBC driver provided with Narayana.
For details about how to configure and use this driver see the previous Chapter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JDBCTest</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {

        <span class="predefined-type">Connection</span> conn = <span class="predefined-constant">null</span>;
        <span class="predefined-type">Connection</span> conn2 = <span class="predefined-constant">null</span>;
        <span class="comment">// non-tx statement</span>
        <span class="predefined-type">Statement</span> stmt = <span class="predefined-constant">null</span>;
        <span class="comment">// will be a tx-statement</span>
        <span class="predefined-type">Statement</span> stmtx = <span class="predefined-constant">null</span>;
        <span class="predefined-type">Properties</span> dbProperties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();

        <span class="keyword">try</span> {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="content">Creating connection to database: </span><span class="delimiter">&quot;</span></span> + url);

            <span class="comment">/*
             * Create conn and conn2 so that they are bound to the JBossTS
             * transactional JDBC driver. The details of how to do this will
             * depend on your environment, the database you wish to use and
             * whether or not you want to use the Direct or JNDI approach. See
             * the appropriate chapter in the JTA Programmers Guide.
             */</span>

            stmt = conn.createStatement();  <span class="comment">// non-tx statement</span>

            <span class="keyword">try</span> {
                stmt.executeUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">DROP TABLE test_table</span><span class="delimiter">&quot;</span></span>);
                stmt.executeUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">DROP TABLE test_table2</span><span class="delimiter">&quot;</span></span>);
            } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
                <span class="comment">// assume not in database.</span>
            }

            <span class="keyword">try</span> {
                stmt.executeUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE TABLE test_table (a INTEGER,b INTEGER)</span><span class="delimiter">&quot;</span></span>);
                stmt.executeUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE TABLE test_table2 (a INTEGER,b INTEGER)</span><span class="delimiter">&quot;</span></span>);
            } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            }

            <span class="keyword">try</span> {
                <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Starting top-level transaction.</span><span class="delimiter">&quot;</span></span>);

                com.arjuna.ats.jta.UserTransaction.userTransaction().begin();

                stmtx = conn.createStatement(); <span class="comment">// will be a tx-statement</span>

                <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="content">Adding entries to table 1.</span><span class="delimiter">&quot;</span></span>);

                stmtx.executeUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO test_table (a, b) VALUES (1,2)</span><span class="delimiter">&quot;</span></span>);

                <span class="predefined-type">ResultSet</span> res1 = <span class="predefined-constant">null</span>;

                <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="content">Inspecting table 1.</span><span class="delimiter">&quot;</span></span>);

                res1 = stmtx.executeQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM test_table</span><span class="delimiter">&quot;</span></span>);
                <span class="keyword">while</span> (res1.next()) {
                    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Column 1: </span><span class="delimiter">&quot;</span></span> + res1.getInt(<span class="integer">1</span>));
                    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Column 2: </span><span class="delimiter">&quot;</span></span> + res1.getInt(<span class="integer">2</span>));
                }

                <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="content">Adding entries to table 2.</span><span class="delimiter">&quot;</span></span>);

                stmtx.executeUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO test_table2 (a, b) VALUES (3,4)</span><span class="delimiter">&quot;</span></span>);
                res1 = stmtx.executeQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM test_table2</span><span class="delimiter">&quot;</span></span>);
                <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="content">Inspecting table 2.</span><span class="delimiter">&quot;</span></span>);

                <span class="keyword">while</span> (res1.next()) {
                    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Column 1: </span><span class="delimiter">&quot;</span></span> + res1.getInt(<span class="integer">1</span>));
                    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Column 2: </span><span class="delimiter">&quot;</span></span> + res1.getInt(<span class="integer">2</span>));
                }
                <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="content">Now attempting to rollback changes.</span><span class="delimiter">&quot;</span></span>);
                com.arjuna.ats.jta.UserTransaction.userTransaction().rollback();

                com.arjuna.ats.jta.UserTransaction.userTransaction().begin();
                stmtx = conn.createStatement();
                <span class="predefined-type">ResultSet</span> res2 = <span class="predefined-constant">null</span>;

                <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="content">Now checking state of table 1.</span><span class="delimiter">&quot;</span></span>);

                res2 = stmtx.executeQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM test_table</span><span class="delimiter">&quot;</span></span>);
                <span class="keyword">while</span> (res2.next()) {
                    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Column 1: </span><span class="delimiter">&quot;</span></span> + res2.getInt(<span class="integer">1</span>));
                    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Column 2: </span><span class="delimiter">&quot;</span></span> + res2.getInt(<span class="integer">2</span>));
                }

                <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="content">Now checking state of table 2.</span><span class="delimiter">&quot;</span></span>);

                stmtx = conn.createStatement();
                res2 = stmtx.executeQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM test_table2</span><span class="delimiter">&quot;</span></span>);
                <span class="keyword">while</span> (res2.next()) {
                    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Column 1: </span><span class="delimiter">&quot;</span></span> + res2.getInt(<span class="integer">1</span>));
                    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Column 2: </span><span class="delimiter">&quot;</span></span> + res2.getInt(<span class="integer">2</span>));
                }

                com.arjuna.ats.jta.UserTransaction.userTransaction().commit(<span class="predefined-constant">true</span>);
            } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
                ex.printStackTrace();
                <span class="predefined-type">System</span>.exit(<span class="integer">0</span>);
            }
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> sysEx) {
            sysEx.printStackTrace();
            <span class="predefined-type">System</span>.exit(<span class="integer">0</span>);
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_failure_recovery_example_with_basicxarecovery"><a class="anchor" href="#_failure_recovery_example_with_basicxarecovery"></a>Failure recovery example with BasicXARecovery</h5>
<div class="paragraph">
<p>This class implements the <code>XAResourceRecovery</code> interface for <code>XAResources</code>.
The parameter supplied in <code>setParameters</code> can contain arbitrary information necessary to initialize the class once created.
In this example, it contains the name of the property file in which the database connection information is specified, as well as the number of connections that this file contains information on.
Each item is separated by a semicolon.</p>
</div>
<div class="paragraph">
<p>This is only a small example of the sorts of things an <code>XAResourceRecovery</code> implementer could do.
This implementation uses a property file that is assumed to contain sufficient information to recreate connections used during the normal run of an application so that recovery can be performed on them.
Typically, user-names and passwords should never be presented in raw text on a production system.</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. Database parameter format for the properties file</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre> DB_x_DatabaseURL=
 DB_x_DatabaseUser=
 DB_x_DatabasePassword=
 DB_x_DatabaseDynamicClass=</pre>
</div>
</div>
<div class="paragraph">
<p><code>x</code> is the number of the connection information.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Some error-handling code is missing from this example, to make it more readable.</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. Failure recovery example with BasicXARecovery</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/*
 * Some XAResourceRecovery implementations will do their startup work here,
 * and then do little or nothing in setDetails. Since this one needs to know
 * dynamic class name, the constructor does nothing.
 */</span>

<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> dbTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">DB_</span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> urlTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">_DatabaseURL</span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> passwordTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">_DatabasePassword</span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> userTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">_DatabaseUser</span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> dynamicClassTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">_DatabaseDynamicClass</span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> jndiTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">JNDI_</span><span class="delimiter">&quot;</span></span>;
<span class="comment">/*
 * Example:
 *
 * DB2_DatabaseURL=jdbc\:arjuna\:sequelink\://qa02\:20001
 * DB2_DatabaseUser=tester2 DB2_DatabasePassword=tester
 * DB2_DatabaseDynamicClass=com.arjuna.ats.internal.jdbc.drivers.sequelink_5_1
 *
 * DB_JNDI_DatabaseURL=jdbc\:arjuna\:jndi DB_JNDI_DatabaseUser=tester1
 * DB_JNDI_DatabasePassword=tester DB_JNDI_DatabaseName=empay
 * DB_JNDI_Host=qa02 DB_JNDI_Port=20000
 */</span>
<span class="comment">// delimiter for parameters</span>
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">char</span> BREAKCHARACTER = <span class="string"><span class="delimiter">'</span><span class="content">;</span><span class="delimiter">'</span></span>;
<span class="directive">private</span> <span class="type">int</span> numberOfConnections;
<span class="directive">private</span> <span class="type">int</span> connectionIndex;
<span class="directive">private</span> <span class="predefined-type">Properties</span> props;
<span class="directive">public</span> BasicXARecovery() <span class="directive">throws</span> <span class="exception">SQLException</span> {
    numberOfConnections = <span class="integer">1</span>;
    connectionIndex = <span class="integer">0</span>;
    props = <span class="predefined-constant">null</span>;
}

<span class="comment">/**
 * The recovery module will have chopped off this class name already. The
 * parameter should specify a property file from which the url, user name,
 * password, etc. can be read.
 *
 * @message com.arjuna.ats.internal.jdbc.recovery.initexp An exception
 * occurred during initialisation.
 */</span>

<span class="directive">public</span> <span class="type">boolean</span> initialise(<span class="predefined-type">String</span> parameter) <span class="directive">throws</span> <span class="exception">SQLException</span> {
    <span class="keyword">if</span> (parameter == <span class="predefined-constant">null</span>)
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;

    <span class="type">int</span> breakPosition = parameter.indexOf(BREAKCHARACTER);
    <span class="predefined-type">String</span> fileName = parameter;

    <span class="keyword">if</span> (breakPosition != -<span class="integer">1</span>) {
        fileName = parameter.substring(<span class="integer">0</span>, breakPosition - <span class="integer">1</span>);

        <span class="keyword">try</span> {
            numberOfConnections = <span class="predefined-type">Integer</span>.parseInt(parameter.substring(breakPosition + <span class="integer">1</span>));
        } <span class="keyword">catch</span> (<span class="exception">NumberFormatException</span> e) {
            <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        }
    }

    <span class="keyword">try</span> {
        <span class="predefined-type">String</span> uri = com.arjuna.common.util.FileLocator.locateFile(fileName);
        jdbcPropertyManager.propertyManager.load(XMLFilePlugin.class.getName(), uri);

        props = jdbcPropertyManager.propertyManager.getProperties();
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }

    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
}

<span class="comment">/**
 * @message com.arjuna.ats.internal.jdbc.recovery.xarec {0} could not find
 * information for connection!
 */</span>

<span class="directive">public</span> <span class="directive">synchronized</span> <span class="predefined-type">XAResource</span> getXAResource() <span class="directive">throws</span> <span class="exception">SQLException</span> {
    JDBC2RecoveryConnection conn = <span class="predefined-constant">null</span>;

    <span class="keyword">if</span> (hasMoreResources()) {
        connectionIndex++;

        conn = getStandardConnection();

        <span class="keyword">if</span> (conn == <span class="predefined-constant">null</span>) conn = getJNDIConnection();
    }

    <span class="keyword">return</span> conn.recoveryConnection().getConnection().getXAResource();
}

<span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> hasMoreResources() {
    <span class="keyword">if</span> (connectionIndex == numberOfConnections)
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    <span class="keyword">else</span>
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
}

<span class="directive">private</span> <span class="directive">final</span> JDBC2RecoveryConnection getStandardConnection() <span class="directive">throws</span> <span class="exception">SQLException</span> {
    <span class="predefined-type">String</span> number = <span class="keyword">new</span> <span class="predefined-type">String</span>(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> + connectionIndex);
    <span class="predefined-type">String</span> url = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + number + urlTag);
    <span class="predefined-type">String</span> password = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + number + passwordTag);
    <span class="predefined-type">String</span> user = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + number + userTag);
    <span class="predefined-type">String</span> dynamicClass = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + number + dynamicClassTag);

    <span class="predefined-type">Properties</span> dbProperties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();

    <span class="predefined-type">String</span> theUser = props.getProperty(user);
    <span class="predefined-type">String</span> thePassword = props.getProperty(password);

    <span class="keyword">if</span> (theUser != <span class="predefined-constant">null</span>) {
        dbProperties.put(TransactionalDriver.userName, theUser);
        dbProperties.put(TransactionalDriver.password, thePassword);

        <span class="predefined-type">String</span> dc = props.getProperty(dynamicClass);

        <span class="keyword">if</span> (dc != <span class="predefined-constant">null</span>)
            dbProperties.put(TransactionalDriver.dynamicClass, dc);

        <span class="keyword">return</span> <span class="keyword">new</span> JDBC2RecoveryConnection(url, dbProperties);
    } <span class="keyword">else</span>
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
}

<span class="directive">private</span> <span class="directive">final</span> JDBC2RecoveryConnection getJNDIConnection() <span class="directive">throws</span> <span class="exception">SQLException</span> {
    <span class="predefined-type">String</span> number = <span class="keyword">new</span> <span class="predefined-type">String</span>(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> + connectionIndex);
    <span class="predefined-type">String</span> url = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + jndiTag + number + urlTag);
    <span class="predefined-type">String</span> password = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + jndiTag + number + passwordTag);
    <span class="predefined-type">String</span> user = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + jndiTag + number + userTag);

    <span class="predefined-type">Properties</span> dbProperties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();

    <span class="predefined-type">String</span> theUser = props.getProperty(user);
    <span class="predefined-type">String</span> thePassword = props.getProperty(password);

    <span class="keyword">if</span> (theUser != <span class="predefined-constant">null</span>) {
        dbProperties.put(TransactionalDriver.userName, theUser);
        dbProperties.put(TransactionalDriver.password, thePassword);

        <span class="keyword">return</span> <span class="keyword">new</span> JDBC2RecoveryConnection(url, dbProperties);
    } <span class="keyword">else</span>
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the class <code>com.arjuna.ats.internal.jdbc.recovery.JDBC2RecoveryConnection</code> to create a new connection to the database using the same parameters used to create the initial connection.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_narayana_in_application_servers"><a class="anchor" href="#_using_narayana_in_application_servers"></a>3.2.3. Using Narayana in application servers</h4>
<div class="paragraph">
<p>WildFly Application Server is discussed here.
Refer to the documentation for your application server for differences.</p>
</div>
<div class="sect4">
<h5 id="_configuration"><a class="anchor" href="#_configuration"></a>Configuration</h5>
<div class="paragraph">
<p>When Narayana runs embedded in WildFly Application Server, the transaction subsystem is configured primarily through the <code>jboss-cli</code> configuration tool, which overrides properties read from the default properties file embedded in the <code>.jar</code> file.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Common configuration attributes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default transaction timeout to be used for new transactions. Specified as an integer in seconds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">enable-statistics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This determines whether or not the transaction service should gather statistical information. This information can then be viewed using the <code>TransactionStatistics</code> MBean. Specified as a Boolean. The default is to not gather this information.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>See the <code>jboss-cli</code> tool and the WildFly Application Server administration and configuration guide for further information.</p>
</div>
</div>
<div class="sect4">
<h5 id="_logging_2"><a class="anchor" href="#_logging_2"></a>Logging</h5>
<div class="paragraph">
<p>To make Narayana logging semantically consistent with WildFly Application Server, the <code>TransactionManagerService</code> modifies the level of some log messages, by overriding the value of the <code>LoggingEnvironmentBean.loggingFactory</code> property in the <code>jbossts-properties.xml</code> file.
Therefore, the value of this property has no effect on the logging behavior when running embedded in WildFly Application Server.
By forcing use of the <code>log4j_releveler</code> logger, the TransactionManagerService changes the level of all <code>INFO</code> level messages in the transaction code to <code>DEBUG</code>.
Therefore, these messages do not appear in log files if the filter level is <code>INFO</code>.
All other log messages behave as normal.</p>
</div>
</div>
<div class="sect4">
<h5 id="_the_services"><a class="anchor" href="#_the_services"></a>The services</h5>
<div class="paragraph">
<p>The <code>TransactionManager</code> bean provides transaction management services to other components in WildFly Application Server.
There are two different version of this bean and they require different configuration.
Use <code>jboss-cli</code> to select JTA or JTS mode.</p>
</div>
</div>
<div class="sect4">
<h5 id="_ensuring_transactional_context_is_propagated_to_the_server"><a class="anchor" href="#_ensuring_transactional_context_is_propagated_to_the_server"></a>Ensuring transactional context is propagated to the server</h5>
<div class="paragraph">
<p>You can coordinate transactions from a coordinator which is not located within the WildFly Application Server, such as when using transactions created by an external OTS server.
To ensure the transaction context is propagated via JRMP invocations to the server, the transaction propagation context factory needs to be explicitly set for the JRMP invoker proxy.
This is done as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">JRMPInvokerProxy.setTPCFactory(<span class="keyword">new</span> com.arjuna.ats.internal.jbossatx.jts.PropagationContextManager());</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installation_2"><a class="anchor" href="#_installation_2"></a>3.3. Installation</h3>
<div class="sect3">
<h4 id="_quick_start_to_jta"><a class="anchor" href="#_quick_start_to_jta"></a>3.3.1. Quick Start to JTA</h4>
<div class="sect4">
<h5 id="_introduction_3"><a class="anchor" href="#_introduction_3"></a>Introduction</h5>
<div class="paragraph">
<p>This chapter will briefly cover the key features required to construct a JTA application.
It is assumed that the reader is familiar with the concepts of the JTA.</p>
</div>
</div>
<div class="sect4">
<h5 id="_package_layout"><a class="anchor" href="#_package_layout"></a>Package layout</h5>
<div class="paragraph">
<p>The key Java packages (and corresponding jar files) for writing basic JTA applications are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.arjuna.ats.jts</code>: this package contains the Narayana implementations of the JTS and JTA.</p>
</li>
<li>
<p><code>com.arjuna.ats.jta</code>: this package contains local and remote JTA implementation support.</p>
</li>
<li>
<p><code>com.arjuna.ats.jdbc</code>: this package contains transactional JDBC support.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of these packages appear in the lib directory of the Narayana installation, and should be added to the programmer’s <code>CLASSPATH</code>.</p>
</div>
<div class="paragraph">
<p>In order to fully utilize all of the facilities available within Narayana, it will be necessary to add some additional jar files to your classpath.
See bin/setup-env.sh or bin\setup-env.bat for details.</p>
</div>
</div>
<div class="sect4">
<h5 id="_setting_properties"><a class="anchor" href="#_setting_properties"></a>Setting properties</h5>
<div class="paragraph">
<p>Narayana has also been designed to be configurable at runtime through the use of various property attributes.
These attributes can be provided at runtime on command line or specified through a properties file.</p>
</div>
<div class="sect5">
<h6 id="_specifying_the_object_store_location"><a class="anchor" href="#_specifying_the_object_store_location"></a>Specifying the object store location</h6>
<div class="paragraph">
<p>Narayana requires an object store in order to persistently record the outcomes of transactions in the event of failures.
In order to specify the location of the object store it is necessary to specify the location when the application is executed; for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java –DObjectStoreEnvironmentBean.objectStoreDir=/var/tmp/ObjectStore myprogram</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default location is a directory under the current execution directory.</p>
</div>
<div class="paragraph">
<p>By default, all object states will be stored within the defaultStore subdirectory of the object store root, e.g., <code>/usr/local/Arjuna/TransactionService/ObjectStore/defaultStore</code>.
However, this subdirectory can be changed by setting the <code>ObjectStoreEnvironmentBean.localOSRoot</code> property variable accordingly.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_demarcating_transactions"><a class="anchor" href="#_demarcating_transactions"></a>Demarcating Transactions</h5>
<div class="paragraph">
<p>The Java Transaction API consists of three elements: a high-level application transaction demarcation interface, a high-level transaction manager interface intended for application server, and a standard Java mapping of the X/Open XA protocol intended for transactional resource manager.
All of the JTA classes and interfaces occur within the <code>jakarta.transaction</code> package, and the corresponding Narayana implementations within the <code>com.arjuna.ats.jta package</code>.</p>
</div>
<div class="sect5">
<h6 id="_usertransaction"><a class="anchor" href="#_usertransaction"></a>UserTransaction</h6>
<div class="paragraph">
<p>The UserTransaction interface provides applications with the ability to control transaction boundaries.</p>
</div>
<div class="paragraph">
<p>In Narayana, <code>UserTransaction</code> can be obtained from the static <code>com.arjuna.ats.jta.UserTransaction.userTransaction()</code> method.
When obtained the <code>UserTransaction</code> object can be used to control transactions</p>
</div>
<div class="listingblock">
<div class="title">User Transaction Example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//get UserTransaction</span>
UserTransaction utx = com.arjuna.ats.jta.UserTransaction.userTransaction();
<span class="comment">// start transaction work..</span>
utx.begin();

<span class="comment">// perform transactional work</span>
utx.commit();</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_transactionmanager"><a class="anchor" href="#_transactionmanager"></a>TransactionManager</h6>
<div class="paragraph">
<p>The TransactionManager interface allows the application server to control transaction boundaries on behalf of the application being managed.</p>
</div>
<div class="paragraph">
<p>In Narayana, transaction manager implementations can be obtained from the static <code>com.arjuna.ats.jta.TransactionManager.transactionManager()</code> method.</p>
</div>
</div>
<div class="sect5">
<h6 id="_the_transaction_interface"><a class="anchor" href="#_the_transaction_interface"></a>The Transaction interface</h6>
<div class="paragraph">
<p>The Transaction interface allows operations to be performed on the transaction associated with the target object.
Every top-level transaction is associated with one Transaction object when the transaction is created.
The Transaction object can be used to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>enlist the transactional resources in use by the application.</p>
</li>
<li>
<p>register for transaction synchronization call backs.</p>
</li>
<li>
<p>commit or rollback the transaction.</p>
</li>
<li>
<p>obtain the status of the transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A Transaction object can be obtained using the <code>TransactionManager</code> by invoking the method <code>getTransaction()</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Transaction txObj = TransactionManager.getTransaction();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_local_vs_distributed_jta_implementations"><a class="anchor" href="#_local_vs_distributed_jta_implementations"></a>Local vs Distributed JTA implementations</h5>
<div class="paragraph">
<p>In order to ensure interoperability between JTA applications, it is recommended to rely on the JTS/OTS specification to ensure transaction propagation among transaction managers.</p>
</div>
<div class="paragraph">
<p>In order to select the local JTA implementation it is necessary to perform the following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>make sure the property <code>JTAEnvironmentBean.jtaTMImplementation</code> is set to <code>com.arjuna.ats.internal.jta.transaction.arjunacore.TransactionManagerImple</code>.</p>
</li>
<li>
<p>make sure the property <code>JTAEnvironmentBean.jtaUTImplementation</code> is set to <code>com.arjuna.ats.internal.jta.transaction.arjunacore.UserTransactionImple</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to select the distributed JTA implementation it is necessary to perform the following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>make sure the property <code>JTAEnvironmentBean.jtaTMImplementation</code> is set to <code>com.arjuna.ats.internal.jta.transaction.jts.TransactionManagerImple</code>.</p>
</li>
<li>
<p>make sure the property <code>JTAEnvironmentBean.jtaUTImplementation</code> is set to <code>com.arjuna.ats.internal.jta.transaction.jts.UserTransactionImple</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbc_and_transactions_2"><a class="anchor" href="#_jdbc_and_transactions_2"></a>JDBC and Transactions</h5>
<div class="paragraph">
<p>Narayana JTS supports the construction of both local and distributed transactional applications which access databases using the JDBC APIs.
JDBC supports two-phase commit of transactions, and is similar to the XA X/Open standard.
The JDBC support is found in the <code>com.arjuna.ats.jdbc</code> package.</p>
</div>
<div class="paragraph">
<p>The ArjunaJTS approach to incorporating JDBC connections within transactions is to provide transactional JDBC drivers through which all interactions occur.
These drivers intercept all invocations and ensure that they are registered with, and driven by, appropriate transactions.
(There is a single type of transactional driver through which any JDBC driver can be driven.
This driver is <code>com.arjuna.ats.jdbc.TransactionalDriver</code>, which implements the <code>java.sql.Driver</code> interface.)</p>
</div>
<div class="paragraph">
<p>Once the connection has been established (for example, using the <code>java.sql.DriverManager.getConnection</code> method), all operations on the connection will be monitored by Narayana.
Once created, the driver and any connection can be used in the same way as any other JDBC driver or connection.</p>
</div>
<div class="paragraph">
<p>Narayana connections can be used within multiple different transactions simultaneously, i.e., different threads, with different notions of the current transaction, may use the same JDBC connection. Narayana does connection pooling for each transaction within the JDBC connection.
So, although multiple threads may use the same instance of the JDBC connection, internally this may be using a different connection instance per transaction.
With the exception of close, all operations performed on the connection at the application level will only be performed on this transaction-specific connection.</p>
</div>
<div class="paragraph">
<p>Narayana will automatically register the JDBC driver connection with the transaction via an appropriate resource.
When the transaction terminates, this resource will be responsible for either committing or rolling back any changes made to the underlying database via appropriate calls on the JDBC driver.</p>
</div>
</div>
<div class="sect4">
<h5 id="_configurable_options"><a class="anchor" href="#_configurable_options"></a>Configurable options</h5>
<div class="paragraph">
<p>The following table shows some of the configuration features, with default values shown in italics.
For more detailed information, the relevant section numbers are provided.
You should look at the various Programmers Guides for more options.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You need to prefix certain properties in this table with the string <code>com.arjuna.ats.internal.jta.transaction</code>.
The prefix has been removed for formatting reasons, and has been replaced by &#8230;&#8203;</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration Name</th>
<th class="tableblock halign-left valign-top">Possible Values</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.ats.jta.supportSubtransactions</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>YES</code>/<code>NO</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.ats.jta.jtaTMImplementation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8230;&#8203;arjunacore.TransactionManagerImple</code></p>
<p class="tableblock"><code>&#8230;&#8203;jts.TransactionManagerImple</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.ats.jta.jtaUTImplementation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8230;&#8203;arjunacore.UserTransactionImple</code></p>
<p class="tableblock"><code>&#8230;&#8203;jts.UserTransactionImple</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.ats.jta.xaBackoffPeriod</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Time in seconds</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.ats.jdbc.isolationLevel</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Any supported JDBC isolation level.</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jts"><a class="anchor" href="#_jts"></a>4. JTS</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_administration_3"><a class="anchor" href="#_administration_3"></a>4.1. Administration</h3>
<div class="sect3">
<h4 id="_introduction_4"><a class="anchor" href="#_introduction_4"></a>4.1.1. Introduction</h4>
<div class="paragraph">
<p>The notions explained here are to be considered as extensions of what has already been presented in the
'Administration' section of <a href="#jta_introduction">JTA&#8217;s Administration section</a>.</p>
</div>
<div class="paragraph">
<p>Since the release of Narayana 4.1, the Web Services Transaction product has been merged into Narayana. Narayana is thus a single product that is compliant with all of the major distributed transaction standards and specifications.</p>
</div>
<div class="paragraph">
<p>Knowledge of Web Services is not required to administer a Narayana installation that only uses the CORBA/J2EE component, nor is knowledge of CORBA required to use the Web Services component.
This, administrative tasks are separated when they touch only one component or the other.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ots_and_jakarta_ee_transaction_service_management"><a class="anchor" href="#_ots_and_jakarta_ee_transaction_service_management"></a>4.1.2. OTS and Jakarta EE Transaction Service Management</h4>
<div class="sect4">
<h5 id="_starting_the_run_time_system"><a class="anchor" href="#_starting_the_run_time_system"></a>Starting the run-time system</h5>
<div class="paragraph">
<p>The Narayana run-time support consists of run-time packages and the OTS transaction manager server.
By default, Narayana does not use a separate transaction manager server.
Instead, transaction managers are co-located with each application process to improve performance and improve application fault-tolerance by reducing application dependency on other services.</p>
</div>
<div class="paragraph">
<p>When running applications which require a separate transaction manager, set the <code>JTSEnvironmentBean.transactionManager</code> environment variable to value <code>YES</code>.
The system locates the transaction manager server in a manner specific to the ORB being used.
This method may be any of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Being registered with a name server.</p>
</li>
<li>
<p>Being added to the ORB’s initial references.</p>
</li>
<li>
<p>Via a Narayana specific references file.</p>
</li>
<li>
<p>By the ORB’s specific location mechanism (if applicable).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You override the default registration mechanism by using the <code>OrbPortabilityEnvironmentBean.resolveService</code> environment variable, which takes the following values:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Possible values of <code>OrbPortabilityEnvironmentBean.resolveService</code></caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONFIGURATION_FILE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the default, and causes the system to use the <code>CosServices.cfg</code> file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NAME_SERVICE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana attempts to use a name service to register the transaction factory. If this is not supported, an exception is thrown.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIND_CONNECT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana uses the ORB-specific bind mechanism. If this is not supported, an exception is thrown.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RESOLVE_INITIAL_REFERENCES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana attempts to register the transaction service with the ORB&#8217;s initial service references. If the ORB does not support this, an exception is thrown, and another option must be used.</p></td>
</tr>
</tbody>
</table>
<div class="sect5">
<h6 id="_ots_configuration_file"><a class="anchor" href="#_ots_configuration_file"></a>OTS configuration file</h6>
<div class="paragraph">
<p>Similar to the <code>resolve_initial_references</code>, Narayana supports an initial reference file where references for specific services can be stored and used at runtime.
The file, <code>CosServices.cfg</code>, consists of two columns: the service name (in the case of the OTS server TransactionService), and the IOR, separated by a single space.
<code>CosServices.cfg</code> is located at runtime by the following <code>OrbPortabilityEnvironmentBean</code> properties:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>initialReferencesRoot</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The directory where the file is located, defaulting to the current working directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>initialReferencesFile</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the configuration file itself, <code>CosServices.cfg</code> by default.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The OTS server automatically registers itself in the <code>CosServices.cfg</code> file if the <code>OrbPortabilityEnvironmentBean</code> option is used, creating the file if necessary.
Stale information is also automatically removed.
Machines sharing the same transaction server should have access to this file, or a copy of it locally.</p>
</div>
<div class="exampleblock">
<div class="title">Example 15. Example ORB reference file settings</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">OrbPortabilityEnvironmentBean.initialReferencesFile=myFile
OrbPortabilityEnvironmentBean.initialReferencesRoot=/tmp</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_name_service"><a class="anchor" href="#_name_service"></a>Name service</h6>
<div class="paragraph">
<p>If your ORB supports a name service, and Narayana is configured to use it, the transaction manager is registered with it automatically.
There is no further work required.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This option is not used for JacORB</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_resolve_initial_references"><a class="anchor" href="#_resolve_initial_references"></a>resolve_initial_references</h6>
<div class="paragraph">
<p>Currently, this option is only supported for JacORB.</p>
</div>
</div>
<div class="sect5">
<h6 id="_resolution_services_supported_per_orb"><a class="anchor" href="#_resolution_services_supported_per_orb"></a>Resolution services supported per ORB</h6>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Resolution Mechanism</th>
<th class="tableblock halign-left valign-top">ORB</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OTS configuration file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All available ORBs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JacORB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">resolve_initial_references</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JacORB</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_xa_specific_management"><a class="anchor" href="#_xa_specific_management"></a>XA Specific management</h5>
<div class="paragraph">
<p>Each XA Xid that Narayana creates must have a unique node identifier encoded within it.
Narayana only recovers transactions and states that match a specified node identifier.
Provide the node identifier with the <code>CoreEnvironmentBean.nodeIdentifier</code> property.
This value must be unique across your Narayana instances.
If you do not provide a value, Narayana generates one and reports the value via the logging infrastructure.</p>
</div>
<div class="paragraph">
<p>When running XA recovery, you need to specify which types of Xid Narayana can recover.
Use the <code>JTAEnvironmentBean.xaRecoveryNodes</code> property to provide one or more values, in a space-separated list.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A value of ‘*’ forces Narayana to recover, and possibly rollback, all transactions, regardless of their node identifier.
Use this value with extreme caution.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_selecting_the_jta_implementation_2"><a class="anchor" href="#_selecting_the_jta_implementation_2"></a>Selecting the JTA implementation</h5>
<div class="paragraph">
<p>Two variants of the JTA implementation are now provided and accessible through the same interface.
These are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Purely local JTA</dt>
<dd>
<p>Only non-distributed JTA transactions can be executed.
This is the only version available with the Narayana product.</p>
</dd>
<dt class="hdlist1">Remote, CORBA-based JTA</dt>
<dd>
<p>Distributed JTA transactions can be executed.
This version is only available with the Narayana product and requires a supported CORBA ORB.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Both of these implementations are fully compatible with the transactional JDBC driver provided with Narayana.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<div class="title">Selecting the local JTA implementation</div>
<ul>
<li>
<p>Set the property <code>JTAEnvironmentBean.jtaTMImplementation</code> to value <code>com.arjuna.ats.internal.jta.transaction.arjunacore.TransactionManagerImple</code>.</p>
</li>
<li>
<p>Set the property <code>JTAEnvironmentBean.jtaUTImplementation</code> to value <code>com.arjuna.ats.internal.jta.transaction.arjunacore.UserTransactionImple</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These settings are the default values for the properties and do not need to be specified if the local implementation is required.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<div class="title">Selecting the remote JTA implementation</div>
<ul>
<li>
<p>Set the property <code>JTAEnvironmentBean.jtaTMImplementation</code> to value <code>com.arjuna.ats.internal.jta.transaction.jts..TransactionManagerImple</code>.</p>
</li>
<li>
<p>Set the property <code>JTAEnvironmentBean.jtaUTImplementation</code> to value <code>com.arjuna.ats.internal.jta.transaction.jts.UserTransactionImple</code>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_orb_specific_configurations"><a class="anchor" href="#_orb_specific_configurations"></a>4.1.3. ORB-specific Configurations</h4>
<div class="sect4">
<h5 id="_jacorb"><a class="anchor" href="#_jacorb"></a>JacORB</h5>
<div class="paragraph">
<p>For JacORB to function correctly it needs a valid <code>jacorb.properties</code> or <code>.jacorb_properties</code> file in one of the following places, in searched order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The classpath</p>
</li>
<li>
<p>The home directory of the user running the Narayana Service.
The home directory is retrieved using <code>System.getProperty(“user.home”);</code></p>
</li>
<li>
<p>The current directory</p>
</li>
<li>
<p>The <code>lib/</code> directory of the JDK used to run your application.
This is retrieved using <code>System.getProperty(“java.home”);</code></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A template <code>jacorb.properties</code> file is located in the JacORB installation directory.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Within the JacORB properties file there are two important properties which must be tailored to suit your application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jacorb.poa.thread_pool_max</code></p>
</li>
<li>
<p><code>jacorb.poa.thread_pool_min</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These properties specify the minimum and maximum number of request processing threads that JacORB uses in its thread pool.
If no threads are available, may block until a thread becomes available. For more information on configuring JacORB, refer to the JacORB documentation.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>JacORB includes its own implementation of the classes defined in the <code>CosTransactions.idl</code> file.
Unfortunately these are incompatible with the version shipped with Narayana.
Therefore, the Narayana jar files absolutely must appear in the CLASSPATH before any JacORB jars.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When running the recovery manager, it should always use the same well-known port for each machine on which it runs.
Do not use the <code>OAPort</code> property provided by JacORB unless the recovery manager has its own <code>jacorb.properties</code> file or the property is provided on the command line when starting the recovery manager.
If the recovery manager and other components of Narayana share the same <code>jacorb.properties</code> file, use the <code>JTSEnvironmentBean.recoveryManagerPort</code> and <code>JTSEnvironmentBean.recoveryManagerAddress</code> properties.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_initializing_narayana_applications"><a class="anchor" href="#_initializing_narayana_applications"></a>4.1.4. Initializing Narayana Applications</h4>
<div class="paragraph">
<p>Narayana must be initialized correctly before any application object is created.
To guarantee this, use the <code>initORB</code> and <code>create_POA</code> methods described in the <em>Orb Portability Guide</em>.
Consult the Orb Portability Guide if you need to use the underlying <code>ORB_init</code> and <code>create_POA</code> methods provided by the ORB instead of the Narayana methods.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_development_2"><a class="anchor" href="#_development_2"></a>4.2. Development</h3>
<div class="sect3">
<h4 id="_transaction_processing_overview"><a class="anchor" href="#_transaction_processing_overview"></a>4.2.1. Transaction Processing Overview</h4>
<div class="sect4">
<h5 id="_defining_a_transaction"><a class="anchor" href="#_defining_a_transaction"></a>Defining a transaction</h5>
<div class="paragraph">
<p>A transaction is a unit of work that encapsulates multiple database actions such that that either all the encapsulated actions fail or all succeed.</p>
</div>
<div class="paragraph">
<p>Transactions ensure data integrity when an application interacts with multiple datasources.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Practical Example</div>
<p>If you subscribe to a newspaper using a credit card, you are using a transactional system.
Multiple systems are involved, and each of the systems needs the ability to roll back its work, and cause the entire transaction to roll back if necessary.
For instance, if the newspaper&#8217;s subscription system goes offline halfway through your transaction, you don&#8217;t want your credit card to be charged.
If the credit card is over its limit, the newspaper doesn&#8217;t want your subscription to go through.
In either of these cases, the entire transaction should fail of any part of it fails.
Neither you as the customer, nor the newspaper, nor the credit card processor, wants an unpredictable (indeterminate) outcome to the transaction.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>This ability to roll back an operation if any part of it fails is what Narayana is all about.
This guide assists you in writing transactional applications to protect your data.</p>
</div>
<div class="paragraph">
<p>"Transactions" in this guide refers to atomic transactions, and embody the "all-or-nothing" concept outlined above.
Transactions are used to guarantee the consistency of data in the presence of failures.
Transactions fulfill the requirements of ACID: Atomicity, Consistency, Isolation, Durability.</p>
</div>
<div class="dlist">
<div class="title">ACID Properties</div>
<dl>
<dt class="hdlist1">Atomicity</dt>
<dd>
<p>The transaction completes successfully (commits) or if it fails (aborts) all of its effects are undone (rolled back).</p>
</dd>
<dt class="hdlist1">Consistency</dt>
<dd>
<p>Transactions produce consistent results and preserve application specific invariants.</p>
</dd>
<dt class="hdlist1">Isolation</dt>
<dd>
<p>Intermediate states produced while a transaction is executing are not visible to others.
Furthermore, transactions appear to execute serially, even if they are actually executed concurrently.</p>
</dd>
<dt class="hdlist1">Durability</dt>
<dd>
<p>The effects of a committed transaction are never lost (except by a catastrophic failure).</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A transaction can be terminated in two ways: committed or aborted (rolled back).
When a transaction is committed, all changes made within it are made durable (forced on to stable storage, e.g., disk).
When a transaction is aborted, all of the changes are undone.
Atomic actions can also be nested; the effects of a nested action are provisional upon the commit/abort of the outermost (top-level) atomic action.</p>
</div>
</div>
<div class="sect4">
<h5 id="_commit_protocol"><a class="anchor" href="#_commit_protocol"></a>Commit protocol</h5>
<div class="paragraph">
<p>A two-phase commit protocol guarantees that all of the transaction participants either commit or abort any changes made.
<a href="#_img_commit_protocol">Two-Phase Commit</a> illustrates the main aspects of the commit protocol.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>During phase 1, the action coordinator, <code>C</code>, attempts to communicate with all of the action participants, <code>A</code> and <code>B</code>, to determine whether they will commit or abort.</p>
</li>
<li>
<p>An abort reply from any participant acts as a veto, causing the entire action to abort.</p>
</li>
<li>
<p>Based upon these (lack of) responses, the coordinator chooses to commit or abort the action.</p>
</li>
<li>
<p>If the action will commit, the coordinator records this decision on stable storage, and the protocol enters phase 2, where the coordinator forces the participants to carry out the decision.
The coordinator also informs the participants if the action aborts.</p>
</li>
<li>
<p>When each participant receives the coordinator’s phase-one message, it records sufficient information on stable storage to either commit or abort changes made during the action.</p>
</li>
<li>
<p>After returning the phase-one response, each participant who returned a commit response must remain blocked until it has received the coordinator’s phase-two message.</p>
</li>
<li>
<p>Until they receive this message, these resources are unavailable for use by other actions.
If the coordinator fails before delivery of this message, these resources remain blocked.
However, if crashed machines eventually recover, crash recovery mechanisms can be employed to unblock the protocol and terminate the action.</p>
</li>
</ul>
</div>
<div id="_img_commit_protocol" class="imageblock">
<div class="content">
<img src="images/jts-img-2phase.png" alt="jts img 2phase">
</div>
<div class="title">Figure 5. Two-Phase Commit</div>
</div>
</div>
<div class="sect4">
<h5 id="_transactional_proxies"><a class="anchor" href="#_transactional_proxies"></a>Transactional proxies</h5>
<div class="paragraph">
<p>The action coordinator maintains a transaction context where resources taking part in the action need to be registered.
Resources must obey the transaction commit protocol to guarantee ACID properties.
Typically, the resource provides specific operations which the action can invoke during the commit/abort protocol.
However, some resources may not be able to be transactional in this way.
This may happen if you have legacy code which cannot be modified.
Transactional proxies allow you to use these anomalous resources within an action.</p>
</div>
<div class="paragraph">
<p>The proxy is registered with, and manipulated by, the action as though it were a transactional resource, and the proxy performs implementation specific work to make the resource it represents transactional.
The proxy must participate within the commit and abort protocols.
Because the work of the proxy is performed as part of the action, it is guaranteed to be completed or undone despite failures of the action coordinator or action participants.</p>
</div>
</div>
<div class="sect4">
<h5 id="_nested_transactions_2"><a class="anchor" href="#_nested_transactions_2"></a>Nested transactions</h5>
<div class="paragraph">
<p>Given a system that provides transactions for certain operations, you can combine them to form another operation, which is also required to be a transaction.
The resulting transaction’s effects are a combination of the effects of its constituent transactions.
This paradigm creates the concept of nested subtransactions, and the resulting combined transaction is called the enclosing transaction.
The enclosing transaction is sometimes referred to as the parent of a nested (or child) transaction.
It can also be viewed as a hierarchical relationship, with a top-level transaction consisting of several subordinate transactions.</p>
</div>
<div class="paragraph">
<p>An important difference exists between nested and top-level transactions.</p>
</div>
<div class="paragraph">
<p>The effect of a nested transaction is provisional upon the commit/roll back of its enclosing transactions.
The effects are recovered if the enclosing transaction aborts, even if the nested transaction has committed.</p>
</div>
<div class="paragraph">
<p>Sub-transactions are a useful mechanism for two reasons:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">fault-isolation</dt>
<dd>
<p>If a sub-transaction rolls back, perhaps because an object it is using fails, the enclosing transaction does not need to roll back.</p>
</dd>
<dt class="hdlist1">modularity</dt>
<dd>
<p>If a transaction is already associated with a call when a new transaction begins, the new transaction is nested within it.
Therefore, if you know that an object requires transactions, you can them within the object.
If the object’s methods are invoked without a client transaction, then the object’s transactions are top-level.
Otherwise, they are nested within the scope of the client&#8217;s transactions.
Likewise, a client does not need to know whether an object is transactional.
It can begin its own transaction.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_the_object_transaction_service_ots"><a class="anchor" href="#_the_object_transaction_service_ots"></a>The Object Transaction Service (OTS)</h5>
<div class="paragraph">
<p>The CORBA architecture, as defined by the OMG, is a standard which promotes the construction of interoperable applications that are based upon the concepts of distributed objects.
The architecture principally contains the following components:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Object Request Broker (ORB)</dt>
<dd>
<p>Enables objects to transparently send and receive requests in a distributed, heterogeneous environment.
This component is the core of the OMG reference model.</p>
</dd>
<dt class="hdlist1">Object Services</dt>
<dd>
<p>A collection of services that support functions for using and implementing objects.
Such services are necessary for the construction of any distributed application.
The Object Transaction Service (OTS) is the most relevant to Narayana.</p>
</dd>
<dt class="hdlist1">Common Facilities</dt>
<dd>
<p>Other useful services that applications may need, but which are not considered to be fundamental.
Desktop management and help facilities fit this category.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The CORBA architecture allows both implementation and integration of a wide variety of object systems.
In particular, applications are independent of the location of an object and the language in which an object is implemented, unless the interface the object explicitly supports reveals such details.
As defined in the OMG CORBA Services documentation, <em>object services</em> are defined as a collection of services (interfaces and objects) that support the basic functions for using and implementing objects.
These services are necessary to construct distributed application, and are always independent of an application domain.
The standards specify several core services including naming, event management, persistence, concurrency control and transactions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The OTS specification allows, but does not require, nested transactions.
Narayana is a fully compliant version of the OTS version 1.1 draft 5, and support nested transactions.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The transaction service provides interfaces that allow multiple distributed objects to cooperate in a transaction, committing or rolling back their changes as a group.
However, the OTS does not require all objects to have transactional behavior.
An object&#8217;s support of transactions can be none at all, for some operations, or fully.
Transaction information may be propagated between client and server explicitly, or implicitly.
You have fine-grained control over an object&#8217;s support of transactions.
If your objects supports partial or complete transactional behavior, it needs interfaces derived from interface <code>TransactionalObject</code>.</p>
</div>
<div class="paragraph">
<p>The Transaction Service specification also distinguishes between recoverable objects and transactional objects.
Recoverable objects are those that contain the actual state that may be changed by a transaction and must therefore be informed when the transaction commits or aborts to ensure the consistency of the state changes.
This is achieved be registering appropriate objects that support the Resource interface (or the derived <code>SubtransactionAwareResource</code> interface) with the current transaction.
Recoverable objects are also by definition transactional objects.</p>
</div>
<div class="paragraph">
<p>In contrast, a simple transactional object does not necessarily need to be recoverable if its state is actually implemented using other recoverable objects.
A simple transactional object does not need to participate the commit protocol used to determine the outcome of the transaction since it maintains no state information of its own.</p>
</div>
<div class="paragraph">
<p>The OTS is a protocol engine that guarantees obedience to transactional behavior.
It does not directly support all of the transaction properties, but relies on some cooperating services:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Persistence/Recovery Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supports properties of atomicity and durability.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Concurrency Control Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supports the isolation properties.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You are responsible for using the appropriate services to ensure that transactional objects have the necessary ACID properties.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_narayana_basics"><a class="anchor" href="#_narayana_basics"></a>4.2.2. Narayana Basics</h4>
<div class="sect4">
<h5 id="_introduction_5"><a class="anchor" href="#_introduction_5"></a>Introduction</h5>
<div class="paragraph">
<p>Narayana is based upon the original Arjuna system developed at the University of Newcastle between 1986 and 1995. Arjuna predates the OTS specification and includes many features not found in the OTS.
Narayana is a superset of the OTS.
Applications written using the standard OTS interfaces are portable across OTS implementations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>full draft 5 compliance, with support for Synchronization objects and PropagationContexts.</p>
</li>
<li>
<p>support for subtransactions.</p>
</li>
<li>
<p>implicit context propagation where support from the ORB is available.</p>
</li>
<li>
<p>support for multi-threaded applications.</p>
</li>
<li>
<p>fully distributed transaction managers, i.e., there is no central transaction manager, and the creator of a top-level transaction is responsible for its termination.
Separate transaction manager support is also available, however.</p>
</li>
<li>
<p>transaction interposition.</p>
</li>
<li>
<p>X/Open compliance, including checked transactions.
This checking can optionally be disabled.
Note: checked transactions are disabled by default, i.e., any thread can terminate a transaction.</p>
</li>
<li>
<p>JDBC support.</p>
</li>
<li>
<p>Full Jakarta Transactions support.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use Narayana in three different levels, which correspond to the sections in this chapter, and are each explored in their own chapters as well.</p>
</div>
<div class="paragraph">
<p>Because of differences in ORB implementations, Narayana uses a separate ORB Portability library which acts as an abstraction later.
Many of the examples used throughout this manual use this library.
Refer to the ORB Portability Manual for more details.</p>
</div>
<div class="sect5">
<h6 id="_raw_ots"><a class="anchor" href="#_raw_ots"></a>Raw OTS</h6>
<div class="paragraph">
<p>The OTS is only a protocol engine for driving registered resources through a two-phase commit protocol.
You are responsible for building and registering the <code>Resource</code> objects which handle persistence and concurrency control, ensuring ACID properties for transactional application objects.
You need to register <code>Resources</code> at appropriate times, and ensure that a given <code>Resource</code> is only registered within a single transaction.
Programming at the raw OTS level is extremely basic.
You as the programmer are responsible for almost everything to do with transactions, including managing persistence and concurrency control on behalf of every transactional object.</p>
</div>
</div>
<div class="sect5">
<h6 id="_enhanced_ots_functionality"><a class="anchor" href="#_enhanced_ots_functionality"></a>Enhanced OTS functionality</h6>
<div class="paragraph">
<p>The OTS implementation of nested transactions is extremely limited, and can lead to the generation of heuristic results.
An example of such a result is when a sub-transaction coordinator discovers part of the way through committing that some resources cannot commit, but being unable to tell the committed resources to abort. Narayana allows nested transactions to execute a full two-phase commit protocol, which removes the possibility that some resources will comment while others roll back.</p>
</div>
<div class="paragraph">
<p>When resources are registered with a transaction, you have no control over the order in which these resources are invoked during the commit/abort protocol.
For example, if previously registered resources are replaced with newly registered resources, resources registered with a subtransaction are merged with the subtraction&#8217;s parent. Narayana provides an additional Resource subtype which you this level of control.</p>
</div>
</div>
<div class="sect5">
<h6 id="_advanced_api"><a class="anchor" href="#_advanced_api"></a>Advanced API</h6>
<div class="paragraph">
<p>The OTS does not provide any <code>Resource</code> implementations.
You are responsible for implementing these interfaces.
The interfaces defined within the OTS specification are too low-level for most application programmers.
Therefore, Narayana includes <em>Transactional Objects for Java (TXOJ)</em> , which makes use of the raw Common Object Services interfaces but provides a higher-level API for building transactional applications and frameworks.
This API automates much of the activities concerned with participating in an OTS transaction, freeing you to concentrate on application development, rather than transactions.</p>
</div>
<div class="paragraph">
<p>The architecture of the system is shown in Figure 2. The API interacts with the concurrency control and persistence services, and automatically registers appropriate resources for transactional objects.
These resources may also use the persistence and concurrency services.</p>
</div>
<div class="paragraph">
<p>Narayana exploits object-oriented techniques to provide you with a toolkit of Java classes which are inheritable by application classes, to obtain transactional properties.
These classes form a hierarchy, illustrated in <a href="#_jbossts_class_hierarchy">Narayana class hierarchy</a>.</p>
</div>
<div id="_jbossts_class_hierarchy" class="imageblock">
<div class="content">
<img src="images/jts-jbossts-class-hierarchy.png" alt="Narayana class hierarchy">
</div>
<div class="title">Figure 6. Narayana class hierarchy</div>
</div>
<div class="paragraph">
<p>Your main responsibilities are specifying the scope of transactions and setting appropriate locks within objects. Narayana guarantees that transactional objects will be registered with, and be driven by, the appropriate transactions.
Crash recovery mechanisms are invoked automatically in the event of failures.
When using the provided interfaces, you do not need to create or register <code>Resource</code> objects or call services controlling persistence or recovery.
If a transaction is nested, resources are automatically propagated to the transaction’s parent upon commit.</p>
</div>
<div class="paragraph">
<p>The design and implementation goal of Narayana was to provide a programming system for constructing fault-tolerant distributed applications.
Three system properties were considered highly important:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integration of Mechanisms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fault-tolerant distributed systems require a variety of system functions for naming, locating and invoking operations upon objects, as well as for concurrency control, error detection and recovery from failures. These mechanisms are integrated in a way that is easy for you to use.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flexibility</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mechanisms must be flexible, permitting implementation of application-specific enhancements, such as type-specific concurrency and recovery control, using system defaults.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Portability</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You need to be able to run Narayana on any ORB.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Narayana is implemented in Java and extensively uses the type-inheritance facilities provided by the language to provide user-defined objects with characteristics such as persistence and recoverability.</p>
</div>
</div>
<div class="sect5">
<h6 id="_narayana_and_the_ots_implementation"><a class="anchor" href="#_narayana_and_the_ots_implementation"></a>Narayana and the OTS implementation</h6>
<div class="paragraph">
<p>The OTS specification is written with flexibility in mind, to cope with different application requirements for transactions. Narayana supports all optional parts of the OTS specification.
In addition, if the specification allows functionality to be implemented in a variety of different ways, Narayana supports all possible implementations.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Narayana implementation of OTS specifications</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">OTS specification</th>
<th class="tableblock halign-left valign-top">Narayana default implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the transaction service chooses to restrict the availability of the transaction context, then it should raise the <code>Unavailable</code> exception.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana does not restrict the availability of the transaction context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">An implementation of the transaction service need not initialize the transaction context for every request.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana only initializes the transaction context if the interface supported by the target object extends the <code>TransactionalObject</code> interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">An implementation of the transaction service may restrict the ability for the <code>Coordinator</code>, <code>Terminator</code>, and <code>Control</code> objects to be transmitted or used in other execution environments to enable it to guarantee transaction integrity.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana does not impose restrictions on the propagation of these objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction service may restrict the termination of a transaction to the client that started it.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana allows the termination of a transaction by any client that uses the <code>Terminator</code> interface. In addition, Narayana does not impose restrictions when clients use the <code>Current</code> interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>TransactionFactory</code> is located using the <code>FactoryFinder</code> interface of the life-cycle service.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana provides multiple ways in which the <code>TransactionFactory</code> can be located.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A transaction service implementation may use the Event Service to report heuristic decisions.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana does not use the Event Service to report heuristic decisions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">An implementation of the transaction service does not need to support nested transactions.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana supports nested transactions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Synchronization</code> objects must be called whenever the transaction commits.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana allows <code>Synchronizations</code> to be called no matter what state the transaction terminates with.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A transaction service implementation is not required to support interposition.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana supports various types of interposition.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_thread_class"><a class="anchor" href="#_thread_class"></a>Thread class</h5>
<div class="paragraph">
<p>Narayana is fully multi-threaded and supports the OTS notion of allowing multiple threads to be active within a transaction, and for a thread to execute multiple transactions.
A thread can only be active within a single transaction at a time, however.
By default, if a thread is created within the scope of a transaction, the new thread is not associated with the transaction.
If the thread needs to be associated with the transaction, use the <code>resume</code> method of either the <code>AtomicTransaction</code> class or the <code>Current</code> class.</p>
</div>
<div class="paragraph">
<p>However, if newly created threads need to automatically inherit the transaction context of their parent, then they should extend the <code>OTS_Thread</code> class.</p>
</div>
<div class="listingblock">
<div class="title">Extending the <code class="class">OTS_Thread</code>class</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">OTS_Thread</span> <span class="directive">extends</span> <span class="predefined-type">Thread</span> {
    <span class="directive">protected</span> OTS_Thread();

    <span class="directive">public</span> <span class="type">void</span> terminate();

    <span class="directive">public</span> <span class="type">void</span> run();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Call the <code>run</code> method of <code>OTS_Thread</code> at the start of the application thread class&#8217;s <code>run</code> method.
Call <code>terminate</code> before you exit the body of the application thread’s <code>run</code> method.</p>
</div>
</div>
<div class="sect4">
<h5 id="_orb_portability_issues"><a class="anchor" href="#_orb_portability_issues"></a>ORB portability issues</h5>
<div class="paragraph">
<p>Although the CORBA specification is a standard, it is written so that an ORB can be implemented in multiple ways.
As such, writing portable client and server code can be difficult.
Because Narayana has been ported to most of the widely available ORBs, it includes a series of ORB Portability classes and macros.
If you write your application using these classes, it should be mostly portable between different ORBs.
These classes are described in the separate ORB Portability Manual.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_introduction_to_the_ots"><a class="anchor" href="#_introduction_to_the_ots"></a>4.2.3. Introduction to the OTS</h4>
<div class="paragraph">
<p>Basic Narayana programming involves using the OTS interfaces provided in the <code>CosTransactions</code> module, which is specified in <code>CosTransactions.idl</code>.
This chapter is based on the <code>OTS Specification1</code>, specifically with the aspects of OTS that are valuable for developing OTS applications using Narayana.
Where relevant, each section describes Narayana implementation decisions and runtime choices available to you.
These choices are also summarized at the end of this chapter.
Subsequent chapters illustrate using these interfaces to construct transactional applications.</p>
</div>
<div class="sect4">
<h5 id="_defining_the_ots"><a class="anchor" href="#_defining_the_ots"></a>Defining the OTS</h5>
<div class="paragraph">
<p>The raw <code>CosTransactions</code> interfaces reside in package <code>org.omg.CosTransactions</code>.
The Narayana implementations of these interfaces reside in package <code>com.arjuna.CosTransactions</code> and its sub-packages.</p>
</div>
<div class="paragraph">
<p>You can override many run-time decisions of Narayana Java properties specified at run-time.
The property names are mentioned in the <code>com.arjuna.ats.jts.common.Environment</code> class.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-ots_architecture.png" alt="jts ots architecture">
</div>
<div class="title">Figure 7. OTS architecture</div>
</div>
</div>
<div class="sect4">
<h5 id="_action_programming_models"><a class="anchor" href="#_action_programming_models"></a>Action programming models</h5>
<div class="paragraph">
<p>A client application program can manage a transaction using direct or indirect context management.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Indirect context management</em> means that an application uses the pseudo-object <code>Current</code>, provided by the Transaction Service, to associate the transaction context with the application thread of control.</p>
</li>
<li>
<p>For <em>direct context management</em>, an application manipulates the <code>Control</code> object and the other objects associated with the transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An object may require transactions to be either explicitly or implicitly propagated to its operations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Explicit propagation</em> means that an application propagates a transaction context by passing objects defined by the Transaction Service as explicit parameters.
Typically the object is the <code>PropagationContext</code> structure.</p>
</li>
<li>
<p><em>Implicit propagation</em> means that requests are implicitly associated with the client’s transaction, by sharing the client&#8217;s transaction context.
The context is transmitted to the objects without direct client intervention.
Implicit propagation depends on indirect context management, since it propagates the transaction context associated with the <code>Current</code> pseudo-object.
An object that supports implicit propagation should not receive any Transaction Service object as an explicit parameter.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A client may use one or both forms of context management, and may communicate with objects that use either method of transaction propagation.
This results in four ways in which client applications may communicate with transactional objects:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Direct Context Management/Explicit Propagation</dt>
<dd>
<p>The client application directly accesses the <code>Control</code> object, and the other objects which describe the state of the transaction.
To propagate the transaction to an object, the client must include the appropriate Transaction Service object as an explicit parameter of an operation.
Typically, the object is the <code>PropagationContext</code> structure.</p>
</dd>
<dt class="hdlist1">Indirect Context Management/Implicit Propagation</dt>
<dd>
<p>The client application uses operations on the <code>Current</code> pseudo-object to create and control its transactions.
When it issues requests on transactional objects, the transaction context associated with the current thread is implicitly propagated to the object.</p>
</dd>
<dt class="hdlist1">Indirect Context Management/Explicit Propagation</dt>
<dd>
<p>for an implicit model application to use explicit propagation, it can get access to the Control using the get_control operation on the <code>Current</code> pseudo object.
It can then use a Transaction Service object as an explicit parameter to a transactional object; for efficiency reasons this should be the PropagationContext structure, obtained by calling get_txcontext on the appropriate <code>Coordinator</code> reference.
This is explicit propagation.</p>
</dd>
<dt class="hdlist1">Direct Context Management/Implicit Propagation</dt>
<dd>
<p>A client that accesses the Transaction Service objects directly can use the <code>resume</code> pseudo-object operation to set the implicit transaction context associated with its thread.
This way, the client can invoke operations of an object that requires implicit propagation of the transaction context.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The main difference between direct and indirect context management is the effect on the invoking thread’s transaction context.
Indirect context management causes the thread’s transaction context to be modified automatically by the OTS.
For instance, if method <code>begin</code> is called, the thread’s notion of the current transaction is modified to the newly-created transaction.
When the transaction is terminated, the transaction previously associated with the thread, if one existed, is restored as the thread’s context.
This assumes that subtransactions are supported by the OTS implementation.</p>
</div>
<div class="paragraph">
<p>If you use direct management, no changes to the thread&#8217;s transaction context are made by the OTS, leaving the responsibility to you.</p>
</div>
</div>
<div class="sect4">
<h5 id="_interfaces"><a class="anchor" href="#_interfaces"></a>Interfaces</h5>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Interfaces</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Used by</th>
<th class="tableblock halign-left valign-top">Direct context mgmt</th>
<th class="tableblock halign-left valign-top">Indirect context mgmt</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a transaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction originator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Factory::create</code><br>
<code>Control::get_terminator</code><br>
<code>Control::get_coordinator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>begin</code><br>
<code>set_timeout</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Terminate a transaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction originator<br>
(implicit)<br>
All<br>
(explicit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Terminator::commit</code><br>
<code>Terminator::rollback</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>commit rollback</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rollback transaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Terminator::rollback_only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollback_only</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Propagation of transaction to server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declaration of method parameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TransactionalObject</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client control of transaction propagation to server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request parameters</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>get_control</code><br>
<code>suspend</code><br>
<code>resume</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register with a transaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Recoverable Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Coordinator::register_resource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Miscellaneous</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Coordinator::get_status</code><br>
<code>Coordinator::get_transaction_name</code><br>
<code>Coordinator::is_same_transaction</code><br>
<code>Coordinator::hash_transaction</code><br>
<code>get_status</code><br>
<code>get_transaction_name</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For clarity, sub-transaction operations are not shown</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_transaction_factory"><a class="anchor" href="#_transaction_factory"></a>Transaction factory</h5>
<div class="paragraph">
<p>The <code>TransactionFactory</code> interface allows the transaction originator to begin a top-level transaction.
sub-transactions must be created using the <code>begin</code> method of <code>Current</code>, or the <code>create_subtransaction</code> method of the parent’s <code>Coordinator</code>).
Operations on the factory and <code>Coordinator</code> to create new transactions use direct context management, and therefore do not modify the calling thread’s transaction context.</p>
</div>
<div class="paragraph">
<p>The <code>create</code> operation creates a new top-level transaction and returns its <code>Control</code> object, which you can use to manage or control participation in the new transaction.
Method <code>create</code> takes a parameter that is an application-specific timeout value, in seconds.
If the transaction does not complete before this timeout elapses, it is rolled back.
If the parameter is <code>0</code>, no application-specific timeout is established.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>sub-transactions do not have a timeout associated with them.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Transaction Service implementation allows the <code>TransactionFactory</code> to be a separate server from the application, shared by transactions clients, and which manages transactions on their behalf.
However, the specification also allows the TransactionFactory to be implemented by an object within each transactional client.
This is the default implementation used by Narayana, because it removes the need for a separate service to be available in order for transactional applications to execute, and therefore reduces a point of failure.</p>
</div>
<div class="paragraph">
<p>If your applications require a separate transaction manager, set the <code>OTS_TRANSACTION_MANAGER</code> environment variable to the value <code>YES</code>.
The system locates the transaction manager server in a manner specific to the ORB being used.
The server can be located in a number of ways.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Registration with a name server.</p>
</li>
<li>
<p>Addition to the ORB’s initial references, using a Narayana specific references file.</p>
</li>
<li>
<p>The ORB’s specific location mechanism, if applicable.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="_ots_configuration_file_2"><a class="anchor" href="#_ots_configuration_file_2"></a>OTS configuration file</h6>
<div class="paragraph">
<p>Similar to the <code>resolve_initial_references</code>, Narayana supports an initial reference file where you can store references for specific services, and use these references at runtime.
The file, <code>CosServices.cfg</code>, consists of two columns, separated by a single space.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The service name, which is <code>TransactionService</code> in the case of the OTS server</p>
</li>
<li>
<p>The IOR</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>CosServices.cfg</code> is usually located in the <code>etc/</code> directory of the Narayana installation.
The OTS server automatically registers itself in this file, creating it if necessary, if you use the configuration file mechanism.
Stale information is also automatically removed.
The Transaction Service locates <code>CosServices.cfg</code> at runtime, using the <code>OrbPortabilityEnvironmentBean</code> properties <code>initialReferencesRoot</code> and <code>InitialReferencesFile</code>.
<code>initialReferencesRoot</code> names a directory, and defaults to the current working directory.
<code>initialReferencesFile</code> refers to a file within the <code>initialReferencesRoot</code>, and defaults to the name <code>CosServices.cfg</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_name_service_2"><a class="anchor" href="#_name_service_2"></a>Name service</h6>
<div class="paragraph">
<p>If your ORB supports a name service, and you configure Narayana to use it, the transaction manager is automatically registered with it.</p>
</div>
</div>
<div class="sect5">
<h6 id="_resolve_initial_references_2"><a class="anchor" href="#_resolve_initial_references_2"></a>resolve_initial_references</h6>
<div class="paragraph">
<p>Narayana does not support <code>resolve_initial_references</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_overriding_the_default_location_mechanisms"><a class="anchor" href="#_overriding_the_default_location_mechanisms"></a>Overriding the default location mechanisms</h6>
<div class="paragraph">
<p>You can override the default location mechanism with the <code>RESOLVE_SERVICE</code> property variable, which can have any of three possible values.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CONFIGURATION_FILE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the default option, and directs the system to use the <code>CosServices.cfg</code> file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NAME_SERVICE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana tries to use a name service to locate the transaction factory. If the ORB does not support the name service mechanism, Narayana throws an exception.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BIND_CONNECT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana uses the ORB-specific bind mechanism. If the ORB does not support such a mechanism, Narayana throws an exception.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If <code>RESOLVE_SERVICE</code> is specified when running the transaction factory, the factory registers itself with the specified resolution mechanism.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_transaction_timeouts_2"><a class="anchor" href="#_transaction_timeouts_2"></a>Transaction timeouts</h5>
<div class="paragraph">
<p>As of Narayana 4.5, transaction timeouts are unified across all transaction components and are controlled by <code>ArjunaCore</code>.
Refer to the <em>ArjunaCore Development Guide</em> for more information.</p>
</div>
</div>
<div class="sect4">
<h5 id="_transaction_contexts"><a class="anchor" href="#_transaction_contexts"></a>Transaction contexts</h5>
<div class="paragraph">
<p>Transaction contexts are fundamental to the OTS architecture.
Each thread is associated with a context in one of three ways.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The thread has no associated transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A transaction ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The thread is associated with a transaction.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Contexts may be shared across multiple threads.
In the presence of nested transactions, a context remembers the stack of transactions started within the environment, so that the context of the thread can be restored to the state before the nested transaction started, when the nested transaction ends.
Threads most commonly use object <code>Current</code> to manipulate transactional information, which is represented by <code>Control</code> objects.
<code>Current</code> is the broker between a transaction and <code>Control</code> objects.</p>
</div>
<div class="paragraph">
<p>Your application can manage transaction contexts either directly or indirectly.
In the direct approach, the transaction originator issues a request to a <code>TransactionFactory</code> to begin a new top-level transaction.
The factory returns a <code>Control</code> object that enables both a <code>Terminator</code> interface and a <code>Coordinator</code> interface.
<code>Terminator</code> ends a transaction.
<code>Coordinator</code> associates a thread with a transaction, or begins a nested transaction.
You need to pass each interface as an explicit parameter in invocations of operations, because creating a transaction with them does not change a thread&#8217;s current context.
If you use the factory, and need to set the current context for a thread to the context which its control object returns, use the <code>resume</code> method of interface <code>Current</code>.</p>
</div>
<div class="listingblock">
<div class="title">Interfaces <code>Terminator</code>, <code>Coordinator</code>, and <code>Control</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C">interface Terminator {
    <span class="directive">void</span> commit (in boolean report_heuristics) raises (HeuristicMixed, HeuristicHazard);
    <span class="directive">void</span> rollback ();
}

interface Coordinator {
    Status get_status ();
    Status get_parent_status ();
    Status get_top_level_status ();

    RecoveryCoordinator register_resource (in Resource r) raises (Inactive);
    Control create_subtransaction () raises (SubtransactionsUnavailable, Inactive);

    <span class="directive">void</span> rollback_only () raises (Inactive);

    ...
}

interface Control {
    Terminator get_terminator () raises (Unavailable);
    Coordinator get_coordinator () raises (Unavailable);
}

interface TransactionFactory {
    Control create (in <span class="predefined-type">unsigned</span> <span class="predefined-type">long</span> time_out);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the factory creates a transaction, you can specify a timeout value in seconds.
If the transaction times out, it is subject to possible roll-back.
Set the timeout to <code>0</code> to disable application-specific timeout.</p>
</div>
<div class="paragraph">
<p>The <code>Current</code> interface handles implicit context management.
Implicit context management provides simplified transaction management functionality, and automatically creates nested transactions as required.
Transactions created using <code>Current</code> do not alter a thread’s current transaction context.</p>
</div>
<div class="listingblock">
<div class="title">Interface <code>Current</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C">interface Current : CORBA::Current {
    <span class="directive">void</span> begin () raises (SubtransactionsUnavailable);
    <span class="directive">void</span> commit (in boolean report_heuristics) raises (NoTransaction, HeuristicMixed, HeuristicHazard);
    <span class="directive">void</span> rollback () raises (NoTransaction);
    <span class="directive">void</span> rollback_only () raises (NoTransaction);
    ...
    Control get_control ();
    Control suspend ();
    <span class="directive">void</span> resume (in Control which) raises (InvalidControl);
}</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="_nested_transactions_3"><a class="anchor" href="#_nested_transactions_3"></a>Nested transactions</h6>
<div class="paragraph">
<p>sub-transactions are a useful mechanism for two reasons:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">fault-tolerance</dt>
<dd>
<p>If a sub-transaction rolls back, the enclosing transaction does not also need to roll back.
This preserves as much of the work done so far, as possible.</p>
</dd>
<dt class="hdlist1">modularity</dt>
<dd>
<p>Indirect transaction management does not require special syntax for creating subtransactions.
Begin a transaction, and if another transaction is associated with the calling thread, the new transaction is nested within the existing one.
If you know that an object requires transactions, you can use them within the object.
If the object&#8217;s methods are invoked without a client transaction, the object&#8217;s transaction is top-level.
Otherwise, it is nested within the client&#8217;s transaction.
A client does not need to know whether an object is transactional.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The outermost transaction of the hierarchy formed by nested transactions is called the top-level transaction.
The inner components are called subtransactions.
Unlike top-level transactions, the commits of subtransactions depend upon the commit/rollback of the enclosing transactions.
Resources acquired within a sub-transaction should be inherited by parent transactions when the top-level transaction completes.
If a sub-transaction rolls back, it can release its resources and undo any changes to its inherited resources.</p>
</div>
<div class="paragraph">
<p>In the OTS, subtransactions behave differently from top-level transactions at commit time.
Top-level transactions undergo a two-phase commit protocol, but nested transactions do not actually perform a commit protocol themselves.
When a program commits a nested transaction, it only informs registered resources of its outcome.
If a resource cannot commit, an exception is thrown, and the OTS implementation can ignore the exception or roll back the sub-transaction.
You cannot roll back a sub-transaction if any resources have been informed that the transaction committed.</p>
</div>
</div>
<div class="sect5">
<h6 id="_transaction_propagation"><a class="anchor" href="#_transaction_propagation"></a>Transaction propagation</h6>
<div class="paragraph">
<p>The OTS supports both implicit and explicit propagation of transactional behavior.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implicit propagation means that an operation signature specifies no transactional behavior, and each invocation automatically sends transaction context associated with the calling thread.</p>
</li>
<li>
<p>Explicit propagation means that applications must define their own mechanism for propagating transactions.
This has the following features:</p>
<div class="ulist">
<ul>
<li>
<p>A client to control if its transaction is propagated with any operation invocation.</p>
</li>
<li>
<p>A client can invoke operations on both transactional and non-transactional objects within a transaction.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Transaction context management and transaction propagation are different things that may be controlled independently of each other.
Mixing of direct and indirect context management with implicit and explicit transaction propagation is supported.
Using implicit propagation requires cooperation from the ORB.
The client must send current context associated with the thread with any operation invocations, and the server must extract them before calling the targeted operation.</p>
</div>
<div class="paragraph">
<p>If you need implicit context propagation, ensure that Narayana is correctly initialized before you create objects.
Both client and server must agree to use implicit propagation.
To use implicit context propagation, your ORB needs to support filters or interceptors, or the <code>CosTSPortability</code> interface.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Implicit context propagation</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property variable <code>OTS_CONTEXT_PROP_MODE</code> set to <code>CONTEXT</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Interposition</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property variable <code>OTS_CONTEXT_PROP_MODE</code> set to <code>INTERPOSITION</code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Interposition is required to use the Narayana Advanced API.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_examples_2"><a class="anchor" href="#_examples_2"></a>Examples</h6>
<div class="exampleblock">
<div class="title">Example 16. Simple transactional client using direct context management and explicit transaction propagation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">{
  ...
  org.omg.CosTransactions.Control c;
  org.omg.CosTransactions.Terminator t;
  org.omg.CosTransactions.PropagationContext pgtx;

  <span class="comment">// create top-level action</span>
  c = transFact.create(<span class="integer">0</span>);

  pgtx = c.get_coordinator().get_txcontext();
  ...
  <span class="comment">// explicit propagation</span>
  trans_object.operation(arg, pgtx);
  ...
  <span class="comment">// get terminator</span>
  t = c.get_terminator();
  <span class="comment">// so it can be used to commit</span>
  t.commit(<span class="predefined-constant">false</span>);
  ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The next example rewrites the same program to use indirect context management and implicit propagation.
This example is considerably simpler, because the application only needs to start and either commit or abort actions.</p>
</div>
<div class="listingblock">
<div class="title">Indirect context management and implicit propagation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">{
   ...
   <span class="comment">// create new action</span>
   current.begin();
   ...
   <span class="comment">// implicit propagation</span>
   trans_object2.operation(arg);
   ...

   <span class="comment">// simple commit</span>
   current.commit(<span class="predefined-constant">false</span>);
   ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last example illustrates the flexibility of OTS by using both direct and indirect context management in conjunction with explicit and implicit transaction propagation.</p>
</div>
<div class="listingblock">
<div class="title">Direct and direct context management with explicitly and implicit propagation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">{
  ...
  org.omg.CosTransactions.Control c;
  org.omg.CosTransactions.Terminator t;
  org.omg.CosTransactions.PropagationContext pgtx;

  <span class="comment">// create top-level action</span>
  c = transFact.create(<span class="integer">0</span>);
  pgtx = c.get_coordinator().get_txcontext();

  <span class="comment">// set implicit context</span>
  current.resume(c);
  ...
  <span class="comment">// explicit propagation</span>
  trans_object.operation(arg, pgtx);
  <span class="comment">// implicit propagation</span>
  trans_object2.operation(arg);
  ...
  <span class="comment">// oops! rollback</span>
  current.rollback();
  ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_transaction_controls"><a class="anchor" href="#_transaction_controls"></a>Transaction controls</h5>
<div class="paragraph">
<p>The <code>Control</code> interface allows a program to explicitly manage or propagate a transaction context.
An object supporting the <code>Control</code> interface is associated with one specific transaction.
The <code>Control</code> interface supports two operations: <code>get_terminator</code> and <code>get_coordinator</code>.
<code>get_terminator</code> returns an instance of the <code>Terminator</code> interface.
<code>get_coordinator</code> returns an instance of the <code>Coordinator</code> interface.
Both of these methods throw the <code>Unavailable</code> exception if the <code>Control</code> cannot provide the requested object.
The OTS implementation can restrict the ability to use the <code>Terminator</code> and <code>Coordinator</code> in other execution environments or threads.
At a minimum, the creator must be able to use them.</p>
</div>
<div class="paragraph">
<p>Obtain the <code>Control</code> object for a transaction when it is created either by using either the <code>TransactionFactory</code> or <code>create_subtransaction</code> methods defined by the <code>Coordinator</code> interface.
Obtain a <code>Control</code> for the transaction associated with the current thread using the <code>get_control</code> or <code>suspend</code> methods defined by the <code>Current</code> interface.</p>
</div>
<div class="sect5">
<h6 id="_control_jbossts_specifics"><a class="anchor" href="#_control_jbossts_specifics"></a>Narayana specifics</h6>
<div class="paragraph">
<p>The transaction creator must be able to use its <code>Control</code>, but the OTS implementation decides whether other threads can use <code>Control</code>.
Narayana places no restrictions the users of the <code>Control</code>.</p>
</div>
<div class="paragraph">
<p>The OTS specification does not provide a means to indicate to the transaction system that information and objects associated with a given transaction can be purged from the system.
In Narayana, the <code>Current</code> interface destroys all information about a transaction when it terminates.
For that reason, do not use any <code>Control</code> references to the transaction after it commits or rolls back.</p>
</div>
<div class="paragraph">
<p>However, if the transaction is terminated using the <code>Terminator</code> interface, it is up to the programmer to signal that the transaction information is no longer required: this can be done using the <code>destroyControl</code> method of the OTS class in the <code>com.arjuna.CosTransactions</code> package.
Once the program has indicated that the transaction information is no longer required, the same restrictions on using <code>Control</code> references apply as described above.
If <code>destroyControl</code> is not called then transaction information will persist until garbage collected by the Java runtime.</p>
</div>
<div class="paragraph">
<p>In Narayana, you can propagate <code>Coordinators</code> and <code>Terminators</code> between execution environments.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_the_terminatorinterface"><a class="anchor" href="#_the_terminatorinterface"></a>The <code class="interface">Terminator</code>interface</h5>
<div class="paragraph">
<p>The <code>Terminator</code> interface supports <code>commit</code> and <code>rollback</code> operations.
Typically, the transaction originator uses these operations.
Each object supporting the <code>Terminator</code> interface is associated with a single transaction.
Direct context management via the <code>Terminator</code> interface does not change the client thread’s notion of the current transaction.</p>
</div>
<div class="paragraph">
<p>The <code>commit</code> operation attempts to commit the transaction.
To successfully commit, the transaction must not be marked <code>rollback only</code>, and all of its must participants agree to commit.
Otherwise, the <code>TRANSACTION_ROLLEDBACK</code> exception is thrown.
If the <code>report_heuristics</code> parameter is <code>true</code>, the Transaction Service reports inconsistent results using the <code>HeuristicMixed</code> and <code>HeuristicHazard</code> exceptions.</p>
</div>
<div class="paragraph">
<p>When a transaction is committed, the coordinator drives any registered <code>Resources</code> using their <code>prepare</code> or <code>commit</code> methods.
These Resources are responsible to ensure that any state changes to recoverable objects are made permanent, to guarantee the ACID properties.</p>
</div>
<div class="paragraph">
<p>When <code>rollback</code> is called, the registered <code>Resources</code> need to guarantee that all changes to recoverable objects made within the scope of the transaction, and its descendants, is undone.
All resources locked by the transaction are made available to other transactions, as appropriate to the degree of isolation the resources enforce.</p>
</div>
<div class="sect5">
<h6 id="_narayana_specifics"><a class="anchor" href="#_narayana_specifics"></a>Narayana specifics</h6>
<div class="paragraph">
<p>See <a href="#_control_jbossts_specifics">Narayana specifics</a> for how long <code>Terminator</code> references remain valid after a transaction terminates.</p>
</div>
<div class="paragraph">
<p>When a transaction is committing, it must make certain state changes persistent, so that it can recover if a failure occurs, and continue to commit, or rollback.
To guarantee ACID properties, flush these state changes to the persistence store implementation before the transaction proceeds to commit.
Otherwise, the application may assume that the transaction has committed, when the state changes may still volatile storage, and may be lost by a subsequent hardware failure.
By default, Narayana makes sure that such state changes are flushed.
However, these flushes can impose a significant performance penalty to the application.
To prevent transaction state flushes, set the <code>TRANSACTION_SYNC</code> variable to <code>OFF</code>.
Obviously, do this at your own risk.</p>
</div>
<div class="paragraph">
<p>When a transaction commits, if only a single resource is registered, the transaction manager does not need to perform the two-phase protocol.
A single phase commit is possible, and the outcome of the transaction is determined by the resource.
In a distributed environment, this optimization represents a significant performance improvement.
As such, Narayana defaults to performing single phase commit in this situation.
Override this behavior at runtime by setting the <code>COMMIT_ONE_PHASE</code> property variable to <code>NO</code>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_the_coordinator_interface"><a class="anchor" href="#_the_coordinator_interface"></a>The <code>Coordinator</code> interface</h5>
<div class="paragraph">
<p>The <code>Coordinator</code> interface is returned by the <code>get_coordinator</code> method of the <code>Control</code> interface.
It supports the operations resources need to participate in a transaction.
These participants are usually either recoverable objects or agents of recoverable objects, such as subordinate coordinators.
Each object supporting the <code>Coordinator</code> interface is associated with a single transaction.
Direct context management via the <code>Coordinator</code> interface does not change the client thread’s notion of the current transaction.
You can terminate transaction directly, through the <code>Terminator</code> interface.
In that case, trying to terminate the transaction a second time using <code>Current</code> causes an exception to be thrown for the second termination attempt.</p>
</div>
<div class="paragraph">
<p>The operations supported by the <code>Coordinator</code> interface of interest to application programmers are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Operations supported by the <code>Coordinator</code> interface</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>get_status</code><br>
<code>get_parent_status</code><br>
<code>get_top_level_status</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return the status of the associated transaction. At any given time a transaction can have one of the following status values representing its progress:</p>
<p class="tableblock"><code><strong>StatusActive</strong></code>
The transaction is currently running, and has not been asked to prepare or marked for rollback.<br>
<code><strong>StatusMarkedRollback</strong></code>
The transaction is marked for rollback.<br>
<code><strong>StatusPrepared</strong></code>
The transaction has been prepared, which means that all subordinates have responded <code>VoteCommit</code>.<br>
<code><strong>StatusCommitted</strong></code>
The transaction has committed. It is likely that heuristics exist. Otherwise, the transaction would have been destroyed and <code>StatusNoTransaction</code> returned.<br>
<code><strong>StatusRolledBack</strong></code>
The transaction has rolled back. It is likely that heuristics exist. Otherwise. the transaction would have been destroyed and StatusNoTransaction returned.<br>
<code><strong>StatusUnknown</strong></code>
The Transaction Service cannot determine the current status of the transaction. This is a transient condition, and a subsequent invocation should return a different status.<br>
<code><strong>StatusNoTransaction</strong></code>
No transaction is currently associated with the target object. This occurs after a transaction completes.<br>
<code><strong>StatusPreparing</strong></code>
The transaction is in the process of preparing and the final outcome is not known.<br>
<code><strong>StatusCommitting</strong></code>
The transaction is in the process of committing.<br>
<code><strong>StatusRollingBack</strong></code>
The transaction is in the process of rolling back.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>is_same_transaction and others</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You can use these operations for transaction comparison. Resources may use these various operations to guarantee that they are registered only once with a specific transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hash_transaction</code><br>
<code>hash_top_level_tran</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns a hash code for the specified transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>register_resource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registers the specified Resource as a participant in the transaction. The <code>Inactive</code> exception is raised if the transaction is already prepared. The <code>TRANSACTION_ROLLEDBACK</code> exception is raised if the transaction is marked <code>rollback only</code>. If the <code>Resource</code> is a <code>SubtransactionAwareResource</code> and the transaction is a sub-transaction, this operation registers the resource with this transaction and indirectly with the top-level transaction when the sub-transaction’s ancestors commit. Otherwise, the resource is only registered with the current transaction. This operation returns a <code>RecoveryCoordinator</code> which this <code>Resource</code> can use during recovery. No ordering of registered Resources is implied by this operation. If <code>A</code> is registered after <code>B</code>, the OTS can operate on them in any order when the transaction terminates. Therefore, do not assume such an ordering exists in your implementation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>register_subtran_aware</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registers the specified sub-transaction-aware resource with the current transaction, so that it know when the sub-transaction commits or rolls back. This method cannot register the resource as a participant in the top-level transaction. The <code>NotSubtransaction</code> exception is raised if the current transaction is not a sub-transaction. As with <code>register_resource</code>, no ordering is implied by this operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>register_synchronization</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registers the <code>Synchronization</code> object with the transaction so that will be invoked before <code>prepare</code> and after the transaction completes. <code>Synchronizations</code> can only be associated with top-level transactions, and the <code>SynchronizationsUnavailable</code> exception is raised if you try to register a <code>Synchronization</code> with a sub-transaction. As with <code>register_resource</code>, no ordering is implied by this operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollback_only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Marks the transaction so that the only possible outcome is for it to rollback. The Inactive exception is raised if the transaction has already been prepared/completed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>create_subtransaction</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A new sub-transaction is created. Its parent is the current transaction. The <code>Inactive</code> exception is raised if the current transaction has already been prepared or completed. If you configure the Transaction Service without sub-transaction support, the <code>SubtransactionsUnavailable</code> exception is raised.</p></td>
</tr>
</tbody>
</table>
<div class="sect5">
<h6 id="_narayana_specifics_2"><a class="anchor" href="#_narayana_specifics_2"></a>Narayana specifics</h6>
<div class="paragraph">
<p>See <a href="#_control_jbossts_specifics">Narayana specifics</a> to control how long <code>Coordinator</code> references remain valid after a transaction terminates.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To disable subtransactions, set set the <code>OTS_SUPPORT_SUBTRANSACTIONS</code> property variable to <code>NO</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_heuristics"><a class="anchor" href="#_heuristics"></a>Heuristics</h5>
<div class="paragraph">
<p>The OTS permits individual resources to make heuristic decisions.
<em>Heuristic</em> decisions are unilateral decisions made by one or more participants to commit or abort the transaction, without waiting for the consensus decision from the transaction service.
Use heuristic decisions with care and only in exceptional circumstances, because they can lead to a loss of integrity in the system.
If a participant makes a heuristic decision, an appropriate exception is raised during commit or abort processing.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Possible heuristic outcomes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HeuristicRollback</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Raised on an attempt to commit, to indicate that the resource already unilaterally rolled back the transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HeuristicCommit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Raised on an attempt to roll back, to indicate that the resource already unilaterally committed the transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HeuristicMixed</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates that a heuristic decision has been made. Some updates committed while others rolled back.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HeuristicHazard</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates that a heuristic decision may have been made, and the outcome of some of the updates is unknown. For those updates which are known, they either all committed or all rolled back.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>HeuristicMixed takes priority over HeuristicHazard.
Heuristic decisions are only reported back to the originator if the <code>report_heuristics</code> argument is set to <code>true</code> when you invoke the commit operation.</p>
</div>
</div>
<div class="sect4">
<h5 id="_current"><a class="anchor" href="#_current"></a><code>Current</code></h5>
<div class="paragraph">
<p>The <code>Current</code> interface defines operations that allow a client to explicitly manage the association between threads and transactions, using indirect context management.
It defines operations that simplify the use of the Transaction Service.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Methods of <code>Current</code></caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>begin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creates a new transaction and associates it with the current thread. If the client thread is currently associated with a transaction, and the OTS implementation supported nested transactions, the new transaction becomes a sub-transaction of that transaction. Otherwise, the new transaction is a top-level transaction. If the OTS implementation does not support nested transactions, the <code>SubtransactionsUnavailable</code> exception is thrown. The thread’s notion of the current context is modified to be this transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>commit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commits the transaction. If the client thread does not have permission to commit the transaction, the standard exception <code>NO_PERMISSION</code> is raised. The effect is the same as performing the <code>commit</code> operation on the corresponding <code>Terminator</code> object. The client thread&#8217;s transaction context is returned to its state before the <code>begin</code> request was initiated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollback</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rolls back the transaction. If the client thread does not have permission to terminate the transaction, the standard exception <code>NO_PERMISSION</code> is raised. The effect is the same as performing the <code>rollback</code> operation on the corresponding <code>Terminator</code> object. The client thread&#8217;s transaction context is returned to its state before the <code>begin</code> request was initiated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollback_only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limits the transaction&#8217;s outcome to rollback only. If the transaction has already been terminated, or is in the process of terminating, an appropriate exception is thrown.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>get_status</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the status of the current transaction, or exception <code>StatusNoTransaction</code> if no transaction is associated with the thread.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>set_timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modifies the timeout associated with top-level transactions for subsequent <code>begin</code> requests, for this thread only. Subsequent transactions are subject to being rolled back if they do not complete before the specified number of seconds elapses. Default timeout values for transactions without explicitly-set timeouts are implementation-dependent. Narayana uses a value of <code>0</code>, which results in transactions never timing out. There is no interface in the OTS for obtaining the current timeout associated with a thread. However, Narayana provides additional support for this. See <a href="#_current_jbossts_specific">Narayana specifics</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>get_control</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtains a <code>Control</code> object representing the current transaction. If the client thread is not associated with a transaction, a null object reference is returned. The operation is not dependent on the state of the transaction. It does not raise the <code>TRANSACTION_ROLLEDBACK</code> exception.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>suspend</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtains an object representing a transaction&#8217;s context. If the client thread is not associated with a transaction, a null object reference is returned. You can pass this object to the <code>resume</code> operation to re-establish this context in a thread. The operation is not dependent on the state of the transaction. It does not raise the <code>TRANSACTION_ROLLEDBACK</code> exception. When this call returns, the current thread has no transaction context associated with it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resume</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Associates the client thread with a transaction. If the parameter is a null object reference, the client thread becomes associated with no transaction. The thread loses association with any previous transactions.</p></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="images/jts-top_level_transaction_current.png" alt="jts top level transaction current">
</div>
<div class="title">Figure 8. Creation of a top-level transaction using <code>Current</code></div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-subtransaction_current.png" alt="jts subtransaction current">
</div>
<div class="title">Figure 9. Creation of a transaction using <code>Current</code></div>
</div>
<div class="sect5">
<h6 id="_current_jbossts_specific"><a class="anchor" href="#_current_jbossts_specific"></a>Narayana specifics</h6>
<div class="paragraph">
<p>Ideally, you should Obtain <code>Current</code> by using the life-cycle service factory finder.
However, very few ORBs support this. Narayana provides method <code>get_current</code> of <code>Current</code> for this purpose.
This class hides any ORB-specific mechanisms required for obtaining <code>Current</code>.</p>
</div>
<div class="paragraph">
<p>If no timeout value is associated with <code>Current</code>, Narayana associates no timeout with the transaction.
The current OTS specification does not provide a means whereby the timeout associated with transaction creation can be obtained.
However, Narayana <code>Current</code> supports a <code>get_timeout</code> method.</p>
</div>
<div class="paragraph">
<p>By default, the Narayana implementation of <code>Current</code> does not use a separate <code>TransactionFactory</code> server when creating new top-level transactions.
Each transactional client has a <code>TransactionFactory</code> co-located with it.
Override this by setting the <code>OTS_TRANSACTION_MANAGER</code> variable to <code>YES</code>.</p>
</div>
<div class="paragraph">
<p>The transaction factory is located in the <code>bin/</code> directory of the Narayana distribution.
Start it by executing the OTS script.
<code>Current</code> locates the factory in a manner specific to the ORB: using the name service, through <code>resolve_initial_references</code>, or via the <code>CosServices.cfg</code> file.
The <code>CosServices.cfg</code> file is similar to <code>resolve_initial_references</code>, and is automatically updated when the transaction factory is started on a particular machine.
Copy the file to each Narayana instance which needs to share the same transaction factory.</p>
</div>
<div class="paragraph">
<p>If you do not need sub-transaction support, set the <code>OTS_SUPPORT_SUBTRANSACTIONS</code> property variable to <code>NO</code>.
The <code>setCheckedAction</code> method overrides the <code>CheckedAction</code> implementation associated with each transaction created by the thread.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_resource"><a class="anchor" href="#_resource"></a>Resource</h5>
<div class="paragraph">
<p>The Transaction Service uses a two-phase commit protocol to complete a top-level transaction with each registered resource.</p>
</div>
<div class="listingblock">
<div class="title">Completing a top-level transaction</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">Resource</span> {
    Vote prepare ();
    <span class="type">void</span> rollback () raises (HeuristicCommit, HeuristicMixed, HeuristicHazard);
    <span class="type">void</span> commit () raises (NotPrepared, HeuristicRollback, HeuristicMixed, HeuristicHazard);
    <span class="type">void</span> commit_one_phase () raises (HeuristicRollback, HeuristicMixed, HeuristicHazard);
    <span class="type">void</span> forget ();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Resource</code> interface defines the operations invoked by the transaction service.
Each <code>Resource</code> object is implicitly associated with a single top-level transaction.
Do not register a <code>Resource</code> with the same transaction more than once.
When you tell a <code>Resource</code> to <code>prepare</code>, <code>commit</code>, or <code>abort</code>, it must do so on behalf of a specific transaction.
However, the <code>Resource</code> methods do not specify the transaction identity.
It is implicit, since a <code>Resource</code> can only be registered with a single transaction.</p>
</div>
<div class="paragraph">
<p>Transactional objects must use the <code>register_resource</code> method to register objects supporting the <code>Resource</code> interface with the current transaction.
An object supporting the <code>Coordinator</code> interface is either passed as a parameter in the case of explicit propagation, or retrieved using operations on the <code>Current</code> interface in the case of implicit propagation.
If the transaction is nested, the <code>Resource</code> is not informed of the sub-transaction’s completion, and is registered with its parent upon commit.</p>
</div>
<div class="paragraph">
<p>This example assumes that transactions are only nested two levels deep, for simplicity.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-resource_nested_transactions.png" alt="jts resource nested transactions">
</div>
<div class="title">Figure 10. <code>Resource</code> and nested transactions</div>
</div>
<div class="paragraph">
<p>Do not register a given <code>Resource</code> with the same transaction more than once, or it will receive multiple termination calls.
When a <code>Resource</code> is directed to <code>prepare</code>, <code>commit</code>, or <code>abort</code>, it needs to link these actions to a specific transaction.
Because <code>Resource</code> methods do not specify the transaction identity, but can only be associated with a single transaction, you can infer the identity.</p>
</div>
<div class="paragraph">
<p>A single <code>Resource</code> or group of <code>Resources</code> guarantees the ACID properties for the recoverable object they represent.
A Resource&#8217;s work depends on the phase of its transaction.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">prepare</dt>
<dd>
<p>If none of the persistent data associated with the resource is modified by the transaction, the Resource can return <code>VoteReadOnly</code> and forget about the transaction.
It does not need to know the outcome of the second phase of the commit protocol, since it hasn&#8217;t made any changes.</p>
<div class="paragraph">
<p>If the resource can write, or has already written, all the data needed to commit the transaction to stable storage, as well as an indication that it has prepared the transaction, it can return <code>VoteCommit</code>.
After receiving this response, the Transaction Service either commits or rolls back.
To support recovery, the resource should store the <code>RecoveryCoordinator</code> reference in stable storage.</p>
</div>
<div class="paragraph">
<p>The resource can return <code>VoteRollback</code> under any circumstances.
After returning this response, the resource can forget the transaction.</p>
</div>
<div class="paragraph">
<p>The <code>Resource</code> reports inconsistent outcomes using the <code>HeuristicMixed</code> and <code>HeuristicHazard</code> exceptions.
One example is that a <code>Resource</code> reports that it can commit and later decides to roll back.
Heuristic decisions must be made persistent and remembered by the <code>Resource</code> until the transaction coordinator issues the <code>forget</code> method.
This method tells the <code>Resource</code> that the heuristic decision has been noted, and possibly resolved.</p>
</div>
</dd>
<dt class="hdlist1">rollback</dt>
<dd>
<p>The resource should undo any changes made as part of the transaction.
Heuristic exceptions can be used to report heuristic decisions related to the resource.
If a heuristic exception is raised, the resource must remember this outcome until the forget operation is performed so that it can return the same outcome in case rollback is performed again.
Otherwise, the resource can forget the transaction.</p>
</dd>
<dt class="hdlist1">commit</dt>
<dd>
<p>If necessary, the resource should commit all changes made as part of this transaction.
As with <code>rollback</code>, it can raise heuristic exceptions.
The <code>NotPrepared</code> exception is raised if the resource has not been prepared.</p>
</dd>
<dt class="hdlist1">commit_one_phase</dt>
<dd>
<p>Since there can be only a single resource, the <code>HeuristicHazard</code> exception reports heuristic decisions related to that resource.</p>
</dd>
<dt class="hdlist1">forget</dt>
<dd>
<p>Performed after the resource raises a heuristic exception.
After the coordinator determines that the heuristic situation is addressed, it issues <code>forget</code> on the resource.
The resource can forget all knowledge of the transaction.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_subtransactionawareresource"><a class="anchor" href="#_subtransactionawareresource"></a>SubtransactionAwareResource</h5>
<div class="paragraph">
<p>Recoverable objects that need to participate within a nested transaction may support the <code>SubtransactionAwareResource</code> interface, a specialization of the <code>Resource</code> interface.</p>
</div>
<div class="listingblock">
<div class="title">Interface <code>SubtransactionAwareResource</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C">interface SubtransactionAwareResource : Resource {
    <span class="directive">void</span> commit_subtransaction (in Coordinator parent);
    <span class="directive">void</span> rollback_subtransaction ();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A recoverable object is only informed of the completion of a nested transaction if it registers a <code>SubtransactionAwareResource</code>.
Register the object with either the <code>register_resource</code> of the <code>Coordinator</code> interface, or the <code>register_subtran_aware</code> method of the <code>Current</code> interface.
A recoverable object registers Resources to participate within the completion of top-level transactions, and <code>SubtransactionAwareResources</code> keep track of the completion of subtransactions.
The <code>commit_subtransaction</code> method uses a reference to the parent transaction to allow sub-transaction resources to register with these transactions.</p>
</div>
<div class="paragraph">
<p><code>SubtransactionAwareResources</code> find out about the completion of a transaction after it terminates.
They cannot affect the outcome of the transaction.
Different OTS implementations deal with exceptions raised by <code>SubtransactionAwareResources</code> in implementation-specific ways.</p>
</div>
<div class="paragraph">
<p>Use method <code>register_resource</code> or method <code>register_subtran_aware</code> to register a <code>SubtransactionAwareResource</code> with a transaction using.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">register_resource</dt>
<dd>
<p>If the transaction is a sub-transaction, the resource is informed of its completion, and automatically registered with the sub-transaction’s parent if the parent commits.</p>
</dd>
<dt class="hdlist1">register_subtran_aware</dt>
<dd>
<p>If the transaction is not a sub-transaction, an exception is thrown.
Otherwise, the resource is informed when the sub-transaction completes.
Unlike <code>register_resource</code>, the resource is not propagated to the sub-transaction’s parent if the transaction commits.
If you need this propagation, re-register using the supplied parent parameter.</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-register_subtran_aware.png" alt="jts register subtran aware">
</div>
<div class="title">Figure 11. Method <code>register_subtran_aware</code></div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-register_resource.png" alt="jts register resource">
</div>
<div class="title">Figure 12. Method <code>register_resource</code></div>
</div>
<div class="paragraph">
<p>In either case, the resource cannot affect the outcome of the transaction completion.
It can only act on the transaction&#8217;s decision, after the decision is made.
However, if the resource cannot respond appropriately, it can raise an exception.
Thee OTS handles these exceptions in an implementation-specific way.</p>
</div>
<div class="sect5">
<h6 id="_narayana_specifics_3"><a class="anchor" href="#_narayana_specifics_3"></a>Narayana specifics</h6>
<div class="paragraph">
<p>A <code>SubtransactionAwareResource</code> which raises an exception to the commitment of a transaction may create inconsistencies within the transaction if other <code>SubtransactionAwareResources</code> think the transaction committed.
To prevent this possibility of inconsistency, Narayana forces the enclosing transaction to abort if an exception is raised.</p>
</div>
<div class="paragraph">
<p>Narayana also provides extended sub-transaction aware resources to overcome this, and other problems.
See Section for further details.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_the_synchronization_interface"><a class="anchor" href="#_the_synchronization_interface"></a>The <code>Synchronization</code> interface</h5>
<div class="paragraph">
<p>If an object needs notification before a transaction commits, it can register an object which is an implements the <code>Synchronization</code> interface, using the <code>register_synchronization</code> operation of the <code>Coordinator</code> interface.
<code>Synchronizations</code> flush volatile state data to a recoverable object or database before the transaction commits.
You can only associate <code>Synchronizations</code> with top-level transactions.
If you try to associate a <code>Synchronization</code> to a nested transaction, an exception is thrown.
Each object supporting the <code>Synchronization</code> interface is associated with a single top-level transaction.</p>
</div>
<div class="listingblock">
<div class="title"><code>Synchronizations</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C">interface Synchronization : TransactionalObject {
    <span class="directive">void</span> before_completion ();
    <span class="directive">void</span> after_completion (in Status s);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The method <code>before_completion</code> is called before the two-phase commit protocol starts, and <code>after_completion</code> is called after the protocol completes.
The final status of the transaction is given as a parameter to <code>after_completion</code>. If <code>before_completion</code> raises an exception, the transaction rolls back.
Any exceptions thrown by <code>after_completion</code> do not affect the transaction outcome.</p>
</div>
<div class="paragraph">
<p>The OTS only requires <code>Synchronizations</code> to be invoked if the transaction commits.
If it rolls back, registered <code>Synchronizations</code> are not informed.</p>
</div>
<div class="paragraph">
<p>Given the previous description of <code>Control</code>, <code>Resource</code>, <code>SubtransactionAwareResource</code>, and <code>Synchronization</code>, the following UML relationship diagram can be drawn:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-interface_relationship.png" alt="Relationship between `Control`" width="`Resource`" height="`SubtransactionAwareResource`">
</div>
<div class="title">Figure 13. Relationship between <code>Control</code>, <code>Resource</code>, <code>SubtransactionAwareResource</code>, and <code>Synchronization</code></div>
</div>
<div class="sect5">
<h6 id="_narayana_specifics_4"><a class="anchor" href="#_narayana_specifics_4"></a>Narayana specifics</h6>
<div class="paragraph">
<p><code>Synchronizations</code> must be called before the top-level transaction commit protocol starts, and after it completes.
By default, if the transaction is instructed to roll back, the <code>Synchronizations</code> associated with the transaction is not contacted.
To override this, and call <code>Synchronizations</code> regardless of the transaction&#8217;s outcome, set the <code>OTS_SUPPORT_ROLLBACK_SYNC</code> property variable to <code>YES</code>.</p>
</div>
<div class="paragraph">
<p>If you use distributed transactions and interposition, a local proxy for the top-level transaction coordinator is created for any recipient of the transaction context.
The proxy looks like a <code>Resource</code> or <code>SubtransactionAwareResource</code>, and registers itself as such with the actual top-level transaction coordinator.
The local recipient uses it to register <code>Resources</code> and <code>Synchronizations</code> locally.</p>
</div>
<div class="paragraph">
<p>The local proxy can affect how <code>Synchronizations</code> are invoked during top-level transaction commit.
Without the proxy, all <code>Synchronizations</code> are invoked before any Resource or <code>SubtransactionAwareResource</code> objects are processed.
However, with interposition, only those <code>Synchronizations</code> registered locally to the transaction coordinator are called.
<code>Synchronizations</code> registered with remote participants are only called when the interposed proxy is invoked.
The local proxy may only be invoked after locally-registered Resource or <code>SubtransactionAwareResource</code> objects are invoked.
With the <code>OTS_SUPPORT_INTERPOSED_SYNCHRONIZATION</code> property variable set to <code>YES</code>, all <code>Synchronizations</code> are invoked before any Resource or <code>SubtransactionAwareResource</code>, no matter where they are registered.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_transactions_and_registered_resources"><a class="anchor" href="#_transactions_and_registered_resources"></a>Transactions and registered resources</h5>
<div class="imageblock">
<div class="content">
<img src="images/jts-control_and_resources.png" alt="Relationship between a transaction `Control` and the resources registered with it">
</div>
<div class="title">Figure 14. Relationship between a transaction <code>Control</code> and the resources registered with it</div>
</div>
<div class="paragraph">
<p>In <a href="#_subtransaction_commit">Sub-transaction commit</a>, a sub-transaction with both <code>Resource</code> and <code>SubtransactionAwareResource</code> objects commits.
The <code>SubtransactionAwareResources</code> were registered using <code>register_subtran_aware</code>.
The <code>Resources</code> do not know the sub-transaction terminated, but the <code>SubtransactionAwareResources</code> do.
Only the <code>Resources</code> are automatically propagated to the parent transaction.</p>
</div>
<div id="_subtransaction_commit" class="imageblock">
<div class="content">
<img src="images/jts-sub-transaction_commit.png" alt="jts sub transaction commit">
</div>
<div class="title">Figure 15. Sub-transaction commit</div>
</div>
<div class="paragraph">
<p><a href="#_subtransaction_rollback">Sub-transaction rollback</a> illustrates the impact of a sub-transaction rolling back.
Any registered resources are discarded, and all <code>SubtransactionAwareResources</code> are informed of the transaction outcome.</p>
</div>
<div id="_subtransaction_rollback" class="imageblock">
<div class="content">
<img src="images/jts-sub-transaction_rollback.png" alt="jts sub transaction rollback">
</div>
<div class="title">Figure 16. Sub-transaction rollback</div>
</div>
<div class="paragraph">
<p><a href="#_top_level_commit">Top-level commit</a> shows the activity diagram for committing a top-level transaction.
sub-transactions within the top-level transaction which have also successfully committed propagate <code>SubtransactionAwareResources</code> to the top-level transaction.
These <code>SubtransactionAwareResources</code> then participate within the two-phase commit protocol.
Any registered <code>Synchronizations</code> are contacted before <code>prepare</code> is called.
Because of indirect context management, when the transaction commits, the transaction service changes the invoking thread’s transaction context.</p>
</div>
<div id="_top_level_commit" class="imageblock">
<div class="content">
<img src="images/jts-top-level-commit.png" alt="jts top level commit">
</div>
<div class="title">Figure 17. Top-level commit</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-top-level-rollback.png" alt="Top-level rollback">
</div>
<div class="title">Figure 18. Top-level rollback</div>
</div>
</div>
<div class="sect4">
<h5 id="_the_transactionalobject_interface"><a class="anchor" href="#_the_transactionalobject_interface"></a>The <code>TransactionalObject</code> interface</h5>
<div class="paragraph">
<p>The <code>TransactionalObject</code> interface indicates to an object that it is transactional.
By supporting this interface, an object indicates that it wants to associate the transaction context associated with the client thread with all operations on its interface.
The <code>TransactionalObject</code> interface defines no operations.</p>
</div>
<div class="paragraph">
<p>OTS specifications do not require an OTS to initialize the transaction context of every request handler.
It is only a requirement if the interface supported by the target object is derived from <code>TransactionalObject</code>.
Otherwise, the initial transaction context of the thread is undefined.
A transaction service implementation can raise the <code>TRANSACTION_REQUIRED</code> exception if a <code>TransactionalObject</code> is invoked outside the scope of a transaction.</p>
</div>
<div class="paragraph">
<p>In a single-address space application, transaction contexts are implicitly shared between clients and objects, regardless of whether or not the objects support the <code>TransactionalObject</code> interface.
To preserve distribution transparency, where implicit transaction propagation is supported, you can direct Narayana to always propagate transaction contexts to objects.
The default is only to propagate if the object is a <code>TransactionalObject</code>.
Set the <code>OTS_ALWAYS_PROPAGATE_CONTEXT</code> property variable to <code>NO</code> to override this behavior.</p>
</div>
<div class="paragraph">
<p>By default, Narayana does not require objects which support the <code>TransactionalObject</code> interface to invoked within the scope of a transaction.
The object determines whether it should be invoked within a transaction.
If so, it must throw the <code>TransactionRequired</code> exception.
Override this default by setting the <code>OTS_NEED_TRAN_CONTEXT</code> shell environment variable to <code>YES</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Make sure that the settings for <code>OTS_ALWAYS_PROPAGATE_CONTEXT</code> and <code>OTS_NEED_TRAN_CONTEXT</code> are identical at the client and the server.
If they are not identical at both ends, your application may terminate abnormally.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_interposition"><a class="anchor" href="#_interposition"></a>Interposition</h5>
<div class="paragraph">
<p>OTS objects supporting interfaces such as the <code>Control</code> interface are standard CORBA objects.
When an interface is passed as a parameter in an operation call to a remote server, only an object reference is passed.
This ensures that any operations that the remote server performs on the interface are correctly performed on the real object.
However, this can have substantial penalties for the application, because of the overhead of remote invocation.
For example, when the server registers a <code>Resource</code> with the current transaction, the invocation might be remote to the originator of the transaction.</p>
</div>
<div class="paragraph">
<p>To avoid this overhead, your OTS may support interposition.
This permits a server to create a local control object which acts as a local coordinator, and fields registration requests that would normally be passed back to the originator.
This coordinator must register itself with the original coordinator, so that it can correctly participate in the commit protocol.
Interposed coordinators form a tree structure with their parent coordinators.</p>
</div>
<div class="paragraph">
<p>To use interposition, ensure that Narayana is correctly initialized before creating objects.
Also, the client and server must both use interposition.
Your ORB must support filters or interceptors, or the <code>CosTSPortability</code> interface, since interposition requires the use of implicit transaction propagation.
To use interposition, set the <code>OTS_CONTEXT_PROP_MODE</code> property variable to <code>INTERPOSITION</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Interposition is not required if you use the Narayana advanced API.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_recoverycoordinator"><a class="anchor" href="#_recoverycoordinator"></a>RecoveryCoordinator</h5>
<div class="paragraph">
<p>A reference to a <code>RecoveryCoordinator</code> is returned as a result of successfully calling <code>register_resource</code> on the transaction&#8217;s <code>Coordinator</code>.
Each <code>RecoveryCoordinator</code> is implicitly associated with a single <code>Resource</code>.
It can drive the <code>Resource</code> through recovery procedures in the event of a failure which occurs during the transaction.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-resource-and-recoverycoordinator.png" alt="jts resource and recoverycoordinator">
</div>
<div class="title">Figure 19. <code>Resource</code> and <code>RecoveryCoordinator</code></div>
</div>
</div>
<div class="sect4">
<h5 id="_checked_transaction_behavior"><a class="anchor" href="#_checked_transaction_behavior"></a>Checked transaction behavior</h5>
<div class="paragraph">
<p>The OTS supports both checked and unchecked transaction behavior.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A transaction will not commit until all transactional objects involved in the transaction have completed their transactional requests.</p>
</li>
<li>
<p>Only the transaction originator can commit the transaction</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Checked transactional behavior is typical transaction behavior, and is widely implemented.
Checked behavior requires implicit propagation, because explicit propagation prevents the OTS from tracking which objects are involved in the transaction.</p>
</div>
<div class="paragraph">
<p>Unchecked behavior allows you to implement relaxed models of atomicity.
Any use of explicit propagation implies the possibility of unchecked behavior, since you as the programmer are in control of the behavior.
Even if you use implicit propagation, a server may unilaterally abort or commit the transaction using the <code>Current</code> interface, causing unchecked behavior.</p>
</div>
<div class="paragraph">
<p>Some OTS implementations enforce checked behavior for the transactions they support, to provide an extra level of transaction integrity.
The checks ensure that all transactional requests made by the application complete their processing before the transaction is committed.
A checked Transaction Service guarantees that commit fails unless all transactional objects involved in the transaction complete the processing of their transactional requests.
Rolling back the transaction does not require such as check, since all outstanding transactional activities will eventually roll back if they are not directed to commit.</p>
</div>
<div class="paragraph">
<p>There are many possible implementations of checking in a Transaction Service.
One provides equivalent function to that provided by the request and response inter-process communication models defined by X/Open.
The X/Open Transaction Service model of checking widely implemented.
It describes the transaction integrity guarantees provided by many existing transaction systems.
These transaction systems provide the same level of transaction integrity for object-based applications, by providing a Transaction Service interface that implements the X/Open checks.</p>
</div>
<div class="paragraph">
<p>In X/Open, completion of the processing of a request means that the object has completed execution of its method and replied to the request.
The level of transaction integrity provided by a Transaction Service implementing the X/Open model provides equivalent function to that provided by the XATMI and TxRPC interfaces defined by X/Open for transactional applications.
X/Open DTP Transaction Managers are examples of transaction management functions that implement checked transaction behavior.</p>
</div>
<div class="paragraph">
<p>This implementation of checked behavior depends on implicit transaction propagation.
When implicit propagation is used, the objects involved in a transaction at any given time form a tree, called the request tree for the transaction.
The beginner of the transaction is the root of the tree.
Requests add nodes to the tree, and replies remove the replying node from the tree.
Synchronous requests, or the checks described below for deferred synchronous requests, ensure that the tree collapses to a single node before commit is issued.</p>
</div>
<div class="paragraph">
<p>If a transaction uses explicit propagation, the Transaction Service has no way to know which objects are or will be involved in the transaction.
Therefore, the use of explicit propagation is not permitted by a Transaction Service implementation that enforces X/Open-style checked behavior.</p>
</div>
<div class="paragraph">
<p>Applications that use synchronous requests exhibit checked behavior.
If your application uses deferred synchronous requests, all clients and objects need to be under the control of a checking Transaction Service.
In that case, the Transaction Service can enforce checked behavior, by applying a <code>reply</code> check and a <code>committed</code> check.
The Transaction Service must also apply a <code>resume</code> check, so that the transaction is only resumed by applications in the correct part of the request tree.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reply</code> check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Before an object replies to a transactional request, a check is made to ensure that the object has received replies to all the deferred synchronous requests that propagated the transaction in the original request. If this condition is not met, an exception is raised and the transaction is marked as rollback-only. A Transaction Service may check that a reply is issued within the context of the transaction associated with the request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>commit</code> check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Before a commit can proceed, a check is made to ensure that the commit request for the transaction is being issued from the same execution environment that created the transaction, and that the client issuing commit has received replies to all the deferred synchronous requests it made that propagated the transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resume</code> check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Before a client or object associates a transaction context with its thread of control, a check is made to ensure that this transaction context was previously associated with the execution environment of the thread. This association would exist if the thread either created the transaction or received it in a transactional operation.</p></td>
</tr>
</tbody>
</table>
<div class="sect5">
<h6 id="_narayana_specifics_5"><a class="anchor" href="#_narayana_specifics_5"></a>Narayana specifics</h6>
<div class="paragraph">
<p>Where support from the ORB is available, Narayana supports X/Open checked transaction behavior.
However, unless the <code>OTS_CHECKED_TRANSACTIONS</code> property variable is set to <code>YES</code>, checked transactions are disabled.
This is the default setting.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Checked transactions are only possible with a co-located transaction manager.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In a multi-threaded application, multiple threads may be associated with a transaction during its lifetime, sharing the context.
In addition, if one thread terminates a transaction, other threads may still be active within it.
In a distributed environment, it can be difficult to guarantee that all threads have finished with a transaction when it terminates.
By default, Narayana issues a warning if a thread terminates a transaction when other threads are still active within it, but allow the transaction termination to continue.
You can choose to block the thread which is terminating the transaction until all other threads have disassociated themselves from its context, or use other methods to solve the problem.
Narayana provides the <code>com.arjuna.ats.arjuna.coordinator.CheckedAction</code> class, which allows you to override the thread and transaction termination policy.
Each transaction has an instance of this class associated with it, and you can implement the class on a per-transaction basis.</p>
</div>
<div class="listingblock">
<div class="title"><code>CheckedAction</code> implementation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CheckedAction</span> {
<span class="directive">public</span> CheckedAction ();

<span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> check (<span class="type">boolean</span> isCommit, Uid actUid, BasicList list);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a thread attempts to terminate the transaction and there active threads exist within it, the system invokes the <code>check</code> method on the transaction’s <code>CheckedAction</code> object.
The parameters to the check method are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>isCommit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates whether the transaction is in the process of committing or rolling back.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>actUid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction identifier.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>list</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of all of the threads currently marked as active within this transaction.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When <code>check</code> returns, the transaction termination continues.
Obviously the state of the transaction at this point may be different from that when check was called.</p>
</div>
<div class="paragraph">
<p>Set the <code>CheckedAction</code> instance associated with a given transaction with the <code>setCheckedAction</code> method of <code>Current</code>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_summary_of_narayana_implementation_decisions"><a class="anchor" href="#_summary_of_narayana_implementation_decisions"></a>Summary of Narayana implementation decisions</h5>
<div class="ulist">
<ul>
<li>
<p>Any execution environment (thread, process) can use a transaction <code>Control</code>.</p>
</li>
<li>
<p><code>Control</code> s, <code>Coordinator</code> s, and <code>Terminator</code> s are valid for use for the duration of the transaction if implicit transaction control is used, via <code>Current</code>.
If you use explicit control, via the <code>TransactionFactory</code> and <code>Terminator</code>, then use the destroyControl method of the OTS class in <code>com.arjuna.CosTransactions</code> to signal when the information can be garbage collected.</p>
</li>
<li>
<p>You can propagate <code>Coordinator</code> s and <code>Terminator</code> s between execution environments.</p>
</li>
<li>
<p>If you try to commit a transaction when there are still active subtransactions within it, Narayana rolls back the parent and the subtransactions.</p>
</li>
<li>
<p>Narayana includes full support for nested transactions.
However, if a resource raises an exception to the commitment of a sub-transaction after other resources have previously been told that the transaction committed, Narayana forces the enclosing transaction to abort.
This guarantees that all resources used within the sub-transaction are returned to a consistent state.
You can disable support for sub-transactions by setting the <code>OTS_SUPPORT_SUBTRANSACTIONS</code> variable to <code>NO</code>.</p>
</li>
<li>
<p>Obtain <code>Current</code> from the <code>get_current</code> method of the OTS.</p>
</li>
<li>
<p>A timeout value of zero seconds is assumed for a transaction if none is specified using <code>set_timeout</code>.</p>
</li>
<li>
<p>by default, <code>Current</code> does not use a separate transaction manager server by default.
Override this behavior by setting the <code>OTS_TRANSACTION_MANAGER</code> environment variable.
Location of the transaction manager is ORB-specific.</p>
</li>
<li>
<p>Checked transactions are disabled by default.
To enable them, set the <code>OTS_CHECKED_TRANSACTIONS</code> property to <code>YES</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_constructing_an_ots_application"><a class="anchor" href="#_constructing_an_ots_application"></a>4.2.4. Constructing an OTS application</h4>
<div class="sect4">
<h5 id="_important_notes_for_narayana"><a class="anchor" href="#_important_notes_for_narayana"></a>Important notes for Narayana</h5>
<div class="sect5">
<h6 id="_initialization"><a class="anchor" href="#_initialization"></a>Initialization</h6>
<div class="paragraph">
<p>Narayana must be correctly initialized before you create any application object.
To guarantee this, use the <code>initORB</code> and POA methods described in the <em>Orb Portability Guide</em>.
Consult <em>the Orb Portability Guide</em> if you need direct use of the <code>ORB_init</code> and <code>create_POA</code> methods provided by the underlying ORB.</p>
</div>
</div>
<div class="sect5">
<h6 id="_implicit_context_propagation_and_interposition"><a class="anchor" href="#_implicit_context_propagation_and_interposition"></a>Implicit context propagation and interposition</h6>
<div class="paragraph">
<p>If you need implicit context propagation and interposition, initialize Narayana correctly before you create any objects.
You can only use implicit context propagation on an ORB which supports filters and interceptors, or the <code>CosTSPortability</code> interface.
You can set <code>OTS_CONTEXT_PROP_MODE</code> to <code>CONTEXT</code> or <code>INTERPOSITION</code>, depending on which functionality you need.
If you are using the Narayana API, you need to use interposition.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_writing_applications_using_the_raw_ots_interfaces"><a class="anchor" href="#_writing_applications_using_the_raw_ots_interfaces"></a>Writing applications using the raw OTS interfaces</h5>
<div class="ulist">
<div class="title">Steps to participate in an OTS transaction</div>
<ul>
<li>
<p>Create <code>Resource</code> and <code>SubtransactionAwareResource</code> objects for each object which will participate within the transaction or sub-transaction.
These resources manage the persistence, concurrency control, and recovery for the object.
The OTS invokes these objects during the prepare, commit, or abort phase of the transaction or sub-transaction, and the Resources perform the work of the application.</p>
</li>
<li>
<p>Register <code>Resource</code> and <code>SubtransactionAwareResource</code> objects at the correct time within the transaction, and ensure that the object is only registered once within a given transaction.
As part of registration, a <code>Resource</code> receives a reference to a <code>RecoveryCoordinator</code>.
This reference must be made persistent, so that the transaction can recover in the event of a failure.</p>
</li>
<li>
<p>Correctly propagate resources such as locks to parent transactions and <code>SubtransactionAwareResource</code> objects.</p>
</li>
<li>
<p>Drive the crash recovery for each resource which was participating within the transaction, in the event of a failure.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The OTS does not provide any <code>Resource</code> implementations.
You need to provide these implementations.
The interfaces defined within the OTS specification are too low-level for most situations. Narayana is designed to make use of raw <em>Common Object Services (COS)</em> interfaces, but provides a higher-level API for building transactional applications and framework.
This API automates much of the work involved with participating in an OTS transaction.</p>
</div>
</div>
<div class="sect4">
<h5 id="_transaction_context_management"><a class="anchor" href="#_transaction_context_management"></a>Transaction context management</h5>
<div class="paragraph">
<p>If you use implicit transaction propagation, ensure that appropriate objects support the <code>TransactionalObject</code> interface.
Otherwise, you need to pass the transaction contexts as parameters to the relevant operations.</p>
</div>
<div class="sect5">
<h6 id="_a_transaction_originator_indirect_and_implicit"><a class="anchor" href="#_a_transaction_originator_indirect_and_implicit"></a>A transaction originator: indirect and implicit</h6>
<div class="listingblock">
<div class="title">Indirect and implicit transaction originator</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    ...
    txn_crt.begin();
    <span class="comment">// should test the exceptions that might be raised</span>
    ...
    <span class="comment">// the client issues requests, some of which involve</span>
    <span class="comment">// transactional objects;</span>
    BankAccount1.makeDeposit(deposit);
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>A transaction originator uses indirect context management and implicit transaction propagation.
<code>txn_crt</code> is a pseudo object supporting the <code>Current</code> interface.
The client uses the <code>begin</code> operation to start the transaction, which becomes implicitly associated with the originator’s thread of control.</p>
</div>
<div class="paragraph">
<p>The program commits the transaction associated with the client thread.
The <code>report_heuristics</code> argument is set to <code>false</code>, so the Transaction Service makes no reports about possible heuristic decisions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    ...
    txn_crt.commit(<span class="predefined-constant">false</span>);
    ...</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_transaction_originator_direct_and_explicit"><a class="anchor" href="#_transaction_originator_direct_and_explicit"></a>Transaction originator: direct and explicit</h6>
<div class="listingblock">
<div class="title">Direct and explicit transaction originator</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    ...
    org.omg.CosTransactions.Control c;
    org.omg.CosTransactions.Terminator t;
    org.omg.CosTransactions.Coordinator co;
    org.omg.CosTransactions.PropagationContext pgtx;

    c = TFactory.create(<span class="integer">0</span>);
    t = c.get_terminator();
    pgtx = c.get_coordinator().get_txcontext();
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This transaction originator uses direct context management and explicit transaction propagation.
The client uses a factory object supporting the <code>CosTransactions::TransactionFactory</code> interface to create a new transaction, and uses the returned <code>Control</code> object to retrieve the <code>Terminator</code> and <code>Coordinator</code> objects.</p>
</div>
<div class="paragraph">
<p>The client issues requests, some of which involve transactional objects.
This example uses explicit propagation of the context.
The <code>Control</code> object reference is passed as an explicit parameter of the request.
It is declared in the OMG IDL of the interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
transactional_object.do_operation(arg, pgtx);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The transaction originator uses the <code>Terminator</code> object to commit the transaction.
The <code>report_heuristics</code> argument is set to <code>false</code>, so the Transaction Service makes no reports about possible heuristic decisions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
t.commit(<span class="predefined-constant">false</span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_implementing_a_transactional_client"><a class="anchor" href="#_implementing_a_transactional_client"></a>Implementing a transactional client</h5>
<div class="paragraph">
<p>The <code>commit</code> operation of <code>Current</code> or the <code>Terminator</code> interface takes the <code>boolean</code> <code>report_heuristics</code> parameter.
If the <code>report_heuristics</code> argument is <code>false</code>, the commit operation can complete as soon as the <code>Coordinator</code> makes the decision to commit or roll back the transaction.
The application does not need to wait for the <code>Coordinator</code> to complete the commit protocol by informing all the participants of the outcome of the transaction.
This can significantly reduce the elapsed time for the commit operation, especially where participant <code>Resource</code> objects are located on remote network nodes.
However, no heuristic conditions can be reported to the application in this case.</p>
</div>
<div class="paragraph">
<p>Using the <code>report_heuristics</code> option guarantees that the commit operation does not complete until the <code>Coordinator</code> completes the commit protocol with all <code>Resource</code> objects involved in the transaction.
This guarantees that the application is informed of any non-atomic outcomes of the transaction, through one of the exceptions <code>HeuristicMixed</code> or <code>HeuristicHazard</code>.
However, it increases the application-perceived elapsed time for the commit operation.</p>
</div>
</div>
<div class="sect4">
<h5 id="_implementing_a_recoverable_server"><a class="anchor" href="#_implementing_a_recoverable_server"></a>Implementing a recoverable server</h5>
<div class="paragraph">
<p>A Recoverable Server includes at least one transactional object and one resource object, each of which have distinct responsibilities.</p>
</div>
<div class="sect5">
<h6 id="_transactional_object"><a class="anchor" href="#_transactional_object"></a>Transactional object</h6>
<div class="paragraph">
<p>The transactional object implements the transactional object&#8217;s operations and registers a <code>Resource</code> object with the <code>Coordinator</code>, so that the Recoverable Server&#8217;s resources, including any necessary recovery, can commit.</p>
</div>
<div class="paragraph">
<p>The <code>Resource</code> object identifies the involvement of the Recoverable Server in a particular transaction.
This requires a <code>Resource</code> object to only be registered in one transaction at a time.
Register a different <code>Resource</code> object for each transaction in which a recoverable server is concurrently involved.
A transactional object may receive multiple requests within the scope of a single transaction.
It only needs to register its involvement in the transaction once.
The <code>is_same_transaction</code> operation allows the transactional object to determine if the transaction associated with the request is one in which the transactional object is already registered.</p>
</div>
<div class="paragraph">
<p>The <code>hash_transaction</code> operations allow the transactional object to reduce the number of transaction comparisons it has to make.
All <code>Coordinators</code> for the same transaction return the same hash code.
The <code>is_same_transaction</code> operation only needs to be called on <code>Coordinators</code> with the same hash code as the <code>Coordinator</code> of the current request.</p>
</div>
</div>
<div class="sect5">
<h6 id="_resource_object"><a class="anchor" href="#_resource_object"></a>Resource object</h6>
<div class="paragraph">
<p>A <code>Resource</code> object participates in the completion of the transaction, updates the resources of the Recoverable Server in accordance with the transaction outcome, and ensures termination of the transaction, including across failures.</p>
</div>
</div>
<div class="sect5">
<h6 id="_reliable_servers"><a class="anchor" href="#_reliable_servers"></a>Reliable servers</h6>
<div class="paragraph">
<p>A <em>Reliable Server</em> is a special case of a Recoverable Server.
A Reliable Server can use the same interface as a Recoverable Server to ensure application integrity for objects that do not have recoverable state.
In the case of a Reliable Server, the transactional object can register a <code>Resource</code> object that replies <code>VoteReadOnly</code> to <code>prepare</code> if its integrity constraints are satisfied.
It replies <code>VoteRollback</code> if it finds a problem.
This approach allows the server to apply integrity constraints which apply to the transaction as a whole, rather than to individual requests to the server.</p>
</div>
</div>
<div class="sect5">
<h6 id="_examples_3"><a class="anchor" href="#_examples_3"></a>Examples</h6>
<div class="exampleblock">
<div class="title">Example 17. Reliable server</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C"><span class="comment">/*
  BankAccount1 is an object with internal resources. It inherits from both the TransactionalObject and the Resource interfaces:
*/</span>
interface BankAccount1:CosTransactions::TransactionalObject, CosTransactions::Resource {
    ...
    <span class="directive">void</span> makeDeposit (in <span class="predefined-type">float</span> amt);
    ...
}
<span class="comment">/* The corresponding Java class is: */</span>
public class BankAccount1 {
public <span class="directive">void</span> makeDeposit(<span class="predefined-type">float</span> amt);
    ...
}
<span class="comment">/*
  Upon entering, the context of the transaction is implicitly associated with the object’s thread. The pseudo object
  supporting the Current interface is used to retrieve the Coordinator object associated with the transaction.
*/</span>
<span class="directive">void</span> makeDeposit (<span class="predefined-type">float</span> amt) {
    org.omg.CosTransactions.Control c;
    org.omg.CosTransactions.Coordinator co;
    c = txn_crt.get_control();
    co = c.get_coordinator();
    ...
<span class="comment">/*
  Before registering the resource the object should check whether it has already been registered for the same
  transaction. This is done using the hash_transaction and is_same_transaction operations.  that this object registers
  itself as a resource. This imposes the restriction that the object may only be involved in one transaction at a
  time. This is not the recommended way for recoverable objects to participate within transactions, and is only used as an
  example.  If more parallelism is required, separate resource objects should be registered for involvement in the same
  transaction.
*/</span>
    RecoveryCoordinator r;
    r = co.register_resource(this);

    <span class="comment">// performs some transactional activity locally</span>
    balance = balance + f;
    num_transactions++;
    ...
    <span class="comment">// end of transactional operation</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Transactional object</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/*  A BankAccount2 is an object with external resources that inherits from the TransactionalObject interface: */</span>
<span class="type">interface</span> <span class="class">BankAccount2</span>: CosTransactions::TransactionalObject {
    ...
    void makeDeposit(in <span class="type">float</span> amt);
    ...
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">BankAccount2</span> {
<span class="directive">public</span> <span class="type">void</span> makeDeposit(<span class="type">float</span> amt);
    ...
}
<span class="comment">/*
Upon entering, the context of the transaction is implicitly associated with the object’s thread. The makeDeposit
operation performs some transactional requests on external, recoverable servers. The objects res1 and res2 are
recoverable objects. The current transaction context is implicitly propagated to these objects.
*/</span>
<span class="type">void</span> makeDeposit(<span class="type">float</span> amt) {
    balance = res1.get_balance(amt);
    balance = balance + amt;
    res1.set_balance(balance);
    res2.increment_num_transactions();
} <span class="comment">// end of transactional operation</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_failure_models"><a class="anchor" href="#_failure_models"></a>Failure models</h5>
<div class="paragraph">
<p>The Transaction Service provides atomic outcomes for transactions in the presence of application, system or communication failures.
From the viewpoint of each user object role, two types of failure are relevant:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A local failure, which affects the object itself.</p>
</li>
<li>
<p>An external failure, such as failure of another object or failure in the communication with an object.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The transaction originator and transactional server handle these failures in different ways.</p>
</div>
<div class="sect5">
<h6 id="_transaction_originator"><a class="anchor" href="#_transaction_originator"></a>Transaction originator</h6>
<div class="dlist">
<dl>
<dt class="hdlist1">Local failure</dt>
<dd>
<p>If a Transaction originator fails before the originator issues <code>commit</code>, the transaction is rolled back.
If the originator fails after issuing commit and before the outcome is reported, the transaction can either commit or roll back, depending on timing.
In this case, the transaction completes without regard to the failure of the originator.</p>
</dd>
<dt class="hdlist1">External failure</dt>
<dd>
<p>Any external failure which affects the transaction before the originator issues <code>commit</code> causes the transaction to roll back.
The standard exception <code>TransactionRolledBack</code> is raised in the originator when it issues <code>commit</code>.</p>
<div class="paragraph">
<p>If a failure occurs after commit and before the outcome is reported, the client may not be informed of the outcome of the transaction.
This depends on the nature of the failure, and the use of the <code>report_heuristics</code> option of <code>commit</code>.
For example, the transaction outcome is not reported to the client if communication between the client and the <code>Coordinator</code> fails.</p>
</div>
<div class="paragraph">
<p>A client can determine the outcome of the transaction by using method <code>get_status</code> on the <code>Coordinator</code>.
However, this is not reliable because it may return the status <code>NoTransaction</code>, which is ambiguous.
The transaction could have committed and been forgotten, or it could have rolled back and been forgotten.</p>
</div>
<div class="paragraph">
<p>An originator is only guaranteed to know the transaction outcome in one of two ways.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if its implementation includes a <code>Resource</code> object, so that it can participate in the two-phase commit procedure.</p>
</li>
<li>
<p>The originator and <code>Coordinator</code> must be located in the same failure domain.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect5">
<h6 id="_transactional_server"><a class="anchor" href="#_transactional_server"></a>Transactional server</h6>
<div class="dlist">
<dl>
<dt class="hdlist1">Local failure</dt>
<dd>
<p>If the Transactional Server fails, optional checks by a Transaction Service implementation may make the transaction to roll back.
Without such checks, whether the transaction rolls back depends on whether the commit decision is already made, such as when an unchecked client invokes <code>commit</code> before receiving all replies from servers.</p>
</dd>
<dt class="hdlist1">External failure</dt>
<dd>
<p>Any external failure affecting the transaction during the execution of a Transactional Server causes the transaction to be rolled back.
If the failure occurs while the transactional object’s method is executing, the failure has no effect on the execution of this method.
The method may terminate normally, returning the reply to its client.
Eventually the <code>TransactionRolledBack</code> exception is returned to a client issuing <code>commit</code>.</p>
</dd>
<dt class="hdlist1">Recoverable server</dt>
<dd>
<p>Behavior of a recoverable server when failures occur is determined by the two phase commit protocol between the <code>Coordinator</code> and the recoverable server’s <code>Resource</code> object.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_summary_2"><a class="anchor" href="#_summary_2"></a>Summary</h5>
<div class="paragraph">
<p>When you develop OTS applications which use the raw OTS interfaces, be aware of the following items:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create <code>Resource</code> and <code>SubtransactionAwareResource</code> objects for each object which will participate within the transaction or sub-transaction.
These resources handle the persistence, concurrency control, and recovery for the object.
The OTS invokes these objects during the prepare, commit, and abort phases of the transaction or sub-transaction, and the <code>Resources</code> then perform all appropriate work.</p>
</li>
<li>
<p>Register <code>Resource</code> and <code>SubtransactionAwareResource</code> objects at the correct time within the transaction, and ensure that the object is only registered once within a given transaction.
As part of registration, a <code>Resource</code> receives a reference to a <code>RecoveryCoordinator</code>, which must be made persistent so that recovery can occur in the event of a failure.</p>
</li>
<li>
<p>For nested transactions, make sure that any propagation of resources, such as locks to parent transactions, are done correctly.
You also need to manage propagation of <code>SubtransactionAwareResource</code> objects to parents.</p>
</li>
<li>
<p>in the event of failures, drive the crash recovery for each <code>Resource</code> which participates within the transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The OTS does not provide any <code>Resource</code> implementations.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_narayana_interfaces_for_extending_the_ots"><a class="anchor" href="#_narayana_interfaces_for_extending_the_ots"></a>4.2.5. Narayana interfaces for extending the OTS</h4>
<div class="paragraph">
<p>This chapter contains a description of the use of the Narayana classes you can use to extend the OTS interfaces.
These advanced interfaces are all written on top of the basic OTS engine described previously, and applications which use them run on other OTS implementations, only without the added functionality.</p>
</div>
<div class="dlist">
<div class="title">Features</div>
<dl>
<dt class="hdlist1">AtomicTransaction</dt>
<dd>
<p>Provides a more manageable interface to the OTS transaction than <code>CosTransactions::Current</code>. It automatically keeps track of transaction scope, and allows you to create nested top-level transactions in a more natural manner than the one provided by the OTS.</p>
</dd>
<dt class="hdlist1">Advanced subtransaction-Resource classes</dt>
<dd>
<p>Allow nested transactions to use a two-phase commit protocol.
These Resources can also be ordered within Narayana, enabling you to control the order in which <code>Resource</code> s are called during the commit or abort protocol.</p>
</dd>
<dt class="hdlist1">Implicit context propagation between client and server</dt>
<dd>
<p>Where available, Narayana uses implicit context propagation between client and server.
Otherwise, Narayana provides an explicit interposition class, which simplifies the work involved in interposition.
The Narayana API, <em>Transactional Objects for Java (TXOJ)</em>, requires either explicit or implicit interposition.
This is even true in a stand-alone mode when using a separate transaction manager.
TXOJ is fully described in the <em>ArjunaCore Development Guide</em>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>the extensions to the <code>CosTransactions.idl</code> are located in the <code>com.arjuna.ArjunaOTS</code> package and the <code>ArjunaOTS.idl</code> file.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_nested_transactions_4"><a class="anchor" href="#_nested_transactions_4"></a>Nested transactions</h5>
<div class="paragraph">
<p>The OTS implementation of nested transactions is extremely limited, and can lead to the generation of inconsistent results.
One example is a scenario in which a sub-transaction coordinator discovers part of the way through committing that a resources cannot commit.
It may not be able to tell the committed resources to abort.</p>
</div>
<div class="paragraph">
<p>In most transactional systems which support sub-transactions, the sub-transaction commit protocol is the same as a top-level transaction’s.
There are two phases, a <code>prepare</code> phase and a <code>commit</code> or <code>abort</code> phase.
Using a multi-phase commit protocol avoids the above problem of discovering that one resources cannot commit after others have already been told to commit.
The <code>prepare</code> phase generates consensus on the commit outcome, and the <code>commit</code> or <code>abort</code> phase enforces the outcome.</p>
</div>
<div class="paragraph">
<p>Narayana supports the strict OTS implementation of sub-transactions for those resources derived from <code>CosTransactions::SubtransactionAwareResource</code>.
However, if a resource is derived from <code>ArjunaOTS::ArjunaSubtranAwareResource</code>, it is driven by a two-phase commit protocol whenever a nested transaction commits.</p>
</div>
<div class="listingblock">
<div class="title">ArjunaSubtranAwareResource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SubtransactionAwareResource {
    CosTransactions::Vote prepare_subtransaction();
} : CosTransactions::

<span class="type">interface</span> <span class="class">ArjunaSubtranAwareResource</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>During the first phase of the commit protocol the <code>prepare_subtransaction</code> method is called, and the resource behaves as though it were being driven by a top-level transaction, making any state changes provisional upon the second phase of the protocol.
Any changes to persistent state must still be provisional upon the second phase of the top-level transaction, as well.
Based on the votes of all registered resources, Narayana then calls either <code>commit_subtransaction</code> or <code>rollback_subtransaction</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This scheme only works successfully if all resources registered within a given sub-transaction are instances of the <code>ArjunaSubtranAwareResource</code> interface, and that after a resource tells the coordinator it can prepare, it does not change its mind.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_extended_resources"><a class="anchor" href="#_extended_resources"></a>Extended resources</h5>
<div class="paragraph">
<p>When resources are registered with a transaction, the transaction maintains them within a list, called the <em>intentions list</em>.
At termination time, the transaction uses the intentions list to drive each resource appropriately, to commit or abort.
However, you have no control over the order in which resources are called, or whether previously-registered resources should be replaced with newly registered resources.
The Narayana interface <code>ArjunaOTS::OTSAbstractRecord</code> gives you this level of control.</p>
</div>
<div class="listingblock">
<div class="title">OTSAbstractRecord</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">OTSAbstractRecord</span> : ArjunaSubtranAwareResource {
    readonly attribute <span class="type">long</span> typeId;
    readonly attribute string uid;

    <span class="type">boolean</span> propagateOnAbort ();
    <span class="type">boolean</span> propagateOnCommit ();

    <span class="type">boolean</span> saveRecord ();
    <span class="type">void</span> merge (in OTSAbstractRecord record);
    <span class="type">void</span> alter (in OTSAbstractRecord record);

    <span class="type">boolean</span> shouldAdd (in OTSAbstractRecord record);
    <span class="type">boolean</span> shouldAlter (in OTSAbstractRecord record);
    <span class="type">boolean</span> shouldMerge (in OTSAbstractRecord record);
    <span class="type">boolean</span> shouldReplace (in OTSAbstractRecord record);
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>typeId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns the record type of the instance. This is one of the values of the enumerated type <code>Record_type</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a stringified Uid for this record.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>propagateOnAbort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">by default, instances of <code>OTSAbstractRecord</code> should not be propagated to the parent transaction if the current transaction rolls back. By returning <code>TRUE</code>, the instance will be propagated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>propagateOnCommit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returning <code>TRUE</code> from this method causes the instance to be propagated to the parent transaction if the current transaction commits. Returning <code>FALSE</code> disables the propagation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>saveRecord</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returning <code>TRUE</code> from this method causes Narayana to try to save sufficient information about the record to persistent state during commit, so that crash recovery mechanisms can replay the transaction termination in the event of a failure. If <code>FALSE</code> is returned, no information is saved.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>merge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">used when two records need to merge together.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>alter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">used when a record should be altered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shouldAdd</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns <code>true</code> ii the record should be added to the list, <code>false</code> if it should be discarded.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shouldMerge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns <code>true</code> if the two records should be merged into a single record, <code>false</code> otherwise.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shouldReplace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns <code>true</code> if the record should replace an existing one, <code>false</code> otherwise.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When inserting a new record into the transaction’s intentions list, Narayana uses the following algorithm:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>if a record with the same type and uid has already been inserted, then the methods <code>shouldAdd</code>, and related methods, are invoked to determine whether this record should also be added.</p>
</li>
<li>
<p>If no such match occurs, then the record is inserted in the intentions list based on the <code>type</code> field, and ordered according to the uid.
All of the records with the same type appear ordered in the intentions list.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>OTSAbstractRecord</code> is derived from <code>ArjunaSubtranAwareResource</code>.
Therefore, all instances of <code>OTSAbstractRecord</code> inherit the benefits of this interface.</p>
</div>
</div>
<div class="sect4">
<h5 id="_atomictransaction"><a class="anchor" href="#_atomictransaction"></a>AtomicTransaction</h5>
<div class="paragraph">
<p>In terms of the OTS, <code>AtomicTransaction</code> is the preferred interface to the OTS protocol engine.
It is equivalent to <code>CosTransactions::Current</code>, but with more emphasis on easing application development.
For example, if an instance of <code>AtomicTransaction</code> goes out of scope before it terminates, the transaction automatically rolls back.
<code>CosTransactions::Current</code> cannot provide this functionality.
When building applications using Narayana, use <code>AtomicTransaction</code> for the added benefits it provides.
It is located in the <code>com.arjuna.ats.jts.extensions.ArjunaOTS</code> package.</p>
</div>
<div class="listingblock">
<div class="title">AtomicTransaction</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AtomicTransaction</span> {
    <span class="directive">public</span> AtomicTransaction ();
    <span class="directive">public</span> <span class="type">void</span> begin () <span class="directive">throws</span> SystemException, SubtransactionsUnavailable, NoTransaction;
    <span class="directive">public</span> <span class="type">void</span> commit (<span class="type">boolean</span> report_heuristics) <span class="directive">throws</span> SystemException, NoTransaction, HeuristicMixed, HeuristicHazard,TransactionRolledBack;
    <span class="directive">public</span> <span class="type">void</span> rollback () <span class="directive">throws</span> SystemException, NoTransaction;
    <span class="directive">public</span> <span class="predefined-type">Control</span> control () <span class="directive">throws</span> SystemException, NoTransaction;
    <span class="directive">public</span> Status get_status () <span class="directive">throws</span> SystemException;
    <span class="comment">/* Allow action commit to be supressed */</span>
    <span class="directive">public</span> <span class="type">void</span> rollbackOnly () <span class="directive">throws</span> SystemException, NoTransaction;

    <span class="directive">public</span> <span class="type">void</span> registerResource (Resource r) <span class="directive">throws</span> SystemException, Inactive;
    <span class="directive">public</span> <span class="type">void</span> registerSubtransactionAwareResource (SubtransactionAwareResource) <span class="directive">throws</span> SystemException, NotSubtransaction;
    <span class="directive">public</span> <span class="type">void</span> registerSynchronization(Synchronization s) <span class="directive">throws</span> SystemException, Inactive;
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. AtomicTransaction&#8217;s Methods</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>begin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starts an action</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>commit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commits an action</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollback</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abort an action</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Transaction nesting is determined dynamically.
Any transaction started within the scope of another running transaction is nested.</p>
</div>
<div class="paragraph">
<p>The <code>TopLevelTransaction</code> class, which is derived from <code>AtomicTransaction</code>, allows creation of nested top-level transactions.
Such transactions allow non-serializable and potentially non-recoverable side effects to be initiated from within a transaction, so use them with caution.
You can create nested top-level transactions with a combination of the <code>CosTransactions::TransactionFactory</code> and the <code>suspend</code> and <code>resume</code> methods of <code>CosTransactions::Current</code>.
However, the <code>TopLevelTransaction</code> class provides a more user-friendly interface.</p>
</div>
<div class="paragraph">
<p><code>AtomicTransaction</code> and <code>TopLevelTransaction</code> are completely compatible with <code>CosTransactions::Current</code>.
You an use the two transaction mechanisms interchangeably within the same application or object.</p>
</div>
<div class="paragraph">
<p><code>AtomicTransaction</code> and <code>TopLevelTransaction</code> are similar to <code>CosTransactions::Current</code>.
They both simplify the interface between you and the OTS.
However, you gain two advantages by using <code>AtomicTransaction</code> or <code>TopLevelTransaction</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The ability to create nested top-level transactions which are automatically associated with the current thread.
When the transaction ends, the previous transaction associated with the thread, if any, becomes the thread’s current transaction.</p>
</li>
<li>
<p>Instances of <code>AtomicTransaction</code> track scope, and if such an instance goes out of scope before it is terminated, it is automatically aborted, along with its children.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_context_propagation_issues"><a class="anchor" href="#_context_propagation_issues"></a>Context propagation issues</h5>
<div class="paragraph">
<p>When using TXOJ in a distributed manner, Narayana requires you to use interposition between client and object.
This requirement also exists if the application is local, but the transaction manager is remote.
In the case of implicit context propagation, where the application object is derived from <code>CosTransactions::TransactionalObject</code>, you do not need to do anything further. Narayana automatically provides interposition.
However, where implicit propagation is not supported by the ORB, or your application does not use it, you must take additional action to enable interposition.</p>
</div>
<div class="paragraph">
<p>The class <code>com.arjuna.ats.jts.ExplicitInterposition</code> allows an application to create a local control object which acts as a local coordinator, fielding registration requests that would normally be passed back to the originator.
This surrogate registers itself with the original coordinator, so that it can correctly participate in the commit protocol.
The application thread context becomes the surrogate transaction hierarchy.
Any transaction context currently associated with the thread is lost.
The interposition lasts for the lifetime of the explicit interposition object, at which point the application thread is no longer associated with a transaction context.
Instead, it is set to <code>null</code>.</p>
</div>
<div class="paragraph">
<p>interposition is intended only for those situations where the transactional object and the transaction occur within different processes, rather than being co-located.
If the transaction is created locally to the client, do not use the explicit interposition class.
The transaction is implicitly associated with the transactional object because it resides within the same process.</p>
</div>
<div class="listingblock">
<div class="title">ExplicitInterposition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ExplicitInterposition</span> {
    <span class="directive">public</span> ExplicitInterposition();

    <span class="directive">public</span> <span class="type">void</span> registerTransaction(<span class="predefined-type">Control</span> control) <span class="directive">throws</span> InterpositionFailed, SystemException;

    <span class="directive">public</span> <span class="type">void</span> unregisterTransaction() <span class="directive">throws</span> InvalidTransaction, SystemException;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A transaction context can be propagated between client and server in two ways: either as a reference to the client’s transaction Control, or explicitly sent by the client.
Therefore, there are two ways in which the interposed transaction hierarchy can be created and registered.
For example, consider the class Example which is derived from LockManager and has a method increment:</p>
</div>
<div class="listingblock">
<div class="title">ExplicitInterposition Example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">boolean</span> increment(<span class="predefined-type">Control</span> control) {
    ExplicitInterposition inter = <span class="keyword">new</span> ExplicitInterposition();

    <span class="keyword">try</span> {
        inter.registerTransaction(control);
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }

    <span class="comment">// do real work</span>

    <span class="comment">// should catch exceptions!</span>
    inter.unregisterTransaction();

    <span class="comment">// return value dependant upon outcome</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>if the <code>Control</code> passed to the <code>register</code> operation of <code>ExplicitInterposition</code> is <code>null</code>, no exception is thrown.
The system assumes that the client did not send a transaction context to the server.
A transaction created within the object will thus be a top-level transaction.</p>
</div>
<div class="paragraph">
<p>When the application returns, or when it finishes with the interposed hierarchy, the program should call <code>unregisterTransaction</code> to disassociate the thread of control from the hierarchy.
This occurs automatically when the <code>ExplicitInterposition</code> object is garbage collected.
However, since this may be after the transaction terminates, Narayana assumes the thread is still associated with the transaction and issues a warning about trying to terminate a transaction while threads are still active within it.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_2"><a class="anchor" href="#_example_2"></a>4.2.6. Example</h4>
<div class="paragraph">
<p>This example illustrates the concepts and the implementation details for a simple client/server example using implicit context propagation and indirect context management.</p>
</div>
<div class="sect4">
<h5 id="_the_basic_example"><a class="anchor" href="#_the_basic_example"></a>The basic example</h5>
<div class="paragraph">
<p>This example only includes a single unit of work within the scope of the transaction.
Consequently, only a one-phase commit is needed.</p>
</div>
<div class="paragraph">
<p>The client and server processes are both invoked using the <code>implicit propagation</code> and <code>interposition</code> command-line options.</p>
</div>
<div class="paragraph">
<p>For the purposes of this worked example, a single method implements the <code>DemoInterface</code> interface.
This method is used in the DemoClient program.</p>
</div>
<div class="listingblock">
<div class="title">idl interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="error">#</span>include &lt;idl/CosTransactions.idl&gt;
<span class="error">#</span>pragma javaPackage <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>

module Demo {
    exception DemoException {};

    <span class="type">interface</span> <span class="class">DemoInterface</span> : CosTransactions::TransactionalObject {
        <span class="type">void</span> work() raises (DemoException);
    }
}</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="_example_implementation_of_the_interface"><a class="anchor" href="#_example_implementation_of_the_interface"></a>Example implementation of the interface</h6>
<div class="paragraph">
<p>This section deals with the pieces needed to implement the example interface.</p>
</div>
<div class="sect6">
<h7 id="_resource_2"><a class="anchor" href="#_resource_2"></a>Resource</h7>
<div class="paragraph">
<p>The example overrides the methods of the <code>Resource</code> implementation class.
The <code>DemoResource</code> implementation includes the placement of <code>System.out.println</code> statements at judicious points, to highlight when a particular method is invoked.</p>
</div>
<div class="paragraph">
<p>Only a single unit of work is included within the scope of the transaction.
Therefore, the <code>prepare</code> or <code>commit</code> methods should never be invoked, but the <code>commit_one_phase</code> method should be invoked.</p>
</div>
<div class="listingblock">
<div class="title">DemoResource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.omg.CosTransactions</span>.*;
<span class="keyword">import</span> <span class="include">org.omg.CORBA.SystemException</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoResource</span> <span class="directive">extends</span> org.omg.CosTransactions.ResourcePOA {
    <span class="directive">public</span> Vote prepare() <span class="directive">throws</span> HeuristicMixed, HeuristicHazard, SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">prepare called</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> Vote.VoteCommit;
    }

    <span class="directive">public</span> <span class="type">void</span> rollback() <span class="directive">throws</span> HeuristicCommit, HeuristicMixed, HeuristicHazard, SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">rollback called</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> commit() <span class="directive">throws</span> NotPrepared, HeuristicRollback, HeuristicMixed, HeuristicHazard, SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">commit called</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> commit_one_phase() <span class="directive">throws</span> HeuristicHazard, SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">commit_one_phase called</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> forget() <span class="directive">throws</span> SystemException {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">forget called</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_transactional_implementation"><a class="anchor" href="#_transactional_implementation"></a>Transactional implementation</h7>
<div class="paragraph">
<p>At this stage, the <em>Demo.idl</em> has been processed by the ORB&#8217;s idl compiler to generate the necessary client and server package.</p>
</div>
<div class="paragraph">
<p>Line 14 returns the transactional context for the <code>Current</code> pseudo object.
After obtaining a <code>Control</code> object, you can derive the Coordinator object (line 16).</p>
</div>
<div class="paragraph">
<p>Lines 17 and 19 create a resource for the transaction, and then inform the ORB that the resource is ready to receive incoming method invocations.</p>
</div>
<div class="paragraph">
<p>Line 20 uses the <code>Coordinator</code> to register a <code>DemoResource</code> object as a participant in the transaction.
When the transaction terminates, the resource receives requests to commit or rollback the updates performed as part of the transaction.</p>
</div>
<div class="listingblock">
<div class="title">Transactional implementation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">Demo</span>.*;
<span class="keyword">import</span> <span class="include">org.omg.CosTransactions</span>.*;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts</span>.*;
<span class="keyword">import</span> <span class="include">com.arjuna.orbportability</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoImplementation</span> <span class="directive">extends</span> Demo.DemoInterfacePOA {
    <span class="directive">public</span> <span class="type">void</span> work() <span class="directive">throws</span> DemoException {
        <span class="keyword">try</span> {

            <span class="predefined-type">Control</span> control = OTSManager.get_current().get_control();

            Coordinator coordinator = control.get_coordinator();
            DemoResource resource = <span class="keyword">new</span> DemoResource();

            ORBManager.getPOA().objectIsReady(resource);
            coordinator.register_resource(resource);

        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="keyword">throw</span> <span class="keyword">new</span> DemoException();
        }
    }
}          </code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_server_implementation"><a class="anchor" href="#_server_implementation"></a>Server implementation</h7>
<div class="paragraph">
<p>First, you need to to initialize the ORB and the POA.
Lines 10 through 14 accomplish these tasks.</p>
</div>
<div class="paragraph">
<p>The servant class <code>DemoImplementation</code> contains the implementation code for the <code>DemoInterface</code> interface.
The servant services a particular client request.
Line 16 instantiates a servant object for the subsequent servicing of client requests.</p>
</div>
<div class="paragraph">
<p>Once a servant is instantiated, connect the servant to the POA, so that it can recognize the invocations on it, and pass the invocations to the correct servant.
Line 18 performs this task.</p>
</div>
<div class="paragraph">
<p>Lines 20 through to 21 registers the service through the default naming mechanism.
More information about the options available can be found in the ORB Portability Guide.</p>
</div>
<div class="paragraph">
<p>If this registration is successful, line 23 outputs a <code>sanity check</code> message.</p>
</div>
<div class="paragraph">
<p>Finally, line 25 places the server process into a state where it can begin to accept requests from client processes.</p>
</div>
<div class="listingblock">
<div class="title">DemoServer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.io</span>.*;

<span class="keyword">import</span> <span class="include">com.arjuna.orbportability</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoServer</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        <span class="keyword">try</span> {
            ORB myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>).initORB(args, <span class="predefined-constant">null</span>);
            RootOA myOA = OA.getRootOA(myORB).myORB.initOA();

            ORBManager.setORB(myORB);
            ORBManager.setPOA(myOA);

            DemoImplementation obj = <span class="keyword">new</span> DemoImplementation();

            myOA.objectIsReady(obj);

            Services serv = <span class="keyword">new</span> Services(myORB);
            serv.registerService(myOA.corbaReference(obj), <span class="string"><span class="delimiter">&quot;</span><span class="content">DemoObjReference</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>);

            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Object published.</span><span class="delimiter">&quot;</span></span>);

            myOA.run();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(e);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After the server compiles, you can use the command line options defined below to start a server process.
By specifying the usage of a filter on the command line, you can override settings in the <em>TransactionService.properties</em> file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>if you specify the interposition filter, you also imply usage of implicit context propagation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="_client_implementation"><a class="anchor" href="#_client_implementation"></a>Client implementation</h7>
<div class="paragraph">
<p>The client, like the server, requires you to first initialize the ORB and the POA.
Lines 14 through 18 accomplish these tasks.</p>
</div>
<div class="paragraph">
<p>After a server process is started, you can obtain the object reference through the default publication mechanism used to publish it in the server.
This is done in lines 20 and 21.
Initially the reference is an instance of <code>Object</code>.
However, to invoke a method on the servant object, you need to narrow this instance to an instance of the <code>DemoInterface</code> interface.
This is shown in line 21.</p>
</div>
<div class="paragraph">
<p>Once we have a reference to this servant object, we can start a transaction (line 23), perform a unit of work (line 25) and commit the transaction (line 27).</p>
</div>
<div class="listingblock">
<div class="title">DemoClient</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">Demo</span>.*;

<span class="keyword">import</span> <span class="include">java.io</span>.*;

<span class="keyword">import</span> <span class="include">com.arjuna.orbportability</span>.*;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts</span>.*;
<span class="keyword">import</span> <span class="include">org.omg.CosTransactions</span>.*;
<span class="keyword">import</span> <span class="include">org.omg</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoClient</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        <span class="keyword">try</span> {
            ORB myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>).initORB(args, <span class="predefined-constant">null</span>);
            RootOA myOA = OA.getRootOA(myORB).myORB.initOA();

            ORBManager.setORB(myORB);
            ORBManager.setPOA(myOA);

            Services serv = <span class="keyword">new</span> Services(myORB);
            DemoInterface d = (DemoInterface) DemoInterfaceHelper.narrow(serv.getService(<span class="string"><span class="delimiter">&quot;</span><span class="content">DemoObjReference</span><span class="delimiter">&quot;</span></span>));

            OTS.get_current().begin();

            d.work();

            OTS.get_current().commit(<span class="predefined-constant">true</span>);
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(e);
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_sequence_diagram"><a class="anchor" href="#_sequence_diagram"></a>Sequence diagram</h7>
<div class="paragraph">
<p>The sequence diagram illustrates the method invocations that occur between the client and server.
The following aspects are important:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You do not need to pass the transactional context as a parameter in method <code>work</code>, since you are using implicit context propagation.</p>
</li>
<li>
<p>Specifying the use of interposition when the client and server processes are started, by using appropriate filters and interceptors, creates an interposed coordinator that the servant process can use, negating any requirement for cross-process invocations.
The interposed coordinator is automatically registered with the root coordinator at the client.</p>
</li>
<li>
<p>The resource that commits or rolls back modifications made to the transactional object is associated, or registered, with the interposed coordinator.</p>
</li>
<li>
<p>The <code>commit</code> invocation in the client process calls the root coordinator.
The root coordinator calls the interposed coordinator, which in turn calls the <code>commit_one_phase</code> method for the resource.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jts-sequence-diagram.png" alt="jts sequence diagram">
</div>
<div class="title">Figure 20. Sequence Diagram</div>
</div>
</div>
<div class="sect6">
<h7 id="_interpretation_of_output"><a class="anchor" href="#_interpretation_of_output"></a>Interpretation of output</h7>
<div class="paragraph">
<p>The server process first stringifies the servant instance, and writes the servant IOR to a temporary file.
The first line of output is the sanity check that the operation was successful.</p>
</div>
<div class="paragraph">
<p>In this simplified example, the coordinator object has only a single registered resource.
Consequently, it performs a <code>commit_one_phase</code> operation on the resource object, instead of performing a <code>prepare</code> operation, followed by a <code>commit</code> or <code>rollback</code>.</p>
</div>
<div class="paragraph">
<p>The output is identical, regardless of whether implicit context propagation or interposition is used, since interposition is essentially performance aid.
Ordinarily, you may need to do a lot of marshaling between a client and server process.</p>
</div>
<div class="exampleblock">
<div class="title">Example 18. Server output</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>Object reference written to file
commit_one_phase called</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_default_settings"><a class="anchor" href="#_default_settings"></a>Default settings</h5>
<div class="paragraph">
<p>These settings are defaults, and you can override them at run-time by using property variables, or in the properties file in the <code>etc/</code> directory of the installation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Unless a CORBA object is derived from <code>CosTransactions::TransactionalObject</code>,you do not need to propagate any context.
In order to preserve distribution transparency, Narayana defaults to always propagating a transaction context when calling remote objects, regardless of whether they are marked as transactional objects.
You can override this by setting the <code>com.arjuna.ats.jts.alwaysPropagateContext</code> property variable to <code>NO</code>.</p>
</li>
<li>
<p>If an object is derived from <code>CosTransactions::TransactionalObject</code>, and no client context is present when an invocation is made, Narayana transmits a null context.
Subsequent transactions begun by the object are top-level.
If a context is required, then set the <code>com.arjuna.ats.jts.needTranContext</code> property variable to <code>YES</code>, in which case Narayana raises the <em>TransactionRequired</em> exception.</p>
</li>
<li>
<p>Narayana needs a persistent object store, so that it can record information about transactions in the event of failures.
If all transactions complete successfully, this object store has no entries.
The default location for this must be set using the <code>ObjectStoreEnvironmentBean.objectStoreDir</code> variable in the properties file.</p>
</li>
<li>
<p>If you use a separate transaction manager for <code>Current</code>, its location is obtained from the <em>CosServices.cfg</em> file.
<em>CosServices.cfg</em> is located at runtime by the <code>OrbPortabilityEnvironmentBean</code> properties <code>initialReferencesRoot</code> and <code>initialReferencesFile</code>.
The former is a directory, defaulting to the current working directory.
The latter is a file name, relative to the directory.
The default value is <code>CosServices.cfg</code> .</p>
</li>
<li>
<p>Checked transactions are not enabled by default.
This means that threads other than the transaction creator may terminate the transaction, and no check is made to ensure all outstanding requests have finished prior to transaction termination.
To override this, set the <code>JTSEnvironmentBean.checkedTransactions</code> property variable to <code>YES</code>.</p>
</li>
<li>
<p></p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As of Narayana 4.5, transaction timeouts are unified across all transaction components and are controlled by ArjunaCore.
The old JTS configuration property com.arjuna.ats.jts.defaultTimeout still remains but is deprecated.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>if a value of <code>0</code> is specified for the timeout of a top-level transaction, or no timeout is specified, Narayana does not impose any timeout on the transaction.
To override this default timeout, set the <code>CoordinatorEnvironmentBean.defaultTimeout</code> property variable to the required timeout value in seconds.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_trail_map"><a class="anchor" href="#_trail_map"></a>4.2.7. Trail map</h4>
<div class="sect4">
<h5 id="_introduction_6"><a class="anchor" href="#_introduction_6"></a>Introduction</h5>
<div class="paragraph">
<p>Narayana assures complete, accurate business transactions for any Java based applications, including those written for the Jakarta EE and EJB frameworks.</p>
</div>
<div class="paragraph">
<p>Narayana is a 100% Java implementation of a distributed transaction management system based on the Jakarta EE Java Transaction Service (JTS) standard.
Our implementation of the JTS utilizes the Object Management Group&#8217;s (OMG) Object Transaction Service (OTS) model for transaction interoperability as recommended in the Jakarta EE and EJB standards.
Although any JTS-compliant product will allow Java objects to participate in transactions, one of the key features of Narayana is it&#8217;s 100% Java implementation.
This allows Narayana to support fully distributed transactions that can be coordinated by distributed parties.</p>
</div>
<div class="paragraph">
<p>Narayana runs can be run both as an embedded distributed service of an application server (e.g. WildFly Application Server), affording the user all the added benefits of the application server environment such as real-time load balancing, unlimited linear scalability and unmatched fault tolerance that allows you to deliver an always-on solution to your customers.
It is also available as a free-standing Java Transaction Service.</p>
</div>
<div class="paragraph">
<p>In addition to providing full compliance with the latest version of the JTS specification, Narayana leads the market in providing many advanced features such as fully distributed transactions and ORB portability with POA support.</p>
</div>
<div class="paragraph">
<p>Narayana is tested on HP-UX 11i, Red Hat Linux, Windows Server 2003, and Sun Solaris 10, using Sun&#8217;s JDK 5.
It should howerver work on any system with JDK 5 or 6.</p>
</div>
<div class="paragraph">
<p>The Java Transaction API support for Narayana comes in two flavours:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a purely local implementation, that does not require an ORB, but obviously requires all coordinated resources to reside within the same JVM.</p>
</li>
<li>
<p>a fully distributed implementation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Key features</p>
</div>
<div class="ulist">
<ul>
<li>
<p>full compliance with the Jakarta Transactions specification:</p>
<div class="ulist">
<ul>
<li>
<p>Purely local (ORB-less) JTA offers the fastest JTA performance</p>
</li>
<li>
<p>JDBC support</p>
</li>
<li>
<p>XA compliance</p>
</li>
<li>
<p>JDBC drivers for database access with full transaction support</p>
</li>
<li>
<p>Automatic crash recovery for XAResources</p>
</li>
</ul>
</div>
</li>
<li>
<p>compliance with the JTS specification and OTS 1.2 specification from the OMG</p>
<div class="ulist">
<ul>
<li>
<p>Distributed JTA implementation</p>
</li>
<li>
<p>support for distributed transactions (utilizing two-phase commit)</p>
</li>
<li>
<p>POA ORB support</p>
</li>
<li>
<p>interposition</p>
</li>
<li>
<p>transaction heuristics</p>
</li>
<li>
<p>distributed transaction manager (co-located with the transaction initiator) or transaction manager server</p>
</li>
<li>
<p>checked/unchecked transaction behaviour</p>
</li>
<li>
<p>supports both flat and nested transaction models, with nested-aware resources and resource adapters</p>
</li>
<li>
<p>independent concurrency control system with support for type-specific concurrency control</p>
</li>
<li>
<p>support for CosTransaction::Current</p>
</li>
<li>
<p>direct and indirect transaction management</p>
</li>
<li>
<p>synchronization interface</p>
</li>
<li>
<p>explicit and implicit transaction context propagation</p>
</li>
<li>
<p>automatic crash recovery</p>
</li>
<li>
<p>multi-thread aware</p>
</li>
</ul>
</div>
</li>
<li>
<p>transactional objects (TO) for Java</p>
</li>
<li>
<p>ORB independence via the ORB portability layer</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This trail map will help you get started with running Narayana product.
It is structured as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1. Installation Content: This trail describes the content installed by the Narayana distribution</p>
</li>
<li>
<p>2. The Sample Application: This trail describes via a set of examples how Narayana is used to build transactional applications</p>
</li>
<li>
<p>3. Deploying and testing the Sample Application: This trail describes how to deploy and to test the sample application</p>
</li>
<li>
<p>4. Making the Sample Application Persistent: This trail describes tools allowing to build a persistent application</p>
</li>
<li>
<p>5. Recovery from Failure: This trail describes via a simple scenario how Narayana manages recovery from failure.</p>
</li>
<li>
<p>6. Where Next?: This trail indicates where to find additional information</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to the trails listed above, a set of trails giving more explanation on concept around transaction processing and standards, and also a quick access to section explaining how to configure Narayana are listed in the section "Additional Trails".</p>
</div>
<div class="paragraph">
<p><em>Note:</em> When running the local JTS transactions part of the trailmap, you will need to start the recovery manager: java com.arjuna.ats.arjuna.recovery.RecoveryManager -test</p>
</div>
<div class="sect5">
<h6 id="_overview_of_the_xopen_dtp_model"><a class="anchor" href="#_overview_of_the_xopen_dtp_model"></a>Overview of the X/Open DTP model</h6>
<div class="paragraph">
<p>The X/Open Distributed Transaction Processing (DTP) model is a distributed transaction processing model proposed by the Open Group, a vendor consortium.
This model is a standard among most of the commercial vendors in transaction processing and database domains.</p>
</div>
<div class="paragraph">
<p>This model consists of the follwng components (illustrated in <a href="#figure1">The X/Open DTP model</a>)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an Application Program (AP), which defines transaction boundaries and specifies actions that constitute a transaction</p>
</li>
<li>
<p>Resource Managers (RMs) such as databases or file access systems, which provide access to resources</p>
</li>
<li>
<p>a Transaction Manager &#8482;, which assigns identifiers to transactions, monitors their progress, and takes responsibility for transaction completion and for coordinating failure recovery</p>
</li>
<li>
<p>Communication Resource Managers (CRMs), which control communication between distributed applications within or across TM domains</p>
</li>
</ul>
</div>
<div id="figure1" class="imageblock text-center">
<div class="content">
<img src="images/jts-xopen.png" alt="jts xopen">
</div>
<div class="title">Figure 21. The X/Open DTP model</div>
</div>
</div>
<div class="sect5">
<h6 id="_interface_between_functional_components"><a class="anchor" href="#_interface_between_functional_components"></a>Interface between functional components</h6>
<div class="paragraph">
<p>There are six interfaces between software components in the X/Open DTP model.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AP-RM.
The AP-RM interfaces give the AP access to resources.
X/Open interfaces, such as SQL and ISAM provide AP portability.
The X/Open DTP model imposes few constraints on native RM APIs.
The constraints involve only those native RM interfaces that define transactions.</p>
</li>
<li>
<p>AP-TM.
The AP-TM interface (the TX interface) provides the AP with an Application Programming Interface (API) by which the AP coordinates global transaction management with the TM.
For example, when the AP calls <code>tx_begin()</code> the TM informs the participating RMs of the start of a global transaction.
After each request is completed, the TM provides a return value to the AP reporting back the success or otherwise of the TX call.</p>
</li>
<li>
<p>TM-RM.
The TM-RM interface (the XA interface) lets the TM structure the work of RMs into global transactions and coordinate completion or recovery.
The XA interface is the bidirectional interface between the TM and RM.</p>
<div class="paragraph">
<p>The functions that each RM provides for the TM are called the <code>xa_*()</code> functions.
For example the TM calls <code>xa_start()</code> in each participating RM to start an RM-internal transaction as part of a new global transaction.
Later, the TM may call in sequence <code>xa_end()</code>, <code>xa_prepare()</code>, and <code>xa_commit()</code> to coordinate a (successful in this case) two-phase commit protocol.
The functions that the TM provides for each RM are called the ax_*( ) functions.
For example an RM calls <code>ax_reg()</code> to register dynamically with the TM.</p>
</div>
</li>
<li>
<p>TM-CRM.
The TM-CRM interface (the XA+ interface) supports global transaction information flow across TM Domains.
In particular TMs can instruct CRMs by use of <code>xa_*()</code> function calls to suspend or complete transaction branches, and to propagate global transaction commitment protocols to other transaction branches.
CRMs pass information to TMs in subordinate branches by use of <code>ax_*()</code> function calls.
CRMs also use <code>ax_*()</code> function calls to request the TM to create subordinate transaction branches, to save and retrieve recovery information, and to inform the TM of the start and end of blocking conditions.</p>
</li>
<li>
<p>AP-CRM.
X/Open provides portable APIs for DTP communication between APs within a global transaction.
The API chosen can significantly influence (and may indeed be fundamental to) the whole architecture of the application.
For this reason, these APIs are frequently referred to in this specification and elsewhere as communication paradigms.
In practice, each paradigm has unique strengths, so X/Open offers the following popular paradigms:</p>
<div class="ulist">
<ul>
<li>
<p>the TxRPC interface (see the referenced TxRPC specification)</p>
</li>
<li>
<p>the XATMI interface (see the referenced XATMI specification)</p>
</li>
<li>
<p>the CPI-C interface (see the referenced CPI-C specification).</p>
<div class="paragraph">
<p>X/Open interfaces, such as the CRM APIs listed above, provide application portability.
The X/Open DTP model imposes few constraints on native CRM APIs.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>CRM-OSI TP. This interface (the XAP-TP interface) provides a programming interface between a CRM and Open Systems Interconnection Distributed Transaction Processing (OSI TP) services.
XAP-TP interfaces with the OSI TP Service and the Presentation Layer of the seven-layer OSI model.
X/Open has defined this interface to support portable implementations of application-specific OSI services.
The use of OSI TP is mandatory for communication between heterogeneous TM domains.
For details of this interface, see the referenced XAP-TP specification and the OSI TP standards.
This interface (the XAP-TP interface) provides a programming interface between a CRM and Open Systems Interconnection Distributed Transaction Processing (OSI TP) services.
XAP-TP interfaces with the OSI TP Service and the Presentation Layer of the seven-layer OSI model.
X/Open has defined this interface to support portable implementations of application-specific OSI services.
The use of OSI TP is mandatory for communication between heterogeneous TM domains.
For details of this interface, see the referenced XAP-TP specification and the OSI TP standards.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Although the aim of the Open Group was providing portable interfaces, only the XA interface appears to be accepted and implemented by a wide range of vendors.</p>
</div>
<div class="paragraph">
<p>XA is a bidirectional interface between resource managers and transaction managers.
This interface specifies two sets of functions.
The first set, called as <code>xa_*()</code> functions are implemented by resource managers for use by the transaction manager.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. XA Interface of X/Open DTP Model for the transaction manager</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Function</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Purpose</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xa_start</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directs a resource manager to associate the subsequent requests by application programs to a transaction identified by the supplied identifier.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xa_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ends the association of a resource manager with the transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xa_prepare</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prepares the resource manager for the commit operation. Issued by the transaction manager in the first phase of the two-phase commit operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xa_commit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commits the transactional operations. Issued by the transaction manager in the second phase of the two-phase commit operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xa_recover</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieves a list of prepared and heuristically committed or heuristically rolled back transactions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xa_forget</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forgets the heuristic transaction associated with the given transaction identifier</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The second set of functions, called as <code>ax_*()</code> functions, are implemented by the transaction manager for use by resource managers.</p>
</div>
<div class="paragraph">
<p>Table 2 - XA Interface of X/Open DTP Model for resource managers</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Function</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Purpose</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ax_reg()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dynamically enlists with the transaction manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ax_unreg()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dynamically delists from the transaction manager.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="_overview_of_the_distributed_transaction_processing"><a class="anchor" href="#_overview_of_the_distributed_transaction_processing"></a>Overview of the Distributed Transaction Processing</h6>
<div class="paragraph">
<p>Transaction management is one of the most crucial requirements for enterprise application development.
Most of the large enterprise applications in the domains of finance, banking and electronic commerce rely on transaction processing for delivering their business functionality.</p>
</div>
<div class="paragraph">
<p>Enterprise applications often require concurrent access to distributed data shared amongst multiple components, to perform operations on data.
Such applications should maintain integrity of data (as defined by the business rules of the application) under the following circumstances:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>distributed access to a single resource of data, and</p>
</li>
<li>
<p>access to distributed resources from a single application component.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In such cases, it may be required that a group of operations on (distributed) resources be treated as one unit of work.
In a unit of work, all the participating operations should either succeed or fail and recover together.
This problem is more complicated when</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a unit of work is implemented across a group of distributed components operating on data from multiple resources, and/or</p>
</li>
<li>
<p>the participating operations are executed sequentially or in parallel threads requiring coordination and/or synchronization.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In either case, it is required that success or failure of a unit of work be maintained by the application.
In case of a failure, all the resources should bring back the state of the data to the previous state ( <em>i.e.,</em> the state prior to the commencement of the unit of work).</p>
</div>
<div class="paragraph">
<p>From the programmer&#8217;s perspective a transaction is a scoping mechanism for a collection of actions which must complete as a unit.
It provides a simplified model for exception handling since only two outcomes are possible:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>success - meaning that all actions involved within a transaction are completed</p>
</li>
<li>
<p>failure - no actions complete</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-trans_succes_failure.PNG.png" alt="jts trans succes failure.PNG">
</div>
</div>
</div>
<div class="sect5">
<h6 id="_example_3"><a class="anchor" href="#_example_3"></a>Example</h6>
<div class="paragraph">
<p>To illustrate the reliability expected by the application, let&#8217;s consider the fund transfer example which is familiar to all of us.</p>
</div>
<div class="paragraph">
<p>The Money transfer involves two operations: Deposit and Withdrawal</p>
</div>
<div class="paragraph">
<p>The complexity of implementation doesn&#8217;t matter; money moves from one place to another.
For instance, involved accounts may be either located in the same relational table within a database or located on different databases.</p>
</div>
<div class="paragraph">
<p>A Simple transfer consists on moving money from savings to checking while a Complex transfer can be performed at the end- of- day according to a reconciliation between international banks</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-example_transfer.PNG.png" alt="jts example transfer.PNG">
</div>
</div>
<div class="paragraph">
<p>The concept of a transaction, and a transaction manager (or a transaction processing service) simplifies the construction of such enterprise level distributed applications while maintaining the integrity of data in a unit of work.</p>
</div>
<div class="paragraph">
<p>A transaction is a unit of work that has the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Atomicity</em> – either the whole transaction completes or nothing completes - partial completion is not permitted.</p>
</li>
<li>
<p><em>Consistency</em> – a transaction transforms the system from one consistent state to another.
In other words, On completion of a successful transaction, the data should be in a consistent state.
For example, in the case of relational databases, a consistent transaction should preserve all the integrity constraints defined on the data.</p>
</li>
<li>
<p><em>Isolation</em> –  Each transaction should appear to execute independently of other transactions that may be executing concurrently in the same environment.
The effect of executing a set of transactions serially should be the same as that of running them concurrently.
This requires two things:</p>
<div class="ulist">
<ul>
<li>
<p>During the course of a transaction, intermediate (possibly inconsistent) state of the data should not be exposed to all other transactions.</p>
</li>
<li>
<p>Two concurrent transactions should not be able to operate on the same data.
Database management systems usually implement this feature using locking.</p>
</li>
</ul>
</div>
</li>
<li>
<p><em>Durabiliy</em> – The effects of a completed transaction should always be persistent.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These properties, called as <em>ACID</em> properties, guarantee that a transaction is never incomplete, the data is never inconsistent, concurrent transactions are independent, and the effects of a transaction are persistent.</p>
</div>
<div class="sect6">
<h7 id="_transactional_concepts"><a class="anchor" href="#_transactional_concepts"></a>Transactional Concepts</h7>

</div>
<div class="sect6">
<h7 id="_transaction_components"><a class="anchor" href="#_transaction_components"></a>Transaction Components</h7>
<div class="paragraph">
<p>A collection of actions is said to be transactional if they possess the ACID properties.
These properties are assumed to be ensured, in the presence of failures; if actions involved within the transaction are performed by a Transactional System.
A transaction system includes a set of components where each of them has a particular role.
The main components are described below.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-transaction_components.PNG.png" alt="jts transaction components.PNG">
</div>
</div>
</div>
<div class="sect6">
<h7 id="_application_programs"><a class="anchor" href="#_application_programs"></a>Application Programs</h7>
<div class="paragraph">
<p>Application Programs are clients for the transactional resources.
These are the programs with which the application developer implements business transactions.
With the help of the transaction manager, these components create global transactions and operate on the transactional resources with in the scope of these transactions.
These components are not responsible for implementing mechanisms for preserving ACID properties of transactions.
However, as part of the application logic, these components generally make a decision whether to commit or rollback transactions.</p>
</div>
<div class="paragraph">
<p>Application responsibilities could be summarised as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create and demarcate transactions</p>
</li>
<li>
<p>Operate on data via resource managers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A resource manager is, in general, a component that manages persistent and stable data storage system, and participates in the two phase commit and recovery protocols with the transaction manager.</p>
</div>
<div class="paragraph">
<p>A resource manager is typically a driver that provides two sets of interfaces: one set for the application components to get connections and operating, and the other set for participating in two phase commit and recovery protocols coordinated by a transaction manager.
This component may also, directly or indirectly, register resources with the transaction manager so that the transaction manager can keep track of all the resources participating in a transaction.
This process is called as resource enlistment.</p>
</div>
<div class="paragraph">
<p>Resource Manager responsibilities could be summarised as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enlist resources with the transaction manager</p>
</li>
<li>
<p>Participate in two-phase commit and recovery protocol</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The transaction manager is the core component of a transaction processing environment.
Its main responsibilities are to create transactions when requested by application components, allow resource enlistment and delistment, and to manage the two-phase commit or recovery protocol with the resource managers.</p>
</div>
<div class="paragraph">
<p>A typical transactional application begins a transaction by issuing a request to a transaction manager to initiate a transaction.
In response, the transaction manager starts a transaction and associates it with the calling thread.
The transaction manager also establishes a transaction context.
All application components and/or threads participating in the transaction share the transaction context.
The thread that initially issued the request for beginning the transaction, or, if the transaction manager allows, any other thread may eventually terminate the transaction by issuing a commit or rollback request.</p>
</div>
<div class="paragraph">
<p>Before a transaction is terminated, any number of components and/or threads may perform transactional operations on any number of transactional resources known to the transaction manager.
If allowed by the transaction manager, a transaction may be suspended or resumed before finally completing the transaction.</p>
</div>
<div class="paragraph">
<p>Once the application issues the commit request, the transaction manager prepares all the resources for a commit operation, and based on whether all resources are ready for a commit or not, issues a commit or rollback request to all the resources.</p>
</div>
<div class="paragraph">
<p>Resource Manager responsibilities could be summarised as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Establish and maintain transaction context</p>
</li>
<li>
<p>Maintain association between a transaction and the participating resources.</p>
</li>
<li>
<p>Initiate and conduct two-phase commit and recovery protocol with the resource managers.</p>
</li>
<li>
<p>Make synchronization calls to the application components before beginning and after end of the two-phase commit and recovery process</p>
</li>
</ul>
</div>
<div class="sect7">
<h8 id="_local_vs_distributed_transaction"><a class="anchor" href="#_local_vs_distributed_transaction"></a>Local vs. Distributed Transaction</h8>
<div class="paragraph">
<p>A transaction that involves only one transactional resource, such a database, is considered as <em>local transaction</em> , while a transaction that involves more than one transactional resource that need to be coordinated to reach a consistent state is considered as a <em>distributed transaction.</em></p>
</div>
<div class="paragraph">
<p>A transaction can be specified by what is known as transaction demarcation.
Transaction demarcation enables work done by distributed components to be bound by a global transaction.
It is a way of marking groups of operations to constitute a transaction.</p>
</div>
<div class="paragraph">
<p>The most common approach to demarcation is to mark the thread executing the operations for transaction processing.
This is called as programmatic demarcation.
The transaction so established can be suspended by unmarking the thread, and be resumed later by explicitly propagating the transaction context from the point of suspension to the point of resumption.</p>
</div>
<div class="paragraph">
<p>The transaction demarcation ends after a commit or a rollback request to the transaction manager.
The commit request directs all the participating resources managers to record the effects of the operations of the transaction permanently.
The rollback request makes the resource managers undo the effects of all operations on the transaction.</p>
</div>
</div>
<div class="sect7">
<h8 id="_transaction_context_and_propagation"><a class="anchor" href="#_transaction_context_and_propagation"></a>Transaction Context and Propagation</h8>
<div class="paragraph">
<p>Since multiple application components and resources participate in a transaction, it is necessary for the transaction manager to establish and maintain the state of the transaction as it occurs.
This is usually done in the form of transaction context.</p>
</div>
<div class="paragraph">
<p>Transaction context is an association between the transactional operations on the resources, and the components invoking the operations.
During the course of a transaction, all the threads participating in the transaction share the transaction context.
Thus the transaction context logically envelops all the operations performed on transactional resources during a transaction.
The transaction context is usually maintained transparently by the underlying transaction manager.</p>
</div>
</div>
<div class="sect7">
<h8 id="_resource_enlistment"><a class="anchor" href="#_resource_enlistment"></a>Resource Enlistment</h8>
<div class="paragraph">
<p>Resource enlistment is the process by which resource managers inform the transaction manager of their participation in a transaction.
This process enables the transaction manager to keep track of all the resources participating in a transaction.
The transaction manager uses this information to coordinate transactional work performed by the resource managers and to drive two-phase and recovery protocol.
At the end of a transaction (after a commit or rollback) the transaction manager delists the resources.</p>
</div>
</div>
<div class="sect7">
<h8 id="_two_phase_commit"><a class="anchor" href="#_two_phase_commit"></a>Two-Phase Commit</h8>
<div class="paragraph">
<p>This protocol between the transaction manager and all the resources enlisted for a transaction ensures that either all the resource managers commit the transaction or they all abort.
In this protocol, when the application requests for committing the transaction, the transaction manager issues a prepare request to all the resource managers involved.
Each of these resources may in turn send a reply indicating whether it is ready for commit or not.
Only The transaction manager issues a commit request to all the resource managers, only when all the resource managers are ready for a commit.
Otherwise, the transaction manager issues a rollback request and the transaction will be rolled back.</p>
</div>
</div>
<div class="sect7">
<h8 id="_recovery_and_logging"><a class="anchor" href="#_recovery_and_logging"></a>Recovery and Logging</h8>
<div class="paragraph">
<p>Basically, the Recovery is the mechanism which preserves the transaction atomicity in presence of failures.
The basic technique for implementing transactions in presence of failures is based on the use of logs.
That is, a transaction system has to record enough information to ensure that it can be able to return to a previous state in case of failure or to ensure that changes committed by a transaction are properly stored.</p>
</div>
<div class="paragraph">
<p>In addition to be able to store appropriate information, all participants within a distributed transaction must log similar information, which allows them to take a same decision either to set data in their final state or in their initial state.</p>
</div>
<div class="paragraph">
<p>Two techniques are, in general, used to ensure transaction&#8217;s atomicity.
A first technique focuses on manipulated data, such as the Do/Undo/Redo protocol (considered as a recovery mechanism in a centralised system), which allows a participant to set its data in their final values or to retrieve them in their initial values.
A second technique relies on a distributed protocol named the two phases commit, ensuring that all participants involved within a distributed transaction set their data either in their final values or in their initial values.
In other words, all participants must commit or all must roll back.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-recovery_logs.PNG.png" alt="jts recovery logs.PNG">
</div>
</div>
<div class="paragraph">
<p>In addition to failures, we refer as centralized such system crashes, communication failures due, for instance, to network outages or message loss have to be considered during the recovery process of a distributed transaction.</p>
</div>
<div class="paragraph">
<p>In order to provide an efficient and optimized mechanism to deal with failure, modern transactional systems typically adopt a “presume abort” strategy, which simplifies the transaction management.</p>
</div>
<div class="paragraph">
<p>The presumed abort strategy can be stated as «when in doubt, abort».
With this strategy, when the recovery mechanism has no information about the transaction, it presumes that the transaction has been aborted.</p>
</div>
<div class="paragraph">
<p>A particularity of the presumed-abort assumption allows a coordinator to not log anything before the commit decision and the participants do not to log anything before they prepare.
Then, any failure which occurs before the 2pc starts leads to abort the transaction.
Furthermore, from a coordinator&#8217;s point of view, any communication failure detected by a timeout or exception raised on sending prepare is considered as a negative vote which leads to abort the transaction.
So, within a distributed transaction, a coordinator or a participant may fail in two ways: either it crashes or it times out for a message it was expecting.
When a coordinator or a participant crashes and then restarts, it uses information on stable storage to determine the way to perform the recovery.
As we will see it the presumed-abort strategy enables an optimized behavior for the recovery.</p>
</div>
</div>
<div class="sect7">
<h8 id="_heuristic_decision"><a class="anchor" href="#_heuristic_decision"></a>Heuristic Decision</h8>
<div class="paragraph">
<p>In extremely rare cases, a resource manager may choose not to wait for the outcome from the transaction manager.
This might occur if the communications path was lost and was not likely to be restored for a very long time.
Typically this happens as a result of human intervention and not as an arbitrary action of a resource manager.
In order to release locks and make this transaction data available to new transactions, the resource manager makes a heuristic decision, i.e. it guesses the proper transaction outcome.
When it does so, it must remember its guess until contact with the transaction manager is ultimately re-established.</p>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_standards"><a class="anchor" href="#_standards"></a>Standards</h7>
<div class="paragraph">
<p>Saying that a distributed transaction can involve several distributed participants, means that these participants must be integrated within a global transaction manager which has the responsibility to ensure that all participants take a common decision to commit or rollback the distributed transaction.
The key of such integration is the existence of a common transactional interface which is understood by all participants, transaction manager and resource managers such as databases.</p>
</div>
<div class="paragraph">
<p>The importance of common interfaces between participants, as well as the complexity of their implementation, becomes obvious in an open systems environment.
For this aim, various distributed transaction processing standards have been developed by international standards organizations.
Among these organizations, We list three of them which are mainly considered in the Narayana product:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The X/Open model and its successful XA interface</p>
</li>
<li>
<p>The OMG with its CORBA infrastructure and the Object Transaction Service and finally</p>
</li>
<li>
<p>The Jakarta Transactions specification process</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Basically, these standards have proposed logical models, which divide transaction processing into several functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>those assigned to the application which ties resources together in application-specific operations</p>
</li>
<li>
<p>those assigned to the Resource manager which access physically to data stores</p>
</li>
<li>
<p>functions performed by the Transaction Manager which manages transactions, and finally</p>
</li>
<li>
<p>Communication Resource Managers which allow exchanging information with other transactional domains.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-standards.PNG.png" alt="jts standards.PNG">
</div>
</div>
</div>
<div class="sect6">
<h7 id="_overview_of_the_omg_object_transaction_service"><a class="anchor" href="#_overview_of_the_omg_object_transaction_service"></a>Overview of the OMG Object Transaction Service</h7>
<div class="paragraph">
<p>Object Transaction Service (OTS) is a distributed transaction processing service specified by the Object Management Group (OMG).
This specification extends the CORBA model and defines a set of interfaces to perform transaction processing across multiple CORBA objects.</p>
</div>
<div class="paragraph">
<p>OTS is based on the Open Group&#8217;s DTP model and is designed so that it can be implemented using a common kernel for both the OTS and Open Group APIs.
In addition to the functions defined by DTP, OTS contains enhancements specifically designed to support the object environment.
Nested transactions and explicit propagation are two examples.</p>
</div>
<div class="paragraph">
<p>The CORBA model also makes some of the functions in DTP unnecessary so these have been consciously omitted.
Static registration and the communications resource manager are unnecessary in the CORBA environment.</p>
</div>
<div class="paragraph">
<p>A key feature of OTS is its ability to share a common transaction with XA compliant resource managers.
This permits the incremental addition of objects into an environment of existing procedural applications.</p>
</div>
<div id="ots_architecture" class="imageblock text-center">
<div class="content">
<img src="images/jts-OTS.PNG.png" alt="jts OTS.PNG">
</div>
<div class="title">Figure 22. OTS Architecture</div>
</div>
<div class="paragraph">
<p>The OTS architecture, shown in the <a href="#ots_architecture">OTS Architecture</a>, consists of the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Transaction Client</em>: A program or object that invokes operations on transactional objects.</p>
</li>
<li>
<p><em>Transactional Object</em>: A CORBA object that encapsulates or refers to persistent data, and whose behavior depends on whether or not its operations are invoked during a transaction.</p>
</li>
<li>
<p><em>Recoverable Object</em>: A transactional object that directly maintains persistent data, and participates in transaction protocols.</p>
</li>
<li>
<p><em>Transactional Server</em>: A collection of one or more transactional objects.</p>
</li>
<li>
<p><em>Recoverable Server</em>: A collection of objects, of which at least one of which is recoverable.</p>
</li>
<li>
<p><em>Resource Object</em>: A resource object is an object in the transaction service that is registered for participation in the two-phase commit and recovery protocol.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to the usual transactional semantics, the CORBA OTS provides for the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Nested Transactions</em>: This allows an application to create a transaction that is embedded in an existing transaction.
In this model, multiple subtransactions can be embedded recursively in a transaction.
Subtransactions can be committed or rolled back without committing or rolling back the parent transaction.
However, the results of a commit operation are contingent upon the commitment of all the transaction&#8217;s ancestors.
The main advantage of this model is that transactional operations can be controlled at a finer granularity.
The application will have an opportunity to correct or compensate for failures at the subtransaction level, without actually attempting to commit the complete parent transaction.</p>
</li>
<li>
<p><em>Application Synchronization</em>: Using the OTS synchronization protocol, certain objects can be registered with the transaction service for notification before the start of and the completion of the two-phase commit process.
This enables such application objects to synchronize transient state and data stored in persistent storage.</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_application_programming_models"><a class="anchor" href="#_application_programming_models"></a>Application programming models</h7>
<div class="paragraph">
<p>A client application program may use direct or indirect context management to manage a transaction.
With indirect context management, an application uses the pseudo object called Current, provided by the Transaction Service , to associate the transaction context with the application thread of control.
In direct context management, an application manipulates the Control object and the other objects associated with the transaction.</p>
</div>
<div class="paragraph">
<p>An object may require transactions to be either explicitly or implicitly propagated to its operations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Explicit propagation means that an application propagates a transaction context by passing objects defined by the Transaction Service as explicit parameters.
This should typically be the PropagationContext structure.</p>
</li>
<li>
<p>Implicit propagation means that requests are implicitly associated with the client&#8217;s transaction; they share the client&#8217;s transaction context.
It is transmitted implicitly to the objects, without direct client intervention.
Implicit propagation depends on indirect context management, since it propagates the transaction context associated with the Current pseudo object.
An object that supports implicit propagation would not typically expect to receive any Transaction Service object as an explicit parameter.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A client may use one or both forms of context management, and may communicate with objects that use either method of transaction propagation.
(Details of how to enable implicit propagation were described in Section Chapter 0 and Section 0).
This results in four ways in which client applications may communicate with transactional objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Direct Context Management/Explicit Propagation: the client application directly accesses the Control object, and the other objects which describe the state of the transaction.
To propagate the transaction to an object, the client must include the appropriate Transaction Service object as an explicit parameter of an operation; typically this should be the PropagationContext structure.</p>
</li>
<li>
<p>Indirect Context Management/Implicit Propagation: the client application uses operations on the Current pseudo object to create and control its transactions.
When it issues requests on transactional objects, the transaction context associated with the current thread is implicitly propagated to the object.</p>
</li>
<li>
<p>Indirect Context Management/Explicit Propagation: for an implicit model application to use explicit propagation, it can get access to the Control using the get_control operation on the Current pseudo object.
It can then use a Transaction Service object as an explicit parameter to a transactional object; for efficiency reasons this should be the PropagationContext structure, obtained by calling get_txcontext on the appropriate Coordinator reference.
This is explicit propagation.</p>
</li>
<li>
<p>Direct Context Management/Implicit Propagation: a client that accesses the Transaction Service objects directly can use the resume pseudo object operation to set the implicit transaction context associated with its thread.
This allows the client to invoke operations of an object that requires implicit propagation of the transaction context.</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_examples_4"><a class="anchor" href="#_examples_4"></a>Examples</h7>
<div class="ulist">
<ul>
<li>
<p>Indirect and Implicit</p>
<div class="paragraph">
<p>In the code fragments below, a transaction originator uses indirect context management and implicit transaction propagation; txn_crt is an example of an object supporting the Current interface.
The client uses the begin operation to start the transaction whichbecomes implicitly associated with the originator&#8217;s thread of control.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">...
txn_crt.begin();
<span class="comment">// should test the exceptions that might be raised</span>
...
<span class="comment">// the client issues requests, some of which involve</span>
<span class="comment">// transactional objects;</span>
BankAccount.makeDeposit(deposit);
...
txn_crt.commit(<span class="predefined-constant">false</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The program commits the transaction associated with the client thread.
The report_heuristics argument is set to false so no report will be made by the Transaction Service about possible heuristic decisions.</p>
</div>
</li>
<li>
<p>Direct and Explicit</p>
<div class="paragraph">
<p>In the following example, a transaction originator uses direct context management and explicit transaction propagation.
The client uses a factory object supporting the CosTransactions::TransactionFactory interface to create a new transaction and uses the returned Control object to retrieve the Ter mi nat or and Coordinator objects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">...
CosTransactions::<span class="predefined-type">Control</span> ctrl;
CosTransactions::Terminator ter;
CosTransactions::Coordinator coo;
coo = TFactory.create(<span class="integer">0</span>);
ter = ctrl.get_terminator();
...
transactional_object.do_operation(arg, c);
...
t.commit(<span class="predefined-constant">false</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client issues requests, some of which involve transactional objects, in this case explicit propagation of the context is used.
The Control object reference is passed as an explicit parameter of the request; it is declared in the OMG IDL of the interface.
The transaction originator uses the Terminator object to commit the transaction; the report_heuristics argument is set to false: so no report will be made by the Transaction Service about possible heuristic decisions.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The main difference between direct and indirect context management is the effect on the invoking thread&#8217;s transaction context.
If using indirect (i.e., invoking operations through the Current pseudo object), then the thread&#8217;s transaction context will be modified automatically by the OTS, e.g., if begin is called then the thread&#8217;s notion of the current transaction will be modified to the newly created transaction; when that is terminated, the transaction previously associated with the thread (if any) will be restored as the thread&#8217;s context (assuming subtransactions are supported by the OTS implementation).
However, if using direct management, no changes to the threads transaction context are performed by the OTS: the application programmer assumes responsibility for this.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_ots_interfaces"><a class="anchor" href="#_ots_interfaces"></a>OTS Interfaces</h6>
<div id="ots_interfaces" class="imageblock text-center">
<div class="content">
<img src="images/jts-OTS_Interfaces.PNG.png" alt="jts OTS Interfaces.PNG">
</div>
<div class="title">Figure 23. OTS interfaces and their interactions</div>
</div>
<div class="paragraph">
<p>The figure "<a href="#ots_interfaces">OTS interfaces and their interactions</a>" describes the principal interfaces in the CORBA OTS specification, with their interaction, while the <a href="#ots_interfaces_table">OTS Interfaces and their role.</a> below provides more details for each interface.</p>
</div>
<table id="ots_interfaces_table" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. OTS Interfaces and their role.</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Interface</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Role and operations</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Transaction demarcation (begin, commit, rollback, rollback_only, set_time_out)</p>
</li>
<li>
<p>Status of the transaction (get_status)</p>
</li>
<li>
<p>Name of the transaction (get_transaction_name)</p>
</li>
<li>
<p>Transaction context (get_control)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TransactionFactory</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Explicit transaction creation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>create a transaction with its associated cooridinator (create)</p>
</li>
<li>
<p>create an interposed coordinator as a subrodinator in the transaction tree (recreate)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Control</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Explicit transaction context management:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>access to the transaction coordinator (get_coordinator)</p>
</li>
<li>
<p>access to the transactions terminator (get_terminator)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Terminator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commit (commit) or rollback (rollback) a transaction in a direct transaction management mode</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Coordinator</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Status of the transaction (get_status, get_parent_status, get_top_level_status)</p>
</li>
<li>
<p>Transaction information (is_same_transaction, is_related_transaction, is_ancestor_transaction, is_descendant_transaction, is_top_level_transaction, hash_transaciton, hash_top_level_transaction, get_transaction_name, get_txcontext)</p>
</li>
<li>
<p>Resource enlistment (register_resource, register_subtrans_aware)</p>
</li>
<li>
<p>Registration of synchronization objects (register_synchronization)</p>
</li>
<li>
<p>Set the transaction for rollback (rollback_only)</p>
</li>
<li>
<p>Create subtransactions (create_subtransaction)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RecoveryCoordinator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to coordinate recovery in case of failure ( <em>replay_completion</em> )</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Participation in two-phase commit and recovery protocol ( <em>prepare, rollback, commit, commit_one_phase, forget</em> )</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Synchronization</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application synchronization before beginning and after completion of two-phase commit ( <em>before_completion, after_completion</em> )</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SubtransactionAwareResource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commit or rollback a subtransaction ( <em>commit_subtransaction, rollback_subtransaction)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TransactionalObject</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A marker interface to be implemented by all transactional objects (no operation defined)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="_managing_transactions_in_jakarta_ee"><a class="anchor" href="#_managing_transactions_in_jakarta_ee"></a>Managing Transactions in Jakarta EE</h6>
<div class="sect6">
<h7 id="_jtajts_architecture"><a class="anchor" href="#_jtajts_architecture"></a>JTA/JTS Architecture</h7>
<div class="paragraph">
<p>The Java transaction initiative consists of two specifications: Java Transaction Service (JTS) and Jakarta Transactions API (also known as JTA).</p>
</div>
<div class="paragraph">
<p>JTS specifies the implementation of a Java transaction manager.
This transaction manager supports the JTA, using which application servers can be built to support transactional Java applications.
Internally, the JTS implements the Java mapping of the OMG OTS specifications.</p>
</div>
<div class="paragraph">
<p>The JTA specifies an architecture for building transactional application servers and defines a set of interfaces for various components of this architecture.
The components are: the application, resource managers, and the application server, as shown in the slide.</p>
</div>
<div class="paragraph">
<p>The JTS thus provides a new architecture for transactional application servers and applications, while complying to the OMG OTS 1.1 interfaces internally.
This allows the JTA compliant applications to interoperate with other OTS 1.1 complaint applications through the standard IIOP.</p>
</div>
<div class="paragraph">
<p>As shown in <a href="#jta_jts_transaction_model">The JTA/JTS transaction model</a>, in the Java transaction model, the Java application components can conduct transactional operations on JTA compliant resources via the JTS.
The JTS acts as a layer over the OTS.
The applications can therefore initiate global transactions to include other OTS transaction managers, or participate in global transactions initiated by other OTS compliant transaction managers.</p>
</div>
<div id="jta_jts_transaction_model" class="imageblock text-center">
<div class="content">
<img src="images/jts-j2ee_1.PNG.png" alt="jts j2ee 1.PNG">
</div>
<div class="title">Figure 24. The JTA/JTS transaction model</div>
</div>
<div class="paragraph">
<p>The Java Transaction Service is architected around an application server and a transaction manager.
The architecture is shown in <a href="#jta_jts_architecture">The JTA/JTS Architecture</a>.</p>
</div>
<div id="jta_jts_architecture" class="imageblock text-center">
<div class="content">
<img src="images/jts-j2ee_2.PNG.png" alt="jts j2ee 2.PNG">
</div>
<div class="title">Figure 25. The JTA/JTS Architecture</div>
</div>
<div class="paragraph">
<p>The JTS architecture consists of the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Transaction Manager</em>: The transaction manager is the core component of this architecture and is provided by an implementation of the JTS.
It provides interfaces to create transactions (including transaction demarcation and propagation of transaction context), allows enlistment and delistment of resources, provides interfaces for registering components for application synchronization, implements the synchronization protocol, and initiates and directs the two phase commit and recovery protocol with the resource managers.</p>
</li>
<li>
<p><em>Application Server</em>: One of the key features of the JTS architecture is that it allows an application server to be built on top of the transaction service and the resources.
Application developers can develop and deploy application components onto the application server for initiating and managing transactions.
The application server can therefore abstract all transactional semantics from the application programs.</p>
</li>
<li>
<p><em>Application Components</em>: These are the clients for the transactional resources and implement business transactions.
These are deployed on the application server.
Depending on the architecture of the application server, these components can directly or indirectly create transactions and operate on the transactional resources.
For example, an Jakarta Enterprise Beans (EJB) server allows declarative transaction demarcation, in which case, the EJB components need not directly implement the transactions.
However, a Java implementation of a CORBA OTS, requires the CORBA object to demarcate transactions explicitly.</p>
</li>
<li>
<p><em>Resource Manager</em>: A resource manager is an X/Open XA compliant component that manages a persistent and stable storage system, and participates in the two phase commit and recovery protocol with the transaction manager.
The application manager also provides interfaces for the application server and the application components to operate on the data managed by it.</p>
</li>
<li>
<p><em>Communication Resource Manager</em>: This allows the transaction manager to participate in transactions initiated by other transaction managers.
However, the JTS specification does not specify any protocol for this communication and assumes that an implementation of the communication resource manager supports the CORBA OTS and GIOP specifications.</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_jakarta_transactions_api_formally_jta"><a class="anchor" href="#_jakarta_transactions_api_formally_jta"></a>Jakarta Transactions API (formally JTA)</h7>
<div class="paragraph">
<p>The Jakarta Transactions specification may be classified into three categories of interface as shown in <a href="#jta_interfaces">JTA Interfaces</a>.
The Java Transaction API consists of three elements: a high-level application transaction demarcation interface, a high-level transaction manager interface intended for application server, and a standard Java mapping of the X/Open XA protocol intended for transactional resource manager.</p>
</div>
<div id="jta_interfaces" class="imageblock text-center">
<div class="content">
<img src="images/jts-j2ee_3_API.PNG.png" alt="jts j2ee 3 API.PNG">
</div>
<div class="title">Figure 26. JTA Interfaces</div>
</div>
<div class="sect7">
<h8 id="_transaction_manager_interfaces"><a class="anchor" href="#_transaction_manager_interfaces"></a>Transaction Manager Interfaces</h8>
<div class="ulist">
<ul>
<li>
<p><code>jakarta.transaction.Status</code>: Defines the following flags for the status of a transaction:</p>
</li>
</ul>
</div>
<table id="transaction_status_flags" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Transaction Status Flags</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Flag</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Purpose</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_ACTIVE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is active (started but not prepared)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_COMMITTED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is committed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_COMMITTING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is in the process of committing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_MARKED_ROLLBACK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is marked for rollback.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_NO_TRANSACTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">There is no transaction associated with the current Transaction, UserTransaction or TransactionManager objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_PREPARED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Voting phase of the two phase commit is over and the transaction is prepared.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_PREPARING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is in the process of preparing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_ROLLEDBACK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Outcome of the transaction has been determined as rollback. It is likely that heuristics exists.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_ROLLING_BACK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is in the process of rolling back.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS_UNKNOWN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A transaction exists but its current status can not be determined. This is a transient condition</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>jakarta.transaction.Transaction</code>, <code>jakarta.transaction.TransactionManager</code>, and <code>jakarta.transaction.UserTransaction</code> interfaces provide a <code>getStatus</code> method that returns one of the above status flags.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jakarta.transaction.Transaction</code>: An object of this type is created for each global transaction.
This interface provides methods for transaction completion(commit and rollback), resource enlistment (enlistResource) and delistment (delistResource), registration of synchronization objects (registerSynchronization), and query of status of the transaction (getStatus).</p>
</li>
<li>
<p><code>jakarta.transaction.TransactionManager</code>: This interface is implemented by the JTS and allows an application server to communicate with the transaction manager to demarcate transactions (begin, commit, rollback), suspending and resuming transactions (suspend and resume), set the transaction for rollback (setRollbackOnly), get the associated Transaction object (getTransaction), set the transaction timeout interval (setTransactionTimeout) and query the status of the transaction (getStatus).</p>
</li>
<li>
<p><code>jakarta.transaction.UserTransaction</code>: This interface provides methods to begin and end transactions (begin, commit, and rollback), set the transaction for rollback (setRollbackOnly), set the transaction timeout interval (setTransactionTimeout), and get the status of the transaction (getStatus).
Nested transactions are not supported, and begin throws the NotSupportedException when the calling thread is already associated with a transaction.
UserTransaction automatically associates newly created transactions with the invoking thread.</p>
</li>
<li>
<p><code>javax.transaction.xa.Xid</code>: This interface is a Java mapping of the X/Open transaction identifier xid structure.
The transaction manager uses an object of this type to associate a resource manager with a transaction.</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_resource_manager_interfaces"><a class="anchor" href="#_resource_manager_interfaces"></a>Resource Manager Interfaces</h8>
<div class="ulist">
<ul>
<li>
<p><code>javax.transaction.xa.XAResource</code>: This is a Java mapping of the X/Open XA interface, and is implemented by resource managers operating with the JTS.
This interface provides methods to start (start) and end (end) work on behalf of a specified transaction, to prepare a transaction with the current resource (prepare), to end transactions with the current resource (commit, forget, recover, and rollback), to compare the current resource manager with another resource manager (isSameRM), and to get and set the transaction timeout (getTransactionTimeout, setTransactionTimeout).</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_application_interfaces"><a class="anchor" href="#_application_interfaces"></a>Application Interfaces</h8>
<div class="paragraph">
<p>The only interface that an application object could implement is the Synchronization interface.
The application components may have to implement whatever other interfaces are mandated by a given application server.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jakarta.transaction.Synchronization</code>: An object intended to participate in a synchronization protocol with the transaction manager should implement this interface.
This mechanism is based on the Observer pattern.
This interface has two methods - beforeCompletion and afterCompletion to be called before starting and after completing, respectively, the two phase commit operation.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_jakarta_transactions_api_usage"><a class="anchor" href="#_jakarta_transactions_api_usage"></a>Jakarta Transactions API - Usage</h7>
<div class="paragraph">
<p>This section describes the usage of the JTA for implementing various transaction semantics.
The purpose of this section is to provide conceptual guidelines only.</p>
</div>
<div class="sect7">
<h8 id="_transaction_demarcation"><a class="anchor" href="#_transaction_demarcation"></a>Transaction Demarcation</h8>
<div class="paragraph">
<p>The Jakarta Transactions specifies two approaches with which new global transactions can be initiated and demarcated.</p>
</div>
<div class="paragraph">
<p>The application component can then use this object to begin, commit and rollback transactions.
In this approach, association between the calling thread and the transaction, and transaction context propagation are handled transparently by the transaction manager.</p>
</div>
<div class="listingblock">
<div class="title">Usage</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Get a UserTransaction object</span>
<span class="comment">// Begin a transaction</span>
userTransaction.begin();
<span class="comment">// Transactional operations ...</span>
<span class="comment">// End the transaction</span>
userTransaction.commit();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Usage</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Begin a transaction</span>
Transaction t = TransactionManager.begin();
<span class="comment">// Transactional operations ...</span>
<span class="comment">// End the transaction</span>
TransactionManager.commit();</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Application Program Demarcation: The <code>jakarta.transaction.UserTransaction</code> interface provides methods for application components to begin and end transactions programmatically.
The underlying application server should provide a mechanism to obtain a reference to this object.
The Jakarta Transactions specification requires that the application servers use the JNDI for storing references to UserTransaction objects and for lookup.</p>
</li>
<li>
<p>Application Server Controlled Demarcation: In this approach, the <code>jakarta.transaction.TransactionManager</code> interface controls transaction demarcation on behalf of the application being managed.
The transaction manager also maintains the transaction context and its association with the calling threads implicitly.</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_resource_enlistment_and_delistment"><a class="anchor" href="#_resource_enlistment_and_delistment"></a>Resource Enlistment and Delistment</h8>
<div class="paragraph">
<p>Transactional resources such as database connections are typically managed by the application server in conjunction with some resource adapter and optionally with connection pooling optimisation.
In order for an external transaction manager to co-ordinate transactional work performed by the resource managers, the application server must enlist and de-list the resources used in the transaction.
These resources (participants) are enlisted with the transaction so that they can be informed when the transaction terminates, e.g. are driven through the two-phase commit protocol.</p>
</div>
<div class="paragraph">
<p>Jakarta Transactions is much more closely integrated with the XA concept of resources than the arbitrary objects.
For each resource in-use by the application, the application server invokes the enlistResource method with an XAResource object which identifies the resource in use.</p>
</div>
<div class="paragraph">
<p>The enlistment request results in the transaction manager informing the resource manager to start associating the transaction with the work performed through the corresponding resource.
The transaction manager is responsible for passing the appropriate flag in its XAResource.start method call to the resource manager.</p>
</div>
<div class="paragraph">
<p>The delistResource method is used to disassociate the specified resource from the transaction context in the target object.
The application server invokes the method with the two parameters: the XAResource object that represents the resource, and a flag to indicate whether the operation is due to the transaction being suspended (TMSUSPEND), a portion of the work has failed (TMFAIL), or a normal resource release by the application (TMSUCCESS).</p>
</div>
<div class="paragraph">
<p>The de-list request results in the transaction manager informing the resource manager to end the association of the transaction with the target XAResource.
The flag value allows the application server to indicate whether it intends to come back to the same resource whereby the resource states must be kept intact.
The transaction manager passes the appropriate flag value in its XAResource.end method call to the underlying resource manager.</p>
</div>
<div class="paragraph">
<p>The application server can enlist and delist resource managers with the transaction manager using the <code>jakarta.transaction.Transaction</code> interface</p>
</div>
<div class="paragraph">
<div class="title">Usage</div>
<p>Resource enlistment is in general done by the application server when an application requests it for a connection to a transactional resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="comment">// ... an implementation of the application server</span>
<span class="comment">// Get a reference to the underlying TransactionManager object.</span>
...
<span class="comment">// Get the current Transaction object from the TransactionManager.</span>
transaction = transactionManager.getTransaction();
<span class="comment">// Get an XAResource object from a transactional resource.</span>
...
<span class="comment">// Create a Transaction object.</span>
...
<span class="comment">// Enlist the resource</span>
transaction.enlistResource(xaResource);...
<span class="comment">// Return the connection to the application.</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Resource delistment is done similarly after the application closes connections to transactional resources.</p>
</div>
</div>
<div class="sect7">
<h8 id="_application_synchronization_with_a_transaction"><a class="anchor" href="#_application_synchronization_with_a_transaction"></a>Application Synchronization with a Transaction</h8>
<div class="paragraph">
<p>Using the JTS synchronization protocol, certain objects can be registered with the transaction manager for notification before the start of and the completion of the two-phase commit process.
This enables such application objects to synchronize transient state and data stored in persistent storage.</p>
</div>
<div class="paragraph">
<p>The <code>jakarta.transaction.Transaction</code> interface provides the <em>registerSynchronization</em> method to register <code>jakarta.transaction.Synchronization</code> objects with the transaction manager.
The transaction manager then uses the synchronization protocol and calls the beforeCompletion and afterCompletion methods before and after the two phase commit process.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <em>beforeCompletion</em> method is called prior to the start of the two-phase transaction complete process.
This call is executed in the same transaction context of the caller who initiates the TransactionManager.commit or the call is executed with no transaction context if Transaction.commit is used.</p>
</li>
<li>
<p>The <em>afterCompletion</em> method is called after the transaction has completed.
The status of the transaction is supplied in the parameter.
This method is executed without a transaction context.</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_further_reading"><a class="anchor" href="#_further_reading"></a>Further Reading</h8>
<div class="ulist">
<ul>
<li>
<p>JDBC and Transactions</p>
</li>
<li>
<p>Jakarta Enterprise Beans and Transactions</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_managing_transactions_in_ejb"><a class="anchor" href="#_managing_transactions_in_ejb"></a>Managing Transactions in EJB</h6>
<div class="sect6">
<h7 id="_an_application_server_model_the_jakarta_enterprise_beans"><a class="anchor" href="#_an_application_server_model_the_jakarta_enterprise_beans"></a>An Application Server Model - The Jakarta Enterprise Beans</h7>
<div class="sect7">
<h8 id="_ejb_overview"><a class="anchor" href="#_ejb_overview"></a>EJB Overview</h8>
<div class="paragraph">
<p>Jakarta Enterprise Beans (EJB) is a technology specification that specifies a framework for building component-based distributed applications.
As an application server framework, the EJB servers address transaction processing, resource pooling, security, threading, persistence, remote access, life cycle etc.</p>
</div>
<div class="paragraph">
<p>The EJB framework specifies construction, deployment and invocation of components called as enterprise beans.
The EJB specification classifies enterprise beans into two categories: entity beans and session beans.
While entity beans abstract persistent domain data, session beans provide for session-specific application logic.
Both types of beans are maintained by EJB compliant servers in what are called as containers.
A container provides the run time environment for an enterprise bean.
The <a href="#ejb_and_transactions">EJB and Transactions</a> shows a simplified architecture of transaction management in EJB compliant application servers.</p>
</div>
<div id="ejb_and_transactions" class="imageblock text-center">
<div class="content">
<img src="images/jts-j2ee_5_ejb_model.PNG.png" alt="jts j2ee 5 ejb model.PNG">
</div>
<div class="title">Figure 27. EJB and Transactions</div>
</div>
<div class="paragraph">
<p>An enterprise bean is specified by two interfaces: the home interface and the remote interface.
The home interface specifies how a bean can be created or found.
With the help of this interface, a client or another bean can obtain a reference to a bean residing in a container on an EJB server.
The remote interface specifies application-specific methods that are relevant to entity or session beans.</p>
</div>
<div class="paragraph">
<p>Clients obtain references to home interfaces of enterprise beans via the Java Naming and Directory Interface (JNDI) mechanism.
An EJB server should provide a JNDI implementation for any naming and directory server.
Using this reference to the home interface, a client can obtain a reference to the remote interface.
The client can then access methods specified in the remote interface.
The EJB specification specifies the Java Remote Method Invocation (RMI) as the application level protocol for remote method invocation.
However, an implementation can use IIOP as the wire-level protocol.</p>
</div>
<div class="paragraph">
<p>In <a href="#ejb_and_transactions">EJB and Transactions</a>, the client first obtains a reference to the home interface, and then a reference to an instance of Bean A via the home interface.
The same procedure is applicable for instance of Bean A to obtain a reference and invoke methods on an instance of Bean B.</p>
</div>
</div>
<div class="sect7">
<h8 id="_ejb_transaction_model"><a class="anchor" href="#_ejb_transaction_model"></a>EJB Transaction Model</h8>
<div class="paragraph">
<p>The EJB framework does not specify any specific transaction service (such as the JTS) or protocol for transaction management.
However, the specification requires that the <code>jakarta.transaction.UserTransaction</code> interface of the JTS be exposed to enterprise beans.
This interface is required for programmatic transaction demarcation as discussed in the next section.</p>
</div>
<div class="paragraph">
<p>The EJB framework allows both programmatic and declarative demarcation of transactions.
Declarative demarcation is needed for all enterprise beans deployed on the EJB.
In addition, EJB clients can also initiative and end transactions programmatically.</p>
</div>
<div class="paragraph">
<p>The container performs automatic demarcation depending on the transaction attributes specified at the time of deploying an enterprise bean in a container.
The following attributes determine how transactions are created.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>NotSupported</em>: The container invokes the bean without a global transaction context.</p>
</li>
<li>
<p><em>Required</em>: The container invokes the bean within a global transaction context.
If the invoking thread already has a transaction context associated, the container invokes the bean in the same context.
Otherwise, the container creates a new transaction and invokes the bean within the transaction context.</p>
</li>
<li>
<p><em>Supports</em>: The bean is transaction-ready.
If the client invokes the bean within a transaction, the bean is also invoked within the same transaction.
Otherwise, the bean is invoked without a transaction context.</p>
</li>
<li>
<p><em>RequiresNew</em>: The container invokes the bean within a new transaction irrespective of whether the client is associated with a transaction or not.</p>
</li>
<li>
<p><em>Mandatory</em>: The container must invoke the bean within a transaction.
The caller should always start a transaction before invoking any method on the bean.</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_transaction_demarcation_2"><a class="anchor" href="#_transaction_demarcation_2"></a>Transaction Demarcation</h8>
<div class="paragraph">
<p>The EJB framework supports three types of transaction demarcation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Declarative Demarcation</em>: This is also called as container managed demarcation.
The container demarcates transactions on behalf of the bean.
The Required or RequiresNew attribute is specified in a deployment descriptor at the time of deploying the bean on an EJB server.
The bean can use the <code>jakarta.ejb.EJBContext.setRollbackOnly()</code> method to mark the transaction for rollback.</p>
</li>
<li>
<p>Bean Managed Demarcation: This is similar to the client-managed demarcation.</p>
</li>
<li>
<p>Client Managed Demarcation: Java clients can use the <code>jakarta.transaction.UserTransaction</code> interface to demarcate transactions programmatically.</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_resource_enlistment_2"><a class="anchor" href="#_resource_enlistment_2"></a>Resource Enlistment</h8>
<div class="paragraph">
<p>Resource enlistment is automatic with EJB.
The EJB containers automatically enlists connections to EJB-aware resource managers whenever a bean obtains a connection.</p>
</div>
</div>
<div class="sect7">
<h8 id="_application_synchronization"><a class="anchor" href="#_application_synchronization"></a>Application Synchronization</h8>
<div class="paragraph">
<p>The EJB specification provides the jakarta.ejb.SessionSynchronization interface for application synchronization.
When implemented by a bean, the container calls the afterBegin, beforeCompletion and afterCompletion methods for application synchronization during the two-phase commit process.</p>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_jdbc_and_transactions_3"><a class="anchor" href="#_jdbc_and_transactions_3"></a>JDBC and Transactions</h6>
<div class="paragraph">
<p>Java Data Base Connectivity, provide Java programs with a way to connect to and use relational databases.
The JDBC API lets you invoke SQL commands from Java programming language methods.
In simplest terms, JDBC allows to do three things</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Establish a connection with a database</p>
</li>
<li>
<p>Send SQL statements</p>
</li>
<li>
<p>Process the results</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following code fragment gives a simple example of these three steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="predefined-type">Connection</span> con = <span class="predefined-type">DriverManager</span>.getConnection(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:myDriver:wombat</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">myLogin</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">myPassword</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Statement</span> stmt = con.createStatement();
<span class="predefined-type">ResultSet</span> rs = stmt.executeQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT a, b, c FROM Table1</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">while</span> (rs.next()) {
    <span class="type">int</span> x = rs.getInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>);
    <span class="predefined-type">String</span> s = rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">b</span><span class="delimiter">&quot;</span></span>);
    <span class="type">float</span> f = rs.getFloat(<span class="string"><span class="delimiter">&quot;</span><span class="content">c</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before the version 2.0 of JDBC, only local transactions controlled by the transaction manager of the DBMS is possible.
To code a JDBC transaction, you invoke the commit and rollback methods of the java.sql.Connection interface.
The beginning of a transaction is implicit.
A transaction begins with the first SQL statement that follows the most recent commit, rollback, or connect statement.
(This rule is generally true, but may vary with DBMS vendor.).
The following example illustrates how transactions are managed by the JDBC API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">void</span> withdraw (<span class="type">double</span> amount) {
    <span class="keyword">try</span> {
        <span class="comment">// A connection opened with JDBC is an AUTO COMMIT mode meaning</span>
        <span class="comment">// that the commitment is automatically performed when the connection</span>
        <span class="comment">// is closed</span>
        <span class="comment">//setAutoCommit to false disable this feature</span>
        connection.setAutoCommit(<span class="predefined-constant">false</span>);
        <span class="comment">//perform an SQL update to Withdraw money from account</span>
        connection.commit();
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
        <span class="keyword">try</span> {
            connection.rollback();
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">Exception</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Transaction failed: </span><span class="delimiter">&quot;</span></span> +  ex.getMessage());
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> sqx) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">Exception</span>(...)
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the version 2.0, a JDBC driver can be involved within a distributed transaction since it supports the XAResource interface that allows to participate to the 2PC protocol.
An application that need to include more than one database can create a JTA transaction.
To demarcate a JTA transaction, the application program invokes the begin, commit, and rollback methods of the <code>jakarta.transaction.UserTransaction</code> interface.
The following code, that can be applied to a bean-managed transaction, demonstrates the UserTransaction methods.
The begin and commit invocations delimit the updates to the database.
If the updates fail, the code invokes the rollback method and throws an Exception.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">void</span> transfer(<span class="type">double</span> amount) {
    UserTransaction ut = context.getUserTransaction();

    <span class="keyword">try</span> {
        ut.begin();
        <span class="comment">// Perform SQL command to debit account 1</span>
        <span class="comment">// Perform SQL command to debit account 2</span>
        ut.commit();
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
        <span class="keyword">try</span> {
            ut.rollback();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex1) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">Exception</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">Rollback failed: </span><span class="delimiter">&quot;</span></span> + ex1.getMessage());
        }
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">Exception</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">Transaction failed: </span><span class="delimiter">&quot;</span></span> + ex.getMessage());
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_configuring_the_narayana"><a class="anchor" href="#_configuring_the_narayana"></a>Configuring the Narayana</h6>
<div class="paragraph">
<p>This trail provides information on the way to configure environmental variables needed to define the behaviour of transactional applications managed with Narayana.
Basically, the behaviour of the Narayana product is configurable through property attributes.
Although these property attributes may be specified as command line arguments, it is more convenient to organise and initialise them through properties files.</p>
</div>
<div class="sect6">
<h7 id="_properties_file"><a class="anchor" href="#_properties_file"></a>Properties File</h7>
<div class="paragraph">
<p>The properties file named <code>jbossts-properties.xml</code> and located under the &lt;ats_installation_directory&gt;/etc directory is organised as a collection of property names.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">&lt;property&gt;
    name=<span class="string"><span class="delimiter">&quot;</span><span class="content">a_name</span><span class="delimiter">&quot;</span></span>
    value=<span class="string"><span class="delimiter">&quot;</span><span class="content">a_value</span><span class="delimiter">&quot;</span></span>
&lt;/property&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some properties must be specified by the developer while others do not need to be defined and can be used with their default values.
Basically, the properties file that does not provide default values to all its properties is the <code>jbossts-properties.xml</code>.</p>
</div>
<div class="paragraph">
<p>The following table describes some properties in the <code>jbossts-properties.xml</code>, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Name</em>: indicates the name of the property</p>
</li>
<li>
<p><em>Description</em>: explain the aim of the property</p>
</li>
<li>
<p><em>Possible Value</em>: indicates possible value the property can have</p>
</li>
<li>
<p><em>Default Value</em>: shows the default value, if any, assigned to the property</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Name</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Possible Value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Default Value</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.ats.arjuna.objectstore.localOSRoot</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By default, all object states will be stored within the "defaultStore" subdirectory of the object store root. However, this subdirectory can be changed by setting the localOSRoot property variable accordingly</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">defaultStore</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.ats.arjuna.objectstore.objectStoreDir</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the location of the ObjectStore</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PutObjectStoreDirHere</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.ats.arjuna.common.varDir</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana needs to be able to write temporary files to a well known location during execution. By default this location is var. However, by setting the varDir property variable this can be overridden.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">var/tmp</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="_objectstore_management_2"><a class="anchor" href="#_objectstore_management_2"></a>ObjectStore management</h7>
<div class="paragraph">
<p>The Narayana layer requires an object store for transaction management logs.
Within the transaction service installation, object store is updated regularly whenever transactions are created, or when Transactional Objects for Java is used.
In a failure-free environment, the only object states which should reside within the object store are those representing objects created with the Transactional Objects for Java API.
However, if failures occur, transaction logs may remain in the object store until crash recovery facilities have resolved the transactions they represent.
As such, it is very important that the contents of the object store are not deleted without due care and attention, as this will make it impossible to resolve in doubt transactions.
In addition, if multiple users share the same object store it is important that they realise this and do not simply delete the contents of the object store assuming it is an exclusive resource.</p>
</div>
<div class="paragraph">
<p>The location of the ObjectStore is specified in via the properrty <code>com.arjuna.ats.arjuna.objectstore.objectStoreDir</code> that can be passed with the java flag "-D".
For convenience this property is defined in the properties file <code>jbossts-properties.xml</code>, and its value is set during the Narayana installation.
At any time, the location of the ObjectStore may be changed.</p>
</div>
</div>
<div class="sect6">
<h7 id="_configuring_output"><a class="anchor" href="#_configuring_output"></a>Configuring Output</h7>
<div class="paragraph">
<p>Sometimes it is desirable, mainly in case of debugging, to have some form of output during execution to trace internal actions performed. Narayana uses the logging tracing mechanism provided by the Arjuna Common Logging Framework (CLF) version 2.4, which provides a high level interface that hides differences that exist between logging APIs such Jakarta log4j, JDK 1.4 logging API or dotnet logging API.</p>
</div>
<div class="paragraph">
<p>With the CLF applications make logging calls on commonLogger objects.
These commonLogger objects pass log messages to Handler for publication.
Both commonLoggers and Handlers may use logging Levels to decide if they are interested in a particular log message.
Each log message has an associated log Level, that gives the importance and urgency of a log message.
The set of possible Log Levels are DEBUG, INFO, WARN, ERROR and FATAL.
Defined Levels are ordered according to their integer values as follows: DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL.</p>
</div>
<div class="paragraph">
<p>The CLF provides an extension to filter logging messages according to finer granularity an application may define.
That is, when a log message is provided to the commonLogger with the DEBUG level, additional conditions can be specified to determine if the log message is enabled or not.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These conditions are applied if and only the DEBUG level is enabled and the log request performed by the application specifies debugging granularity.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When enabled, Debugging is filtered conditionally on three variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Debugging level: this is where the log request with the DEBUG Level is generated from, e.g., constructors or basic methods.</p>
</li>
<li>
<p>Visibility level: the visibility of the constructor, method, etc. that generates the debugging.</p>
</li>
<li>
<p>Facility code: for instance the package or sub-module within which debugging is generated, e.g., the object store.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>According to these variables the Common Logging Framework defines three interfaces.
A particular product may implement its own classes according to its own finer granularity. Narayana uses the default Debugging level and the default Visibility level provided by CLF, but it defines its own Facility Code. Narayana uses the default level assigned to its commonLoggers objects (DEBUG).
However, it uses the finer debugging features to disable or enable debug messages.
Finer values used by the Narayana are defined below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Debugging level – Narayana uses the default values defined in the class <code>com.arjuna.common.util.logging.CommonDebugLevel</code></p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Debug Level</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NO_DEBUGGING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A commonLogger object assigned with this values discard all debug requests</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONSTRUCTORS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from constructors</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DESTRUCTORS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0002</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from finalizers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONSTRUCT_AND_DESTRUCT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONSTRUCTORS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DESTRUCTORS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from constructors and finalizers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FUNCTIONS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x010</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from functions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPERATORS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x020</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from operators, such as equals</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FUNCS_AND_OPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FUNCTIONS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPERATORS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from functions and operations.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_NON_TRIVIAL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONSTRUCT_AND_DESTRUCT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FUNCTIONS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPERATORS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from all non-trivial operations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRIVIAL_FUNCS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0100</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from trivial functions.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRIVIAL_OPERATORS:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0200</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from trivial operations, and operators.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_TRIVIAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRIVIAL_FUNCS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRIVIAL_OPERATORS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Diagnostics from all trivial operations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FULL_DEBUGGING</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>Visibility level – Narayana uses the default values defined in the class com.arjuna.common.util.logging.CommonVisibilityLevel</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Debug Level</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIS_NONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No Diagnostic</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIS_PRIVATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">only from private methods.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIS_PROTECTED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0002</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">only from protected methods.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIS_PUBLIC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0004</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">only from public methods.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIS_PACKAGE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0008</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">only from package methods.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIS_ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xffff</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Full Diagnostic</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>Facility Code – Narayana uses the following values</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Facility Code Level</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_ATOMIC_ACTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">atomic action core module</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_BUFFER_MAN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000004</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">state management (buffer) classes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_ABSTRACT_REC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000008</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">abstract records</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_OBJECT_STORE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000010</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object store implementations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_STATE_MAN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000020</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">state management and StateManager)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_SHMEM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000040</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shared memory implementation classes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_GENERAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000080</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">general classes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_CRASH_RECOVERY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000800</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">detailed trace of crash recovery module and classes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_THREADING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00002000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">threading classes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_JDBC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00008000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDBC 1.0 and 2.0 support</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FAC_RECOVERY_NORMAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00040000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">normal output for crash recovery manager</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To ensure appropriate output, it is necessary to set some of the finer debug properties explicitly as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;properties&gt;</span>
    <span class="comment">&lt;!-- CLF 2.4 properties --&gt;</span>
    <span class="tag">&lt;property</span>
            <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.common.util.logging.DebugLevel</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0x00000000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span>
            <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.common.util.logging.FacilityLevel</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0xffffffff</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span>
            <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.common.util.logging.VisibilityLevel</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0xffffffff</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span>
            <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.common.util.logger</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">log4j</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/properties&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, debugging messages are not enabled since the DebugLevel is set to NO_DEBUGGING (0x00000000).
You can enable debugging by providing one of the appropriate value listed above - for instance with you wish to see all internal actions performed by the RecoveryManager to recover transactions from a failure set the DebugLevel to FULL_DEBUGGING (0xffffffff) and the FacilityCode Level FAC_CRASH_RECOVERY.</p>
</div>
<div class="paragraph">
<p><em>Note</em> : To enable finger debug messages, the logging level should be set to the DEBUG level as described below.</p>
</div>
<div class="paragraph">
<p>From the program point of view a same API is used whatever the underlying logging mechanism, but from a configuration point of view is that the user is totally responsible for the configuration of the underlying logging system.
Hence, the properties of the underlying log system are configured in a manner specific to that log system, e.g., a log4j.properties file in the case that log4j logging is used.
To set the logging level to the DEBUG value, the log4j.properties file can be edited to set that value.</p>
</div>
<div class="paragraph">
<p>The property com.arjuna.common.util.logger allows to select the underlying logging system.
Possible value are listed in the following table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Property Value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">log4j</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log4j logging (log4j classes must be available in the classpath); configuration through the log4j.properties file, which is picked up from the <code>CLASSPATH</code> or given through a System property: log4j.configuration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jdk14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDK 1.4 logging API (only supported on JVMs of version 1.4 or higher). Configuration is done through a file logging.properties in the jre/lib directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">simple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selects the simple JDK 1.1 compatible console-based logger provided by Jakarta Commons Logging</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">csf</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selects CSF-based logging (CSF embeddor must be available)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jakarta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses the default log system selection algorithm of the Jakarta Commons Logging framework</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dotnet</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Selects a .net logging implementation</p>
</div>
<div class="paragraph">
<p>Since a dotnet logger is not currently implemented, this is currently identical to simple. Simple is a purely JDK1.1 console-based log implementation.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">avalon</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses the Avalon Logkit implementation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">noop</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disables all logging</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_orb_portability"><a class="anchor" href="#_orb_portability"></a>ORB Portability</h6>
<div class="sect6">
<h7 id="_introduction_7"><a class="anchor" href="#_introduction_7"></a>Introduction</h7>
<div class="paragraph">
<p>Many ORBs currently in use support different versions of CORBA and/or the Java language mapping.</p>
</div>
<div class="paragraph">
<p>Narayana only supports the new Portable Object Adapter (POA) architecture described in the CORBA 2.3 specification as a replacement for the Basic Object Adapter (BOA).
Unlike the BOA, which was weakly specified and led to a number of different (and often conflicting) implementations, the POA was deliberately designed to reduce the differences between ORB implementations, and thus minimise the amount of re-coding that would need to be done when porting applications from one ORB to another.
However, there is still scope for slight differences between ORB implementations, notably in the area of threading.
Note, instead of talking about the POA, this manual will consider the Object Adapter (OA).</p>
</div>
<div class="paragraph">
<p>Because Narayana must be able to run on a number of different ORBs, we have developed an ORB portability interface which allows entire applications to be moved between ORBs with little or no modifications.
This portability interface is available to the application programmer in the form of several Java classes.</p>
</div>
</div>
<div class="sect6">
<h7 id="_the_orb_portability_api"><a class="anchor" href="#_the_orb_portability_api"></a>The ORB Portability API</h7>

</div>
<div class="sect6">
<h7 id="_using_the_orb"><a class="anchor" href="#_using_the_orb"></a>Using the ORB</h7>
<div class="paragraph">
<p>The ORB class provided in the package com.arjuna.orbportability.ORB shown below provides a uniform way of using the ORB.
There are methods for obtaining a reference to the ORB, and for placing the application into a mode where it listens for incoming connections.
There are also methods for registering application specific classes to be invoked before or after ORB initialisation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ORB</span> {
    <span class="directive">public</span> <span class="directive">static</span> ORB getInstance(<span class="predefined-type">String</span> uniqueId);
    <span class="comment">// given the various parameters,this method initialises the ORB and</span>
    <span class="comment">// retains a reference to it within the ORB class.</span>
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initORB () <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initORB (<span class="predefined-type">Applet</span> a, <span class="predefined-type">Properties</span> p)
        <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initORB (<span class="predefined-type">String</span><span class="type">[]</span> s, <span class="predefined-type">Properties</span> p)
        <span class="directive">throws</span> SystemException;

    <span class="comment">//The orb method returns a reference to the ORB.</span>
    <span class="comment">//After shutdown is called this reference may be null.</span>
    <span class="directive">public</span> <span class="directive">synchronized</span> org.omg.CORBA.ORB orb ();
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setOrb (org.omg.CORBA.ORB theORB);
    <span class="comment">// If supported, this method cleanly shuts down the ORB.</span>
    <span class="comment">// Any pre- and post- ORB shutdown classes which</span>
    <span class="comment">//have been registered will also be called.</span>
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> shutdown ();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> addAttribute (<span class="predefined-type">Attribute</span> p);
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> addPreShutdown (PreShutdown c);
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> addPostShutdown (PostShutdown c);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> destroy () <span class="directive">throws</span> SystemException;
    <span class="comment">//these methods place the ORB into a listening mode,</span>
    <span class="comment">//where it waits for incoming invocations.</span>
    <span class="directive">public</span> <span class="type">void</span> run ();
    <span class="directive">public</span> <span class="type">void</span> run (<span class="predefined-type">String</span> name);
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note, some of the methods are not supported on all ORBs, and in this situation, a suitable exception will be thrown.
The ORB class is a factory class which has no public constructor.
To create an instance of an ORB you must call the <code>getInstance</code> method passing a unique name as a parameter.
If this unique name has not been passed in a previous call to <code>getInstance</code> you will be returned a new ORB instance.
Two invocations of <code>getInstance</code> made with the same unique name, within the same JVM, will return the same ORB instance.</p>
</div>
</div>
<div class="sect6">
<h7 id="_using_the_object_adapater_oa"><a class="anchor" href="#_using_the_object_adapater_oa"></a>Using the Object Adapater (OA)</h7>
<div class="paragraph">
<p>The OA classes shown below provide a uniform way of using Object Adapters (OA).
There are methods for obtaining a reference to the OA.
There are also methods for registering application specific classes to be invoked before or after OA initialisation.
Note, some of the methods are not supported on all ORBs, and in this situation, a suitable exception will be thrown.
The OA class is an abstract class and provides the basic interface to an Object Adapter.
It has two sub-classes RootOA and ChildOA, these classes expose the interfaces specific to the root Object Adapter and a child Object Adapter respectively.
From the RootOA you can obtain a reference to the RootOA for a given ORB by using the static method getRootOA.
To create a ChildOA instance use the createPOA method on the RootOA.</p>
</div>
<div class="paragraph">
<p>As described below, the OA class and its sub-classes provide most operations provided by the POA as specified in the POA specification.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">OA</span>
{
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="directive">static</span> RootOA getRootOA(ORB associatedORB);
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initPOA () <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initPOA (<span class="predefined-type">String</span><span class="type">[]</span> args) <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initOA () <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initOA (<span class="predefined-type">String</span><span class="type">[]</span> args) <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="directive">synchronized</span> ChildOA createPOA (<span class="predefined-type">String</span> adapterName,
        PolicyList policies) <span class="directive">throws</span> AdapterAlreadyExists, InvalidPolicy;
    <span class="directive">public</span> <span class="directive">synchronized</span> org.omg.PortableServer.POA rootPoa ();
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setPoa (org.omg.PortableServer.POA thePOA);
    <span class="directive">public</span> <span class="directive">synchronized</span> org.omg.PortableServer.POA poa (<span class="predefined-type">String</span> adapterName);
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setPoa (<span class="predefined-type">String</span> adapterName,
        org.omg.PortableServer.POA thePOA);
    ...
};

<span class="directive">public</span> <span class="type">class</span> <span class="class">RootOA</span> <span class="directive">extends</span> OA {
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> destroy() <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> org.omg.CORBA.Object corbaReference (Servant obj);
    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady (Servant obj, <span class="type">byte</span><span class="type">[]</span> id);
    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady (Servant obj);
    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject (org.omg.CORBA.Object obj);
    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject (Servant obj);
};

<span class="directive">public</span> <span class="type">class</span> <span class="class">ChildOA</span> <span class="directive">extends</span> OA {
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setRootPoa (POA thePOA);
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> destroy() <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> org.omg.CORBA.Object corbaReference (Servant obj);
    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady (Servant obj, <span class="type">byte</span><span class="type">[]</span> id)
        <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady (Servant obj) <span class="directive">throws</span> SystemException;
    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject (org.omg.CORBA.Object obj);
    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject (Servant obj);
};</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_example_4"><a class="anchor" href="#_example_4"></a>Example</h7>
<div class="paragraph">
<p>The following example illustrates how to use the ORB Portability API to create</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">import</span> <span class="include">com.arjuna.orbportability.ORB</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.orbportability.OA</span>;

<span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    <span class="keyword">try</span> {
        <span class="comment">// Create an ORB instance</span>
        ORB orb = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">orb_test</span><span class="delimiter">&quot;</span></span>);
        OA oa = OA.getRootOA( orb );  <span class="comment">// Get the root POA</span>
        orb.initORB(args, <span class="predefined-constant">null</span>); <span class="comment">// Initialize the ORB</span>
        oa.initOA(args);  <span class="comment">// Initialize the OA</span>
        <span class="comment">// Do Work</span>
        oa.destroy(); <span class="comment">// destroy the OA</span>
        orb.shutdown();  <span class="comment">// Shutdown the ORB</span>
    } <span class="keyword">catch</span>(<span class="exception">Exception</span> e) {

    }
};</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_specifying_the_orb_to_use"><a class="anchor" href="#_specifying_the_orb_to_use"></a>Specifying the ORB to use</h7>
<div class="paragraph">
<p>If using such a JDK (from its version 1.2.2) in conjunction with another ORB it is necessary to tell the JVM which ORB to use.
This happens by specifying the org.omg.CORBA.ORBClass and org.omg.CORBA.ORBSingletonClass properties.
If used, ORB Portability classes will ensure that these properties are automatically set when required, i.e., during ORB initialisation.</p>
</div>
<div class="paragraph">
<p>The ORB portability library attempts to detect which ORB is in use, it does this by looking for the ORB implementation class for each ORB it supports.
This means that if there are classes for more than one ORB in the classpath the wrong ORB can be detected.
Therefore it is best to only have one ORB in your classpath.
If it is necessary to have multiple ORBs in the classpath then the property com.arjuna.orbportability.orbImplementation must be set to the value specified in the table below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>ORB</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Property Value</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JacORB v2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.orbportability.internal.orbspecific.jacorb.orb.implementations.jacorb_2_0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For additional details on the features provided by the ORB Portability API refer to the documentation provided by the Narayana distribution.</p>
</div>
</div>
<div class="sect6">
<h7 id="_narayana_failure_recovery"><a class="anchor" href="#_narayana_failure_recovery"></a>Narayana Failure Recovery</h7>
<div class="paragraph">
<p>The failure recovery subsystem of Narayana will ensure that results of a transaction are applied consistently to all resources affected by the transaction, even if any of the application processes or the machine hosting them crash or lose network connectivity.
In the case of machine (system) crash or network failure, the recovery will not take place until the system or network are restored, but the original application does not need to be restarted recovery responsibility is delegated to the Recovery Manager process (see below).
Recovery after failure requires that information about the transaction and the resources involved survives the failure and is accessible afterward: this information is held in the ActionStore, which is part of the ObjectStore.
If the ObjectStore is destroyed or modified, recovery may not be possible.</p>
</div>
<div class="paragraph">
<p>Until the recovery procedures are complete, resources affected by a transaction that was in progress at the time of the failure may be inaccessible.
For database resources, this may be reported as tables or rows held by "in-doubt transactions".</p>
</div>
</div>
<div class="sect6">
<h7 id="_the_recovery_manager_2"><a class="anchor" href="#_the_recovery_manager_2"></a>The Recovery Manager</h7>
<div class="paragraph">
<p>The Recovery Manager is a daemon process responsible for performing crash recovery.
Only one Recovery Manager runs per node.
The Object Store provides persistent data storage for transactions to log data.
During normal transaction processing each transaction will log persistent data needed for the commit phase to the Object Store.
On successfully committing a transaction this data is removed, however if the transaction fails then this data remains within the Object Store.</p>
</div>
<div class="paragraph">
<p>The Recovery Manager functions by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Periodically scanning the Object Store for transactions that may have failed.
Failed transactions are indicated by the presence of log data after a period of time that the transaction would have normally been expected to finish.</p>
</li>
<li>
<p>Checking with the application process which originated the transaction whether the transaction is still in progress or not.</p>
</li>
<li>
<p>Recovering the transaction by re-activating the transaction and then replaying phase two of the commit protocol.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To start the Recovery Manager issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the -test flag is used with the Recovery Manager then it will display a "Ready" message when initialised, i.e.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager -test</code></pre>
</div>
</div>
<div class="paragraph">
<p>On initialization the Recovery Manager first loads in configuration information via a properties file.
This configuration includes a number of recovery activators and recovery modules, which are then dynamically loaded.</p>
</div>
<div class="paragraph">
<p>Each recovery activator, which implements the com.arjuna.ats.arjuna.recovery.RecoveryActivator interface, is used to instantiate a recovery class related to the underlying communication protocol.
Indeed, since the version 3.0 of Narayana, the Recovery Manager is not specifically tied to an Object Request Broker or ORB, which is to specify a recovery instance able to manage the OTS recovery protocol the new interface RecoveryActivator is provided to identify specific transaction protocol.
For instance, when used with OTS, the RecoveryActivitor has the responsibility to create a RecoveryCoordinator object able to respond to the replay_completion operation.</p>
</div>
<div class="paragraph">
<p>All RecoveryActivator instances inherit the same interface.
They are loaded via the following recovery extension property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryActivator_&lt;number</span></span><span class="error">&gt;</span>&quot;
    value=&quot;RecoveryClass&quot;/<span class="error">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For instance the RecoveryActivator provided in the distribution of JTS/OTS, which shall not be commented, is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryActivator_1</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.jts.</span>
        <span class="content">orbspecific.recovery.RecoveryEnablement</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each recovery module, which implements the <code>com.arjuna.ats.arjuna.recovery.RecoveryModule</code> interface, is used to recover a different type of transaction/resource, however each recovery module inherits the same basic behaviour.</p>
</div>
<div class="paragraph">
<p>Recovery consists of two separate passes/phases separated by two timeout periods.
The first pass examines the object store for potentially failed transactions; the second pass performs crash recovery on failed transactions.
The timeout between the first and second pass is known as the backoff period.
The timeout between the end of the second pass and the start of the first pass is the recovery period.
The recovery period is larger than the backoff period.</p>
</div>
<div class="paragraph">
<p>The Recovery Manager invokes the first pass upon each recovery module, applies the backoff period timeout, invokes the second pass upon each recovery module and finally applies the recovery period timeout before restarting the first pass again.</p>
</div>
<div class="paragraph">
<p>The recovery modules are loaded via the following recovery extension property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">com.arjuna.ats.arjuna.recovery.recoveryExtension<span class="tag">&lt;number&gt;</span>=<span class="tag">&lt;RecoveryClass&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The default RecoveryExtension settings are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryExtension1</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.</span>
        <span class="content">arjuna.recovery.AtomicActionRecoveryModule</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryExtension2</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.</span>
        <span class="content">txoj.recovery.TORecoveryModule</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryExtension3</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.</span>
        <span class="content">jts.recovery.transactions.TopLevelTransactionRecoveryModule</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryExtension4</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.</span>
        <span class="content">jts.recovery.transactions.ServerTransactionRecoveryModule</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_configuring_the_recovery_manager_3"><a class="anchor" href="#_configuring_the_recovery_manager_3"></a>Configuring the Recovery Manager</h7>

</div>
<div class="sect6">
<h7 id="_periodic_recovery_3"><a class="anchor" href="#_periodic_recovery_3"></a>Periodic Recovery</h7>
<div class="paragraph">
<p>The backoff period and recovery period are set using the following properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (default 10 secs) --&gt;</span>
com.arjuna.ats.arjuna.recovery.recoveryBackoffPeriod
<span class="comment">&lt;!-- (default 120 secs) --&gt;</span>
com.arjuna.ats.arjuna.recovery.periodicRecovery</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_expired_entry_removal_3"><a class="anchor" href="#_expired_entry_removal_3"></a>Expired entry removal</h7>
<div class="paragraph">
<p>The operation of the recovery subsystem will cause some entries to be made in the ObjectStore that will not be removed in normal progress.
The RecoveryManager has a facility for scanning for these and removing items that are very old.
Scans and removals are performed by implementations of the com.arjuna.ats.arjuna.recovery.ExpiryScanner.
Implementations of this interface are loaded by giving the class name as the value of a property whose name begins with ExperyScanner.</p>
</div>
<div class="paragraph">
<p>The RecoveryManager calls the scan() method on each loaded ExpiryScanner implementation at an interval determined by the property com.arjuna.ats.arjuna.recovery.expiryScanInterval.
This value is given in hours default is 12.
An EXPIRY_SCAN_INTERVAL value of zero will suppress any expiry scanning.
If the value as supplied is positive, the first scan is performed when RecoveryManager starts; if the value is negative, the first scan is delayed until after the first interval (using the absolute value)</p>
</div>
<div class="paragraph">
<p>The default ExpiryScanner is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">&lt;property
    name=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.
        expiryScannerTransactionStatusManager</span><span class="delimiter">&quot;</span></span>
    value=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.arjuna.recovery.
        ExpiredTransactionStatusManagerScanner</span><span class="delimiter">&quot;</span></span>/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following table summarize properties used by the Recovery Manager.
These properties are defined by default the properties file named RecoveryManager-properties.xml.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Name</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Possible Value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Default Value</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.periodicRecoveryPeriod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval in seconds between initiating the periodic recovery modules</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value in seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">120</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.recoveryBackoffPeriod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval in seconds between first and second pass of periodic recovery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value in seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.recoveryExtensionX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates a periodic recovery module to use. X is the occurence number of the recovery module among a set of recovery modules. These modules are invoked in sort-order of names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The class name of the periodic recovery module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana provides a set classes given in the RecoveryManager-properties.xml file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.recoveryActivator_X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates a recovery activator to use. X is the occurence number of the recovery activator among a set of recovery activators.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The class name of the periodic recovery activator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana provide one class that manages the recovery protocol specified by the OTS specification</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.expiryScannerXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expiry scanners to use (order of invocation is random). Names must begin with "com.arjuna.ats.arjuna.recovery.expiryScanner"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Narayana provides one class given in the RecoveryManager-properties.xml file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.expiryScanInterval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval, in hours, between running the expiry scanners. This can be quite long. The absolute value determines the interval - if the value is negative, the scan will NOT be run until after one interval has elapsed. If positive the first scan will be immediately after startup. Zero will prevent any scanning.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value in hours</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.transactionStatusManagerExpiryTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Age, in hours, for removal of transaction status manager item. This should be longer than any ts-using process will remain running. Zero = Never removed.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value in Hours</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.arjuna.recovery.transactionStatusManagerPort</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use this to fix the port on which the TransactionStatusManager listens</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port number (short)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">use a free port</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_installation_content"><a class="anchor" href="#_installation_content"></a>Installation Content</h6>
<div class="sect6">
<h7 id="_verifying_installation"><a class="anchor" href="#_verifying_installation"></a>Verifying Installation</h7>
<div class="paragraph">
<p>When installed, the binary release of Narayana, JTS version, should have the following structure.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>/bin: this directory contains commands to run the OTS transaction manager server (if required) and the Recovery Manager, and scripts to configure environment variables needed to execute Narayana.</p>
</li>
<li>
<p>/docs: this directory contains documentation on the way to installing, administering and programming ArjunaCore, Narayana JTA and Narayana JTS.</p>
</li>
<li>
<p>/etc: this directory contains appropriate properties files that can be used to configure the behaviour of the Narayana.</p>
</li>
<li>
<p>/htdocs: this directory describes all APIs defined by Narayana</p>
</li>
<li>
<p>/idl: this directory contains the CORBA idl files that may be registered with your interface repository prior to running any applications.</p>
</li>
<li>
<p>/jacorb: This directory contains the jacorb distribution.</p>
</li>
<li>
<p>/lib: this directory contains the jar files that contains packages defined by the Narayana.
These jar files shall be added in the <code>CLASSPATH</code></p>
</li>
<li>
<p>/services: this directory contains the appropriates scripts, jar and configuration files allowing to start and stop standalone Transaction Service and Recovery Manager</p>
</li>
<li>
<p>/trail_map: contains examples applications</p>
</li>
</ul>
</div>
</div>
<div class="sect6">
<h7 id="_testing_your_installation"><a class="anchor" href="#_testing_your_installation"></a>Testing your installation</h7>
<div class="paragraph">
<p>To ensure that your Narayana installation is fully operational, we will run the simple demo.</p>
</div>
<div class="paragraph">
<p>Please follow these steps before running the transactional applications</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure you have the Ant build system installed.
Ant is a Java build tool, similar to make.
It is available for free from <a href="http://ant.apache.org/" class="bare">http://ant.apache.org/</a> The sample application requires version 1.5.1 or later.</p>
</li>
<li>
<p>The <code>PATH</code> and <code>CLASSPATH</code> environment variables need to be set appropriately to use Narayana.
To make this easier, we provide a shell script <code>setup_env.sh</code> (and for Windows a batch file <code>setup_env.bat</code>) in the directory <code>&lt;jbossts_install_root&gt;/bin/</code></p>
</li>
<li>
<p>From a command prompt, cd to the directory containing the <code>build.xml</code> file (<code>&lt;jbossts_install_root&gt;/trail_map</code>) and type 'ant'.
This will compile a set of sources files located under <code>&lt;jbossts_install_root&gt;/trail_map/src</code> then create an application .jar file named <code>jbossts-demo.jar</code> under the directory <code>&lt;jbossts_install_root&gt;/trail_map/lib</code></p>
</li>
<li>
<p>Add the generated jar file to the <code>CLASSPATH</code> environment variable.</p>
</li>
<li>
<p>Ensure that the jacorb is added in your <code>CLASSPATH</code>.
Use only the patched version that ships with Narayana.</p>
<div class="paragraph">
<p><em>Ensure that Narayana jar files appear before jacorb jar files.</em></p>
</div>
</li>
<li>
<p>Start the server <code>src/com/arjuna/demo/simple/HelloServer.java</code> (HelloServer.java).</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The source code for the trailmap is fully documented and can often contain very useful tips and information that may not be reflected elsewhere in the trailmap</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.simple.HelloServer</code></pre>
</div>
</div>
</li>
<li>
<p>Open another command prompt, go to the same <code>/trail_map</code> directory and start the client <code>src/com/arjuna/demo/simple/HelloClient.java</code> (HelloClient.java). Be sure that the environment variable <code>CLASSPATH</code> is set with the same value as explained above.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.simple.HelloClient</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the client window you should see the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Creating a transaction !
Call the Hello Server !
Commit transaction
Done</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the server, which must be stopped by hand, you should see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Hello - called within a scope of a transaction</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_setting_properties_2"><a class="anchor" href="#_setting_properties_2"></a>Setting properties</h7>
<div class="paragraph">
<p>Narayana has been designed to be highly configurable at runtime through the use of various property attributes.
Although these attributes can be provided at runtime on the command line, it is possible (and may be more convenient) to specify them through the properties file <code>jbossts-properties.xml</code> located under the <code>/etc</code> directory of the Narayana distribution.</p>
</div>
<div class="paragraph">
<p>More details on the way to configure the behavior of Narayana can be found in the section on configuration.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_specifying_the_orb_to_use_2"><a class="anchor" href="#_specifying_the_orb_to_use_2"></a>Specifying the ORB to use</h6>
<div class="paragraph">
<p>JDK releases from 1.2.2 onwards include a minimum ORB implementation from Sun.
If using such a JDK in conjunction with another ORB it is necessary to tell the JVM which ORB to use.
This happens by specifying the <em>org.omg.CORBA.ORBClass</em> and <em>org.omg.CORBA.ORBSingletonClass</em> properties.
In earlier versions of the Narayana it was necessary to specify these properties explicitly, either on the command line of in the properties file.
However, it is no longer a requirement to do this, as the ORB Portability classes will ensure that these properties are automatically set when required.
Of course it is still possible to specify these values explicitly (and necessary if not using the ORB initialization methods)</p>
</div>
</div>
<div class="sect5">
<h6 id="_overview_of_the_distributed_transaction_processing_2"><a class="anchor" href="#_overview_of_the_distributed_transaction_processing_2"></a>Overview of the Distributed Transaction Processing</h6>
<div class="paragraph">
<p>Transaction management is one of the most crucial requirements for enterprise application development.
Most of the large enterprise applications in the domains of finance, banking and electronic commerce rely on transaction processing for delivering their business functionality.</p>
</div>
<div class="paragraph">
<p>Enterprise applications often require concurrent access to distributed data shared amongst multiple components, to perform operations on data.
Such applications should maintain integrity of data (as defined by the business rules of the application) under the following circumstances:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>distributed access to a single resource of data, and</p>
</li>
<li>
<p>access to distributed resources from a single application component.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In such cases, it may be required that a group of operations on (distributed) resources be treated as one unit of work.
In a unit of work, all the participating operations should either succeed or fail and recover together.
This problem is more complicated when</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a unit of work is implemented across a group of distributed components operating on data from multiple resources, and/or</p>
</li>
<li>
<p>the participating operations are executed sequentially or in parallel threads requiring coordination and/or synchronization.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In either case, it is required that success or failure of a unit of work be maintained by the application.
In case of a failure, all the resources should bring back the state of the data to the previous state ( <em>i.e.,</em> the state prior to the commencement of the unit of work).</p>
</div>
<div class="paragraph">
<p>From the programmer&#8217;s perspective a transaction is a scoping mechanism for a collection of actions which must complete as a unit.
It provides a simplified model for exception handling since only two outcomes are possible:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>success - meaning that all actions involved within a transaction are completed</p>
</li>
<li>
<p>failure - no actions complete</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_example_5"><a class="anchor" href="#_example_5"></a>Example</h6>
<div class="paragraph">
<p>To illustrate the reliability expected by the application, let’s consider the fund transfer example which is familiar to all of us.</p>
</div>
<div class="paragraph">
<p>The Money transfer involves two operations: Deposit and Withdrawal</p>
</div>
<div class="paragraph">
<p>The complexity of implementation doesn&#8217;t matter; money moves from one place to another.
For instance, involved accounts may be either located in the same relational table within a database or located on different databases.</p>
</div>
<div class="paragraph">
<p>A Simple transfer consists on moving money from savings to checking while a Complex transfer can be performed at the end-of-day according to a reconciliation between international banks</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-example_transfer.PNG.png" alt="jts example transfer.PNG">
</div>
</div>
<div class="sect6">
<h7 id="_what_is_a_transaction"><a class="anchor" href="#_what_is_a_transaction"></a>What is a Transaction?</h7>
<div class="paragraph">
<p>The concept of a transaction, and a transaction manager (or a transaction processing service) simplifies construction of such enterprise level distributed applications while maintaining integrity of data in a unit of work.</p>
</div>
<div class="paragraph">
<p>A transaction is a unit of work that has the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Atomicity</em>: either the whole transaction completes or nothing completes - partial completion is not permitted.</p>
</li>
<li>
<p><em>Consistency</em>: a transaction transforms the system from one consistent state to another.
In other words, On completion of a successful transaction, the data should be in a consistent state.
For example, in the case of relational databases, a consistent transaction should preserve all the integrity constraints defined on the data.</p>
</li>
<li>
<p><em>Isolation</em>: Each transaction should appear to execute independently of other transactions that may be executing concurrently in the same environment.
The effect of executing a set of transactions serially should be the same as that of running them concurrently.
This requires two things:</p>
<div class="ulist">
<ul>
<li>
<p>During the course of a transaction, intermediate (possibly inconsistent) state of the data should not be exposed to all other transactions.</p>
</li>
<li>
<p>Two concurrent transactions should not be able to operate on the same data.
Database management systems usually implement this feature using locking.</p>
</li>
</ul>
</div>
</li>
<li>
<p><em>Durability</em>: The effects of a completed transaction should always be persistent.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These properties, called as <em>ACID</em> properties, guarantee that a transaction is never incomplete, the data is never inconsistent, concurrent transactions are independent, and the effects of a transaction are persistent.</p>
</div>
</div>
<div class="sect6">
<h7 id="_transactional_concepts_2"><a class="anchor" href="#_transactional_concepts_2"></a>Transactional Concepts</h7>
<div class="sect7">
<h8 id="_transaction_components_2"><a class="anchor" href="#_transaction_components_2"></a>Transaction Components</h8>
<div class="paragraph">
<p>A collection of actions is said to be transactional if they possess the ACID properties.
These properties are assumed to be ensured, in the presence of failures; if actions involved within the transaction are performed by a Transactional System.
A transaction system includes a set of components where each of them has a particular role.
Main components are described below.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-transaction_components.PNG.png" alt="jts transaction components.PNG">
</div>
</div>
</div>
<div class="sect7">
<h8 id="_application_programs_2"><a class="anchor" href="#_application_programs_2"></a>Application Programs</h8>
<div class="paragraph">
<p>Application Programs are clients for the transactional resources.
These are the programs with which the application developer implements business transactions.
With the help of the transaction manager, these components create global transactions and operate on the transactional resources with in the scope of these transactions.
These components are not responsible for implementing mechanisms for preserving ACID properties of transactions.
However, as part of the application logic, these components generally make a decision whether to commit or rollback transactions.</p>
</div>
<div class="paragraph">
<p>Application responsibilities could be summarised as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create and demarcate transactions</p>
</li>
<li>
<p>Operate on data via resource managers</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_resource_managers"><a class="anchor" href="#_resource_managers"></a>Resource Managers</h8>
<div class="paragraph">
<p>A resource manager is, in general, a component that manages persistent and stable data storage system, and participates in the two phase commit and recovery protocols with the transaction manager.</p>
</div>
<div class="paragraph">
<p>A resource manager is typically a driver that provides two sets of interfaces: one set for the application components to get connections and operating, and the other set for participating in two phase commit and recovery protocols coordinated by a transaction manager.
This component may also, directly or indirectly, register resources with the transaction manager so that the transaction manager can keep track of all the resources participating in a transaction.
This process is called as resource enlistment.</p>
</div>
<div class="paragraph">
<p>Resource Manager responsibilities could be summarised as follows</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enlist resources with the transaction manager</p>
</li>
<li>
<p>Participate in two-phase commit and recovery protocol</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_transaction_manager"><a class="anchor" href="#_transaction_manager"></a>Transaction Manager</h8>
<div class="paragraph">
<p>The transaction manager is the core component of a transaction processing environment.
Its main responsibilities are to create transactions when requested by application components, allow resource enlistment and delistment, and to manage the two-phase commit or recovery protocol with the resource managers.</p>
</div>
<div class="paragraph">
<p>A typical transactional application begins a transaction by issuing a request to a transaction manager to initiate a transaction.
In response, the transaction manager starts a transaction and associates it with the calling thread.
The transaction manager also establishes a transaction context.
All application components and/or threads participating in the transaction share the transaction context.
The thread that initially issued the request for beginning the transaction, or, if the transaction manager allows, any other thread may eventually terminate the transaction by issuing a commit or rollback request.</p>
</div>
<div class="paragraph">
<p>Before a transaction is terminated, any number of components and/or threads may perform transactional operations on any number of transactional resources known to the transaction manager.
If allowed by the transaction manager, a transaction may be suspended or resumed before finally completing the transaction.</p>
</div>
<div class="paragraph">
<p>Once the application issues the commit request, the transaction manager prepares all the resources for a commit operation, and based on whether all resources are ready for a commit or not, issues a commit or rollback request to all the resources.</p>
</div>
<div class="paragraph">
<p>Resource Manager responsibilities could be summarised as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Establish and maintain transaction context</p>
</li>
<li>
<p>Maintain association between a transaction and the participating resources.</p>
</li>
<li>
<p>Initiate and conduct two-phase commit and recovery protocol with the resource managers.</p>
</li>
<li>
<p>Make synchronization calls to the application components before beginning and after end of the two-phase commit and recovery process</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_local_vs_distributed_transaction_2"><a class="anchor" href="#_local_vs_distributed_transaction_2"></a>Local vs. Distributed Transaction</h8>
<div class="paragraph">
<p>A transaction that involves only one transactional resource, such a database, is considered as <em>local transaction</em> , while a transaction that involves more than one transactional resource that need to be coordinated to reach a consistent state is considered as a <em>distributed transaction.</em></p>
</div>
<div class="paragraph">
<p>A transaction can be specified by what is known as transaction demarcation.
Transaction demarcation enables work done by distributed components to be bound by a global transaction.
It is a way of marking groups of operations to constitute a transaction.</p>
</div>
<div class="paragraph">
<p>The most common approach to demarcation is to mark the thread executing the operations for transaction processing.
This is called as programmatic demarcation.
The transaction so established can be suspended by unmarking the thread, and be resumed later by explicitly propagating the transaction context from the point of suspension to the point of resumption.</p>
</div>
<div class="paragraph">
<p>The transaction demarcation ends after a commit or a rollback request to the transaction manager.
The commit request directs all the participating resources managers to record the effects of the operations of the transaction permanently.
The rollback request makes the resource managers undo the effects of all operations on the transaction.</p>
</div>
</div>
<div class="sect7">
<h8 id="_transaction_context_and_propagation_2"><a class="anchor" href="#_transaction_context_and_propagation_2"></a>Transaction Context and Propagation</h8>
<div class="paragraph">
<p>Since multiple application components and resources participate in a transaction, it is necessary for the transaction manager to establish and maintain the state of the transaction as it occurs.
This is usually done in the form of transaction context.</p>
</div>
<div class="paragraph">
<p>Transaction context is an association between the transactional operations on the resources, and the components invoking the operations.
During the course of a transaction, all the threads participating in the transaction share the transaction context.
Thus the transaction context logically envelops all the operations performed on transactional resources during a transaction.
The transaction context is usually maintained transparently by the underlying transaction manager.</p>
</div>
</div>
<div class="sect7">
<h8 id="_resource_enlistment_3"><a class="anchor" href="#_resource_enlistment_3"></a>Resource Enlistment</h8>
<div class="paragraph">
<p>Resource enlistment is the process by which resource managers inform the transaction manager of their participation in a transaction.
This process enables the transaction manager to keep track of all the resources participating in a transaction.
The transaction manager uses this information to coordinate transactional work performed by the resource managers and to drive two-phase and recovery protocol.
At the end of a transaction (after a commit or rollback) the transaction manager delists the resources.</p>
</div>
</div>
<div class="sect7">
<h8 id="_two_phase_commit_2"><a class="anchor" href="#_two_phase_commit_2"></a>Two-Phase Commit</h8>
<div class="paragraph">
<p>This protocol between the transaction manager and all the resources enlisted for a transaction ensures that either all the resource managers commit the transaction or they all abort.
In this protocol, when the application requests for committing the transaction, the transaction manager issues a prepare request to all the resource managers involved.
Each of these resources may in turn send a reply indicating whether it is ready for commit or not.
Only The transaction manager issue a commit request to all the resource managers, only when all the resource managers are ready for a commit.
Otherwise, the transaction manager issues a rollback request and the transaction will be rolled back.</p>
</div>
</div>
<div class="sect7">
<h8 id="_recovery_and_logging_2"><a class="anchor" href="#_recovery_and_logging_2"></a>Recovery and Logging</h8>
<div class="paragraph">
<p>Basically, the Recovery is the mechanism which preserves the transaction atomicity in presence of failures.
The basic technique for implementing transactions in presence of failures is based on the use of logs.
That is, a transaction system has to record enough information to ensure that it can be able to return to a previous state in case of failure or to ensure that changes committed by a transaction are properly stored.</p>
</div>
<div class="paragraph">
<p>In addition to be able to store appropriate information, all participants within a distributed transaction must log similar information which allow them to take a same decision either to set data in their final state or in their initial state.</p>
</div>
<div class="paragraph">
<p>Two techniques are in general used to ensure transaction&#8217;s atomicity.
A first technique focuses on manipulated data, such the Do/Undo/Redo protocol (considered as a recovery mechanism in a centralized system), which allow a participant to set its data in their final values or to retrieve them in their initial values.
A second technique relies on a distributed protocol named the two phases commit, ensuring that all participants involved within a distributed transaction set their data either in their final values or in their initial values.
In other words all participants must commit or all must rollback.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-recovery_logs.PNG.png" alt="jts recovery logs.PNG">
</div>
</div>
<div class="paragraph">
<p>In addition to failures we refer as centralized such system crashes, communication failures due for instance to network outages or message loss have to be considered during the recovery process of a distributed transaction.</p>
</div>
<div class="paragraph">
<p>In order to provide an efficient and optimized mechanism to deal with failure, modern transactional systems typically adopt a “presume abort” strategy, which simplifies the transaction management.</p>
</div>
<div class="paragraph">
<p>The presumed abort strategy can be stated as «when in doubt, abort».
With this strategy, when the recovery mechanism has no information about the transaction, it presumes that the transaction has been aborted.</p>
</div>
<div class="paragraph">
<p>A particularity of the presumed-abort assumption allows a coordinator to not log anything before the commit decision and the participants do not to log anything before they prepare.
Then, any failure which occurs before the 2PC starts leads to abort the transaction.
Furthermore, from a coordinator&#8217;s point of view, any communication failure detected by a timeout or exception raised on sending prepare is considered as a negative vote which leads to abort the transaction.
So, within a distributed transaction, a coordinator or a participant may fail in two ways: either it crashes or it times out for a message it was expecting.
When a coordinator or a participant crashes and then restarts, it uses information on stable storage to determine the way to perform the recovery.
As we will see it the presumed-abort strategy enable an optimized behavior for the recovery.</p>
</div>
</div>
<div class="sect7">
<h8 id="_heuristic_decision_2"><a class="anchor" href="#_heuristic_decision_2"></a>Heuristic Decision</h8>
<div class="paragraph">
<p>In extremely rare cases, a resource manager may choose not to wait for the outcome from the transaction manager.
This might occur if the communications path was lost and was not likely to be restored for a very long time.
Typically, this happens as a result of human intervention and not as an arbitrary action of a resource manager.
In order to release locks and make this transaction data available to new transactions, the resource manager makes a heuristic decision, i.e. it guesses the proper transaction outcome.
When it does so, it must remember its guess until contact with the transaction manager is ultimately re-established.</p>
</div>
</div>
<div class="sect7">
<h8 id="_standards_2"><a class="anchor" href="#_standards_2"></a>Standards</h8>
<div class="paragraph">
<p>Saying that a distributed transaction can involve several distributed participants, means that these participant must be integrated within a global transaction manager which has the responsibility to ensure that all participants take a common decision to commit or rollback the distributed transaction.
The key of such integration is the existence of a common transactional interface which is understood by all participants, transaction manager and resource managers such databases.</p>
</div>
<div class="paragraph">
<p>The importance of common interfaces between participants, as well as the complexity of their implementation, becomes obvious in an open systems environment.
For this aim, various distributed transaction processing standards have been developed by international standards organizations.
Among these organizations, We list three of them which are mainly considered in the Narayana product:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The X/Open model and its successful XA interface</p>
</li>
<li>
<p>The OMG with its CORBA infrastructure and the Object Transaction Service and finally</p>
</li>
<li>
<p>The Java Community Process led by Sun with its JTA/JTS specification</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Basically these standards have proposed logical models, which divide transaction processing into several functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>those assigned to the application which ties resources together in application-specific operations</p>
</li>
<li>
<p>those assigned to the Resource manager which access physically to data stores</p>
</li>
<li>
<p>functions performed by the Transaction Manager which manages transactions, and finally</p>
</li>
<li>
<p>Communication Resource Managers which allow exchanging information with other transactional domains.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-standards.PNG.png" alt="jts standards.PNG">
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_narayana_overview"><a class="anchor" href="#_narayana_overview"></a>Narayana Overview</h6>
<div class="paragraph">
<p>Narayana assures complete, accurate business transactions for any Java based applications, including those written for the Jakarta EE and EJB frameworks.</p>
</div>
<div class="paragraph">
<p>Narayana is a 100% Java implementation of a distributed transaction management system based on the Jakarta EE Java Transaction Service (JTS) standard.
Our implementation of the JTS utilizes the Object Management Group&#8217;s (OMG) Object Transaction Service (OTS) model for transaction interoperability as recommended in the Jakarta EE and EJB standards.
Although any JTS-compliant product will allow Java objects to participate in transactions, one of the key features of Narayana is it&#8217;s 100% Java implementation.
This allows Narayana to support fully distributed transactions that can be coordinated by distributed parties.</p>
</div>
<div class="paragraph">
<p>Narayana runs can be run both as an embedded distributed service of an application server (e.g. WildFly Application Server), affording the user all the added benefits of the application server environment such as real-time load balancing, unlimited linear scalability and unmatched fault tolerance that allows you to deliver an always-on solution to your customers.
It is also available as a free-standing Java Transaction Service.</p>
</div>
<div class="paragraph">
<p>In addition to providing full compliance with the latest version of the JTS specification, Narayana leads the market in providing many advanced features such as fully distributed transactions and ORB portability with POA support.</p>
</div>
<div class="paragraph">
<p>Narayana works on a number of operating systems including Red Hat linux, Sun Solaris and Microsoft Windows XP.
It requires a Java 5 or later environment.</p>
</div>
<div class="paragraph">
<p>The Java Transaction API support for Narayana comes in two flavours:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a purely local implementation that does not require an ORB, but obviously requires all coordinated resources to reside within the same JVM.</p>
</li>
<li>
<p>a fully distributed implementation.</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="_key_features"><a class="anchor" href="#_key_features"></a>Key features</h7>
<div class="ulist">
<ul>
<li>
<p>fully compliant with the Jakarta Transactions 2.0 specification:</p>
<div class="ulist">
<ul>
<li>
<p>Purely local (ORB-less) JTA offers the fastest JTA performance</p>
</li>
<li>
<p>JDBC 3 support</p>
</li>
<li>
<p>XA compliance</p>
</li>
<li>
<p>JDBC drivers for database access with full transaction support</p>
</li>
<li>
<p>Automatic crash recovery for XAResources</p>
</li>
</ul>
</div>
</li>
<li>
<p>compliance with the JTS specification and OTS 1.2 specification from the OMG</p>
<div class="ulist">
<ul>
<li>
<p>Distributed JTA implementation</p>
</li>
<li>
<p>support for distributed transactions (utilizing two-phase commit)</p>
</li>
<li>
<p>POA ORB support</p>
</li>
<li>
<p>interposition</p>
</li>
<li>
<p>transaction heuristics</p>
</li>
<li>
<p>distributed transaction manager (co-located with the transaction initiator) or transaction manager server</p>
</li>
<li>
<p>checked/unchecked transaction behaviour</p>
</li>
<li>
<p>supports both flat and nested transaction models, with nested-aware resources and resource adapters</p>
</li>
<li>
<p>independent concurrency control system with support for type-specific concurrency control</p>
</li>
<li>
<p>support for CosTransaction::Current</p>
</li>
<li>
<p>direct and indirect transaction management</p>
</li>
<li>
<p>synchronization interface</p>
</li>
<li>
<p>explicit and implicit transaction context propagation</p>
</li>
<li>
<p>automatic crash recovery</p>
</li>
<li>
<p>multi-thread aware</p>
</li>
</ul>
</div>
</li>
<li>
<p>transactional objects (TO) for Java</p>
</li>
<li>
<p>ORB independence via the ORB portability layer</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_the_sample_application"><a class="anchor" href="#_the_sample_application"></a>The Sample Application</h6>
<div class="sect6">
<h7 id="_the_banking_application"><a class="anchor" href="#_the_banking_application"></a>The Banking Application</h7>
<div class="paragraph">
<p>The sample application consists of a banking application that involves a bank able to manage accounts on behalf of clients.
Clients can obtain information on accounts and perform operations such credit, withdraw and transfer money from one account to an other.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-banking_application_1.PNG.png" alt="jts banking application 1.PNG">
</div>
<div class="title">Figure 28. The Banking Applications</div>
</div>
<div class="paragraph">
<p>The client application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Initializes the banking object.</p>
</li>
<li>
<p>Choose an operation to be performed on the banking object.
Possible operations are:</p>
<div class="ulist">
<ul>
<li>
<p>Create Account: this operation asks the bank to create a new account credit it with the first amount provided in the request.
The creation consists:</p>
<div class="ulist">
<ul>
<li>
<p>to create an Account Object, then</p>
</li>
</ul>
</div>
</li>
<li>
<p>Get Balance: this operation invokes the bank to obtain the balance of an account.</p>
<div class="ulist">
<ul>
<li>
<p>the account is first returned by the bank, then</p>
</li>
<li>
<p>the account is asked to return its balance</p>
</li>
</ul>
</div>
</li>
<li>
<p>Withdraw: this operation is invoked to withdraw money from an account.
If the final balance is negative, the withdraw is refused and the associated transaction aborted</p>
</li>
<li>
<p>Credit: this operation is performed to credit an account</p>
</li>
<li>
<p>Transfer: This operation is used to transfer money from an account to another.
If the transfer leads to get a negative balance of the debited account, the transfer is refused and the associated transaction is aborted.</p>
</li>
<li>
<p>Exit: This operation terminates the client</p>
</li>
</ul>
</div>
</li>
<li>
<p>Waits for a response.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Bank Object</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creates Account Objects using name</p>
</li>
<li>
<p>Maintains the list of created Accounts</p>
</li>
<li>
<p>Returns, when asked, the Account Object requested by the client.
If the Account doesn&#8217;t exist an exception is returned to the client.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An Account Object</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Performs operations requested by the client</p>
<div class="ulist">
<ul>
<li>
<p>credit,</p>
</li>
<li>
<p>withdraw (debit), and</p>
</li>
<li>
<p>return the current balance.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each operation provided to the client leads to the creation of a transaction; therefore in order to commit or rollback changes made on an account, a resource is associated with the account to participate to the transaction commitment protocol.
According to the final transaction decision, the resource is able to set the Account either to its initial state (in case of rollback) or to the final state (in case of commit).
From the transactional view, Figure 2 depicts of transactional components.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-banking_application_2.PNG.png" alt="jts banking application 2.PNG">
</div>
<div class="title">Figure 29. The Banking Application and the transactional Component</div>
</div>
</div>
<div class="sect6">
<h7 id="_deploying_and_testing_the_banking_application"><a class="anchor" href="#_deploying_and_testing_the_banking_application"></a>Deploying and Testing The Banking Application</h7>
<div class="paragraph">
<p>Assuming that the Narayana product has been installed, this trail provides a set of examples that show how to build transactional applications.
Two types of transactional applications are presented, those using the JTA interface and those accessing to the JTS (OTS) interfaces.</p>
</div>
<div class="paragraph">
<p>Please follow these steps before running the transactional applications</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure you have the Ant build system installed.
Ant is a Java build tool, similar to make.
It is available for free from <a href="http://ant.apache.org/" class="bare">http://ant.apache.org/</a> The sample application requires version 1.5.1 or later.</p>
</li>
<li>
<p>The <code>PATH</code> and <code>CLASSPATH</code> environment variables need to be set appropriately to use Narayana.
To make this easier, we provide a shell script <code>setup_env.sh</code> (and for Windows a batch file <code>setup_env.bat</code>) in the directory <code>&lt;jbossts_install_root&gt;/bin/</code></p>
</li>
<li>
<p>From a command prompt, cd to the directory containing the <code>build.xml</code> file (<code>&lt;jbossts_install_root&gt;/trail_map</code>) and type 'ant', unless already done in the installation section.
This will compile a set of sources files located under <code>&lt;jbossts_install_root&gt;/trail_map/src</code> then create an application .jar file named <code>jbossts-demo.jar</code> under the directory <code>&lt;jbossts_install_root&gt;/trail_map/lib</code></p>
</li>
<li>
<p>Add the generated jar file to the <code>CLASSPATH</code> environment variable.</p>
</li>
<li>
<p>The demo application is provided in several ways, accessing persistent data or not.
When JDBC is used as a mean to access a database, Oracle 9i is used.
For this aim the appropriate Oracle libraries (<code>classes12.zip</code>) should be added in the <code>CLASSPATH</code> environment variable.</p>
</li>
</ul>
</div>
<div class="sect7">
<h8 id="_local_transaction_with_jta"><a class="anchor" href="#_local_transaction_with_jta"></a>Local transaction with JTA</h8>
<div class="paragraph">
<p>To configure Narayana for such transaction, edit the <code>jbossts-properties.xml</code> file and set the following properties to the appropriate values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.jta.jtaTMImplementation</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.jta.transaction.</span>
    <span class="content">arjunacore.TransactionManagerImple</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.jta.jtaUTImplementation</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.jta.transaction.</span>
    <span class="content">arjunacore.UserTransactionImple</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect7">
<h8 id="_distributed_transaction_with_jta"><a class="anchor" href="#_distributed_transaction_with_jta"></a>Distributed transaction with JTA</h8>
<div class="paragraph">
<p>While for a distributed transactions case, Narayana need to be configured as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.jta.jtaTMImplementation</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.jta.transaction.</span>
    <span class="content">jts.TransactionManagerImple</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.jta.jtaUTImplementation</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.jta.transaction.</span>
    <span class="content">jts.UserTransactionImple</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using JTA to create a distributed transaction need the creation of an ORB instance as done by a JTS application (see JTS versions of the banking application), the difference is in the interface used to demarcate and control transactions.</p>
</div>
</div>
<div class="sect7">
<h8 id="_the_application_programming_interfaces_used_by_the_banking_application"><a class="anchor" href="#_the_application_programming_interfaces_used_by_the_banking_application"></a>The application programming interfaces used by the Banking Application</h8>
<div class="paragraph">
<p>To illustrate the programming interfaces possibilities enabled by Narayana, the banking application is provided in several versions: a version that uses the JTA API and a second that uses JTS/OTS interfaces.</p>
</div>
<div class="paragraph">
<p>This trail focuses to understanding concepts related to the creation of transactions and the behavior of the commitment protocol, while the next trail illustrates the similar application with persistent data.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Testing the Banking application with JTA</p>
</li>
<li>
<p>Testing the Banking application with JTS</p>
</li>
</ul>
</div>
<div class="sect8">
<h9 id="_running_the_banking_application_with_jta"><a class="anchor" href="#_running_the_banking_application_with_jta"></a>Running The Banking application with JTA</h9>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Configuring Narayana</div>
<p>Program Applications that create transactions using the JTA interface may invoke as well local services as remote services.
When a remote invocation need to be performed, the current transactional context need to be propagated to the remote service in order to involve it to the transaction in progress.
Narayana allows the possibility to provide such feature using the facilities provided by JTS and ORB.
More precisely Narayana need to be configured to determine in which type of transaction, local or distributed, the JTA interface is used.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Executing the JTA sample</div>
<p>The Banking sample using JTA creates local transactions, ensure that JTA is configured for local transactions as explained above.</p>
</div>
<div class="paragraph">
<p>To launch the JTA version of the Banking application, which creates only local transactions, execute the following java program:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jta.localbank.BankClient</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once one of the program given above is launched the following lines are displayed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">-------------------------------------------------
  Bank client
-------------------------------------------------
Select an option :
   0. Quit
   1. Create a new account.
   2. Get an account information.
   3. Make a transfer.
   4. Credit an account.
   5. Withdraw from an account

Your choice :</code></pre>
</div>
</div>
<div class="paragraph">
<p>After introducing your choice, the appropriate operation is performed by the Bank object, to get the requested account, and by the account to execute the credit or withdraw or to return the current balance.
Let&#8217;s consider the following execution.</p>
</div>
<div class="paragraph">
<p>Enter the number 1 as your choice, then give the name "Foo" as the account name and "1000" as an initial value of the account to create.
You should get the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 1
- Create a new account -
------------------------
Name : Foo
Initial balance : 1000
Beginning a User transaction to create account
XA_START[]
Attempt to commit the account creation transaction
XA_END[]
XA_COMMIT (ONE_PHASE)[]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The line XA_START indicates that the AccountResource object that implements the XAResource interface and enlisted to participate in the account creation transaction, receives the indication from the Transaction Manager that the transaction has started.</p>
</li>
<li>
<p>The line XA_END indicates that the calling thread in which the AccountRessource object is associated shall be ended to enable the transaction completion as recommended by the X/Open specification.</p>
</li>
<li>
<p>Since only one AccountResource then only one XAResource is involved in the account creation transaction, the two phases needed to get a consensus in the 2PC protocol are not mandatory.
The one phase commit optimization, indicated by the "XA_COMMIT (ONE_PHASE)", is applied.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the same way create a second account with the name "Bar" and the initial balance set to 500.</p>
</div>
<div class="paragraph">
<p>As a choice now, enter "3" to make a transfer (300) from "Foo" to "Bar".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 3
- Make a transfer -
-------------------
Take money from : Foo
Put money to : Bar
Transfert amount : 300
Beginning a User transaction to get balance
XA_START[]
XA_START[]
XA_END[]
XA_PREPARE[]
XA_END[]
XA_PREPARE[]
XA_COMMIT[]
XA_COMMIT[]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Now two AccountResource objects, then two XAResource objects are enlisted with the transaction.
The displayed lines show that the two phases, prepare and commit, are applied.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any attempt to manipulate an account that it doesn&#8217;t exist leads to throw the NotExistingAccount exception and to rollback the transaction in progress.
For instance, let&#8217;s withdraw money from an account FooBar not previously created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 5
- Withdraw from an Account -
----------------------------
Give the Account name : FooBar
Amount to withdraw : 200
Beginning a User transaction to
withdraw from an account
The requested account does not exist!
ERROR - jakarta.transaction.RollbackException</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Building The Banking Application with JTA</div>
<p>From an architectural point of view of JTA, the bank client is considered as an application program able to manage transactions via the <code>jakarta.transaction.UserTransaction</code> interface.
The following portion of the code illustrates how a JTA transaction is started and terminated when the client asks to transfer money from one account to another.
This also describes what are Narayana packages that need to be used in order to obtain appropriate objects instances (such UserTransaction).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The code below is a simplified view of the BankClient.java program.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Only the transfer operation is illustrated; other operations manage transactions in the same way. (see for details the <code>src/com/arjuna/demo/jta/localbank/BankClient.java</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BankClient</span> {
    <span class="directive">private</span> Bank _bank;

    <span class="comment">// This operation is used to make a transfer</span>
    <span class="comment">//from an account to another account</span>
    <span class="directive">private</span> <span class="type">void</span> makeTransfer() {
        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Take money from : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> name_supplier = input();

        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Put money to : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> name_consumer = input();

        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Transfer amount : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> amount = input();

        <span class="type">float</span> famount = <span class="integer">0</span>;
        <span class="keyword">try</span> {
            famount = <span class="keyword">new</span> <span class="predefined-type">Float</span>(amount).floatValue();
        } <span class="keyword">catch</span> (java.lang.Exception ex) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Invalid float number, abort operation...</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">return</span>;
        }

        <span class="keyword">try</span> {
            <span class="comment">//the following instruction asks a specific {parentProduct}</span>
            <span class="comment">//class to obtain a UserTransaction instance</span>
            jakarta.transaction.UserTransaction userTran =
                    com.arjuna.ats.jta.UserTransaction.userTransaction();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Beginning a User transaction to get balance</span><span class="delimiter">&quot;</span></span>);
            userTran.begin();

            Account supplier = _bank.get_account(name_supplier);
            Account consumer = _bank.get_account(name_consumer);
            supplier.debit(famount);
            consumer.credit(famount);

            userTran.commit();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR - </span><span class="delimiter">&quot;</span></span> + e);
        }
    }
   ......
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Bank object has mainly two operations: creating an account, which is added in the account list, and returning an Account object.
No transactional instruction is performed by the Bank object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Bank</span> {
    <span class="directive">private</span> java.util.Hashtable _accounts;

    <span class="directive">public</span> Bank() {
        _accounts = <span class="keyword">new</span> java.util.Hashtable();
    }

    <span class="directive">public</span> Account create_account(<span class="predefined-type">String</span> name) {
        Account acc = <span class="keyword">new</span> Account(name);
        _accounts.put(name, acc);
        <span class="keyword">return</span> acc;
    }

    <span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name)
            <span class="directive">throws</span> NotExistingAccount {
        Account acc = (Account) _accounts.get(name);
        <span class="keyword">if</span> (acc == <span class="predefined-constant">null</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account requested does not exist</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> acc;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Account object provides mainly three methods balance, credit and withdraw.
However, in order to provide the transactional behaviour, rather than to modify the current account directly (according to credit or withdraw) this task is delegated to an AccountResource object that is able, according to the transaction outcome, to set the account value either to its initial state or its final state.</p>
</div>
<div class="paragraph">
<p>The AccountResource object is in fact an object that implements the javax.transaction.xa.XAResource, then able to participate to the transaction commitment.
For this aim, the Account object has to register or enlist the AccountResource object as a participant after having obtaining the reference of the <code>jakarta.transaction.Transaction</code> object via the <code>jakarta.transaction.TransactionManager</code> object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Account</span> {
    <span class="type">float</span> _balance;
    AccountResource accRes = <span class="predefined-constant">null</span>;

    <span class="directive">public</span> Account(<span class="predefined-type">String</span> name) {
        _name = name;
        _balance = <span class="integer">0</span>;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> getXAResource().balance();
        ;
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        getXAResource().credit(value);
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        getXAResource().debit(value);
    }

    <span class="directive">public</span> AccountResource getXAResource() {

        <span class="keyword">try</span> {
            jakarta.transaction.TransactionManager transactionManager =
                    com.arjuna.ats.jta.TransactionManager.transactionManager();
            jakarta.transaction.Transaction currentTrans =
                    transactionManager.getTransaction();

            <span class="keyword">if</span> (accRes == <span class="predefined-constant">null</span>) {
                currentTrans.enlistResource(
                        accRes = <span class="keyword">new</span> AccountResource(<span class="local-variable">this</span>, _name));
            }

            currentTrans.delistResource(accRes, <span class="predefined-type">XAResource</span>.TMSUCCESS);

        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR - </span><span class="delimiter">&quot;</span></span> + e);
        }
        <span class="keyword">return</span> accRes;
    }
   ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The AccountResource class that implements the javax.transaction.xa.XAResource interface provides similar methods as the Account class (credit, withdraw and balance) but also all methods specified by the javax.transaction.xa.XAResource.
The following portion of code describes how the methods prepare, commit and rollback are implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AccountResource</span> <span class="directive">implements</span> <span class="predefined-type">XAResource</span> {
    <span class="directive">public</span> AccountResource(Account account, <span class="predefined-type">String</span> name) {
        _name = name;
        _account = account;
        _initial_balance = account._balance;
        _current_balance = _initial_balance;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        _current_balance += value;
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        _current_balance -= value;
    }

    <span class="directive">public</span> <span class="type">void</span> commit(<span class="predefined-type">Xid</span> id, <span class="type">boolean</span> onePhase) <span class="directive">throws</span> <span class="exception">XAException</span> {
        <span class="comment">//The value of the associated Account object is modified</span>
        _account._balance = _current_balance;
    }

    <span class="directive">public</span> <span class="type">int</span> prepare(<span class="predefined-type">Xid</span> xid) <span class="directive">throws</span> <span class="exception">XAException</span> {
        <span class="keyword">if</span> (_initial_balance == _current_balance) <span class="comment">//account not modified</span>
            <span class="keyword">return</span> (XA_RDONLY);
        <span class="keyword">if</span> (_current_balance &lt; <span class="integer">0</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">XAException</span>(<span class="exception">XAException</span>.XA_RBINTEGRITY);
        <span class="comment">//If the integrity of the account is corrupted then vote rollback</span>
        <span class="keyword">return</span> (XA_OK); <span class="comment">//return OK</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">void</span> rollback(<span class="predefined-type">Xid</span> xid) <span class="directive">throws</span> <span class="exception">XAException</span> {
    <span class="comment">//Nothing is done</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">private</span> <span class="type">float</span> _initial_balance;
<span class="directive">private</span> <span class="type">float</span> _current_balance;
<span class="directive">private</span> Account _account;</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Sample Application Source Code</div>
<p>Full source code for the banking application with JTA is included to provide you with a starting point for experimentation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>src/com/arjuna/demo/jta/localbank/BankClient.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jta/localbank/Bank.java</code> &#8594; <code>Bank.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jta/localbank/Account.java</code> &#8594; <code>Account.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jta/localbank/AccountResource.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jta/localbank/NotExistingAccount.java</code> &#8594; <code>NotExistingAccount.java</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect7">
<h8 id="_running_the_banking_application_with_jts"><a class="anchor" href="#_running_the_banking_application_with_jts"></a>Running The Banking application with JTS</h8>
<div class="paragraph">
<p>The JTS version of the Banking application means that the Object Request Broker will be used.
The Narayana distribution is provided to work with the bundled JacORB version</p>
</div>
<div class="paragraph">
<p>To describe the possibilities provided by Narayana to build a transactional application according to the programming models defined by the OTS specification, the Banking Application is programmed in different ways.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Local transactions: The Bank Client and the Bank server are collocated in the same process.</p>
</li>
<li>
<p>Distributed Transactions: The Bank Client and the Bank Server and located on different process.
To participate within a client&#8217;s transaction, Account Objects needed to access the transactional context.
We describe the two of context propagation.</p>
<div class="ulist">
<ul>
<li>
<p>implicit context propagation, and</p>
</li>
<li>
<p>explicit context propagation.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>JTS Local Transactions&gt;</p>
</div>
<div class="paragraph">
<p>JTS Distributed Transactions</p>
</div>
<div class="sect8">
<h9 id="_running_the_banking_application_with_jts_2"><a class="anchor" href="#_running_the_banking_application_with_jts_2"></a>Running The Banking application with JTS</h9>
<div class="paragraph">
<p>The JTS version of the Banking application means that the Object Request Broker will be used.
The Narayana distribution is provided to work with the bundled JacORB version</p>
</div>
<div class="paragraph">
<p><em>Note</em> : Ensure that the jacorb jar files are added in your <code>CLASSPATH</code></p>
</div>
<div class="paragraph">
<p>To launch the JTS version of the Banking application, execute the following java program</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.localbank.BankClient</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once one of the program given above is launched the following lines are displayed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">-------------------------------------------------
   Bank client
-------------------------------------------------
Select an option :
   0. Quit
   1. Create a new account.
   2. Get an account information.
   3. Make a transfer.
   4. Credit an account.
   5. Withdraw from an account

Your choice :</code></pre>
</div>
</div>
<div class="paragraph">
<p>After introducing your choice, the appropriate operation is performed by the Bank object, to get the requested account, and by the account to execute the credit or withdraw or to return the current balance.
Let&#8217;s consider the following execution.</p>
</div>
<div class="paragraph">
<p>Enter the number 1 as your choice, then give the name "Foo" as the account name and "1000" as an initial value of the account to create.
You should get the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 1
- Create a new account -
------------------------
Name : Foo
Initial balance : 1000
Beginning a User transaction to create account
[ Connected to 192.168.0.2:4799 from local port 4924 ]
Attempt to commit the account creation transaction
/[ Resource for Foo : Commit one phase ]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Since only one AccountResource then only one CosTransaction.Resource is involved in the account creation transaction, the two phases needed to get a consensus in the 2PC protocol are not mandatory.
The one phase commit optimisation, indicated by the "Commit one phase", is applied.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the same way create a second account with the name "Bar" and the initial balance set to 500.</p>
</div>
<div class="paragraph">
<p>As a choice now, enter "3" to make a transfer (300) from "Foo" to "Bar".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 3
- Make a transfer -
-------------------

Take money from : Foo
Put money to : Bar
Transfer amount : 300
Beginning a User transaction to Transfer money
[ Resource for Foo : Prepare ]
[ Resource for Bar : Prepare ]
[ Resource for Foo : Commit ]
[ Resource for Bar : Commit ]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Now two AccountResource objects, then two CosTransactions.Resource objects are enlisted with the transaction.
The displayed lines show that the two phases, prepare and commit, are applied.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any attempt to manipulate an account that it doesn&#8217;t exist leads to throw the NotExistingAccount exception and to rollback the transaction in progress.
For instance, let&#8217;s withdraw money from an account FooBar not previously created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 5
- Withdraw from an Account -
----------------------------
Give the Account name : FooBar
Amount to withdraw : 200
Beginning a User transaction to withdraw from an account
The requested account does not exist!
ERROR - org.omg.CORBA.TRANSACTION_ROLLEDBACK:
minor code: 50001  completed: No</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Using a stand-alone Transaction Server</div>
<p>By default Narayana does not use a separate transaction manager server: transaction managers are co-located with each application process to improve performance and improve application fault-tolerance.
When running applications which require a separate transaction manager, you must set the com.arjuna.ats.jts.transactionManager property variable, in the <code>(jbossts_install_dir)/etc/jbossts-properties.xml</code> file, to YES.</p>
</div>
<div class="paragraph">
<p>In a separate window, the stand-alone Transaction Server is launched as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.jts.TransactionServer [-test]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The option <code>-test</code> allows to see the message "Ready" when the Transaction Server is started.</p>
</div>
<div class="paragraph">
<p>The Banking application presented above gives the same output.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Running The Banking application with JTS</div>
<p>The JTS version of the Banking application means that the Object Request Broker will be used.
The Narayana distribution is provided to work with the bundled JacORB version</p>
</div>
<div class="paragraph">
<p><em>Note</em> : Ensure that the jacorb jar files are added in your <code>CLASSPATH</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>In a separate window launch the Recovery Manager, as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager</code></pre>
</div>
</div>
</li>
<li>
<p>Testing the distributed transaction with <em>Implicit Propagation Context</em></p>
</li>
<li>
<p>Start the Server</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.remotebank.BankServer</code></pre>
</div>
</div>
</li>
<li>
<p>In a separate window, start the client</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.remotebank.BankClient</code></pre>
</div>
</div>
</li>
<li>
<p>Testing the distributed transaction with <em>Explicit Propagation Context</em></p>
</li>
<li>
<p>Start the Server</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.explicitremotebank.BankServer</code></pre>
</div>
</div>
</li>
<li>
<p>In a separate window, start the client</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.explicitremotebank.BankClient</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In both cases (implicit and explicit), the Bank Server, which can be stopped by hand, displays the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">The bank server is now ready...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In both cases (implicit and Explicit), the Bank Client window displays the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">-------------------------------------------------
Bank client
-------------------------------------------------
Select an option :
0. Quit
1. Create a new account.
2. Get an account information.
3. Make a transfer.
4. Credit an account.
5. Withdraw from an account

Your choice :</code></pre>
</div>
</div>
<div class="paragraph">
<p>After entering your choice, the appropriate operation is performed by the remote Bank object, to get the requested account, and by the account to execute the credit or withdraw or to return the current balance.
Let&#8217;s consider the following execution.</p>
</div>
<div class="paragraph">
<p>Enter the number 1 as your choice, then give the name "Foo" as the account name and "1000" as an initial value of the account to create.
You should get in the server window a result that terminates with the following line</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">[ Resource for Foo : Commit one phase ]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Since only one AccountResource then only one CosTransaction.Resource is involved in the account creation transaction, the two phases needed to get a consensus in the 2PC protocol are not mandatory.
The one phase commit optimisation, indicated by the "Commit one phase", is applied.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the same way create a second account with the name "Bar" and the initial balance set to 500.</p>
</div>
<div class="paragraph">
<p>As a choice now, enter in the client window "3" to make a transfer (300) from "Foo" to "Bar".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 3
- Make a transfer -
-------------------

Take money from : Foo
Put money to : Bar
Transfer amount : 300</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the Server window you should see a result with the following lines</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">[ Resource for Foo : Prepare ]
[ Resource for Bar : Prepare ]
[ Resource for Foo : Commit ]
[ Resource for Bar : Commit ]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Now two AccountResource objects, then two CosTransactions.Resource objects are enlisted with the transaction.
The displayed lines show that the two phases, prepare and commit, are applied.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any attempt to manipulate an account that it doesn&#8217;t exist leads to throw the NotExistingAccount exception and to rollback the transaction in progress.
For instance, let&#8217;s withdraw money from an account FooBar not previously created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Your choice : 5
- Withdraw from an Account -
----------------------------
Amount to withdraw : 200
Beginning a User transaction to withdraw from an account
The requested account does not exist!
ERROR - org.omg.CORBA.TRANSACTION_ROLLEDBACK:
minor code: 50001 completed: No</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Using a stand-alone Transaction Server</div>
<p>By default Narayana does not use a separate transaction manager server: transaction managers are co-located with each application process to improve performance and improve application fault-tolerance.
When running applications which require a separate transaction manager, you must set the com.arjuna.ats.jts.transactionManager property variable, in the <code>jbossts-properties.xml</code> file, to YES.</p>
</div>
<div class="paragraph">
<p>In a separate window, the stand-alone Transaction Server is launched as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.jts.TransactionServer [-test]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The option <code>-test</code> allows to see the message "Ready" when the Transaction Server is started.</p>
</div>
<div class="paragraph">
<p>The Banking application presented above gives the same output.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Running the example on several machines</div>
<p>It is possible to run the Narayana Transaction Service and recovery manager processes on a different machine and have clients access these centralized services in a hub-and-spoke style architecture.</p>
</div>
<div class="paragraph">
<p>All that must be done is to provide the clients with enough information to contact the transaction service (such as the ORB&#8217;s NameService).
However, configuring the ORB is beyond the remit of this trailmap and so we shall opt for a simpler mechanism whereby the transaction services IOR is shared by access to a common file.</p>
</div>
<div class="paragraph">
<p>This trailmap stage assumes that the transaction service has been appropriately installed and configured (the <code>setenv.[bat|sh]</code> script has been ran) onto two hosts (for the purpose of explanation we shall refer to these hosts as <code>host1</code> and <code>host2</code>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Start the recovery manager in one command prompt terminal</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager [-test]</code></pre>
</div>
</div>
</li>
<li>
<p>Start the transaction service in a second command prompt terminal</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.jts.TransactionServer [-test]</code></pre>
</div>
</div>
</li>
<li>
<p>Start the transaction service and recovery manager on <code>host1</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Open a command prompt on <code>host2</code> and copy the <code>CosServices.cfg</code> file from the <code>&lt;narayana-jts_install_root&gt;/etc</code> directory on <code>host1</code>.
For example, using the popular <code>scp</code> package, open a shell prompt and issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">scp user @ host1:&lt;ats_root&gt;/etc/CosServices.cfg &lt;host2_ats_root&gt;/etc/</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Share the transaction service IOR on <code>host1</code> with <code>host2</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>See the section above entitled "Using a stand-alone Transaction Server" for more information on how to configure these application to use a remote transaction service.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Testing the distributed transaction with Implicit Propagation Context</em></p>
<div class="ulist">
<ul>
<li>
<p>Start the Server</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.remotebank.BankServer</code></pre>
</div>
</div>
</li>
<li>
<p>In a separate window, start the client</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.remotebank.BankClient</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><em>Testing the distributed transaction with Explicit Propagation Context</em></p>
<div class="ulist">
<ul>
<li>
<p>Start the Server</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.explicitremotebank.BankServer</code></pre>
</div>
</div>
</li>
<li>
<p>In a separate window, start the client</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.explicitremotebank.BankClient</code></pre>
</div>
</div>
</li>
<li>
<p>Start the Bank Server and Bank Client applications on <code>host2</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">How the Banking Application is build using JTS interfaces</div>
<p>From an architectural point of view of JTS, the bank client is considered as an application program able to manage transactions either in a direct or indirect management mode, respectively with the interfaces org.omg.CosTransactions.TransactionFactory and org.omg.CosTransactions.Terminator or with the org.omg.CosTransactions.Current interface.
Transactions created by the client in the Banking application are done in the indirect mode.</p>
</div>
<div class="paragraph">
<p>The following portion of code illustrates how a JTS transaction is started and terminated when the client asks to transfer money from one account to another.
This also describes what are Narayana packages that need to be used in order to obtain appropriate objects instances (such Current).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The code below is a simplified view of the BankClient.java program.
Only the transfer operation is illustrated; other operations manage transactions in the same way.
(see <code>../src/com/arjuna/demo/jts/localbank/BankClient.java</code> for details)</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts.OTSManager</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.internal.jts.ORBManager</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BankClient</span> {
    <span class="directive">private</span> Bank _bank; <span class="comment">//Initialised on BankClient initializations</span>
   ....

    <span class="comment">// This operation is used to make a transfer from an account to another account</span>
    private <span class="type">void</span> makeTransfer() {
        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Take money from : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> name_supplier = input();

        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Put money to : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> name_consumer = input();

        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Transfert amount : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> amount = input();

        <span class="type">float</span> famount = <span class="integer">0</span>;
        <span class="keyword">try</span> {
            famount = <span class="keyword">new</span> <span class="predefined-type">Float</span>(amount).floatValue();
        } <span class="keyword">catch</span> (java.lang.Exception ex) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Invalid float number, abort operation...</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">return</span>;
        }

        <span class="keyword">try</span> {
            <span class="comment">//the following instruction asks a specific {parentProduct} class to obtain a Current instance</span>
            Current current = OTSManager.get_current();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Beginning a User transaction to get balance</span><span class="delimiter">&quot;</span></span>);
            current.begin();

            Account supplier = _bank.get_account(name_supplier);
            Account consumer = _bank.get_account(name_consumer);
            supplier.debit(famount);
            consumer.credit(famount);

            current.commit();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR - </span><span class="delimiter">&quot;</span></span> + e);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since JTS is used invocations against an ORB are needed, such ORB and Object Adapter instantiation and initialisation.
To ensure a better portability, the ORB Portability API provides a set of methods that can be used as described below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    <span class="keyword">try</span> {
        myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);<span class="comment">// Create an ORB instance</span>
        myOA = OA.getRootOA(myORB); <span class="comment">//Obtain the Root POA</span>
        myORB.initORB(args, <span class="predefined-constant">null</span>); <span class="comment">//Initialise the ORB</span>
        myOA.initOA(); <span class="comment">//Initialise the POA</span>

        <span class="comment">// The ORBManager is a class provided by {parentProduct} to facilitate the association</span>
        <span class="comment">// of the ORB/POA with the transaction service</span>
        ORBManager.setORB(myORB);
        ORBManager.setPOA(myOA);
     ....
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        e.printStackTrace(<span class="predefined-type">System</span>.err);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Bank object has mainly two operations: creating an account, which is added in the account list, and returning an Account object.
No transactional instruction is performed by the Bank object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Bank</span> {
    <span class="directive">private</span> java.util.Hashtable _accounts;

    <span class="directive">public</span> Bank()
    {
        _accounts = <span class="keyword">new</span> java.util.Hashtable();
    }

    <span class="directive">public</span> Account create_account( <span class="predefined-type">String</span> name )
    {
        Account acc = <span class="keyword">new</span> Account(name);
        _accounts.put( name, acc );
        <span class="keyword">return</span> acc;
    }

    <span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name)
            <span class="directive">throws</span> NotExistingAccount
    {
        Account acc = ( Account ) _accounts.get( name );
        <span class="keyword">if</span> ( acc == <span class="predefined-constant">null</span> )
            <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account requested does not exist</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> acc;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Account object provides mainly three methods balance, credit and withdraw.
However, in order to provide the transactional behaviour, rather than to modify the current account directly (according to credit or withdraw) this task is delegated to an AccountResource object that is able, according to the transaction outcome, to set the account value either to its initial state or its final state.</p>
</div>
<div class="paragraph">
<p>The AccountResource object is in fact an object that implements the org.omg.CosTransactions.Resource, then able to participate to the transaction commitment.
For this aim, the Account object has to register the AccountResource object as a participant, after having obtaining the reference of the org.omg.CosTransactions.Coordinator object , itself obtained via the org.omg.CosTransactions.Control object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Account</span> {
    <span class="type">float</span> _balance;
    AccountResource accRes = <span class="predefined-constant">null</span>;

    <span class="directive">public</span> Account(<span class="predefined-type">String</span> name) {
        _name = name;
        _balance = <span class="integer">0</span>;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> getResource().balance();
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        getResource().credit(value);
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        getResource().debit(value);
    }

    <span class="directive">public</span> AccountResource getResource() {
        <span class="keyword">try</span> {
            <span class="keyword">if</span> (accRes == <span class="predefined-constant">null</span>) {
                accRes = <span class="keyword">new</span> AccountResource(<span class="local-variable">this</span>, _name);
                Resource ref = org.omg.CosTransactions.ResourceHelper.narrow(ORBManager.getPOA().corbaReference(accRes));
                <span class="comment">// Note above the possibilities provided by the ORBManager to access the POA then to obtain</span>
                <span class="comment">// the CORBA reference of the created AccountResource object</span>

                RecoveryCoordinator recoverycoordinator = OTSManager.get_current().get_control().
                        get_coordinator().register_resource(ref);

            }
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR - </span><span class="delimiter">&quot;</span></span> + e);
        }

        <span class="keyword">return</span> accRes;
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To be considered as a org.omg.CosTransactions.Resource, the AccountResource class shall extends the class org.omg.CosTransactions.ResourcePOA generated by the CORBA IDL compiler.
The AccountRessource provides similar methods as the Account class (credit, withdraw and balance) with the appropriate methods to participate to the 2PC protocol.
The following portion of code describes how the methods prepare, commit and rollback are implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AccountResource</span> <span class="directive">extends</span> org.omg.CosTransactions.ResourcePOA {
    <span class="directive">public</span> AccountResource(Account account, <span class="predefined-type">String</span> name) {
        _name = name;
        _account = account;
        _initial_balance = account._balance;
        _current_balance = _initial_balance;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        _current_balance += value;
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        _current_balance -= value;
    }

    <span class="directive">public</span> org.omg.CosTransactions.Vote prepare()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicMixed, org.omg.CosTransactions.HeuristicHazard {
        <span class="keyword">if</span> (_initial_balance == _current_balance)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteReadOnly;
        <span class="keyword">if</span> (_current_balance &lt; <span class="integer">0</span>)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteRollback;
        <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteCommit;
    }

    <span class="directive">public</span> <span class="type">void</span> rollback()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicCommit, org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        <span class="comment">//Nothing to do</span>
    }

    <span class="directive">public</span> <span class="type">void</span> commit()
            <span class="directive">throws</span> org.omg.CosTransactions.NotPrepared, org.omg.CosTransactions.HeuristicRollback,
            org.omg.CosTransactions.HeuristicMixed, org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> commit_one_phase()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    .....

    private <span class="type">float</span> _initial_balance;
    <span class="directive">private</span> <span class="type">float</span> _current_balance;
    <span class="directive">private</span> Account _account;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Sample Application Source Code</div>
<p>Full source code for the banking application is included to provide you with a starting point for experimentation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JTS Version</p>
<div class="ulist">
<ul>
<li>
<p>src/com/arjuna/demo/jts/localbank/BankClient.java</p>
</li>
<li>
<p>src/com/arjuna/demo/jts/localbank/Bank.java"&gt;Bank.java</p>
</li>
<li>
<p>src/com/arjuna/demo/jts/localbank/Account.java"&gt;Account.java</p>
</li>
<li>
<p>src/com/arjuna/demo/jts/localbank/AccountResource.java</p>
</li>
<li>
<p>src/com/arjuna/demo/jts/localbank/NotExistingAccount.java"&gt;NotExistingAccount.java</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">How the Banking Application is build using JTS interfaces</div>
<p>The bank client is an application program able to manage transactions either in a direct or indirect management mode, respectively with the interfaces org.omg.CosTransactions.TransactionFactory and org.omg.CosTransactions.Terminator or with the org.omg.CosTransactions.Current interface.
Transactions created by the client in the Banking application are done in the indirect mode.</p>
</div>
<div class="paragraph">
<p>Invoking a remote object within a CORBA environment means that the remote object implements a CORBA interface defined in a CORBA idl file.
The following Bank.idl describes the interfaces then the possible kind of distributed CORBA objects involved in the banking application.
There is no any interface that inherits the CosTransactions::TransactionalObject interface, which means that for any remote invocations the transactional context is normally not propagated.
However, since the Account object may have to register Resource objects that participate to transaction completion, a context is needed.
In the following Bank.idl file operations defined in the Account interface have explicitly in their signature the CosTransactions::Control argument meaning that it passed explicitly by the caller - in this case the Bank Client program.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">module arjuna {
    module demo {
     module jts {
      module explicitremotebank {

        <span class="type">interface</span> <span class="class">Account</span> :
        {
          <span class="type">float</span> balance(in CosTransactions::<span class="predefined-type">Control</span> ctrl);
          <span class="type">void</span> credit( in CosTransactions::<span class="predefined-type">Control</span> ctrl, in <span class="type">float</span> value );
          <span class="type">void</span> debit( in CosTransactions::<span class="predefined-type">Control</span> ctrl, in <span class="type">float</span> value );
        };

        exception NotExistingAccount
        { };

        <span class="type">interface</span> <span class="class">Bank</span>
        {
          Account create_account( in string name );
          Account get_account( in string name )
            raises( NotExistingAccount );
        };
       };
      };
     };
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following portion of code illustrates how a JTS transaction is started and terminated when the client asks to transfer money from one account to another.
This also describes what are Narayana packages that need to be used in order to obtain appropriate objects instances (such Current).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The code below is a simplified view of the <code>BankClient.java</code> program.
Only the transfer operation is illustrated; other operations manage transactions in the same way.
(see for details the <code>src/com/arjuna/demo/jts/explicitremotebank/BankClient.java</code>)</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.remotebank</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts.OTSManager</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BankClient</span> {
    <span class="directive">private</span> Bank _bank;
    ....

    <span class="comment">// This operation is used to make a transfer</span>
    <span class="comment">//from an account to another account</span>
    private <span class="type">void</span> makeTransfer() {
        <span class="comment">//get the name of the supplier(name_supplier) and</span>
        <span class="comment">// the consumer(name_consumer)</span>
        <span class="comment">// get the amount to transfer (famount)</span>
        ...
        try {
            <span class="comment">//the following instruction asks a specific</span>
            <span class="comment">//{parentProduct} class to obtain a Current instance</span>
            Current current = OTSManager.get_current();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Beginning a User transaction to get balance</span><span class="delimiter">&quot;</span></span>);
            current.begin();

            Account supplier = _bank.get_account(name_supplier);
            Account consumer = _bank.get_account(name_consumer);
            supplier.debit(current.get_control(), famount);
            <span class="comment">//The Control is explicitly propagated</span>
            consumer.credit(current.get_control(), famount);
            current.commit();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            ...
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since JTS is used invocations against an ORB are needed, such ORB and Object Adapter instantiation and initialisation.
To ensure a better portability, the ORB Portability API provides a set of methods that can be used as described below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
  ....
    myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);<span class="comment">// Create an ORB instance</span>
    myORB.initORB(args, <span class="predefined-constant">null</span>); <span class="comment">//Initialise the ORB</span>

    org.omg.CORBA.Object obj = <span class="predefined-constant">null</span>;
    <span class="keyword">try</span> {
        <span class="comment">//Read the reference string from a file then convert to Object</span>
        ....
        obj = myORB.orb().string_to_object(stringTarget);
    } <span class="keyword">catch</span> (java.io.IOException ex) {
        ...
    }
    Bank bank = BankHelper.narrow(obj);
    ....
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Bank object has mainly two operations: creating an account, which is added in the account list, and returning an Account object.
No transactional instruction is performed by the Bank object.
The following lines decribe the implementation of the Bank CORBA object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BankImpl</span> <span class="directive">extends</span> BankPOA {
    <span class="directive">public</span> BankImpl(OA oa) {
        _accounts = <span class="keyword">new</span> java.util.Hashtable();
        _oa = oa;
    }

    <span class="directive">public</span> Account create_account(<span class="predefined-type">String</span> name) {
        AccountImpl acc = <span class="keyword">new</span> AccountImpl(name);
        _accounts.put(name, acc);
        <span class="keyword">return</span> com.arjuna.demo.jts.remotebank.AccountHelper.
                narrow(_oa.corbaReference(acc));
    }

    <span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name)
            <span class="directive">throws</span> NotExistingAccount {
        AccountImpl acc = (AccountImpl) _accounts.get(name);
        <span class="keyword">if</span> (acc == <span class="predefined-constant">null</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account requested does not exist</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> com.arjuna.demo.jts.remotebank.AccountHelper.
                narrow(_oa.corbaReference(acc));
    }

    <span class="directive">private</span> java.util.Hashtable _accounts;<span class="comment">// Accounts created by the Bank</span>
    <span class="directive">private</span> OA _oa;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After having defined an implementation of the Bank object, we should now create an instance and make it available for client requests.
This is the role of the Bank Server that has the responsibility to create the ORB and the Object Adapater instances, then the Bank CORBA object that has its object reference stored in a file well known by the bank client.
The following lines describe how the Bank server is implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BankServer</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        ORB myORB = <span class="predefined-constant">null</span>;
        RootOA myOA = <span class="predefined-constant">null</span>;
        <span class="keyword">try</span> {
            myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">ServerSide</span><span class="delimiter">&quot;</span></span>);
            myOA = OA.getRootOA(myORB);
            myORB.initORB(args, <span class="predefined-constant">null</span>);
            myOA.initOA();
            ....
            BankImpl bank = <span class="keyword">new</span> BankImpl(myOA);

            <span class="predefined-type">String</span> reference = myORB.orb().
                    object_to_string(myOA.corbaReference(bank));
            <span class="comment">//Store the Object reference in the file</span>
            ...

            System.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">The bank server is now ready...</span><span class="delimiter">&quot;</span></span>);
            myOA.run();
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Account object provides mainly three methods balance, credit and withdraw.
However, in order to provide the transactional behaviour, rather than to modify the current account directly (according to credit or withdraw) this task is delegated to an AccountResource object that is able, according to the transaction outcome, to set the account value either to its initial state or its final state.</p>
</div>
<div class="paragraph">
<p>The AccountResource object is in fact an object that implements the org.omg.CosTransactions.Resource, then able to participate to the transaction commitment.
For this aim, the Account object has to register the AccountResource object as a participant, after having obtaining the reference of the org.omg.CosTransactions.Coordinator object , itself obtained via the org.omg.CosTransactions.Control object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.remotebank</span>;

<span class="keyword">import</span> <span class="include">org.omg.CosTransactions</span>.*;
<span class="keyword">import</span> ....

<span class="include">public</span> <span class="include">class</span> <span class="include">AccountImpl</span> <span class="include">extends</span> <span class="include">AccountPOA</span> {
    <span class="include">float</span> <span class="include">_balance</span>;
    AccountResource accRes = <span class="predefined-constant">null</span>;

    <span class="directive">public</span> Account(<span class="predefined-type">String</span> name) {
        _name = name;
        _balance = <span class="integer">0</span>;
    }

    <span class="directive">public</span> <span class="type">float</span> balance(<span class="predefined-type">Control</span> ctrl) {
        <span class="keyword">return</span> getResource(ctrl).balance();
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="predefined-type">Control</span> ctrl, <span class="type">float</span> value) {
        getResource(ctrl).credit(value);
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="predefined-type">Control</span> ctrl, <span class="type">float</span> value) {
        getResource(ctrl).debit(value);
    }

    <span class="directive">public</span> AccountResource getResource(<span class="predefined-type">Control</span> control) {
        <span class="keyword">try</span> {
            <span class="keyword">if</span> (accRes == <span class="predefined-constant">null</span>) {
                accRes = <span class="keyword">new</span> AccountResource(<span class="local-variable">this</span>, _name);

                <span class="comment">//The invocation on the ORB illustrates the fact that the same</span>
                <span class="comment">//ORB instance created by the Bank Server is returned.</span>
                ref = org.omg.CosTransactions.ResourceHelper.
                        narrow(OA.getRootOA(ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">ServerSide</span><span class="delimiter">&quot;</span></span>)).
                                corbaReference(accRes));
                RecoveryCoordinator recoverycoordinator =
                        control.get_coordinator().register_resource(ref);
            }
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {...}
        <span class="keyword">return</span> accRes;
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To be considered as a org.omg.CosTransactions.Resource, the AccountResource class shall extends the class org.omg.CosTransactions.ResourcePOA generated by the CORBA IDL compiler.
The AccountRessource provides similar methods as the Account class (credit, withdraw and balance) with the appropriate methods to participate to the 2PC protocol.
The following portion of code describes how the methods prepare, commit and rollback are implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AccountResource</span> <span class="directive">extends</span> org.omg.CosTransactions.ResourcePOA {
    <span class="directive">public</span> AccountResource(Account account, <span class="predefined-type">String</span> name) {
        _name = name;
        _account = account;
        _initial_balance = account._balance;
        _current_balance = _initial_balance;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        _current_balance += value;
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        _current_balance -= value;
    }

    <span class="directive">public</span> org.omg.CosTransactions.Vote prepare()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        <span class="keyword">if</span> (_initial_balance == _current_balance)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteReadOnly;
        <span class="keyword">if</span> (_current_balance &lt; <span class="integer">0</span>)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteRollback;
        <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteCommit;
    }

    <span class="directive">public</span> <span class="type">void</span> rollback()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicCommit,
            org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
            <span class="comment">//Nothing to do</span>
    }

    <span class="directive">public</span> <span class="type">void</span> commit()
            <span class="directive">throws</span> org.omg.CosTransactions.NotPrepared,
            org.omg.CosTransactions.HeuristicRollback,
            org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> commit_one_phase()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    .....

    private <span class="type">float</span> _initial_balance;
    <span class="directive">private</span> <span class="type">float</span> _current_balance;
    <span class="directive">private</span> Account _account;

}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Sample Application Source Code</div>
<p>Full source code for the banking application is included to provide you with a starting point for experimentation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JTS Version</p>
<div class="ulist">
<ul>
<li>
<p><code>src/com/arjuna/demo/jts/explicitremotebank/Bank.idl</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/explicitremotebank/BankClient.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/explicitremotebank/BankServer.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/explicitremotebank/BankImpl.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/explicitremotebank/AccountImpl.java</code> &#8594; <code>AccountImpl.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/explicitremotebank/AccountResource.java</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">How the Banking Application is build using JTS interfaces</div>
<p>The bank client is an application program able to manage transactions either in a direct or indirect management mode, respectively with the interfaces org.omg.CosTransactions.TransactionFactory and org.omg.CosTransactions.Terminator or with the org.omg.CosTransactions.Current interface.
Transactions created by the client in the Banking application are done in the indirect mode.</p>
</div>
<div class="paragraph">
<p>Invoking a remote object within a CORBA environment means that the remote object implements a CORBA interface defined in a CORBA idl file.
The following Bank.idl describes the interfaces then the possible kind of distributed CORBA objects involved in the banking application.
Only the Account interface inherits the CosTransactions::TransactionalObject interface, this means that an Account CORBA object is expected to invoked within a scope of transaction and the transactional context is implicitly propagated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">module arjuna {
   module demo {
     module jts {
      module remotebank {

        <span class="type">interface</span> <span class="class">Account</span> : CosTransactions::TransactionalObject
        {
          <span class="type">float</span> balance();
          <span class="type">void</span> credit( in <span class="type">float</span> value );
          <span class="type">void</span> debit( in <span class="type">float</span> value );
        };

        exception NotExistingAccount
        { };

        <span class="type">interface</span> <span class="class">Bank</span>
        {
          Account create_account( in string name );
          Account get_account( in string name )
            raises( NotExistingAccount );
        };
       };
      };
     };
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following portion of code illustrates how a JTS transaction is started and terminated when the client asks to transfer money from one account to another.
This also describes what are Narayana packages that need to be used in order to obtain appropriate standard JTS API objects instances (such Current).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The code below is a simplified view of the <code>BankClient.java</code> program.
Only the transfer operation is illustrated; other operations manage transactions in the same way.
(see for details the <code>src/com/arjuna/demo/jts/localbank/BankClient.java</code>)</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.remotebank</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts.OTSManager</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BankClient</span> {
    <span class="directive">private</span> Bank _bank;
   ....

    <span class="comment">// This operation is used to make a transfer</span>
    <span class="comment">// from an account to another account</span>
    private <span class="type">void</span> makeTransfer() {
        <span class="comment">//get the name of the supplier(name_supplier)</span>
        <span class="comment">// and the consumer(name_consumer)</span>
        <span class="comment">// get the amount to transfer (famount)</span>
        ...

        try {
            <span class="comment">//the following instruction asks a</span>
            <span class="comment">// specific {parentProduct} class</span>
            <span class="comment">// to obtain a Current instance</span>
            Current current = OTSManager.get_current();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Beginning a User
                    transaction to get balance</span><span class="delimiter">&quot;</span></span>);
                    current.begin();

            Account supplier = _bank.get_account(name_supplier);
            Account consumer = _bank.get_account(name_consumer);
            supplier.debit(famount);
            consumer.credit(famount);

            current.commit();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            ...
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since JTS is used invocations against an ORB are needed, such ORB and Object Adapter instantiation and initialisation.
To ensure a better portability, the ORB Portability API provides a set of methods that can be used as described below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    ....
    myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);
    myORB.initORB(args, <span class="predefined-constant">null</span>); <span class="comment">//Initialise the ORB</span>

    org.omg.CORBA.Object obj = <span class="predefined-constant">null</span>;
    <span class="keyword">try</span> {
        <span class="comment">//Read the reference string from</span>
        <span class="comment">// a file then convert to Object</span>
        ....
        obj = myORB.orb().string_to_object(stringTarget);
    } <span class="keyword">catch</span> (java.io.IOException ex) {
       ...
    }
    Bank bank = BankHelper.narrow(obj);
    ....
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Bank object has mainly two operations: creating an account, which is added in the account list, and returning an Account object.
No transactional instruction is performed by the Bank object.
The following lines decribe the implementation of the Bank CORBA object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BankImpl</span> <span class="directive">extends</span> BankPOA {
    <span class="directive">public</span> BankImpl(OA oa) {
        _accounts = <span class="keyword">new</span> java.util.Hashtable();
        _oa = oa;
    }

    <span class="directive">public</span> Account create_account(<span class="predefined-type">String</span> name) {
        AccountImpl acc = <span class="keyword">new</span> AccountImpl(name);
        _accounts.put(name, acc);
        <span class="keyword">return</span> com.arjuna.demo.jts.remotebank.AccountHelper.
                narrow(_oa.corbaReference(acc));
    }

    <span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name)
            <span class="directive">throws</span> NotExistingAccount {
        AccountImpl acc = (AccountImpl) _accounts.get(name);
        <span class="keyword">if</span> (acc == <span class="predefined-constant">null</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account requested
                    does not exist</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> com.arjuna.demo.jts.remotebank.AccountHelper.
                narrow(_oa.corbaReference(acc));
    }

    <span class="directive">private</span> java.util.Hashtable _accounts;
    <span class="comment">// Accounts created by the Bank</span>
    <span class="directive">private</span> OA _oa;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After having defined an implementation of the Bank object, we should now create an instance and make it available for client requests.
This is the role of the Bank Server that has the responsibility to create the ORB and the Object Adapater instances, then the Bank CORBA object that has its object reference stored in a file well known by the bank client.
The following lines describe how the Bank server is implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BankServer</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        ORB myORB = <span class="predefined-constant">null</span>;
        RootOA myOA = <span class="predefined-constant">null</span>;
        <span class="keyword">try</span> {
            myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">ServerSide</span><span class="delimiter">&quot;</span></span>);
            myOA = OA.getRootOA(myORB);
            myORB.initORB(args, <span class="predefined-constant">null</span>);
            myOA.initOA();
            ....
            BankImpl bank = <span class="keyword">new</span> BankImpl(myOA);

            <span class="predefined-type">String</span> reference = myORB.orb().
                    object_to_string(myOA.corbaReference(bank));
            <span class="comment">//Store the Object reference in the file</span>
            ...
            System.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">The bank server is now ready...</span><span class="delimiter">&quot;</span></span>);
            myOA.run();
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Account object provides mainly three methods balance, credit and withdraw.
However, in order to provide the transactional behaviour, rather than to modify the current account directly (according to credit or withdraw) this task is delegated to an AccountResource object that is able, according to the transaction outcome, to set the account value either to its initial state or its final state.</p>
</div>
<div class="paragraph">
<p>The AccountResource object is in fact an object that implements the org.omg.CosTransactions.Resource, then able to participate to the transaction commitment.
For this aim, the Account object has to register the AccountResource object as a participant, after having obtaining the reference of the org.omg.CosTransactions.Coordinator object , itself obtained via the org.omg.CosTransactions.Control object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.remotebank</span>;
<span class="keyword">import</span> ....

<span class="include">public</span> <span class="include">class</span> <span class="include">AccountImpl</span> <span class="include">extends</span> <span class="include">AccountPOA</span> {
    <span class="include">float</span> <span class="include">_balance</span>;
    AccountResource accRes = <span class="predefined-constant">null</span>;

    <span class="directive">public</span> Account(<span class="predefined-type">String</span> name) {
        _name = name;
        _balance = <span class="integer">0</span>;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> getResource().balance();
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        getResource().credit(value);
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        getResource().debit(value);
    }

    <span class="directive">public</span> AccountResource getResource() {
        <span class="keyword">try</span> {
            <span class="keyword">if</span> (accRes == <span class="predefined-constant">null</span>) {
                accRes = <span class="keyword">new</span> AccountResource(<span class="local-variable">this</span>, _name);
                <span class="comment">//The invocation on the ORB illustrates the</span>
                <span class="comment">// fact that the same ORB instance created</span>
                <span class="comment">// by the Bank Server is returned.</span>
                ref = org.omg.CosTransactions.ResourceHelper.
                        narrow(OA.getRootOA(ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">ServerSide</span><span class="delimiter">&quot;</span></span>)).
                                corbaReference(accRes));
                RecoveryCoordinator recoverycoordinator = OTSManager.get_current().
                        get_control().get_coordinator().register_resource(ref);

            }
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {....}
        <span class="keyword">return</span> accRes;
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To be considered as a org.omg.CosTransactions.Resource, the AccountResource class shall extends the class org.omg.CosTransactions.ResourcePOA generated by the CORBA IDL compiler.
The AccountResource provides similar methods as the Account class (credit, withdraw and balance) with the appropriate methods to participate to the 2PC protocol.
The following portion of code describes how the methods prepare, commit and rollback are implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AccountResource</span>
        <span class="directive">extends</span> org.omg.CosTransactions.ResourcePOA {
    <span class="directive">public</span> AccountResource(Account account, <span class="predefined-type">String</span> name) {
        _name = name;
        _account = account;
        _initial_balance = account._balance;
        _current_balance = _initial_balance;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        _current_balance += value;
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        _current_balance -= value;
    }

    <span class="directive">public</span> org.omg.CosTransactions.Vote prepare()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        <span class="keyword">if</span> (_initial_balance == _current_balance)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteReadOnly;
        <span class="keyword">if</span> (_current_balance &lt; <span class="integer">0</span>)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteRollback;
        <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteCommit;
    }

    <span class="directive">public</span> <span class="type">void</span> rollback()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicCommit,
            org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        <span class="comment">//Nothing to do</span>
    }

    <span class="directive">public</span> <span class="type">void</span> commit()
            <span class="directive">throws</span> org.omg.CosTransactions.NotPrepared,
            org.omg.CosTransactions.HeuristicRollback,
            org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> commit_one_phase()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    ....
    private <span class="type">float</span> _initial_balance;
    <span class="directive">private</span> <span class="type">float</span> _current_balance;
    <span class="directive">private</span> <span class="directive">final</span> Account _account;

}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Sample Application Source Code</div>
<p>Full source code for the banking application is included to provide you with a starting point for experimentation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JTS Version</p>
<div class="ulist">
<ul>
<li>
<p><code>src/com/arjuna/demo/jts/remotebank/Bank.idl"&gt;Bank.idl</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/remotebank/BankClient.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/remotebank/BankServer.java</code> &#8594; <code>BankServer.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/remotebank/BankImpl.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/remotebank/AccountImpl.java</code> &#8594; <code>AccountImpl.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/remotebank/AccountResource.java</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">How the Banking Application is build using JTS interfaces</div>
<p>From an architectural point of view of JTS, the bank client is considered as an application program able to manage transactions either in a direct or indirect management mode, respectively with the interfaces org.omg.CosTransactions.TransactionFactory and org.omg.CosTransactions.Terminator or with the org.omg.CosTransactions.Current interface.
Transactions created by the client in the Banking application are done in the indirect mode.</p>
</div>
<div class="paragraph">
<p>The following portion of code illustrates how a JTS transaction is started and terminated when the client asks to transfer money from one account to another.
This also describes what are Narayana packages that need to be used in order to obtain appropriate objects instances (such Current).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The code below is a simplified view of the <code>BankClient.java</code> program.
Only the transfer operation is illustrated; other operations manage transactions in the same way.
(see for details the <code>src/com/arjuna/demo/jts/localbank/BankClient.java</code>)</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jts.OTSManager</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BankClient</span> {
    <span class="directive">private</span> Bank _bank;
    ....

    <span class="comment">// This operation is used to make</span>
    <span class="comment">//a transfer from an account to another account</span>
    private <span class="type">void</span> makeTransfer() {
        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Take money from : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> name_supplier = input();

        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Put money to : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> name_consumer = input();

        <span class="predefined-type">System</span>.out.print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Transfert amount : </span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> amount = input();

        <span class="type">float</span> famount = <span class="integer">0</span>;
        <span class="keyword">try</span> {
            famount = <span class="predefined-type">Float</span>.parseFloat(amount);
        } <span class="keyword">catch</span> (java.lang.Exception ex) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Invalid float number,
                    abort operation...</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">return</span>;
        }

        <span class="keyword">try</span> {
            <span class="comment">//the following instruction asks a specific</span>
            <span class="comment">// {parentProduct} class to obtain a Current instance</span>
            Current current = OTSManager.get_current();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Beginning a User
                    transaction to get balance</span><span class="delimiter">&quot;</span></span>);
                    current.begin();

            Account supplier = _bank.get_account(name_supplier);
            Account consumer = _bank.get_account(name_consumer);
            supplier.debit(famount);
            consumer.credit(famount);

            current.commit();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR - </span><span class="delimiter">&quot;</span></span> + e);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since JTS is used invocations against an ORB are needed, such ORB and Object Adapter instantiation and initialisation.
To ensure a better portability, the ORB Portability API provides a set of methods that can be used as described below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    <span class="keyword">try</span> {
        <span class="comment">// Create an ORB instance</span>
        myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);
        <span class="comment">//Obtain the Root POA</span>
        myOA = OA.getRootOA(myORB);
        <span class="comment">//Initialise the ORB</span>
        myORB.initORB(args, <span class="predefined-constant">null</span>);
        <span class="comment">//Initialise the POA</span>
        myOA.initOA();
        ....

    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) { ....}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Bank object has mainly two operations: creating an account, which is added in the account list, and returning an Account object.
No transactional instruction is performed by the Bank object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Bank</span> {
    <span class="directive">private</span> <span class="directive">final</span> java.util.Hashtable _accounts;

    <span class="directive">public</span> Bank() {
        _accounts = <span class="keyword">new</span> java.util.Hashtable();
    }

    <span class="directive">public</span> Account create_account(<span class="predefined-type">String</span> name) {
        Account acc = <span class="keyword">new</span> Account(name);
        _accounts.put(name, acc);
        <span class="keyword">return</span> acc;
    }

    <span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name)
            <span class="directive">throws</span> NotExistingAccount {
        Account acc = (Account) _accounts.get(name);
        <span class="keyword">if</span> (acc == <span class="predefined-constant">null</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account
                    requested does not exist</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> acc;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Account object provides mainly three methods balance, credit and withdraw.
However, in order to provide the transactional behaviour, rather than to modify the current account directly (according to credit or withdraw) this task is delegated to an AccountResource object that is able, according to the transaction outcome, to set the account value either to its initial state or its final state.</p>
</div>
<div class="paragraph">
<p>The AccountResource object is in fact an object that implements the org.omg.CosTransactions.Resource, then able to participate to the transaction commitment.
For this aim, the Account object has to register the AccountResource object as a participant, after having obtaining the reference of the org.omg.CosTransactions.Coordinator object , itself obtained via the org.omg.CosTransactions.Control object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.localbank</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Account</span> {
    <span class="type">float</span> _balance;
    AccountResource accRes = <span class="predefined-constant">null</span>;

    <span class="directive">public</span> Account(<span class="predefined-type">String</span> name) {
        _name = name;
        _balance = <span class="integer">0</span>;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> getResource().balance();
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        getResource().credit(value);
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        getResource().debit(value);
    }

    <span class="directive">public</span> AccountResource getResource() {
        <span class="keyword">try</span> {
            <span class="keyword">if</span> (accRes == <span class="predefined-constant">null</span>) {
                accRes = <span class="keyword">new</span> AccountResource(<span class="local-variable">this</span>, _name);
                Resource ref = org.omg.CosTransactions.ResourceHelper.
                        narrow(OA.getRootOA(ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>)).corbaReference(accRes));
                RecoveryCoordinator recoverycoordinator = OTSManager.get_current().
                        get_control().get_coordinator().register_resource(ref);
            }
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {...}
        <span class="keyword">return</span> accRes;
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To be considered as a org.omg.CosTransactions.Resource, the AccountResource class shall extends the class org.omg.CosTransactions.ResourcePOA generated by the CORBA IDL compiler.
The AccountRessource provides similar methods as the Account class (credit, withdraw and balance) with the appropriate methods to participate to the 2PC protocol.
The following portion of code describes how the methods prepare, commit and rollback are implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AccountResource</span> <span class="directive">extends</span> org.omg.CosTransactions.ResourcePOA {
    <span class="directive">public</span> AccountResource(Account account, <span class="predefined-type">String</span> name) {
        _name = name;
        _account = account;
        _initial_balance = account._balance;
        _current_balance = _initial_balance;
    }

    <span class="directive">public</span> <span class="type">float</span> balance() {
        <span class="keyword">return</span> _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
        _current_balance += value;
    }

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
        _current_balance -= value;
    }

    <span class="directive">public</span> org.omg.CosTransactions.Vote prepare()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        <span class="keyword">if</span> (_initial_balance == _current_balance)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteReadOnly;
        <span class="keyword">if</span> (_current_balance &lt; <span class="integer">0</span>)
            <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteRollback;
        <span class="keyword">return</span> org.omg.CosTransactions.Vote.VoteCommit;
    }

    <span class="directive">public</span> <span class="type">void</span> rollback()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicCommit,
            org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        <span class="comment">//Nothing to do</span>
    }

    <span class="directive">public</span> <span class="type">void</span> commit()
            <span class="directive">throws</span> org.omg.CosTransactions.NotPrepared,
            org.omg.CosTransactions.HeuristicRollback,
            org.omg.CosTransactions.HeuristicMixed,
            org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }

    <span class="directive">public</span> <span class="type">void</span> commit_one_phase()
            <span class="directive">throws</span> org.omg.CosTransactions.HeuristicHazard {
        _account._balance = _current_balance;
    }
    .....
    private <span class="directive">final</span> <span class="type">float</span> _initial_balance;
    <span class="directive">private</span> <span class="type">float</span> _current_balance;
    <span class="directive">private</span> <span class="directive">final</span> Account _account;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Sample Application Source Code</div>
<p>Full source code for the banking application is included to provide you with a starting point for experimentation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JTS Version</p>
<div class="ulist">
<ul>
<li>
<p><code>src/com/arjuna/demo/jts/localbank/BankClient.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/localbank/Bank.java</code> &#8594; <code>Bank.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/localbank/Account.java</code> &#8594; <code>Account.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/localbank/AccountResource.java</code></p>
</li>
<li>
<p><code>src/com/arjuna/demo/jts/localbank/NotExistingAccount.java</code> &#8594; <code>NotExistingAccount.java</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_making_the_banking_application_persistent"><a class="anchor" href="#_making_the_banking_application_persistent"></a>Making the Banking Application Persistent</h6>
<div class="paragraph">
<p>The way the banking application is built and deployed in the previous trail does not it make it persistent, in such way that any created account can be retrieved later after stopping the bank server or if the application crashes; moreover, it does not allow concurrent access to accounts without leading to inconsistent values.</p>
</div>
<div class="paragraph">
<p>Two ways will be presented in this trail on the way to build the banking application as a persistent and sharable application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using the Narayana Object For Java (TXOJ) mechanisms</p>
<div class="ulist">
<ul>
<li>
<p>Overview of the Transactional Object For Java</p>
</li>
<li>
<p>Deploying the Banking application with TXOJ mechanisms</p>
</li>
</ul>
</div>
</li>
<li>
<p>Using the JDBC API by considering the banking application as a relational database.</p>
<div class="ulist">
<ul>
<li>
<p>Developing applications with JDBC and Narayana</p>
</li>
<li>
<p>The banking application as a relational database accessed with JDBC</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_what_is_transactional_object_for_java"><a class="anchor" href="#_what_is_transactional_object_for_java"></a>What is Transactional Object For Java</h6>
<div class="paragraph">
<p>ArjunaCore exploits object-oriented techniques to present programmers with a toolkit of Java classes from which application classes can inherit to obtain desired properties, such as persistence and concurrency control.
These classes form a hierarchy, part of which is shown below.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-ArjunaCore_Classes.PNG.png" alt="jts ArjunaCore Classes.PNG">
</div>
<div class="title">Figure 30. ArjunaCore class hierarchy</div>
</div>
<div class="paragraph">
<p>Apart from specifying the scopes of transactions, and setting appropriate locks within objects, the application programmer does not have any other responsibilities: ArjunaCore and Transactional Objects for Java (TXOJ) guarantee that transactional objects will be registered with, and be driven by, the appropriate transactions, and crash recovery mechanisms are invoked automatically in the event of failures.</p>
</div>
<div class="sect6">
<h7 id="_recovery_and_persistency"><a class="anchor" href="#_recovery_and_persistency"></a>Recovery and Persistency</h7>
<div class="paragraph">
<p>Making an object persistent and recoverable means that we shall be able to store its final state or to retrieve its initial state according to the final status of a transaction even in the presence of failures.
ArjunaCore provides a set of techniques to save to and to retrieve from the Object Store states of objects.
All objects made persistent with these ArjunaCore mechanisms are assigned unique identifiers (instances of the Uid class), when they are created, and this is to identify them within the object store.
Due to common functionality for persistency and recovery required by several applications, objects are stored and retrieved from the object store using the same mechanism: the classes OutputObjectState and InputObjecState.</p>
</div>
<div class="paragraph">
<p>At the root of the class hierarchy, given in Figure 1, is the class StateManager.
This class is responsible for object activation and deactivation and object recovery.
The simplified signature of the class is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">StateManager</span> {
    <span class="directive">public</span> <span class="type">boolean</span> activate();

    <span class="directive">public</span> <span class="type">boolean</span> deactivate(<span class="type">boolean</span> commit);

    <span class="directive">public</span> Uid get_uid(); <span class="comment">// object’s identifier.</span>

    <span class="comment">// methods to be provided by a derived class</span>
    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os);

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os);

    <span class="directive">protected</span> StateManager();

    <span class="directive">protected</span> StateManager(Uid id);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Objects are assumed to be of three possible flavours.
They may simply be recoverable, in which case StateManager will attempt to generate and maintain appropriate recovery information for the object.
Such objects have lifetimes that do not exceed the application program that creates them.
Objects may be recoverable and persistent, in which case the lifetime of the object is assumed to be greater than that of the creating or accessing application, so that in addition to maintaining recovery information StateManager will attempt to automatically load (unload) any existing persistent state for the object by calling the activate (deactivate) operation at appropriate times.
Finally, objects may possess none of these capabilities, in which case no recovery information is ever kept nor is object activation/deactivation ever automatically attempted.</p>
</div>
<div class="paragraph">
<p>According to the its activation or deactivation a transactional object for Java move from a passive state to an active state and vice-versa.
The fundamental life cycle of a persistent object in TXOJ is shown in Figure 2.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/jts-txoj_lifecycle.PNG.png" alt="jts txoj lifecycle.PNG">
</div>
<div class="title">Figure 31. The life cycle of a persistent object.</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The object is initially passive, and is stored in the object store as an instance of the class OutputObjectState.</p>
</li>
<li>
<p>When required by an application the object is automatically activated by reading it from the store using a read_committed operation and is then converted from an InputObjectState instance into a fully-fledged object by the restore_state operation of the object.</p>
</li>
<li>
<p>When the application has finished with the object it is deactivated by converting it back into an OutputObjectState instance using the save_state operation, and is then stored back into the object store as a shadow copy using write_uncommitted.
This shadow copy can be committed, overwriting the previous version, using the commit_state operation.
The existence of shadow copies is normally hidden from the programmer by the transaction system.
Object de-activation normally only occurs when the top-level transaction within which the object was activated commits.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While deactivating and activating a transactional object for java, the operations save_state and restore_state are respectively invoked.
These operations must be implemented by the programmer since StateManager cannot detect user level state changes.
This gives the programmer the ability to decide which parts of an object&#8217;s state should be made persistent.
For example, for a spreadsheet it may not be necessary to save all entries if some values can simply be recomputed.
The save_state implementation for a class Example that has two integer member variables called A and B and one String member variable called C could simply be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState o) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.save_state(o))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    <span class="keyword">try</span> {
        o.packInt(A);
        o.packInt(B);
        o.packString(C))
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>while, the corresponding restore_state implementation allowing to retrieve similar values is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState o) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.restore_state(o))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    <span class="keyword">try</span> {
        A = o.unpackInt();
        B = o.unpackInt();
        S = o.unpackString())
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Classes OutputObjectState and InputObjectState provide respectively operations to pack and unpack instances of standard Java data types.
In other words for a standard Java data type, for instance Long or Short, there are corresponding methods to pack and unpack, i.e., packLong or packShort and unpackLong or unpackShort.</p>
</div>
<div class="paragraph">
<p><em>Note:</em> it is necessary for all save_state and restore_state methods to call super.save_state and super.restore_state.
This is to cater for improvements in the crash recovery mechanisms.</p>
</div>
</div>
<div class="sect6">
<h7 id="_the_concurrency_controller_2"><a class="anchor" href="#_the_concurrency_controller_2"></a>The concurrency controller</h7>
<div class="paragraph">
<p>The concurrency controller is implemented by the class LockManager which provides sensible default behaviour while allowing the programmer to override it if deemed necessary by the particular semantics of the class being programmed.
The primary programmer interface to the concurrency controller is via the setlock operation.
By default, the runtime system enforces strict two-phase locking following a multiple reader, single writer policy on a per object basis.
However, as shown in Figure 1, by inheriting from the Lock class it is possible for programmers to provide their own lock implementations with different lock conflict rules to enable type specific concurrency control.</p>
</div>
<div class="paragraph">
<p>Lock acquisition is (of necessity) under programmer control, since just as StateManager cannot determine if an operation modifies an object, LockManager cannot determine if an operation requires a read or write lock.
Lock release, however, is under control of the system and requires no further intervention by the programmer.
This ensures that the two-phase property can be correctly maintained.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">LockManager</span> <span class="directive">extends</span> StateManager {
   <span class="directive">public</span> LockResult setlock (<span class="predefined-type">Lock</span> toSet, <span class="type">int</span> retry, <span class="type">int</span> timeout);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The LockManager class is primarily responsible for managing requests to set a lock on an object or to release a lock as appropriate.
However, since it is derived from StateManager, it can also control when some of the inherited facilities are invoked.
For example, LockManager assumes that the setting of a write lock implies that the invoking operation must be about to modify the object.
This may in turn cause recovery information to be saved if the object is recoverable.
In a similar fashion, successful lock acquisition causes activate to be invoked.</p>
</div>
<div class="paragraph">
<p>The code below shows how we may try to obtain a write lock on an object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Example</span> <span class="directive">extends</span> LockManager {
    <span class="directive">public</span> <span class="type">boolean</span> foobar() {
        AtomicAction A = <span class="keyword">new</span> AtomicAction;
        <span class="comment">/*
         * The ArjunaCore AtomicAction class is here used to create
         * a transaction. Any interface provided by the JTA or
         * JTS interfaces that allow to create transactions can
         * be used in association with the Locking mechanisms
         * described in this trail.
         */</span>
        <span class="type">boolean</span> result = <span class="predefined-constant">false</span>;

        A.begin();
        <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.WRITE), <span class="integer">0</span>) == <span class="predefined-type">Lock</span>.GRANTED) {
            <span class="comment">/*
             * Do some work, and TXOJ will
             * guarantee ACID properties.
             */</span>
            <span class="comment">// automatically aborts if fails</span>
            <span class="keyword">if</span> (A.commit() == AtomicAction.COMMITTED) {
                result = <span class="predefined-constant">true</span>;
            }
        } <span class="keyword">else</span>
            A.rollback();

        <span class="keyword">return</span> result;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_further_reading_2"><a class="anchor" href="#_further_reading_2"></a>Further Reading</h7>
<div class="paragraph">
<p>More details on Transactional Object For Java can be found in the ArjunaCore Programming Guide.</p>
</div>
</div>
<div class="sect6">
<h7 id="_making_the_banking_application_persistent_with_transactional_object_for_java"><a class="anchor" href="#_making_the_banking_application_persistent_with_transactional_object_for_java"></a>Making the Banking Application Persistent with Transactional Object For Java</h7>
<div class="paragraph">
<p>The banking application consists of a Bank object that contains a list of Account object, which in turn have a String (name) and a float (the value) as member variables.
It appears clearly that from the persistent point of view, an Account Object need to store its name and its current balance or value, while the Bank Object need to store the list of accounts that it manages.</p>
</div>
<div class="sect7">
<h8 id="_distributed_configuration"><a class="anchor" href="#_distributed_configuration"></a>Distributed Configuration</h8>
<div class="paragraph">
<p>The banking application with Transactional Object for Java (TXOJ) is configured to use JTS interfaces as the API to create the transaction, then an ORB to deploy it.
The Narayana distribution is provided to work with the bundled JacORB version</p>
</div>
<div class="paragraph">
<p><em>Note</em> : Ensure that the jacorb jar files are added in your <code>CLASSPATH</code></p>
</div>
</div>
<div class="sect7">
<h8 id="_delpoy_the_application"><a class="anchor" href="#_delpoy_the_application"></a>Delpoy the Application</h8>
<div class="ulist">
<ul>
<li>
<p>Start the Server</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.txojbank.BankServer</code></pre>
</div>
</div>
</li>
<li>
<p>In a separate window, start the client</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jts.txojbank.BankClient</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>As for the demonstrations presented in the previous trails, the same menu is presented for the client with a set of operations such creating an account, credit/withdraw money to/from an account and making a transfer.</p>
</div>
<div class="paragraph">
<p>Building the banking application with TXOJ tools</p>
</div>
</div>
<div class="sect7">
<h8 id="_building_the_banking_application_with_txoj"><a class="anchor" href="#_building_the_banking_application_with_txoj"></a>Building the banking application with TXOJ</h8>

</div>
<div class="sect7">
<h8 id="_the_bank_idl"><a class="anchor" href="#_the_bank_idl"></a>The Bank IDL</h8>
<div class="paragraph">
<p>Since a distributed version has been adopted to present the application with Transactional Object for Java, an IDL file named Bank.idl described below is needed.
The difference with the Bank.idl presented in previous trails is the fact that the Bank interface inherits the CosTransactions::TransactionalObject interface.
Since we consider now that a Bank object need to modify its list in a transactional, we consider now a Bank object as a CORBA transactional.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">module arjuna {
   module demo {
     module jts {
      module txojbank {

        <span class="type">interface</span> <span class="class">Account</span> : CosTransactions::TransactionalObject
        {
          <span class="type">float</span> balance();
          <span class="type">void</span> credit( in <span class="type">float</span> value );
          <span class="type">void</span> debit( in <span class="type">float</span> value );
        };

        exception NotExistingAccount
        { };

        <span class="type">interface</span> <span class="class">Bank</span> : CosTransactions::TransactionalObject
        {
          Account create_account( in string name );
          Account get_account( in string name )
            raises( NotExistingAccount );
        };
       };
      };
     };
};</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The client program</p>
<div class="paragraph">
<p>Basically the client program (<code>src/com/arjuna/demo/jts/txojbank/BankClient.java</code>) is equivalent to the one described in the distributed jts version with implicit propagation, the difference is on the package name.</p>
</div>
</li>
<li>
<p>Implementing the Account Interface</p>
</li>
<li>
<p>Implementing the Bank Interface</p>
</li>
<li>
<p>Implementing the Bank Server.</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_implementing_the_account_interface"><a class="anchor" href="#_implementing_the_account_interface"></a>Implementing the Account interface</h8>
<div class="paragraph">
<p>To take benefit from the persistency and locking mechanism provided by ArjunaCore, a user class can inherit from the appropriate class (StateManager for recovery, and LockManager for recovery and concurrency control).
The AccountImpl class that implements the Account interface inherits the LockManager and implements the AccountOperations interface generated by the CORBA IDL compiler.
Since multiple inheritance is not allowed in Java, inheriting the AccountPOA class, as made in simple jts remote version, in addition to the LockManager is not possible.
That we use in this version a CORBA TIE mechanism to associate a servant to an CORBA object reference.</p>
</div>
<div class="paragraph">
<p>The Java interface definition of the AccountImpl class is given below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AccountImpl</span> <span class="directive">extends</span> LockManager <span class="directive">implements</span> AccountOperations {
    <span class="type">float</span> _balance;
    <span class="predefined-type">String</span> _name;

    <span class="directive">public</span> AccountImpl(<span class="predefined-type">String</span> name);

    <span class="directive">public</span> AccountImpl(Uid uid);

    <span class="directive">protected</span> <span class="type">void</span> finalize();

    <span class="directive">public</span> <span class="type">float</span> balance();

    <span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value);

    <span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value);

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="predefined-type">String</span> type();
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Constructors and Destructor</p>
<div class="paragraph">
<p>To use an existing persistent object requires the use of a special constructor that is required to take the Uid of the persistent object; the implementation of such a constructor is given below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> AccountImpl(Uid uid) {
    <span class="local-variable">super</span>(uid);
    <span class="comment">// Invoking super will lead to invoke the</span>
    <span class="comment">// restore_state method of this AccountImpl class</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is no particular behaviour applied by the Constructor with the Uid parameter The following constructor is used for a new Account creation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> AccountImpl(<span class="predefined-type">String</span> name ) {
    <span class="local-variable">super</span>(ObjectType.ANDPERSISTENT);
    _name = name;
    _balance = <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The destructor of the queue class is only required to call the terminate operation of LockManager.</p>
</div>
</li>
<li>
<p>save_state, restore_state and type</p>
<div class="paragraph">
<p>The implementations of save_state and restore_state are relatively simple for this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.save_state(os, ObjectType))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;

    <span class="keyword">try</span> {
        os.packString(_name);
        os.packFloat(_balance);
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.restore_state(os, ObjectType))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;

    <span class="keyword">try</span> {
        _name = os.unpackString();
        _balance = os.unpackFloat();
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the AccountImpl class is derived from the LockManager class, the operation type should be:</p>
</div>
</li>
<li>
<p>account management operations</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">float</span> balance() {
    <span class="type">float</span> result = <span class="integer">0</span>;
    <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.READ), <span class="integer">0</span>) == LockResult.GRANTED) {
        result = _balance;
    }
    ...

    return result;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the balance operation consists only to get the current balance, acquiring a lock in READ mode is enough.
This is not the case of the credit and debit methods that need to modify the current balance, that is a WRITE mode is needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">void</span> credit(<span class="type">float</span> value) {
    <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.WRITE), <span class="integer">0</span>) == LockResult.GRANTED) {
        _balance += value;
    }
    ...
}

<span class="directive">public</span> <span class="type">void</span> debit(<span class="type">float</span> value) {
    <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.WRITE), <span class="integer">0</span>) == LockResult.GRANTED) {
        _balance -= value;
    }
    ...
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_sample_application_source_code"><a class="anchor" href="#_sample_application_source_code"></a>Sample Application Source Code</h8>
<div class="paragraph">
<p>Full source code for the <code>src/com/arjuna/demo/jts/txojbank/AccountImpl.java</code> &#8594; AccountImpl class is included to provide you with a starting point for experimentation.</p>
</div>
</div>
<div class="sect7">
<h8 id="_implementing_the_bank_interface"><a class="anchor" href="#_implementing_the_bank_interface"></a>Implementing the Bank interface</h8>
<div class="paragraph">
<p>To take benefit from the persistency and locking mechanism provided by ArjunaCore, a user class can inherit from the appropriate class (StateManager for recovery, and LockManager for recovery and concurrency control).
The BankImpl class that implements the Bank interface inherits the LockManager and implements the BankOperations interface generated by the CORBA IDL compiler.
Since multiple inheritance is not allowed in Java, inheriting the BankPOA class, as made in simple jts remote version, in addition to the LockManager is not possible.
That we use in this version a CORBA TIE mechanism to associate a servant to an CORBA object reference.</p>
</div>
<div class="paragraph">
<p>The Java interface definition of the BankImpl class is given below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BankImpl</span> <span class="directive">extends</span> LockManager <span class="directive">implements</span> BankOperations {
    <span class="directive">public</span> BankImpl(OA oa);

    <span class="directive">public</span> BankImpl(Uid uid, OA oa);

    <span class="directive">public</span> BankImpl(Uid uid);

    <span class="directive">public</span> Account create_account(<span class="predefined-type">String</span> name);

    <span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name);

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="predefined-type">String</span> type();

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> ACCOUNT_SIZE = <span class="integer">10</span>;
    <span class="comment">// ACCOUNT_SIZE is the maximum number of accounts</span>
    <span class="directive">private</span> <span class="predefined-type">String</span><span class="type">[]</span> accounts;
    <span class="directive">private</span> <span class="type">int</span> numberOfAccounts;
    <span class="directive">private</span> ORB _orb;
    <span class="directive">private</span> OA _oa;
    <span class="directive">private</span> java.util.Hashtable _accounts; <span class="comment">//The list of accounts</span>
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Constructors and Destructor</p>
<div class="paragraph">
<p>To use an existing persistent object requires the use of a special constructor that is required to take the Uid of the persistent object; the implementation of such a constructor is given below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> BankImpl(Uid uid) {
    <span class="local-variable">super</span>(uid);
    _accounts = <span class="keyword">new</span> java.util.Hashtable();
    numberOfAccounts = <span class="integer">0</span>;
    accounts = <span class="keyword">new</span> <span class="predefined-type">String</span>[ACCOUNT_SIZE];
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following constructor is invoked during the first creation of the Bank Object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> BankImpl(OA oa) {
    <span class="local-variable">super</span>(ObjectType.ANDPERSISTENT);
    _accounts = <span class="keyword">new</span> java.util.Hashtable();
    _oa = oa;
    numberOfAccounts = <span class="integer">0</span>;
    accounts = <span class="keyword">new</span> <span class="predefined-type">String</span>[ACCOUNT_SIZE];
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following constructor is invoked on successive BankServer restart.
A bank already exists and should be recreated.
Invoking super or the constructor of the inherited class leads to execute the restore_state method, described below, of the BankImpl class to rebuild the list of accounts previously created, if any.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> BankImpl(Uid uid, OA oa) {
    <span class="local-variable">super</span>(uid);
    _accounts = <span class="keyword">new</span> java.util.Hashtable();
    _oa = oa;
    numberOfAccounts = <span class="integer">0</span>;
    accounts = <span class="keyword">new</span> <span class="predefined-type">String</span>[ACCOUNT_SIZE];
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The destructor of the queue class is only required to call the terminate operation of LockManager.</p>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">protected</span> <span class="type">void</span> finalize() {
    <span class="local-variable">super</span>.terminate();
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>account management operations</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> Account create_account(<span class="predefined-type">String</span> name) {
    AccountImpl acc;
    AccountPOA account = <span class="predefined-constant">null</span>;
    <span class="comment">//Attempt to obtain the lock for change</span>
    <span class="keyword">if</span> (setlock(<span class="keyword">new</span> <span class="predefined-type">Lock</span>(LockMode.WRITE), <span class="integer">0</span>) == LockResult.GRANTED) {
        <span class="comment">//Check if the maximum number of accounts is not reached</span>
        <span class="keyword">if</span> (numberOfAccounts &lt; ACCOUNT_SIZE) {
            acc = <span class="keyword">new</span> AccountImpl(name); <span class="comment">//Create a new account</span>
            <span class="comment">//Use the TIE mechanism to create a CORBA object</span>
            account = <span class="keyword">new</span> AccountPOATie(acc);
            <span class="comment">//Add the account to the list of accounts that</span>
            <span class="comment">//facilitate to retrieve accounts</span>
            _accounts.put(name, acc);
            <span class="comment">//The Uid of the created account is put in the array</span>
            accounts[numberOfAccounts] = acc.get_uid().toString();
            numberOfAccounts++;
        }
    }
    <span class="keyword">return</span> com.arjuna.demo.jts.txojbank.
            AccountHelper.narrow(_oa.corbaReference(account));
}

<span class="directive">public</span> Account get_account(<span class="predefined-type">String</span> name)
        <span class="directive">throws</span> NotExistingAccount {
    <span class="comment">// Only the hashtable list is used to retrieve the account</span>
    AccountImpl acc = (AccountImpl) _accounts.get(name);
    AccountPOA account = <span class="keyword">new</span> AccountPOATie(acc);
    <span class="keyword">if</span> (acc == <span class="predefined-constant">null</span>)
        <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account
                requested does not exist</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> com.arjuna.demo.jts.txojbank.
            AccountHelper.narrow(_oa.corbaReference(account));
}</code></pre>
</div>
</div>
</li>
<li>
<p>save_state, restore_state and type</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.save_state(os, ObjectType))
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;

    <span class="keyword">try</span> {
        os.packInt(numberOfAccounts);
        <span class="keyword">if</span> (numberOfAccounts &gt; <span class="integer">0</span>) {
            <span class="comment">// All Uid located in the array will be saved</span>
            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; numberOfAccounts; i++)
                os.packString(accounts[i]);
        }
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType) {
    <span class="keyword">if</span> (!<span class="local-variable">super</span>.restore_state(os, ObjectType)) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
    <span class="keyword">try</span> {
        numberOfAccounts = os.unpackInt();

        <span class="keyword">if</span> (numberOfAccounts &gt; <span class="integer">0</span>) {
            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; numberOfAccounts; i++) {
                accounts[i] = os.unpackString();
                <span class="comment">//each stored Uid is re-used to recreate</span>
                <span class="comment">//a stored account object</span>
                AccountImpl acc = <span class="keyword">new</span> AccountImpl(<span class="keyword">new</span> Uid(accounts[i]));
                acc.activate();
                <span class="comment">//Once recreated the account object</span>
                <span class="comment">//is activated and added to the list.</span>
                _accounts.put(acc.getName(), acc);
            }
        }
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="directive">public</span> <span class="predefined-type">String</span> type () {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/StateManager/LockManager/BankServer</span><span class="delimiter">&quot;</span></span>;
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_sample_application_source_code_2"><a class="anchor" href="#_sample_application_source_code_2"></a>Sample Application Source Code</h8>
<div class="paragraph">
<p>Full source code for the <code>src/com/arjuna/demo/jts/txojbank/BankImpl.java</code> &#8594; BankImpl class is included to provide you with a starting point for experimentation.</p>
</div>
</div>
<div class="sect7">
<h8 id="_implementing_the_bankserver"><a class="anchor" href="#_implementing_the_bankserver"></a>Implementing the BankServer</h8>
<div class="paragraph">
<p>The role of the BankServer class is mainly to initialise the ORB and the Object Adapter and to create the default Bank object responsible to create banking accounts.</p>
</div>
<div class="paragraph">
<p>Globally, the BankServer has the following structure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">myORB = ORB.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">ServerSide</span><span class="delimiter">&quot;</span></span>);
myOA = OA.getRootOA(myORB);
myORB.initORB(args, <span class="predefined-constant">null</span>);
myOA.initOA();
...</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Initialise the ORB</p>
<div class="paragraph">
<p>This done using the ORB Portability API</p>
</div>
</li>
<li>
<p>Create the BankImpl object, an instance that implements the Bank interface.
Two ways are provided to build such Bank object according to the fact it&#8217;s the first time we create such object or not.
This depends on the existence or not of the file named "</p>
<div class="ulist">
<ul>
<li>
<p></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">...
java.io.FileInputStream file = <span class="keyword">new</span> java.io.FileInputStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">UidBankFile</span><span class="delimiter">&quot;</span></span>);
java.io.InputStreamReader input = <span class="keyword">new</span> java.io.InputStreamReader(file);
java.io.BufferedReader reader = <span class="keyword">new</span> java.io.BufferedReader(input);
<span class="predefined-type">String</span> stringUid = reader.readLine();
file.close();
_bank = <span class="keyword">new</span> BankImpl(<span class="keyword">new</span> Uid(stringUid), myOA);
<span class="type">boolean</span> result =_bank.activate();
...</code></pre>
</div>
</div>
</li>
<li>
<p>If the file does not exist, a new BankImpl object is created, then the Uid of the created object is stored in the file named "UidBankFile"</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">...
_bank = <span class="keyword">new</span> BankImpl(myOA);
java.io.FileOutputStream file = <span class="keyword">new</span> java.io.FileOutputStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">UidBankFile</span><span class="delimiter">&quot;</span></span>);
java.io.PrintStream pfile=<span class="keyword">new</span> java.io.PrintStream(file);
pfile.println(_bank.get_uid().toString());
file.close();
...</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Store the CORBA object reference of the BankImpl object in a file in such way the client can retrieve it from that file.</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_sample_application_source_code_3"><a class="anchor" href="#_sample_application_source_code_3"></a>Sample Application Source Code</h8>
<div class="paragraph">
<p>Full source code for the <code>src/com/arjuna/demo/jts/txojbank/BankServer.java</code> &#8594; <code>BankServer</code> class is included to provide you with a starting point for experimentation.</p>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_developing_applications_with_jdbc_and_narayana_jts"><a class="anchor" href="#_developing_applications_with_jdbc_and_narayana_jts"></a>Developing applications with JDBC and Narayana JTS</h7>
<div class="paragraph">
<p>Narayana JTS supports the construction of both local and distributed transactional applications which access databases using the JDBC APIs.
JDBC supports two-phase commit of transactions, and is similar to the XA X/Open standard.
The JDBC support is found in the com.arjuna.ats.jdbc package.</p>
</div>
<div class="sect7">
<h8 id="_transactional_driver"><a class="anchor" href="#_transactional_driver"></a>Transactional Driver</h8>
<div class="paragraph">
<p>The Narayana JTS approach to incorporating JDBC connections within transactions is to provide transactional JDBC drivers through which all interactions occur.
These drivers intercept all invocations and ensure that they are registered with, and driven by, appropriate transactions.
There is a single type of transactional driver through which any JDBC driver can be driven; obviously if the database is not transactional then ACID properties cannot be guaranteed.
This driver is com.arjuna.ats.jdbc.TransactionalDriver, which implements the java.sql.Driver interface.</p>
</div>
<div class="paragraph">
<p>The driver may be directly instantiated and used within an application.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"> TransactionalDriver arjunaJDBC2Driver = <span class="keyword">new</span> TransactionalDriver();</code></pre>
</div>
</div>
<div class="paragraph">
<p>It can be registered with the JDBC driver manager (<code>java.sql.DriverManager</code>) by adding them to the Java system properties.
The <code>jdbc.drivers</code> property contains a list of driver class names, separated by colons, that are loaded by the JDBC driver manager when it is initialised, for instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">jdbc.drivers=foo.bar.Driver:mydata.sql.Driver:bar.test.myDriver</code></pre>
</div>
</div>
<div class="paragraph">
<p>On running an application, it is the DriverManager&#8217;s responsibility to load all the drivers found in the system property jdbc.drivers.
For example, this is where the driver for the Oracle database may be defined.
When opening a connection to a database it is the DriverManager' s role to choose the most appropriate driver from the previously loaded drivers.</p>
</div>
<div class="paragraph">
<p>A program can also explicitly load JDBC drivers at any time.
For example, the <code>my.sql.Driver</code> is loaded with the following statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="predefined-type">Class</span>.forName(<span class="string"><span class="delimiter">&quot;</span><span class="content">my.sql.Driver</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Calling Class.forName() will automatically register the driver with the JDBC driver manager.
It is also possible to explicitly create an instance of the JDBC driver using the registerDriver method of the DriverManager.
This is the case for instance for the TransactionalDriver that can be registered as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">TransactionalDriver arjunaJDBC2Driver = <span class="keyword">new</span> TransactionalDriver();
<span class="predefined-type">DriverManager</span>.registerDriver(arjunaJDBC2Driver);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you have loaded a driver, it is available for making a connection with a DBMS.</p>
</div>
</div>
<div class="sect7">
<h8 id="_making_connections"><a class="anchor" href="#_making_connections"></a>Making Connections</h8>
<div class="paragraph">
<p>Once a driver is loaded and ready for a connection to be made, instances of a Connection class can be created using the getConnection method on the DriverManager, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="predefined-type">Connection</span> con = <span class="predefined-type">DriverManager</span>.getConnection(url, username, password);</code></pre>
</div>
</div>
<div class="paragraph">
<p>From its version 2.0, the JDBC API has introduced a new way to obtain instances of the Connection class.
This is the case of the interfaces DataSource and XADataSource that creates transactional connections.
When using a JDBC 2.0 driver, Narayana will use the appropriate DataSource whenever a connection to the database is made.
It will then obtain XAResources and register them with the transaction via the JTA interfaces.
It is these XAResources which the transaction service will use when the transaction terminates in order to drive the database to either commit or rollback the changes made via the JDBC connection.</p>
</div>
<div class="paragraph">
<p>There are two ways in which the Narayana JDBC 2.0 support can obtain XADataSources.
These will be explained in the following sections.
Note, for simplicity we shall assume that the JDBC 2.0 driver is instantiated directly by the application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java Naming and Directory Interface (JNDI)</p>
<div class="paragraph">
<p>To get the ArjunaJDBC2Driver class to use a JNDI registered XADataSource it is first necessary to create the XADataSource instance and store it in an appropriate JNDI implementation.
Details of how to do this can be found in the JDBC 2.0 tutorial available at JavaSoft.
An example is show below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="predefined-type">XADataSource</span> ds = MyXADataSource();
<span class="predefined-type">Hashtable</span> env = <span class="keyword">new</span> <span class="predefined-type">Hashtable</span>();
<span class="predefined-type">String</span> initialCtx = PropertyManager.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Context.INITIAL_CONTEXT_FACTORY</span><span class="delimiter">&quot;</span></span>);
env.put(<span class="predefined-type">Context</span>.INITIAL_CONTEXT_FACTORY, initialCtx);
initialContext ctx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>(env);
ctx.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc/foo</span><span class="delimiter">&quot;</span></span>, ds);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where the Context.INITIAL_CONTEXT_FACTORY property is the JNDI way of specifying the type of JNDI implementation to use.</p>
</div>
<div class="paragraph">
<p>Then the application must pass an appropriate connection URL to the JDBC 2.0 driver:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="predefined-type">Properties</span> dbProps = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
dbProps.setProperty(TransactionalDriver.userName, <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>);
dbProps.setProperty(TransactionalDriver.password, <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>);
TransactionalDriver arjunaJDBC2Driver = <span class="keyword">new</span> TransactionalDriver();
<span class="predefined-type">Connection</span> connection = arjunaJDBC2Driver.connect(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:arjuna:jdbc/foo</span><span class="delimiter">&quot;</span></span>, dbProps);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JNDI URL must be pre-pended with jdbc:arjuna: in order for the ArjunaJDBC2Driver to recognise that the DataSource must participate within transactions and be driven accordingly.</p>
</div>
</li>
<li>
<p>Dynamic class instantiation</p>
<div class="paragraph">
<p>Many JDBC implementations provide proprietary implementations of XADataSources that provide non-standard extensions to the specification.
In order to allow the application to remain isolated from the actual JDBC 2.0 implementation it is using and yet continue to be able to use these extensions, Narayana hides the details of these proprietary implementations using dynamic class instantiation.
In addition, the use of JNDI is not required when using this mechanism because the actual implementation of the XADataSource will be directly instantiated, albeit in a manner which will not tie an application or driver to a specific implementation.
Narayana therefore has several classes which are for specific JDBC implementations, and these can be selected at runtime by the application setting the dynamicClass property appropriately:</p>
</div>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Database Type</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Property Name</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloudscape 3.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.internal.jdbc.drivers.cloudscape_3_6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequelink 5.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.internal.jdbc.drivers.sequelink_5_1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Oracle 8.1.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.internal.jdbc.drivers.oracle_8_1_6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQL Server 2000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.arjuna.ats.internal.jdbc.drivers.sqlserver_2_2</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The application code must specify which dynamic class the TransactionalDriver should instantiate when setting up the connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Properties</span> dbProps = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
dbProps.setProperty(TransactionalDriver.userName, <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>);
dbProps.setProperty(TransactionalDriver.password, <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>);
dbProps.setProperty(TransactionalDriver.dynamicClass,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.internal.jdbc.drivers.sequelink_5_0</span><span class="delimiter">&quot;</span></span>);
TransactionalDriver arjunaJDBC2Driver = <span class="keyword">new</span> TransactionalDriver();
<span class="predefined-type">Connection</span> connection = arjunaJDBC2Driver.connect(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:arjuna:
        sequelink/*:host:port;databaseName=foo</span><span class="delimiter">&quot;</span></span>,dbProperties*/);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note on properties used by the <code>com.arjuna.ats.jdbc.TransactionalDriver</code> class</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>userName</em>: the user name to use when attempting to connect to the database.</p>
</li>
<li>
<p><em>password</em>: the password to use when attempting to connect to the database.</p>
</li>
<li>
<p><em>createDb</em>: if set to true, the driver will attempt to create the database when it connects.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This may not be supported by all JDBC 2.0 implementations.
</td>
</tr>
</table>
</div>
</li>
<li>
<p><em>dynamicClass</em>: this specifies a class to instantiate to connect to the database, rather than using JNDI.</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_using_the_connection_2"><a class="anchor" href="#_using_the_connection_2"></a>Using the Connection</h8>
<div class="paragraph">
<p>Once the connection has been established (for example, using the <code>java.sql.DriverManager.getConnection</code> method), all operations on the connection will be monitored by Narayana.
Once created, the driver and any connection can be used in the same way as any other JDBC driver or connection.</p>
</div>
<div class="paragraph">
<p>Narayana connections can be used within multiple different transactions simultaneously, i.e., different threads, with different notions of the current transaction, may use the same JDBC connection. Narayana does connection pooling for each transaction within the JDBC connection.
So, although multiple threads may use the same instance of the JDBC connection, internally this may be using a different connection instance per transaction.
With the exception of close, all operations performed on the connection at the application level will only be performed on this transaction-specific connection.</p>
</div>
<div class="paragraph">
<p>Narayana will automatically register the JDBC driver connection with the transaction via an appropriate resource . When the transaction terminates, this resource will be responsible for either committing or rolling back any changes made to the underlying database via appropriate calls on the JDBC driver.</p>
</div>
</div>
<div class="sect7">
<h8 id="_further_reading_3"><a class="anchor" href="#_further_reading_3"></a>Further reading</h8>
<div class="paragraph">
<p>More details on the way to manage applications using the JDBC API can be found in the Narayana Programming Guide.</p>
</div>
</div>
<div class="sect7">
<h8 id="_the_banking_application_as_a_relational_database_accessed_with_jdbc"><a class="anchor" href="#_the_banking_application_as_a_relational_database_accessed_with_jdbc"></a>The banking application as a relational database accessed with JDBC</h8>
<div class="paragraph">
<p>In regards to the its structure in the previous trails, the banking application described here has been slightly simplified.
In this version creating local JTA transactions, accounts managed by a bank object are in fact instances or tuples within a SQL relational table named "accounts".
When the Bank object is requested for instance to create an account or to get information on an account, the Bank object performs SQL statement such SQL INSERT or SQL SELECT.</p>
</div>
</div>
<div class="sect7">
<h8 id="_deploy_the_application"><a class="anchor" href="#_deploy_the_application"></a>Deploy the application</h8>
<div class="paragraph">
<p>Executing the demonstration consists to launch the folowing program</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.jta.jdbcbank.BankClient  -host &lt;hostName&gt;
  -port portNumber  -username &lt;userName&gt;  -dbName &lt;DBName&gt;
  -password &lt;password&gt; -clean|-create</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>hostName</em> - the name of the machine where is located the database</p>
</li>
<li>
<p><em>userName</em> - the user name used to access the database</p>
</li>
<li>
<p><em>password</em> - the password used to access to database</p>
</li>
<li>
<p><em>DBName</em> - the database name</p>
</li>
<li>
<p><em>clean</em> - the existing relational table will be deleted then created</p>
</li>
<li>
<p><em>create</em> - a new relational table will be created</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Due to an issue with Oracle, it is possible that an XA exception is thrown when attempting to perform this test (see Release Notes).
If an xa error is returned you can use the following property property <em>com.arjuna.ats.jdbc.isolationLevel</em> set to <em>TRANSACTION_READ_COMMITTED</em> .
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This property can be added in previous command as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java -Dcom.arjuna.ats.jdbc.isolationLevel=TRANSACTION_READ_COMMITTED
  com.arjuna.demo.jta.jdbcbank.BankClient  -host &lt;hostName&gt;
  -port portNumber  -userName &lt;userName&gt;
  -password &lt;password&gt; -clean|-create</code></pre>
</div>
</div>
</div>
<div class="sect7">
<h8 id="_how_jdbc_is_used"><a class="anchor" href="#_how_jdbc_is_used"></a>How JDBC is used</h8>
<div class="paragraph">
<p>The following Banking application illustrates some methods that use the JDBC API.
In this application, the way to create a jdbc connection is made via an XADataSource obtained with JNDI operations, es explained in the previous trail jdbc introduction The BankClient class instantiates an XADataSource and bind it to a jndi naming in order to be retrieved to create transactional connections.
This portion of code illustrates how this made against oracle (tested on version 9i).
A similar code could tested against an other database by providng the appropriate XADataSource implementation.
Details of the BankClient class can be found in the file <code>src/com/arjuna/demo/jta/jdbcbank/BankClient.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><span class="keyword">package</span> <span class="namespace">com.arjuna.demo.jta.jdbcbank</span>;

<span class="keyword">import</span> <span class="include">javax.naming</span> .*;
        <span class="keyword">import</span> <span class="include">java.util.Hashtable</span>;
  <span class="keyword">import</span> <span class="include">oracle.jdbc.xa.client.OracleXADataSource</span>;
  <span class="keyword">import</span> <span class="include">com.arjuna.ats.jdbc.common.jdbcPropertyManager</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BankClient</span> {
    .....

    public <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        <span class="comment">//Provide the apporopriate information to access the database</span>
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; args.length; i++) {
            <span class="keyword">if</span> (args[i].compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">-host</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>)
                host = args[i + <span class="integer">1</span>]
            <span class="keyword">if</span> (args[i].compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">-port</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>)
                port = args[i + <span class="integer">1</span>];
            <span class="keyword">if</span> (args[i].compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">-username</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>)
                user = args[i + <span class="integer">1</span>];
            <span class="keyword">if</span> (args[i].compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">-password</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>)
                password = args[i + <span class="integer">1</span>];
            <span class="keyword">if</span> (args[i].compareTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">-dbName</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span>)
                dbName = args[i + <span class="integer">1</span>];
            ....
        }

        <span class="keyword">try</span> {
            <span class="comment">// create DataSource</span>
            OracleXADataSource ds = <span class="keyword">new</span> OracleXADataSource();
            ds.setURL(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:oracle:thin:@</span><span class="delimiter">&quot;</span></span> + host + <span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span> + port + <span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span> + dbName);

            <span class="comment">// now stick it into JNDI</span>
            <span class="predefined-type">Hashtable</span> env = <span class="keyword">new</span> <span class="predefined-type">Hashtable</span>();
            env.put(<span class="predefined-type">Context</span>.INITIAL_CONTEXT_FACTORY,
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">com.sun.jndi.fscontext.RefFSContextFactory</span><span class="delimiter">&quot;</span></span>);
            env.put(<span class="predefined-type">Context</span>.PROVIDER_URL, <span class="string"><span class="delimiter">&quot;</span><span class="content">file:/tmp/JNDI</span><span class="delimiter">&quot;</span></span>);
            <span class="predefined-type">InitialContext</span> ctx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>(env);
            ctx.rebind(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc/DB</span><span class="delimiter">&quot;</span></span>, ds);
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
        }
        <span class="comment">//Set the jndi information to be user by the Arjuna JDBC Property Manager</span>
        jdbcPropertyManager.propertyManager.setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Context.INITIAL_CONTEXT_FACTORY</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">com.sun.jndi.fscontext.RefFSContextFactory</span><span class="delimiter">&quot;</span></span>);
        jdbcPropertyManager.propertyManager.setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Context.PROVIDER_URL</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">file:/tmp/JNDI</span><span class="delimiter">&quot;</span></span>);

        Bank bank = <span class="keyword">new</span> Bank();
        BankClient client = <span class="keyword">new</span> BankClient(bank);

    }

    ....</code></pre>
</div>
</div>
<div class="paragraph">
<p>While the BankClient class is responsible to obtain information to access the database, tocreate the XADataSource and bind it to jndi, and also to get order from a user (create_account, debit, transfer, ..), the Bank class is resposnible to create jdbc connections to perform user&#8217;s requests.
The Bank class is illustarted below where.
All methods are not illusrated here but have a similar behavior; they could be found in details in the <code>src/com/arjuna/demo/jta/jdbcbank/Bank.java</code> &#8594; <code>Bank.java</code> program.
Note that for simplicity, much error checking code has been removed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java">    <span class="directive">public</span> Bank() {
        <span class="keyword">try</span> {
            <span class="predefined-type">DriverManager</span>.registerDriver(<span class="keyword">new</span> TransactionalDriver());
            dbProperties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
            dbProperties.put(TransactionalDriver.userName, user);
            dbProperties.put(TransactionalDriver.password, password);
            arjunaJDBC2Driver = <span class="keyword">new</span> TransactionalDriver(); <span class="comment">//</span>
            create_table();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            e.printStackTrace();
            <span class="predefined-type">System</span>.exit(<span class="integer">0</span>);
        }

        _accounts = <span class="keyword">new</span> java.util.Hashtable();
        reuseConnection = <span class="predefined-constant">true</span>;
    }

    <span class="directive">public</span> <span class="type">void</span> create_account(<span class="predefined-type">String</span> _name, <span class="type">float</span> _value) {
        <span class="keyword">try</span> {
            <span class="predefined-type">Connection</span> conne = arjunaJDBC2Driver.connect(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:arjuna:jdbc/DB</span><span class="delimiter">&quot;</span></span>, dbProperties);
            <span class="predefined-type">Statement</span> stmtx = conne.createStatement(); <span class="comment">// tx statement</span>
            stmtx.executeUpdate
                    (<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO accounts (name, value)
                            VALUES('</span><span class="delimiter">&quot;</span></span>+_name+<span class="string"><span class="delimiter">&quot;</span><span class="content">', </span><span class="delimiter">&quot;</span></span>+_value+<span class="string"><span class="delimiter">&quot;</span><span class="content">)</span><span class="delimiter">&quot;</span></span>);
        } <span class="keyword">catch</span> (<span class="exception">SQLException</span> e) {
            e.printStackTrace();
        }
    }

    <span class="directive">public</span> <span class="type">float</span> get_balance(<span class="predefined-type">String</span> _name)
            <span class="directive">throws</span> NotExistingAccount {
        <span class="type">float</span> theBalance = <span class="integer">0</span>;
        <span class="keyword">try</span> {
            <span class="predefined-type">Connection</span> conne = arjunaJDBC2Driver.connect(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:arjuna:jdbc/DB</span><span class="delimiter">&quot;</span></span>, dbProperties);
            <span class="predefined-type">Statement</span> stmtx = conne.createStatement(); <span class="comment">// tx statement</span>
            <span class="predefined-type">ResultSet</span> rs = stmtx.executeQuery
                    (<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT value from accounts
                            WHERE name = '</span><span class="delimiter">&quot;</span></span>+_name+<span class="string"><span class="delimiter">&quot;</span><span class="content">'</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">while</span> (rs.next()) {
                theBalance = rs.getFloat(<span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
            }
        } <span class="keyword">catch</span> (<span class="exception">SQLException</span> e) {
            e.printStackTrace();
            <span class="keyword">throw</span> <span class="keyword">new</span> NotExistingAccount(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Account requested does not exist</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="keyword">return</span> theBalance;
    }

    ....
}</code></pre>
</div>
</div>
</div>
<div class="sect7">
<h8 id="_note"><a class="anchor" href="#_note"></a>Note</h8>
<div class="paragraph">
<p>Although, this version of the banking application creates JTA local transactions, the way to manipulate JDBC API and the associated Narayana mechanisms in the case of distributed transactions is the same.</p>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_recovery_from_failure_examples"><a class="anchor" href="#_recovery_from_failure_examples"></a>Recovery From Failure Examples</h6>
<div class="sect6">
<h7 id="_introduction_8"><a class="anchor" href="#_introduction_8"></a>Introduction</h7>
<div class="paragraph">
<p>Recovery is the mechanism which preserves the transaction atomicity in presence of failures.
The basic technique for implementing transactions in presence of failures is based on the use of logs.
That is, a transaction system has to record enough information to ensure that it can be able to return to a previous state in case of failure or to ensure that changes committed by a transaction are properly stored.</p>
</div>
<div class="paragraph">
<p>Narayana ensures that results of a transaction are applied consistently to all resources involved in a transaction, even in the presence of failure.
To recover from failure, Narayana relies on its Recovery Manager.</p>
</div>
<div class="paragraph">
<p>Basically, the Recovery Manager is a daemon process that invokes a set of well known Recovery Modules periodically in two steps; a first to determine transactions in doubt state and a second step to continue the completion of those transactions found in the first step.
Since different type of resources may be involved in a transaction, different type of Recovery Modules may exist. Narayana provides several type of modules that manage resources according to their position in the transaction tree (root, subordinate, leaf) or the nature of the data itself, transactional object for java or XAResource as seen in the previous trail.</p>
</div>
<div class="paragraph">
<p>Whatever the nature of the involved resource, recovery is based on information or logs held in the Object Store, which contains specific subdirectory holding information according to the nature of the participant.</p>
</div>
</div>
<div class="sect6">
<h7 id="_running_the_recovery_manager"><a class="anchor" href="#_running_the_recovery_manager"></a>Running the Recovery Manager</h7>
<div class="paragraph">
<p><em>This section provides only brief information on running the recovery manager from provided scripts.
For complete information on the recovery manager (including how to configure it), see the Narayana recovery information.</em></p>
</div>
<div class="sect7">
<h8 id="_windows"><a class="anchor" href="#_windows"></a>Windows</h8>
<div class="paragraph">
<p>To run the Recovery Manager as a Windows service, simply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open a command prompt</p>
</li>
<li>
<p>cd to the directory &lt;jbossts_install_root&gt;\services\bin\windows</p>
</li>
<li>
<p>Type InstallRecoveryManagerService-NT.bat</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This directory also contains the uninstall script which is ran in the same manner.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To launch the Recovery Manager as a Windows process, simply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open a command prompt</p>
</li>
<li>
<p>cd to the directory &lt;jbossts_install_root&gt;\services\bin\windows</p>
</li>
<li>
<p>Type recoverymanagerservice.bat</p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_unix"><a class="anchor" href="#_unix"></a>UNIX</h8>
<div class="paragraph">
<p>To launch the Recovery Manager on a Linux/UNIX platform, simply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open a command prompt</p>
</li>
<li>
<p>cd to the directory &lt;jbossts_install_root&gt;\services\bin\[platform]</p>
</li>
<li>
<p>Type recoverymanagerservice.sh start</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To uninstall the recovery manager, rerun the script specifying the stop flag.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_the_recovery_process_and_xaresources"><a class="anchor" href="#_the_recovery_process_and_xaresources"></a>The Recovery Process and XAResources</h7>
<div class="paragraph">
<p>The Narayana recovery manager provides support for recovering XAResources whether or not they are Serializable.
XAResources that <em>do</em> implement the Serializable interface are handled without requiring additional programmer defined classes.
For those XAResources that need to recover but which cannot implement Serializable, it is possible to provide a small class which is used to help recover them.</p>
</div>
<div class="paragraph">
<p>This example shows the Narayana recovery manager recovering a Serializable XAResource and a non-Serializable XAResource.</p>
</div>
<div class="sect7">
<h8 id="_the_demos_components"><a class="anchor" href="#_the_demos_components"></a>The demo&#8217;s components</h8>
<div class="paragraph">
<p>The application consists of four classes.
Each class is well documented and it is recommended that the provided code is inspected to gain useful insight into some of the nuances of the recovery process.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The code of the main class that controls the application (<code>src/com/arjuna/demo/recovery/xaresource/TestXAResourceRecovery.java</code> &#8594; <code>TestRecoveryModule.java</code>), allows the user to specify a number of options: <code>[-waitForRecovery] [-useExternalRecoveryManager]</code></p>
</li>
<li>
<p>Programmer-defined support of the Serializable XAResource is only required in the XAResource implementation class <code>src/com/arjuna/demo/recovery/xaresource/ExampleXAResource.java</code> &#8594; <code>ExampleXAResource.java</code></p>
</li>
<li>
<p>Programmer-defined support of the non-Serializable XAResource is required both in the XAResource implementation class <code>src/com/arjuna/demo/recovery/xaresource/NonSerializableExampleXAResource.java</code> &#8594; <code>NonSerializableExampleXAResource</code>, and in a class that implements a helper for the Narayana recovery process <code>src/com/arjuna/demo/recovery/xaresource/NonSerializableExampleXAResourceRecovery.java</code> &#8594; <code>NonSerializableExampleXAResourceRecovery.java</code></p>
</li>
</ul>
</div>
</div>
<div class="sect7">
<h8 id="_xaresourcerecovery_registration"><a class="anchor" href="#_xaresourcerecovery_registration"></a>XAResourceRecovery registration</h8>
<div class="paragraph">
<p>When recovering from failures, Narayana requires the ability to reconnect to the resource managers that were in use prior to the failures in order to resolve any outstanding transactions.
In order to recreate those connections for non-Serializable XAResources it is necessary to provide implementations of the following Narayana interface com.arjuna.ats.jta.recovery.XAResourceRecovery.</p>
</div>
<div class="paragraph">
<p>To inform the recovery system about each of the XAResourceRecovery instances, it is necessary to specify their class names through property variables in the <code>jbossts-properties.xml</code> file.
Any property variable which starts with the name XAResourceRecovery will be assumed to represent one of these instances, and its value should be the class name.</p>
</div>
<div class="paragraph">
<p>When running XA transaction recovery it is necessary to tell Narayana which types of Xid it can recover.
Each Xid that Narayana creates has a unique node identifier encoded within it and Narayana will only recover transactions and states that match a specified node identifier.
The node identifier to use should be provided to Narayana via a property that starts with the name com.arjuna.ats.jta.xaRecoveryNode (multiple values may be provided).
A value of * will force Narayana to recover (and possibly rollback) all transactions irrespective of their node identifier and should be used with caution.</p>
</div>
<div class="paragraph">
<p>The recovery module for the non-Serializable XAResource must be deployed in order to provide support to recover the non-Serializable XAResource.
If this step was missed out the Serializable XAResource would recover OK but Narayana would have no knowledge of the non-Serializable XAResource and so it could not recover it.
To register the non-Serializable XAResource XAResourceRecovery module, add an entry to the <code>jbossts-properties.xml</code>.</p>
</div>
<div class="paragraph">
<p>Under the element <code>&lt;properties depends="jts" name="jta"&gt;</code>, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.jta.recovery.XAResourceRecovery1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.demo.recovery.xaresource.NonSerializableExampleXAResourceRecovery</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.jta.xaRecoveryNode</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="sect8">
<h9 id="_configure_the_recovery_manager_scan_period"><a class="anchor" href="#_configure_the_recovery_manager_scan_period"></a>Configure the recovery manager scan period</h9>
<div class="paragraph">
<p>By default, the recovery manager is configured to perform a pass over resources to be recovered every two minutes.
It will then wait for ten seconds before re-checking the resources.
Although the test will run OK with this configuration, it is possible to configure the recovery manager scan times to reduce the time waiting.
To configure the intervals, edit the <code>jbossts-properties.xml</code> as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Edit the property "com.arjuna.ats.arjuna.recovery.periodicRecoveryPeriod" to change the value from 120 to 5.</p>
</li>
<li>
<p>Edit the property "com.arjuna.ats.arjuna.recovery.recoveryBackoffPeriod" to change the value from 10 to 5.</p>
</li>
</ul>
</div>
</div>
<div class="sect8">
<h9 id="_specify_the_transaction_manager_type_to_use"><a class="anchor" href="#_specify_the_transaction_manager_type_to_use"></a>Specify the transaction manager type to use</h9>
<div class="paragraph">
<p>The recovery manager will work in the same manner for either the JTA or JTS implementation.
By default Narayana is configured to use a JTS transaction manager, in order to configure it to use a JTA transaction manager a change must again be made to the <code>jbossts-properties.xml</code>.
<em>See "Testing JTA" for more information on how to configure the Narayana transaction manager to use JTA rather than JTS.</em></p>
</div>
<div class="paragraph">
<p><em>If you do change the transaction manager type remember to reconfigure the recovery manager as follows:</em></p>
</div>
<div class="paragraph">
<p>If you are using the ArjunaCore (raw JTA) transaction manager implementation comment out the element in <code>jbossts-properties.xml</code> containing the following text:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">internal.jta.recovery.jts.XARecoveryModule</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using the JTS transaction manager implementation comment out the element in <code>jbossts-properties.xml</code> containing the following text:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">internal.jta.recovery.arjunacore.XARecoveryModule</code></pre>
</div>
</div>
</div>
<div class="sect8">
<h9 id="_launching_the_demo"><a class="anchor" href="#_launching_the_demo"></a>Launching the demo</h9>
<div class="paragraph">
<p>To launch the Test Recovery Module, execute the following java program</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open a command prompt</p>
</li>
<li>
<p>cd to the directory <code>&lt;jbossts_install_root&gt;\trail_map</code></p>
</li>
<li>
<p>Type <code>java com.arjuna.demo.recovery.xaresource.TestXAResourceRecovery</code></p>
</li>
<li>
<p>View the output noting the crash during commit.</p>
</li>
<li>
<p>Inspect the current working directory to note that the applications have created several log files which you may like to review.</p>
</li>
<li>
<p>Type <code>java com.arjuna.demo.recovery.xaresource.TestXAResourceRecovery -waitForRecovery</code></p>
</li>
<li>
<p>Wait for the two resources to be recovered and committed.</p>
</li>
<li>
<p>Re-review the log files from the working directory, if wanted.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As you can see, the Serializable XAResource does not need it&#8217;s recover() method called as the transaction manager is aware of all the information about this resource.
</td>
</tr>
</table>
</div>
</div>
<div class="sect8">
<h9 id="_the_recovery_process_and_abstractrecords"><a class="anchor" href="#_the_recovery_process_and_abstractrecords"></a>The Recovery Process and AbstractRecords</h9>
<div class="paragraph">
<p><em>WARNING: Implementing a RecoveryModule and AbstractRecord is a very advanced feature of the transaction service.
It should only be performed by users familiar with the all the concepts used in the Narayana product.
Please see the ArjunaCore guide for more information about RecoveryModules and AbstractRecords.</em></p>
</div>
<div class="paragraph">
<p>The following sample gives an overview how the Recovery Manager invokes a module to recover from failure.
This basic sample does not aim to present a complete process to recover from failure, but mainly to illustrate the way to implement a recovery module.
More details can be found in "Failure Recovery Guide".</p>
</div>
<div class="paragraph">
<p>The application used here consists to create an atomic transaction, to register a participant within the created transaction and finally to terminate it either by commit or abort.
A set of arguments are provided:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to decide committing or aborting the transaction,</p>
</li>
<li>
<p>to decide generating a crash during the commitment process.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">The demo&#8217;s components</div>
<p>The application consists of three programs</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The code of the main class that control the application (<code>src/com/arjuna/demo/recoverymodule/TestRecoveryModule.java</code> &#8594; <code>TestRecoveryModule.java</code>), which consists to give the choice to either commit or abort the transaction and also to generate a crash.</p>
</li>
<li>
<p>The registered participant (<code>src/com/arjuna/demo/recoverymodule/SimpleRecord.java</code> &#8594; <code>SimpleRecord.java</code>) has the following behaviour:</p>
<div class="ulist">
<ul>
<li>
<p>During the prepare phase, it writes a simple message - "I&#8217;m prepared" - on the disk such message is written in a well known file</p>
</li>
<li>
<p>During the commit phase, it writes another message - "I&#8217;m committed" - in the same file used during prepare</p>
</li>
<li>
<p>If it receives an abort message, it removes from the disk the file used for prepare if any.</p>
</li>
<li>
<p>if a crash has been decided for the test, then it crashes during the commit phase - the file remains with the message "I&#8217;m prepared".</p>
</li>
</ul>
</div>
</li>
<li>
<p>A Recovery Module (<code>src/com/arjuna/demo/recoverymodule/SimpleRecoveryModule.java</code> &#8594; <code>SimpleRecoveryModule.java</code>) that consists to read the content of the file used to store the status of the participant, to determine that status and print a message indicating if a recovery action is needed or not.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using the provided Narayana Recovery Modules ensures that resources are correctly recovered.
This sample illustrates how to define and register its own module.
It&#8217;s the responsibility of the module to re-create the appropriate objects using information retrieved from a log.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Recovery Module registration</div>
<p>The recovery module should now be deployed in order to be called by the Recovery Manager.
To do so, we just need to add an entry in the <code>jbossts-properties.xml</code> by adding a new property as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.ats.arjuna.recovery.recoveryExtension&lt;i</span></span><span class="error">&gt;</span>&quot; value=&quot;com.arjuna.demo.recoverymodule.SimpleRecoveryModule&quot;/<span class="error">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Where &lt;i&gt; represent the new occurrence number that follows the last that already exists in the file.
Once started, the Recovery Manager will automatically load the added Recovery module.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Starting the Recovery Manager</div>
<p>In a separate window launch the Recovery Manager, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager -test</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<div class="title">Launching the demo</div>
<p>To launch the Test Recovery Module, execute the following java program</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.demo.recoverymodule.TestRecoveryModule
  [-commit|-abort] [-crash]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_failure_recovery_2"><a class="anchor" href="#_failure_recovery_2"></a>4.2.8. Failure Recovery</h4>
<div class="paragraph">
<p>The failure recovery subsystem of Narayana ensure that results of a transaction are applied consistently to all resources affected by the transaction, even if any of the application processes or the hardware hosting them crash or lose network connectivity.
In the case of hardware crashes or network failures, the recovery does not take place until the system or network are restored, but the original application does not need to be restarted.
Recovery is handled by the Recovery Manager process.
For recover to take place, information about the transaction and the resources involved needs to survive the failure and be accessible afterward.
This information is held in the <code>ActionStore</code>, which is part of the <code>ObjectStore</code>.
If the <code>ObjectStore</code> is destroyed or modified, recovery may not be possible.</p>
</div>
<div class="paragraph">
<p>Until the recovery procedures are complete, resources affected by a transaction which was in progress at the time of the failure may be inaccessible.
Database resources may report this as as tables or rows held by in-doubt transactions.
For TXOJ resources, an attempt to activate the Transactional Object, such as when trying to get a lock, fails.</p>
</div>
<div class="sect4">
<h5 id="_configuring_the_failure_recovery_subsystem_for_your_orb"><a class="anchor" href="#_configuring_the_failure_recovery_subsystem_for_your_orb"></a>Configuring the failure recovery subsystem for your ORB</h5>
<div class="paragraph">
<p>Although some ORB-specific configuration is necessary to configure the ORB sub-system, the basic settings are ORB-independent.
The configuration which applies to Narayana is in the <code>RecoveryManager-properties.xml</code> file and the <code>orportability-properties.xml</code> file.
Contents of each file are below.</p>
</div>
<div class="listingblock">
<div class="title">RecoverManager-properties.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.recoveryActivatorClassNames</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    com.arjuna.ats.internal.jts.orbspecific.recovery.RecoveryEnablement
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">orportability-properties.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna.orbportability.orb.PostInit2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>com.arjuna.ats.internal.jts.recovery.RecoveryInit<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These entries cause instances of the named classes to be loaded.
The named classes then load the ORB-specific classes needed and perform other initialization.
This enables failure recovery for transactions initiated by or involving applications using this property file.
The default <code>RecoveryManager-properties.xml</code> file and <code>orportability-properties.xml</code> with the distribution include these entries.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Failure recovery is NOT supported with the JavaIDL ORB that is part of JDK.
Failure recovery is supported for JacOrb only.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To disable recovery, remove or comment out the <code>RecoveryEnablement</code> line in the property file.</p>
</div>
</div>
<div class="sect4">
<h5 id="_jts_specific_recovery"><a class="anchor" href="#_jts_specific_recovery"></a>JTS specific recovery</h5>
<div class="sect5">
<h6 id="_xa_resource_recovery"><a class="anchor" href="#_xa_resource_recovery"></a>XA resource recovery</h6>
<div class="paragraph">
<p>Recovery of XA resources accessed via JDBC is handled by the <code>XARecoveryModule</code>. This module includes both transaction-initiated and resource-initiated recovery.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Transaction-initiated recovery is possible where the particular transaction branch progressed far enough for a <code>JTA_ResourceRecord</code> to be written in the ObjectStore.
The record contains the information needed to link the transaction to information known by the rest of Narayana in the database.</p>
</li>
<li>
<p>Resource-initiated recovery is necessary for branches where a failure occurred after the database made a persistent record of the transaction, but before the <code>JTA_ResourceRecord</code> was written.
Resource-initiated recovery is also necessary for datasources for which it is impossible to hold information in the <code>JTA_ResourceRecord</code> that allows the recreation in the RecoveryManager of the <code>XAConnection</code> or <code>XAResource</code> used in the original application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Transaction-initiated recovery is automatic.
The <code>XARecoveryModule</code> finds the <code>JTA_ResourceRecord</code> which needs recovery, using the two-pass mechanism described above.
It then uses the normal recovery mechanisms to find the status of the transaction the resource was involved in, by running <code>replay_completion</code> on the <code>RecoveryCoordinator</code> for the transaction branch.
Next, it creates or recreates the appropriate <code>XAResource</code> and issues <code>commit</code> or <code>rollback</code> on it as appropriate.
The <code>XAResource</code> creation uses the same database name, username, password, and other information as the application.</p>
</div>
<div class="paragraph">
<p>Resource-initiated recovery must be specifically configured, by supplying the <code>RecoveryManager</code> with the appropriate information for it to interrogate all the <code>XADataSources</code> accessed by any Narayana application.
The access to each <code>XADataSource</code> is handled by a class that implements the <code>com.arjuna.ats.jta.recovery.XAResourceRecovery</code> interface.
Instances of this class are dynamically loaded, as controlled by property <code>JTAEnvironmentBean.xaResourceRecoveryInstances</code> .</p>
</div>
<div class="paragraph">
<p>The <code>XARecoveryModule</code> uses the <code>XAResourceRecovery</code> implementation to get an <code>XAResource</code> to the target datasource.
On each invocation of periodicWorkSecondPass`, the recovery module issues an <code>XAResource.recover</code> request.
This request returns a list of the transaction identifiers that are known to the datasource and are in an in-doubt state.
The list of these in-doubt Xids is compared across multiple passes, using <code>periodicWorkSecondPass-es</code>.
Any Xid that appears in both lists, and for which no <code>JTA_ResourceRecord</code> is found by the intervening transaction-initiated recovery, is assumed to belong to a transaction involved in a crash before any <code>JTA_Resource_Record</code> was written, and a <code>rollback</code> is issued for that transaction on the <code>XAResource</code>.</p>
</div>
<div class="paragraph">
<p>This double-scan mechanism is used because it is possible the Xid was obtained from the datasource just as the original application process was about to create the corresponding JTA_ResourceRecord.
The interval between the scans should allow time for the record to be written unless the application crashes (and if it does, rollback is the right answer).</p>
</div>
<div class="paragraph">
<p>An <code>XAResourceRecovery</code> implementation class can contain all the information needed to perform recovery to a specific datasource.
Alternatively, a single class can handle multiple datasources which have some similar features.
The constructor of the implementation class must have an empty parameter list, because it is loaded dynamically.
The interface includes an <code>initialise</code> method, which passes in further information as a <code>string</code>.
The content of the string is taken from the property value that provides the class name.
Everything after the first semi-colon is passed as the value of the string.
The <code>XAResourceRecovery</code> implementation class determines how to use the string.</p>
</div>
<div class="paragraph">
<p>An <code>XAResourceRecovery</code> implementation class, <code>com.arjuna.ats.internal.jdbc.recovery.BasicXARecovery</code>, supports resource-initiated recovery for any XADataSource.
For this class, the string received in method <code>initialise</code> is assumed to contain the number of connections to recover, and the name of the properties file containing the dynamic class name, the database username, the database password and the database connection URL.
The following example is for an Oracle 8.1.6 database accessed via the Sequelink 5.1 driver:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>XAConnectionRecoveryEmpay=com.arjuna.ats.internal.jdbc.recovery.BasicXARecovery;2;OraRecoveryInfo</pre>
</div>
</div>
<div class="paragraph">
<p>This implementation is only meant as an example, because it relies upon usernames and passwords appearing in plain text properties files.
You can create your own implementations of <code>XAConnectionRecovery</code>.
See the javadocs and the example <code>com.arjuna.ats.internal.jdbc.recovery.BasicXARecovery</code>.</p>
</div>
<div class="listingblock">
<div class="title">XAConnectionRecovery implementation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.arjuna.ats.internal.jdbc.recovery</span>;

<span class="keyword">import</span> <span class="include">com.arjuna.ats.jdbc.TransactionalDriver</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jdbc.common.jdbcPropertyManager</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jdbc.logging.jdbcLogger</span>;

<span class="keyword">import</span> <span class="include">com.arjuna.ats.internal.jdbc</span>.*;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.jta.recovery.XAConnectionRecovery</span>;
<span class="keyword">import</span> <span class="include">com.arjuna.ats.arjuna.common</span>.*;
<span class="keyword">import</span> <span class="include">com.arjuna.common.util.logging</span>.*;

<span class="keyword">import</span> <span class="include">java.sql</span>.*;
<span class="keyword">import</span> <span class="include">javax.sql</span>.*;

<span class="keyword">import</span> <span class="include">jakarta.transaction</span>.*;

<span class="keyword">import</span> <span class="include">javax.transaction.xa</span>.*;
<span class="keyword">import</span> <span class="include">java.util</span>.*;

<span class="keyword">import</span> <span class="include">java.lang.NumberFormatException</span>;

<span class="comment">/**
 * This class implements the XAConnectionRecovery interface for XAResources.
 * The parameter supplied in setParameters can contain arbitrary information
 * necessary to initialise the class once created. In this instance it contains
 * the name of the property file in which the db connection information is
 * specified, as well as the number of connections that this file contains
 * information on (separated by ;).
 * &lt;p&gt;
 * IMPORTANT: this is only an *example* of the sorts of things an
 * XAConnectionRecovery implementor could do. This implementation uses
 * a property file which is assumed to contain sufficient information to
 * recreate connections used during the normal run of an application so that
 * we can perform recovery on them. It is not recommended that information such
 * as user name and password appear in such a raw text format as it opens up
 * a potential security hole.
 * &lt;p&gt;
 * The db parameters specified in the property file are assumed to be
 * in the format:
 * &lt;p&gt;
 * DB_x_DatabaseURL=
 * DB_x_DatabaseUser=
 * DB_x_DatabasePassword=
 * DB_x_DatabaseDynamicClass=
 * &lt;p&gt;
 * DB_JNDI_x_DatabaseURL=
 * DB_JNDI_x_DatabaseUser=
 * DB_JNDI_x_DatabasePassword=
 * &lt;p&gt;
 * where x is the number of the connection information.
 *
 * @since JTS 2.1.
 */</span>

<span class="directive">public</span> <span class="type">class</span> <span class="class">BasicXARecovery</span> <span class="directive">implements</span> XAConnectionRecovery {
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> dbTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">DB_</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> urlTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">_DatabaseURL</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> passwordTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">_DatabasePassword</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> userTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">_DatabaseUser</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> dynamicClassTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">_DatabaseDynamicClass</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> jndiTag = <span class="string"><span class="delimiter">&quot;</span><span class="content">JNDI_</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">char</span> BREAKCHARACTER = <span class="string"><span class="delimiter">'</span><span class="content">;</span><span class="delimiter">'</span></span>;  <span class="comment">// delimiter for parameters</span>
    <span class="directive">private</span> <span class="type">int</span> numberOfConnections;
    <span class="directive">private</span> <span class="type">int</span> connectionIndex;
    <span class="directive">private</span> <span class="predefined-type">Properties</span> props;
    <span class="comment">/*
     * Some XAConnectionRecovery implementations will do their startup work
     * here, and then do little or nothing in setDetails. Since this one needs
     * to know dynamic class name, the constructor does nothing.
     */</span>
    <span class="directive">public</span> BasicXARecovery() <span class="directive">throws</span> <span class="exception">SQLException</span> {
        numberOfConnections = <span class="integer">1</span>;
        connectionIndex = <span class="integer">0</span>;
        props = <span class="predefined-constant">null</span>;
    }

    <span class="comment">/**
     * The recovery module will have chopped off this class name already.
     * The parameter should specify a property file from which the url,
     * user name, password, etc. can be read.
     */</span>

    <span class="directive">public</span> <span class="type">boolean</span> initialise(<span class="predefined-type">String</span> parameter) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="type">int</span> breakPosition = parameter.indexOf(BREAKCHARACTER);
        <span class="predefined-type">String</span> fileName = parameter;

        <span class="keyword">if</span> (breakPosition != -<span class="integer">1</span>) {
            fileName = parameter.substring(<span class="integer">0</span>, breakPosition - <span class="integer">1</span>);

            <span class="keyword">try</span> {
                numberOfConnections = <span class="predefined-type">Integer</span>.parseInt(parameter.substring(breakPosition + <span class="integer">1</span>));
            } <span class="keyword">catch</span> (<span class="exception">NumberFormatException</span> e) {
                <span class="comment">//Produce a Warning Message</span>
                <span class="keyword">return</span> <span class="predefined-constant">false</span>;
            }
        }

        PropertyManager.addPropertiesFile(fileName);

        <span class="keyword">try</span> {
            PropertyManager.loadProperties(<span class="predefined-constant">true</span>);

            props = PropertyManager.getProperties();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            <span class="comment">//Produce a Warning Message</span>

            <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        }

        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    }

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="predefined-type">XAConnection</span> getConnection() <span class="directive">throws</span> <span class="exception">SQLException</span> {
        JDBC2RecoveryConnection conn = <span class="predefined-constant">null</span>;

        <span class="keyword">if</span> (hasMoreConnections()) {
            connectionIndex++;

            conn = getStandardConnection();

            <span class="keyword">if</span> (conn == <span class="predefined-constant">null</span>)
                conn = getJNDIConnection();

            <span class="keyword">if</span> (conn == <span class="predefined-constant">null</span>)
            <span class="comment">//Produce a Warning message</span>
        }

        <span class="keyword">return</span> conn;
    }

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> hasMoreConnections() {
        <span class="keyword">if</span> (connectionIndex == numberOfConnections)
            <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        <span class="keyword">else</span>
            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    }

    <span class="directive">private</span> <span class="directive">final</span> JDBC2RecoveryConnection getStandardConnection() <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="predefined-type">String</span> number = <span class="keyword">new</span> <span class="predefined-type">String</span>(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> + connectionIndex);
        <span class="predefined-type">String</span> url = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + number + urlTag);
        <span class="predefined-type">String</span> password = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + number + passwordTag);
        <span class="predefined-type">String</span> user = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + number + userTag);
        <span class="predefined-type">String</span> dynamicClass = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + number + dynamicClassTag);
        <span class="predefined-type">Properties</span> dbProperties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
        <span class="predefined-type">String</span> theUser = props.getProperty(user);
        <span class="predefined-type">String</span> thePassword = props.getProperty(password);

        <span class="keyword">if</span> (theUser != <span class="predefined-constant">null</span>) {
            dbProperties.put(ArjunaJDBC2Driver.userName, theUser);
            dbProperties.put(ArjunaJDBC2Driver.password, thePassword);

            <span class="predefined-type">String</span> dc = props.getProperty(dynamicClass);

            <span class="keyword">if</span> (dc != <span class="predefined-constant">null</span>)
                dbProperties.put(ArjunaJDBC2Driver.dynamicClass, dc);

            <span class="keyword">return</span> <span class="keyword">new</span> JDBC2RecoveryConnection(url, dbProperties);
        } <span class="keyword">else</span>
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }

    <span class="comment">/*
     * Example:
     *
     * DB2_DatabaseURL=jdbc\:arjuna\:sequelink\://qa02\:20001
     * DB2_DatabaseUser=tester2
     * DB2_DatabasePassword=tester
     * DB2_DatabaseDynamicClass=
     *      com.arjuna.ats.internal.jdbc.drivers.sequelink_5_1
     *
     * DB_JNDI_DatabaseURL=jdbc\:arjuna\:jndi
     * DB_JNDI_DatabaseUser=tester1
     * DB_JNDI_DatabasePassword=tester
     * DB_JNDI_DatabaseName=empay
     * DB_JNDI_Host=qa02
     * DB_JNDI_Port=20000
     */</span>

    <span class="directive">private</span> <span class="directive">final</span> JDBC2RecoveryConnection getJNDIConnection() <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="predefined-type">String</span> number = <span class="keyword">new</span> <span class="predefined-type">String</span>(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> + connectionIndex);
        <span class="predefined-type">String</span> url = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + jndiTag + number + urlTag);
        <span class="predefined-type">String</span> password = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + jndiTag + number + passwordTag);
        <span class="predefined-type">String</span> user = <span class="keyword">new</span> <span class="predefined-type">String</span>(dbTag + jndiTag + number + userTag);
        <span class="predefined-type">Properties</span> dbProperties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
        <span class="predefined-type">String</span> theUser = props.getProperty(user);
        <span class="predefined-type">String</span> thePassword = props.getProperty(password);

        <span class="keyword">if</span> (theUser != <span class="predefined-constant">null</span>) {
            dbProperties.put(ArjunaJDBC2Driver.userName, theUser);
            dbProperties.put(ArjunaJDBC2Driver.password, thePassword);
            <span class="keyword">return</span> <span class="keyword">new</span> JDBC2RecoveryConnection(url, dbProperties);
        } <span class="keyword">else</span>
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Multiple recovery domains and resource-initiated recovery</div>
<code>XAResource.recover</code> returns the list of all transactions that are in-doubt with in the datasource.
If multiple recovery domains are used with a single datasource, resource-initiated recovery sees transactions from other domains.
Since it does not have a <code>JTA_ResourceRecord</code> available, it rolls back the transaction in the database, if the Xid appears in successive recover calls.
To suppress resource-initiated recovery, do not supply an <code>XAConnectionRecovery</code> property, or confine it to one recovery domain.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_recovery_behavior"><a class="anchor" href="#_recovery_behavior"></a>Recovery behavior</h6>
<div class="paragraph">
<p>Property <code>OTS_ISSUE_RECOVERY_ROLLBACK</code> controls whether the <code>RecoveryManager</code> explicitly issues a rollback request when <code>replay_completion</code> asks for the status of a transaction that is unknown.
According to the <code>presume-abort</code> mechanism used by OTS and JTS, the transaction can be assumed to have rolled back, and this is the response returned to the Resource`, including a subordinate coordinator, in this case.
The <code>Resource</code> should then apply that result to the underlying resources.
However, it is also legitimate for the superior to issue a rollback, if <code>OTS_ISSUE_RECOVERY_ROLLBACK</code> is set to <code>YES</code>.</p>
</div>
<div class="paragraph">
<p>The OTS transaction identification mechanism makes it possible for a transaction coordinator to hold a <code>Resource</code> reference that will never be usable.
This can occur in two cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The process holding the <code>Resource</code> crashes before receiving the commit or rollback request from the coordinator.</p>
</li>
<li>
<p>The <code>Resource</code> receives the commit or rollback, and responds.
However, the message is lost or the coordinator process has crashed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the first case, the <code>RecoveryManager</code> for the <code>Resource``ObjectStore</code> eventually reconstructs a new <code>Resource</code> (with a different CORBA object reference (IOR), and issues a <code>replay_completion</code> request containing the new <code>Resource</code> IOR.
The <code>RecoveryManager</code> for the coordinator substitutes this in place of the original, useless one, and issues <code>commit</code> to the new reconstructed <code>Resource</code>.
The <code>Resource</code> has to have been in a commit state, or there would be no transaction intention list.
Until the <code>replay_completion</code> is received, the <code>RecoveryManager</code> tries to send <code>commit</code> to its <code>Resource</code> reference.
This will fail with a CORBA System Exception.
Which exception depends on the ORB and other details.</p>
</div>
<div class="paragraph">
<p>In the second case, the <code>Resource</code> no longer exists.
The <code>RecoveryManager</code> at the coordinator will never get through, and will receive System Exceptions forever.</p>
</div>
<div class="paragraph">
<p>The <code>RecoveryManager</code> cannot distinguish these two cases by any protocol mechanism.
There is a perceptible cost in repeatedly attempting to send the commit to an inaccessible <code>Resource</code>. In particular, the timeouts involved will extend the recovery iteration time, and thus potentially leave resources inaccessible for longer.</p>
</div>
<div class="paragraph">
<p>To avoid this, the <code>RecoveryManager</code> only attempts to send <code>commit</code> to a <code>Resource</code> a limited number of times.
After that, it considers the transaction assumed complete.
It retains the information about the transaction, by changing the object type in the ActionStore`, and if the <code>Resource</code> eventually does wake up and a <code>replay_completion</code> request is received, the <code>RecoveryManager</code> activates the transaction and issues the commit request to the new Resource IOR.
The number of times the <code>RecoveryManager</code> attempts to issue <code>commit</code> as part of the periodic recovery is controlled by the property variable <code>COMMITTED_TRANSACTION_RETRY_LIMIT</code>, and defaults to <code>3</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_expired_entry_removal_4"><a class="anchor" href="#_expired_entry_removal_4"></a>Expired entry removal</h6>
<div class="paragraph">
<p>The operation of the recovery subsystem causes some entries to be made in the <code>ObjectStore</code> that are not removed in normal progress.
The <code>RecoveryManager</code> has a facility for scanning for these and removing items that are very old.
Scans and removals are performed by implementations of the <code>&gt;com.arjuna.ats.arjuna.recovery.ExpiryScanner</code>.
Implementations of this interface are loaded by giving the class names as the value of the property <code>RecoveryEnvironmentBean.expiryScannerClassNames</code>.
The <code>RecoveryManager</code> calls the <code>scan</code> method on each loaded <code>ExpiryScanner</code> implementation at an interval determined by the property <code>RecoveryEnvironmentBean.expiryScanInterval</code>.
This value is given in hours, and defaults to <code>12</code>.
A property value of <code>0</code> disables any expiry scanning.
If the value as supplied is positive, the first scan is performed when <code>RecoveryManager</code> starts.
If the value is negative, the first scan is delayed until after the first interval, using the absolute value.</p>
</div>
<div class="paragraph">
<p>There are two kinds of item that are scanned for expiry:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contact items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One contact item is created by every application process that uses Narayana.
They contain the information that the <code>RecoveryManager</code> uses to determine if the process that initiated the transaction is still alive, and what the transaction status is.
The expiry time for these is set by the property <code>RecoveryEnvironmentBean.transactionStatusManagerExpiryTime</code>, which is expressed in hours.
The default is <code>12</code> , and <code>0</code> suppresses the expiration.
This is the interval after which a process that cannot be contacted is considered to be dead.
It should be long enough to avoid accidentally removing valid entries due to short-lived transient errors such as network downtime.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Assumed complete transactions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The expiry time is counted from when the transactions were assumed to be complete.
A <code>replay_completion</code> request resets the clock.
The risk with removing assumed complete transactions it that a prolonged communication outage means that a remote <code>Resource</code> cannot connect to the <code>RecoveryManager</code> for the parent transaction.
If the assumed complete transaction entry is expired before the communications are recovered, the eventual <code>replay_completion</code> will find no information and the <code>Resource</code> will be rolled back, although the transaction committed.
Consequently, the expiry time for assumed complete transactions should be set to a value that exceeds any anticipated network outage.
The parameter is <code>ASSUMED_COMPLETE_EXPIRY_TIME</code>.
It is expressed in hours, with <code>240</code> being the default, and <code>0</code> meaning never to expire.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">ExpiryScanner properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.expiryScannerClassNames</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    com.arjuna.ats.internal.arjuna.recovery.ExpiredTransactionStatusManagerScanner
    com.arjuna.ats.internal.jts.recovery.contact.ExpiredContactScanner
    com.arjuna.ats.internal.jts.recovery.transactions.ExpiredToplevelScanner
    com.arjuna.ats.internal.jts.recovery.transactions.ExpiredServerScanner
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two `ExpiryScannner&#8217;s for the assumed complete transactions, because there are different types in the ActionStore.</p>
</div>
</div>
<div class="sect5">
<h6 id="_recovery_domains"><a class="anchor" href="#_recovery_domains"></a>Recovery domains</h6>
<div class="paragraph">
<p>A key part of the recovery subsystem is that the <code>RecoveryManager</code> hosts the OTS <code>RecoveryCoordinator</code> objects that handle recovery for transactions initiated in application processes.
Information passes between the application process and the <code>RecoveryManager</code> in one of three ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>RecoveryCoordinator</code> object references (IORs) are created in the application process.
They contain information identifying the transaction in the object key.
They pass the object key to the <code>Resource</code> objects, and the <code>RecoveryManager</code> receives it.</p>
</li>
<li>
<p>The application process and the <code>RecoveryManager</code> access the same <code>jbossts-properties.xml</code>, and therefore use the same <code>ObjectStore</code>.</p>
</li>
<li>
<p>The <code>RecoveryCoordinator</code> invokes CORBA directly in the application, using information in the contact items.
Contact items are kept in the <code>ObjectStore</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Multiple recovery domains may useful if you are doing a migration, and separate <code>ObjectStores</code> are useful.
However, multiple RecoveryManagers can cause problems with XA datasources if resource-initiated recovery is active on any of them.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_transaction_status_and_replay_comparison"><a class="anchor" href="#_transaction_status_and_replay_comparison"></a>Transaction status and <code>replay_comparison</code></h5>
<div class="paragraph">
<p>When a transaction successfully commits, the transaction log is removed from the system.
The log is no longer required, since all registered Resources have responded successfully to the two-phase commit sequence.
However, if a <code>Resource</code> calls <code>replay_completion</code> on the <code>RecoveryCoordinator</code> after the transaction it represents commits, the status returned is <code>StatusRolledback</code>.
The transaction system does not keep a record of committed transactions, and assumes that in the absence of a transaction log, the transaction must have rolled back.
This is in line with the <code>presumed abort protocol</code> used by the OTS.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jta_and_jts"><a class="anchor" href="#_jta_and_jts"></a>4.2.9. JTA and JTS</h4>
<div class="sect4">
<h5 id="_distributed_jta"><a class="anchor" href="#_distributed_jta"></a>Distributed JTA</h5>
<div class="paragraph">
<p>This guide describes how to use the JTA interfaces for purely local transactions.
This is a high-performance implementation, but you can only use it to execute transactions within the same process.
If you need support for distributed transactions, the JTA needs to use the JTS.
Another advantage of this approach is interoperability with other JTS-compliant transaction systems.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you use the JTS and JTA interfaces to manage the same transactions, the JTA needs to be configured to be aware of the JTS.
Otherwise, local transactions will be unaware of their JTS counterparts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You need to do this configuration manually, because some applications may be using Narayana in a purely local manner, or may need to differentiate between transactions managed by JTS and JTA.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Making the JTA interfaces JTS-aware</div>
<ol class="arabic">
<li>
<p>Set <code>JTAEnvironmentBean.jtaTMImplementation</code> to <code>com.arjuna.ats.internal.jta.transaction.jts.TransactionManagerImple</code>.</p>
</li>
<li>
<p>Set <code>JTAEnvironmentBean.jtaUTImplementation</code> to <code>com.arjuna.ats.internal.jta.transaction.jts.UserTransactionImple</code>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_orb_specific_configuration"><a class="anchor" href="#_orb_specific_configuration"></a>4.2.10. ORB-specific configuration</h4>
<div class="sect4">
<h5 id="_jacorb_2"><a class="anchor" href="#_jacorb_2"></a>JacORB</h5>
<div class="paragraph">
<p>Take care to use only the patched version of JacORB shipped with Narayana.
Correct functioning of the transaction system, particularly with regard to crash recovery, is unlikely to work with an unpatched JacORB.
For each deployment of JacORB, ensure that the <code>jacorb.implname</code> in the <code>jacorb.properties</code> file is unique.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_orb_portability_2"><a class="anchor" href="#_orb_portability_2"></a>4.3. ORB Portability</h3>
<div class="sect3">
<h4 id="_orb_portability_introduction"><a class="anchor" href="#_orb_portability_introduction"></a>4.3.1. ORB Portability Introduction</h4>
<div class="paragraph">
<p>This part of the guide contains information on how to use the ORB Portability Layer.
Although the CORBA specification is a standard, it is written in such a way that allows for a wide variety of implementations.
Unless writing extremely simple applications, differences between ORB implementations tend to produce code which cannot easily be moved between ORBs.
This is especially true for server-side code, which suffers from the widest variation between ORBs.
There have also been a number of revisions of the Java language mapping for IDL and for CORBA itself.
Many ORBs currently in use support different versions of CORBA and/or the Java language mapping.</p>
</div>
<div class="paragraph">
<p>The Narayana only supports the new Portable Object Adapter (POA) architecture described in the CORBA 2.3 specification as a replacement for the Basic Object Adapter (BOA).
Unlike the BOA, which was weakly specified and led to a number of different (and often conflicting) implementations, the POA was deliberately designed to reduce the differences between ORB implementations, and thus minimize the amount of re-coding that would need to be done when porting applications from one ORB to another.
However, there is still scope for slight differences between ORB implementations, notably in the area of threading.
Note, instead of talking about the POA, this manual will consider the Object Adapter (OA).</p>
</div>
<div class="paragraph">
<p>Because the Narayana must be able to run on a number of different ORBs, we have developed an ORB portability interface which allows entire applications to be moved between ORBs with little or no modifications.
This portability interface is available to the application programmer in the form of several Java classes.
Note, the classes to be described in this document are located in the <code>com.arjuna.orbportability</code> package.</p>
</div>
</div>
<div class="sect3">
<h4 id="_orb_portability_api"><a class="anchor" href="#_orb_portability_api"></a>4.3.2. ORB Portability API</h4>
<div class="sect4">
<h5 id="_using_the_orb_and_oa"><a class="anchor" href="#_using_the_orb_and_oa"></a>Using the ORB and OA</h5>
<div class="paragraph">
<p>The <code>ORB</code> class shown below provides a uniform way of using the ORB.
There are methods for obtaining a reference to the ORB, and for placing the application into a mode where it listens for incoming connections.
There are also methods for registering application-specific classes to be invoked before or after ORB initialisation.
Note, some of the methods are not supported on all ORBs, and in this situation, a suitable exception will be thrown.
The ORB class is a factory class which has no public constructor.
To create an instance of an ORB you must call the getInstance method passing a unique name as a parameter.
If this unique name has not been passed in a previous call to <code>getInstance</code> you will be returned a new ORB instance.
Two invocations of getInstance made with the same unique name, within the same JVM, will return the same ORB instance.</p>
</div>
<div class="listingblock">
<div class="title"><em>ORB.java</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ORB</span> {
    <span class="directive">public</span> <span class="directive">static</span> ORB getInstance(<span class="predefined-type">String</span> uniqueId);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initORB() <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initORB(<span class="predefined-type">Applet</span> a, <span class="predefined-type">Properties</span> p) <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initORB(<span class="predefined-type">String</span><span class="type">[]</span> s, <span class="predefined-type">Properties</span> p) <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> org.omg.CORBA.ORB orb();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setOrb(org.omg.CORBA.ORB theORB);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> shutdown();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> addAttribute(<span class="predefined-type">Attribute</span> p);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> addPreShutdown(PreShutdown c);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> addPostShutdown(PostShutdown c);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> destroy() <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="type">void</span> run();

    <span class="directive">public</span> <span class="type">void</span> run(<span class="predefined-type">String</span> name);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We shall now describe the various methods of the ORB class.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>initORB</code>: given the various parameters, this method initialises the ORB and retains a reference to it within the ORB class.
This method should be used in preference to the raw ORB interface since the Narayana requires a reference to the ORB.
If this method is not used, setOrb must be called prior to using Narayana.</p>
</li>
<li>
<p><code>orb</code>: this method returns a reference to the ORB.
After shutdown is called this reference may be null.</p>
</li>
<li>
<p><code>shutdown</code>: where supported, this method cleanly shuts down the ORB.
Any pre- and post- ORB shutdown classes which have been registered will also be called.
See the section titled ORB and OA Initialisation.
This method must be called prior to application termination.
It is the application programmer&#8217;s responsibility to ensure that no objects or threads continue to exist which require access to the ORB.
It is ORB implementation dependant whether outstanding references to the ORB remain useable after this call.</p>
</li>
<li>
<p><code>addAttribute</code>: this method allows the application to register classes with Narayana which will be called either before, or after the ORB has been initialised.
See the section titled ORB and OA Initialisation.
If the ORB has already been initialised then the attribute object will not be added, and false will be returned.</p>
</li>
<li>
<p><code>run</code>: these methods place the ORB into a listening mode, where it waits for incoming invocations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The OA classes shown below provide a uniform way of using Object Adapters (OA).
There are methods for obtaining a reference to the OA.
There are also methods for registering application-specific classes to be invoked before or after OA initialisation.
Note, some of the methods are not supported on all ORBs, and in this situation, a suitable exception will be thrown.
The OA class is an abstract class and provides the basic interface to an Object Adapter.
It has two sub-classes <code>RootOA</code> and <code>ChildOA</code>, these classes expose the interfaces specific to the root Object Adapter and a child Object Adapter respectively.
From the <code>RootOA</code> you can obtain a reference to the <code>RootOA</code> for a given ORB by using the static method get`RootOA`.
To create a <code>ChildOA</code> instance use the createPOA method on the <code>RootOA</code>.</p>
</div>
<div class="listingblock">
<div class="title"><em>OA.java</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">OA</span> {
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="directive">static</span> RootOA getRootOA(ORB associatedORB);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initPOA() <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initPOA(<span class="predefined-type">String</span><span class="type">[]</span> args) <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initOA() <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> initOA(<span class="predefined-type">String</span><span class="type">[]</span> args) <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="directive">synchronized</span> ChildOA createPOA(
            <span class="predefined-type">String</span> adapterName, PolicyList policies)
            <span class="directive">throws</span> AdapterAlreadyExists, InvalidPolicy;

    <span class="directive">public</span> <span class="directive">synchronized</span> org.omg.PortableServer.POA rootPoa();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setPoa(org.omg.PortableServer.POA thePOA);

    <span class="directive">public</span> <span class="directive">synchronized</span> org.omg.PortableServer.POA poa(<span class="predefined-type">String</span> adapterName);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setPoa(<span class="predefined-type">String</span> adapterName, org.omg.PortableServer.POA thePOA);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> addAttribute(OAAttribute p);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> addPreShutdown(OAPreShutdown c);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> addPostShutdown(OAPostShutdown c);
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">RootOA</span> <span class="directive">extends</span> OA {
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> destroy() <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> org.omg.CORBA.Object corbaReference(Servant obj);

    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady(Servant obj, <span class="type">byte</span><span class="type">[]</span> id);

    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady(Servant obj);

    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject(org.omg.CORBA.Object obj);

    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject(Servant obj);
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">ChildOA</span> <span class="directive">extends</span> OA {
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> setRootPoa(POA thePOA);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> destroy() <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> org.omg.CORBA.Object corbaReference(Servant obj);

    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady(Servant obj, <span class="type">byte</span><span class="type">[]</span> id) <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="type">boolean</span> objectIsReady(Servant obj) <span class="directive">throws</span> SystemException;

    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject(org.omg.CORBA.Object obj);

    <span class="directive">public</span> <span class="type">boolean</span> shutdownObject(Servant obj);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We shall now describe the various methods of the OA class.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>initPOA</code>: this method activates the POA, if this method is called on the <code>RootPOA</code> the POA with the name <code>RootPOA</code> will be activated.</p>
</li>
<li>
<p><code>createPOA</code>: if a child POA with the specified name for the current POA has not already been created then this method will create and activate one, otherwise <code>AdapterAlreadyExists</code> will be thrown.
This method returns a <code>ChildOA</code> object.</p>
</li>
<li>
<p><code>initOA</code>: this method calls the initPOA method and has been retained for backwards compatibility.</p>
</li>
<li>
<p><code>rootPoa</code>: this method returns a reference to the root POA.
After destroy is called on the root POA this reference may be null.</p>
</li>
<li>
<p><code>poa</code>: this method returns a reference to the POA.
After destroy is called this reference may be null.</p>
</li>
<li>
<p><code>destroy</code>: this method destroys the current POA, if this method is called on a <code>RootPOA</code> instance then the root POA will be destroyed along with its children.</p>
</li>
<li>
<p><code>shutdown</code>: this method shuts down the POA.</p>
</li>
<li>
<p><code>addAttribute</code>: this method allows the application to register classes with Narayana which will be called either before or after the OA has been initialised.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See below.
If the OA has already been initialised then the attribute object will not be added, and false will be returned.</p>
</div>
<div class="sect5">
<h6 id="_orb_and_oa_initialisation"><a class="anchor" href="#_orb_and_oa_initialisation"></a>ORB and OA Initialisation</h6>
<div class="paragraph">
<p>It is possible to register application-specific code with the ORB portability library which can be executed either before or after the ORB or OA are initialised.
Application programs can inherit from either <code>com.arjuna.orbportability.orb.Attribute</code> or <code>com.arjuna.orbportability.oa.Attribute</code> and pass these instances to the addAttribute method of the ORB/OA classes respectively:</p>
</div>
<div class="listingblock">
<div class="title"><em>Attribute.java</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.arjuna.orbportability.orb</span>;

<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">Attribute</span> {
    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">void</span> initialise(<span class="predefined-type">String</span><span class="type">[]</span> params);

    <span class="directive">public</span> <span class="type">boolean</span> postORBInit();
}

<span class="keyword">package</span> <span class="namespace">com.arjuna.orbportability.oa</span>;

<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">OAAttribute</span> {
    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">void</span> initialise(<span class="predefined-type">String</span><span class="type">[]</span> params);

    <span class="directive">public</span> <span class="type">boolean</span> postOAInit();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the <code>postORBInit/postOAInit</code> methods return true, which means that any instances of derived classes will be invoked after either the ORB or OA have been initialised.
By redefining this to return false, a particular instance will be invoked before either the ORB or OA have been initialised.</p>
</div>
<div class="paragraph">
<p>When invoked, each registered instance will be provided with the exact String parameters passed to the initialise method for the ORB/OA.</p>
</div>
</div>
<div class="sect5">
<h6 id="_orb_and_oa_shutdown"><a class="anchor" href="#_orb_and_oa_shutdown"></a>ORB and OA shutdown</h6>
<div class="paragraph">
<p>It is possible to register application-specific code (via the <code>addPreShutdown/addPostShutdown</code> methods) with the ORB portability library which will be executed prior to, or after, shutting down the ORB.
The pre/post interfaces which are to be registered have a single work method, taking no parameters and returning no results.
When the ORB and OA are being shut down (using <code>shutdown/destroy</code> ), each registered class will have its work method invoked.</p>
</div>
<div class="listingblock">
<div class="title"><em>Shutdown.java</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">PreShutdown</span> {
    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">void</span> work();
}

<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">PostShutdown</span> {
    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">void</span> work();
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_specifying_the_orb_to_use_3"><a class="anchor" href="#_specifying_the_orb_to_use_3"></a>Specifying the ORB to use</h6>
<div class="paragraph">
<p>JDK releases from 1.2.2 onwards include a minimum ORB implementation from Sun.
If using such a JDK in conjunction with another ORB it is necessary to tell the JVM which ORB to use.
This happens by specifying the <code>org.omg.CORBA.ORBClass</code> and <code>org.omg.CORBA.ORBSingletonClass</code> properties.
The ORB Portability classes will ensure that these properties are automatically set when required, i.e., during ORB initialisation.
Of course, it is still possible to specify these values explicitly (and necessary if not using the ORB initialisation methods).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
if you do not use the ORB Portability classes for ORB initialisation then it will still be necessary to set these properties.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The ORB portability library attempts to detect which ORB is in use, it does this by looking for the ORB implementation class for each ORB it supports.
This means that if there are classes for more than one ORB in the classpath the wrong ORB can be detected.
Therefore, it is best to only have one ORB in your classpath.
If it is necessary to have multiple ORBs in the classpath then the property <code>OrbPortabilityEnvironmentBean.orbImplementation</code> must be set to the value specified in the table below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ORB</th>
<th class="tableblock halign-left valign-top">Property Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JacORB v2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.orbportability.internal.orbspecific.jacorb.orb.implementations.jacorb_2_0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDK miniORB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.arjuna.orbportability.internal.orbspecific.javaidl.orb.implementations.javaidl_1_4</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="_initialisation_code"><a class="anchor" href="#_initialisation_code"></a>Initialisation code</h6>
<div class="paragraph">
<p>The Narayana requires specialised code to be instantiated before and after the ORB and the OA are initialised.
This code can be provided at runtime through the use of <code>OrbPortabilityEnvironmentBean.orbInitializationProperties</code>.
This mechanism is also available to programmers who can register arbitrary code which the ORB Portability will guarantee to be instantiated either before or after ORB/OA initialisation.
For each application (and each execution of the same application) the programmer can simultaneously provide multiple Java classes which are instantiated before and after the ORB and or OA is initialised.
There are few restrictions on the types and numbers of classes which can be passed to an application at execution time.
All classes which are to be instantiated must have a public default constructor, i.e., a constructor which takes no parameters.
The classes can have any name.
The property names used must follow the format specified below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com..orbportability.orb.PreInit</code> – this property is used to specify a global pre-initialisation routine which will be run before any ORB is initialised.</p>
</li>
<li>
<p><code>com..orbportability.orb.PostInit</code> – this property is used to specify a global post-initialisation routine which will be run after any ORB is initialised.</p>
</li>
<li>
<p><code>com..orbportability.orb.&lt;ORB NAME&gt;.PreInit</code> – this property is used to specify a pre-initialisation routine which will be run when an ORB with the given name is initialised.</p>
</li>
<li>
<p><code>com..orbportability.orb.&lt;ORB NAME&gt;.PostInit</code> – this property is used to specify a post-initialisation routine which will be run after an ORB with the given name is initialised.</p>
</li>
<li>
<p><code>com..orbportability.oa.PreInit</code> – this property is used to specify a global pre-initialisation routine which will be run before any OA is initialised.</p>
</li>
<li>
<p><code>com..orbportability.oa.PostInit</code> – this property is used to specify a global post-initialisation routine which will be run after any OA is initialised,</p>
</li>
<li>
<p><code>com..orbportability.oa.&lt;ORB NAME&gt;.PreInit</code> – this property is used to specify a pre-initialisation routine which will be run before an OA with the given name is initialised</p>
</li>
<li>
<p><code>com..orbportability.oa.&lt;ORB NAME&gt;.PostInit</code> – this property is used to specify a pre-initialisation routine which will be run after an OA with the given name is initialised</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pre and post initialisation can be arbitrarily combined, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java –DorbPortabilityEnvironmentBean.orbInitializationProperties=”com..orbportability.orb.PreInit=org.foo.AllORBPreInit
  com..orbportability.orb.MyORB.PostInit=org.foo.MyOrbPostInit
  com..orbportability.oa.PostInit=orb.foo.AllOAPostInit” org.foo.MyMainClass</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_locating_objects_and_services"><a class="anchor" href="#_locating_objects_and_services"></a>Locating Objects and Services</h6>
<div class="paragraph">
<p>Locating and binding to distributed objects within CORBA can be ORB specific.
For example, many ORBs provide implementations of the naming service, whereas some others may rely upon proprietary mechanisms.
Having to deal with the many possible ways of binding to objects can be a difficult task, especially if portable applications are to be constructed.
ORB Portability provides the Services class in order to provide a more manageable, and portable binding mechanism.
The implementation of this class takes care of any ORB specific locations mechanisms, and provides a single interface to a range of different object location implementations.</p>
</div>
<div class="listingblock">
<div class="title"><em>Services.java</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Services</span> {
    <span class="comment">/**
     * The various means used to locate a service.
     */</span>

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> RESOLVE_INITIAL_REFERENCES = <span class="integer">0</span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> NAME_SERVICE = <span class="integer">1</span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> CONFIGURATION_FILE = <span class="integer">2</span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> FILE = <span class="integer">3</span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> NAMED_CONNECT = <span class="integer">4</span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> BIND_CONNECT = <span class="integer">5</span>;

    <span class="directive">public</span> <span class="directive">static</span> org.omg.CORBA.Object getService(
            <span class="predefined-type">String</span> serviceName, <span class="predefined-type">Object</span><span class="type">[]</span> params,
            <span class="type">int</span> mechanism) <span class="directive">throws</span> InvalidName,
            CannotProceed, NotFound, <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">static</span> org.omg.CORBA.Object getService(
            <span class="predefined-type">String</span> serviceName, <span class="predefined-type">Object</span><span class="type">[]</span> params)
            <span class="directive">throws</span> InvalidName, CannotProceed, NotFound,
            <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> registerService(
            org.omg.CORBA.Object objRef,
            <span class="predefined-type">String</span> serviceName, <span class="predefined-type">Object</span><span class="type">[]</span> params,
            <span class="type">int</span> mechanism) <span class="directive">throws</span> InvalidName, <span class="exception">IOException</span>,
            CannotProceed, NotFound;

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> registerService(
            org.omg.CORBA.Object objRef,
            <span class="predefined-type">String</span> serviceName, <span class="predefined-type">Object</span><span class="type">[]</span> params)
            <span class="directive">throws</span> InvalidName, <span class="exception">IOException</span>, CannotProceed,
            NotFound;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are currently several different object location and binding mechanisms supported by Services (not all of which are supported by all ORBs, in which case a suitable exception will be thrown):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>RESOLVE_INITIAL_REFERENCES</em>: if the ORB supported <code>resolve_initial_references</code>, then Services will attempt to use this to locate the object.</p>
</li>
<li>
<p><em>NAME_SERVICE</em>: Services will contact the name service for the object.
The name service will be located using <code>resolve_initial_references</code>.</p>
</li>
<li>
<p><em>CONFIGURATION_FILE</em>: as described in the Using the OTS Manual, the Narayana supports an initial reference file where references for specific services and objects can be stored and used at runtime.
The file, <code>CosServices.cfg</code>, consists of two columns: the service name (in the case of the OTS server TransactionService) and the IOR, separated by a single space.
<code>CosServices.cfg</code> is located at runtime by the <code>OrbPortabilityEnvironmentBean</code> properties <code>initialReferencesRoot</code> (a directory, defaulting to the current working directory) and <code>initialReferencesFile</code> (a name relative to the directory, <code>CosServices.cfg</code> by default).</p>
</li>
<li>
<p><em>FILE</em> : object IORs can be read from, and written to, application-specific files.
The service name is used as the file name.</p>
</li>
<li>
<p><em>NAMED_CONNECT</em> : some ORBs support proprietary location and binding mechanisms.</p>
</li>
<li>
<p><em>BIND_CONNECT</em> : some ORBs support the bind operation for locating services.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We shall now describe the various methods supported by the Services class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>getService</em>: given the name of the object or service to be located (serviceName), and the type of mechanism to be used (mechanism), the programmer must also supply location mechanism specific parameters in the form of params.
If the name service is being used, then params[0] should be the String kind field.</p>
</li>
<li>
<p><em>getService</em>: the second form of this method does not require a location mechanism to be supplied, and will use an ORB specific default.
The default for each ORB is shown in Table 2.</p>
</li>
<li>
<p><em>registerService</em>: given the object to be registered, the name it should be registered with, and the mechanism to use to register it, the application programmer must specify location mechanism specific parameters in the form of params.
If the name service is being used, then params[0] should be the String kind field.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_orb_location_mechanisms"><a class="anchor" href="#_orb_location_mechanisms"></a>ORB location mechanisms</h6>
<div class="paragraph">
<p>The following table summarises the different location mechanisms that ORB Portability supports for each ORB via the Services class:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Location Mechanism</th>
<th class="tableblock halign-left valign-top">ORB</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONFIGURATION_FILE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All available ORBs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FILE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All available ORBs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIND_CONNECT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If a location mechanism isn&#8217;t specified then the default is the configuration file.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_quick_start_to_jtsots"><a class="anchor" href="#_quick_start_to_jtsots"></a>4.3.3. Quick Start to JTS/OTS</h4>
<div class="sect4">
<h5 id="_introduction_9"><a class="anchor" href="#_introduction_9"></a>Introduction</h5>
<div class="paragraph">
<p>This chapter will briefly cover the key features required to construct a basic OTS application using the raw OTS interfaces defined by the OMG specification.
It is assumed that the reader is familiar with the concepts of the JTS/OTS and has read the relevant ORB specific portions of the Narayana.
Programmer&#8217;s Guide.
Further topics and the advanced facilities provided by Narayana will be described in subsequent sections of this manual; references to chapters in the other manuals of the document set will be given in the relevant sections.</p>
</div>
</div>
<div class="sect4">
<h5 id="_package_layout_2"><a class="anchor" href="#_package_layout_2"></a>Package layout</h5>
<div class="paragraph">
<p>The key Java packages (and corresponding jar files) for writing basic OTS applications are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.arjuna.orbportability</code>: this package contains the classes which constitute the ORB portability library and other useful utility classes.</p>
</li>
<li>
<p><code>org.omg.CosTransactions</code>: this package contains the classes which make up the CosTransactions.idl module.</p>
</li>
<li>
<p><code>com.arjuna.ats.jts</code>: this package contains the Narayana implementations of the JTS and JTA.</p>
</li>
<li>
<p><code>com.arjuna.ats.arjuna</code>: this package contains further classes necessary for the Narayana implementation of the JTS.</p>
</li>
<li>
<p><code>com.arjuna.ats.jta</code>: this package contains local and remote JTA implementation support.</p>
</li>
<li>
<p><code>com.arjuna.ats.jdbc</code>: this package contains transactional JDBC support.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of these packages appear in the lib directory of the Narayana installation, and should be added to the programmer&#8217;s CLASSPATH.</p>
</div>
<div class="paragraph">
<p>In order to fully utilize all of the facilities available within Narayana, it will be necessary to add the some additional jar files to your classpath.
See <code>bin/setup-env.sh</code> or <code>bin\setup-env.bat</code> for details.</p>
</div>
</div>
<div class="sect4">
<h5 id="_setting_properties_3"><a class="anchor" href="#_setting_properties_3"></a>Setting properties</h5>
<div class="paragraph">
<p>Narayana has been designed to be highly configurable at runtime through the use of various property attributes, which will be described in subsequent sections.
Although these attributes can be provided at runtime on the command line, it is possible (and may be more convenient) to specify them through the single properties file <code>Narayana-properties.xml</code>.
At runtime Narayana looks for its property file in the following order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a location specified by a system property, allowing the normal search path to be overridden.</p>
</li>
<li>
<p>the current working directory, i.e., where the application was executed from.</p>
</li>
<li>
<p>the user&#8217;s home directory.</p>
</li>
<li>
<p><code>java.home</code></p>
</li>
<li>
<p>the <code>CLASSPATH</code>, which normally includes the installations etc dir</p>
</li>
<li>
<p>A default set of properties embedded in the .jar file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Where properties are defined in both the system properties e.g. <code>-Dfoo=bar</code> and in the properties file, the value from the system property takes precedence.
This facilitates overriding individual properties easily on the command line.</p>
</div>
</div>
<div class="sect4">
<h5 id="_starting_and_terminating_the_orb_and_boapoa"><a class="anchor" href="#_starting_and_terminating_the_orb_and_boapoa"></a>Starting and terminating the ORB and BOA/POA</h5>
<div class="paragraph">
<p>It is important that Narayana is correctly initialised prior to any application object being created.
In order to guarantee this, the programmer must use the <code>initORB</code> and <code>initBOA</code>/<code>initPOA</code> methods of the <code>ORBInterface</code> class described in the ORB Portability Manual.
Using the <code>ORB_init</code> and <code>BOA_init</code>/<code>create_POA</code> methods provided by the underlying ORB will not be sufficient, and may lead to incorrectly operating applications.
For example:</p>
</div>
<div class="listingblock">
<div class="title">Initialize ORB</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    ORBInterface.initORB(args, <span class="predefined-constant">null</span>);
    ORBInterface.initOA();
    <span class="comment">//        . . .</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ORBInterface</code> class has operations <code>orb()</code> and <code>boa()</code>/<code>poa()</code>/<code>rootPoa()</code> for returning references to the orb and boa/child POA/root POA respectively after initialization has been performed.
If the ORB being used does not support the BOA (e.g., Sun&#8217;s JDK 1.2) then <code>boa()</code> does not appear in the class definition, and initBOA will do nothing.</p>
</div>
<div class="paragraph">
<p>In addition, it is necessary to use shutdownOA and shutdownORB (in that order) prior to terminating an application to allow Narayana to perform necessary cleanup routines.
<code>shutdownOA</code> routine will either shutdown the BOA or the POA depending upon the ORB being used.</p>
</div>
<div class="listingblock">
<div class="title">Shutdown ORB</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
    <span class="comment">// . . .</span>
    ORBInterface.shutdownOA();
    ORBInterface.shutdownORB();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>No further CORBA objects should be used once shutdown has been called.
It will be necessary to re-initialise the BOA/POA and ORB in such an event.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the rest of this document we shall use the term Object Adapter to mean either the Basic Object Adapter (BOA) or the Portable Object Adapter (POA).
In addition, where possible we shall use the ORB Portability classes which attempt to mask the differences between POA and BOA.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_specifying_the_object_store_location_2"><a class="anchor" href="#_specifying_the_object_store_location_2"></a>Specifying the object store location</h5>
<div class="paragraph">
<p>Narayana requires an object store in order to persistently record the outcomes of transactions in the event of failures.
In order to specify the location of the object store it is necessary to specify the location when the application is executed; for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java –DObjectStoreEnvironmentBean.objectStoreDir=/var/tmp/ObjectStore myprogram</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default location is a directory under the current execution directory.</p>
</div>
<div class="paragraph">
<p>By default, all object states will be stored within the defaultStore subdirectory of the object store root, e.g., <code>/usr/local/Arjuna/TransactionService/ObjectStore/defaultStore</code>.
However, this subdirectory can be changed by setting the <code>ObjectStoreEnvironmentBean.localOSRoot</code> property variable accordingly.</p>
</div>
</div>
<div class="sect4">
<h5 id="_implicit_transaction_propagation_and_interposition"><a class="anchor" href="#_implicit_transaction_propagation_and_interposition"></a>Implicit transaction propagation and interposition</h5>
<div class="paragraph">
<p>Transactions can be created within one domain (e.g., process) and used within another.
Therefore, information about a transaction (the transaction context) needs to be propagated between these domains.
This can be accomplished in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Explicit propagation</em> means that an application propagates a transaction context by passing context objects (instances of the Control interface or the PropagationContext structure) defined by the Transaction Service as explicit parameters.
Note, for efficiency reasons it is recommended that the PropagationContext be passed, rather than the Control.</p>
</li>
<li>
<p><em>Implicit propagation</em> means that requests on objects are implicitly associated with the client&#8217;s transaction; they share the client&#8217;s transaction context.
The context is transmitted implicitly to the objects, without direct client intervention.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OTS objects supporting the Control interface are standard CORBA objects.
When the interface is passed as a parameter in some operation call to a remote server only an object reference is passed.
This ensures that any operations that the remote object performs on the interface (such as registering resources as participants within the transaction) are performed on the real object.
However, this can have substantial penalties for the application if it frequently uses these interfaces due to the overheads of remote invocation.
To avoid this overhead Narayana supports interposition, whereby the server creates a local object which acts as a proxy for the remote transaction and fields all requests that would normally have been passed back to the originator.
This surrogate registers itself with the original transaction coordinator to enable it to correctly participate in the termination of the transaction.
Interposed coordinators effectively form a tree structure with their parent coordinators.
This is shown in the figure below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/interposition.gif" alt="interposition">
</div>
<div class="title">Figure 32. Interposition relationship</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>implicit transaction propagation does not imply interposition will be used at the server, but (typically) interposition requires implicit propagation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If implicit context propagation and interposition are required, then the programmer must ensure that Narayana is correctly initialised prior to objects being created; obviously it is necessary for both client and server to agree on which, if any, protocol (implicit or interposition) is being used.
Implicit context propagation is only possible on those ORBs which either support filters/interceptors, or the CosTSPortability interface.
Currently this is JacORB and the JDK miniORB.
Depending upon which type of functionality is required, the programmer must perform the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implicit context propagation: set the <code>JTSEnvironmentBean.contextPropMode</code> property variable to <code>CONTEXT</code>.</p>
</li>
<li>
<p>Interposition: set the <code>JTSEnvironmentBean.contextPropMode</code> property variable to <code>INTERPOSITION</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If using the Narayana advanced API then interposition is <em>required</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_obtaining_current"><a class="anchor" href="#_obtaining_current"></a>Obtaining Current</h5>
<div class="paragraph">
<p>The Current pseudo object can be obtained from the <code>com.arjuna.ats.jts.OTSManager</code> class using its <code>get_current()</code> method.</p>
</div>
</div>
<div class="sect4">
<h5 id="_transaction_termination"><a class="anchor" href="#_transaction_termination"></a>Transaction termination</h5>
<div class="paragraph">
<p>It is implementation dependant as to how long a Control remains able to access a transaction after it terminates.
In Narayana, if using the Current interface then all information about a transaction is destroyed when it terminates.
Therefore, the programmer should not use any Control references to the transaction after issuing the commit/rollback operations.</p>
</div>
<div class="paragraph">
<p>However, if the transaction is terminated explicitly using the Terminator interface then information about the transaction will be removed when all outstanding references to it are destroyed.
However, the programmer can signal that the transaction information is no longer required using the destroyControl method of the OTS class in the <code>com.arjuna.CosTransactions</code> package.
Once the program has indicated that the transaction information is no longer required, the same restrictions to using Control references apply as described above.</p>
</div>
</div>
<div class="sect4">
<h5 id="_transaction_factory_2"><a class="anchor" href="#_transaction_factory_2"></a>Transaction factory</h5>
<div class="paragraph">
<p>By default, Narayana does not use a separate transaction manager when creating transactions through the Current interface.
Each transactional client essentially has its own transaction manager (<code>TransactionFactory</code>) which is co-located with it.
By setting the <code>com.arjuna.ats.jts.transactionManager</code> property variable to YES this can be overridden at runtime.
The transaction factory is located in the bin directory of the Narayana distribution, and should be started by executing the <code>start-transaction-service</code> script located in <code>&lt;ats_root&gt;/bin</code>.</p>
</div>
<div class="paragraph">
<p>Typically Current locates the factory using the <code>CosServices.cfg</code> file.
This file is similar to <code>resolve_initial_references</code>, and is automatically updated (or created) when the transaction factory is started on a particular machine.
This file must be copied to the installation of all machines which require to share the same transaction factory.
<code>CosServices.cfg</code> is located at runtime by the <code>OrbPortabilityEnvironmentBean</code> properties <code>initialReferencesRoot</code> (a directory, defaulting to the current working directory) and <code>initialReferencesFile</code> (a name relative to the directory,<code>CosServices.cfg</code> by default).</p>
</div>
<div class="paragraph">
<p>It is possible to override the default location mechanism by using the <code>OrbPortabilityEnvironmentBean.resolveService</code> property variable.
This can have one of the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CONFIGURATION_FILE</code>: the default, this causes the system to use the <code>CosServices.cfg</code> file.</p>
</li>
<li>
<p><code>NAME_SERVICE</code>: Narayana will attempt to use a name service to locate the transaction factory.
If this is not supported, an exception will be thrown.</p>
</li>
<li>
<p><code>BIND_CONNECT</code>: Narayana will use the ORB-specific bind mechanism.
If this is not supported, an exception will be thrown.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If <code>OrbPortabilityEnvironmentBean.resolveService</code> is specified when the transaction factory is run, then the factory will register itself with the specified resolution mechanism.</p>
</div>
</div>
<div class="sect4">
<h5 id="_recovery_manager"><a class="anchor" href="#_recovery_manager"></a>Recovery manager</h5>
<div class="paragraph">
<p>You will need to start the recovery manager subsystem to ensure that transactions are recovered despite failures.
In order to do this, you should run the <code>start-recovery-manager</code> script in <code>&lt;ats_root&gt;/bin</code>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_xts"><a class="anchor" href="#_xts"></a>5. XTS</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_10"><a class="anchor" href="#_introduction_10"></a>5.1. Introduction</h3>
<div class="paragraph">
<p>The <em>XML Transaction Service (XTS)</em> component of Narayana supports the coordination of private and public Web Services in a business transaction.
Therefore, to understand XTS, you must be familiar with Web Services, and also understand something about transactions.
This chapter introduces XTS and provides a brief overview of the technologies that form the Web Services standard.
Additionally, this chapter explores some of the fundamentals of transactioning technology and how it can be applied to Web Services.
Much of the content presented in this chapter is detailed throughout this guide.
However, only overview information about Web Services is provided.
If you are new to creating Web services, please consult your Web Services platform documentation.</p>
</div>
<div class="paragraph">
<p>Narayana provides the XTS component as a transaction solution for Web Services.
Using XTS, business partners can coordinate complex business transactions in a controlled and reliable manner.
The XTS API supports a transactional coordination model based on the <em>WS-Coordination</em>, <em>WS-Atomic Transaction</em>, and <em>WS-Business Activity</em> specifications.</p>
</div>
<div class="paragraph">
<p>Protocols Included in XTS</p>
</div>
<div class="ulist">
<ul>
<li>
<p>WS-Coordination (WS-C) is a generic coordination framework developed by IBM, Microsoft and BEA.</p>
</li>
<li>
<p>WS-Atomic Transaction (WS-AT) and WS-Business Activity (WS-BA) together comprise the WS-Transaction (WS-T) transaction protocols that utilize this framework.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Narayana implements versions 1.1, and 1.2 of these three specifications.
Version specifications are available from <a href="http://www.oasis-open.org/specs/" class="bare">http://www.oasis-open.org/specs/</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The 1.1, and 1.2 specifications only differ in a small number of details.
The rest of this document employs version 1.1 of these specifications when providing explanations and example code.
On the few occasions where the modifications required to adapt these to the 1.1 specifications are not obvious, an explanatory note is provided.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>Web Services</em> are modular, reusable software components that are created by exposing business functionality through a Web service interface.
Web Services communicate directly with other Web Services using standards-based technologies such as SOAP and HTTP.
These standards-based communication technologies enable customers, suppliers, and trading partners to access Web Services, independent of hardware operating system, or programming environment.
The result is a vastly improved collaboration environment as compared to today&#8217;s EDI and <em class="term">business-to-business (B2B)</em> solutions; an environment where businesses can expose their current and future business applications as Web Services that can be easily discovered and accessed by external partners.</p>
</div>
<div class="paragraph">
<p>Web Services, by themselves, are not fault-tolerant.
In fact, some of the reasons that the Web Services model is an attractive development solution are also the same reasons that service-based applications may have drawbacks.</p>
</div>
<div class="paragraph">
<p>Properties of Web Services:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Application components that are exposed as Web Services may be owned by third parties, which provides benefits in terms of cost of maintenance, but drawbacks in terms of having exclusive control over their behaviour.</p>
</li>
<li>
<p>Web Services are usually remotely located, increasing risk of failure due to increased network travel for invocations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Applications that have high dependability requirements need a method of minimising the effects of errors that may occur when an application consumes Web Services.
One method of safeguarding against such failures is to interact with an application&#8217;s Web Services within the context of a <em>transaction</em>.
A transaction is a unit of work which is completed entirely, or in the case of failures is reversed to some agreed consistent state.
The goal, in the event of a failure, is normally to appear as if the work had never occurred in the first place.
With XTS, transactions can span multiple Web Services, meaning that work performed across multiple enterprises can be managed with transactional support.</p>
</div>
<div class="sect3">
<h4 id="_managing_service_based_processes"><a class="anchor" href="#_managing_service_based_processes"></a>5.1.1. Managing service-Based Processes</h4>
<div class="paragraph">
<p>XTS allows you to create transactions that drive complex business processes, spanning multiple Web Services.
Current Web Services standards do not address the requirements for a high-level coordination of services.
This is because in today&#8217;s Web Services applications, which use single request/receive interactions, coordination is typically not a problem.
However, for applications that engage multiple services among multiple business partners, coordinating and controlling the resulting interactions is essential.
This becomes even more apparent when you realise that you generally have little in the way of formal guarantees when interacting with third-party Web Services.</p>
</div>
<div class="paragraph">
<p>XTS provides the infrastructure for coordinating services during a business process.
By organising processes as transactions, business partners can collaborate on complex business interactions in a reliable manner, insuring the integrity of their data - usually represented by multiple changes to a database – but without the usual overheads and drawbacks of directly exposing traditional transaction-processing engines directly onto the web.
<a href="#example_application">An Evening On the Town</a> demonstrates how an application may manage service-based processes as transactions:</p>
</div>
<div id="example_application" class="paragraph">
<div class="title">An Evening On the Town</div>
<p>The application in question allows a user to plan a social evening.
This application is responsible for reserving a table at a restaurant, and reserving tickets to a show.
Both activities are paid for using a credit card.
In this example, each service represents exposed Web Services provided by different service providers.
XTS is used to envelop the interactions between the theater and restaurant services into a single (potentially) long-running business transaction.
The business transaction must insure that seats are reserved both at the restaurant and the theater.
If one event fails the user has the ability to decline both events, thus returning both services back to their original state.
If both events are successful, the user&#8217;s credit card is charged and both seats are booked.
As you may expect, the interaction between the services must be controlled in a reliable manner over a period of time.
In addition, management must span several third-party services that are remotely deployed.</p>
</div>
<div class="paragraph">
<p>Without the backing of a transaction, an undesirable outcome may occur.
For example, the user credit card may be charged, even if one or both of the bookings fail.</p>
</div>
<div class="paragraph">
<p><a href="#example_application">An Evening On the Town</a> describes the situations where XTS excels at supporting business processes across multiple enterprises.
This example is further refined throughout this guide, and appears as a standard demonstrator (including source code) with the XTS distribution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_servlets"><a class="anchor" href="#_servlets"></a>5.1.2. Servlets</h4>
<div class="paragraph">
<p>The WS-Coordination, WS-Atomic Transaction, and WS-Business Activity protocols are based on one-way interactions of entities rather than traditional synchronous request/response RPC-style interactions.
One group of entities, called transaction participants, invoke operations on other entities, such as the transaction coordinator, in order to return responses to requests.
The programming model is based on peer-to-peer relationships, with the result that all services, whether they are participants, coordinators or clients, must have an <em>active component</em> that allows them to receive unsolicited messages.</p>
</div>
<div class="paragraph">
<p>In XTS, the active component is achieved through deployment of JaxWS endpoints.
Each XTS endpoint that is reachable through SOAP/XML is published via JaxWS, without developer intervention.
The only requirement is that transactional client applications and transactional web services must reside within a domain capable of hosting JaxWS endpoints, such as an application server.
WildFly Application Server can provide this functionality.</p>
</div>
</div>
<div class="sect3">
<h4 id="_soap"><a class="anchor" href="#_soap"></a>5.1.3. SOAP</h4>
<div class="paragraph">
<p>SOAP has emerged as the de facto message format for XML-based communication in the Web Services arena.
It is a lightweight protocol that allows the user to define the content of a message and to provide hints as to how recipients should process that message.</p>
</div>
</div>
<div class="sect3">
<h4 id="_web_services_description_language_wdsl"><a class="anchor" href="#_web_services_description_language_wdsl"></a>5.1.4. Web Services Description Language (WDSL)</h4>
<div class="paragraph">
<p><em>Web Services Description Language (WSDL)</em> is an XML-based language used to define Web service interfaces.
An application that consumes a Web service parses the service&#8217;s WSDL document to discover the location of the service, the operations that the service supports, the protocol bindings the service supports (SOAP, HTTP, etc), and how to access them.
For each operation, WSDL describes the format that the client must follow.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transactions_overview"><a class="anchor" href="#_transactions_overview"></a>5.2. Transactions Overview</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This chapter deals with the theory of transactional Web Services.
If you are familiar with these principles, consider this chapter a reference.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Transactions have emerged as the dominant paradigm for coordinating interactions between parties in a distributed system, and in particular to manage applications that require concurrent access to shared data.
Much of the XTS API is based on contemporary transaction APIs whose familiarity will enhance developer productivity and lessen the learning curve.
While the following section provides the essential information that you should know before starting to use XTS for building transactional Web Services, it should not be treated as a definitive reference to all transactional technology.</p>
</div>
<div class="paragraph">
<p>A transaction is a unit of work that encapsulates multiple database actions such that that either all the encapsulated actions fail or all succeed.</p>
</div>
<div class="paragraph">
<p>Transactions ensure data integrity when an application interacts with multiple datasources.</p>
</div>
<div class="paragraph">
<p>The main components involved in using and defining transactional Web Services using XTS are illustrated in <a href="#fig_web_services_transaction">Components Involved in an XTS Transaction</a>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="fig_web_services_transaction" class="imageblock text-center">
<div class="content">
<img src="images/xts-fig-web-services-transaction.png" alt="xts fig web services transaction">
</div>
<div class="title">Figure 33. Components Involved in an XTS Transaction</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Transaction Service</dt>
<dd>
<p>The Transaction Service captures the model of the underlying transaction protocol and coordinates parties affiliated with the transaction according to that model.</p>
</dd>
<dt class="hdlist1">Transaction API</dt>
<dd>
<p>Provides an interface for transaction demarcation and the registration of participants.</p>
</dd>
<dt class="hdlist1">A Participant</dt>
<dd>
<p>The entity that cooperates with the transaction service on behalf of its associated business logic.</p>
</dd>
<dt class="hdlist1">The Context</dt>
<dd>
<p>Captures the necessary details of the transaction such that participants can enlist within its scope.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_coordinator"><a class="anchor" href="#_the_coordinator"></a>5.2.1. The Coordinator</h4>
<div class="paragraph">
<p>Every transaction is associated with a coordinator, which is responsible for governing the outcome of the transaction.
When a client begins a Web Service transaction it posts a <em>create</em> request to a coordination service, which creates the coordinator and returns its details to the client.
This service may be located in its own container or may be colocated with the application client or with one of the transactional web services for improved performance.
The coordination service is typically responsible for managing many transactions in parallel, so each coordinator is identified by a unique transaction identifier.</p>
</div>
<div class="paragraph">
<p>The coordinator is responsible for ensuring that the web services invoked by the client arrive at a consistent outcome.
When the client asks the coordinator to complete the transaction, the coordinator ensures that each web service is ready to confirm any provisional changes it has made within the scope of the transaction.
It then asks them all to make their changes permanent.
If any of the web services indicates a problem at the confirmation stage, the coordinator ensures that all web services reject their provisional changes, reverting to the state before the transaction started.
The coordinator also reverts all changes if the client asks it to cancel the transaction.</p>
</div>
<div class="paragraph">
<p>The negotiation between the coordinator and the web services is organized to ensure that all services will make their changes permanent, or all of them will revert to the previous state, even if the coordinator or one of the web services crashes part of the way through the transaction."</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_transaction_context"><a class="anchor" href="#_the_transaction_context"></a>5.2.2. The Transaction Context</h4>
<div class="paragraph">
<p>In order for a transaction to span a number of services, certain information has to be shared between those services, to propagate information about the transaction.
This information is known as the <em>Context</em>.
The coordination service hands a context back to the application client when it begins a transaction.
This context is passed as an extra, hidden parameter whenever the client invokes a transactional web service.
The XTS implementation saves and propagates this context automatically with only minimal involvement required on the part of the client.
However, it is still helpful to understand what information is captured in a context.
This information is listed in the following section.</p>
</div>
<div class="dlist">
<div class="title">Contents of a Context</div>
<dl>
<dt class="hdlist1">Transaction Identifier</dt>
<dd>
<p>Guarantees global uniqueness for an individual transaction.</p>
</dd>
<dt class="hdlist1">Transaction Coordinator Location</dt>
<dd>
<p>The endpoint address participants contact to enroll.</p>
</dd>
</dl>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/xts-fig-web-services-context-flow.png" alt="xts fig web services context flow">
</div>
<div class="title">Figure 34. Web Services and Context Flow</div>
</div>
<div class="paragraph">
<p>Whenever an application message is sent, the XTS Client API automatically creates a context and embeds it into the message.
Similarly, any transaction-aware services can extract that context using the XTS service-side infrastructure and use it to perform work within the context of a particular transaction, even if that transaction was initiated elsewhere on the Web.
The value of this approach is that the business logic contained within the client application and services are not peppered with transaction-processing code.</p>
</div>
</div>
<div class="sect3">
<h4 id="_participants"><a class="anchor" href="#_participants"></a>5.2.3. Participants</h4>
<div class="paragraph">
<p>The coordinator cannot know the details of how every transactional service is implemented.
In fact this knowledge is not even necessary for it to negotiate a transactional outcome.
It treats each service taking part in a transaction as a participant and communicates with it according to some predefined participant coordination models appropriate to the type of transaction.
When a web service receives its first service request in some given transaction, it enrolls with the coordinator as a participant, specifying the participant model it wishes to follow.
The context contains a URL for the endpoint of the coordination service which handles enrollment requests.
So, the term participant merely refers a transactional service enrolled in a specific transaction using a specific participant model.</p>
</div>
</div>
<div class="sect3">
<h4 id="_acid_transactions"><a class="anchor" href="#_acid_transactions"></a>5.2.4. ACID Transactions</h4>
<div class="paragraph">
<p>Traditionally, transaction processing systems support <em>ACID</em> properties.
ACID is an acronym for <em>A</em> tomic, <em>C</em> onsistent, <em>I</em> solated, and <em>D</em> urable.
A unit of work has traditionally been considered transactional only if the ACID properties are maintained, as describe in <a href="#acid_properties">ACID Properties</a>.</p>
</div>
<div id="acid_properties" class="dlist">
<div class="title">ACID Properties</div>
<dl>
<dt class="hdlist1">Atomicity</dt>
<dd>
<p>The transaction executes completely, or not at all.</p>
</dd>
<dt class="hdlist1">Consistency</dt>
<dd>
<p>The effects of the transaction preserve the internal consistency of an underlying data structure.</p>
</dd>
<dt class="hdlist1">Isolated</dt>
<dd>
<p>The transaction runs as if it were running alone, with no other transactions running, and is not visible to other transactions.</p>
</dd>
<dt class="hdlist1">Durable</dt>
<dd>
<p>The transaction&#8217;s results are not lost in the event of a failure.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_two_phase_commit_3"><a class="anchor" href="#_two_phase_commit_3"></a>5.2.5. Two Phase Commit</h4>
<div class="paragraph">
<p>The classical two-phase commit approach is the bedrock of Narayana, and more generally of Web Services transactions.
Two-phase commit provides coordination of parties that are involved in a transaction.
The general flow of a two-phase commit transaction is described in <a href="#two_phase_commit_overview">Two-Phase Commit Overview</a>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="two_phase_commit_overview" class="imageblock text-center">
<div class="content">
<img src="images/xts-fig-two-phase-commit-overview.png" alt="xts fig two phase commit overview">
</div>
<div class="title">Figure 35. Two-Phase Commit Overview</div>
</div>
<div class="ulist">
<ul>
<li>
<p>A transaction is started, and some work is performed.</p>
</li>
<li>
<p>Once the work is finished, the two-phase commit begins.</p>
</li>
<li>
<p>The coordinator (transaction manager) of the transaction asks each resource taking part in the transaction whether it is prepared to commit.</p>
</li>
<li>
<p>If all resources respond positively, the coordinator instructs the resources to make all work performed durable (usually committed to a database).</p>
</li>
<li>
<p>If not, all work performed is rolled back (undone) such that the underlying data structures are in their original states.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>During two-phase commit transactions, coordinators and resources keep track of activity in non-volatile data stores so that they can recover in the case of a failure.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_synchronization_protocol"><a class="anchor" href="#_the_synchronization_protocol"></a>5.2.6. The Synchronization Protocol</h4>
<div class="paragraph">
<p>Besides the two-phase commit protocol, traditional transaction processing systems employ an additional protocol, often referred to as the <em>synchronization protocol</em>.
With the original ACID properties, Durability is important when state changes need to be available despite failures.
Applications interact with a persistence store of some kind, such as a database, and this interaction can impose a significant overhead, because disk access is much slower to access than main computer memory.</p>
</div>
<div class="paragraph">
<p>One solution to the problem disk access time is to cache the state in main memory and only operate on the cache for the duration of a transaction.
Unfortunately, this solution needs a way to flush the state back to the persistent store before the transaction terminates, or risk losing the full ACID properties.
This is what the synchronization protocol does, with <em>Synchronization Participants</em>.</p>
</div>
<div class="paragraph">
<p>Synchronizations are informed that a transaction is about to commit.
At that point, they can flush cached state, which might be used to improve performance of an application, to a durable representation prior to the transaction committing.
The synchronizations are then informed about when the transaction completes and its completion state.</p>
</div>
<div class="paragraph">
<div class="title">Procedure: The "Four Phase Protocol" Created By Synchronizations</div>
<p>Synchronizations essentially turn the two-phase commit protocol into a four-phase protocol:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Step 1</p>
<div class="paragraph">
<p>Before the transaction starts the two-phase commit, all registered Synchronizations are informed.
Any failure at this point will cause the transaction to roll back.</p>
</div>
</li>
<li>
<p>Step 2 and 3</p>
<div class="paragraph">
<p>The coordinator then conducts the normal two-phase commit protocol.</p>
</div>
</li>
<li>
<p>Step 4</p>
<div class="paragraph">
<p>Once the transaction has terminated, all registered Synchronizations are informed.
However, this is a courtesy invocation because any failures at this stage are ignored: the transaction has terminated so there&#8217;s nothing to affect.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The synchronization protocol does not have the same failure requirements as the traditional two-phase commit protocol.
For example, Synchronization participants do not need the ability to recover in the event of failures, because any failure before the two-phase commit protocol completes cause the transaction to roll back, and failures after it completes have no effect on the data which the Synchronization participants are responsible for.</p>
</div>
</div>
<div class="sect3">
<h4 id="_optimizations_to_the_protocol"><a class="anchor" href="#_optimizations_to_the_protocol"></a>5.2.7. Optimizations to the Protocol</h4>
<div class="paragraph">
<p>There are several variants to the standard two-phase commit protocol that are worth knowing about, because they can have an impact on performance and failure recovery.
<a href="#xts_two_phase_variants">Variants to the Two-Phase Commit Protocol</a> gives more information about each one.</p>
</div>
<table id="xts_two_phase_variants" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Variants to the Two-Phase Commit Protocol</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variant</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Presumed Abort</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If a transaction is going to roll back, the coordinator may record this information locally and tell all enlisted participants.
Failure to contact a participant has no effect on the transaction outcome.
The coordinator is informing participants only as a courtesy.
Once all participants have been contacted, the information about the transaction can be removed.
If a subsequent request for the status of the transaction occurs, no information will be available and the requester can assume that the transaction has aborted.
This optimization has the benefit that no information about participants need be made persistent until the transaction has progressed to the end of the <code>prepare</code> phase and decided to commit, since any failure prior to this point is assumed to be an abort of the transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">One-Phase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If only a single participant is involved in the transaction, the coordinator does not need to drive it through the <code>prepare</code> phase.
Thus, the participant is told to commit, and the coordinator does not need to record information about the decision, since the outcome of the transaction is the responsibility of the participant.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-Only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When a participant is asked to prepare, it can indicate to the coordinator that no information or data that it controls has been modified during the transaction.
Such a participant does not need to be informed about the outcome of the transaction since the fate of the participant has no affect on the transaction.
Therefore, a read-only participant can be omitted from the second phase of the commit protocol.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The WS-Atomic Transaction protocol does not support the one-phase commit optimisation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_non_atomic_transactions_and_heuristic_outcomes"><a class="anchor" href="#_non_atomic_transactions_and_heuristic_outcomes"></a>5.2.8. Non-Atomic Transactions and Heuristic Outcomes</h4>
<div class="paragraph">
<p>In order to guarantee atomicity, the two-phase commit protocol is <em>blocking</em>.
As a result of failures, participants may remain blocked for an indefinite period of time, even if failure recovery mechanisms exist.
Some applications and participants cannot tolerate this blocking.</p>
</div>
<div class="paragraph">
<p>To break this blocking nature, participants that are past the <em>prepare</em> phase are allowed to make autonomous decisions about whether to commit or rollback.
Such a participant must record its decision, so that it can complete the original transaction if it eventually gets a request to do so.
If the coordinator eventually informs the participant of the transaction outcome, and it is the same as the choice the participant made, no conflict exists.
If the decisions of the participant and coordinator are different, the situation is referred to as a non-atomic outcome, and more specifically as a <em>heuristic outcome</em>.</p>
</div>
<div class="paragraph">
<p>Resolving and reporting heuristic outcomes to the application is usually the domain of complex, manually driven system administration tools, because attempting an automatic resolution requires semantic information about the nature of participants involved in the transactions.</p>
</div>
<div class="paragraph">
<p>Precisely when a participant makes a heuristic decision depends on the specific implementation.
Likewise, the choice the participant makes about whether to commit or to roll back depends upon the implementation, and possibly the application and the environment in which it finds itself.
The possible heuristic outcomes are discussed in <a href="#tbl_heuristic_outcomes">Heuristic Outcomes</a>.</p>
</div>
<table id="tbl_heuristic_outcomes" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Heuristic Outcomes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Outcome</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heuristic Rollback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The commit operation failed because some or all of the participants unilaterally rolled back the transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heuristic Commit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An attempted rollback operation failed because all of the participants unilaterally committed.
One situation where this might happen is if the coordinator is able to successfully <code>prepare</code> the transaction, but then decides to roll it back because its transaction log could not be updated.
While the coordinator is making its decision, the participants decide to commit.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heuristic Mixed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Some participants committed, while others were rolled back.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heuristic Hazard</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The disposition of some of the updates is unknown.
For those which are known, they have either all been committed or all rolled back.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Heuristic decisions should be used with care and only in exceptional circumstances, since the decision may possibly differ from that determined by the transaction service.
This type of difference can lead to a loss of integrity in the system.
Try to avoid needing to perform resolution of heuristics, either by working with services and participants that do not cause heuristics, or by using a transaction service that provides assistance in the resolution process.</p>
</div>
</div>
<div class="sect3">
<h4 id="_interposition_2"><a class="anchor" href="#_interposition_2"></a>5.2.9. Interposition</h4>
<div class="paragraph">
<p><em>Interposition</em> is a scoping mechanism which allows coordination of a transaction to be delegated across a hierarchy of coordinators.
See <a href="#fig_interpositions">Interpositions</a> for a graphical representation of this concept.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="fig_interpositions" class="imageblock text-center">
<div class="content">
<img src="images/xts-fig-interpositions.png" alt="xts fig interpositions">
</div>
<div class="title">Figure 36. Interpositions</div>
</div>
<div class="paragraph">
<p>The diagram shows a top-level coordinator and an interposed coordinator.
The top-level coordinator is responsible for driving the original, top-level transaction to completion or rollback.
The interposed coordinator manages its participants in a subordinate transaction, but it cannot act autonomously.
From the point of view of the parent coordinator, it appears to be another participant in the top-level transaction.
The interposed coordinator operates as an intermediary.
It forwards incoming prepare and commit/rollback messages to its participants, combining their responses and returning them back to its parent coordinator.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Interposition is particularly useful for Web Services transactions, as a way of limiting the amount of network traffic required for coordination.
For example, if communications between the top-level coordinator and a web service are slow because of network traffic or distance, the web service might benefit from executing in a subordinate transaction which employs a local coordinator service.
In <a href="#fig_interpositions">Interpositions</a>,to <em>prepare</em> , the top-level coordinator only needs to send one <em>prepare</em> message to the subordinate coordinator, and receive one <em>prepared</em> or <em>aborted</em> reply.
The subordinate coordinator forwards a <em>prepare</em> locally to each participant and combines the results to decide whether to send a single <em>prepared</em> or <em>aborted</em> reply.</p>
</div>
</div>
<div class="sect3">
<h4 id="_a_new_transaction_protocol"><a class="anchor" href="#_a_new_transaction_protocol"></a>5.2.10. A New Transaction Protocol</h4>
<div class="paragraph">
<p>Many component technologies offer mechanisms for coordinating ACID transactions based on two-phase commit semantics.
Some of these are CORBA/OTS, JTS/JTA, and MTS/MSDTC.
ACID transactions are not suitable for all Web Services transactions, as explained in the following section.</p>
</div>
<div class="ulist">
<div class="title">Reasons ACID is Not Suitable for Web Services</div>
<ul>
<li>
<p>Classic ACID transactions assume that an organization that develops and deploys applications owns the entire infrastructure for the applications.
This infrastructure has traditionally taken the form of an Intranet.
Ownership implies that transactions operate in a trusted and predictable manner.
To assure ACIDity, potentially long-lived locks can be kept on underlying data structures during two-phase commit.
Resources can be used for any period of time and released when the transaction is complete.</p>
<div class="paragraph">
<p>In Web Services, these assumptions are no longer valid.
One obvious reason is that the owners of data exposed through a Web service refuse to allow their data to be locked for extended periods, since allowing such locks invites denial-of-service attacks.</p>
</div>
</li>
<li>
<p>All application infrastructures are generally owned by a single party.
Systems using classical ACID transactions normally assume that participants in a transaction will obey the directives of the transaction manager and only infrequently make unilateral decisions which harm other participants in a transaction.</p>
<div class="paragraph">
<p>Web Services participating in a transaction can effectively decide to resign from the transaction at any time, and the consumer of the service generally has little in the way of quality of service guarantees to prevent this.</p>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_transaction_in_loosely_coupled_systems"><a class="anchor" href="#_transaction_in_loosely_coupled_systems"></a>Transaction in Loosely Coupled Systems</h5>
<div class="paragraph">
<p>Extended transaction models which relax the ACID properties have been proposed over the years.
WS-T provides a new transaction protocol to implement these concepts for the Web Services architecture.
XTS is designed to accommodate four underlying requirements inherent in any loosely coupled architecture like Web Services.
These requirements are discussed in the following section.</p>
</div>
<div class="ulist">
<div class="title">Requirements of Web Services</div>
<ul>
<li>
<p>Ability to handle multiple successful outcomes to a transaction, and to involve operations whose effects may not be isolated or durable.</p>
</li>
<li>
<p>Coordination of autonomous parties whose relationships are governed by contracts, rather than the dictates of a central design authority.</p>
</li>
<li>
<p>Discontinuous service, where parties are expected to suffer outages during their lifetimes, and coordinated work must be able to survive such outages.</p>
</li>
<li>
<p>Interoperation using XML over multiple communication protocols.
XTS uses SOAP encoding carried over HTTP.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_overview_of_protocols_used_by_xts"><a class="anchor" href="#_overview_of_protocols_used_by_xts"></a>5.3. Overview of Protocols Used by XTS</h3>
<div class="paragraph">
<p>This section discusses fundamental concepts associated with the WS-Coordination, WS-Atomic Transaction and WS-Business Activity protocols, as defined in each protocol&#8217;s specification.
Foundational information about these protocols is important to understanding the remaining material covered in this guide.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are familiar with the WS-Coordination, WS-Atomic Transaction, and WS-Business Activity specifications, you may only need to skim this chapter.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_ws_coordination"><a class="anchor" href="#_ws_coordination"></a>5.3.1. WS-Coordination</h4>
<div class="paragraph">
<p>In general terms, <em>coordination</em> is the act of one entity, known as the coordinator, disseminating information to a number of participants for some domain-specific reason.
This reason could be to reach consensus on a decision by a distributed transaction protocol, or to guarantee that all participants obtain a specific message, such as in a reliable multicast environment.
When parties are being coordinated, information, known as the <em>coordination context</em>, is propagated to tie together operations which are logically part of the same coordinated work or activity.
This context information may flow with normal application messages, or may be an explicit part of a message exchange.
It is specific to the type of coordination being performed.</p>
</div>
<div class="paragraph">
<p>The fundamental idea underpinning <em>WS-Coordination (WS-C)</em> is that a coordination infrastructure is needed in a Web Services environment.
The WS-C specification defines a framework that allows different coordination protocols to be plugged in to coordinate work between clients, services, and participants, as shown in <a href="#fig_ws_c_architecture">WS-C Architecture</a>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="fig_ws_c_architecture" class="imageblock text-center">
<div class="content">
<img src="images/xts-fig-ws-c-overview.png" alt="xts fig ws c overview">
</div>
<div class="title">Figure 37. WS-C Architecture</div>
</div>
<div class="paragraph">
<p>The WS-C specification speaks of activities , which are distributed units of work, involving one or more parties.
These parties may be services, components, or even objects.
At this level, an activity is minimally specified and is simply created, run, and then completed.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Whatever coordination protocol is used, and in whatever domain it is deployed, the same generic requirements are present.</p>
</div>
<div id="list_requirements_for_wsc" class="ulist">
<div class="title">Generic Requirements for WS-C</div>
<ul>
<li>
<p>Instantiation, or activation, of a new coordinator for the specific coordination protocol, for a particular application instance.</p>
</li>
<li>
<p>Registration of participants with the coordinator, such that they will receive that coordinator&#8217;s protocol messages during (some part of) the application&#8217;s lifetime.</p>
</li>
<li>
<p>Propagation of contextual information between Web Services that comprise the application.</p>
</li>
<li>
<p>An entity to drive the coordination protocol through to completion.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first three of the points in <a href="#list_requirements_for_wsc">Generic Requirements for WS-C</a> are the direct responsibility of WS-C, while the fourth is the responsibility of a third-party entity.
The third-party entity is usually the client component of the overall application.
These four WS-C roles and their relationships are shown in <a href="#fig_wsc_four_roles">Four Roles in WS-C</a>.</p>
</div>
<div id="fig_wsc_four_roles" class="imageblock text-center">
<div class="content">
<img src="images/xts-fig-wsc-four-roles.png" alt="xts fig wsc four roles">
</div>
<div class="title">Figure 38. Four Roles in WS-C</div>
</div>
<div class="sect4">
<h5 id="_activation"><a class="anchor" href="#_activation"></a>Activation</h5>
<div class="paragraph">
<p>The WS-C framework exposes an Activation Service which supports the creation of coordinators for specific coordination protocols and retrieval of associated contexts.
Activation services are invoked synchronously using an RPC style exchange.
So, the service WSDL defines a single port declaring a <code>CreateCoordinationContext</code> operation.
This operation takes an input specfying the details of the transaction to be created, including the type of coordination required, timeout, and other relevant information.
It returns an output containing the details of the newly-created transaction context: the transaction identifier, coordination type, and registration service URL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Activation Service portType Declaration --&gt;</span> 
<span class="tag">&lt;wsdl:portType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ActivationCoordinatorPortType</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> 
  <span class="tag">&lt;wsdl:operation</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CreateCoordinationContext</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> 
    <span class="tag">&lt;wsdl:input</span> <span class="attribute-name">message</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">wscoor:CreateCoordinationContext</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> 
    <span class="tag">&lt;wsdl:output</span> <span class="attribute-name">message</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">wscoor:CreateCoordinationContextResponse</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> 
  <span class="tag">&lt;/wsdl:operation&gt;</span> 
<span class="tag">&lt;/wsdl:portType&gt;</span> </code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_registration"><a class="anchor" href="#_registration"></a>Registration</h5>
<div class="paragraph">
<p>The context returned by the activation service includes the URL of a Registration Service.
When a web service receieves a service request accompanied by a transaction context, it contacts the Registration Service to enroll as a participant in the transaction.
The registration request includes a participant protocol defining the role the web service wishes to take in the transaction.
Depending upon the coordination protocol, more than one choice of participant protocol may be available.</p>
</div>
<div class="paragraph">
<p>Like the activation service, the registration service assumes synchronous communication.
Thus, the service WSDL exposes a single port declaring a <code>Register</code> operation.
This operation takes an input specifying the details of the participant which is to be registered, including the participant protocol type.
It returns a corresponding output response.</p>
</div>
<div id="example_wsc_registration" class="listingblock">
<div class="title">Registration ServiceWSDL Interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Registration Service portType Declaration --&gt;</span> 
<span class="tag">&lt;wsdl:portType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RegistrationCoordinatorPortType</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> 
  <span class="tag">&lt;wsdl:operation</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Register</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> 
    <span class="tag">&lt;wsdl:input</span> <span class="attribute-name">message</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">wscoor:Register</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> 
    <span class="tag">&lt;wsdl:output</span> <span class="attribute-name">message</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">wscoor:RegisterResponse</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> 
  <span class="tag">&lt;/wsdl:operation&gt;</span> 
<span class="tag">&lt;/wsdl:portType&gt;</span> </code></pre>
</div>
</div>
<div class="paragraph">
<p>Once a participant is registered with a coordinator through the registration service, it receives coordination messages from the coordinator.
Typical messages include such things as "prepare to complete" and "complete" messages if a two-phase protocol is used.
Where the coordinator&#8217;s protocol supports it, participants can also send messages back to the coordinator.</p>
</div>
</div>
<div class="sect4">
<h5 id="_completion"><a class="anchor" href="#_completion"></a>Completion</h5>
<div class="paragraph">
<p>The role of terminator is generally filled by the client application.
At an appropriate point, the client asks the coordinator to perform its particular coordination function with any registered participants, to drive the protocol through to its completion.
After completion, the client application may be informed of an outcome for the activity.
This outcome may take any form along the spectrum from simple success or failure notification, to complex structured data detailing the activity&#8217;s status.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ws_transaction"><a class="anchor" href="#_ws_transaction"></a>5.3.2. WS-Transaction</h4>
<div class="paragraph">
<p><em>WS-Transaction (WS-T)</em> comprises the pair of transaction coordination protocols, <em>WS-Atomic Transaction (WS-AT)</em>, and <em>WS-Business Activity (WS-BA)</em>, which utilize the coordination framework provided by <em>WS-Coordination (WS-C)</em>.</p>
</div>
<div class="paragraph">
<p><em>WS-Transactions</em> was developed to unify existing traditional transaction processing systems, allowing them to communicate reliably with one another without changes to the systems' own function.</p>
</div>
<div class="sect4">
<h5 id="_ws_transaction_foundations"><a class="anchor" href="#_ws_transaction_foundations"></a>WS-Transaction Foundations</h5>
<div class="paragraph">
<p>WS-Transaction is layered upon the WS-Coordination protocol, as shown in <a href="#wsc_wst_interop">WS-Coordination, WS-Transaction, and WS-Business Activity</a>.</p>
</div>
<div id="wsc_wst_interop" class="imageblock text-center">
<div class="content">
<img src="images/xts-fig-wsc-wst-interop.png" alt="xts fig wsc wst interop">
</div>
<div class="title">Figure 39. WS-Coordination, WS-Transaction, and WS-Business Activity</div>
</div>
<div class="paragraph">
<p>WS-C provides a generic framework for specific coordination protocols, like WS-Transaction, used in a modular fashion.
WS-C provides only context management, allowing contexts to be created and activities to be registered with those contexts.
WS-Transaction leverages the context management framework provided by WS-C in two ways.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>It extends the WS-C context to create a transaction context.</p>
</li>
<li>
<p>It augments the activation and registration services with a number of additional services (<code>Completion</code>, <code>Volatile2PC</code>, <code>Durable2PC</code>, <code>BusinessAgreementWithParticipantCompletion</code>, and <code>BusinessAgreementWithCoordinatorCompletion</code>) and two protocol message sets (one for each of the transaction models supported in WS-Transaction), to build a fully-fledged transaction coordinator on top of the WS-C protocol infrastructure.</p>
</li>
<li>
<p>An important aspect of WS-Transaction that differs from traditional transaction protocols is that a synchronous request/response model is not assumed.
Sequences of one way messages are used to implement communications between the client/participant and the coordination services appropriate to the transaction&#8217;s coordination and participant protocols.
This is significant because it means that the client and participant containers must deploy XTS service endpoints to receive messages from the coordinator service.</p>
<div class="paragraph">
<p>This requirement is visible in the details of the <code>Register</code> and <code>RegisterResponse</code> messages declared in the Registration Service WSDL in <a href="#example_wsc_registration">Registration ServiceWSDL Interface</a>.
The <code>Register</code> message contains the URL of an endpoint in the client or web service container.
This URL is used when a WS-Transaction coordination service wishes to dispatch a message to the client or web service.
Similarly, the <code>RegisterResponse</code> message contains a URL iendtifying an endpoint for the protocol-specific WS-Transaction coordination service for which the client/web service is registered, allowing messages to be addressed to the transaction coordinator.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_ws_transaction_architecture"><a class="anchor" href="#_ws_transaction_architecture"></a>WS-Transaction Architecture</h5>
<div class="paragraph">
<p>WS-Transaction distinguishes the transaction-aware web service in its role executing business-logic, from the web service acting as a participant in the transaction, communicating with and responding to its transaction coordinator.
Transaction-aware web services deal with application clients using business-level protocols, while the participant handles the underlying WS-Transaction protocols, as shown in <a href="#ws_trans_global_view">WS-Transaction Global View</a>.</p>
</div>
<div id="ws_trans_global_view" class="imageblock text-center">
<div class="content">
<img src="images/xts-ws-trans-global-view.png" alt="xts ws trans global view">
</div>
<div class="title">Figure 40. WS-Transaction Global View</div>
</div>
<div class="paragraph">
<p>A transaction-aware web service encapsulates the business logic or work that needs to be conducted within the scope of a transaction.
This work cannot be confirmed by the application unless the transaction also commits.
Thus, control is ultimately removed from the application and given to the transaction.</p>
</div>
<div class="paragraph">
<p>The participant is the entity that, under the dictates of the transaction coordinator, controls the outcome of the work performed by the transaction-aware Web service.
In <a href="#ws_trans_global_view">WS-Transaction Global View</a>, each web service is shown with one associated participant that manages the transaction protocol messages on behalf of its web service.
<a href="#ws_trans_services_participants">WS-Transaction Web Services and Participants</a>, however, shows a close-up view of a single web service, and a client application with their associated participants.</p>
</div>
<div id="ws_trans_services_participants" class="imageblock text-center">
<div class="content">
<img src="images/xts-fig-ws-trans-services-participants.png" alt="xts fig ws trans services participants">
</div>
<div class="title">Figure 41. WS-Transaction Web Services and Participants</div>
</div>
<div class="paragraph">
<p>The transaction-aware web service employs a back end database accessed via a JDBC driver, which sends SQL statements to the database for processing.
However, those statements should only commit if the enclosing web service transaction does.
For this to work, the web service must employ transaction bridging.
Transaction bridging registers a participant with the coordinator for the web service transaction and creates a matching XA transaction within which it can invoke the driver to make tentative changes to the database.
The web service ensures that service requests associated with a specific web service transaction are executed in the scope of the corresponding XA transaction, grouping changes common to a given transaction while isolating changes belonging to different transactions.
The participant responds to prepare, commit, or rollback requests associated from the web service transaction coordinator by forwarding the same operations to the underlying XA transaction coordinator, ensuring that the local outcome in the database corresponds with the global outcome of the web service transaction as a whole.</p>
</div>
<div class="paragraph">
<p>Things are less complex for the client.
Through its API, the client application registers a participant with the transaction, and uses this participant to control termination of the transaction.</p>
</div>
</div>
<div class="sect4">
<h5 id="_ws_transaction_models"><a class="anchor" href="#_ws_transaction_models"></a>WS-Transaction Models</h5>
<div class="paragraph">
<p>It has been established that traditional transaction models are not appropriate for Web Services.
No one specific protocol is likely to be sufficient, given the wide range of situations where Web service transactions are likely to be used.
The WS-Transaction specification proposes two distinct models, where each supports the semantics of a particular kind of B2B interaction.</p>
</div>
<div class="paragraph">
<p>The following discussion presents the interactions between the client, web service and the transaction coordinator in great detail for expository purposes only.
Most of this activity happens automatically behind the scenes.
The actual APIs used to initiate and complete a transaction and to register a participant and drive it through the commit or abort process are described in the XTS API.</p>
</div>
<div class="sect5">
<h6 id="_atomic_transactions"><a class="anchor" href="#_atomic_transactions"></a>Atomic Transactions</h6>
<div class="paragraph">
<p>An <em class="term">atomic transaction (AT)</em> is similar to traditional ACID transactions, and is designed to support short-duration interactions where ACID semantics are appropriate.
Within the scope of an AT, web services typically employ bridging to allow them to access XA resources, such as databases and message queues, under the control of the web service transaction.
When the transaction terminates, the participant propagates the outcome decision of the AT to the XA resources, and the appropriate commit or rollback actions are taken by each.</p>
</div>
<div class="paragraph">
<p>All services and associated participants are expected to provide ACID semantics, and it is expected that any use of atomic transactions occurs in environments and situations where ACID is appropriate.
Usually, this environment is a trusted domain, over short durations.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Atomic Transaction Process</div>
<ol class="arabic">
<li>
<p>To begin an atomic transaction, the client application first locates a WS-C Activation Coordinator web service that supports WS-Transaction.</p>
</li>
<li>
<p>The client sends a WS-C <em>CreateCoordinationContext</em> message to the service, specifying <a href="http://schemas.xmlsoap.org/ws/2004/10/wsat" class="bare">http://schemas.xmlsoap.org/ws/2004/10/wsat</a> as its coordination type.</p>
</li>
<li>
<p>The client receives an appropriate WS-Transaction context from the activation service.</p>
</li>
<li>
<p>The response to the <em>CreateCoordinationContext</em> message, the transaction context, has its <em>CoordinationType</em> element set to the WS-Atomic Transaction namespace, <a href="http://schemas.xmlsoap.org/ws/2004/10/wsat" class="bare">http://schemas.xmlsoap.org/ws/2004/10/wsat</a>.
It also contains a reference to the atomic transaction coordinator endpoint, the WS-C Registration Service, where participants can be enlisted.</p>
</li>
<li>
<p>The client normally proceeds to invoke Web Services and complete the transaction, either committing all the changes made by the web services, or rolling them back.
In order to be able to drive this completion activity, the client must register itself as a participant for the <em>Completion</em> protocol, by sending a <em>Register</em> message to the Registration Service whose endpoint was returned in the Coordination Context.</p>
</li>
<li>
<p>Once registered for Completion, the client application then interacts with Web Services to accomplish its business-level work.
With each invocation of a business Web service, the client inserts the transaction context into a SOAP header block, such that each invocation is implicitly scoped by the transaction.
The toolkits that support WS-Atomic Transaction-aware Web Services provide facilities to correlate contexts found in SOAP header blocks with back-end operations.
This ensures that modifications made by the Web service are done within the scope of the same transaction as the client and subject to commit or rollback by the transaction coordinator.</p>
</li>
<li>
<p>Once all the necessary application-level work is complete, the client can terminate the transaction, with the intent of making any changes to the service state permanent.
The completion participant instructs the coordinator to try to commit or roll back the transaction.
When the commit or roll-back operation completes, a status is returned to the participant to indicate the outcome of the transaction.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Although this description of the completion protocol seems straightforward, it hides the fact that in order to resolve the transaction to an outcome, several other participant protocols need to be followed.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Volatile2pc</dt>
<dd>
<p>The first of these protocols is the optional <em class="term">Volatile2PC</em> (2PC is an abbreviation referring to the two-phase commit).
The Volatile2PC protocol is the WS-Atomic Transaction equivalent of the synchronization protocol discussed earlier.
It is typically executed where a Web service needs to flush volatile (cached) state, which may be used to improve performance of an application, to a database prior to the transaction committing.
Once flushed, the data is controlled by a two-phase aware participant.</p>
<div class="paragraph">
<p>When the completion participant initiates a <em>commit</em> operation, all Volatile2PC participants are informed that the transaction is about to complete, via the <em>prepare</em> message.
The participants can respond with one of three messages: <em>prepared</em>, <em>aborted</em>, or <em>readonly</em>.
A failure at this stage causes the transaction to roll back.</p>
</div>
</dd>
<dt class="hdlist1">Durable2PC</dt>
<dd>
<p>The next protocol in the WS-Atomic Transaction is <em class="term">Durable2PC</em>.
The Durable2PC protocol is at the core of WS-Atomic Transaction.
It brings about the necessary consensus between participants in a transaction, so the transaction can safely be terminated.</p>
<div class="paragraph">
<p>The Durable2PC protocol ensures atomicity between participants, and is based on the classic technique of two-phase commit with presumed abort.</p>
</div>
</dd>
</dl>
</div>
<div class="olist arabic">
<div class="title">Procedure: Durable2PC Procedure</div>
<ol class="arabic">
<li>
<p>During the first phase, when the coordinator sends the prepare message, a participant must make durable any state changes that occurred during the scope of the transaction, so these changes can either be rolled back or committed later.
None of the original state information can be lost at this point, since the atomic transaction may still roll back.
If the participant cannot <em>prepare</em>, it must inform the coordinator, by means of the <em>aborted</em> message.
The transaction will ultimately roll back.
If the participant is responsible for a service that did not change any of the transaction&#8217;s data, it can return the <em>readonly</em> message, causing it to be omitted from the second phase of the commit protocol.
Otherwise, the <em>prepared</em> message is sent by the participant.</p>
</li>
<li>
<p>If no failures occur during the first phase, Durable2PC proceeds to the second phase, in which the coordinator sends the <em>commit</em> message to participants.
Participants then make permanent the tentative work done by their associated services, and send a <em>committed</em> message to the coordinator.
If any failures occur, the coordinator sends the <em>rollback</em> message to all participants, causing them to discard tentative work done by their associated services, and delete any state information saved to persistent storage at <em>prepare</em>, if they have reached that stage.
Participants respond to a rollback by sending an <em>aborted</em> message to the coordinator.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The semantics of the WS-Atomic Transaction protocol do not include the one-phase commit optimization.
A full two-phase commit is always used, even where only a single participant is enlisted.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a href="#two_pc_participant_state_transitions">WS-Atomic Two-Phase Participant State Transitions</a> shows the state transitions of a WS-Atomic Transaction and the message exchanges between coordinator and participant.
Messages generated by the coordinator are represented by solid lines, while the participants' messages use dashed lines.</p>
</div>
<div id="two_pc_participant_state_transitions" class="imageblock text-center">
<div class="content">
<img src="images/xts-fig-2pc-participant-state-transitions.png" alt="xts fig 2pc participant state transitions">
</div>
<div class="title">Figure 42. WS-Atomic Two-Phase Participant State Transitions</div>
</div>
<div class="paragraph">
<p>Once the Durable2PC protocol completes, the <em>Completion</em> protocol that originally began the termination of the transaction can complete, and inform the client application whether the transaction was committed or rolled back.
Additionally, the Volatile2PC protocol may complete.</p>
</div>
<div class="paragraph">
<p>Like the <em>prepare</em> phase of Volatile2PC, the final phase is optional and can be used to inform participants about the transaction&#8217;s completion, so that they can release resources such as database connections.</p>
</div>
<div class="paragraph">
<p>Any registered Volatile2PC participants are invoked after the transaction terminates, and are informed about the transaction&#8217;s completion state by the coordinator.
Since the transaction has terminated, any failures of participants at this stage are ignored, since they have no impact on outcomes.</p>
</div>
<div class="paragraph">
<p><a href="#fig_at_model">Context Creation</a> illustrates the intricate interweaving of individual protocols comprising the AT as a whole.</p>
</div>
<div id="fig_at_model" class="imageblock text-center">
<div class="content">
<img src="images/xts-fig-at-model.png" alt="xts fig at model">
</div>
<div class="title">Figure 43. Context Creation</div>
</div>
</div>
<div class="sect5">
<h6 id="_business_activities"><a class="anchor" href="#_business_activities"></a>Business Activities</h6>
<div class="paragraph">
<p>Most B2B applications require transactional support in order to guarantee consistent outcome and correct execution.
These applications often involve long-running computations, loosely coupled systems, and components that do not share data, location, or administration.
It is difficult to incorporate atomic transactions within such architectures.</p>
</div>
<div class="paragraph">
<p>For example, an online bookshop may reserve books for an individual for a specific period of time.
However, if the individual does not purchase the books within that period, they become available again for purchase by other customers.
Because it is not possible to have an infinite supply of stock, some online shops may seem, from the user&#8217;s perspective, to reserve items for them, while actually allow others to preempt the reservation.
A user may discover, to his disappointment, that the item is no longer available.</p>
</div>
<div class="paragraph">
<p>A <em>Business Activity (BA)</em> is designed specifically for these kinds of long-duration interactions, where it is impossible or impractical to exclusively lock resources.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: BA Process Overview</div>
<ol class="arabic">
<li>
<p>Services are requested to do work.</p>
</li>
<li>
<p>Where those services have the ability to undo any work, they inform the BA, in case the BA later decides the cancel the work.
If the BA suffers a failure. it can instruct the service to execute its <em>undo</em> behavior.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The key to BA is that how services do their work and provide compensation mechanisms is not the responsibility of the WS-BA specification.
It is delegated to the service provider.</p>
</div>
<div class="paragraph">
<p>The WS-BA defines a protocol for Web Services-based applications to enable existing business processing and work-flow systems to wrap their proprietary mechanisms and interoperate across implementations and business boundaries.</p>
</div>
<div class="paragraph">
<p>Unlike the WS-AT protocol model, where participants inform the coordinator of their state only when asked, a child activity within a BA can specify its outcome to the coordinator directly, without waiting for a request.
A participant may choose to exit the activity or may notify the coordinator of a failure at any point.
This feature is useful when tasks fail, since the notification can be used to modify the goals and drive processing forward, without the need to wait until the end of the transaction to identify failures.
A well-designed Business Activity should be proactive.</p>
</div>
<div class="paragraph">
<p>The BA protocols employ a compensation-based transaction model.
When a participant in a business activity completes its work, it may choose to exit the activity.
This choice does not allow any subsequent rollback.
Alternatively, the participant can complete its activity, signaling to the coordinator that the work it has done can be compensated if, at some later point, another participant notifies a failure to the coordinator.
In this latter case, the coordinator asks each non-exited participant to compensate for the failure, giving them the opportunity to execute whatever compensating action they consider appropriate.
For instance, the participant might credit a bank account which it previously debited.
If all participants exit or complete without failure, the coordinator notifies each completed participant that the activity has been closed.</p>
</div>
<div class="paragraph">
<p>Underpinning all of this are three fundamental assumptions, detailed in the <a href="#wsba_assumptions">Assumptions of WS-BA</a>.</p>
</div>
<div id="wsba_assumptions" class="ulist">
<div class="title">Assumptions of WS-BA</div>
<ul>
<li>
<p>All state transitions are reliably recorded, including application state and coordination metadata (the record of sent and received messages).</p>
</li>
<li>
<p>All request messages are acknowledged, so that problems are detected as early as possible.
This avoids executing unnecessary tasks and can also detect a problem earlier when rectifying it is simpler and less expensive.</p>
</li>
<li>
<p>As with atomic transactions, a <em>response</em> is defined as a separate operation, not as the output of the request.
Message I/O implementations typically have timeout requirements too short for BA responses.
If the response is not received after a timeout, it is re-sent, repeatedly, until a response is received.
The receiver discards all but one identical request received.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The BA model has two participant protocols: <em>BusinessAgreementWithParticipantCompletion</em> and <em>BusinessAgreementWithCoordinatorCompletion</em>.
Unlike the AT protocols which are driven from the coordinator down to participants, this protocol takes the opposite approach.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">BusinessAgreementWithParticipantCompletion</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A participant is initially created in the Active state.</p>
</li>
<li>
<p>If it finishes its work and it is no longer needed within the scope of the BA (such as when the activity operates on immutable data), the participant can unilaterally decide to exit, sending an <em>exited</em> message to the coordinator.
However, if the participant finishes and wishes to continue in the BA, it must be able to compensate for the work it has performed.
In this case, it sends a <em>completed</em> message to the coordinator and waits for the coordinator to notify it about the final outcome of the BA.
This outcome is either a <em>close</em> message, meaning the BA has completed successfully, or a <em>compensate</em> message indicating that the participant needs to reverse its work.</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">BusinessAgreementWithCoordinatorCompletion</dt>
<dd>
<p>The <em>BusinessAgreementWithCoordinatorCompletion</em> differs from the <em>BusinessAgreementWithParticipantCompletion</em> protocol in that the participant cannot autonomously decide to complete its participation in the BA, even if it can be compensated.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instead, the completion stage is driven by the client which created the BA, which sends a <em>completed</em> message to the coordinator.</p>
</li>
<li>
<p>The coordinator sends a <em>complete</em> message to each participant, indicating that no further requests will be sent to the service associated with the participant.</p>
</li>
<li>
<p>The participant continues on in the same manner as in the <em>BusinessAgreementWithParticipantCompletion</em> protocol.</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The advantage of the BA model, compared to the AT model, is that it allows the participation of services that cannot lock resources for extended periods.</p>
</div>
<div class="paragraph">
<p>While the full ACID semantics are not maintained by a BA, consistency can still be maintained through compensation.
The task of writing correct compensating actions to preserve overall system consistency is the responsibility of the developers of the individual services under control of the BA.
Such compensations may use backward error recovery, but forward recovery is more common.</p>
</div>
<div class="paragraph">
<p><a href="#fig_bawpc_state_transitions">BusinessAgreementWithParticipantCompletion State Transitions</a> shows the state transitions of a WS-BA <em>BusinessAgreementWithParticipantCompletion</em> participant and the message exchanges between coordinator and participant.
Messages generated by the coordinator are shown with solid lines, while the participants' messages are illustrated with dashed lines.</p>
</div>
<div id="fig_bawpc_state_transitions" class="imageblock text-center">
<div class="content">
<img src="images/xts-fig-bawpc-state-transitions.png" alt="xts fig bawpc state transitions">
</div>
<div class="title">Figure 44. BusinessAgreementWithParticipantCompletion State Transitions</div>
</div>
<div class="paragraph">
<p><a href="#fig_bawcc_state_transitions">BusinessAgreementWithCoordinatorCompletion State Transitions</a> shows the state transitions of a WS-BA <em>BusinessAgreementWithCoordinatorCompletion</em> participant and the message exchanges between coordinator and participant.
Messages generated by the coordinator are shown with solid lines, while the participants' messages are illustrated with dashed lines.</p>
</div>
<div id="fig_bawcc_state_transitions" class="imageblock text-center">
<div class="content">
<img src="images/xts-fig-bawcc-state-transitions.png" alt="xts fig bawcc state transitions">
</div>
<div class="title">Figure 45. BusinessAgreementWithCoordinatorCompletion State Transitions</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_application_messages"><a class="anchor" href="#_application_messages"></a>Application Messages</h5>
<div class="paragraph">
<p><em>Application messages</em> are the requests and responses sent between parties, that constitute the work of a business process.
Any such messages are considered opaque by XTS, and there is no mandatory message format, protocol binding, or encoding style.
This means that you are free to use any appropriate Web Services protocol.
In XTS, the transaction context is propagated within the headers of SOAP messages.</p>
</div>
<div class="paragraph">
<p>XTS ships with support for service developers building WS-Transactions-aware services on the WildFly Application Server.
Interceptors are provided for automatic context handling at both client and service, which significantly simplifies development, allowing you to concentrate on writing the business logic without being sidetracked by the transactional infrastructure.
The interceptors add and remove context elements to application messages, without altering the semantics of the messages themselves.
Any service which understands what to do with a WS-C context can use it.
Services which are not aware of WS-C, WS-Atomic Transaction and WS-Business Activity can ignore the context.
XTS manages contexts without user intervention.</p>
</div>
<div class="sect5">
<h6 id="_ws_c_ws_atomic_transaction_and_ws_business_activity_messages"><a class="anchor" href="#_ws_c_ws_atomic_transaction_and_ws_business_activity_messages"></a>WS-C, WS-Atomic Transaction, and WS-Business Activity Messages</h6>
<div class="paragraph">
<p>Although the application or service developer is rarely interested in the messages exchanged by the transactional infrastructure, it is useful to understand what kinds of exchanges occur so that the underlying model can be fitted in to an overall architecture.</p>
</div>
<div class="paragraph">
<p>WS-Coordination, WS-Atomic Transaction and WS-Business Activity-specific messages are transported using SOAP messaging over HTTP.
The types of messages that are propagated include instructions to perform standard transaction operations like <em>begin</em> and <em>prepare</em>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>XTS messages do not interfere with messages from the application, an application need not use the same transport as the transaction-specific messages.
For example, a client application might deliver its application-specific messages using SOAP RPC over SMTP, even though the XTS messages are delivered using a different mechanism.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_summary_3"><a class="anchor" href="#_summary_3"></a>5.3.3. Summary</h4>
<div class="paragraph">
<p>XTS provides a coordination infrastructure which allows transactions to run between services owned by different businesses, across the Internet.
That infrastructure is based on the WS-C, WS-Atomic Transaction and WS-Business Activity specifications.
It supports two kinds of transactions: atomic transactions and business activities, which can be combined in arbitrary ways to map elegantly onto the transactional requirements of the underlying problem.
The use of the whole infrastructure is simple, because its functionality is exposed through a simple transactioning API.
XTS provides everything necessary to keep application and transactional aspects of an application separate, and to ensure that a system&#8217;s use of transactions does not interfere with the functional aspects of the system itself.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_long_running_actions_lra"><a class="anchor" href="#_long_running_actions_lra"></a>6. Long Running Actions (LRA)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview_2"><a class="anchor" href="#_overview_2"></a>6.1. Overview</h3>
<div class="paragraph">
<p>This guide describes the Naryana implementation, or Naryana LRA for short, of the MicroProfile LRA specification <a href="https://github.com/eclipse/microprofile-lra/blob/master/spec/src/main/asciidoc/microprofile-lra-spec.adoc" class="bare">https://github.com/eclipse/microprofile-lra/blob/master/spec/src/main/asciidoc/microprofile-lra-spec.adoc</a> The specification introduces annotations and APIs for services to coordinate long running activities whilst still maintaining loose coupling and doing so in such a way as to guarantee a globally consistent outcome without the need to take locks on data for extended periods.
The specification has similarities to WS-BA except that it uses a simplified compensation model and as such it can expose certain failure conditions that are not present in WS-BA.
Please refer to <a href="https://github.com/eclipse/microprofile-lra/blob/master/spec/src/main/asciidoc/microprofile-lra-spec.adoc#the-model" class="bare">https://github.com/eclipse/microprofile-lra/blob/master/spec/src/main/asciidoc/microprofile-lra-spec.adoc#the-model</a> for details of the state model used by the LRA specification.</p>
</div>
<div class="paragraph">
<p>The basic idea is to group a collection of compensatable JAX-RS service interactions within a context, called a Long Running Action (LRA).
The context is propagated on JAX-RS service requests and responses using a JAX-RS header.
The implementation automatically adds the header to requests and responses before and after service method invocation (using JAX-RS filters as an implementation technique).
An attribute of the @LRA annotation determines how the LRA is started and/or ended.</p>
</div>
<div class="paragraph">
<p>A service may join the context by, in the case of a JAX-RS resource, providing REST endpoints (via annotations) that the implementation should invoke when the LRA is later closed or cancelled.
The specification is transactional in the sense that all the endpoints involved in the interaction are informed about the decision to close or cancel the context regardless of system failures.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jax_rs_services"><a class="anchor" href="#_jax_rs_services"></a>6.2. JAX-RS services</h3>
<div class="paragraph">
<p>Primary support is for JAX-RS based services to participate in transactional Long Running Actions (LRAs).
Full details are available in the MP-LRA specification document <a href="https://github.com/eclipse/microprofile-lra/blob/master/spec/src/main/asciidoc/microprofile-lra-spec.adoc" class="bare">https://github.com/eclipse/microprofile-lra/blob/master/spec/src/main/asciidoc/microprofile-lra-spec.adoc</a>.
Also look in the <a href="examples.html#lra_examples">examples section</a> below and in the MP-LRA TCK.</p>
</div>
</div>
<div class="sect2">
<h3 id="_non_jax_rs_services"><a class="anchor" href="#_non_jax_rs_services"></a>6.3. Non JAX-RS services</h3>
<div class="paragraph">
<p>We also support POJO style participants, details of which are available in the specification and TCK available on the MP-LRA github repository <a href="https://github.com/eclipse/microprofile-lra" class="bare">https://github.com/eclipse/microprofile-lra</a></p>
</div>
</div>
<div class="sect2">
<h3 id="lra_examples"><a class="anchor" href="#lra_examples"></a>6.4. Examples</h3>
<div class="sect3">
<h4 id="_lra_quickstart_examples"><a class="anchor" href="#_lra_quickstart_examples"></a>6.4.1. LRA Quickstart Examples</h4>
<div class="paragraph">
<p>There are some quickstarts with README.md files for using LRAs in the quickstart repository: <a href="https://github.com/jbosstm/quickstart/tree/master/rts/lra-examples" class="bare">https://github.com/jbosstm/quickstart/tree/master/rts/lra-examples</a> and <a href="https://github.com/jbosstm/quickstart/tree/master/rts/lra" class="bare">https://github.com/jbosstm/quickstart/tree/master/rts/lra</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_participating_in_long_running_actions"><a class="anchor" href="#_participating_in_long_running_actions"></a>6.4.2. Participating in Long Running Actions</h4>
<div class="paragraph">
<p>The following code snippet shows the basic steps for writing service methods (and associated participant resource) that will result in the registration of a participant in a new or an existing LRA.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@LRA</span>(value = LRA.Type.REQUIRED, <span class="comment">// if there is no incoming context a new one is created</span>
     cancelOn = {
         Response.Status.INTERNAL_SERVER_ERROR <span class="comment">// cancel on a 500 code</span>
     },
     cancelOnFamily = {
         Response.Status.Family.CLIENT_ERROR <span class="comment">// cancel on any 4xx code</span>
     },
     end = <span class="predefined-constant">false</span>) <span class="comment">// the LRA will continue to run when the method finishes</span>
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/book</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@POST</span>
<span class="directive">public</span> Response bookTrip(<span class="annotation">@HeaderParam</span>(LRA_HTTP_CONTEXT_HEADER) <span class="predefined-type">URI</span> lraId,
                         <span class="annotation">@HeaderParam</span>(LRA_HTTP_PARENT_CONTEXT_HEADER) <span class="predefined-type">URI</span> parentLRA) {
    <span class="keyword">if</span> (parentLRA != <span class="predefined-constant">null</span>) { <span class="comment">// is the context nested</span>
          <span class="comment">// code which is sensitive to executing with a nested context goes here</span>
    }
    ...
}

<span class="annotation">@LRA</span>(LRA.Type.MANDATORY, <span class="comment">// requires an active context before method can be executed</span>
     end = <span class="predefined-constant">true</span>) <span class="comment">// end the LRA started by the bookTrip method</span>
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/confirm</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@PUT</span>
<span class="directive">public</span> Booking confirmTrip(<span class="annotation">@HeaderParam</span>(LRA_HTTP_CONTEXT_HEADER) <span class="predefined-type">URI</span> lraId,
                           <span class="annotation">@HeaderParam</span>(LRA_HTTP_PARENT_CONTEXT_HEADER) <span class="predefined-type">URI</span> parentLRA,
                           Booking booking) <span class="directive">throws</span> BookingException {
    <span class="keyword">if</span> (parentLRA != <span class="predefined-constant">null</span>) { <span class="comment">// is the context nested</span>
          <span class="comment">// code which is sensitive to executing with a nested context goes here</span>
    }
    <span class="comment">// lookup data associated with the incoming LRA (lraId)</span>
    ...
}

<span class="annotation">@Complete</span>
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/complete</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@PUT</span>
<span class="directive">public</span> Response completeWork(<span class="annotation">@HeaderParam</span>(LRA_HTTP_CONTEXT_HEADER) <span class="predefined-type">URI</span> lraId)
{
    <span class="comment">/*
     * Free up resources allocated in the context of the LRA identified by the
     * value in the injected JAX-RS header.
     *
     * Since there is no @Status method in this class, completeWork MUST be
     * idempotent and MUST return the status.
     */</span>
    <span class="keyword">return</span> Response.ok(ParticipantStatus.Completed.name()).build();
}

<span class="annotation">@Compensate</span>
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/compensate</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@PUT</span>
<span class="directive">public</span> Response compensateWork(<span class="annotation">@HeaderParam</span>(LRA_HTTP_CONTEXT_HEADER) <span class="predefined-type">URI</span> lraId)
{
    <span class="comment">/*
     * The LRA identified by the value in the injected JAX-RS header was
     * cancelled so the business logic should compensate for any actions
     * that have been performed while running in its context.
     *
     * Since there is no @Status method in this class, compensateWork MUST be
     * idempotent and MUST return the status
    */</span>
    <span class="keyword">return</span> Response.ok(ParticipantStatus.Compensated.name()).build();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_making_jax_rs_invocations_from_jax_rs_resource_methods"><a class="anchor" href="#_making_jax_rs_invocations_from_jax_rs_resource_methods"></a>6.4.3. Making JAX-RS Invocations from JAX-RS Resource Methods</h4>
<div class="paragraph">
<p>According to the specification the LRA context (<a href="https://download.eclipse.org/microprofile/microprofile-lra-2.0-RC1/microprofile-lra-spec-2.0-RC1.html#_setting_the_context_on_outgoing_jax_rs_requests" class="bare">https://download.eclipse.org/microprofile/microprofile-lra-2.0-RC1/microprofile-lra-spec-2.0-RC1.html#_setting_the_context_on_outgoing_jax_rs_requests</a>) is implicitly propagated to outgoing requests.
The Narayana implementation enforces this requirement by storing the LRA context with the thread used to service the incoming request and then reading it if the service methods makes outgoing requests and adds the context to the outgoing headers.
Although exhaustive testing of the implementation indicates that this requirement is met there is still a concern because the JAX-RS specification does not mandate that the same thread is used for the incoming and outgoing requests.
We therefore recommend that the service writer explicitly set the context on outgoing requests as shown in the following code snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@LRA</span>(value = LRA.Type.REQUIRED)
    <span class="annotation">@PUT</span>
    <span class="directive">public</span> Response addContextHeader(<span class="annotation">@HeaderParam</span>(LRA_HTTP_CONTEXT_HEADER) <span class="predefined-type">URI</span> lraId) {
        <span class="comment">// some business logic</span>

        <span class="comment">// create an invocation builder for a remote service</span>
        Invocation.Builder builder = ClientBuilder.newClient()
            .target(context.getBaseUri())
            .path(resource)
            .path(path)
            .request();

        <span class="comment">// explicitly set the context</span>
        builder.header(LRA_HTTP_CONTEXT_HEADER, lraId); <span class="comment">// lraId must be valid</span>

        Response response = builder.put(<span class="predefined-type">Entity</span>.text(<span class="string"><span class="delimiter">&quot;</span><span class="content">bodyText</span><span class="delimiter">&quot;</span></span>));

        <span class="comment">// more business logic</span>

        <span class="keyword">return</span> Response.ok().entity(lraId.toASCIIString()).build();
    }
    ...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="lra_integration"><a class="anchor" href="#lra_integration"></a>6.5. Runtime Integration</h3>
<div class="paragraph">
<p>To date we have only integrated with thorntail or standalone.
The near term plan is to provide a quarkus extension and a WildFly subsystem for running coordinators and participants.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rts"><a class="anchor" href="#_rts"></a>7. RTS</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview_3"><a class="anchor" href="#_overview_3"></a>7.1. Overview</h3>
<div class="paragraph">
<p>This guide covers the REST interfaces to the Narayana Transaction Manager.
The actual protocol implemented by RESTAT described in this book is taken from the draft RESTAT specification <a href="https://github.com/jbosstm/documentation/blob/master/rts/docs/REST-Atomic_v2_draft_8_comments_sept_4.pdf">https://github.com/jbosstm/documentation/blob/master/rest-tx/docs/RESTAT-v2-latest.pdf</a> . The specification is still evolving but has reached a stability level such that it can be used in real world environments.</p>
</div>
<div class="paragraph">
<p>Atomic transactions are a well-known technique for guaranteeing consistency in the presence of failures.
The ACID properties of atomic transactions (Atomicity, Consistency, Isolation, Durability) ensure that even in complex business applications consistency of state is preserved, despite concurrent accesses and failures.
This is extremely useful fault-tolerance technique, especially when multiple, possibly remote resources are involved.</p>
</div>
<div class="paragraph">
<p>Consistency is especially important in a web application with dynamic servers.
When users navigate a web application, they are viewing snapshots of the server state.
If the snapshot is computed within a transaction, the state returned to the user is consistent.
For many applications this is important for otherwise the inconsistent view of the data could be confusing to the user.
Many developers have the incorrect perception that they do not need transactions if all they are doing is reading a database.
However, if you are doing multiple reads and you want them to be consistent, then you need to do them within a transaction.</p>
</div>
<div class="paragraph">
<p>Furthermore, even in the simplest of system, a single user environment where all operations are idempotent, retrying requires the capability to remember the list of participating resources as well as the operations that must be re-transmitted, potentially many times.
As we shall see, fortunately this is an inherent part of a transaction system, provided in a reliable manner such that it can tolerate its own failures as well as those that occur elsewhere within the environment.</p>
</div>
<div class="paragraph">
<p>Although the Web and REST have progressed well without the need for transactions there are a class of applications where the use of transactions, or at least atomicity, would be beneficial.
To support this need, we have created a RESTful interface to the Narayana transaction manager.</p>
</div>
</div>
<div class="sect2">
<h3 id="_transaction_model"><a class="anchor" href="#_transaction_model"></a>7.2. Transaction Model</h3>
<div class="paragraph">
<p>The REST Atomic Transaction (RESTAT) model uses a traditional two-phase commit protocol with the following optimizations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Presumed rollback: the transaction coordinator need not record information about the participants in stable storage until it decides to commit, i.e., until after the prepare phase has completed successfully.
A definitive answer that a transaction does not exist can be used to infer that it rolled back.</p>
</li>
<li>
<p>One-phase: if the coordinator discovers that only a single participant is registered then it may omit the prepare phase.</p>
</li>
<li>
<p>Read-only: a participant that is responsible for a service that did not modify any transactional data during the course of the transaction can indicate to the coordinator during prepare that it is a read-only participant and the coordinator can omit it from the second phase of the commit protocol.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_architecture"><a class="anchor" href="#_architecture"></a>7.2.1. Architecture</h4>
<div class="paragraph">
<p>The diagram below illustrates the various resources defined within the RESTAT protocol.
We shall discuss each of these in the following sections.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/rts-architecture.png" alt="rts architecture">
</div>
<div class="title">Figure 46. Architecture</div>
</div>
<div class="paragraph">
<p>These components are enumerated below and discussed in the following sections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Transaction Manager: this is a factory resource that is responsible for creating new transactions.
Once created, the transaction manager has no further role to play in the life of the transaction.</p>
</li>
<li>
<p>Transaction Coordinator: this is a specific resource for the transaction.
It drives the two-phase commit protocol and manages interactions with participants.</p>
</li>
<li>
<p>Client: the user of transactions.</p>
</li>
<li>
<p>Service: a transaction-aware service that performs work that may need to be coordinated with other such services elsewhere.</p>
</li>
<li>
<p>Participant: a resource that manages the state changes performed by the service in the context of a transaction.
The participant is driven through two-phase commit by the coordinator.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_state_transitions"><a class="anchor" href="#_state_transitions"></a>7.2.2. State Transitions</h4>
<div class="paragraph">
<p>A transaction coordinator and two-phase participant go through the state transitions shown:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/rts-state_transitions.png" alt="rts state transitions">
</div>
<div class="title">Figure 47. StateTransitions</div>
</div>
<div class="paragraph">
<p>As such, all of the resources in the protocol have statuses that can be represented as one of these values.
Asking a resource to change its state from, say, Active to Committed, may drive it through all of the intermediate states and as a result trigger protocol specific events, such as driving the two-phase commit protocol.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_transaction_manager_resource"><a class="anchor" href="#_the_transaction_manager_resource"></a>7.2.3. The Transaction Manager Resource</h4>
<div class="paragraph">
<p>The transaction manager is represented by a URI (referred to as the <em>transaction-manager</em> URI).
It enables clients to create new transaction resources and to query the list of current transactions.
The actual URI depends upon how RESTAT is deployed and will be discussed later.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="client_responsibilities"><a class="anchor" href="#client_responsibilities"></a>7.3. Client Responsibilities</h3>
<div class="paragraph">
<p>The RESTAT client is responsible for creating and terminating transaction resources.</p>
</div>
<div class="sect3">
<h4 id="_starting_a_transaction"><a class="anchor" href="#_starting_a_transaction"></a>7.3.1. Starting a Transaction</h4>
<div class="paragraph">
<p>Performing a POST on the <em>transaction-manager</em> URI with header as shown below will start a new transaction with a default timeout.
A successful invocation returns a 201 HTTP status code and the Location header contains the URI of the newly created transaction resource, which we refer to as transaction-coordinator in the rest of this book.
At least two related URLs will also be returned, one for use by the transaction terminator (typically referred to as the client) and one used for registering durable participation in the transaction (typically referred to as the server).
These URIs are referred to as the transaction-terminator and <em>transaction-enlistment</em> URIs, respectively.
Although uniform URL structures are used in the examples, these linked URLs can be of arbitrary format.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">POST /transaction-manager HTTP/1.1
From: foo@bar.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>The corresponding response would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">HTTP 1.1 201 Created
Location: /transaction-coordinator/1234
Link:<span class="tag">&lt;/transaction-coordinator</span>/1234/terminator<span class="error">&gt;</span>; rel=”terminator”,
    <span class="tag">&lt;/transaction-coordinator</span>/1234/participant<span class="error">&gt;</span>; rel=”durable-participant”,
    <span class="tag">&lt;/transaction-coordinator</span>/1234/vparticipant<span class="error">&gt;</span>; rel=”volatile-participant”</code></pre>
</div>
</div>
<div class="paragraph">
<p>The lifetime of the transaction resource can be controlled by including a timeout in milliseconds in the body of the POST request</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">POST /transaction-manager HTTP/1.1
From: foo@bar.com
Content-Type: text/plain
Content-Length: --

timeout=1000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Performing a HEAD on the <em>transaction-coordinator</em> URI returns the same link information.</p>
</div>
<div class="paragraph">
<p>Performing a DELETE on the <em>transaction-coordinator</em> or <em>transaction-enlistment</em> URIs are not allowed (and an attempt to do so will result in a 403 status code).</p>
</div>
</div>
<div class="sect3">
<h4 id="_obtaining_the_transaction_status"><a class="anchor" href="#_obtaining_the_transaction_status"></a>7.3.2. Obtaining The Transaction Status</h4>
<div class="paragraph">
<p>Performing a GET on the <em>transaction-coordinator</em> URI returns the current status of the transaction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">GET /transaction-coordinator/1234 HTTP/1.1
Accept: application/txstatus</code></pre>
</div>
</div>
<div class="paragraph">
<p>With an example response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">HTTP/1.1 200 OK
Content-Length: --
Content-Type: application/txstatus
Link:<span class="tag">&lt;/transaction-coordinator</span>/1234/terminator<span class="error">&gt;</span>; rel=”terminator”,
    <span class="tag">&lt;/transaction-coordinator</span>/1234/participant<span class="error">&gt;</span>; rel=”durable-participant”,
    <span class="tag">&lt;/transaction-coordinator</span>/1234/vparticipant<span class="error">&gt;</span>; rel=”volatile-participant”

txstatus=TransactionActive</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additional information about the transaction, such as the number of participants and their individual URIs, is returned if the client specifies the application/txstatusext+xml media type.
For full details of this extended media type please refer to the specification and to the xsd in the restat-util jar packaging ( <a href="https://github.com/jbosstm/narayana/tree/master/rts/at/util/src/main/resources/restat.xsd">https://github.com/jbosstm/narayana/tree/master/rts/at/util/src/main/resources/restat.xsd</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_propagating_the_context"><a class="anchor" href="#_propagating_the_context"></a>7.3.3. Propagating the Context</h4>
<div class="paragraph">
<p>When making an invocation on a resource that needs to participate in a transaction, either the <em>transaction-coordinator</em> URI or the <em>transaction-enlistment</em> URI (<code>/transaction-coordinator/1234/participant</code> in the previous example) needs to be transmitted to the resource.
Alternatively, if the client knows which endpoints the service will use to cancel or commit its work, it can do the registration and skip this requirement to propagate the context).
If the context is to be propagated then the mechanism is private to the service writer but the following OPTIONAL approach is recommended:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The URI is passed as a Link header with the relevant service interaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the RESTAT user follows this convention then we can provide tools to the service writer to automate transaction handling.
For example, if the client wishes to make a transactional service request then it should include a link to the URI used for enlisting into a transaction (which the client may have obtained when it first created the transaction) as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">Link:<span class="tag">&lt;/transaction-coordinator</span>/1234/participant<span class="error">&gt;</span>; rel=”durable-participant”</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">Link:<span class="tag">&lt;/transaction-coordinator</span>/1234<span class="error">&gt;</span>; rel=”transaction-coordinator”</code></pre>
</div>
</div>
<div class="paragraph">
<p>and similarly if the client wants to pass the volatile participant URI to the invoked REST service.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discovering_existing_transactions"><a class="anchor" href="#_discovering_existing_transactions"></a>7.3.4. Discovering Existing Transactions</h4>
<div class="paragraph">
<p>Performing a GET on the <em>transaction-manager</em> URI with media type <code>application/txlist</code> returns a list of all <em>transaction-coordinator</em> URIs known to the coordinator (active and in recovery).
The returned response includes a link header with <em>rel</em> attribute <em>statistics</em> linking to a resource that contains statistical information such as the number of transactions that have committed and aborted.</p>
</div>
<div class="paragraph">
<p>Performing a GET on the <em>transaction-manager</em> URI with media type <code>application/txstatusext+xml</code> returns extended information about the transaction-manager resource such as how long it has been up and all <em>transaction-coordinator</em> URIs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ending_the_transaction"><a class="anchor" href="#_ending_the_transaction"></a>7.3.5. Ending the Transaction</h4>
<div class="paragraph">
<p>The client can PUT a document containing the desired transaction status to the <em>transaction-terminator</em> URI in order to control the outcome of the transaction.
Upon termination, the resource and all associated resources are implicitly deleted.
If the client wishes to commit the transaction it sends the following resource update request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">PUT /transaction-coordinator/1234/terminator HTTP/1.1
From: foo@bar.com
Content-Type: application/txstatus
Content-Length: --

txstatus=TransactionCommitted</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response body contains the transaction outcome.
The state of the transaction resource must be <em>TransactionActive</em> for this operation to succeed otherwise a 412 status code is returned.</p>
</div>
<div class="paragraph">
<p>The transaction may be told to rollback with the following PUT request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">PUT /transaction-coordinator/1234/terminator HTTP/1.1
From: foo@bar.com
Content-Type: application/txstatus
Content-Length: --

txstatus=TransactionRolledBack</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_service_responsibilities"><a class="anchor" href="#_service_responsibilities"></a>7.4. Service Responsibilities</h3>
<div class="paragraph">
<p>Once a resource has the transaction or enlistment URI, it can register participation in the transaction (or, alternatively, as mentioned earlier it is possible for the client to register the service directly with the coordinator if it knows the services cancel and commit endpoints).
Each participant must be uniquely identified to the transaction coordinator in order that the protocol can guarantee consistency and atomicity in the event of failure and recovery.
The participant is free to use whatever URI structure it desires for uniquely identifying itself; in the rest of this manual we shall assume it is <code>/participant-resource</code> and refer to it as the <em>participant-resource</em> URI.</p>
</div>
<div class="sect3">
<h4 id="_joining_the_transaction"><a class="anchor" href="#_joining_the_transaction"></a>7.4.1. Joining the Transaction</h4>
<div class="sect4">
<h5 id="_two_phase_aware_participants"><a class="anchor" href="#_two_phase_aware_participants"></a>Two Phase Aware Participants</h5>
<div class="paragraph">
<p>A participant is registered with the <em>transaction-coordinator</em> using POST on the <em>participant-enlistment</em> URI obtained when the transaction was originally created.
The request must include two link headers: one to uniquely identify the participant to the coordinator and one to provide a terminator resource (referred to as the <em>participant-terminator</em> URI) that the coordinator will use to terminate the participant.
If the <em>rel</em> attributes of the link are not participant and terminator the implementation will return 400.
Note, the following URIs are only examples, and an implementation is free to use whatever structure/format it likes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">POST /transaction-coordinator/1234/participant
HTTP/1.1
From: foo@bar.com
Link:<span class="tag">&lt;/participant-resource&gt;</span>; rel=”participant”,
    <span class="tag">&lt;/participant-resource</span>/terminator<span class="error">&gt;</span>; rel=”terminator”

Content-Length: 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Performing a HEAD on the <em>participant-resource</em> URI will return the terminator reference, as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">HEAD /participant-resource HTTP/1.1
From: foo@bar.com

HTTP/1.1 200 OK
Link:<span class="tag">&lt;/participant-resource</span>/terminator<span class="error">&gt;</span>; rel=”terminator”</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the transaction is not <em>TransactionActive</em> when registration is attempted, then the implementation returns a 412 status code.
If the implementation has seen this participant URI before then it returns 400.
Otherwise the operation is considered a success and the implementation will return 201 and uses the Location header to give a participant specific URI that the participant may use later during prepare or for recovery purposes.
The lifetime of this URI is the same as the <em>transaction-coordinator</em> URI.
In the rest of this specification we shall refer to this as the <em>participant-recovery</em> URI (not to be confused with the <em>participant-resource</em> URI).
An example response from the <em>transaction-coordinator</em> to a successful enlistment request is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">HTTP/1.1 201 Created
Location: /participant-recovery/1234</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_two_phase_unaware_participants"><a class="anchor" href="#_two_phase_unaware_participants"></a>Two Phase Unaware Participants</h5>
<div class="paragraph">
<p>In order for a participant to be enlisted with a transaction it must be transaction aware to fulfill the requirements placed on it to ensure data consistency in the presence of failures or concurrent access.
However, it is not necessary that a participant be modified such that it has a terminator resource as outlined previously: it simply needs a way to tell the coordinator which resource(s) to communicate with when driving the two-phase protocol.
This type of participant will be referred to as Two-Phase Unaware, though strictly speaking such a participant or service does need to understand the protocol as mentioned earlier.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>enlisting two-phase unaware participants is not a mandatory requirement on service writers.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>During enlistment a service must provide URIs for prepare, commit, rollback and optionally a commit-one-phase URI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">POST /transaction-coordinator/1234/participant
HTTP/1.1
From: foo@bar.com
Link:<span class="tag">&lt;/participant-resource&gt;</span>; rel=”participant”,
    <span class="tag">&lt;/participant-resource</span>/prepare<span class="error">&gt;</span>; rel=”prepare”,
    <span class="tag">&lt;/participant-resource</span>/commit<span class="error">&gt;</span>; rel=”commit”,
    <span class="tag">&lt;/participant-resource</span>/rollback<span class="error">&gt;</span>; rel=”rollback”,
    <span class="tag">&lt;/participant-resource</span>/commit-one-phase<span class="error">&gt;</span>; rel=”commit-one-phase”

Content-Length: 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Performing a HEAD on a registered participant URI must return these references, as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">HEAD /participant-resource HTTP/1.1
From: foo@bar.com

HTTP/1.1 200 OK
Link:<span class="tag">&lt;/participant-resource</span>/prepare<span class="error">&gt;</span>; rel=”prepare”,
    <span class="tag">&lt;/participant-resource</span>/commit<span class="error">&gt;</span>; rel=”commit”,
    <span class="tag">&lt;/participant-resource</span>/rollback<span class="error">&gt;</span>; rel=”rollback”,
    <span class="tag">&lt;/participant-resource</span>/commit-one-phase<span class="error">&gt;</span>; rel=”commit-one-phase”</code></pre>
</div>
</div>
<div class="paragraph">
<p>A service that registers a participant must therefore either define a terminator relationship for the participant or the relationships/resources needed for the two-phase commit protocol.</p>
</div>
</div>
<div class="sect4">
<h5 id="_obtaining_the_participant_status"><a class="anchor" href="#_obtaining_the_participant_status"></a>Obtaining the Participant Status</h5>
<div class="paragraph">
<p>Performing an HTTP GET request on the <em>participant-resource</em> URI must return the current status of the participant in the same way as for the <em>transaction-coordinator</em> URI discussed earlier.
Determining the status of a participant whose URI has been removed is similar to that discussed for the <em>transaction-coordinator</em> URI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">GET /participant-resource HTTP/1.1
Accept: application/txstatus</code></pre>
</div>
</div>
<div class="paragraph">
<p>With an example response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">HTTP/1.1 200 OK
Content-Length: --
Content-Type: application/txstatus

txstatus=TransactionActive</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_leaving_the_transaction"><a class="anchor" href="#_leaving_the_transaction"></a>7.4.2. Leaving the Transaction</h4>
<div class="paragraph">
<p>A participant can leave the transaction at any time by sending a DELETE request to the coordinator using the URI it obtained during registration (i.e., the <em>participant-recovery</em> URI).
Alternatively, it can respond to a prepare request from the coordinator with content body containing <em>txstatus=TransactionReadOnly</em> (in which case the transaction coordinator will remove it from further participation in the transaction).
Otherwise it is the participants responsibility to participate in the <a href="#_2pc">transaction termination protocol</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_2pc"><a class="anchor" href="#_2pc"></a>7.4.3. Preparing and Committing Work</h4>
<div class="paragraph">
<p>The coordinator drives the participant through the two-phase commit protocol by sending a PUT request to the <em>participant-terminator</em> URI, provided to the coordinator during enlistment, with the desired transaction outcome as the content ( <em>TransactionPrepared</em>, <em>TransactionCommitted</em>, <em>TransactionRolledBack</em> or <em>TransactionCommittedOnePhase</em>).
For instance, here is how the prepare phase would be driven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">PUT /participant-resource/terminator HTTP/1.1
From: foo@bar.com
Content-Type: application/txstatus
Content-Length: --

txstatus=TransactionPrepared</code></pre>
</div>
</div>
<div class="paragraph">
<p>If PUT is successful then the implementation returns 200.
A subsequent GET on the URI will return the current status of the participant as described previously.
It is not always necessary to enquire as to the status of the participant once the operation has been successful.</p>
</div>
<div class="paragraph">
<p>If PUT fails, e.g., the participant cannot be prepared, then the service writer must return 409.
Depending upon the point in the two-phase commit protocol where such a failure occurs the transaction will roll back, e.g., because we use presumed abort semantics, failures prior to the end of the prepare phase <strong>always</strong> result in a rollback.
If the participant is not in the correct state for the requested operation, e.g., <em>TransactionPrepared</em> when it has already been prepared, then the service writer will return 412.</p>
</div>
<div class="paragraph">
<p>If the transaction coordinator receives any response other than 200 then the transaction <strong>always</strong> rolls back.</p>
</div>
<div class="paragraph">
<p>After a request to change the resource state using <em>TransactionRolledBack</em>, <em>TransactionCommitted</em> or <em>TransactionCommittedOnePhase</em>, any subsequent PUT request will return a 409 or 410 code.</p>
</div>
<div class="paragraph">
<p>The usual rules of heuristic decisions apply here (i.e., the participant cannot forget the choice it made until it is told to by the coordinator).</p>
</div>
<div class="paragraph">
<p>Performing a DELETE on the <em>participant-resource</em> URI will cause the participant to forget any heuristic decision it made on behalf of the transaction.
If the operation succeeds then 200 will be returned and the implementation will delete the resource; a subsequent PUT or GET request returns 410.
Any other response means the coordinator will keep retrying.</p>
</div>
</div>
<div class="sect3">
<h4 id="_recovery"><a class="anchor" href="#_recovery"></a>7.4.4. Recovery</h4>
<div class="paragraph">
<p>In general it is assumed that failed actors in this protocol, i.e., coordinator or participants, will recover on the same URI as they had prior to the failure.
HTTP provides a number of options to support temporary or permanent changes of address, including 301 (Moved Permanently) and 307 (Temporary Redirect), if the actor is unable to recover on the same URI then requests to the original endpoints should return an HTTP status code of 301 (Moved Permanently), 307 (Temporary Redirect) is also acceptable.</p>
</div>
<div class="paragraph">
<p>However, sometimes it is possible that a participant may crash and recover on a different URI, e.g., the original machine is unavailable, or that for expediency it is necessary to move recovery to a different machine.
In that case it may be the case that the transaction coordinator is unable to complete the transaction, even during recovery.
As a result this protocol defines a way for a recovering server to update the information maintained by the coordinator on behalf of these participants.</p>
</div>
<div class="paragraph">
<p>If the recovering participant uses the <em>participant-recovery</em> URI returned by the coordinator during enlistment then a GET on the <em>participant-recovery</em> URI will return the participant resource and terminator as link headers that the participant used during the original registration.</p>
</div>
<div class="paragraph">
<p>Performing a PUT on the <em>participant-recovery</em> URI will overwrite the old participant URI with the new one supplied.
This operation is equivalent to re-enlisting the participant.
This will also trigger off a recovery attempt on the associated transaction using the new participant URI.
For example to update location URIs, a two phase aware participant would PUT the following document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">PUT /participant-recovery/1234 HTTP/1.1
From: foo@bar.com
Link:<span class="tag">&lt;/new-participant-resource&gt;</span>; rel=”participant”,
<span class="tag">&lt;/participant-resource</span>/new-terminator<span class="error">&gt;</span>; rel=”terminator”

Content-Length: 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly for a two phase unaware participant.</p>
</div>
<div class="paragraph">
<p>If, after performing the PUT request to the <em>participant-recovery</em> URI, the participant is not asked to complete (within an implementation dependent period) then the protocol requires that the participant re-issue the PUT request.</p>
</div>
</div>
<div class="sect3">
<h4 id="_pre_and_post_two_phase_commit_processing"><a class="anchor" href="#_pre_and_post_two_phase_commit_processing"></a>7.4.5. Pre- and Post- Two-Phase Commit Processing</h4>
<div class="paragraph">
<p>Most modern transaction processing systems allow the creation of participants that do not take part in the two-phase commit protocol, but are informed before it begins and after it has completed.
They are called Synchronizations, and are typically employed to flush volatile (cached) state, which may be being used to improve performance of an application, to a recoverable object or database prior to the transaction committing.</p>
</div>
<div class="paragraph">
<p>This additional protocol is accomplished by supporting an additional two-phase commit protocol that encloses the protocol already discussed.
This will be termed the Volatile Two Phase Commit protocol, as the participants involved in it are not required to be durable for the purposes of data consistency, whereas the other protocol will be termed the Durable Two Phase Commit protocol.
The coordinator will not record any durable information on behalf of Volatile participants.</p>
</div>
<div class="paragraph">
<p>In this enclosing protocol the Volatile prepare phase executes prior to the Durable prepare.
The <em>transaction-coordinator</em> sends a PUT request to the registered <em>volatile-participant</em>: only if this prepare succeeds will the Durable protocol be executed.
The <em>volatile-participant</em> has to indicate success by returning a 200 status code (any other code indicates failure).
If the Durable protocol completes then this may be communicated to the Volatile participants through the commit or rollback phases.
In this case the <em>transaction-coordinator</em> sends a PUT request to the registered <em>volatile-participant</em> with the outcome in the request body (using content type <em>application/txstatus</em>).
However, because the coordinator does not maintain any information about these participants and the Durable protocol has completed, this is a best-effort approach only, i.e., such participants should not assume they will be informed about the transaction outcome.
If that is a necessity then they should register with the Durable protocol instead.</p>
</div>
<div class="paragraph">
<p>The primary difference between the Volatile and Durable protocols is that there is no recovery associated with the Volatile protocol so enlistment of volatile participants does not return a <em>participant-recovery</em> URI.
In addition there can be no heuristic outcomes associated with the Volatile protocol.
Once the Durable protocol has started no more registration in the Volatile protocol are allowed.
And finally, there is no one-phase commit optimization for the Volatile protocol.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_container_integration"><a class="anchor" href="#_container_integration"></a>7.5. Container Integration</h3>
<div class="paragraph">
<p>The RESTAT protocol described here is implemented as a JAX-RS service, deploys as a Servlet 3.0 application and depends on the Narayana TM as the back-end transaction engine.
JAX-RS is the Java language support for building REST based applications - it is both an annotation-based API for defining resources and a run-time for mapping HTTP requests to Java methods.
Thus any container supporting these two requirements (servlet 3.0 and the Narayana TM) can be used.</p>
</div>
<div class="sect3">
<h4 id="_deploying_as_a_wildfly_subsystem"><a class="anchor" href="#_deploying_as_a_wildfly_subsystem"></a>7.5.1. Deploying as a Wildfly Subsystem</h4>
<div class="paragraph">
<p>The RESTAT coordinator is integrated with the 8.0.0.Alpha3 and subsequent releases of the Wildfly application server ( <a href="http://www.wildfly.org/download/" class="bare">http://www.wildfly.org/download/</a> ) as a subsystem (called RTS) so you do not have to explicitly deploy it.
You do, however, need to start the application server using an optional server configuration:</p>
</div>
<div class="paragraph">
<p>change directory to where the application server is installed
* Linux</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./bin/standalone.sh --server-config=../../docs/examples/configs/standalone-rts.xml</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows</p>
<div class="listingblock">
<div class="content">
<pre>bin\standalone.bat --server-config=..\..\docs\examples\configs\standalone-rts.xml</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For this mode of deployment the <em>transaction-manager</em> URI is <a href="http://&lt;host&gt;:&lt;port&gt;/rest-at-coordinator/tx/transaction-manager" class="bare">http://&lt;host&gt;:&lt;port&gt;/rest-at-coordinator/tx/transaction-manager</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_deploying_into_a_servlet_container"><a class="anchor" href="#_deploying_into_a_servlet_container"></a>7.5.2. Deploying into a Servlet Container</h4>
<div class="paragraph">
<p>For other versions of the application server you will need to deploy the coordinator as a war archive using the standard war deployment mechanism appropriate to your particular container.
The archive is contained in the bin folder of the narayana download (restat-web.war).
If you are building from source the archive is located in <code>rts/at/webservice/target/restat-web-&lt;version&gt;.war</code>.</p>
</div>
<div class="paragraph">
<p>For this mode of deployment the <em>transaction-manager</em> URI is <code><a href="http://&lt;host&gt;:&lt;port&gt;/rest-tx/tx/transaction-manager" class="bare">http://&lt;host&gt;:&lt;port&gt;/rest-tx/tx/transaction-manager</a></code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_examples_5"><a class="anchor" href="#_examples_5"></a>7.6. Examples</h3>
<div class="paragraph">
<p>The quickstarts contained in the release bundles or in the quickstart repo (<code><a href="https://github.com/jbosstm/quickstart" class="bare">https://github.com/jbosstm/quickstart</a></code>) contain examples of all the features provided by RESTAT.
The unit tests in the source bundle are also a good resource for further examples.</p>
</div>
<div class="sect3">
<h4 id="_support_for_java_based_services"><a class="anchor" href="#_support_for_java_based_services"></a>7.6.1. Support For Java based Services</h4>
<div class="paragraph">
<p>For REST services written in Java there is a Utility class called org.jboss.jbossts.star.util.TxSupport in the source bundle (or is available at <a href="https://github.com/jbosstm/narayana" class="bare">https://github.com/jbosstm/narayana</a> ) which contains a variety of methods which help service writers to conform to the specification.
The majority of the RESTAT quickstarts use this utility API.</p>
</div>
<div class="paragraph">
<p>Alternatively, there is a RESTAT integration API for service writers.
This API takes care of transaction enlistment and handles the responsibility for listening for transaction completion requests on HTTP endpoints from the transaction coordinator.
Normally when a services wishes to join an existing transaction it sends a message to the coordinator containing HTTP endpoints on which it will be notified when the transaction progresses through its prepare and commit stages.
The integration API simplifies this task and instead the service enlists a participant which implements a callback interface (<code>org.jboss.narayana.rest.integration.api.ParticipantsManager</code>).
The API will then invoke the callback transparently (to the service) when the completion protocol begins executing.
This makes managing participants much cleaner for the service writer.
The service writer should implement the interface <code>org.jboss.narayana.rest.integration.api.Participant</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Participant</span> {
    Vote prepare();
    <span class="type">void</span> commit() <span class="directive">throws</span> HeuristicException;
    <span class="type">void</span> commitOnePhase();
    <span class="type">void</span> rollback() <span class="directive">throws</span> HeuristicException;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and register this implementation with the participant service manager:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ParticipantsManagerFactory.getInstance().enlist(...);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The getInstance method on the <code>ParticipantsManagerFactory</code> returns an instance of the interface <code>ParticipantsManager</code> which is global to the (JAX-RS) application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ParticipantsManager</span> {
    ...
    String enlist(<span class="predefined-type">String</span> applicationId,
    <span class="predefined-type">String</span> participantEnlistmentURL,
    Participant participant);
    <span class="type">void</span> registerDeserializer(<span class="predefined-type">String</span> applicationId,
    ParticipantDeserializer deserializer);
    <span class="type">void</span> reportHeuristic(<span class="predefined-type">String</span> participantId,
    HeuristicType heuristicType);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The participantEnlistmentURL in the enlist method corresponds to a running REST transaction which the service acquires during normal interactions with service clients.
To register for completion callbacks the service writer registers an interface using the enlist method and passes in an implementation of Participant.
For full details of this interface please refer to the javadoc for <code>org.jboss.narayana.rest.integration.api.ParticipantsManager</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Now when a service client terminates a transaction the services' callback methods will be invoked by the RESTAT coordinator which may or may not be running locally (since these are distributed transactions).
It is interesting to note that the wildfly application server is a modular container so subsystems and applications run in their own class loaders.
In the event of failures a recovery system will need to recreate participant callback registrations in order to complete any pending transaction and therefore will no longer have access to the original class.
The service writer must help the recovery system in this task via the registerDeserializer call.
The final method on the interface (reportHeuristic) is to allow services to independently abort or commit work before being asked to via the callback interface.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For full details of this interface please refer to the javadoc for <code>org.jboss.narayana.rest.integration.api.ParticipantsManager</code></p>
</div>
<div class="paragraph">
<p>The accessibility of the <code>ParticipantsManagerFactory</code> from your application depends upon whether the container contains the RTS subsystem.
Versions of the wildfly application server from <code>8.0.0.Alpha3</code> onwards contain this subsystem so your manifest should declare a dependency on it by adding the line "Dependencies: org.jboss.narayana.rts" to the <code>MANIFEST.MF</code> file in your archive.
For other containers you should register the dependency programatically.
The quickstarts contain examples of how to do this for the embedded Resteasy and Jersey JAX-RS containers (look for classes called JaxrsServer in the quickstart source for <code>rts/at/service/service2 and rts/at/recovery/recovery2</code>).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interoperating_with_other_transaction_models"><a class="anchor" href="#_interoperating_with_other_transaction_models"></a>7.7. Interoperating With Other Transaction Models</h3>
<div class="paragraph">
<p>Narayana in general supports a number of different transaction models other than the one described in this book.
Of particular importance are the standard ones supported by the standards, namely JTA and Web Services Transactions.</p>
</div>
<div class="sect3">
<h4 id="_jta_bridge"><a class="anchor" href="#_jta_bridge"></a>7.7.1. JTA Bridge</h4>
<div class="sect4">
<h5 id="_inbound_bridge"><a class="anchor" href="#_inbound_bridge"></a>Inbound Bridge</h5>
<div class="paragraph">
<p>REST-AT to JTA bridge (also called inbound bridge) allows JTA resources to be enlisted in REST-AT transaction.
Therefore, tools such as JPA and JMS can be used by JAX-RS endpoints and their XA resources will participate in the REST-AT transaction together with RESTful participants.</p>
</div>
<div class="paragraph">
<p>This functionality is provided by Wildfly RTS subsytem.
Therefore, modular dependency on org.jboss.narayana.rts has to be defined in deployment&#8217;s manifest file.
In order to enable bridging, service writer has to annotate either JAX-RS resource class or specific JAX-RS resource method with one of two annotations: <code>jakarta.ejb.TransactionAttribute</code>, <code>jakarta.transaction.Transactional</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">JAXRSResource</span> {
    <span class="annotation">@GET</span>
    <span class="directive">public</span> <span class="type">void</span> get() {
    <span class="comment">// Do work witout JTA.</span>
    }

    <span class="annotation">@POST</span>
    <span class="annotation">@TransactionAttribute</span>
    <span class="directive">public</span> <span class="type">void</span> post() {
    <span class="comment">// Do work with JTA.</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Transactional</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JAXRSResource</span> {
    <span class="annotation">@GET</span>
    <span class="directive">public</span> <span class="type">void</span> get() {
    <span class="comment">// Do work with JTA.</span>
    }

    <span class="annotation">@POST</span>
    <span class="directive">public</span> <span class="type">void</span> post() {
    <span class="comment">// Do work with JTA.</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>REST-AT transaction context does not provide timeout.
When REST-AT transaction is bridged to JTA then the bridged JTA transaction is created with the default timeout defined by the container.</p>
</div>
</div>
<div class="sect4">
<h5 id="_outbound_bridge"><a class="anchor" href="#_outbound_bridge"></a>Outbound Bridge</h5>
<div class="paragraph">
<p>Enabling RESTAT participants to participate in a JTA transaction.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Outbound bridging is not currently implemented</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_web_services_transactions"><a class="anchor" href="#_web_services_transactions"></a>7.7.2. Web Services Transactions</h4>
<div class="paragraph">
<p>WS includes two transaction models referred to as WSAT and WSBA.
WSAT integration with JTA is documented in the Transaction Bridging section of the product guide (<code><a href="http://narayana.io/docs/product/index.html#txbridge" class="bare">http://narayana.io/docs/product/index.html#txbridge</a></code>).
By using this bridge in conjunction with the RESTAT JTA bridge full interoperability between RESTAT and WSAT can be realised.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>RESTAT outbound bridging is not currently supported so interoperability is one way only.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stm"><a class="anchor" href="#_stm"></a>8. STM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we shall look at the Software Transactional Memory (STM) implementation that ships as part of Narayana.
Software Transactional Memory (STM) has been around in research environments since the late 1990&#8217;s and has relatively recently started to appear in products and various programming languages.
We won&#8217;t go into all of the details behind STM but the interested reader could look at this paper (<code><a href="https://groups.csail.mit.edu/tds/papers/Shavit/ShavitTouitou-podc95.pdf" class="bare">https://groups.csail.mit.edu/tds/papers/Shavit/ShavitTouitou-podc95.pdf</a></code>).
However, suffice it to say that STM offers an approach to developing transactional applications in a highly concurrent environment with some of the same characteristics of ACID transactions, which you&#8217;ve probably already used through JTA.
Importantly though, the Durability property is relaxed (removed) within STM implementations, or at least made optional.
This is not the situation with JTA, where state changes are made durable to a relational database which supports the X/Open XA standard.</p>
</div>
<div class="paragraph">
<p>Now you may be asking yourself "Why STM instead of JTA?" or "What are the benefits to STM that I don&#8217;t get from JTA?" We will try to answer those and similar questions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The goal of STM is to simplify object reads and writes from multiple threads/protect state from concurrent updates.
The Narayana STM implementation will safely manage any conflicts between these threads using whatever isolation model has been chosen to protect that specific state instance.
In STM, there are two isolation implementations, pessimistic (the default), which would cause conflicting threads to be blocked until the original has completed its updates (committed or aborted the transaction); then there is the optimistic approach which allows all of the threads to proceed and checks for conflicts at commit time, where one or more of the threads may be forced to abort if there have been conflicting updates.</p>
</li>
<li>
<p>STM objects have state but it does not need to be persistent (durable).
In fact the default behaviour is for objects managed within transactional memory to be volatile, such that if the service or microservice within which they are being used crashes or is spawned elsewhere, e.g., by a scheduler, all state in memory is lost and the objects start from scratch.
But surely you get this and more with JTA (and a suitable transactional datastore) and do not need to worry about restarting your application?
Not quite.
There is a trade-off here: we are doing away with persistent state and the overhead of reading from and then writing (and sync-ing) to the datastore during each transaction.
This makes updates to (volatile) state very fast but you still get the benefits of atomic updates across multiple STM objects (e.g., objects your team wrote then calling objects you inherited from another team and requiring them to make all-or-nothing updates), as well as consistency and isolation in the presence of concurrent threads/users (common in distributed microservices architectures).
Furthermore, not all stateful applications need to be durable - even when JTA transactions are used, they tend to be the exception and not the rule.</p>
</li>
<li>
<p>Another benefit of STM is composability and modularity.
You can write concurrent objects/services that can be easily composed with any other services built using STM, without exposing the details of how the objects/services are implemented.
As we discussed earlier, this ability to compose objects you wrote with those other teams may have written weeks, months or years earlier, and have A, C and I properties can be hugely beneficial.
Furthermore, some STM implementations, including the Narayana version, support nested transactions and these allow changes made within the context of a nested (sub) transaction to later be rolled back by the parent transaction.</p>
</li>
<li>
<p>Although the default for STM object state is volatile, it is possible to configure the STM implementation such that an object&#8217;s state is durable.
Although it&#8217;s possible to configure Narayana such that different backend datastores can be used, including relational databases, the default is the local operating system file system, which means you don&#8217;t need to configure anything else, such as a database.</p>
</li>
<li>
<p>Many STM implementations allow "plain old language objects" to be made STM-aware with little or no changes to the application code.
You can build, test and deploy applications without wanting them to be STM-aware and then later add those capabilities if they become necessary and without much development overhead at all.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Narayana STM implementation builds on the Transactional Objects for Java (TXOJ) framework which has offered building blocks for the construction of transactional objects via inheritence.
The interested reader should look at the text on TXOJ within the ArjunaCore documentation for more in depth details.
However, within TXOJ an application class can inherit from the LockManager class to obtain persistence (D) and concurrency (I), whilst at the same time having the flexibility to change some of these capabilities.
For example, an object could be volatile, i.e., no durability, and yet still maintain the other transactional properties.</p>
</div>
<div class="paragraph">
<p>If you look at the abilities that TXOJ offers to developers then it shares many aspects with STM.
However, the downside is that developers need to modify their classes through class inheritence (something which is not always possible), add suitable extension methods (for saving and restoring state), set locks etc.
None of this is entirely unreasonable, but it represents a barrier to some and hence is one of the reasons we decided to provide a separate STM implementation.</p>
</div>
<div class="sect2">
<h3 id="_an_stm_example"><a class="anchor" href="#_an_stm_example"></a>8.1. An STM Example</h3>
<div class="paragraph">
<p>In order to illustrate the Narayana STM implementation we shall use a worked example throughout the rest of this chapter.
We&#8217;ll make it simple to start with, just a atomic integer that supports set, get and increment methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Atomic</span> {
   <span class="directive">public</span> <span class="type">void</span> incr (<span class="type">int</span> value) <span class="directive">throws</span> <span class="exception">Exception</span>;
   <span class="directive">public</span> <span class="type">void</span> set (<span class="type">int</span> value) <span class="directive">throws</span> <span class="exception">Exception</span>;
   <span class="directive">public</span> <span class="type">int</span> get () <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll throw exceptions from each method just in case, but obviously you could just as easily catch any problems which occur and return booleans or some other indicator from the increment and set methods.</p>
</div>
<div class="paragraph">
<p>In this example we&#8217;ll next create an implementation class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ExampleInteger</span> <span class="directive">implements</span> Atomic {
   <span class="directive">public</span> <span class="type">int</span> get () <span class="directive">throws</span> <span class="exception">Exception</span> {
       <span class="keyword">return</span> state;
   }

   <span class="directive">public</span> <span class="type">void</span> set (<span class="type">int</span> value) <span class="directive">throws</span> <span class="exception">Exception</span> {
       state = value;
   }

   <span class="directive">public</span> <span class="type">void</span> incr (<span class="type">int</span> value) <span class="directive">throws</span> <span class="exception">Exception</span> {
       state += value;
   }

   <span class="directive">private</span> <span class="type">int</span> state;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is pretty straightforward and we won&#8217;t go into it here.
However, so far apart from inheriting from our Atomic interface there&#8217;s nothing to call this implementation out as being atomic.
That&#8217;s because we haven&#8217;t actually done anything STM related to the code yet.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s start to modify it by adding in STM specific elements.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All class scope annotations should be applied to the interface whereas method scope annotations should be applied to the implementation class.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s start by looking at the Atomic interface.
First of all any transactional objects must be instrumented as such for the underyling STM implementation to be able to differentiate them from non-transactional objects.
To do that you use the Transactional annotation on the class.
Next we need to ensure that our transactional object(s) is free from conflicts when used in a concurrent environment, so we have to add information about the type of operation, i.e., whether or not the method modifies the state of the object.
You do this using either the ReadLock or WriteLock annotations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you do not add locking annotations to the methods on your Transactional interface then Narayana will default to assuming they all potentially modify the object&#8217;s state.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this stage we end up with a modified interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transactional</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Atomic</span> {
   <span class="directive">public</span> <span class="type">void</span> incr (<span class="type">int</span> value) <span class="directive">throws</span> <span class="exception">Exception</span>;
   <span class="directive">public</span> <span class="type">void</span> set (<span class="type">int</span> value) <span class="directive">throws</span> <span class="exception">Exception</span>;
   <span class="directive">public</span> <span class="type">int</span> get () <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>public class ExampleInteger implements Atomic {
   @ReadLock
   public int get () throws Exception {
       return state;
   }

   @WriteLock
   public void set (int value) throws Exception {
       state = value;
   }

   @WriteLock
   public void incr (int value) throws Exception {
       state += value;
   }

   private int state;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, these are fairly straightfoward (and hopefully intuitive) changes to make.
Everything else is defaulted, though will we will discuss other annotations later once we go beyond the basic example.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We are contemplating allowing method annotations to be applied on the interface and then overridden on the implementation class.
For now if you follow the above conventions you will continue to be compatible if this change is eventually supported.
<a href="https://issues.jboss.org/browse/JBTM-2172" class="bare">https://issues.jboss.org/browse/JBTM-2172</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we have a transactional class, by virtue of its dependency on the Atomic interface, how we go about creating instances of the corresponding STM object and use it (them) within transactions?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Container</span>&lt;Atomic&gt; theContainer = <span class="keyword">new</span> <span class="predefined-type">Container</span>&lt;Atomic&gt;();
ExampleInteger basic = <span class="keyword">new</span> ExampleInteger();
Atomic obj = theContainer.create(basic);
AtomicAction a = <span class="keyword">new</span> AtomicAction();

a.begin();

obj.set(<span class="integer">1234</span>);

a.commit();

<span class="keyword">if</span> (obj.get() == <span class="integer">1234</span>)
   <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">State changed ok!</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">else</span>
   <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">State not changed!</span><span class="delimiter">&quot;</span></span>);
a = <span class="keyword">new</span> AtomicAction();

a.begin();

obj.change(<span class="integer">1</span>);

a.abort();

<span class="keyword">if</span> (obj.get() == <span class="integer">1234</span>)
   <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">State reverted to 1234!</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">else</span>
   <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">State is wrong!</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For clarity we&#8217;ve removed some of the error checking code in the above example, but let&#8217;s walk through exactly what is going on.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some of the discussions around AtomicAction etc. are deliberately brief here because you can find more information in the relevant ArjunaCore documentation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In order for the STM subsystem to have knowledge about which classes are to be managed within the context of transactional memory it is necessary to provide a minimal level of instrumentation.
This occurs by categorising STM-aware and STM-unaware classes through an interface boundary; specifically all STM-aware objects must be instances of classes which inherit from interfaces that themselves have been annotated to identify them as STM-aware.
Any other objects (and their classes) which do not follow this rule will not be managed by the STM subsystem and hence any of their state changes will not be rolled back, for example.
Therefore, the first thing we need to do is create an STM Container.
We need to tell each Container about the type of objects for which it will be responsible.
Then we create an instance of our <code>ExampleInteger</code>.
However, we can&#8217;t use it directly because at this stage its operations aren&#8217;t being monitored by the Container.
Therefore, we pass the instance to the Container and obtain a reference to an Atomic object through which we can operate on the STM object.</p>
</div>
<div class="paragraph">
<p>At this point, if we called the operations such as incr on the Atomic instance we wouldn&#8217;t see any difference in behaviour: there are no transactions in flight to help provide the necessary properties.
Let&#8217;s change that by creating an AtomicAction (transaction) and starting it.
Now when we operate on the STM object all of the operations, such as set, will be performed within the scope of that transaction because it is associated with the thread of control.
At this point, if we commit the transaction object the state changes will be made permanent (well not quite, but that&#8217;s a different story and one you can see when we discuss the Container in more detail later.)</p>
</div>
<div class="paragraph">
<p>The rest of the example code simply repeats the above, except this time instead of committing the transaction we roll it back.
What happens in this case is that any state changes which were performed within the scope of the transaction are automatically undone and we get back the state of the object(s) as it existed prior to the operations being performed.</p>
</div>
<div class="paragraph">
<p>Pretty simple and not too much additional work on the part of the developer.
Most of the ways in which you will use the Narayana STM implementation come down to similar approaches to what we&#8217;ve seen in the example.
Where things may differ are in the various advanced options available to the developer.
We&#8217;ll discuss those next as we look at all of the user classes and annotations that are available.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All of the classes, interfaces and annotations that you should be using can be located within the <code>org.jboss.stm and org.jboss.stm.annotations</code> packages.
All other classes etc.
located within <code>org.jboss.stm.internal</code> are private implementation specific aspects of the framework and subject to change without warning.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_annotations"><a class="anchor" href="#_annotations"></a>8.2. Annotations</h3>
<div class="paragraph">
<p>The following annotations are available for use on STM interfaces or classes.</p>
</div>
<div class="paragraph">
<p><code>@Transactional</code>: Used on the interface.
Defines that implementations of the interface are to be managed within a transactional container.
Unless specified using other annotations, all public methods will be assumed to modify the state of the object, i.e., require write locks.
All state variables will be saved and restored unless marked explicitly using the @State annotation or SaveState/RestoreState.
This assumes currently that all state modification and locking occurs through public methods, which means that even if there are private, protected or package scope methods that would change the state, they will not be tracked.
Therefore, the implementation class should not modify state unless by calling its own public methods.
All methods should either be invoked within a transactional context or have the Nested annotation applied, wherein the system will automatically create a new transaction when the method is invoked.</p>
</div>
<div class="paragraph">
<p><code>@Optimistic</code>: Used on the interface.
Specifies that the framework should use optimistic concurrency control for managing interactions on the instances.
This may mean that a transaction is forced to abort at the end due to conflicting updates made by other users.
The default is @Pessimistic.</p>
</div>
<div class="paragraph">
<p><code>@Pessimistic</code>: Used on the interface.
Specifies that pessimistic concurrency control should be used.
This means that a read or write operation may block or be rejected if another user is manipulating the same object in a conflicting manner.
If no other annotation appears to override this, then pessimistic is the default for a transactional object.</p>
</div>
<div class="paragraph">
<p><code>@Nested</code>: Used on the interface or class.
Defines that the container will create a new transaction for each method invocation, regardless of whether there is already a transaction associated with the caller.
These transactions will then either be top-level transactions or nested automatically depending upon the context within which they are created.</p>
</div>
<div class="paragraph">
<p><code>@NestedTopLevel</code>: Used on the interface or class.
Defines that the container will create a new transaction for each method invocation, regardless of whether there is already a transaction associated with the caller.
These transactions will always be top-level transactions even if there is a transaction already associated with the invoking thread.</p>
</div>
<div class="paragraph">
<p><code>@ReadLock</code>: Used on the class method.
The framework will grab a read lock when the method is invoked.</p>
</div>
<div class="paragraph">
<p><code>@WriteLock</code>: Used on the class method.
The framework will grab a write lock then the method is invoked.</p>
</div>
<div class="paragraph">
<p><code>@LockFree</code>: Used on the class method.
No locks will be obtained on this method, though any transaction context will still be on the thread when the method is invoked.</p>
</div>
<div class="paragraph">
<p><code>@TransactionFree</code>: Used on the class method.
This means that the method is not transactional, so no context will exist on the thread or locks acquired/released when the method is invoked.</p>
</div>
<div class="paragraph">
<p><code>@Timeout</code>: Used on the class method.
If pessimistic concurrency control is being used then a conflict will immediately cause the operation to fail and the application can do something else.
If instead the developer wants the system to retry getting the lock before returning, then this annotation defines the time between each retry attempt in milliseconds.</p>
</div>
<div class="paragraph">
<p><code>@Retry</code>: Used on the class method.
If pessimistic concurrency control is being used then a conflict will immediately cause the operation to fail and the application can do something else.
If instead the developer wants the system to retry getting the lock before returning, then this annotation defines the number of retry attempts.</p>
</div>
<div class="paragraph">
<p><code>@State</code>: Used on the class member variables to define which state will be saved and restored by the transaction system.
By default, all member variables (non-static, non-volatile) will be saved.</p>
</div>
<div class="paragraph">
<p><code>@NotState</code>: Used on the class member variables to define which state to ignore when saving/restoring instance data.
Note that any member variable that is not annotated with NotState will be saved and restored by the transaction system, irrespective of whether or not it has the State annotation.
You should use these annotations cautiously because if you limit the state which is saved (and hence restored) you may allow dirty data to cross transaction boundaries.</p>
</div>
<div class="paragraph">
<p><code>@SaveState</code>: Used on the class method to define the specific save_state method for the class.
This is used in preference to any @State indications on the class state.
This is the case no matter where in the class hierarchy it occurs.
So if you have a base class that uses save/restore methods the inherited classes must have them too if their state is to be durable.
In future we may save/restore specifically for each class in the inheritance hierarchy.</p>
</div>
<div class="paragraph">
<p><code>@RestoreState</code>: Used on the class method to define the specific restore_state method for the class.
This is used in preference to any @State indications on the class state.</p>
</div>
</div>
<div class="sect2">
<h3 id="_containers_volatility_and_durability"><a class="anchor" href="#_containers_volatility_and_durability"></a>8.3. Containers, Volatility and Durability</h3>
<div class="paragraph">
<p>By default objects created within STM do not possess the Durable aspect of traditional ACID transactions, i.e., they are volatile instances.
This has an obvious performance benefit since there is no disk or replicated in-memory data store involved.
However, it has disadvantages.
If the objects are Pessimitic or Optimistic then they can be shared between threads in the same address space (JVM instance).
At the time of writing Optimistic objects cannot be shared between address spaces.</p>
</div>
<div class="paragraph">
<p>Most of the time you will want to create volatile STM objects, with the option of using optimistic of pessimistic concurrency control really down to the type of application you are developing.
As such you use of Containers will be very similar to that which we have seen already:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TestContainer&lt;Sample&gt; theContainer = <span class="keyword">new</span> TestContainer&lt;Sample&gt;();
SampleLockable tester = <span class="keyword">new</span> SampleLockable();
Sample proxy = theContainer.enlist(tester);</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, the Container class has a number of extensibility options available for the more advanced user and requirements, which we shall discuss in the rest of this section.</p>
</div>
<div class="paragraph">
<p>By default when you create a Container it is used to manage volatile objects.
In STM language we call these objects recoverable due to the fact their state can be recovered in the event of a transaction rolling back, but not if there is a crash.
The Container therefore supports two types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">enum</span> TYPE { RECOVERABLE, PERSISTENT };</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can therefore use the TYPE constructore to create a Container of either type.
You can always determine the type of a Container later by calling the type() method.</p>
</div>
<div class="paragraph">
<p>All Containers can be named with a String.
We recommend uniquely naming your Container instances and in fact if you do not give your Container a name when it is created using the default constructure then the system will assign a unique name (an instance of a Narayana Uid).
If you want to give you Container a name then you can use the constructor that takes a String and you can get the name of any Container instance by calling the name() method.
The default type of a Container is RECOVERABLE.</p>
</div>
<div class="paragraph">
<p>The Container also supports two sharing models for objects created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">enum</span> MODEL { SHARED, EXCLUSIVE };</code></pre>
</div>
</div>
<div class="paragraph">
<p>SHARED means the instance may be used within multiple processes.
It must be PERSISTENT too; if not then the framework.
EXCLUSIVE means that the instance will only be used within a single JVM, though it can be PERSISTENT or RECOVERABLE.
You can get the model used by your container by calling the model() method.
The default model for a Container is EXCLUSIVE.</p>
</div>
<div class="paragraph">
<p>Given the above information, you should now be able to understand what the various constructors of the Container class do, since they provide the ability to modify the behaviour of any created instance through combinations of the above three parameters.
Where a given parameter is not available in a specific constructor, the default value discussed previously is used.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sharing_stm_objects"><a class="anchor" href="#_sharing_stm_objects"></a>8.4. Sharing STM Objects</h3>
<div class="paragraph">
<p>Once a Container is created, you can use the create() method to create objects (handles) within the STM.
As shown in the previous example, you pass in an unmodified (with the possible exception of annotations) class instance which corresponds to the interface type given to the Container when it was created and the Container will return a reference to an instance of the same type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Sample1 obj1 = theContainer.create(<span class="keyword">new</span> Sample1Imple(<span class="integer">10</span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>All objects thus created are uniquely identified by the system.
You can obtain their identifier (an instance of the Uid class) at any time by calling the getIdentifier method of the corresponding Container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Uid id = theContainer.getIdentifier(obj1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be useful for debugging purposes.
However, it can also be useful if you want to create a duplicate handle to the object for another thread to use.
This is not strictly necessary when using the default Pessimistic concurrency control, but is a requirement when using Optimistic (MVCC) (see relevant section).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not share the same reference for an Optimistic object with multiple threads.
You must use the clone() operation for each thread.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are two variants of the clone() operation.
Both of them require an empty instance of the original non-STM class to clone the data in to (this does not actually happen for Pessimistic instances, but is still required at present for uniformity):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">synchronized</span> T clone (T member, T proxy)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This version requires a reference to the STM object that is being cloned as the second parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Sample1 obj2 = theContainer.clone(<span class="keyword">new</span> Sample1Imple(), obj1);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second version is similar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">synchronized</span> T clone (T member, Uid id)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time instead of a reference you can provide the object&#8217;s identifier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Sample1 obj2 = theContainer.clone(<span class="keyword">new</span> Sample1Imple(), theContainer.getIdentifier(obj1));</code></pre>
</div>
</div>
<div class="paragraph">
<p>You are free to use either clone() operation depending upon what information your program has available.</p>
</div>
</div>
<div class="sect2">
<h3 id="_state_management_2"><a class="anchor" href="#_state_management_2"></a>8.5. State Management</h3>
<div class="paragraph">
<p>Earlier in this chapter we discussed how you can instrument your implementation class member variables with the State and NotState annotations to indicate what state should be saved and restored by the transaction system.
In some situations you may want even more control over this process and this is where the @SaveState and @RestoreState annotations come in.
These annotations let you define a method which will be called when the system needs to save your objec&#8217;s state and likewise when it needs to restore it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You must use SaveState and RestoreState annotations together, i.e., you cannot just define one without the other.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Your methods can be called whatever you want but they must have the following signatures.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@SaveState</code></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> save_state (OutputObjectState os) <span class="directive">throws</span> <span class="exception">IOException</span></code></pre>
</div>
</div>
</li>
<li>
<p><code>@RestoreState</code></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> restore_state (InputObjectState os) <span class="directive">throws</span> <span class="exception">IOException</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each operation is then given complete control over which state variables are saved and restored at the appropriate time.
Any state-related annotations on member instance variables are ignored by the framework so you must ensure that all state which can be modified within the scope of a transaction must be saved and restored if you want it to be manipulated appropriately by the transaction.</p>
</div>
<div class="paragraph">
<p>For instance, look at the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DummyImple</span> <span class="directive">implements</span> Dummy {
        <span class="directive">public</span> DummyImple () {
            _isNotState = <span class="predefined-constant">false</span>;
            _saved = <span class="integer">1234</span>;
        }

        <span class="annotation">@ReadLock</span>
        <span class="directive">public</span> <span class="type">int</span> getInt () {
            <span class="keyword">return</span> _saved;
        }

        <span class="annotation">@WriteLock</span>
        <span class="directive">public</span> <span class="type">void</span> setInt (<span class="type">int</span> value) {
            _saved = value;
        }

        <span class="annotation">@ReadLock</span>
        <span class="directive">public</span> <span class="type">boolean</span> getBoolean () {
            <span class="keyword">return</span> _isNotState;
        }

        <span class="annotation">@WriteLock</span>
        <span class="directive">public</span> <span class="type">void</span> setBoolean (<span class="type">boolean</span> value) {
            _isNotState = value;
        }

        <span class="annotation">@SaveState</span>
        <span class="directive">public</span> <span class="type">void</span> save_state (OutputObjectState os) <span class="directive">throws</span> <span class="exception">IOException</span> {
           os.packInt(_saved);
        }

        <span class="annotation">@RestoreState</span>
        <span class="directive">public</span> <span class="type">void</span> restore_state (InputObjectState os) <span class="directive">throws</span> <span class="exception">IOException</span> {
            _saved = os.unpackInt();
        }

        <span class="directive">public</span> <span class="type">int</span> _saved;
        <span class="directive">public</span> <span class="type">boolean</span> _isNotState;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, only the int member variable is saved and restored.
This means that any changes made to the other member variable(s) within the scope of any transaction, in this case the boolean, will not be undone in the event the transaction(s) rolls back.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use the SaveState and RestoreState annotations with care as you could cause dirty data to be visible between transactions if you do not save and restore all of the necessary state.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_optimistic_concurrency_control"><a class="anchor" href="#_optimistic_concurrency_control"></a>8.6. Optimistic Concurrency Control</h3>
<div class="paragraph">
<p>Per object concurrency control is done through locks and type specific concurrency control is available.
You can define locks on a per object and per method basis, and combined with nested transactions this provides for a flexible way of structuring applications that would typically not block threads unless there is really high contention.
All but the @Transactional annotation are optional, with sensible defaults taken for everything else including locks and state.</p>
</div>
<div class="paragraph">
<p>However, the locking strategy we had originally was pessimistic.
Most transaction systems utilize what is commonly referred to as pessimistic concurrency control mechanisms: in essence, whenever a data structure or other transactional resource is accessed, a lock is obtained on it as described earlier.
This lock will remain held on that resource for the duration of the transaction and the benefit of this is that other users will not be able to modify (and possibly not even observe) the resource until the holding transaction has terminated.
There are a number of disadvantages of this style: (i) the overhead of acquiring and maintaining concurrency control information in an environment where conflict or data sharing is not high, (ii) deadlocks may occur, where one user waits for another to release a lock not realizing that that user is waiting for the release of a lock held by the first.</p>
</div>
<div class="paragraph">
<p>The obvious alternative to this approach is optimistic or MVCC.
Therefore, optimistic concurrency control assumes that conflicts are not high and tries to ensure locks are held only for brief periods of time: essentially locks are only acquired at the end of the transaction when it is about to terminate.
This kind of concurrency control requires a means to detect if an update to a resource does conflict with any updates that may have occurred in the interim and how to recover from such conflicts.
Typically detection will happen using timestamps, whereby the system takes a snapshot of the timestamps associated with resources it is about to use or modify and compares them with the timestamps available when the transaction commits.</p>
</div>
<div class="paragraph">
<p>As discussed previously, there are two annotations: @Optimistic and @Pessimistic, with Pessimistic being the default, i.e., if no annotation is present, then the STM framework will assume you want pessimistic concurrency control.
These are defined on a per interface basis and define the type of concurrency control implementation that is used whenever locks are needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transactional</span>
<span class="annotation">@Optimistic</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SampleLockable</span> <span class="directive">implements</span> Sample {
   <span class="directive">public</span> SampleLockable (<span class="type">int</span> init) {
      _isState = init;
   }

   <span class="annotation">@ReadLock</span>
   <span class="directive">public</span> <span class="type">int</span> value () {
      <span class="keyword">return</span> _isState;
   }

   <span class="annotation">@WriteLock</span>
   <span class="directive">public</span> <span class="type">void</span> increment () {
      _isState++;
   }

   <span class="annotation">@WriteLock</span>
   <span class="directive">public</span> <span class="type">void</span> decrement () {
      _isState--;
   }

   <span class="annotation">@State</span>
   <span class="directive">private</span> <span class="type">int</span> _isState;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s it.
No other changes are needed to the interface or to the implementation.
However, at present there is a subtle change in the way in which you create your objects.
Recall how that was done previously and then compare it with the style necessary when using optimistic concurrency control:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Container</span> theContainer = <span class="keyword">new</span> <span class="predefined-type">Container</span>();
Sample obj1 = theContainer.create(<span class="keyword">new</span> SampleLockable(<span class="integer">10</span>));
Sample obj2 = theContainer.clone(<span class="keyword">new</span> SampleLockable(<span class="integer">10</span>),obj1);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the original pessimistic approach the instance <code>obj1</code> can be shared between any number of threads and the STM implementation will ensure that the state is manipulated consistently and safely.
However, with optimistic concurrency we need to have one instance of the state per thread.
So in the above code we first create the object (<code>obj1</code>) and then we create a copy of it (<code>obj2</code>), passing a reference to the original to the container.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Remember that the same reference to Optimistic (MVCC) objects cannot be shared between different threads: you must use the clone() operation on the corresponding Container for each thread which wishes to use the object.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_a_typical_use_case"><a class="anchor" href="#_a_typical_use_case"></a>8.7. A Typical Use Case</h3>
<div class="paragraph">
<p>In this chapter we have considered all of the publicly available interfaces and classes for the STM framework within Narayana.
There is deliberately a lot of flexibility on offer but much of it will only be needed by more advanced users and use cases.
In this section we shall consider the most typical way in which we believe users will want to use the STM implementation.
Let&#8217;s consider the interface first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transactional</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Sample</span> {
       <span class="directive">public</span> <span class="type">void</span> increment ();
       <span class="directive">public</span> <span class="type">void</span> decrement ();

       <span class="directive">public</span> <span class="type">int</span> value ();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whilst MVCC (optimistic concurrency control) is available, it is most useful in environments with a high degree of contention.
Even then, with the ability to control the timeout and retry values of the locking used by the pessimistic concurrency control option, the surety of making progress in a longer running transaction and not being forced to roll back later can be an advantage.
Therefore, pessimistic (the default) is probably the approach you will want to take initially.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s look at the implementation class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyExample</span> <span class="directive">implements</span> Sample {
        <span class="directive">public</span> MyExample () {
            <span class="local-variable">this</span>(<span class="integer">0</span>);
        }

        <span class="directive">public</span> MyExample (<span class="type">int</span> init) {
            _isState = init;
        }

        <span class="annotation">@ReadLock</span>
        <span class="directive">public</span> <span class="type">int</span> value () {
            <span class="keyword">return</span> _isState;
        }

        <span class="annotation">@WriteLock</span>
        <span class="directive">public</span> <span class="type">void</span> increment () {
            _isState++;
        }

        <span class="annotation">@WriteLock</span>
        <span class="directive">public</span> <span class="type">void</span> decrement () {
            _isState--;
        }

        <span class="directive">private</span> <span class="type">int</span> _isState;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By this point it should look fairly straightforward.
We&#8217;ve kept it simple deliberately, but it can be as complex as your application requires.
There are no nested transactions at work here, but you can easily add them using the Nested annotation.
Remember that they give you improved modularity as well as the ability to better control failures.</p>
</div>
<div class="paragraph">
<p>Because STM implementations typically relax or remove the durability aspect, you are more likely to want to create volatile objects, i.e., objects that do not survive the crash and repair of the JVM on which they are created.
Therefore, you should use the default Container constructor, unless you want to control the name of the instance and in which case you can pass in an arbitrary string.
Then all that is left is the creation and manipulation of AtomicActions as you invoke the relevant methods on your object(s).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">MyExample ex = <span class="keyword">new</span> MyExample(<span class="integer">10</span>);
<span class="predefined-type">Container</span>&lt;Sample&gt; theContainer = <span class="keyword">new</span> <span class="predefined-type">Container</span>&lt;Sample&gt;();    Sample obj1 = theContainer.create(ex);
AtomicAction act = <span class="keyword">new</span> AtomicAction();

act.begin();

obj1.increment();

act.commit();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compensating_transactions"><a class="anchor" href="#_compensating_transactions"></a>9. Compensating transactions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview_4"><a class="anchor" href="#_overview_4"></a>9.1. Overview</h3>
<div class="paragraph">
<p>Compensating transactions are acknowledged as a good fit for long-lived transactions.
The idea comes out of (<a href="https://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf">the Sagas paper, Princeton University, 1987</a>).
The concept of the original paper talks about a single node database but the concepts described can readily be applied to distributed transactions.</p>
</div>
<div class="paragraph">
<p>Structurally, applications utilising Sagas may consist of several atomic transactions each working with a separate system and with corresponding compensation handlers to deal with failures.
The Saga as a whole then presents an atomic work of unit where changes made by atomic transactions are visible immediately but in the case of failure a recovery handling is employed.
As such, saga transactions can cooperate with, but don’t mandate full ACID - within that model, they would be considered as relaxing the isolation property.
You can read a bit more in this <a href="http://jbossts.blogspot.cz/2017/06/sagas-and-how-they-differ-from-two.html">blogpost</a>.</p>
</div>
<div class="paragraph">
<p>Compensating transaction fall within backward recovery.
The compensation transaction is defined as a work of unit that consists from one or more actions.
Each action processes some work and up to that provides compensation handler with the definition of the undo-like operation.
When a failure occurs the transaction manager invokes the compensating handlers (the undo operation) to allow the application to reconcile work processed by the proper action.</p>
</div>
<div class="paragraph">
<p>With regards to Narayana, and when considering its impact on the <a href="http://www.julianbrowne.com/article/viewer/brewers-cap-theorem">CAP theorem</a> which dictates us that because of network can’t be considered reliable we need to choose between one of availability or consistency, our compensations approach relaxes some degree of availability.</p>
</div>
<div class="paragraph">
<p>Compensating transactions are currently implemented in Narayana in way of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Compensation framework (more below)</p>
</li>
<li>
<p>WS-BA transactions in XTS module</p>
</li>
<li>
<p>REST-JDI in plans <a href="https://issues.jboss.org/browse/JBTM-1488">JBTM-1488</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_compensations_framework"><a class="anchor" href="#_compensations_framework"></a>9.2. Compensations Framework</h3>
<div class="paragraph">
<p>Narayana contains a compensations framework to assist users with developing transactional applications which require the use of compensating transactions.
The compensating transaction behaviour can be expressed using either CDI annotations or via a programmatic API.</p>
</div>
<div class="sect3">
<h4 id="_cdi_annotations"><a class="anchor" href="#_cdi_annotations"></a>9.2.1. CDI annotations</h4>
<div class="paragraph">
<p>Application developer annotates methods with the CDI annotations to define actions and undo operations which are managed by Transaction Manager.
Narayana handles the state of the compensating transaction and drives undo operation if necessary.
The manner how the annotations are used is pretty similar to standard CDI transaction annotations (e.g. in Jakarta EE).</p>
</div>
<div class="paragraph">
<p>For the better understanding we recommend to check the <a href="https://github.com/jbosstm/quickstart/tree/master/compensating-transactions/mongodb-simple">compensating transactions quickstart</a>.</p>
</div>
<div class="paragraph">
<p>The “entry point” is marking a method with <code>@Compensatable</code> annotation.
This defines demarcation for the compensating transaction to start a new one, to join to an existing one or to throw exception if a compensating transaction context does not yet exist - the behaviour is the same as you can know from with the Jakarta EE <a href="https://javadoc.io/static/jakarta.platform/jakarta.jakartaee-api/10.0.0/jakarta/ejb/TransactionAttribute.html"><code>@TransactionAttribute</code></a>.
On top of that the <code>@Compensatable</code> annotation permits you to define which exception type made the transaction to be cancelled or not cancelled.</p>
</div>
<div class="paragraph">
<p>When the compensating transaction context exists there you can call methods marked with <code>@TxCompensate</code> and <code>@TxConfirm</code> annotations.
Both expected to be parameterized with a handler class.
That’s a class implementing either <code>org.jboss.narayana.compensations.api.CompensationHandler</code> (with definition of one method called <code>compensate</code>) or <code>org.jboss.narayana.compensations.api.ConfirmationHandler</code> (with definition of one method called <code>confirm</code>).
Handlers intercepts the execution when the transaction reaches a specific state - the <code>compensate</code> method is called when it fails or is cancelled, the <code>confirm</code> method is called when it ends successfully.</p>
</div>
<div class="paragraph">
<p>The CDI bean marking a method with <code>@TxCompensate</code>/<code>@TxConfirm</code> and the handlers can inject (<a href="https://jakarta.ee/specifications/cdi/3.0/jakarta-cdi-spec-3.0.html#built_in_annotation_literals">@Inject</a>) a POJO object (a DTO) marked as <code>@CompensationScoped</code>.
This annotation defines the data being set to this object in the bean in the scope of the specific compensating transaction will be available in the handlers (<code>@TxCompensate</code>/<code>@TxConfirm</code>) intercepting the compensating transaction.
It’s important the <code>@CompensationScoped</code> POJOs being implemented as <a href="https://docs.oracle.com/javase/7/docs/api/java/io/Serializable.html"><code>Serializable</code></a> as they are saved during transaction processing to the transaction log store.
Let’s imagine a situation where some part of the compensating transaction work is processed and JVM, where Narayana transaction manager resides, is crashed.
After the restart Narayana needs to understand the state before the crash.
That information is persisted in the transaction log store.
Narayana loads the POJO state and passes it to handlers - to get proceed with confirmation or compensation.</p>
</div>
<div class="sect4">
<h5 id="_list_of_available_cdi_annotations"><a class="anchor" href="#_list_of_available_cdi_annotations"></a>List of available CDI annotations</h5>
<div class="ulist">
<ul>
<li>
<p><code>@Compensatable</code> - declaratively control compensation transaction boundaries on CDI managed beans.
This is similar to what is known from Jakarta EE world, how <a href="https://javadoc.io/static/jakarta.platform/jakarta.jakartaee-api/10.0.0/jakarta/ejb/TransactionAttribute.html">@TransactionAttribute</a> drives the global transaction behaviour.
Compensatable framework uses CDI (you can define how interacts with other compensating transaction in the scope - you can use the type as known from Jakarta EE, which means <code>MANDATORY</code>, <code>SUPPORTS</code>, <code>REQUIRED</code> etc.)</p>
</li>
<li>
<p><code>@TxConfirm</code> - callback handler for confirming any work done within this annotated method, implementing <code>org.jboss.narayana.compensations.api.ConfirmationHandler</code>.</p>
</li>
<li>
<p><code>@TxCompensate</code> - callback handler for compensating work which was done, implementing <code>org.jboss.narayana.compensations.api.CompensationHandler</code>.</p>
</li>
<li>
<p><code>@CompensationScoped</code> - CDI bean is to be scoped to the current active compensation-based transaction.</p>
</li>
<li>
<p><code>@CancelOnFailure</code> - states that the compensation-based transaction must cancel, if a <code>RuntimeException</code> is thrown.
A similar effect could be achieved by setting parameter <code>cancelOn</code> of <code>@Compensatable</code> set with <code>RuntimeException</code>.
There is no timeout associated with compensatable units of work which implies that they must either run to completion or fail.</p>
</li>
<li>
<p><code>org.jboss.narayana.compensations.api.CompensationManager</code> - compensation manager could be <a href="https://jakarta.ee/specifications/cdi/3.0/jakarta-cdi-spec-3.0.html#built_in_annotation_literals">@Injected</a> for being able to mark the context as <code>setCompensateOnly</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_programmatic_api"><a class="anchor" href="#_programmatic_api"></a>Programmatic API</h5>
<div class="paragraph">
<p>The compensation framework provides a declarative API to add compensatable work and let it processed by framework.
The application programmer injects the interface <code>org.jboss.narayana.compensations.api.CompensatableAction</code> (<code>@Inject CompensatableAction</code>).
This interface contains methods to add work to the action (<code>addWork</code>) and then execute the action <code>execute</code>).</p>
</div>
<div class="paragraph">
<p>Programmer then adds work items to the <code>CompensatableAction</code> one by one.
The <code>addWork</code> methods offers ability to specify work item, which is instance of <code>CompensatableWork</code> that declares only that the work has to define method to execute the work, and assign to the work item its <code>CompensationHandler</code> and/or <code>ConfirmationHandler</code>.</p>
</div>
<div class="paragraph">
<p>The programmer then declares the instant when <code>CompensatableAction</code> should be executed by calling the method executes.
Execution means that work items will be executed one by one.
All work items then belong under the same compensation and in the case of failure of one item others will be compensated (of a compensation handler was declared).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_recovery_2"><a class="anchor" href="#_recovery_2"></a>9.2.2. Recovery</h4>
<div class="paragraph">
<p>Implementation of recovery for compensating transaction is not yet part of the Narayana codebase, see <a href="https://issues.jboss.org/browse/JBTM-1107">JBTM-1107</a> however the implementation is under the review.</p>
</div>
<div class="paragraph">
<p>The recovery works in the following way.
The state of participant is saved to Narayana object store (<code>org.jboss.narayana.compensations.internal.ParticipantImpl</code>).
The content of the store regarding of the participant of the compensating transaction is <code>transactionId</code>, <code>participantId</code>, <code>compensationHandler</code> and <code>confirmationHandler</code>.
For handler could be persisted it needs to implement <code>java.io.Serializable</code> interface.</p>
</div>
<div class="paragraph">
<p>When crash of the Narayana occurs these data is restored and used during standard periodic recovery process.
For restoring handlers user has to register an implementation of interface <code>org.jboss.narayana.compensations.api.Deserializer</code>.
The implementation is then used for getting implementation of the handler class which could be later used during recovery.</p>
</div>
<div class="paragraph">
<p>For tracking state is used standard Narayana object store and its handling of <code>com.arjuna.ats.arjuna.StateManager</code> methods <code>save_state</code>.
Narayana manages serializing and deserializing but programmer has to implement and registered the <code>Deserializer</code> interface to get handlers restored from the object store.</p>
</div>
<div class="paragraph">
<p>You can find more valuable information in the wiki article <a href="https://developer.jboss.org/wiki/XTSRecoveryInternals">XTS Recovery Internals</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_limitation"><a class="anchor" href="#_limitation"></a>9.2.3. Limitation</h4>
<div class="paragraph">
<p>Currently, there is one limitation which is needed to be emphasized.
If you are used to work with XTS AT transactions you probably take advantage of transaction bridge functionality - ability of smoothly join XTS transaction with app server container transaction under one transparent global transaction.
This is not possible for compensating transaction.
The lack of the bridge functionality for the compensating transactions is addressed under jira <a href="https://issues.jboss.org/browse/JBTM-1099">JBTM-1099</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resources"><a class="anchor" href="#_resources"></a>9.3. Resources</h3>
<div class="paragraph">
<p>This is our blog series which is valuable to check out</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://jbossts.blogspot.com/2013/05/compensating-transactions-when-acid-is.html">Compensating Transactions: When ACID is too much (Part 1: Introduction)</a></p>
</li>
<li>
<p><a href="http://jbossts.blogspot.com/2013/05/compensating-transactions-when-acid-is_29.html">Compensating Transactions: When ACID is too much (Part 2: Non-Transactional Resources)</a></p>
</li>
<li>
<p><a href="http://jbossts.blogspot.com/2013/06/compensating-transactions-when-acid-is_26.html">Compensating Transactions: When ACID is too much (Part 3: Cross-Domain Distributed Transactions)</a></p>
</li>
<li>
<p><a href="http://jbossts.blogspot.com/2013/07/compensating-transactions-when-acid-is.html">Compensating Transactions: When ACID is too much (Part 4: Long Lived Transactions)</a></p>
</li>
<li>
<p><a href="http://jbossts.blogspot.com/2014/05/bringing-transactional-guarantees-to.html">Bringing Transactional Guarantees to MongoDB: Part 1</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_notes"><a class="anchor" href="#_notes"></a>9.4. Notes</h3>
<div class="ulist">
<ul>
<li>
<p>Compensations framework directly depends on Weld as a result of <a href="https://issues.jboss.org/browse/JBTM-2704">JBTM-2704</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_osgi"><a class="anchor" href="#_osgi"></a>10. OSGi</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="chap_integrate_with_karaf"><a class="anchor" href="#chap_integrate_with_karaf"></a>10.1. Integrate with Karaf</h3>
<div class="sect3">
<h4 id="_introduction_11"><a class="anchor" href="#_introduction_11"></a>10.1.1. Introduction</h4>
<div class="paragraph">
<p>The Narayana has been introduced in the Karaf 4.1.0-SNAPSHOT.
You need to build from <a href="https://github.com/apache/karaf">https://github.com/apache/karaf</a>.</p>
</div>
<div class="paragraph">
<p>The narayana configuration file could be found in <code>&lt;karaf-4.1.0-SNAPSHOT&gt;/etc/org.jboss.nararayana.cfg</code></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Configuration</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ObjectStoreEnvironmentBean.objectStoreDir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$\{karaf.data}/narayana</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ObjectStoreEnvironmentBean.communicationStore.objectStoreDir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$\{karaf.data}/narayana</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HornetqJournalEnvironmentBean.storeDir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$\{karaf.data}/narayana/hornetq</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You could use the more keys in the <code>jbossts-properties.xml</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_quickstart"><a class="anchor" href="#_quickstart"></a>10.1.2. Quickstart</h4>
<div class="paragraph">
<p>You could build and run the <a href="https://github.com/jbosstm/quickstart/tree/master/karaf/osgi-jta"> Karaf osgi-jta Quicksart</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_admin_commands_support"><a class="anchor" href="#_admin_commands_support"></a>10.1.3. Admin Commands Support</h4>
<div class="paragraph">
<p>We support the following commands in the karaf console</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Admin Command Cli</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Command</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">narayana:refresh</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Refresh the view of the object store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">narayana:types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List record types</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">narayana:select type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Select a particular transaction type</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">narayana:ls [type]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List the transactions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">narayana:attach id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Attach to a transaction log</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">narayana:detach id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Detach to the transaction log</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">narayana:forget idx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Move the specified heuristic participant back to the prepared list</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">narayana:delete idx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete the specified heuristic participant</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendixes"><a class="anchor" href="#_appendixes"></a>11. Appendixes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_object_store_implementations"><a class="anchor" href="#_object_store_implementations"></a>Appendix A: Object store implementations</h3>
<div class="sect3">
<h4 id="_the_objectstore"><a class="anchor" href="#_the_objectstore"></a>The ObjectStore</h4>
<div class="paragraph">
<p>This appendix examines the various ArjunaCore object store implementations and gives guidelines for creating other implementations and plugging into an application.</p>
</div>
<div class="paragraph">
<p>This release of Narayana contains several different implementations of a basic object store.
Each serves a particular purpose and is generally optimized for that purpose.
Each of the implementations implements the <code>ObjectStoreAPI</code> interface, which defines the minimum operations which must be provided for an object store implementation to be used by the Transaction Service.
You can override the default object store implementation at runtime by setting the <code>com.arjuna.ats.arjuna.objectstore.objectStoreType</code> property variable to one of the types described below.</p>
</div>
<div class="listingblock">
<div class="title">Class <code>StateStatus</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/*
 * This is the base class from which all object store types are derived.
 * Note that because object store instances are stateless, to improve
 * efficiency we try to only create one instance of each type per process.
 * Therefore, the create and destroy methods are used instead of new
 * and delete. If an object store is accessed via create it *must* be
 * deleted using destroy. Of course it is still possible to make use of
 * new and delete directly and to create instances on the stack.
 */</span>

<span class="directive">public</span> <span class="type">class</span> <span class="class">StateStatus</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_ORIGINAL;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_SHADOW;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_UNCOMMITTED;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_UNCOMMITTED_HIDDEN;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_UNKNOWN;
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">StateType</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_COMMITTED;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_COMMITTED_HIDDEN;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_HIDDEN;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> OS_INVISIBLE;
}

<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">ObjectStore</span> <span class="directive">implements</span> BaseStore, ParticipantStore, RecoveryStore, TxLog {
    <span class="directive">public</span> ObjectStore(<span class="predefined-type">String</span> osRoot);

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> printState(<span class="predefined-type">PrintStream</span> strm, <span class="type">int</span> res);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> allObjUids(<span class="predefined-type">String</span> s, InputObjectState buff) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> allObjUids(<span class="predefined-type">String</span> s, InputObjectState buff, <span class="type">int</span> m) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> allTypes(InputObjectState buff) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">int</span> currentState(Uid u, <span class="predefined-type">String</span> tn) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> commit_state(Uid u, <span class="predefined-type">String</span> tn) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> hide_state(Uid u, <span class="predefined-type">String</span> tn) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> reveal_state(Uid u, <span class="predefined-type">String</span> tn) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">synchronized</span> InputObjectState read_committed(Uid u, <span class="predefined-type">String</span> tn) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">synchronized</span> InputObjectState read_uncommitted(Uid u, <span class="predefined-type">String</span> tn) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> remove_committed(Uid u, <span class="predefined-type">String</span> tn) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> remove_uncommitted(Uid u, <span class="predefined-type">String</span> tn) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> write_committed(Uid u, <span class="predefined-type">String</span> tn, OutputObjectState buff) <span class="directive">throws</span> ObjectStoreException;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> write_uncommitted(Uid u, <span class="predefined-type">String</span> tn, OutputObjectState buff) <span class="directive">throws</span> ObjectStoreException;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Narayana programmers do not usually need to interact with any of the object store implementations directly, apart from possibly creating them in the first place.
Even this is not necessary if the default store type is used, since Narayana creates stores as necessary.
All stores manipulate instances of the class <code>ObjectState</code>.
These instances are named using a <code>type</code> (via the object&#8217;s <code>type()</code> operation) and a <em class="path">Uid</em> .</p>
</div>
<div class="paragraph">
<p>For atomic actions purposes, object states in the store can be principally in two distinct states: <code>OS_COMMITTED</code> or <code>OS_UNCOMMITTED</code>.
An object state starts in the <code>OS_COMMITTED</code> state, but when it is modified under the control of an atomic action, a new second object state may be written that is in the <code>OS_UNCOMMITTED</code> state.
If the action commits, this second object state replaces the original and becomes <code>OS_COMMITTED</code>.
If the action aborts, this second object state is discarded.
All of the implementations provided with this release handle these state transitions by making use of shadow copies of object states.
However, any other implementation that maintains this abstraction is permissible.</p>
</div>
<div class="paragraph">
<p>Object states may become hidden, and thus inaccessible, under the control of the crash recovery system.</p>
</div>
<div class="paragraph">
<p>You can browse the contents of a store through the <code>allTypes</code> and <code>allObjUids</code> operations. <code>allTypes</code> returns an <code>InputObjectState</code> containing all of the type names of all objects in a store, terminated by a <code>null</code> name.
<code>allObjUids</code> returns an <code>InputObjectState</code> containing all of the <code>Uids</code> of all objects of a given type, terminated by the special <code>Uid.nullUid()</code>.</p>
</div>
<div class="sect4">
<h5 id="_persistent_object_stores"><a class="anchor" href="#_persistent_object_stores"></a>Persistent object stores</h5>
<div class="paragraph">
<p>This section briefly describes the characteristics and optimizations of each of the supplied implementations of the persistent object store.
Persistent object states are mapped onto the structure of the file system supported by the host operating system.</p>
</div>
<div class="sect5">
<h6 id="_common_functionality"><a class="anchor" href="#_common_functionality"></a>Common functionality</h6>
<div class="paragraph">
<p>In addition to the features mentioned earlier, all of the supplied persistent object stores obey the following rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each object state is stored in its own file, which is named using the Uid of the object.</p>
</li>
<li>
<p>The type of an object, as given by the <code>type()</code> operation, determines the directory into which the object is placed.</p>
</li>
<li>
<p>All of the stores have a common root directory that is determined when Narayana is configured.
This directory name is automatically prepended to any store-specific root information.</p>
</li>
<li>
<p>All stores also have the notion of a localized root directory that is automatically prepended to the type of the object to determine the ultimate directory name.
The localized root name is specified when the store is created.
The default name is <code>defaultStore</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">&lt;ObjectStore root Directory from configure&gt;     &lt;filename&gt;/JBossTS/ObjectStore/&lt;/filename&gt;
   &lt;ObjectStore Type1&gt;                          &lt;filename&gt;FragmentedStore/&lt;/filename&gt;
      &lt;Default root&gt;                            &lt;filename&gt;defaultStore/&lt;/filename&gt;
         &lt;StateManager&gt;                         &lt;filename&gt;StateManager&lt;/filename&gt;
            &lt;LockManager&gt;                       &lt;filename&gt;LockManager/&lt;/filename&gt;
               &lt;User Types&gt;
      &lt;Localised root 2&gt;                        &lt;filename&gt;myStore/&lt;/filename&gt;
         &lt;StateManager&gt;                         &lt;filename&gt;StateManager/&lt;/filename&gt;

   &lt;ObjectStore Type2&gt;                          &lt;filename&gt;ActionStore/&lt;/filename&gt;
         &lt;Default root&gt;                         &lt;filename&gt;defaultStore/&lt;/filename&gt;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_the_shadowing_store"><a class="anchor" href="#_the_shadowing_store"></a>The shadowing store</h6>
<div class="paragraph">
<p>The shadowing store is the original version of the object store, which was provided in prior releases.
It is implemented by the class <code>ShadowingStore</code>.
It is simple but slow.
It uses pairs of files to represent objects.
One file is the shadow version and the other is the committed version.
Files are opened, locked, operated upon, unlocked, and closed on every interaction with the object store.
This causes a lot of I/O overhead.</p>
</div>
<div class="paragraph">
<p>If you are overriding the object store implementation, the type of this object store is <code>ShadowingStore</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_no_file_level_locking"><a class="anchor" href="#_no_file_level_locking"></a>No file-level locking</h6>
<div class="paragraph">
<p>Since transactional objects are concurrency-controlled through <code>LockManager</code>, you do not need to impose additional locking at the file level.
The basic ShadowingStore implementation handles file-level locking.
Therefore, the default object store implementation for Narayana, <em class="path">ShadowNoFileLockStore</em>, relies upon user-level locking.
This enables it to provide better performance than the <em class="path">ShadowingStore</em> implementation.</p>
</div>
<div class="paragraph">
<p>If you are overriding the object store implementation, the type of this object store is <code>ShadowNoFileLockStore</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_the_hashed_store"><a class="anchor" href="#_the_hashed_store"></a>The hashed store</h6>
<div class="paragraph">
<p>The HashedStore has the same structure for object states as the ShadowingStore, but has an alternate directory structure that is better suited to storing large numbers of objects of the same type.
Using this store, objects are scattered among a set of directories by applying a hashing function to the object&#8217;s Uid.
By default, 255 sub-directories are used.
However, you can override this by setting the <code>ObjectStoreEnvironmentBean.hashedDirectories</code> environment variable accordingly.</p>
</div>
<div class="paragraph">
<p>If you are overriding the object store implementation, the type of this object store is <code>HashedStore</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_the_jdbc_store"><a class="anchor" href="#_the_jdbc_store"></a>The JDBC store</h6>
<div class="paragraph">
<p>The JDBCStore uses a JDBC database to save persistent object states.
When used in conjunction with the Transactional Objects for Java API, nested transaction support is available.
In the current implementation, all object states are stored as <em class="term">Binary Large Objects (BLOBs)</em> within the same table.
The limitation on object state size imposed by using BLOBs is <code>64k</code>.
If you try to store an object state which exceeds this limit, an error is generated and the state is not stored.
The transaction is subsequently forced to roll back.</p>
</div>
<div class="paragraph">
<p>When using the JDBC object store, the application must provide an implementation of the <code>JDBCAccess</code> interface, located in the <code>com.arjuna.ats.arjuna.objectstore</code> package:</p>
</div>
<div class="listingblock">
<div class="title">Interface <code>JDBCAccess</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">JDBCAccess</span> {
    <span class="directive">public</span> <span class="predefined-type">Connection</span> getConnection() <span class="directive">throws</span> <span class="exception">SQLException</span>;

    <span class="directive">public</span> <span class="type">void</span> putConnection(<span class="predefined-type">Connection</span> conn) <span class="directive">throws</span> <span class="exception">SQLException</span>;

    <span class="directive">public</span> <span class="type">void</span> initialise(<span class="predefined-type">Object</span><span class="type">[]</span> objName);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation of this class is responsible for providing the <code>Connection</code> which the JDBC ObjectStore uses to save and restore object states:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>getConnection</code></dt>
<dd>
<p>Returns the Connection to use.
This method is called whenever a connection is required, and the implementation should use whatever policy is necessary for determining what connection to return.
This method need not return the same <code>Connection</code> instance more than once.</p>
</dd>
<dt class="hdlist1">putConnection</dt>
<dd>
<p>Returns one of the <code>Connections</code> acquired from <code>getConnection</code>.
Connections are returned if any errors occur when using them.</p>
</dd>
<dt class="hdlist1">initialise</dt>
<dd>
<p>Used to pass additional arbitrary information to the implementation.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The JDBC object store initially requests the number of <code>Connections</code> defined in the <code>ObjectStoreEnvironmentBean.jdbcPoolSizeInitial</code> property and will use no more than defined in the <code>ObjectStoreEnvironmentBean.jdbcPoolSizeMaximum</code> property.</p>
</div>
<div class="paragraph">
<p>The implementation of the <code>JDBCAccess</code> interface to use should be set in the <code>ObjectStoreEnvironmentBean.jdbcUserDbAccessClassName</code> property variable.</p>
</div>
<div class="paragraph">
<p>If overriding the object store implementation, the type of this object store is <code>JDBCStore</code>.</p>
</div>
<div class="paragraph">
<p>A JDBC object store can be used for managing the transaction log.
In this case, the transaction log implementation should be set to <code>JDBCActionStore</code> and the <code>JDBCAccess</code> implementation must be provided via the <code>ObjectStoreEnvironmentBean.jdbcTxDbAccessClassName</code> property variable.
In this case, the default table name is <em class="path">JBossTSTxTable</em> .</p>
</div>
<div class="paragraph">
<p>You can use the same <code>JDBCAccess</code> implementation for both the user object store and the transaction log.</p>
</div>
</div>
<div class="sect5">
<h6 id="_the_cached_store"><a class="anchor" href="#_the_cached_store"></a>The cached store</h6>
<div class="paragraph">
<p>This object store uses the hashed object store, but does not read or write states to the persistent backing store immediately.
It maintains the states in a volatile memory cache and either flushes the cache periodically or when it is full.
The failure semantics associated with this object store are different from the normal persistent object stores, because a failure could result in states in the cache being lost.</p>
</div>
<div class="paragraph">
<p>If overriding the object store implementation, the type of this object store is <code>CacheStore</code>.</p>
</div>
<div class="dlist">
<div class="title">Configuration Properties</div>
<dl>
<dt class="hdlist1">ObjectStoreEnvironmentBean.cacheStoreHash</dt>
<dd>
<p>sets the number of internal stores to hash the states over.
The default value is 128.</p>
</dd>
<dt class="hdlist1">ObjectStoreEnvironmentBean.cacheStoreSize</dt>
<dd>
<p>the maximum size the cache can reach before a flush is triggered.
The default is 10240 bytes.</p>
</dd>
<dt class="hdlist1">ObjectStoreEnvironmentBean.cacheStoreRemovedItems</dt>
<dd>
<p>the maximum number of removed items that the cache can contain before a flush is triggered.
By default, calls to remove a state that is in the cache will simply remove the state from the cache, but leave a blank entry (rather than remove the entry immediately, which would affect the performance of the cache).
When triggered, these entries are removed from the cache.
The default value is twice the size of the hash.</p>
</dd>
<dt class="hdlist1">ObjectStoreEnvironmentBean.cacheStoreWorkItems</dt>
<dd>
<p>the maximum number of items that are allowed to build up in the cache before it is flushed.
The default value is 100.
<code>ObjectStoreEnvironmentBean.cacheStoreScanPeriod</code> sets the time in milliseconds for periodically flushing the cache.
The default is 120 seconds.</p>
</dd>
<dt class="hdlist1">ObjectStoreEnvironmentBean.cacheStoreSync</dt>
<dd>
<p>determines whether flushes of the cache are sync-ed to disk.
The default is <code>OFF</code>.
To enable, set to <code>ON</code>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect5">
<h6 id="_logstore"><a class="anchor" href="#_logstore"></a>LogStore</h6>
<div class="paragraph">
<p>This implementation is based on a traditional transaction log.
All transaction states within the same process (VM instance) are written to the same log (file), which is an append-only entity.
When transaction data would normally be deleted, at the end of the transaction, a <em class="path">delete</em> record is added to the log instead.
Therefore, the log just keeps growing.
Periodically a thread runs to prune the log of entries that have been deleted.</p>
</div>
<div class="paragraph">
<p>A log is initially given a maximum capacity beyond which it cannot grow.
After it reaches this size, the system creates a new log for transactions that could not be accommodated in the original log.
The new log and the old log are pruned as usual.
During the normal execution of the transaction system, there may be an arbitrary number of log instances.
These should be garbage collected by the system,(or the recovery sub-system, eventually.</p>
</div>
<div class="paragraph">
<p>Check the Configuration Options table for how to configure the LogStore.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_core_class_definitions"><a class="anchor" href="#_core_class_definitions"></a>Appendix B: Core Class Definitions</h3>
<div class="paragraph">
<p>This appendix contains an overview of those classes that the application programmer will typically use.
The aim of this appendix is to provide a quick reference guide to these classes for use when writing applications in ArjunaCore.
For clarity only the public and protected interfaces of the classes will be given.</p>
</div>
<div class="listingblock">
<div class="title">Class <code class="class">LockManager</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">LockResult</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> GRANTED;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> REFUSED;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> RELEASED;
};

<span class="directive">public</span> <span class="type">class</span> <span class="class">ConflictType</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> CONFLICT;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> COMPATIBLE;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> PRESENT;
};

<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">LockManager</span> <span class="directive">extends</span> StateManager {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> defaultRetry;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> defaultTimeout;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> waitTotalTimeout;

    <span class="directive">protected</span> LockManager();

    <span class="directive">protected</span> LockManager(<span class="type">int</span> ot);

    <span class="directive">protected</span> LockManager(<span class="type">int</span> ot, <span class="type">int</span> objectModel);

    <span class="directive">protected</span> LockManager(Uid storeUid);

    <span class="directive">protected</span> LockManager(Uid storeUid, <span class="type">int</span> ot);

    <span class="directive">protected</span> LockManager(Uid storeUid, <span class="type">int</span> ot, <span class="type">int</span> objectModel);

    <span class="directive">public</span> <span class="directive">final</span> <span class="directive">synchronized</span> <span class="type">boolean</span> releaselock(Uid lockUid);

    <span class="directive">public</span> <span class="directive">final</span> <span class="directive">synchronized</span> <span class="type">int</span> setlock(<span class="predefined-type">Lock</span> toSet);

    <span class="directive">public</span> <span class="directive">final</span> <span class="directive">synchronized</span> <span class="type">int</span> setlock(<span class="predefined-type">Lock</span> toSet, <span class="type">int</span> retry);

    <span class="directive">public</span> <span class="directive">final</span> <span class="directive">synchronized</span> <span class="type">int</span> setlock(<span class="predefined-type">Lock</span> toSet, <span class="type">int</span> retry, <span class="type">int</span> sleepTime);

    <span class="directive">public</span> <span class="type">void</span> print(<span class="predefined-type">PrintStream</span> strm);

    <span class="directive">public</span> <span class="predefined-type">String</span> type();

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ObjectType);

    <span class="directive">protected</span> <span class="type">void</span> terminate();
};</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Class <code class="class">StateManager</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ObjectStatus</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> PASSIVE;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> PASSIVE_NEW;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> ACTIVE;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> ACTIVE_NEW;
};

<span class="directive">public</span> <span class="type">class</span> <span class="class">ObjectType</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> RECOVERABLE;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> ANDPERSISTENT;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> NEITHER;
};

<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">StateManager</span> {
    <span class="directive">protected</span> StateManager();

    <span class="directive">protected</span> StateManager(<span class="type">int</span> ot);

    <span class="directive">protected</span> StateManager(<span class="type">int</span> ot, <span class="type">int</span> objectModel);

    <span class="directive">protected</span> StateManager(Uid objUid);

    <span class="directive">protected</span> StateManager(Uid objUid, <span class="type">int</span> ot);

    <span class="directive">protected</span> StateManager(Uid objUid, <span class="type">int</span> ot, <span class="type">int</span> objectModel);

    <span class="directive">public</span> <span class="type">boolean</span> restore_state(InputObjectState os, <span class="type">int</span> ot);

    <span class="directive">public</span> <span class="type">boolean</span> save_state(OutputObjectState os, <span class="type">int</span> ot);

    <span class="directive">public</span> <span class="predefined-type">String</span> type();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> activate();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> activate(<span class="predefined-type">String</span> rootName);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> deactivate();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> deactivate(<span class="predefined-type">String</span> rootName);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> deactivate(<span class="predefined-type">String</span> rootName, <span class="type">boolean</span> commit);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">int</span> status();

    <span class="directive">public</span> <span class="directive">final</span> Uid get_uid();

    <span class="directive">public</span> <span class="type">void</span> destroy();

    <span class="directive">public</span> <span class="type">void</span> print(<span class="predefined-type">PrintStream</span> strm);

    <span class="directive">protected</span> <span class="type">void</span> terminate();

    <span class="directive">protected</span> <span class="directive">synchronized</span> <span class="directive">final</span> <span class="type">void</span> modified();
};</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Classes <code class="class">OutputObjectState</code>and <code class="class">InputObjectState</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">OutputObjectState</span> <span class="directive">extends</span> OutputBuffer {
    <span class="directive">public</span> OutputObjectState(Uid newUid, <span class="predefined-type">String</span> typeName);

    <span class="directive">public</span> <span class="type">boolean</span> notempty();

    <span class="directive">public</span> <span class="type">int</span> size();

    <span class="directive">public</span> Uid stateUid();

    <span class="directive">public</span> <span class="predefined-type">String</span> type();
};

<span class="type">class</span> <span class="class">InputObjectState</span> <span class="directive">extends</span> ObjectState {
    <span class="directive">public</span> OutputObjectState(Uid newUid, <span class="predefined-type">String</span> typeName, <span class="type">byte</span><span class="type">[]</span> b);

    <span class="directive">public</span> <span class="type">boolean</span> notempty();

    <span class="directive">public</span> <span class="type">int</span> size();

    <span class="directive">public</span> Uid stateUid();

    <span class="directive">public</span> <span class="predefined-type">String</span> type();
};</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Classes <code class="class">OutputBuffer</code>and <code class="class">InputBuffer</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">OutputBuffer</span> {
    <span class="directive">public</span> OutputBuffer();

    <span class="directive">public</span> <span class="directive">final</span> <span class="directive">synchronized</span> <span class="type">boolean</span> valid();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">byte</span><span class="type">[]</span> buffer();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">int</span> length();

    <span class="comment">/* pack operations for standard Java types */</span>

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packByte(<span class="type">byte</span> b) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packBytes(<span class="type">byte</span><span class="type">[]</span> b) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packBoolean(<span class="type">boolean</span> b) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packChar(<span class="type">char</span> c) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packShort(<span class="type">short</span> s) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packInt(<span class="type">int</span> i) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packLong(<span class="type">long</span> l) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packFloat(<span class="type">float</span> f) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packDouble(<span class="type">double</span> d) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> packString(<span class="predefined-type">String</span> s) <span class="directive">throws</span> <span class="exception">IOException</span>;
};

<span class="directive">public</span> <span class="type">class</span> <span class="class">InputBuffer</span> {
    <span class="directive">public</span> InputBuffer();

    <span class="directive">public</span> <span class="directive">final</span> <span class="directive">synchronized</span> <span class="type">boolean</span> valid();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">byte</span><span class="type">[]</span> buffer();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">int</span> length();

    <span class="comment">/* unpack operations for standard Java types */</span>

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">byte</span> unpackByte() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">byte</span><span class="type">[]</span> unpackBytes() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">boolean</span> unpackBoolean() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">char</span> unpackChar() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">short</span> unpackShort() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">int</span> unpackInt() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">long</span> unpackLong() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">float</span> unpackFloat() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">double</span> unpackDouble() <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="predefined-type">String</span> unpackString() <span class="directive">throws</span> <span class="exception">IOException</span>;
};</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Class <code class="class">Uid</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Uid</span> <span class="directive">implements</span> <span class="predefined-type">Cloneable</span> {
    <span class="directive">public</span> Uid();

    <span class="directive">public</span> Uid(Uid copyFrom);

    <span class="directive">public</span> Uid(<span class="predefined-type">String</span> uidString);

    <span class="directive">public</span> Uid(<span class="predefined-type">String</span> uidString, <span class="type">boolean</span> errorsOk);

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">synchronized</span> Uid nullUid();

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> pack(OutputBuffer packInto) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> unpack(InputBuffer unpackFrom) <span class="directive">throws</span> <span class="exception">IOException</span>;

    <span class="directive">public</span> <span class="type">void</span> print(<span class="predefined-type">PrintStream</span> strm);

    <span class="directive">public</span> <span class="predefined-type">String</span> toString();

    <span class="directive">public</span> <span class="predefined-type">Object</span> clone() <span class="directive">throws</span> <span class="exception">CloneNotSupportedException</span>;

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> copy(Uid toCopy) <span class="directive">throws</span> UidException;

    <span class="directive">public</span> <span class="type">boolean</span> equals(Uid u);

    <span class="directive">public</span> <span class="type">boolean</span> notEquals(Uid u);

    <span class="directive">public</span> <span class="type">boolean</span> lessThan(Uid u);

    <span class="directive">public</span> <span class="type">boolean</span> greaterThan(Uid u);

    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="directive">final</span> <span class="type">boolean</span> valid();
};</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Class <code class="class">AtomicAction</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AtomicAction</span> {
    <span class="directive">public</span> AtomicAction();

    <span class="directive">public</span> <span class="type">void</span> begin() <span class="directive">throws</span> SystemException, SubtransactionsUnavailable,
            NoTransaction;

    <span class="directive">public</span> <span class="type">void</span> commit(<span class="type">boolean</span> report_heuristics) <span class="directive">throws</span> SystemException,
            NoTransaction, HeuristicMixed,
            HeuristicHazard, TransactionRolledBack;

    <span class="directive">public</span> <span class="type">void</span> rollback() <span class="directive">throws</span> SystemException, NoTransaction;

    <span class="directive">public</span> <span class="predefined-type">Control</span> control() <span class="directive">throws</span> SystemException, NoTransaction;

    <span class="directive">public</span> Status get_status() <span class="directive">throws</span> SystemException;

    <span class="comment">/* Allow action commit to be supressed */</span>
    <span class="directive">public</span> <span class="type">void</span> rollbackOnly() <span class="directive">throws</span> SystemException, NoTransaction;

    <span class="directive">public</span> <span class="type">void</span> registerResource(Resource r) <span class="directive">throws</span> SystemException, Inactive;

    <span class="directive">public</span> <span class="type">void</span> registerSubtransactionAwareResource(SubtransactionAwareResource sr)
            <span class="directive">throws</span> SystemException, NotSubtransaction;

    <span class="directive">public</span> <span class="type">void</span> registerSynchronization(Synchronization s) <span class="directive">throws</span> SystemException,
            Inactive;
};</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_idl_definitions"><a class="anchor" href="#_idl_definitions"></a>Appendix C: IDL definitions</h3>
<div class="paragraph">
<p>Because of differences between ORBs, and errors in certain ORBs, the idl available with Narayana may differ from that shown below.
You should always inspect the idl files prior to implementation to determine what, if any, differences exist.</p>
</div>
<div class="listingblock">
<div class="title">CosTransactions.idl</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C"><span class="preprocessor">#ifndef</span> COSTRANSACTIONS_IDL_
<span class="preprocessor">#define</span> COSTRANSACTIONS_IDL_
module CosTransactions {
    <span class="keyword">enum</span> Status {
        StatusActive, StatusMarkedRollback, StatusPrepared,
        StatusCommitted, StatusRolledback, StatusUnknown,
        StatusPreparing, StatusCommitting, StatusRollingBack,
        StatusNoTransaction
    };

    <span class="keyword">enum</span> Vote { VoteCommit, VoteRollback, VoteReadOnly };
    <span class="comment">// Standard exceptions - some Orb supports them</span>
    exception TransactionRequired {};
    exception TransactionRolledBack {};
    exception InvalidTransaction {};
    <span class="comment">// Heuristic exceptions</span>
    exception HeuristicRollback {};
    exception HeuristicCommit {};
    exception HeuristicMixed {};
    exception HeuristicHazard {};
    <span class="comment">// Exception from ORB</span>
    exception WrongTransaction {};
    <span class="comment">// Other transaction related exceptions</span>
    exception SubtransactionsUnavailable {};
    exception NotSubtransaction {};
    exception Inactive {};
    exception NotPrepared {};
    exception NoTransaction {};
    exception InvalidControl {};
    exception Unavailable {};
    exception SynchronizationUnavailable {};
    <span class="comment">// Forward references for later interfaces</span>
    interface Control;
    interface Terminator;
    interface Coordinator;
    interface Resource;
    interface RecoveryCoordinator;
    interface SubtransactionAwareResource;
    interface TransactionFactory;
    interface TransactionalObject;
    interface Current;
    interface Synchronization;

    <span class="comment">// Formally part of CosTSInteroperation</span>
    <span class="keyword">struct</span> otid_t {
        <span class="predefined-type">long</span> formatID;
        <span class="predefined-type">long</span> bequal_length;
        sequence &lt;octet&gt; tid;
    };

    <span class="keyword">struct</span> TransIdentity {
        Coordinator coord;
        Terminator term;
        otid_t otid;
    };

    <span class="keyword">struct</span> PropagationContext{
       <span class="predefined-type">unsigned</span> <span class="predefined-type">long</span> timeout;
        TransIdentity currentTransaction;
        sequence &lt;TransIdentity&gt; parents;
        any implementation_specific_data;
    };

    interface Current : CORBA::Current {
        <span class="directive">void</span> begin () raises (SubtransactionsUnavailable);
        <span class="directive">void</span> commit (in boolean report_heuristics) raises (NoTransaction, HeuristicMixed, HeuristicHazard, TransactionRolledBack);
        <span class="directive">void</span> rollback () raises (NoTransaction);
        <span class="directive">void</span> rollback_only () raises (NoTransaction);

        Status get_status ();
        string get_transaction_name ();
        <span class="directive">void</span> set_timeout (in <span class="predefined-type">unsigned</span> <span class="predefined-type">long</span> seconds);

        Control get_control ();
        Control suspend ();
        <span class="directive">void</span> resume (in Control which) raises (InvalidControl);
    };

    interface TransactionFactory{
        Control create (in <span class="predefined-type">unsigned</span> <span class="predefined-type">long</span> time_out);
        Control recreate (in PropagationContext ctx);
    };
    interface Control {
        Terminator get_terminator () raises (Unavailable);
        Coordinator get_coordinator () raises (Unavailable);
    };

    interface Terminator{
        <span class="directive">void</span> commit (in boolean report_heuristics) raises (HeuristicMixed, HeuristicHazard, TransactionRolledBack);
        <span class="directive">void</span> rollback ();
    };

    interface Coordinator {
        Status get_status ();
        Status get_parent_status ();
        Status get_top_level_status ();

        boolean is_same_transaction (in Coordinator tc);
        boolean is_related_transaction (in Coordinator tc);
        boolean is_ancestor_transaction (in Coordinator tc);
        boolean is_descendant_transaction (in Coordinator tc);
        boolean is_top_level_transaction ();

        <span class="predefined-type">unsigned</span> <span class="predefined-type">long</span> hash_transaction ();
        <span class="predefined-type">unsigned</span> <span class="predefined-type">long</span> hash_top_level_tran ();

        RecoveryCoordinator register_resource (in Resource r) raises (Inactive);
        <span class="directive">void</span> register_synchronization (in Synchronization sync) raises (Inactive, SynchronizationUnavailable);
        <span class="directive">void</span> register_subtran_aware (in SubtransactionAwareResource r) raises (Inactive, NotSubtransaction);

        <span class="directive">void</span> rollback_only () raises (Inactive);

        string get_transaction_name ();

        Control create_subtransaction () raises (SubtransactionsUnavailable, Inactive);

        PropagationContext get_txcontext () raises (Unavailable);
    };

    interface RecoveryCoordinator {
        Status replay_completion (in Resource r) raises (NotPrepared);
    };

    interface Resource {
        Vote prepare () raises (HeuristicMixed, HeuristicHazard);
        <span class="directive">void</span> rollback () raises (HeuristicCommit, HeuristicMixed, HeuristicHazard);
        <span class="directive">void</span> commit () raises (NotPrepared, HeuristicRollback, HeuristicMixed, HeuristicHazard);
        <span class="directive">void</span> commit_one_phase () raises (HeuristicHazard);
        <span class="directive">void</span> forget ();
    };

    interface SubtransactionAwareResource : Resource {
        <span class="directive">void</span> commit_subtransaction (in Coordinator parent);
        <span class="directive">void</span> rollback_subtransaction ();
    };

    interface TransactionalObject {
    };

    interface Synchronization : TransactionalObject {
        <span class="directive">void</span> before_completion ();
        <span class="directive">void</span> after_completion (in Status s);
    };
};
<span class="preprocessor">#endif</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ArjunaOTS.IDL</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C"><span class="preprocessor">#ifndef</span> ARJUNAOTS_IDL_
<span class="preprocessor">#define</span> ARJUNAOTS_IDL_

<span class="preprocessor">#include</span> <span class="include">&lt;idl/CosTransactions.idl&gt;</span>
module ArjunaOTS {
    exception ActiveTransaction {};
    exception BadControl {};
    exception Destroyed {};
    exception ActiveThreads {};
    exception InterpositionFailed {};

    interface UidCoordinator : CosTransactions::Coordinator {
        readonly attribute string uid;
        readonly attribute string topLevelUid;
    };

    interface ActionControl : CosTransactions::Control {
        CosTransactions::Control getParentControl () raises (CosTransactions::Unavailable, CosTransactions::NotSubtransaction);
        <span class="directive">void</span> destroy () raises (ActiveTransaction, ActiveThreads, BadControl, Destroyed);
    };

    interface ArjunaSubtranAwareResource : CosTransactions::SubtransactionAwareResource {
        CosTransactions::Vote prepare_subtransaction ();
    };

    interface ArjunaTransaction : UidCoordinator, CosTransactions::Terminator {
    };

    interface OTSAbstractRecord : ArjunaSubtranAwareResource {
        readonly attribute <span class="predefined-type">long</span> typeId;
        readonly attribute string uid;

        boolean propagateOnAbort ();
        boolean propagateOnCommit ();

        boolean saveRecord ();

        <span class="directive">void</span> merge (in OTSAbstractRecord record);
        <span class="directive">void</span> alter (in OTSAbstractRecord record);

        boolean shouldAdd (in OTSAbstractRecord record);
        boolean shouldAlter (in OTSAbstractRecord record);
        boolean shouldMerge (in OTSAbstractRecord record);
        boolean shouldReplace (in OTSAbstractRecord record);
    };
};</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transaction_statuses"><a class="anchor" href="#_transaction_statuses"></a>Appendix D: REST-AT Transaction Statuses</h3>
<div class="paragraph">
<p>Resources return the following status values in response to GET requests on the appropriate <code>transaction-coordinator</code> or <code>participant-resource</code> URI:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">TransactionRollbackOnly</dt>
<dd>
<p>the status of the endpoint is that it will roll back eventually.</p>
</dd>
<dt class="hdlist1">TransactionRollingBack</dt>
<dd>
<p>the endpoint is in the process of rolling back.
If the recipient has already rolled back then it must return a 410 error code.</p>
</dd>
<dt class="hdlist1">TransactionRolledBack</dt>
<dd>
<p>the endpoint has rolled back.</p>
</dd>
<dt class="hdlist1">TransactionCommitting</dt>
<dd>
<p>the endpoint is in the process of committing.
This does not mean that the final outcome will be Committed.
If the recipient has already committed then it must return a 410 error code.</p>
</dd>
<dt class="hdlist1">TransactionCommitted</dt>
<dd>
<p>the endpoint has committed.</p>
</dd>
<dt class="hdlist1">TransactionCommittedOnePhase</dt>
<dd>
<p>the recipient has committed the transaction without going through a prepare phase.
If the recipient has previously been asked to prepare then it must return a 412 error code.
If the recipient has already terminated, then it must return a 410 error code.</p>
</dd>
<dt class="hdlist1">TransactionHeuristicRollback</dt>
<dd>
<p>all of the participants rolled back when they were asked to commit.</p>
</dd>
<dt class="hdlist1">TransactionHeuristicCommit</dt>
<dd>
<p>all of the participants committed when they were asked to rollback.</p>
</dd>
<dt class="hdlist1">TransactionHeuristicHazard</dt>
<dd>
<p>some of the participants rolled back, some committed and the outcome of others is indeterminate.</p>
</dd>
<dt class="hdlist1">TransactionHeuristicMixed</dt>
<dd>
<p>some of the participants rolled back whereas the remainder committed.</p>
</dd>
<dt class="hdlist1">TransactionPreparing</dt>
<dd>
<p>the endpoint is preparing.</p>
</dd>
<dt class="hdlist1">TransactionPrepared</dt>
<dd>
<p>the endpoint has prepared.</p>
</dd>
<dt class="hdlist1">TransactionActive</dt>
<dd>
<p>the transaction is active, i.e., has not begun to terminate.</p>
</dd>
<dt class="hdlist1">TransactionStatusUnknown</dt>
<dd>
<p>the status of the transaction is unknown</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_qa_testsuite"><a class="anchor" href="#_qa_testsuite"></a>Appendix E: QA Testsuite</h3>
<div class="paragraph">
<p>In the source git repository we maintain a testsuite for integration testing.</p>
</div>
<div class="sect3">
<h4 id="_jdbcresources_01_02"><a class="anchor" href="#_jdbcresources_01_02"></a>JDBCResources 01 &amp; 02</h4>
<div class="sect4">
<h5 id="_overview_5"><a class="anchor" href="#_overview_5"></a>Overview</h5>
<div class="ulist">
<ul>
<li>
<p>Tests</p>
<div class="ulist">
<ul>
<li>
<p>JDBC Support</p>
</li>
</ul>
</div>
</li>
<li>
<p>Series</p>
<div class="ulist">
<ul>
<li>
<p>JTSResources01: Implicit context propagation</p>
</li>
<li>
<p>JTSResources02: Explicit context propagation</p>
</li>
</ul>
</div>
</li>
<li>
<p>Sub-series</p>
<div class="ulist">
<ul>
<li>
<p>_ibmdb2_jndi</p>
</li>
<li>
<p>_mssqlserver_jndi</p>
</li>
<li>
<p>_mysql_jndi</p>
</li>
<li>
<p>_oracle_thin_jndi</p>
</li>
<li>
<p>_pgsql_jndi</p>
</li>
<li>
<p>_sybase_jndi</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_01_02_summary"><a class="anchor" href="#_jdbcresources_01_02_summary"></a>JDBCResources 01 &amp; 02 Summary</h5>
<div class="ulist">
<ul>
<li>
<p>Building blocks:</p>
<div class="ulist">
<ul>
<li>
<p>Interfaces: 1</p>
</li>
<li>
<p>Implementations: 2</p>
</li>
<li>
<p>Servers: 2</p>
</li>
<li>
<p>Setups: 2</p>
</li>
<li>
<p>Clients: 16</p>
</li>
<li>
<p>Outcomes: 4</p>
</li>
<li>
<p>Cleanups: 1</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tests:</p>
<div class="ulist">
<ul>
<li>
<p>Configurations: 32</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_01_02_interfaces"><a class="anchor" href="#_jdbcresources_01_02_interfaces"></a>JDBCResources 01 &amp; 02 Interfaces</h5>
<div class="ulist">
<ul>
<li>
<p>InfoTable</p>
<div class="ulist">
<ul>
<li>
<p>insert(in string name, in string value)</p>
</li>
<li>
<p>update(in string name, in string value)</p>
</li>
<li>
<p>select(in string name, out string value)</p>
</li>
<li>
<p>delete(in string name)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_01_02_implementations"><a class="anchor" href="#_jdbcresources_01_02_implementations"></a>JDBCResources 01 &amp; 02 Implementations</h5>
<div class="ulist">
<ul>
<li>
<p>JDBCInfoTableImpl01</p>
<div class="ulist">
<ul>
<li>
<p>Creates a single JDBC connection for all operations</p>
</li>
</ul>
</div>
</li>
<li>
<p>JDBCInfoTableImpl02</p>
<div class="ulist">
<ul>
<li>
<p>Creates a JDBC connection per operation</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_01_02_server"><a class="anchor" href="#_jdbcresources_01_02_server"></a>JDBCResources 01 &amp; 02 Server</h5>
<div class="ulist">
<ul>
<li>
<p>Server01: 1 x JDBCInfoTableImpl01</p>
</li>
<li>
<p>Server02: 1 x JDBCInfoTableImpl02</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_01_02_setups"><a class="anchor" href="#_jdbcresources_01_02_setups"></a>JDBCResources 01 &amp; 02 Setups</h5>
<div class="ulist">
<ul>
<li>
<p>Setup01</p>
<div class="ulist">
<ul>
<li>
<p>Creates Table InfoTable (Name VARCHAR(64), Value VARCHAR(64))</p>
<div class="ulist">
<ul>
<li>
<p>Inserts 10 entries ("Name_’X’", "Value_’X’") [Where X is 0 … 9]</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Setup02</p>
<div class="ulist">
<ul>
<li>
<p>Creates Table InfoTable (Name VARCHAR(64), Value VARCHAR(64))</p>
<div class="ulist">
<ul>
<li>
<p>Inserts 10 entries ("Name_’X’", "Value_’X’") [Where X is 0 … 9]</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_01_02_clients"><a class="anchor" href="#_jdbcresources_01_02_clients"></a>JDBCResources 01 &amp; 02 Clients</h5>
<div class="ulist">
<ul>
<li>
<p>Client01</p>
<div class="ulist">
<ul>
<li>
<p>Obtains an InfoTable object</p>
</li>
<li>
<p>Inserts 10 entries, no transaction</p>
</li>
<li>
<p>Verify existence of inserted entries, no transaction</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client02</p>
<div class="ulist">
<ul>
<li>
<p>Obtains an InfoTable object</p>
</li>
<li>
<p>Inserts 10 entries, within transaction</p>
</li>
<li>
<p>Verify existence of inserted entries, within transaction</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client03</p>
<div class="ulist">
<ul>
<li>
<p>Obtains an InfoTable object</p>
</li>
<li>
<p>Inserts 10 entries, within transaction</p>
</li>
<li>
<p>Update entry, with transaction which rolls back</p>
</li>
<li>
<p>Verify existence of inserted entries, within transaction</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client04</p>
<div class="ulist">
<ul>
<li>
<p>Obtains an InfoTable object</p>
</li>
<li>
<p>Inserts 10 entries, within transaction</p>
</li>
<li>
<p>Delete entry, with transaction which rolls back</p>
</li>
<li>
<p>Verify existence of inserted entries, within transaction</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client05</p>
<div class="ulist">
<ul>
<li>
<p>Obtains an InfoTable object</p>
</li>
<li>
<p>Inserts 10 entries, within transaction</p>
</li>
<li>
<p>Update entry, within transaction</p>
</li>
<li>
<p>Update same entry with old value, no transaction</p>
</li>
<li>
<p>Verify existence of inserted entries, within transaction</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client06</p>
<div class="ulist">
<ul>
<li>
<p>Obtains an InfoTable object</p>
</li>
<li>
<p>Inserts 10 entries, within transaction</p>
</li>
<li>
<p>Update entry, no transaction</p>
</li>
<li>
<p>Update same entry with old value, within transaction</p>
</li>
<li>
<p>Verify existence of inserted entries, within transaction</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client07</p>
<div class="ulist">
<ul>
<li>
<p>Obtains two InfoTable objects</p>
</li>
<li>
<p>Update 10 entries, split alternatively, over each object</p>
<div class="ulist">
<ul>
<li>
<p>Name_’X’", "Value_’9-X’") [Where X is 0 … 9]</p>
</li>
<li>
<p>No transaction</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Client08</p>
<div class="ulist">
<ul>
<li>
<p>Obtains two InfoTable objects</p>
</li>
<li>
<p>Update 10 entries, split alternatively, over each object</p>
<div class="ulist">
<ul>
<li>
<p>Name_’X’", "Value_’9-X’") [Where X is 0 … 9]</p>
</li>
<li>
<p>Within transaction</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Client09</p>
<div class="ulist">
<ul>
<li>
<p>Obtains two InfoTable objects</p>
</li>
<li>
<p>Update 10 entries, split alternatively, over each object</p>
<div class="ulist">
<ul>
<li>
<p>Name_’X’", "Value_’9-X’") [Where X is 0 … 9]</p>
</li>
<li>
<p>Within transaction, per update</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Client10</p>
<div class="ulist">
<ul>
<li>
<p>Obtains two InfoTable objects</p>
</li>
<li>
<p>Update 10 entries, split alternatively, over each object</p>
<div class="ulist">
<ul>
<li>
<p>Name_’X’", "Value_’9-X’") [Where X is 0 … 9]</p>
</li>
<li>
<p>Within transaction, which rolls back</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Client11</p>
<div class="ulist">
<ul>
<li>
<p>Obtains two InfoTable objects</p>
</li>
<li>
<p>Update 10 entries, split alternatively, over each object</p>
<div class="ulist">
<ul>
<li>
<p>Name_’X’", "Value_’9-X’") [Where X is 0 … 9]</p>
</li>
<li>
<p>Within transaction, per update, which rolls back</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Client12</p>
<div class="ulist">
<ul>
<li>
<p>Obtains two InfoTable objects</p>
</li>
<li>
<p>Update 10 entries, in each object</p>
<div class="ulist">
<ul>
<li>
<p>Name_’X’", "Value_’9-X’") [Where X is 0 … 9]</p>
</li>
<li>
<p>No transaction</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Client13</p>
<div class="ulist">
<ul>
<li>
<p>Obtains two InfoTable objects</p>
</li>
<li>
<p>Update 10 entries, in each object</p>
<div class="ulist">
<ul>
<li>
<p>Name_’X’", "Value_’9-X’") [Where X is 0 … 9]</p>
</li>
<li>
<p>Within transaction</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Client14</p>
<div class="ulist">
<ul>
<li>
<p>Obtains two InfoTable objects</p>
</li>
<li>
<p>Update 10 entries, in each object</p>
<div class="ulist">
<ul>
<li>
<p>Name_’X’", "Value_’9-X’") [Where X is 0 … 9]</p>
</li>
<li>
<p>Within transaction, per update</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Client15</p>
<div class="ulist">
<ul>
<li>
<p>Obtains two InfoTable objects</p>
</li>
<li>
<p>Update 10 entries, in each object</p>
<div class="ulist">
<ul>
<li>
<p>Name_’X’", "Value_’9-X’") [Where X is 0 … 9]</p>
</li>
<li>
<p>Within transaction, which rolls back</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Client16</p>
<div class="ulist">
<ul>
<li>
<p>Obtains two InfoTable objects</p>
</li>
<li>
<p>Update 10 entries, in each object</p>
<div class="ulist">
<ul>
<li>
<p>Name_’X’", "Value_’9-X’") [Where X is 0 … 9]</p>
</li>
<li>
<p>Within transaction, per update, which rolls back</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_01_02_outcomes"><a class="anchor" href="#_jdbcresources_01_02_outcomes"></a>JDBCResources 01 &amp; 02 Outcomes</h5>
<div class="ulist">
<ul>
<li>
<p>Outcome01</p>
<div class="ulist">
<ul>
<li>
<p>Verify existence and values of inserted entries</p>
</li>
</ul>
</div>
</li>
<li>
<p>Outcome02</p>
<div class="ulist">
<ul>
<li>
<p>Verify existence and values [reverse] of inserted entries</p>
</li>
</ul>
</div>
</li>
<li>
<p>Outcome03</p>
<div class="ulist">
<ul>
<li>
<p>Verify existence and values of inserted entries, in two InfoTables</p>
</li>
</ul>
</div>
</li>
<li>
<p>Outcome04</p>
<div class="ulist">
<ul>
<li>
<p>Verify existence and values [reverse] of inserted entries, in two InfoTables</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_01_02_cleanups"><a class="anchor" href="#_jdbcresources_01_02_cleanups"></a>JDBCResources 01 &amp; 02 Cleanups</h5>
<div class="ulist">
<ul>
<li>
<p>Cleanup01</p>
<div class="ulist">
<ul>
<li>
<p>Drops Table "InfoTable"</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_01_02_configurations"><a class="anchor" href="#_jdbcresources_01_02_configurations"></a>JDBCResources 01 &amp; 02 Configurations</h5>
<div class="ulist">
<ul>
<li>
<p>Test001: 1 x Server01 + 1 x Client01</p>
</li>
<li>
<p>Test002: 1 x Server01 + 1 x Client02</p>
</li>
<li>
<p>Test003: 1 x Server01 + 1 x Client03</p>
</li>
<li>
<p>Test004: 1 x Server01 + 1 x Client04</p>
</li>
<li>
<p>Test005: 1 x Server01 + 1 x Client05</p>
</li>
<li>
<p>Test006: 1 x Server01 + 1 x Client06</p>
</li>
<li>
<p>Test007: 1 x Server02 + 1 x Client01</p>
</li>
<li>
<p>Test008: 1 x Server02 + 1 x Client02</p>
</li>
<li>
<p>Test009: 1 x Server02 + 1 x Client03</p>
</li>
<li>
<p>Test010: 1 x Server02 + 1 x Client04</p>
</li>
<li>
<p>Test011: 1 x Server02 + 1 x Client05</p>
</li>
<li>
<p>Test012: 1 x Server02 + 1 x Client06</p>
</li>
<li>
<p>Test013: 2 x Server01 + 1 x Client07 + Outcome02</p>
</li>
<li>
<p>Test014: 2 x Server01 + 1 x Client08 + Outcome02</p>
</li>
<li>
<p>Test015: 2 x Server01 + 1 x Client09 + Outcome02</p>
</li>
<li>
<p>Test016: 2 x Server01 + 1 x Client10 + Outcome01</p>
</li>
<li>
<p>Test017: 2 x Server01 + 1 x Client11 + Outcome01</p>
</li>
<li>
<p>Test018: 2 x Server02 + 1 x Client07 + Outcome02</p>
</li>
<li>
<p>Test019: 2 x Server02 + 1 x Client08 + Outcome02</p>
</li>
<li>
<p>Test020: 2 x Server02 + 1 x Client09 + Outcome02</p>
</li>
<li>
<p>Test021: 2 x Server02 + 1 x Client10 + Outcome01</p>
</li>
<li>
<p>Test022: 2 x Server02 + 1 x Client11 + Outcome01</p>
</li>
<li>
<p>Test023: 2 x Server01 + 1 x Client12 + Outcome04</p>
</li>
<li>
<p>Test024: 2 x Server01 + 1 x Client13 + Outcome04</p>
</li>
<li>
<p>Test025: 2 x Server01 + 1 x Client14 + Outcome04</p>
</li>
<li>
<p>Test026: 2 x Server01 + 1 x Client15 + Outcome03</p>
</li>
<li>
<p>Test027: 2 x Server01 + 1 x Client16 + Outcome03</p>
</li>
<li>
<p>Test028: 2 x Server02 + 1 x Client12 + Outcome04</p>
</li>
<li>
<p>Test029: 2 x Server02 + 1 x Client13 + Outcome04</p>
</li>
<li>
<p>Test030: 2 x Server02 + 1 x Client14 + Outcome04</p>
</li>
<li>
<p>Test031: 2 x Server02 + 1 x Client15 + Outcome03</p>
</li>
<li>
<p>Test032: 2 x Server02 + 1 x Client16 + Outcome03</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jdbcresources_03_04"><a class="anchor" href="#_jdbcresources_03_04"></a>JDBCResources 03 &amp; 04</h4>
<div class="sect4">
<h5 id="_overview_6"><a class="anchor" href="#_overview_6"></a>Overview</h5>
<div class="ulist">
<ul>
<li>
<p>Tests</p>
<div class="ulist">
<ul>
<li>
<p>JDBC Support – Conflict over resource</p>
</li>
<li>
<p>May fail: Depending on DB’s behaviour</p>
</li>
</ul>
</div>
</li>
<li>
<p>Series</p>
<div class="ulist">
<ul>
<li>
<p>JTSResources03: Implicit context propagation</p>
</li>
<li>
<p>JTSResources04: Explicit context propagation</p>
</li>
</ul>
</div>
</li>
<li>
<p>Sub-series</p>
<div class="ulist">
<ul>
<li>
<p>_ibmdb2_jndi</p>
</li>
<li>
<p>_mssqlserver_jndi</p>
</li>
<li>
<p>_mysql_jndi</p>
</li>
<li>
<p>_oracle_thin_jndi</p>
</li>
<li>
<p>_pgsql_jndi</p>
</li>
<li>
<p>_sybase_jndi</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_03_04_summary"><a class="anchor" href="#_jdbcresources_03_04_summary"></a>JDBCResources 03 &amp; 04 Summary</h5>
<div class="ulist">
<ul>
<li>
<p>Building blocks:</p>
<div class="ulist">
<ul>
<li>
<p>Interfaces: 1</p>
</li>
<li>
<p>Implementations: 2</p>
</li>
<li>
<p>Servers: 2</p>
</li>
<li>
<p>Setups: 1</p>
</li>
<li>
<p>Clients: 1</p>
</li>
<li>
<p>Outcomes: 1</p>
</li>
<li>
<p>Cleanups: 1</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tests:</p>
<div class="ulist">
<ul>
<li>
<p>Configurations: 4</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_03_04_interfaces"><a class="anchor" href="#_jdbcresources_03_04_interfaces"></a>JDBCResources 03 &amp; 04 Interfaces</h5>
<div class="ulist">
<ul>
<li>
<p>NumberTable</p>
<div class="ulist">
<ul>
<li>
<p>get(in string name, out long value)</p>
</li>
<li>
<p>set(in string name, in long value)</p>
</li>
<li>
<p>increase(in string name)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_03_04_implementations"><a class="anchor" href="#_jdbcresources_03_04_implementations"></a>JDBCResources 03 &amp; 04 Implementations</h5>
<div class="ulist">
<ul>
<li>
<p>JDBCNumberTableImpl01</p>
<div class="ulist">
<ul>
<li>
<p>Creates a single JDBC connection for all operations</p>
</li>
</ul>
</div>
</li>
<li>
<p>JDBCNumberTableImpl02</p>
<div class="ulist">
<ul>
<li>
<p>Creates a JDBC connection per operation</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_03_04_server"><a class="anchor" href="#_jdbcresources_03_04_server"></a>JDBCResources 03 &amp; 04 Server</h5>
<div class="ulist">
<ul>
<li>
<p>Server01: 1 x JDBCNumberTableImpl01</p>
</li>
<li>
<p>Server02: 1 x JDBCNumberTableImpl02</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_03_04_setups"><a class="anchor" href="#_jdbcresources_03_04_setups"></a>JDBCResources 03 &amp; 04 Setups</h5>
<div class="ulist">
<ul>
<li>
<p>Setup01</p>
<div class="ulist">
<ul>
<li>
<p>Creates Table NumberTable</p>
<div class="ulist">
<ul>
<li>
<p>Name VARCHAR(64), Value INTEGER)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Inserts n entries</p>
<div class="ulist">
<ul>
<li>
<p>Name_’X’", "0") [Where X is 0 … n - 1]</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_03_04_clients"><a class="anchor" href="#_jdbcresources_03_04_clients"></a>JDBCResources 03 &amp; 04 Clients</h5>
<div class="ulist">
<ul>
<li>
<p>Client01</p>
<div class="ulist">
<ul>
<li>
<p>Operation</p>
<div class="ulist">
<ul>
<li>
<p>Obtains an NumberTable object</p>
</li>
<li>
<p>Begin transaction</p>
</li>
<li>
<p>Gets Values for "Name_0" and "Name_1"</p>
</li>
<li>
<p>Increase value associated with "Name_0"</p>
</li>
<li>
<p>Sleeps 15 sec.</p>
</li>
<li>
<p>Increase value associated with "Name_1"</p>
</li>
<li>
<p>Gets Values for "Name_0" and "Name_1"</p>
</li>
<li>
<p>Commit(true) transaction</p>
</li>
</ul>
</div>
</li>
<li>
<p>Passes if:</p>
<div class="ulist">
<ul>
<li>
<p>New values are the same, and equals old values plus one, or</p>
</li>
<li>
<p>InvocationException thrown with Reason "ReasonCantSerializeAccess"</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_03_04_outcomes"><a class="anchor" href="#_jdbcresources_03_04_outcomes"></a>JDBCResources 03 &amp; 04 Outcomes</h5>
<div class="ulist">
<ul>
<li>
<p>Outcome01</p>
<div class="ulist">
<ul>
<li>
<p>Verify first n entries (0 … n - 1) have value n</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_03_04_cleanups"><a class="anchor" href="#_jdbcresources_03_04_cleanups"></a>JDBCResources 03 &amp; 04 Cleanups</h5>
<div class="ulist">
<ul>
<li>
<p>Cleanup01</p>
<div class="ulist">
<ul>
<li>
<p>Drops Table "NumberTable"</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jdbcresources_03_04_configurations"><a class="anchor" href="#_jdbcresources_03_04_configurations"></a>JDBCResources 03 &amp; 04 Configurations</h5>
<div class="ulist">
<ul>
<li>
<p>Test01: 1 x Server01 + 2 x Client01 + Outcome01</p>
</li>
<li>
<p>Test02: 2 x Server01 + 2 x Client01 + Outcome01</p>
</li>
<li>
<p>Test03: 1 x Server02 + 2 x Client01 + Outcome01</p>
</li>
<li>
<p>Test04: 2 x Server02 + 2 x Client01 + Outcome01</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_currenttests"><a class="anchor" href="#_currenttests"></a>CurrentTests</h4>
<div class="sect4">
<h5 id="_overview_7"><a class="anchor" href="#_overview_7"></a>Overview</h5>
<div class="ulist">
<ul>
<li>
<p>Tests</p>
<div class="ulist">
<ul>
<li>
<p>Test Current interface</p>
</li>
<li>
<p>Close to "Unit Tests"</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_currenttests01_summary"><a class="anchor" href="#_currenttests01_summary"></a>CurrentTests01 Summary</h5>
<div class="ulist">
<ul>
<li>
<p>Building blocks:</p>
<div class="ulist">
<ul>
<li>
<p>Interfaces: 0</p>
</li>
<li>
<p>Implementations: 0</p>
</li>
<li>
<p>Servers: 0</p>
</li>
<li>
<p>Clients: 34</p>
</li>
<li>
<p>Outcomes: 0</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tests:</p>
<div class="ulist">
<ul>
<li>
<p>Configurations: 34</p>
</li>
<li>
<p>TestXX.java maps to Test0XX.conf</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_currenttests_clients"><a class="anchor" href="#_currenttests_clients"></a>CurrentTests Clients</h5>
<div class="ulist">
<ul>
<li>
<p>Tests 01 through 16: Complete transaction and then check that a further operation throws NoTransaction:</p>
</li>
<li>
<p>Test17</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Tests 01 through 16</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Op To Check</th>
<th class="tableblock halign-left valign-top">None</th>
<th class="tableblock halign-left valign-top">begin commit(true)</th>
<th class="tableblock halign-left valign-top">begin commit(false)</th>
<th class="tableblock halign-left valign-top">begin rollback</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">commit(true)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test05</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test09</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test13</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">commit(false)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test02</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test06</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test14</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rollback()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test07</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test15</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rollback_only()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test04</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test08</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test16</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>Create a series if 1000 transactions, terminated with commit(true)</p>
</li>
<li>
<p>Checks all names (get_transaction_name) are unique</p>
<div class="ulist">
<ul>
<li>
<p>Test18</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create a series if 1000 transactions, terminated with commit(false)</p>
</li>
<li>
<p>Checks all names (get_transaction_name) are unique</p>
<div class="ulist">
<ul>
<li>
<p>Test19</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create a series if 1000 transactions, terminated with rollback()</p>
</li>
<li>
<p>Checks all names (get_transaction_name) are unique</p>
<div class="ulist">
<ul>
<li>
<p>Test20</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create and suspends 1000 transactions</p>
</li>
<li>
<p>Resumes transactions in series</p>
</li>
<li>
<p>Checks names (get_transaction_name) correspond</p>
<div class="ulist">
<ul>
<li>
<p>Test21</p>
</li>
</ul>
</div>
</li>
<li>
<p>Preamble: None</p>
</li>
<li>
<p>Checks if suspend return null, then not transaction</p>
<div class="ulist">
<ul>
<li>
<p>Test22</p>
</li>
</ul>
</div>
</li>
<li>
<p>Preamble: begin(), commit(true)</p>
</li>
<li>
<p>Checks if suspend return null, then not transaction</p>
<div class="ulist">
<ul>
<li>
<p>Test23</p>
</li>
</ul>
</div>
</li>
<li>
<p>Preamble: begin(), commit(false)</p>
</li>
<li>
<p>Checks if suspend return null, then not transaction</p>
<div class="ulist">
<ul>
<li>
<p>Test24</p>
</li>
</ul>
</div>
</li>
<li>
<p>Preamble: begin(), rollback()</p>
</li>
<li>
<p>Checks if suspend return null, then not transaction</p>
<div class="ulist">
<ul>
<li>
<p>Test25</p>
</li>
</ul>
</div>
</li>
<li>
<p>Checks resume(null) does not throw InvalidControl</p>
<div class="ulist">
<ul>
<li>
<p>Test26</p>
</li>
</ul>
</div>
</li>
<li>
<p>Checks that resume() of transaction terminated with commit(true) throws InvalidControl</p>
<div class="ulist">
<ul>
<li>
<p>Test27</p>
</li>
</ul>
</div>
</li>
<li>
<p>Checks that resume() of transaction terminated with commit(false) throws InvalidControl</p>
<div class="ulist">
<ul>
<li>
<p>Test28</p>
</li>
</ul>
</div>
</li>
<li>
<p>Checks that resume() of transaction terminated with rollback() throws InvalidControl</p>
<div class="ulist">
<ul>
<li>
<p>Test29</p>
</li>
</ul>
</div>
</li>
<li>
<p>Preamble: None</p>
</li>
<li>
<p>Checks that get_status() when no transaction returns StatusNoTransaction</p>
<div class="ulist">
<ul>
<li>
<p>Test30</p>
</li>
</ul>
</div>
</li>
<li>
<p>Preamble: begin(), commit(true)</p>
</li>
<li>
<p>Checks that get_status() when no transaction returns StatusNoTransaction</p>
<div class="ulist">
<ul>
<li>
<p>Test31</p>
</li>
</ul>
</div>
</li>
<li>
<p>Preamble: begin(), commit(false)</p>
</li>
<li>
<p>Checks that get_status() when no transaction returns StatusNoTransaction</p>
<div class="ulist">
<ul>
<li>
<p>Test32</p>
</li>
</ul>
</div>
</li>
<li>
<p>Preamble: begin(), rollback()</p>
</li>
<li>
<p>Checks that get_status() when no transaction returns StatusNoTransaction</p>
<div class="ulist">
<ul>
<li>
<p>Test33</p>
</li>
</ul>
</div>
</li>
<li>
<p>Checks that get_status() when in transaction returns StatusActive</p>
<div class="ulist">
<ul>
<li>
<p>Test34</p>
</li>
</ul>
</div>
</li>
<li>
<p>Checks that get_status() when in transaction marked roll back only returns StatusMarkedRollback</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_otsserver"><a class="anchor" href="#_otsserver"></a>OTSServer</h4>
<div class="sect4">
<h5 id="_overview_8"><a class="anchor" href="#_overview_8"></a>Overview</h5>
<div class="ulist">
<ul>
<li>
<p>Tests</p>
<div class="ulist">
<ul>
<li>
<p>Tests OTSServer (a TransactionFactory interface implementation)</p>
</li>
<li>
<p>Test001 to Test006 (Test003 to Test006 requires "DYNAMIC") - ClientXX.java maps to Test0XX.conf</p>
</li>
<li>
<p>Test007 to Test012 - ClientXX.java maps to Test0XX.conf with args 1000</p>
</li>
<li>
<p>Test013 to Test016 - Client13: x1, x2 with args 4 250 and x3, x4 with args 4 100</p>
</li>
<li>
<p>Test017 to Test020 - Client13: x1, x2 with args 4 250 and x3, x4 with args 4 100</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_otsserver_summary"><a class="anchor" href="#_otsserver_summary"></a>OTSServer Summary</h5>
<div class="ulist">
<ul>
<li>
<p>Building blocks:</p>
<div class="ulist">
<ul>
<li>
<p>Interfaces: 0</p>
</li>
<li>
<p>Implementations: 0</p>
</li>
<li>
<p>Servers: 1 (OTS_Server)</p>
</li>
<li>
<p>Clients: 14</p>
</li>
<li>
<p>Outcomes: 0</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tests:</p>
<div class="ulist">
<ul>
<li>
<p>Configurations: 20</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_otsserver_clients"><a class="anchor" href="#_otsserver_clients"></a>OTSServer Clients</h5>
<div class="ulist">
<ul>
<li>
<p>Test01</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(0)</p>
</li>
<li>
<p>Check its status is StatusActive</p>
</li>
<li>
<p>Check commit(true) does not throw exception</p>
</li>
</ul>
</div>
</li>
<li>
<p>Test02</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(0)</p>
</li>
<li>
<p>Check its status is StatusActive</p>
</li>
<li>
<p>Check rollback() does not throw exception</p>
</li>
</ul>
</div>
</li>
<li>
<p>Test03</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(4)</p>
</li>
<li>
<p>Check its status is StatusRolledBack, after 8 seconds</p>
</li>
</ul>
</div>
</li>
<li>
<p>Test04</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(4)</p>
</li>
<li>
<p>Check commit(true) throws INVALID_TRANSACTION or BAD_OPERATION, after 8 seconds</p>
</li>
</ul>
</div>
</li>
<li>
<p>Test05</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(4)</p>
</li>
<li>
<p>Check commit(false) throws INVALID_TRANSACTION or BAD_OPERATION, after 8 seconds</p>
</li>
</ul>
</div>
</li>
<li>
<p>Test06</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(4)</p>
</li>
<li>
<p>Check commit(true) throws INVALID_TRANSACTION or BAD_OPERATION, after 8 seconds</p>
</li>
</ul>
</div>
</li>
<li>
<p>Test07</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(0)</p>
</li>
<li>
<p>Check its status is StatusActive</p>
</li>
<li>
<p>Check commit(true) does not throw exception, repeat n times</p>
</li>
</ul>
</div>
</li>
<li>
<p>Test08</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(0)</p>
</li>
<li>
<p>Check its status is StatusActive</p>
</li>
<li>
<p>Check commit(false) does not throw exception, repeat n times</p>
</li>
</ul>
</div>
</li>
<li>
<p>Test09</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(0)</p>
</li>
<li>
<p>Check its status is StatusActive</p>
</li>
<li>
<p>Check rollback() does not throw exception, repeat n times</p>
</li>
</ul>
</div>
</li>
<li>
<p>Test10</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(0), repeat n times</p>
</li>
<li>
<p>Check each status is StatusActive</p>
</li>
<li>
<p>Check each commit(true) does not throw exception</p>
</li>
</ul>
</div>
</li>
<li>
<p>Test11</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(0), repeat n times</p>
</li>
<li>
<p>Check each status is StatusActive</p>
</li>
<li>
<p>Check each commit(false) does not throw exception</p>
</li>
</ul>
</div>
</li>
<li>
<p>Test12</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(0), repeat n times</p>
</li>
<li>
<p>Check each status is StatusActive</p>
</li>
<li>
<p>Check each rollback() does not throw exception</p>
</li>
</ul>
</div>
</li>
<li>
<p>Test13</p>
<div class="ulist">
<ul>
<li>
<p>Create n threads which does m times</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(0)</p>
</li>
<li>
<p>Check its status is StatusActive</p>
</li>
<li>
<p>Checks commit(true), commit(false), rollback(), alternatively, does not throw an exception</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Test14</p>
<div class="ulist">
<ul>
<li>
<p>Create n threads which does</p>
<div class="ulist">
<ul>
<li>
<p>Creates a transaction via transactionFactory.create(0) m times</p>
</li>
<li>
<p>Check each status is StatusActive</p>
</li>
<li>
<p>Checks each commit(true), commit(false), rollback(), alternatively, does not throw an exception</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_aitresources"><a class="anchor" href="#_aitresources"></a>AITResources</h4>
<div class="sect4">
<h5 id="_overview_9"><a class="anchor" href="#_overview_9"></a>Overview</h5>
<div class="ulist">
<ul>
<li>
<p>AIT</p>
<div class="ulist">
<ul>
<li>
<p>Advanced(/Arjuna) Integrated(/Interface) Transactions</p>
</li>
<li>
<p>Transactional Objects for Java</p>
</li>
</ul>
</div>
</li>
<li>
<p>Series</p>
<div class="ulist">
<ul>
<li>
<p>AITResources01: Implicit context propagation</p>
</li>
<li>
<p>AITResources02: Explicit context propagation</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tests</p>
<div class="ulist">
<ul>
<li>
<p>Transaction Engine</p>
</li>
<li>
<p>AIT support</p>
</li>
<li>
<p>Context propagation</p>
</li>
<li>
<p>Memory problems</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_aitresources_01_02_summary"><a class="anchor" href="#_aitresources_01_02_summary"></a>AITResources 01 &amp; 02 Summary</h5>
<div class="ulist">
<ul>
<li>
<p>Building blocks:</p>
<div class="ulist">
<ul>
<li>
<p>Interfaces: 2 (Counter &amp; PingPong)</p>
</li>
<li>
<p>Implementations: 4 (3 Counter, 1 PingPong)</p>
</li>
<li>
<p>Servers: 10</p>
</li>
<li>
<p>Clients: 17</p>
</li>
<li>
<p>Outcomes: 2</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tests:</p>
<div class="ulist">
<ul>
<li>
<p>Functional: 44</p>
</li>
<li>
<p>Memory: 14</p>
</li>
<li>
<p>Configurations: 58</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_aitresources_interfaces"><a class="anchor" href="#_aitresources_interfaces"></a>AITResources Interfaces</h5>
<div class="ulist">
<ul>
<li>
<p>Counter</p>
<div class="ulist">
<ul>
<li>
<p>get()</p>
</li>
<li>
<p>set()</p>
</li>
<li>
<p>increase()</p>
</li>
<li>
<p>getMemory()</p>
</li>
</ul>
</div>
</li>
<li>
<p>PingPong</p>
<div class="ulist">
<ul>
<li>
<p>hit(count, ping, pong)</p>
<div class="ulist">
<ul>
<li>
<p>If count != 0, call hit on ping, with count-1, and ping and pong swapped</p>
</li>
<li>
<p>If count == 0, increase a value in object</p>
</li>
</ul>
</div>
</li>
<li>
<p>bad_hit(count, bad_count, ping, pong)</p>
<div class="ulist">
<ul>
<li>
<p>similar to hit(), except if bad_count == 0, abort transaction</p>
</li>
</ul>
</div>
</li>
<li>
<p>get()</p>
</li>
<li>
<p>getMemory()</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_aitresources_implementations"><a class="anchor" href="#_aitresources_implementations"></a>AITResources Implementations</h5>
<div class="ulist">
<ul>
<li>
<p>AITCounterImpl01 - Operations create [nested] transactions (AtomicTransaction)</p>
</li>
<li>
<p>AITCounterImpl02 - Operations create [nested] transactions (OTS.current)</p>
</li>
<li>
<p>AITCounterImpl03 - Operations do not create transactions</p>
</li>
<li>
<p>AITPingPongImpl01 - Operations create [nested] transactions (AtomicTransaction)</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_aitresources_server"><a class="anchor" href="#_aitresources_server"></a>AITResources Server</h5>
<div class="ulist">
<ul>
<li>
<p>Server01: 1 x AITCounterImpl01</p>
</li>
<li>
<p>Server02: 4 x AITCounterImpl01</p>
</li>
<li>
<p>Server03: 1 x AITCounterImpl02</p>
</li>
<li>
<p>Server04: 4 x AITCounterImpl02</p>
</li>
<li>
<p>Server05: 1 x AITCounterImpl01, 1 x AITCounterImpl02</p>
</li>
<li>
<p>Server06: 2 x AITCounterImpl01, 2 x AITCounterImpl02</p>
</li>
<li>
<p>Server07: 1 x AITPingPongImpl01</p>
</li>
<li>
<p>Server08: 2 x AITPingPongImpl01</p>
</li>
<li>
<p>Server09: 1 x AITCounterImpl03</p>
</li>
<li>
<p>Server10: 4 x AITCounterImpl03</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_aitresources_clients"><a class="anchor" href="#_aitresources_clients"></a>AITResources Clients</h5>
<div class="ulist">
<ul>
<li>
<p>Client01</p>
<div class="ulist">
<ul>
<li>
<p>Performs 1000 increase(), no client transaction</p>
</li>
<li>
<p>Does get() to check counter value now 1000</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client02</p>
<div class="ulist">
<ul>
<li>
<p>Performs 1000 increase(), each with own transaction</p>
</li>
<li>
<p>Transactions are alternatively committed/rolled back</p>
</li>
<li>
<p>Does get() to check counter value now 500</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client03</p>
<div class="ulist">
<ul>
<li>
<p>Memory check version of Client01</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client04</p>
<div class="ulist">
<ul>
<li>
<p>Memory check version of Client02</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client05</p>
<div class="ulist">
<ul>
<li>
<p>Performs 10 hit(), with count 0,1,2 … 9, ping and pong same, no client transaction</p>
</li>
<li>
<p>Does get() to check value now 10</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client06</p>
<div class="ulist">
<ul>
<li>
<p>Performs 10 hit(), with count 0,1,2 … 9, ping and pong different, no client transaction</p>
</li>
<li>
<p>Does get(), on both ping and pong, to check values are now 5</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client07</p>
<div class="ulist">
<ul>
<li>
<p>Memory check version of Client05</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client08</p>
<div class="ulist">
<ul>
<li>
<p>Memory check version of Client06</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client09</p>
<div class="ulist">
<ul>
<li>
<p>Performs 1000 successful increase(), no client transaction</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client10</p>
<div class="ulist">
<ul>
<li>
<p>Performs 10 bad_hit(), with count 0,1,2 … 9, for each bad_count 0 … count, ping and pong same, no client transaction</p>
</li>
<li>
<p>Does get() to check value now 0</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client11</p>
<div class="ulist">
<ul>
<li>
<p>Performs 10 bad_hit(), with count 0,1,2 … 9 , for each bad_count 0 … count, ping and pong different, no client transaction</p>
</li>
<li>
<p>Does get(), on both ping and pong, to check values are now 0</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client12</p>
<div class="ulist">
<ul>
<li>
<p>Memory check version of Client10</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client13</p>
<div class="ulist">
<ul>
<li>
<p>Memory check version of Client11</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client14</p>
<div class="ulist">
<ul>
<li>
<p>Creates n threads, which each performs m successful increase(), no client transaction</p>
</li>
<li>
<p>Does get() to check counter value now n * m</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client15</p>
<div class="ulist">
<ul>
<li>
<p>Memory check version of Client14</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client16</p>
<div class="ulist">
<ul>
<li>
<p>Creates n threads, which each performs m successful increase(), each with own transaction, commits if increase() was successful, rolls bask if increase() was unsuccessful</p>
</li>
<li>
<p>Does get() to check counter value now n * m</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client17</p>
<div class="ulist">
<ul>
<li>
<p>Memory check version of Client16</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_aitresources_outcomes"><a class="anchor" href="#_aitresources_outcomes"></a>AITResources Outcomes</h5>
<div class="ulist">
<ul>
<li>
<p>Outcome01</p>
</li>
<li>
<p>Checks if a counter has an "expected value"</p>
</li>
<li>
<p>Outcome02</p>
</li>
<li>
<p>Checks if two counters has an "expected value"</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_aitresources_memory_tests"><a class="anchor" href="#_aitresources_memory_tests"></a>AITResources Memory Tests</h5>
<div class="ulist">
<ul>
<li>
<p>General form:</p>
<div class="ulist">
<ul>
<li>
<p>Perform test pattern (reduced)</p>
<div class="ulist">
<ul>
<li>
<p>Make sure all classes loaded</p>
</li>
<li>
<p>Caches full</p>
</li>
</ul>
</div>
</li>
<li>
<p>Get memory of all Clients and Servers</p>
<div class="ulist">
<ul>
<li>
<p>Repeat: run GC, get memory until no further decreases</p>
</li>
</ul>
</div>
</li>
<li>
<p>Perform test pattern</p>
</li>
<li>
<p>Get memory of all Clients and Servers</p>
<div class="ulist">
<ul>
<li>
<p>Repeat: run GC, get memory until no further decreases</p>
</li>
</ul>
</div>
</li>
<li>
<p>Perform check</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_crashrecovery"><a class="anchor" href="#_crashrecovery"></a>CrashRecovery</h4>
<div class="sect4">
<h5 id="_crashrecovery_summary"><a class="anchor" href="#_crashrecovery_summary"></a>CrashRecovery Summary</h5>
<div class="ulist">
<ul>
<li>
<p>CrashRecovery01</p>
<div class="ulist">
<ul>
<li>
<p>Tests replay_completion (Implicit context propagation)</p>
</li>
</ul>
</div>
</li>
<li>
<p>CrashRecovery02 (_1: One resource &amp; _2: Two resource)</p>
<div class="ulist">
<ul>
<li>
<p>Tests behaviour server crash (Implicit context propagation)</p>
</li>
</ul>
</div>
</li>
<li>
<p>CrashRecovery03</p>
<div class="ulist">
<ul>
<li>
<p>Tests replay_completion called with null (Implicit context propagation)</p>
</li>
</ul>
</div>
</li>
<li>
<p>CrashRecovery04</p>
<div class="ulist">
<ul>
<li>
<p>Tests replay_completion (Explicit context propagation)</p>
</li>
</ul>
</div>
</li>
<li>
<p>CrashRecovery05 (_1: One resource &amp; _2: Two resource)</p>
<div class="ulist">
<ul>
<li>
<p>Tests behaviour server crash (Explicit context propagation)</p>
</li>
</ul>
</div>
</li>
<li>
<p>CrashRecovery06</p>
<div class="ulist">
<ul>
<li>
<p>Tests replay_completion called with null (Explicit context propagation)</p>
</li>
</ul>
</div>
</li>
<li>
<p>CrashRecovery07</p>
<div class="ulist">
<ul>
<li>
<p>Tests behaviour client crash (Implicit context propagation)</p>
</li>
</ul>
</div>
</li>
<li>
<p>CrashRecovery08</p>
<div class="ulist">
<ul>
<li>
<p>Tests behaviour client crash (Explicit context propagation)</p>
</li>
</ul>
</div>
</li>
<li>
<p>CrashRecovery09</p>
<div class="ulist">
<ul>
<li>
<p>Tests automatic TO (AIT) resource initiated crash recovery (Implicit context propagation)</p>
</li>
<li>
<p>Not supported by system, if passes caused by recovery manager initiated crash recovery ]</p>
</li>
</ul>
</div>
</li>
<li>
<p>CrashRecovery10</p>
<div class="ulist">
<ul>
<li>
<p>Tests automatic TO (AIT) resource initiated crash recovery (Explicit context propagation)</p>
</li>
<li>
<p>Not supported by system, if passes caused by recovery manager initiated crash recovery ]</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-09-27 14:39:50 +0100
</div>
</div>
</body>
</html>