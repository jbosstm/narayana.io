<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>General Procedures</title>
<style>
@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";
@import "https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css";

h6 > .content > .title,h7,h8,h9 {
    font-family:"Open Sans","DejaVu Sans",sans-serif;
    font-weight:normal;
    font-size:.85em;
    font-style:normal;
    color:#ba8425;
    text-rendering:optimizeLegibility;
    margin-top:1em;
    margin-bottom:1em;
    line-height:2em
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>General Procedures</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_administration">1. Administration</a>
<ul class="sectlevel2">
<li><a href="#_introduction">1.1. Introduction</a></li>
<li><a href="#_objectstore_management">1.2. ObjectStore Management</a></li>
<li><a href="#_narayana_runtime_information">1.3. Narayana Runtime Information</a></li>
<li><a href="#_failure_recovery_administration">1.4. Failure Recovery Administration</a></li>
<li><a href="#_errors_and_exceptions">1.5. Errors and Exceptions</a></li>
</ul>
</li>
<li><a href="#_installation">2. Installation</a>
<ul class="sectlevel2">
<li><a href="#_preparing_your_system">2.1. Preparing Your System</a></li>
<li><a href="#_operating_system_services">2.2. Operating System Services</a></li>
<li><a href="#_logging">2.3. Logging</a></li>
<li><a href="#_additional_jar_requirements">2.4. Additional JAR Requirements</a></li>
<li><a href="#_chap_jbossjta_installation_guide_test_chapter">2.5. Setting Properties</a></li>
</ul>
</li>
<li><a href="#_upgrade">3. Upgrade</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_administration"><a class="anchor" href="#_administration"></a>1. Administration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction"><a class="anchor" href="#_introduction"></a>1.1. Introduction</h3>
<div class="paragraph">
<p>Apart from ensuring that the run-time system is executing normally, there is little continuous administration needed for the Narayana software.
Refer to <a href="#important_points_for_administrators">Important Points for Administrators</a> for some specific concerns.</p>
</div>
<div id="important_points_for_administrators" class="ulist">
<div class="title">Important Points for Administrators</div>
<ul>
<li>
<p>The present implementation of the Narayana system provides no security or protection for data.
The objects stored in the Narayana object store are (typically) owned by the user who ran the application that created them.
The Object Store and Object Manager facilities make no attempt to enforce even the limited form of protection that Unix/Windows provides.
There is no checking of user or group IDs on access to objects for either reading or writing.</p>
</li>
<li>
<p>Persistent objects created in the Object Store never go away unless the StateManager.destroy method is invoked on the object or some application program explicitly deletes them.
This means that the Object Store gradually accumulates garbage (especially during application development and testing phases).
At present we have no automated garbage collection facility.
Further, we have not addressed the problem of dangling references.
That is, a persistent object, <code>A</code>, may have stored a Uid for another persistent object, <code>B</code>, in its passive representation on disk.
There is nothing to prevent an application from deleting <code>B</code> even though <code>A</code> still contains a reference to it.
When <code>A</code> is next activated and attempts to access <code>B</code>, a run-time error will occur.</p>
</li>
<li>
<p>There is presently no support for version control of objects or database reconfiguration in the event of class structure changes.
This is a complex research area that we have not addressed.
At present, if you change the definition of a class of persistent objects, you are entirely responsible for ensuring that existing instances of the object in the Object Store are converted to the new representation.
The Narayana software can neither detect nor correct references to old object state by new operation versions or vice versa.</p>
</li>
<li>
<p>Object store management is critically important to the transaction service.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_objectstore_management"><a class="anchor" href="#_objectstore_management"></a>1.2. ObjectStore Management</h3>
<div class="paragraph">
<p>Within the transaction service installation, the object store is updated regularly whenever transactions are created, or when <em>Transactional Objects for Java</em> is used.
In a failure-free environment, the only object states which should reside within the object store are those representing objects created with the <em>Transactional Objects for Java</em> API.</p>
</div>
<div class="paragraph">
<p>However, if failures occur, transaction logs may remain in the object store until crash recovery facilities have resolved the transactions they represent.
As such it is very important that the contents of the object store are not deleted without due care and attention, as this will make it impossible to resolve in doubt transactions.
In addition, if multiple users share the same object store it is important that they realize this and do not simply delete the contents of the object store assuming it is an exclusive resource.</p>
</div>
</div>
<div class="sect2">
<h3 id="_narayana_runtime_information"><a class="anchor" href="#_narayana_runtime_information"></a>1.3. Narayana Runtime Information</h3>
<div class="paragraph">
<p>Compile-time configuration information is available via class <code>com.arjuna.common.util.ConfigurationInfo</code>.
Runtime configuration is embodied in the various <code>name EnvironmentBean</code> classes where name refers to the particular configuration category (see the configuration section of the user guide).
These beans have corresponding MBean interfaces and may be linked to JMX for remote inspection of the configuration if desired.</p>
</div>
</div>
<div class="sect2">
<h3 id="_failure_recovery_administration"><a class="anchor" href="#_failure_recovery_administration"></a>1.4. Failure Recovery Administration</h3>
<div class="paragraph">
<p>The failure recovery subsystem of Narayana will ensure that results of a transaction are applied consistently to all resources affected by the transaction, even if any of the application processes or the machine hosting them crash or lose network connectivity.
In the case of machine (system) crash or network failure, the recovery will not take place until the system or network are restored, but the original application does not need to be restarted.
Recovery responsibility is delegated to <a href="#recovery-manager">The Recovery Manager</a>.
Recovery after failure requires that information about the transaction and the resources involved survives the failure and is accessible afterward: this information is held in the <code>ActionStore</code>, which is part of the <code>ObjectStore</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <code>ObjectStore</code> is destroyed or modified, recovery may not be possible.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Until the recovery procedures are complete, resources affected by a transaction that was in progress at the time of the failure may be inaccessible.
For database resources, this may be reported as tables or rows held by “in-doubt transactions”.
For <em>TransactionalObjects for Java</em> resources, an attempt to activate the <code>Transactional Object</code> (as when trying to get a lock) will fail.</p>
</div>
<div class="sect3">
<h4 id="recovery-manager"><a class="anchor" href="#recovery-manager"></a>1.4.1. The Recovery Manager</h4>
<div class="paragraph">
<p>The failure recovery subsystem of Narayana requires that the stand-alone Recovery Manager process be running for each <code>ObjectStore</code> (typically one for each node on the network that is running Narayana applications).
The <code>RecoveryManager</code> file is located in the Narayana JAR file within the package <code>com.arjuna.ats.arjuna.recovery.RecoveryManager</code>.
To start the Recovery Manager issue the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>-test</code> flag is used with the Recovery Manager then it will display a <code>Ready</code> message when initialized, i.e.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.recovery.RecoveryManager -test</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_the_recovery_manager"><a class="anchor" href="#_configuring_the_recovery_manager"></a>1.4.2. Configuring the Recovery Manager</h4>
<div class="paragraph">
<p>The <code>RecoveryManager</code> reads the properties defined in the <code>jbossts-properties.xml</code> file.</p>
</div>
<div class="paragraph">
<p>A default version of <code>jbossts-properties.xml</code> is supplied with the distribution.
This can be used without modification, except possibly the debug tracing fields, as shown in <a href="#recovery_manager_output">Output</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="recovery_manager_output"><a class="anchor" href="#recovery_manager_output"></a>1.4.3. Output</h4>
<div class="paragraph">
<p>It is likely that installations will want to have some form of output from the <code>RecoveryManager</code>, to provide a record of what recovery activity has taken place.
<code>RecoveryManager</code> uses the logging mechanism provided by <em>jboss logging</em>, which provides a high level interface that hides differences that exist between existing logging APIs such Jakarta log4j or JDK logging API.</p>
</div>
<div class="paragraph">
<p>The configuration of <em>jboss logging</em> depends on the underlying logging framework that is used, which is determined by the availability and ordering of alternatives on the classpath.
Please, consult the <em>jboss logging</em> documentation for details.
Each log message has an associated log Level, that gives the importance and urgency of a log message.
The set of possible Log Levels, in order of least severity, and highest verbosity, is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>TRACE</code></p>
</li>
<li>
<p><code>DEBUG</code></p>
</li>
<li>
<p><code>INFO</code></p>
</li>
<li>
<p><code>WARN</code></p>
</li>
<li>
<p><code>ERROR</code></p>
</li>
<li>
<p><code>FATAL</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Messages describing the start and the periodical behavior made by the <code>RecoveryManager</code> are output using the <code>INFO</code> level.
If other debug tracing is wanted, the finer debug or trace levels should be set appropriately.</p>
</div>
<div class="paragraph">
<p>Setting the normal recovery messages to the <code>INFO</code> level allows the <code>RecoveryManager</code> to produce a moderate level of reporting.
If nothing is going on, it just reports the entry into each module for each periodic pass.
To disable <code>INFO</code> messages produced by the Recovery Manager, the logging level could be set to the higher level of <code>ERROR</code>, which means that the <code>RecoveryManager</code> will only produce <code>ERROR</code>, <code>WARNING</code>, or <code>FATAL</code> messages.</p>
</div>
</div>
<div class="sect3">
<h4 id="_periodic_recovery"><a class="anchor" href="#_periodic_recovery"></a>1.4.4. Periodic Recovery</h4>
<div class="paragraph">
<p>The <code>RecoveryManager</code> scans the <code>ObjectStore</code> and other locations of information, looking for transactions and resources that require, or may require recovery.
The scans and recovery processing are performed by recovery modules.
These recovery modules are instances of classes that implement the <code>com.arjuna.ats.arjuna.recovery.RecoveryModule</code> interface.
Each module has responsibility for a particular category of transaction or resource.
The set of recovery modules used is dynamically loaded, using properties found in the <code>RecoveryManager</code> property file.</p>
</div>
<div class="paragraph">
<p>The interface has two methods: <code>periodicWorkFirstPass</code> and <code>periodicWorkSecondPass</code>.
At an interval defined by property <code>com.arjuna.ats.arjuna.recovery.periodicRecoveryPeriod</code>, the <code>RecoveryManager</code> calls the first pass method on each property, then waits for a brief period, defined by property <code>com.arjuna.ats.arjuna.recovery.recoveryBackoffPeriod</code>.
Next, it calls the second pass of each module.
Typically, in the first pass, the module scans the relevant part of the <code>ObjectStore</code> to find transactions or resources that are in-doubt.
An in-doubt transaction may be part of the way through the commitment process, for instance.
On the second pass, if any of the same items are still in-doubt, the original application process may have crashed, and the item is a candidate for recovery.</p>
</div>
<div class="paragraph">
<p>An attempt by the <code>RecoveryManager</code> to recover a transaction that is still progressing in the original process is likely to break the consistency.
Accordingly, the recovery modules use a mechanism, implemented in the <code>com.arjuna.ats.arjuna.recovery.TransactionStatusManager</code> package, to check to see if the original process is still alive, and if the transaction is still in progress.
The <code>RecoveryManager</code> only proceeds with recovery if the original process has gone, or, if still alive, the transaction is completed.
If a server process or machine crashes, but the transaction-initiating process survives, the transaction completes, usually generating a warning.
Recovery of such a transaction is the responsibility of the <code>RecoveryManager</code>.</p>
</div>
<div class="paragraph">
<p>It is clearly important to set the interval periods appropriately.
The total iteration time will be the sum of the <code>periodicRecoveryPeriod</code> and <code>recoveryBackoffPeriod</code> properties, and the length of time it takes to scan the stores and to attempt recovery of any in-doubt transactions found, for all the recovery modules.
The recovery attempt time may include connection timeouts while trying to communicate with processes or machines that have crashed or are inaccessible.
There are mechanisms in the recovery system to avoid trying to recover the same transaction indefinitely.
The total iteration time affects how long a resource will remain inaccessible after a failure. – <code>periodicRecoveryPeriod</code> should be set accordingly.
Its default is 120 seconds.
The <code>recoveryBackoffPeriod</code> can be comparatively short, and defaults to 10 seconds.
Its purpose is mainly to reduce the number of transactions that are candidates for recovery and which thus require a call to the original process to see if they are still in progress.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In previous versions of Narayana, there was no contact mechanism, and the back-off period needed to be long enough to avoid catching transactions in flight at all.
From 3.0, there is no such risk.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Two recovery modules, implementations of the <code>com.arjuna.ats.arjuna.recovery.RecoveryModule</code> interface, are supplied with Narayana.
These modules support various aspects of transaction recovery, including JDBC recovery.
It is possible for advanced users to create their own recovery modules and register them with the Recovery Manager.
The recovery modules are registered with the <code>RecoveryManager</code> using <code>RecoveryEnvironmentBean.recoveryModuleClassNames</code>.
These will be invoked on each pass of the periodic recovery in the sort-order of the property names – it is thus possible to predict the ordering, but a failure in an application process might occur while a periodic recovery pass is in progress.
The default Recovery Extension settings are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.recoveryModuleClassNames</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    com.arjuna.ats.internal.arjuna.recovery.AtomicActionRecoveryModule
    com.arjuna.ats.internal.txoj.recovery.TORecoveryModule
    com.arjuna.ats.internal.jts.recovery.transactions.TopLevelTransactionRecoveryModule
    com.arjuna.ats.internal.jts.recovery.transactions.ServerTransactionRecoveryModule
    com.arjuna.ats.internal.jta.recovery.jts.XARecoveryModule
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_expired_entry_removal"><a class="anchor" href="#_expired_entry_removal"></a>1.4.5. Expired Entry Removal</h4>
<div class="paragraph">
<p>The operation of the recovery subsystem cause some entries to be made in the <code>ObjectStore</code> that are not removed in normal progress.
The <code>RecoveryManager</code> has a facility for scanning for these and removing items that are very old.
Scans and removals are performed by implementations of the <code>com.arjuna.ats.arjuna.recovery.ExpiryScanner</code> interface.
These implementations are loaded by giving the class names as the value of a property <code>RecoveryEnvironmentBean.expiryScannerClassNames</code>.
The <code>RecoveryManager</code> calls the <code>scan()</code> method on each loaded Expiry Scanner implementation at an interval determined by the property <code>RecoveryEnvironmentBean.expiryScanInterval</code>.
This value is given in hours, and defaults to 12hours.
An <code>expiryScanInterval</code> value of zero suppresses any expiry scanning.
If the value supplied is positive, the first scan is performed when <code>RecoveryManager</code> starts.
If the value is negative, the first scan is delayed until after the first interval, using the absolute value.</p>
</div>
<div class="paragraph">
<p>The kinds of item that are scanned for expiry are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">TransactionStatusManager items</dt>
<dd>
<p>One <code>TransactionStatusManager</code> item is created by every application process that uses Narayana.
It contains the information that allows the <code>RecoveryManager</code> to determine if the process that initiated the transaction is still alive, and its status.
The expiry time for these items is set by the property <code>com.arjuna.ats.arjuna.recovery.transactionStatusManagerExpiryTime</code>, expressed in hours.
The default is 12, and 0 (zero) means never to expire.The expiry time should be greater than the lifetime of any single processes using Narayana .</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The Expiry Scanner properties for these are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.expiryScannerClassNames</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    com.arjuna.ats.internal.arjuna.recovery.ExpiredTransactionStatusManagerScanner
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_errors_and_exceptions"><a class="anchor" href="#_errors_and_exceptions"></a>1.5. Errors and Exceptions</h3>
<div class="paragraph">
<p>This section covers the types and causes of errors and exceptions which may be thrown or reported during a transactional application.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<div class="title">Errors and Exceptions</div>
<dl>
<dt class="hdlist1"><code>NO_MEMORY</code></dt>
<dd>
<p>The application has run out of memory, and has thrown an <code>OutOfMemoryError</code> exception.
Narayana has attempted to do some cleanup, by running the garbage collector, before re-throwing the exception.
This is probably a transient problem and retrying the invocation should succeed.</p>
</dd>
<dt class="hdlist1"><code>com.arjuna.ats.arjuna.exceptions.FatalError</code></dt>
<dd>
<p>An error has occurred, and the error is of such severity that the transaction system must shut down.
Prior to this error being thrown the transaction service ensures that all running transactions have rolled back.
If an application catches this error, it should tidy up and exit.
If further work is attempted, application consistency may be violated.</p>
</dd>
<dt class="hdlist1"><code>com.arjuna.ats.arjuna.exceptions.ObjectStoreError</code></dt>
<dd>
<p>An error occurred while the transaction service attempted to use the object store.
Further forward progress is not possible.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>Object store warnings about access problems on states may occur during the normal execution of crash recovery.
This is the result of multiple concurrent attempts to perform recovery on the same transaction.
It can be safely ignored.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation"><a class="anchor" href="#_installation"></a>2. Installation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_preparing_your_system"><a class="anchor" href="#_preparing_your_system"></a>2.1. Preparing Your System</h3>
<div class="sect3">
<h4 id="_pre_installation_steps"><a class="anchor" href="#_pre_installation_steps"></a>2.1.1. Pre-Installation Steps</h4>
<div class="paragraph">
<p>Before installing the Narayana software, we recommend the following administrative steps be taken, assuming a default configuration for Narayana.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install the distribution into the required location.</p>
<div class="paragraph">
<p>Typically, the distribution is extracted from a <code>.ZIP</code> file.</p>
</div>
</li>
<li>
<p>Specify the Location for the Object Store</p>
<div class="paragraph">
<p>Narayana requires a minimum object store for storing the outcome of transactions in the event of system crashes.
The location of this should be specified in the properties file using the <code>ObjectStoreEnvironmentBean.objectStoreDir</code> key or by using environment variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java –DObjectStoreEnvironmentBean.objectStoreDir =C:\temp foo.</code></pre>
</div>
</div>
</li>
<li>
<p>Optional: Specify the sub-directory within the Object Store root.</p>
<div class="paragraph">
<p>By default, all object states will be stored within the <code>defaultStore</code> sub-directory of the object store root.
For instance, if the object store root is <code>/usr/local/Arjuna/TransactionService/ObjectStore</code>, the subdirectory <code>/usr/local/Arjuna/TransactionService/ObjectStore/defaultStore/</code> is used.</p>
</div>
<div class="paragraph">
<p>To change this subdirectory, set the <code>ObjectStoreEnvironmentBean.localOSRoot</code> or <code>com.arjuna.ats.arjuna.objectstore.localOSRoot</code> property variable accordingly.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_operating_system_services"><a class="anchor" href="#_operating_system_services"></a>2.2. Operating System Services</h3>
<div class="sect3">
<h4 id="_microsoft_windows_server"><a class="anchor" href="#_microsoft_windows_server"></a>2.2.1. Microsoft Windows Server</h4>
<div class="paragraph">
<p>Four scripts, located in the <code>Services\bin\windows</code> folder, install and uninstall the recovery manager and transaction server services.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<div class="title">Installation Scripts for Microsoft Windows</div>
<dl>
<dt class="hdlist1">Recovery Manager Service</dt>
<dd>
<p><code>InstallRecoveryManagerService-NT.bat</code></p>
</dd>
<dt class="hdlist1">Transaction Server</dt>
<dd>
<p><code>InstallTransactionServiceService-NT.bat</code></p>
</dd>
</dl>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<div class="title">Uninstallation Scripts for Microsoft Windows</div>
<dl>
<dt class="hdlist1">Recovery Manager Service</dt>
<dd>
<p><code>UninstallRecoveryManagerService-NT.bat</code></p>
</dd>
<dt class="hdlist1">Transaction Server</dt>
<dd>
<p><code>UninstallTransactionServerService-NT.bat</code></p>
</dd>
</dl>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Each of the scripts requires administrative privileges.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After running any of the scripts, a status message indicates success or failure.</p>
</div>
</div>
<div class="sect3">
<h4 id="_linux_unix"><a class="anchor" href="#_linux_unix"></a>2.2.2. Linux / UNIX</h4>
<div class="sect4">
<h5 id="_installing_services_in_linuxunix"><a class="anchor" href="#_installing_services_in_linuxunix"></a>Installing Services in Linux/UNIX:</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log into the system with <code>root</code> privileges.</p>
<div class="paragraph">
<p>The installer needs these privileges to create files in <code>/etc</code>.</p>
</div>
</li>
<li>
<p>Change to <code>JBOSS_HOME/services/installer</code> directory.</p>
<div class="paragraph">
<p><code>JBOSS_HOME</code> refers to the directory where you extracted Narayana.</p>
</div>
</li>
<li>
<p>Set the <code>JAVA_HOME</code> variable, if necessary.</p>
<div class="paragraph">
<p>Set the <code>JAVA_HOME</code> variable to the base directory of the JVM the service will use.
The <code>base directory</code> is the directory above <code>bin/java</code>.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Bash: <code>export JAVA_HOME="/opt/java"</code></p>
<div class="paragraph">
<p>CSH: <code>setenv JAVA_HOME="/opt/java"</code></p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Run the installer script.</p>
<div class="paragraph">
<p><code>./install_service.sh</code></p>
</div>
</li>
<li>
<p>The start-up and shut-down scripts are installed.</p>
<div class="paragraph">
<p>Information similar to the output below is displayed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Adding $JAVA_HOME (/opt/java) to $PATH in
/opt/arjuna/ats-3.2/services/bin/solaris/recoverymanagerservice.sh
Adding $JAVA_HOME (/opt/java) to $PATH in
/opt/arjuna/ats-3.2/services/bin/solaris/transactionserverservice.sh
Installing shutdown scripts into /etc/rcS.d:
K01recoverymanagerservice
K00transactionserverservice
Installing shutdown scripts into /etc/rc0.d:
K01recoverymanagerservice
K00transactionserverservice
Installing shutdown scripts into /etc/rc1.d:
K01recoverymanagerservice
K00transactionserverservice
Installing shutdown scripts into /etc/rc2.d:
K01recoverymanagerservice
K00transactionserverservice
Installing startup scripts into /etc/rc3.d:
S98recoverymanagerservice
S99transactionserverservice</code></pre>
</div>
</div>
<div class="paragraph">
<p>The start-up and shut-down scripts are installed for each run-level.
Depending on your specific operating system, you may need to explicitly enable the services for automatic start-up.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_uninstalling_services_in_linuxunix"><a class="anchor" href="#_uninstalling_services_in_linuxunix"></a>Uninstalling Services in Linux/UNIX</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log into the system with <code>root</code> privileges.</p>
<div class="paragraph">
<p>The installer needs these privileges to delete files in <code>/etc</code>.</p>
</div>
</li>
<li>
<p>Change to <code>JBOSS_HOME/services/installer</code> directory.</p>
<div class="paragraph">
<p><code>JBOSS_HOME</code> refers to the directory where you extracted Narayana.</p>
</div>
</li>
<li>
<p>Run the installation script with the <code>-u</code> option.</p>
<div class="paragraph">
<p><code>./install_services.sh -u</code></p>
</div>
</li>
<li>
<p>The start-up and shut-down scripts are removed.</p>
<div class="paragraph">
<p>Messages like the ones below indicate that the start-up and shut-down scripts have been removed successfully.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Removing startup scripts from /etc/rc3.d:
S98recoverymanagerservice
S99transactionserverservice
Removing shutdown scripts from /etc/rcS.d:
K01recoverymanagerservice
K00transactionserverservice
Removing shutdown scripts from /etc/rc0.d:
K01recoverymanagerservice
K00transactionserverservice
Removing shutdown scripts from /etc/rc1.d:
K01recoverymanagerservice
K00transactionserverservice
Removing shutdown scripts from /etc/rc2.d:
K01recoverymanagerservice
K00transactionserverservice</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logging"><a class="anchor" href="#_logging"></a>2.3. Logging</h3>
<div class="paragraph">
<p>The recovery manager and the transaction server services produce log files which are located in the <code>services/logs/</code> directory.
Two log files are created per service.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>&lt;service-name&gt;-service.log</code></dt>
<dd>
<p>Contains information regarding whether the service is stopped, started, restarted, or in another state.</p>
</dd>
<dt class="hdlist1"><code>&lt;service-name&gt;.log</code></dt>
<dd>
<p>Contains information logged from the actual service.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To configure what information is logged in these files, edit the appropriate LOG4J configuration files located in <code>services/config/</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_additional_jar_requirements"><a class="anchor" href="#_additional_jar_requirements"></a>2.4. Additional JAR Requirements</h3>
<div class="paragraph">
<p>To use all of the facilities available within Narayana, you need to add all of the JAR files contained in the <code>lib/</code> directory of the distribution to the <code>CLASSPATH</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_chap_jbossjta_installation_guide_test_chapter"><a class="anchor" href="#_chap_jbossjta_installation_guide_test_chapter"></a>2.5. Setting Properties</h3>
<div class="paragraph">
<p>Narayana has been designed to be highly configurable at runtime through the use of various property attributes.
Although these attributes can be provided at runtime on the command line, it may be more convenient to specify them through a single properties file or via <code>setter</code> methods on the beans.
At runtime, Narayana looks for the file <code>jbossts-properties.xml</code>, in a specific search order.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A location specified by a system property, allowing the normal search path to be overridden.</p>
</li>
<li>
<p>The directory from which the application was executed.</p>
</li>
<li>
<p>The home directory of the user that launched Narayana.</p>
</li>
<li>
<p><code>java.home</code></p>
</li>
<li>
<p>The <code>CLASSPATH</code>, which normally includes the installation&#8217;s <code>etc/</code> directory.</p>
</li>
<li>
<p>A default set of properties embedded in the <code>JAR</code> file.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Where properties are defined in both the system properties by using the <code>-D</code> switch, and in the properties file, the value from the system property takes precedence.
This facilitates overriding individual properties easily on the command line.</p>
</div>
<div class="paragraph">
<p>The properties file uses <code>java.uil.Properties</code> XML format, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CoordinatorEnvironmentBean.asyncCommit</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>NO<span class="tag">&lt;/entry&gt;</span>
<span class="tag">&lt;entyr</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ObjectStoreEnvironmentBean.objectStoreDir</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>/var/ObjectStore<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can override the name of the properties file at runtime by specifying a new file using the <code>com.arjuna.ats.arjuna.common.propertiesFile</code> attribute variable.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Unlike earlier releases, there is no longer one properties file name per module.
These properties file name key is now global for all Narayana components in the JVM.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upgrade"><a class="anchor" href="#_upgrade"></a>3. Upgrade</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To upgrade to the latest version of the Narayana software, replace all currently used Narayana jars with their latest versions.
However, before replacing the jars, ensure that all pending transactions are either completed or recovered.
It is essential that the Object Store is empty before transitioning to a newer version of Narayana.
This precaution is necessary because a newer version of Narayana may potentially break compatibility with older information stored in the Object Store, making that data unusable.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-09-27 14:39:50 +0100
</div>
</div>
</body>
</html>