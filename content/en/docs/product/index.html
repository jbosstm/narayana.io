<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Functionality of Narayana supported within Red Hat JBoss EAP</title>
<style>
@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";
@import "https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css";

h6 > .content > .title,h7,h8,h9 {
    font-family:"Open Sans","DejaVu Sans",sans-serif;
    font-weight:normal;
    font-size:.85em;
    font-style:normal;
    color:#ba8425;
    text-rendering:optimizeLegibility;
    margin-top:1em;
    margin-bottom:1em;
    line-height:2em
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Functionality of Narayana supported within Red Hat JBoss EAP</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_document_conventions">Document Conventions</a></li>
<li><a href="#_we_need_feedback">We Need Feedback!</a></li>
</ul>
</li>
<li><a href="#_transactions_overview">1. Transactions Overview</a>
<ul class="sectlevel2">
<li><a href="#_what_is_a_transaction">1.1. What is a transaction?</a></li>
<li><a href="#_the_coordinator">1.2. The Coordinator</a></li>
<li><a href="#_the_transaction_context">1.3. The Transaction Context</a></li>
<li><a href="#_participants">1.4. Participants</a></li>
<li><a href="#_commit_protocol">1.5. Commit protocol</a></li>
<li><a href="#_the_synchronization_protocol">1.6. The Synchronization Protocol</a></li>
<li><a href="#_optimizations_to_the_protocol">1.7. Optimizations to the Protocol</a></li>
<li><a href="#_non_atomic_transactions_and_heuristic_outcomes">1.8. Non-Atomic Transactions and Heuristic Outcomes</a></li>
<li><a href="#_interposition">1.9. Interposition</a></li>
<li><a href="#_a_new_transaction_protocol">1.10. A New Transaction Protocol</a></li>
</ul>
</li>
<li><a href="#_failure_recovery">2. Failure Recovery</a>
<ul class="sectlevel2">
<li><a href="#_architecture_of_the_recovery_manager">2.1. Architecture of the Recovery Manager</a></li>
<li><a href="#_how_narayana_manages_the_ots_recovery_protocol">2.2. How Narayana manages the OTS Recovery Protocol</a></li>
<li><a href="#_configuration_options">2.3. Configuration Options</a></li>
</ul>
</li>
<li><a href="#_development_guide">3. Development Guide</a>
<ul class="sectlevel2">
<li><a href="#_transactions">3.1. Transactions</a></li>
<li><a href="#_the_resource_manager">3.2. The Resource Manager</a></li>
<li><a href="#_general_transaction_issues">3.3. General Transaction Issues</a></li>
<li><a href="#_tools">3.4. Tools</a></li>
<li><a href="#_configuration_options_2">3.5. Configuration options</a></li>
<li><a href="#_important_log_messages">3.6. Important Log Messages</a></li>
<li><a href="#_troubleshooting">3.7. Troubleshooting</a></li>
</ul>
</li>
<li><a href="#_xts_guide">4. XTS Guide</a>
<ul class="sectlevel2">
<li><a href="#_introduction_2">4.1. Introduction</a></li>
<li><a href="#_getting_started">4.2. Getting Started</a></li>
<li><a href="#sec_xts_api">4.3. The XTS API</a></li>
<li><a href="#_stand_alone_coordination">4.4. Stand-Alone Coordination</a></li>
<li><a href="#_participant_crash_recovery">4.5. Participant Crash Recovery</a></li>
<li><a href="#_web_service_transaction_service_xts_management">4.6. Web Service Transaction Service (XTS) Management</a></li>
<li><a href="#_quickstarts_overview">4.7. Quickstarts Overview</a></li>
</ul>
</li>
<li><a href="#_txbridge">5. TXBridge Guide</a>
<ul class="sectlevel2">
<li><a href="#_introduction_4">5.1. Introduction</a></li>
<li><a href="#_transaction_bridge_architecture">5.2. Transaction <code>Bridge</code> Architecture</a></li>
<li><a href="#_using_the_transaction_bridge">5.3. Using the Transaction Bridge</a></li>
<li><a href="#_known_limitations">5.4. Known Limitations</a></li>
<li><a href="#_design_notes">5.5. Design Notes</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Copyright &#169; The Narayana Authors</p>
</div>
<div class="paragraph">
<p>SPDX short identifier: <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache-2.0</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Transactions Overview Guide contains information on how to use Narayana;
to develop applications that use transaction technology to manage business processes.
This document covers functionality that is available within both the Narayana community version and
is also available within the Red Hat JBoss EAP product.</p>
</div>
<div class="sect2">
<h3 id="_document_conventions"><a class="anchor" href="#_document_conventions"></a>Document Conventions</h3>
<div class="paragraph">
<p>This manual uses several conventions to highlight certain words and phrases and draw attention to specific pieces of information.</p>
</div>
<div class="paragraph">
<p>In PDF and paper editions, this manual uses typefaces drawn from the <a href="https://fedorahosted.org/liberation-fonts/">Liberation Fonts</a> set.
The Liberation Fonts set is also used in HTML editions if the set is installed on your system.
If not, alternative but equivalent typefaces are displayed.
Note: Red Hat Enterprise Linux 5 and later includes the Liberation Fonts set by default.</p>
</div>
<div class="sect3">
<h4 id="_typographic_conventions"><a class="anchor" href="#_typographic_conventions"></a>Typographic Conventions</h4>
<div class="paragraph">
<p>Four typographic conventions are used to call attention to specific words and phrases.
These conventions, and the circumstances they apply to, are as follows.</p>
</div>
<div class="paragraph">
<p><code>Mono-spaced Bold</code></p>
</div>
<div class="paragraph">
<p>Used to highlight system input, including shell commands, file names and paths.
Also used to highlight keycaps and key combinations.
For example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>To see the contents of the file <em>my_next_bestselling_novel</em> in your current working directory, enter the <code>cat my_next_bestselling_novel</code> command at the shell prompt and press <code>Enter</code> to execute the command.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The above includes a file name, a shell command and a keycap, all presented in mono-spaced bold and all distinguishable thanks to context.</p>
</div>
<div class="paragraph">
<p>Key combinations can be distinguished from keycaps by the hyphen connecting each part of a key combination.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Press `Enter` to execute the command.

Press
// &lt;keycombo&gt;
//   &lt;keycap&gt;Ctrl&lt;/keycap&gt;
//   &lt;keycap&gt;Alt&lt;/keycap&gt;
//   &lt;keycap&gt;F2&lt;/keycap&gt;
// &lt;/keycombo&gt;
 to switch to the first virtual terminal.
Press
// &lt;keycombo&gt;
//   &lt;keycap&gt;Ctrl&lt;/keycap&gt;
//   &lt;keycap&gt;Alt&lt;/keycap&gt;
//   &lt;keycap&gt;F1&lt;/keycap&gt;
// &lt;/keycombo&gt;
 to return to your X-Windows session.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first paragraph highlights the particular keycap to press.
The second highlights two key combinations (each a set of three keycaps with each set pressed simultaneously).</p>
</div>
<div class="paragraph">
<p>If source code is discussed, class names, methods, functions, variable names and returned values mentioned within a paragraph will be presented as above, in <code>mono-spaced bold</code>.
For example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>File-related classes include <code>filesystem</code> for file systems, <code>file</code> for files, and <code>dir</code> for directories.
Each class has its own associated set of permissions.</p>
</div>
</div>
</div>
<div class="paragraph">
<p><code>Proportional Bold</code></p>
</div>
<div class="paragraph">
<p>This denotes words or phrases encountered on a system, including application names; dialog box text; labeled buttons; check-box and radio button labels; menu titles and sub-menu titles.
For example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Choose <code>Preferences &gt; Mouse</code> from the main menu bar to launch <code>Mouse Preferences</code>.
In the <code>Buttons tab</code>, click the <code>Left-handed mouse</code> check box and click <code>Close</code> to switch the primary mouse button from the left to the right (making the mouse suitable for use in the left hand).</p>
</div>
<div class="paragraph">
<p>To insert a special character into a <code>gedit</code> file, choose <code>Accessories &gt; Character Map</code> from the main menu bar.
Next, choose <code>Find</code> from the <code>Character Map</code> menu bar, type the name of the character in the <code>Search</code> field and click <code>Next</code>.
The character you sought will be highlighted in the <code>Character Table</code>.
Double-click this highlighted character to place it in the <code>Text to copy</code> field and then click the <code>Copy</code> button.
Now switch back to your document and choose <code>Paste</code> from the <code>gedit</code> menu bar.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The above text includes application names; system-wide menu names and items; application-specific menu names; and buttons and text found within a GUI interface, all presented in proportional bold and all distinguishable by context.</p>
</div>
<div class="paragraph">
<p><code>Mono-spaced Bold Italic</code> or <code>Proportional Bold Italic</code></p>
</div>
<div class="paragraph">
<p>Whether mono-spaced bold or proportional bold, the addition of italics indicates replaceable or variable text.
Italics denotes text you do not input literally or displayed text that changes depending on circumstance.
For example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>To connect to a remote machine using ssh, type <code>ssh <a href="mailto:username@domain.name">username@domain.name</a></code> at a shell prompt.
If the remote machine is <em>example.com</em> and your username on that machine is john, type <code>ssh <a href="mailto:john@example.com">john@example.com</a></code>.</p>
</div>
<div class="paragraph">
<p>The <code>mount -o remount file-system</code> command remounts the named file system.
For example, to remount the <code>/home file system</code>, the command is <code>mount -o remount /home</code>.</p>
</div>
<div class="paragraph">
<p>To see the version of a currently installed package, use the <code>rpm -q package</code> command.
It will return a result as follows: <code>package-version-release</code>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Note the words in bold italics above -username, domain.name, file-system, package, version and release.
Each word is a placeholder, either for text you enter when issuing a command or for text displayed by the system.</p>
</div>
<div class="paragraph">
<p>Aside from standard usage for presenting the title of a work, italics denotes the first use of a new and important term.
For example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>This documentation uses <em>Asciidoc</em>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pull_quote_conventions"><a class="anchor" href="#_pull_quote_conventions"></a>Pull-quote Conventions</h4>
<div class="paragraph">
<p>Terminal output and source code listings are set off visually from the surrounding text.</p>
</div>
<div class="paragraph">
<p>Output sent to a terminal is set in <code>mono-spaced roman</code> and presented thus:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>books        Desktop   documentation  drafts  mss    photos   stuff  svn
books_tests  Desktop1  downloads      images  notes  scripts  svgs</pre>
</div>
</div>
<div class="paragraph">
<p>Source-code listings are also set in <code>mono-spaced roman</code> but add syntax highlighting as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.jboss.book.jca.ex1</span>;

<span class="keyword">import</span> <span class="include">javax.naming.InitialContext</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">ExClient</span> {
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span> args<span class="type">[]</span>) <span class="directive">throws</span> <span class="exception">Exception</span> {
       <span class="predefined-type">InitialContext</span> iniCtx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>();
       <span class="predefined-type">Object</span>         ref    = iniCtx.lookup(<span class="string"><span class="delimiter">&quot;</span><span class="content">EchoBean</span><span class="delimiter">&quot;</span></span>);
       EchoHome       home   = (EchoHome) ref;
       Echo           echo   = home.create();

       <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Created Echo</span><span class="delimiter">&quot;</span></span>);

       <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Echo.echo('Hello') = </span><span class="delimiter">&quot;</span></span> + echo.echo(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello</span><span class="delimiter">&quot;</span></span>));
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notes_and_warnings"><a class="anchor" href="#_notes_and_warnings"></a>Notes and Warnings</h4>
<div class="paragraph">
<p>Finally, we use three visual styles to draw attention to information that might otherwise be overlooked.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Note</div>
<div class="paragraph">
<p>Notes are tips, shortcuts or alternative approaches to the task at hand.
Ignoring a note should have no negative consequences, but you might miss out on a trick that makes your life easier.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Important</div>
<div class="paragraph">
<p>Important boxes detail things that are easily missed: configuration changes that only apply to the current session, or services that need restarting before an update will apply.
Ignoring a box labeled 'Important' will not cause data loss but may cause irritation and frustration.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Warning</div>
<div class="paragraph">
<p>Warnings should not be ignored.
Ignoring warnings will most likely cause data loss.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_we_need_feedback"><a class="anchor" href="#_we_need_feedback"></a>We Need Feedback!</h3>
<div class="paragraph">
<p>Please feel free to raise any issues you find with this document in our <a href="https://issues.redhat.com/browse/JBTM">issue tracking system</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transactions_overview"><a class="anchor" href="#_transactions_overview"></a>1. Transactions Overview</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_is_a_transaction"><a class="anchor" href="#_what_is_a_transaction"></a>1.1. What is a transaction?</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This chapter deals with the theory of transactional services.
If you are familiar with these principles, consider this chapter a reference.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consider the following situation: a user wishes to purchase access to an on-line newspaper and requires to pay for this access from an account maintained by an on-line bank.
Once the newspaper site has received the user&#8217;s credit from the bank, they will deliver an electronic token to the user granting access to their site.
Ideally the user would like the debiting of the account, and delivery of the token to be "all or nothing" (atomic).
However, hardware and software failures could prevent either event from occurring, and leave the system in an indeterminate state.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Atomic transactions (transactions) possess an "all-or-nothing" property, and are a well-known technique for guaranteeing application consistency in the presence of failures.
Transactions possess the following ACID properties:</p>
</li>
<li>
<p>Atomicity: The transaction completes successfully (commits) or if it fails (aborts) all of its effects are undone (rolled back).</p>
</li>
<li>
<p>Consistency: Transactions produce consistent results and preserve application specific invariants.</p>
</li>
<li>
<p>Isolation: Intermediate states produced while a transaction is executing are not visible to others.
Furthermore transactions appear to execute serially, even if they are actually executed concurrently.</p>
</li>
<li>
<p>Durability: The effects of a committed transaction are never lost (except by a catastrophic failure).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A transaction can be terminated in two ways: committed or aborted (rolled back).
When a transaction is committed, all changes made within it are made durable (forced on to stable storage, e.g., disk).
When a transaction is aborted, all of the changes are undone.
Atomic actions can also be nested; the effects of a nested action are provisional upon the <code>commit</code>/<code>abort</code> of the outermost (top-level) atomic action.</p>
</div>
<div class="paragraph">
<p>Transactions have emerged as the dominant paradigm for coordinating interactions between parties in a (distributed) system, and in particular to manage applications that require concurrent access to shared data.
A classic transaction is a unit of work that either completely succeeds, or fails with all partially completed work being undone.
When a transaction is committed, all changes made by the associated requests are made durable, normally by committing the results of the work to a database.
If a transaction should fail and is rolled back, all changes made by the associated work are undone.
Transactions in distributed systems typically require the use of a transaction manager that is responsible for coordinating all of the participants that are part of the transaction.</p>
</div>
<div class="ulist">
<div class="title">The main components involved in using and defining transactional applications are:</div>
<ul>
<li>
<p>A Transaction Service: The Transaction Service captures the model of the underlying transaction protocol and coordinates parties affiliated with the transaction according to that model.</p>
</li>
<li>
<p>A Transaction API: Provides an interface for transaction demarcation and the registration of participants.</p>
</li>
<li>
<p>A Participant: The entity that cooperates with the transaction service on behalf of its associated business logic.</p>
</li>
<li>
<p>The Context: Captures the necessary details of the transaction such that participants can enlist within its scope.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_the_coordinator"><a class="anchor" href="#_the_coordinator"></a>1.2. The Coordinator</h3>
<div class="paragraph">
<p>Associated with every transaction is a coordinator, which is responsible for governing the outcome of the transaction.
The coordinator may be implemented as a separate service or may be co-located with the user for improved performance.
Each coordinator is created by the transaction manager service, which is in effect a factory for those coordinators.</p>
</div>
<div class="paragraph">
<p>A coordinator communicates with enrolled participants to inform them of the desired termination requirements, i.e., whether they should accept (e.g., confirm) or reject (e.g., cancel) the work done within the scope of the given transaction.
For example, whether to purchase the (provisionally reserved) flight tickets for the user or to release them.
An application/client may wish to terminate a transaction in a number of different ways (e.g., confirm or cancel).
However, although the coordinator will attempt to terminate in a manner consistent with that desired by the client, it is ultimately the interactions between the coordinator and the participants that will determine the actual final outcome.</p>
</div>
<div class="paragraph">
<p>A transaction manager is typically responsible for managing coordinators for many transactions.
The initiator of the transaction (e.g., the client) communicates with a transaction manager and asks it to start a new transaction and associate a coordinator with the transaction.
Once created, the context can be propagated to Web services in order for them to associate their work with the transaction.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_transaction_context"><a class="anchor" href="#_the_transaction_context"></a>1.3. The Transaction Context</h3>
<div class="paragraph">
<p>In order for a transaction to span a number of services, certain information has to be shared between those services in order to propagate information about the transaction.
This information is known as the Context.
The context is often automatically propagated and processed by transaction-aware components of an application:</p>
</div>
<div class="dlist">
<div class="title">Contents of a Context</div>
<dl>
<dt class="hdlist1">Transaction Identifier</dt>
<dd>
<p>Guarantees global uniqueness for an individual transaction.</p>
</dd>
<dt class="hdlist1">Transaction Coordinator Location</dt>
<dd>
<p>The endpoint address participants contact to enroll.</p>
</dd>
</dl>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/transactions-overview-fig-web-services-context-flow.png" alt="transactions overview fig web services context flow">
</div>
<div class="title">Figure 1. Context Flow</div>
</div>
</div>
<div class="sect2">
<h3 id="_participants"><a class="anchor" href="#_participants"></a>1.4. Participants</h3>
<div class="paragraph">
<p>The coordinator cannot know the details of how every transactional service is implemented; in fact it is not necessary for it to do so in order to negotiate a transactional outcome.
It treats each service taking part in a transaction as a participant and communicates with it according to some predefined participant coordination models appropriate to the type of transaction.
When a service begins performing work within the scope of a transaction it enrolls itself with the coordinator as a participant, specifying the participant model it wishes to follow.
So, the term participant merely refers a transactional service enrolled in a specific transaction using a specific participant model.</p>
</div>
</div>
<div class="sect2">
<h3 id="_commit_protocol"><a class="anchor" href="#_commit_protocol"></a>1.5. Commit protocol</h3>
<div class="paragraph">
<p>A two-phase commit protocol is required to guarantee that all of the action participants either <code>commit</code> or <code>abort</code> any changes made.
See <a href="#two_phase_commit_overview">Two-Phase <code>Commit</code> Overview</a> which illustrates the main aspects of the commit protocol: during phase 1, the action coordinator, C, attempts to communicate with all of the action participants, A and B, to determine whether they will <code>commit</code> or <code>abort</code>.
An <code>abort</code> reply from any participant acts as a veto, causing the entire action to <code>abort</code>.
Based upon these (lack of) responses, the coordinator arrives at the decision of whether to <code>commit</code> or <code>abort</code> the action.
If the action will <code>commit</code>, the coordinator records this decision on stable storage, and the protocol enters phase 2, where the coordinator forces the participants to carry out the decision.
The coordinator also informs the participants if the action aborts.</p>
</div>
<div class="paragraph">
<p>When each participant receives the coordinator&#8217;s phase 1 message, they record sufficient information on stable storage to either <code>commit</code> or <code>abort</code> changes made during the action.
After returning the phase 1 response, each participant who returned a <code>commit</code> response must remain blocked until it has received the coordinator&#8217;s phase 2 message.
Until they receive this message, these resources are unavailable for use by other actions.
If the coordinator fails before delivery of this message, these resources remain blocked.
However, if crashed machines eventually recover, crash recovery mechanisms can be employed to unblock the protocol and terminate the action.</p>
</div>
<div id="two_phase_commit_overview" class="imageblock text-center">
<div class="content">
<img src="images/transactions-overview-fig-two-phase-commit-overview.png" alt="transactions overview fig two phase commit overview">
</div>
<div class="title">Figure 2. Two-Phase <code>Commit</code> Overview</div>
</div>
<div class="ulist">
<ul>
<li>
<p>A transaction is started, and some work is performed.</p>
</li>
<li>
<p>Once the work is finished, the two-phase commit begins.</p>
</li>
<li>
<p>The coordinator (transaction manager) of the transaction asks each resource taking part in the transaction whether it is prepared to commit.</p>
</li>
<li>
<p>If all resources respond positively, the coordinator instructs the resources to make all work performed durable (usually committed to a database).</p>
</li>
<li>
<p>If not, all work performed is rolled back (undone) such that the underlying data structures are in their original states.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>During two-phase commit transactions, coordinators and resources keep track of activity in non-volatile data stores so that they can recover in the case of a failure.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_the_synchronization_protocol"><a class="anchor" href="#_the_synchronization_protocol"></a>1.6. The Synchronization Protocol</h3>
<div class="paragraph">
<p>Besides the two-phase commit protocol, traditional transaction processing systems employ an additional protocol, often referred to as the <em>synchronization protocol</em>.
With the original ACID properties, Durability is important when state changes need to be available despite failures.
Applications interact with a persistence store of some kind, such as a database, and this interaction can impose a significant overhead, because disk access is much slower to access than main computer memory.</p>
</div>
<div class="paragraph">
<p>One solution to the problem disk access time is to cache the state in main memory and only operate on the cache for the duration of a transaction.
Unfortunately, this solution needs a way to flush the state back to the persistent store before the transaction terminates, or risk losing the full ACID properties.
This is what the synchronization protocol does, with <em>Synchronization Participants</em>.</p>
</div>
<div class="paragraph">
<p>Synchronizations are informed that a transaction is about to <code>commit</code>.
At that point, they can flush cached state, which might be used to improve performance of an application, to a durable representation prior to the transaction committing.
The synchronizations are then informed about when the transaction completes and its completion state.</p>
</div>
<div class="paragraph">
<div class="title">Procedure: The "Four Phase Protocol" Created By Synchronizations</div>
<p>Synchronizations essentially turn the two-phase commit protocol into a four-phase protocol:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Step 1</p>
<div class="paragraph">
<p>Before the transaction starts the two-phase commit, all registered Synchronizations are informed.
Any failure at this point will cause the transaction to <code>roll back</code>.</p>
</div>
</li>
<li>
<p>Step 2 and 3</p>
<div class="paragraph">
<p>The coordinator then conducts the normal two-phase commit protocol.</p>
</div>
</li>
<li>
<p>Step 4</p>
<div class="paragraph">
<p>Once the transaction has terminated, all registered Synchronizations are informed.
However, this is a courtesy invocation because any failures at this stage are ignored: the transaction has terminated so there&#8217;s nothing to affect.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The synchronization protocol does not have the same failure requirements as the traditional two-phase commit protocol.
For example, Synchronization participants do not need the ability to recover in the event of failures, because any failure before the two-phase commit protocol completes cause the transaction to <code>roll back</code>, and failures after it completes have no effect on the data which the Synchronization participants are responsible for.</p>
</div>
</div>
<div class="sect2">
<h3 id="_optimizations_to_the_protocol"><a class="anchor" href="#_optimizations_to_the_protocol"></a>1.7. Optimizations to the Protocol</h3>
<div class="paragraph">
<p>There are several variants to the standard two-phase commit protocol that are worth knowing about, because they can have an impact on performance and failure recovery.
<a href="#two_phase_variants">Variants to the Two-Phase Commit Protocol</a> gives more information about each one.</p>
</div>
<table id="two_phase_variants" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Variants to the Two-Phase Commit Protocol</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variant</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Presumed Abort</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If a transaction is going to <code>roll back</code>, the coordinator may record this information locally and tell all enlisted participants.
Failure to contact a participant has no effect on the transaction outcome.
The coordinator is informing participants only as a courtesy.
Once all participants have been contacted, the information about the transaction can be removed.
If a subsequent request for the status of the transaction occurs, no information will be available and the requester can assume that the transaction has aborted.
This optimization has the benefit that no information about participants need be made persistent until the transaction has progressed to the end of the <code>prepare</code> phase and decided to <code>commit</code>, since any failure prior to this point is assumed to be an <code>abort</code> of the transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">One-Phase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If only a single participant is involved in the transaction, the coordinator does not need to drive it through the <code>prepare</code> phase.
Thus, the participant is told to <code>commit</code>, and the coordinator does not need to record information about the decision, since the outcome of the transaction is the responsibility of the participant.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-Only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When a participant is asked to <code>prepare</code>, it can indicate to the coordinator that no information or data that it controls has been modified during the transaction.
Such a participant does not need to be informed about the outcome of the transaction since the fate of the participant has no affect on the transaction.
Therefore, a read-only participant can be omitted from the second phase of the commit protocol.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_non_atomic_transactions_and_heuristic_outcomes"><a class="anchor" href="#_non_atomic_transactions_and_heuristic_outcomes"></a>1.8. Non-Atomic Transactions and Heuristic Outcomes</h3>
<div class="paragraph">
<p>In order to guarantee atomicity, the two-phase commit protocol is <code>blocking</code>.
As a result of failures, participants may remain blocked for an indefinite period of time, even if failure recovery mechanisms exist.
Some applications and participants cannot tolerate this blocking.</p>
</div>
<div class="paragraph">
<p>To break this blocking nature, participants that are past the <code>prepare</code> phase are allowed to make autonomous decisions about whether to <code>commit</code> or <code>rollback</code>.
Such a participant must record its decision, so that it can complete the original transaction if it eventually gets a request to do so.
If the coordinator eventually informs the participant of the transaction outcome, and it is the same as the choice the participant made, no conflict exists.
If the decisions of the participant and coordinator are different, the situation is referred to as a non-atomic outcome, and more specifically as a <em>heuristic outcome</em>.</p>
</div>
<div class="paragraph">
<p>Resolving and reporting heuristic outcomes to the application is usually the domain of complex, manually driven system administration tools, because attempting an automatic resolution requires semantic information about the nature of participants involved in the transactions.</p>
</div>
<div class="paragraph">
<p>Precisely when a participant makes a heuristic decision depends on the specific implementation.
Likewise, the choice the participant makes about whether to <code>commit</code> or to <code>roll back</code> depends upon the implementation, and possibly the application and the environment in which it finds itself.
The possible heuristic outcomes are discussed in <a href="#tbl_heuristic_outcomes">Heuristic Outcomes</a> .</p>
</div>
<table id="tbl_heuristic_outcomes" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Heuristic Outcomes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Outcome</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heuristic Rollback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>commit</code> operation was not able to <code>commit</code> the resources but all of the participants were able to be rolled back and so an atomic outcome was still achieved.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heuristic Commit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An attempted <code>rollback</code> operation failed because all of the participants unilaterally committed.
One situation where this might happen is if the coordinator is able to successfully <code>prepare</code> the transaction, but then decides to roll it back because its transaction log could not be updated.
While the coordinator is making its decision, the participants decides to <code>commit</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heuristic Mixed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Some participants committed, while others were rolled back.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heuristic Hazard</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The disposition of some of the updates is unknown.
For those which are known, they have either all been committed or all rolled back.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Heuristic decisions should be used with care and only in exceptional circumstances, since the decision may possibly differ from that determined by the transaction service.
This type of difference can lead to a loss of integrity in the system.
Try to avoid needing to perform resolution of heuristics, either by working with services and participants that do not cause heuristics, or by using a transaction service that provides assistance in the resolution process.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interposition"><a class="anchor" href="#_interposition"></a>1.9. Interposition</h3>
<div class="paragraph">
<p><em>Interposition</em> is a scoping mechanism which allows coordination of a transaction to be delegated across a hierarchy of coordinators.
See <a href="#fig_interpositions">Interpositions</a> for a graphical representation of this concept.</p>
</div>
<div id="fig_interpositions" class="imageblock text-center">
<div class="content">
<img src="images/transactions-overview-fig-interpositions.png" alt="transactions overview fig interpositions">
</div>
<div class="title">Figure 3. Interpositions</div>
</div>
<div class="paragraph">
<p>Interposition is particularly useful for Web Services transactions, as a way of limiting the amount of network traffic required for coordination.
For example, if communications between the top-level coordinator and a web service are slow because of network traffic or distance, the web service might benefit from executing in a subordinate transaction which employs a local coordinator service.
In <a href="#fig_interpositions">Interpositions</a> ,to <code>prepare</code>, the top-level coordinator only needs to send one <code>prepare</code> message to the subordinate coordinator, and receive one <code>prepared</code> or <code>aborted</code> reply.
The subordinate coordinator forwards a <code>prepare</code> locally to each participant and combines the results to decide whether to send a single <code>prepared</code> or <code>aborted</code> reply.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_new_transaction_protocol"><a class="anchor" href="#_a_new_transaction_protocol"></a>1.10. A New Transaction Protocol</h3>
<div class="paragraph">
<p>Many component technologies offer mechanisms for coordinating ACID transactions based on two-phase <code>commit</code> semantics.
Some of these are CORBA/OTS, JTS/JTA, and MTS/MSDTC.
ACID transactions are not suitable for all Web Services transactions, as explained in <a href="#acid_not_suitable">Reasons ACID is Not Suitable for Web Services</a>.</p>
</div>
<div id="acid_not_suitable" class="ulist">
<div class="title">Reasons ACID is Not Suitable for Web Services</div>
<ul>
<li>
<p>Classic ACID transactions assume that an organization that develops and deploys applications owns the entire infrastructure for the applications.
This infrastructure has traditionally taken the form of an Intranet.
Ownership implies that transactions operate in a trusted and predictable manner.
To assure ACIDity, potentially long-lived locks can be kept on underlying data structures during two-phase <code>commit</code>.
Resources can be used for any period of time and released when the transaction is complete.</p>
<div class="paragraph">
<p>In Web Services, these assumptions are no longer valid.
One obvious reason is that the owners of data exposed through a Web service refuse to allow their data to be locked for extended periods, since allowing such locks invites denial-of-service attacks.</p>
</div>
</li>
<li>
<p>All application infrastructures are generally owned by a single party.
Systems using classical ACID transactions normally assume that participants in a transaction will obey the directives of the transaction manager and only infrequently make unilateral decisions which harm other participants in a transaction.</p>
<div class="paragraph">
<p>Web Services participating in a transaction can effectively decide to resign from the transaction at any time, and the consumer of the service generally has little in the way of quality of service guarantees to prevent this.</p>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_addressing_the_problems_of_transactioning_in_loosely_coupled_systems"><a class="anchor" href="#_addressing_the_problems_of_transactioning_in_loosely_coupled_systems"></a>1.10.1. Addressing the Problems of Transactioning in Loosely Coupled Systems</h4>
<div class="paragraph">
<p>Though extended transaction models which relax the ACID properties have been proposed over the years, standards such as OASIS WS-TX provide a new transaction protocol to implement these concepts for the Web services architecture.
The are designed to accommodate four underlying requirements inherent in any loosely coupled architecture like Web services:.</p>
</div>
<div class="ulist">
<div class="title">Requirements of Web Services</div>
<ul>
<li>
<p>Ability to handle multiple successful outcomes to a transaction, and to involve operations whose effects may not be isolated or durable.</p>
</li>
<li>
<p>Coordination of autonomous parties whose relationships are governed by contracts, rather than the dictates of a central design authority.</p>
</li>
<li>
<p>Discontinuous service, where parties are expected to suffer outages during their lifetimes, and coordinated work must be able to survive such outages.</p>
</li>
<li>
<p>Interoperation using XML over multiple communication protocols.
XTS uses SOAP encoding carried over HTTP.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_failure_recovery"><a class="anchor" href="#_failure_recovery"></a>2. Failure Recovery</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_architecture_of_the_recovery_manager"><a class="anchor" href="#_architecture_of_the_recovery_manager"></a>2.1. Architecture of the Recovery Manager</h3>
<div class="sect3">
<h4 id="_crash_recovery_overview"><a class="anchor" href="#_crash_recovery_overview"></a>2.1.1. Crash Recovery Overview</h4>
<div class="paragraph">
<p>The main architectural components within Crash Recovery are illustrated in the diagram below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/failure-recovery-fig1-crashrecoveryarchitecture.png" alt="failure recovery fig1 crashrecoveryarchitecture">
</div>
<div class="title">Figure 4. Recovery Manager Architecture</div>
</div>
<div class="paragraph">
<p>The Recovery Manager is a daemon process responsible for performing crash recovery.
Only one Recovery Manager runs per node.
The Object Store provides persistent data storage for transactions to log data.
During normal transaction processing each transaction will log persistent data needed for the commit phase to the Object Store.
On successfully committing a transaction this data is removed, however if the transaction fails then this data remains within the Object Store.</p>
</div>
<div class="paragraph">
<p>The Recovery Manager functions by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Periodically scanning the Object Store for transactions that may have failed.
Failed transactions are indicated by the presence of log data after a period of time that the transaction would have normally been expected to finish.</p>
</li>
<li>
<p>Checking with the application process which originated the transaction whether the transaction is still in progress or not.</p>
</li>
<li>
<p>Recovering the transaction by re-activating the transaction and then replaying phase two of the commit protocol.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following sections describe the architectural components in more detail.</p>
</div>
</div>
<div class="sect3">
<h4 id="_recovery_manager"><a class="anchor" href="#_recovery_manager"></a>2.1.2. Recovery Manager</h4>
<div class="paragraph">
<p>On initialisation, the Recovery Manager first loads in configuration information via a properties file.
This configuration includes a number of recovery activators and recovery modules, which are then dynamically loaded.</p>
</div>
<div class="paragraph">
<p>The Recovery Manager is not specifically tied to an Object Request Broker or ORB.
Hence, the OTS recovery protocol is not implicitly enabled.
To enable such protocol, we use the concept of recovery activator, defined with the interface <code>RecoveryActivator</code>, which is used to instantiate a recovery class related to the underlying communication protocol.
For instance, when used with OTS, the <code>RecoveryActivitor</code> has the responsibility to create a <code>RecoveryCoordinator</code> object able to respond to the <code>replay_completion</code> operation.</p>
</div>
<div class="paragraph">
<p>All <code>RecoveryActivator</code> instances inherit the same interface.
They are loaded via the following recovery extension property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.recoveryActivators</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    list_of_class_names
<span class="tag">&lt;entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For instance the <code>RecoveryActivator</code> provided in the distribution of JTS/OTS, which shall not be commented, is as follow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.recoveryActivators</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    com.arjuna.ats.internal.jts.orbspecific.recovery.RecoveryEnablement
<span class="tag">&lt;entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When loaded all <code>RecoveryActivator</code> instances provide the method startRCservice invoked by the Recovery Manager and used to create the appropriate Recovery Component able to receive recovery requests according to a particular transaction protocol.
For instance the <code>RecoveryCoordinator</code> defined by the OTS protocol.</p>
</div>
<div class="paragraph">
<p>Each recovery module is used to recover a different type of transaction/resource, however each recovery module inherits the same basic behavior.</p>
</div>
<div class="paragraph">
<p>Recovery consists of two separate passes/phases separated by two timeout periods.
The first pass examines the object store for potentially failed transactions; the second pass performs crash recovery on failed transactions.
The timeout between the first and second pass is known as the backoff period.
The timeout between the end of the second pass and the start of the first pass is the recovery period.
The recovery period is larger than the backoff period.</p>
</div>
<div class="paragraph">
<p>The Recovery Manager invokes the first pass upon each recovery module, applies the backoff period timeout, invokes the second pass upon each recovery module and finally applies the recovery period timeout before restarting the first pass again.</p>
</div>
<div class="paragraph">
<p>The recovery modules are loaded via the following recovery extension property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.recoveryExtenstions</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    list_of_class_names
<span class="tag">&lt;entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The backoff period and recovery period are set using the following properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.recoveryBackoffPeriod</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.periodicRecoveryPeriod</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following java classes are used to implement the Recovery Manager:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>package <code>com.arjuna.ats.arjuna.recovery</code>:</p>
<div class="paragraph">
<p><code>RecoveryManager</code>  The daemon process that starts up by instantiating an instance of the <code>RecoveryManagerImple</code> class.</p>
</div>
<div class="paragraph">
<p><code>RecoveryEnvironment</code> - Properties used by the recovery manager.</p>
</div>
<div class="paragraph">
<p><code>RecoveryConfiguration</code> - Specifies the name of the Recovery Manager property file.(ie <code>RecoveryManager-properties.xml</code>)</p>
</div>
</li>
<li>
<p>package <code>com.arjuna.ats.internal.ts.arjuna.recovery</code>:</p>
<div class="paragraph">
<p><code>RecoveryManagerImple</code> - Creates and starts instances of the <code>RecActivatorLoader</code>, the <code>PeriodicRecovery</code> thread and the <code>ExpiryEntryMonitor</code> thread.</p>
</div>
<div class="paragraph">
<p><code>RecActivatorLoader</code> - Dynamically loads in the <code>RecoveryActivator</code> specified in the Recovery Manager property file.
Each <code>RecoveryActicator</code> is specified as a recovery extension in the properties file</p>
</div>
<div class="paragraph">
<p><code>PeriodicRecovery</code> - Thread which loads each recovery module, then calls the first pass method for each module, applies the backoff period timeout, calls the second pass method for each module and applies the recovery period timeout.</p>
</div>
<div class="paragraph">
<p><code>RecoveryClassLoader</code> - Dynamically loads in the recovery modules specified in the Recovery Manager property file.
Each module is specified as a recovery extension in the properties file (e.g., <code>com.arjuna.ats.arjuna.recovery.recoveryExtension1=com.arjuna.ats.internal.ts.arjuna.recovery.AtomicActionRecoveryModule</code>).</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, the recovery manager listens on the first available port on a given machine.
If you wish to control the port number that it uses, you can specify this using the <code>com.arjuna.ats.arjuna.recovery.recoveryPort</code> attribute.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_managing_recovery_directly"><a class="anchor" href="#_managing_recovery_directly"></a>Managing recovery directly</h5>
<div class="paragraph">
<p>As already mentioned, recovery typically happens at periodic intervals.
If you require to drive recovery directly, then there are two options, depending upon how the <code>RecoveryManager</code> has been created.</p>
</div>
</div>
<div class="sect4">
<h5 id="_separate_recovery_manager"><a class="anchor" href="#_separate_recovery_manager"></a>Separate Recovery Manager</h5>
<div class="paragraph">
<p>You can either use the <code>com.arjuna.ats.arjuna.tools.RecoveryMonitor</code> program to send a message to the Recovery Manager instructing it to perform recovery, or you can create an instance of the <code>com.arjuna.ats.arjuna.recovery.RecoveryDriver</code> class to do likewise.
There are two types of recovery scan available:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>ASYNC_SCAN</code>: here a message is sent to the <code>RecoveryManager</code> to instruct it to perform recovery, but the response returns before recovery has completed.</p>
</li>
<li>
<p><code>SYNC</code>: here a message is sent to the <code>RecoveryManager</code> to instruct it to perform recovery, and the response occurs only when recovery has completed.</p>
<div class="paragraph">
<p>When using the RecoveryMonitor program there is a -verbose option which will trigger a recovery scan and report any warnings or errors emitted from the XA recovery module by printing "ERROR" (otherwise "DONE" is printed).
If the monitor is invoked programmatically, for example RecoveryMonitor.main(new String [] {"-verbose", "-port", &#8230;&#8203;});, then the status of the recovery pass is available by calling the static method RecoveryMonitor.getResponse(); Note that only XA resource issues are reported using this mechanism which is sufficient to detect any resource recovery failures, including unavailablity of resources that impact orphan detection.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_in_process_recovery_manager"><a class="anchor" href="#_in_process_recovery_manager"></a>In process Recovery Manager</h5>
<div class="paragraph">
<p>You can invoke the scan operation on the <code>RecoveryManager</code>.
This operation returns only when recovery has completed.
However, if you wish to have an asynchronous interaction pattern, then the RecoveryScan interface is provided:</p>
</div>
<div class="listingblock">
<div class="title">RecoveryScan interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">RecoveryScan</span> {
    <span class="directive">public</span> <span class="type">void</span> completed();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An instance of an object supporting this interface can be passed to the scan operation and its completed method will be called when recovery finishes.
The scan operation returns immediately, however.</p>
</div>
</div>
<div class="sect4">
<h5 id="_recovering_for_multiple_transaction_coordinators"><a class="anchor" href="#_recovering_for_multiple_transaction_coordinators"></a>Recovering For Multiple Transaction Coordinators</h5>
<div class="paragraph">
<p>Sometimes a single Recovery Manager can be made responsible for recovering transactions executing on behalf of multiple transaction coordinators.
Conversely, due to specific configurations it may be that multiple Recovery Managers share the same Object Store and in which case should not conflict with each other, e.g., roll back transactions that they do not understand.
Therefore, when running recovery it is necessary to tell Narayana which types of transactions it can recover and which transaction identifiers it should ignore.</p>
</div>
<div class="paragraph">
<p>When necessary each transaction identifier that Narayana creates may have a unique node identifier encoded within it and Narayana will only recover transactions and states that match a specified node identifier.
The node identifier for each Narayana instance should be set via the com.arjuna.ats.arjuna.nodeIdentifier property.
This value must be unique across Narayana instances.
The contents of this should be alphanumeric and not exceed 10 bytes in length.
If you do not provide a value, then Narayana will fabricate one and report the value via the logging infrastructure.</p>
</div>
<div class="paragraph">
<p>How this value is used will depend upon the type of resources being recovered and will be discussed within the relevant sections for the Recovery Modules.</p>
</div>
</div>
<div class="sect4">
<h5 id="_recovery_from_an_alternate_node"><a class="anchor" href="#_recovery_from_an_alternate_node"></a>Recovery From An Alternate Node</h5>
<div class="paragraph">
<p>After failure it is sometimes desirable to recover on a different node from the one where the transaction manager failed.
This kind of usage is only supported in JTA mode running inside an application server (with certain restrictions) and is not typical because of the consequences of incorrect configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Only JTA transactions will be recovered (so the failing node must be configured in JTA mode).</p>
</li>
<li>
<p>Changing versions of Narayana or the application server on the new node is not supported.</p>
</li>
<li>
<p>The recovering node must have access to the same object store logs as the failed node (which can be achieved by either copying the logs or by using a shared file system or by using the JDBC object store connected to a database that is accessible to both nodes).
If you are using the JDBC object store ensure that it is configured the same way on both nodes.</p>
</li>
<li>
<p>Both nodes must have access to the same set of resource managers and with the same configuration (minimally, the JNDI names must not change).
Often the deployment model for databases is to host the resource manager on a different node from the application server so generally this should not be an issue.</p>
</li>
<li>
<p>Recovery requires help from Resource Managers which should be configured to support the ability to recover from other nodes.
Database recovery is known to work but other resource managers may require case by case consideration.</p>
</li>
<li>
<p>If application deployments define their own datasources then these applications must also be deployed on the new server.</p>
</li>
<li>
<p>It is recommended that the transaction subsystem is configured in the same way on the new node as it was on the failed one.
In particular the node identifier should not change.
The comment made in the previous section about the uniqueness of the node identifier still applies so it is imperative that the failed node is not brought back online without changing its configuration.
The same restrictions regarding object stores still apply, namely "exactly one recovery manager per <code>ObjectStore</code> must run on each node and ObjectStores must not be shared by multiple nodes".</p>
</li>
<li>
<p>Before restarting recovery on the new node sanity check your configuration to ensure it does not contain any hard coded IP addresses that refer to network interfaces on the failed node.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is a long list of caveats and if it is not possible to simply restart the failed node then, in order to avoid the consequences of incorrect configuration, we advise that the application server on the recovering node uses the same configuration file as the failed node.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_recovery_modules"><a class="anchor" href="#_recovery_modules"></a>2.1.3. Recovery Modules</h4>
<div class="paragraph">
<p>As stated before each recovery module is used to recover a different type of transaction/resource, but each recovery module must implement the following <code>RecoveryModule</code> interface, which defines two methods: <code>periodicWorkFirstPass</code> and <code>periodicWorkSecondPass</code> invoked by the Recovery Manager.</p>
</div>
<div class="listingblock">
<div class="title"><code>RecoveryModule</code> interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">RecoveryModule</span> {
    <span class="comment">/**
     * Called by the RecoveryManager at start up, and then
     * PERIODIC_RECOVERY_PERIOD seconds after the completion, for all
     * RecoveryModules of the second pass
     */</span>
    <span class="directive">public</span> <span class="type">void</span> periodicWorkFirstPass();

    <span class="comment">/**
     * Called by the RecoveryManager RECOVERY_BACKOFF_PERIOD seconds after the
     * completion of the first pass
     */</span>
    <span class="directive">public</span> <span class="type">void</span> periodicWorkSecondPass();
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_narayana_recovery_module_classes"><a class="anchor" href="#_narayana_recovery_module_classes"></a>Narayana Recovery Module Classes</h5>
<div class="paragraph">
<p>Narayana provides a set of recovery modules that are responsible to manage recovery according to the nature of the participant and its position in a transactional tree.
The provided classes (that all implements the <code>RecoveryModule</code> interface) are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.arjuna.ats.internal.arjuna.recovery.AtomicActionRecoveryModule</code></p>
<div class="paragraph">
<p>Recovers AtomicAction transactions.</p>
</div>
</li>
<li>
<p><code>com.arjuna.ats.internal.jts.recovery.transactions.TransactionRecoveryModule</code></p>
<div class="paragraph">
<p>Recovers JTS Transactions.
This is a generic class from which TopLevel and Server transaction recovery modules inherit, respectively</p>
</div>
</li>
<li>
<p><code>com.arjuna.ats.internal.jts.recovery.transactions.TopLevelTransactionRecoveryModule</code></p>
</li>
<li>
<p><code>com.arjuna.ats.internal.jts.recovery.transactions.ServerTransactionRecoveryModule</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_recovery_module_for_xa_resources"><a class="anchor" href="#_a_recovery_module_for_xa_resources"></a>2.1.4. A Recovery Module for XA Resources</h4>
<div class="paragraph">
<p>During recovery, the Transaction Manager needs to be able to communicate to all resource managers that are in use by the applications in the system.
For each resource manager, the Transaction Manager uses the <code>XAResource.recover</code> method to retrieve the list of transactions that are currently in a prepared or heuristically completed state.
Typically, the system administrator configures all transactional resource factories that are used by the applications deployed on the system.
An example of such a resource factory is the <code>JDBC XADataSource</code> object, which is a factory for the <code>JDBC XAConnection</code> objects.</p>
</div>
<div class="paragraph">
<p>Because <code>XAResource</code> objects are not persistent across system failures, the Transaction Manager needs to have some way to acquire the <code>XAResource</code> objects that represent the resource managers which might have participated in the transactions prior to the system failure.
For example, a Transaction Manager might, through the use of JNDI lookup mechanism, acquire a connection from each of the transactional resource factories, and then obtain the corresponding <code>XAResource</code> object for each connection.
The Transaction Manager then invokes the <code>XAResource.recover</code> method to ask each resource manager to return the transactions that are currently in a prepared or heuristically completed state.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When running XA recovery it is necessary to tell Narayana which types of Xid it can recover.
Each <code>Xid</code> that Narayana creates has a unique node identifier encoded within it and Narayana will only recover transactions and states that match a specified node identifier.
The node identifier to use should be provided to Narayana via the property <code>JTAEnvironmentBean.xaRecoveryNodes</code>; multiple values may be provided in a list.
A value of <code>*</code> will force Narayana to recover (and possibly rollback) all transactions irrespective of their node identifier and should be used with caution.
The contents of <code>com.arjuna.ats.jta.xaRecoveryNode</code> should be alphanumeric and match the values of <code>com.arjuna.ats.arjuna.nodeIdentifier</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One of the following recovery mechanisms will be used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the <code>XAResource</code> is serializable, then the serialized form will be saved during transaction commitment, and used during recovery.
It is assumed that the recreated <code>XAResource</code> is valid and can be used to drive recovery on the associated database.</p>
</li>
<li>
<p>The <code>com.arjuna.ats.jta.recovery.XAResourceRecovery</code>, <code>com.arjuna.ats.jta.recovery.XARecoveryResourceManager</code> and <code>com.arjuna.ats.jta.recovery.XARecoveryResource</code> interfaces are used.
These are described in detail later in this document.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To manage recovery, we have seen in the previous chapter that the Recovery Manager triggers a recovery process by calling a set of recovery modules that implements the two methods defined by the <code>RecoveryModule</code> interface.
To enable recovery of participants controlled via the XA interface, a specific recovery module named <code>XARecoveryModule</code> is provided.
The <code>XARecoveryModule</code>, defined in the packages <code>com.arjuna.ats.internal.jta.recovery.arjunacore</code> and <code>com.arjuna.ats.internal.jta.recovery.jts</code>, handles recovery of XA resources (databases etc.) used in JTA.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Narayana supports two JTA implementations: a purely local version (no distributed transactions) and a version layered on the JTS.
Recovery for the former is straightforward.
In the following discussion we shall implicitly consider on the JTS implementation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Its behavior consists of two aspects: "transaction-initiated" and "`esource-initiated" recovery.
Transaction-initiated recovery is possible where the particular transaction branch had progressed far enough for a JTA Resource Record to be written in the <code>ObjectStore</code>.</p>
</div>
<div class="paragraph">
<p>A JTA Resource record contains the information needed to link the transaction, as known to the rest of Narayana, to the database.
Resource-initiated recovery is necessary for branches where a failure occurred after the database had made a persistent record of the transaction, but before the JTA <code>ResourceRecord</code> was persisted.
Resource-initiated recovery is also necessary for datasources for which it is not possible to hold information in the JTA Resource record that allows the recreation in the <code>RecoveryManager</code> of the <code>XAConnection</code>/<code>XAResource</code> that was used in the original application.</p>
</div>
<div class="paragraph">
<p>Transaction-initiated recovery is automatic.
The <code>XARecoveryModule</code> finds the JTA Resource Record that need recovery, then uses the normal recovery mechanisms to find the status of the transaction it was involved in (i.e., it calls replay_completion on the RecoveryCoordinator for the transaction branch), (re)creates the appropriate <code>XAResource</code> and issues commit or rollback on it as appropriate.
The <code>XAResource</code> creation will use the same information, database name, username, password etc., as the original application.</p>
</div>
<div class="paragraph">
<p>Resource-initiated recovery has to be specifically configured, by supplying the Recovery Manager with the appropriate information for it to interrogate all the databases (<code>XADataSources</code>) that have been accessed by any Narayana application.
The access to each XADataSource is handled by a class that implements the <code>com.arjuna.ats.jta.recovery.XAResourceRecovery</code> interface, as illustrated in <a href="#resource-initiated_recovery_and_XA_recovery">Resource-initiated recovery and XA Recovery</a>.
Instances of classes that implements the <code>XAResourceRecovery</code> interface are dynamically loaded, as controlled by properties with names beginning <code>com.arjuna.ats.jta.recovery.XAResourceRecovery</code>.</p>
</div>
<div id="resource-initiated_recovery_and_XA_recovery" class="imageblock text-center">
<div class="content">
<img src="images/failure-recovery-fig2-resourceinitiatedrecovery.png" alt="failure recovery fig2 resourceinitiatedrecovery">
</div>
<div class="title">Figure 5. Resource-initiated recovery and XA Recovery</div>
</div>
<div class="paragraph">
<p>The <code>XARecoveryModule</code> will use the <code>XAResourceRecovery</code> implementation to get a <code>XAResource</code> to the target datasource.
On each invocation of <code>periodicWorkSecondPass</code>, the recovery module will issue an <code>XAResource.recover</code> request  this will (as described in the XA specification) return a list of the transaction identifiers (Xid&#8217;s) that are known to the datasource and are in an indeterminate (in-doubt) state.
The list of these in-doubt Xid&#8217;s received on successive passes (i.e. <code>periodicWorkSecondPass</code>-es) is compared.
Any Xid that appears in both lists, and for which no JTA <code>ResourceRecord</code> was found by the intervening transaction-initiated recovery is assumed to belong to a transaction that was involved in a crash before any JTA <code>ResourceRecord</code> was written, and a rollback is issued for that transaction on the <code>XAResource</code>.</p>
</div>
<div class="paragraph">
<p>This double-scan mechanism is used because it is possible the Xid was obtained from the datasource just as the original application process was about to create the corresponding <code>JTA_ResourceRecord</code>.
The interval between the scans should allow time for the record to be written unless the application crashes (and if it does, rollback is the right answer).</p>
</div>
<div class="paragraph">
<p>An <code>XAResourceRecovery</code> implementation class can be written to contain all the information needed to perform recovery to some datasource.
Alternatively, a single class can handle multiple datasources.
The constructor of the implementation class must have an empty parameter list (because it is loaded dynamically), but the interface includes an initialise method which passes in further information as a string.
The content of the string is taken from the property value that provides the class name: everything after the first semi-colon is passed as the value of the string.
The use made of this string is determined by the <code>XAResourceRecovery</code> implementation class.</p>
</div>
<div class="paragraph">
<p>For further details on the way to implement a class that implements the interface <code>XAResourceRecovery</code>, read the JDBC chapter of the JTA Programming Guide.
An implementation class is provided that supports resource-initiated recovery for any XADataSource.
This class could be used as a template to build your own implementation class.</p>
</div>
<div class="sect4">
<h5 id="_assumed_complete"><a class="anchor" href="#_assumed_complete"></a>Assumed complete</h5>
<div class="paragraph">
<p>If a failure occurs in the transaction environment after the transaction coordinator had told the <code>XAResource</code> to commit but before the transaction log has been updated to remove the participant, then recovery will attempt to replay the commit.
In the case of a Serialized <code>XAResource</code>, the response from the <code>XAResource</code> will enable the participant to be removed from the log, which will eventually be deleted when all participants have been committed.
However, if the <code>XAResource</code> is not recoverable then it is extremely unlikely that any <code>XAResourceRecovery</code> instance will be able to provide the recovery sub-system with a fresh <code>XAResource</code> to use in order to attempt recovery; in which case recovery will continually fail and the log entry will never be removed.</p>
</div>
<div class="paragraph">
<p>There are two possible solutions to this problem:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Rely on the relevant <code>ExpiryScanner</code> to eventually move the log elsewhere.
Manual intervention will then be needed to ensure the log can be safely deleted.
If a log entry is moved, suitable warning messages will be output.</p>
</li>
<li>
<p>Set the <code>com.arjuna.ats.jta.xaAssumeRecoveryComplete</code> to true.
This option is checked whenever a new <code>XAResource</code> instance cannot be located from any registered <code>XAResourceRecovery</code> instance.
If false (the default), recovery assumes that there is a transient problem with the <code>XAResourceRecovery</code> instances (e.g., not all have been registered with the sub-system) and will attempt recovery periodically.
If true then recovery assumes that a previous commit attempt succeeded and this instance can be removed from the log with no further recovery attempts.
This option is global, so needs to be used with care since if used incorrectly <code>XAResource</code> instances may remain in an uncommitted state.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_recovering_xaconnections"><a class="anchor" href="#_recovering_xaconnections"></a>2.1.5. Recovering XAConnections</h4>
<div class="paragraph">
<p>When recovering from failures, Narayana requires the ability to reconnect to databases that were in use prior to the failures in order to resolve any outstanding transactions.
Most connection information will be saved by the transaction service during its normal execution, and can be used during recovery to recreate the connection.
However, it is possible that not all such information will have been saved prior to a failure (for example, a failure occurs before such information can be saved, but after the database connection is used).
In order to recreate those connections it is necessary to provide implementations of the following Narayana interface <code>com.arjuna.ats.jta.recovery.XAResourceRecovery</code>, one for each database that may be used by an application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>if using the transactional JDBC driver provided with Narayana, then no additional work is necessary in order to ensure that recovery occurs.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To inform the recovery system about each of the <code>XAResourceRecovery</code> instances, it is necessary to specify their class names through the JTAEnvironmentBean.xaResourceRecoveryInstances property variable, whose values is a list of space separated strings, each being a classname followed by optional configuration information.</p>
</div>
<div class="paragraph">
<p><code>JTAEnvironmentBean.xaResourceRecoveryInstances=com.foo.barRecovery</code></p>
</div>
<div class="paragraph">
<p>Additional information that will be passed to the instance when it is created may be specified after a semicolon:</p>
</div>
<div class="paragraph">
<p><code>JTAEnvironmentBean.xaResourceRecoveryInstances=com.foo.barRecovery;myData=hello</code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These properties need to go into the JTA section of the property file.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Any errors will be reported during recovery.</p>
</div>
<div class="listingblock">
<div class="title"><code>XAResourceRecovery</code> interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">XAResourceRecovery</span> {
    <span class="directive">public</span> <span class="predefined-type">XAResource</span> getXAResource() <span class="directive">throws</span> <span class="exception">SQLException</span>;

    <span class="directive">public</span> <span class="type">boolean</span> initialise(<span class="predefined-type">String</span> p);

    <span class="directive">public</span> <span class="type">boolean</span> hasMoreResources();
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each method should return the following information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>initialise: once the instance has been created, any additional information which occurred on the property value (anything found after the first semi-colon) will be passed to the object.
The object can then use this information in an implementation specific manner to initialise itself, for example.</p>
</li>
<li>
<p><code>hasMoreResources</code>: each <code>XAResourceRecovery</code> implementation may provide multiple <code>XAResource</code> instances.
Before any call to <code>getXAResource</code> is made, <code>hasMoreResources</code> is called to determine whether there are any further connections to be obtained.
If this returns false, <code>getXAResource</code> will not be called again during this recovery sweep and the instance will not be used further until the next recovery scan.
It is up to the implementation to maintain the internal state backing this method and to reset the iteration as required.
Failure to do so will mean that the second and subsequent recovery sweeps in the lifetime of the JVM do not attempt recovery.</p>
</li>
<li>
<p><code>getXAResource</code>: returns an instance of the <code>XAResource</code> object.
How this is created (and how the parameters to its constructors are obtained) is up to the <code>XAResourceRecovery</code> implementation.
The parameters to the constructors of this class should be similar to those used when creating the initial driver or data source, and should obviously be sufficient to create new <code>XAResources</code> that can be used to drive recovery.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you want your <code>XAResourceRecovery</code> instance to be called during each sweep of the recovery manager then you should ensure that once <code>hasMoreResources</code> returns false to indicate the end of work for the current scan it then returns true for the next recovery scan.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_alternative_to_xaresourcerecovery"><a class="anchor" href="#_alternative_to_xaresourcerecovery"></a>2.1.6. Alternative to <code>XAResourceRecovery</code></h4>
<div class="paragraph">
<p>The iterator based approach used by <code>XAResourceRecovery</code> leads to a requirement for implementations to manage state, which makes them more complex than necessary.</p>
</div>
<div class="paragraph">
<p>As an alternative, starting with Narayana 4.4, users may provide an implementation of the public interface</p>
</div>
<div class="listingblock">
<div class="title"><code>XAResourceRecoveryHelper</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">com</span>.arjuna.ats.jta.recovery.

XAResourceRecoveryHelper {
    <span class="directive">public</span> <span class="type">boolean</span> initialise (<span class="predefined-type">String</span> p) <span class="directive">throws</span> <span class="exception">Exception</span>;
    <span class="directive">public</span> <span class="predefined-type">XAResource</span><span class="type">[]</span> getXAResources () <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>During each recovery sweep the <code>getXAResources</code> method will be called and recovery attempted on each element of the array.
For the majority of resource managers it will be necessary to have only one <code>XAResource</code> in the array, as the <code>recover()</code> call on it can return multiple Xids.</p>
</div>
<div class="paragraph">
<p>Unlike <code>XAResourceRecovery</code> instances, which are configured via the xml properties file and instantiated by Narayana, instances of <code>XAResourceRecoveryHelper</code> and constructed by the application code and registered with Narayana by calling</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">XARecoveryModule.addXAResourceRecoveryHelper(...)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The initialize method is not called by Narayana in the current implementation, but is provided to allow for the addition of further configuration options in later releases.</p>
</div>
<div class="paragraph">
<p><code>XAResourceRecoveryHelper</code> instances may be deregistered, after which they will no longer be called by the recovery manager.
Deregistration may block for a time if a recovery scan is in progress.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">XARecoveryModule.removeXAResourceRecoveryHelper(...)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The ability to dynamically add and remove instances of <code>XAResourceRecoveryHelper</code> whilst the system is running makes this approach an attractive option for environments in which e.g. datasources may be deployed or undeployed, such as application servers.
Care should be taken with classloading behaviour in such cases.</p>
</div>
</div>
<div class="sect3">
<h4 id="_shipped_xaresourcerecovery_implementations"><a class="anchor" href="#_shipped_xaresourcerecovery_implementations"></a>2.1.7. Shipped <code>XAResourceRecovery</code> implementations</h4>
<div class="paragraph">
<p>Recovery of XA datasources can sometimes be implementation dependant, requiring developers to provide their own <code>XAResourceRecovery</code> instances.
However, Narayana ships with several out-of-the-box implementations that may be useful.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These <code>XAResourceRecovery</code> instances are primarily intended for when running Narayana outside of a container such as WildFly Application Server, since they rely upon <code>XADataSources</code> as the primary handle to drive recovery.
If you are not running Narayana stand-alone then you should consult the relevant integration documentation to ensure that the right recovery modules are being used.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">com.arjuna.ats.internal.jdbc.recovery.BasicXARecovery</code></pre>
</div>
</div>
<div class="paragraph">
<p>this expects an XML property file to be specified upon creation and from which it will read the configuration properties for the datasource.
For example:</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">XML datasource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="doctype">&lt;!DOCTYPE properties SYSTEM &quot;http://java.sun.com/dtd/properties.dtd&quot;&gt;</span>
<span class="tag">&lt;properties&gt;</span>
    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DB_X_DatabaseUser</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>username<span class="tag">&lt;/entry&gt;</span>
    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DB_X_DatabasePassword</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>password&quot;<span class="tag">&lt;/entry&gt;</span>
    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DB_X_DatabaseDynamicClass</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>DynamicClass<span class="tag">&lt;/entry&gt;</span>
    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DB_X_DatabaseURL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>theURL<span class="tag">&lt;/entry&gt;</span>
<span class="tag">&lt;/properties&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">com.arjuna.ats.internal.jdbc.recovery.JDBCXARecovery</code></pre>
</div>
</div>
<div class="paragraph">
<p>this recovery implementation should work on any datasource that is exposed via JNDI.
It expects an XML property file to be specified upon creation and from which it will read the database JNDI name, username and password.
For example:</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">JNDI datasource</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="doctype">&lt;!DOCTYPE properties SYSTEM &quot;http://java.sun.com/dtd/properties.dtd&quot;&gt;</span>
<span class="tag">&lt;properties&gt;</span>
    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DatabaseJNDIName</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>java:ExampleDS<span class="tag">&lt;/entry&gt;</span>
    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UserName</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>username<span class="tag">&lt;/entry&gt;</span>
    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Password</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>password<span class="tag">&lt;/entry&gt;</span>
<span class="tag">&lt;/properties&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Because these classes are <code>XAResourceRecovery</code> instances they are passed any necessary initialization information via the initialise operation.
In the case of BasicXARecovery and JDBCXARecovery this should be the location of a property file and is specified in the Narayana configuration file.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">com.arjuna.ats.jta.recovery.XAResourceRecoveryJDBC=com.arjuna.ats.internal.jdbc.recovery.JDBCXAResourceRecovery;thePropertyFile</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_transactionstatusconnectionmanager"><a class="anchor" href="#_transactionstatusconnectionmanager"></a>2.1.8. <code>TransactionStatusConnectionManager</code></h4>
<div class="paragraph">
<p>The <code>TransactionStatusConnectionManager</code> object is used by the recovery modules to retrieve the status of transactions and acts like a proxy for <code>TransactionStatusManager</code> objects.
It maintains a table of <code>TransactionStatusConnector</code> obects each of which connects to a <code>TransactionStatusManager</code> object in an Application Process.</p>
</div>
<div class="paragraph">
<p>The transactions status is retrieved using the <code>getTransactionStatus</code> methods which take a transaction Uid and if available a transaction type as parameters.
The process Uid field in the transactions Uid parameter is used to lookup the target <code>TransactionStatusManagerItem</code> host/port pair in the Object Store.
The host/port pair are used to make a TCP connection to the target <code>TransactionStatusManager</code> object by a <code>TransactionStatusConnector</code> object.
The <code>TransactionStatusConnector</code> passes the transaction Uid/transaction type to the <code>TransactionStatusManager</code> in order to retrieve the transactions status.</p>
</div>
</div>
<div class="sect3">
<h4 id="_expired_scanner_thread"><a class="anchor" href="#_expired_scanner_thread"></a>2.1.9. Expired Scanner Thread</h4>
<div class="paragraph">
<p>When the Recovery Manager initialises an expiry scanner thread <code>ExpiryEntryMonitor</code> is created which is used to remove long dead items from the <code>ObjectStore</code>.
A number of scanner modules are dynamically loaded which remove long dead items for a particular type.</p>
</div>
<div class="paragraph">
<p>Scanner modules are loaded at initialisation and are specified as properties beginning with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.expiryScanners</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    list of class names
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All the scanner modules are called periodically to scan for dead items by the <code>ExpiryEntryMonitor</code> thread.
This period is set with the property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.expiryScanInterval</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    number_of_hours
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All scanners inherit the same behaviour from the java interface <code>ExpiryScanner</code>.
A scan method is provided by this interface and implemented by all scanner modules, this is the method that gets called by the scanner thread.</p>
</div>
<div class="paragraph">
<p>The <code>ExpiredTransactionStatusManagerScanner</code> removes long dead <code>TransactionStatusManagerItems</code> from the Object Store.
These items will remain in the Object Store for a period of time before they are deleted.
This time is set by the property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.transactionStatusManagerExpiryTime</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    number_of_hours
<span class="tag">&lt;/entry&gt;</span> (default 12 hours)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>AtomicActionExpiryScanner</code> moves transaction logs for AtomicActions that are assumed to have completed.
For instance, if a failure occurs after a participant has been told to commit but before the transaction system can update the log, then upon recovery Narayana recovery will attempt to replay the commit request, which will obviously fail, thus preventing the log from being removed.
This is also used when logs cannot be recovered automatically for other reasons, such as being corrupt or zero length.
All logs are moved to a location based on the old location appended with <code>/Expired</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>AtomicActionExpiryScanner</code> is disabled by default.
To enable it simply add it to the Narayana properties file.
You do not need to enable it in order to cope with (move) corrupt logs.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_application_process"><a class="anchor" href="#_application_process"></a>2.1.10. Application Process</h4>
<div class="paragraph">
<p>This represents the user transactional program.
A Local transaction (hash) table, maintained within the running application process keeps trace of the current status of all transactions created by that application process, The Recovery Manager needs access to the transaction tables so that it can determine whether a transaction is still in progress, if so then recovery does not happen.</p>
</div>
<div class="paragraph">
<p>The transaction tables are accessed via the <code>TransactionStatusManager</code> object.
On application program initialisation the host/port pair that represents the <code>TransactionStatusManager</code> is written to the Object Store in <code>../Recovery/TransactionStatusManager</code> part of the Object Store file hierarchy and identified by the process Uid of the application process.</p>
</div>
<div class="paragraph">
<p>The Recovery Manager uses the <code>TransactionStatusConnectionManager</code> object to retrieve the status of a transaction and a <code>TransactionStatusConnector</code> object is used to make a TCP connection to the <code>TransactionStatusManager</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transactionstatusmanager"><a class="anchor" href="#_transactionstatusmanager"></a>2.1.11. <code>TransactionStatusManager</code></h4>
<div class="paragraph">
<p>This object acts as an interface for the Recovery Manager to obtain the status of transactions from running Narayana application processes.
One <code>TransactionStatusManager</code> is created per application process by the class <code>com.arjuna.ats.arjuna.coordinator.TxControl</code>.
Currently a tcp connection is used for communication between the <code>RecoveryManager</code> and <code>TransactionStatusManager</code>.
Any free port is used by the <code>TransactionStatusManager</code> by default, however the port can be fixed with the property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.transactionStatusManagerPort</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    port
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On creation the <code>TransactionStatusManager</code> obtains a port which it stores with the host in the Object Store as a <code>TransactionStatusManagerItem</code>.
A Listener thread is started which waits for a connection request from a <code>TransactionStatusConnector</code>.
When a connection is established a Connection thread is created which runs a Service (<code>AtomicActionStatusService</code>) which accepts a transaction Uid and a transaction type (if available) from a <code>TransactionStatusConnector</code>, the transaction status is obtained from the local thransaction table and returned back to the <code>TransactionStatusConnector</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_object_store"><a class="anchor" href="#_object_store"></a>2.1.12. Object Store</h4>
<div class="paragraph">
<p>All objects are identified by a unique identifier Uid.
One of the values of which is a process id in which the object was created.
The Recovery Manager uses the process id to locate transaction status manager items when contacting the originator application process for the transaction status.
Therefore, exactly one recovery manager per <code>ObjectStore</code> must run on each node and ObjectStores must not be shared by multiple nodes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_socket_free_operation"><a class="anchor" href="#_socket_free_operation"></a>2.1.13. Socket free operation</h4>
<div class="paragraph">
<p>The use of TCP/IP sockets for <code>TransactionStatusManager</code> and <code>RecoveryManager</code> provides for maximum flexibility in the deployment architecture.
It is often desirable to run the <code>RecoveryManager</code> in a separate JVM from the Transaction manager(s) for increased reliability.
In such deployments, TCP/IP provides for communication between the <code>RecoveryManager</code> and transaction manager(s), as detailed in the preceding sections.
Specifically, each JVM hosting a TransactionManager will run a <code>TransactionStatusManager</code> listener, through which the <code>RecoveryManager</code> can contact it to determine if a transaction is still live or not.
The <code>RecoveryManager</code> likewise listens on a socket, through which it can be contacted to perform recovery scans on demand.
The presence of a recovery listener is also used as a safety check when starting a <code>RecoveryManager</code>, since at most one should be running for a given <code>ObjectStore</code>.</p>
</div>
<div class="paragraph">
<p>There are some deployment scenarios in which there is only a single TransactionManager accessing the <code>ObjectStore</code> and the <code>RecoveryManager</code> is co-located in the same JVM.
For such cases the use of TCP/IP sockets for communication introduces unnecessary runtime overhead.
Additionally, if several such distinct processes are needed for e.g. replication or clustering, management of the TCP/IP port allocation can become unwieldy.
Therefore it may be desirable to configure for socketless recovery operation.</p>
</div>
<div class="paragraph">
<p>The property <code>CoordinatorEnvironmentBean.transactionStatusManagerEnable</code> can be set to a value of NO to disable the <code>TransactionStatusManager</code> for any given <code>TransactionManager</code>.
Note that this must not be done if recovery runs in a separate process, as it may lead to incorrect recovery behavior in such cases.
For an in-process recovery manager, the system will use direct access to the <code>ActionStatusService</code> instead.</p>
</div>
<div class="paragraph">
<p>The property <code>RecoveryEnvironmentBean.recoveryListener</code> can likewise be used to disable the TCP/IP socket listener used by the recovery manager.
Care must be taken not to inadvertently start multiple recovery managers for the same <code>ObjectStore</code>, as this error, which may lead to significant crash recovery problems, cannot be automatically detected and prevented without the benefit of the socket listener.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_narayana_manages_the_ots_recovery_protocol"><a class="anchor" href="#_how_narayana_manages_the_ots_recovery_protocol"></a>2.2. How Narayana manages the OTS Recovery Protocol</h3>
<div class="sect3">
<h4 id="_recovery_protocol_in_ots_overview"><a class="anchor" href="#_recovery_protocol_in_ots_overview"></a>2.2.1. Recovery Protocol in OTS - Overview</h4>
<div class="paragraph">
<p>To manage recovery in case of failure, the OTS specification has defined a recovery protocol.
Transaction&#8217;s participants in a doubt status could use the <code>RecoveryCoordinator</code> to determine the status of the transaction.
According to that transaction status, those participants can take appropriate decision either by roll backing or committing.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/failure-recovery-fig3-resource-recoverycoordinator.png" alt="failure recovery fig3 resource recoverycoordinator">
</div>
<div class="title">Figure 6. Resource and <code>RecoveryCoordinator</code> relationship</div>
</div>
<div class="paragraph">
<p>A reference to a <code>RecoveryCoordinator</code> is returned as a result of successfully calling <code>register_resource</code> on the transaction Coordinator.
This object, which is implicitly associated with a single Resource, can be used to drive the Resource through recovery procedures in the event of a failure occurring during the transaction.</p>
</div>
</div>
<div class="sect3">
<h4 id="_recoverycoordinator_in_narayana"><a class="anchor" href="#_recoverycoordinator_in_narayana"></a>2.2.2. <code>RecoveryCoordinator</code> in Narayana</h4>
<div class="paragraph">
<p>On each resource registration a <code>RecoveryCoordinator</code> Object is expected to be created and returned to the application that invoked the register_resource operation.
Behind each CORBA object there should be an object implementation or Servant object, in POA terms, which performs operations made on a <code>RecoveryCoordinator</code> object.
Rather than to create a <code>RecoveryCoordinator</code> object with its associated servant on each register_resource, Narayana enhances performance by avoiding the creation of servants but it relies on a default <code>RecoveryCoordinator</code> object with it&#8217;s associated default servant to manage all <code>replay_completion</code> invocations.</p>
</div>
<div class="paragraph">
<p>In the next sections we first give an overview of the Portable Object Adapter architecture, then we describe how this architecture is used to provide <code>RecoveryCoordinator</code> creation with optimization as explained above.</p>
</div>
<div class="sect4">
<h5 id="_understanding_poa"><a class="anchor" href="#_understanding_poa"></a>Understanding POA</h5>
<div class="paragraph">
<p>Basically, the Portable Object Adapter, or POA is an object that intercepts a client request and identifies the object that satisfies the client request.
The Object is then invoked and the response is returned to the client.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/failure-recovery-fig4-overview-of-poa.png" alt="failure recovery fig4 overview of poa">
</div>
<div class="title">Figure 7. Overview of the POA</div>
</div>
<div class="paragraph">
<p>The object that performs the client request is referred as a servant, which provides the implementation of the CORBA object requested by the client.
A servant provides the implementation for one or more CORBA object references.
To retreive a servant, each POA maintains an Active Object Map that maps all objects that have been activated in the POA to a servant.
For each incoming request, the POA looks up the object reference in the Active Object Map and tries to find the responsible servant.
If none is found, the request is either delegated to a default servant, or a servant manager is invoked to activate or locate an appropriate servant.
In addition to the name space for the objects, which are identified by Object Ids, a POA also provides a name space for POAs.
A POA is created as a child of an existing POA, which forms a hierarchy starting with the root POA.</p>
</div>
<div class="paragraph">
<p>Each POA has a set of policies that define its characteristics.
When creating a new POA, the default set of policies can be used or different values can be assigned that suit the application requirements.
The POA specification defines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Thread policy  Specifies the threading model to be used by the POA.
Possible values are:</p>
<div class="ulist">
<ul>
<li>
<p><code>ORB_CTRL_MODEL</code>  (default) The POA is responsible for assigning requests to threads.</p>
</li>
<li>
<p><code>SINGLE_THREAD_MODEL</code>  the POA processes requests sequentially</p>
</li>
</ul>
</div>
</li>
<li>
<p>Lifespan policy - specifies the lifespan of the objects implemented in the POA.
The lifespan policy can have the following values:</p>
<div class="ulist">
<ul>
<li>
<p><code>TRANSIENT</code> (Default) Objects implemented in the POA cannot outlive the process in which they are first created.
Once the POA is deactivated, an <code>OBJECT_NOT_EXIST</code> exception occurs when attempting to use any object references generated by the POA.</p>
</li>
<li>
<p><code>PERSISTENT</code> Objects implemented in the POA can outlive the process in which they are first created.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Object ID Uniqueness policy - allows a single servant to be shared by many abstract objects.
The Object ID Uniqueness policy can have the following values:</p>
<div class="ulist">
<ul>
<li>
<p><code>UNIQUE_ID</code> (Default) Activated servants support only one Object ID.</p>
</li>
<li>
<p><code>MULTIPLE_ID</code> Activated servants can have one or more Object IDs.
The Object ID must be determined within the method being invoked at run time.</p>
</li>
</ul>
</div>
</li>
<li>
<p>ID Assignment policy - specifies whether object IDs are generated by server applications or by the POA.
The ID Assignment policy can have the following values:</p>
<div class="ulist">
<ul>
<li>
<p><code>USER_ID</code> is for persistent objects, and</p>
</li>
<li>
<p><code>SYSTEM_ID</code> is for transient objects</p>
</li>
</ul>
</div>
</li>
<li>
<p>Servant Retention policy - specifies whether the POA retains active servants in the Active Object Map.
The Servant Retention policy can have the following values:</p>
<div class="ulist">
<ul>
<li>
<p><code>RETAIN</code> (Default) The POA tracks object activations in the Active Object Map.
<code>RETAIN</code> is usually used with ServantActivators or explicit activation methods on POA.</p>
</li>
<li>
<p><code>NON_RETAIN</code> The POA does not retain active servants in the Active Object Map.
<code>NON_RETAIN</code> is typically used with ServantLocators.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Request Processing policy - specifies how requests are processed by the POA.</p>
<div class="ulist">
<ul>
<li>
<p><code>USE_ACTIVE_OBJECT_MAP</code> (Default) If the Object ID is not listed in the Active Object Map, an <code>OBJECT_NOT</code> <code>_EXIST</code> exception is returned.
The POA must also use the RETAIN policy with this value.</p>
</li>
<li>
<p><code>USE_DEFAULT_SERVANT</code> If the Object ID is not listed in the Active Object Map or the <code>NON_RETAIN</code> policy is set, the request is dispatched to the default servant.
If no default servant has been registered, an OBJ_ADAPTER exception is returned.
The POA must also use the MULTIPLE_ID policy with this value.</p>
</li>
<li>
<p><code>USE_SERVANT_MANAGER</code> If the Object ID is not listed in the Active Object Map or the <code>NON_RETAIN</code> policy is set, the servant manager is used to obtain a servant.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Implicit Activation policy - specifies whether the POA supports implicit activation of servants.
The Implicit Activation policy can have the following values:</p>
<div class="ulist">
<ul>
<li>
<p><code>IMPLICIT_ACTIVATION</code> The POA supports implicit activation of servants.
Servants can be activated by converting them to an object reference with org.omg.PortableServer.POA.servant_to_reference() or by invoking _this()on the servant.
The POA must also use the SYSTEM_ID and RETAIN policies with this value.</p>
</li>
<li>
<p><code>NO_IMPLICIT_ACTIVATION</code> (Default) The POA does not support implicit activation of servants.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>It appears that to redirect <code>replay_completion</code> invocations to a default servant we need to create a POA with the Request Processing policy assigned with the value set to <code>USE_DEFAULT_SERVANT</code>.
However to reach that default Servant we should first reach the POA that forward the request to the default servant.
Indeed, the ORB uses a set of information to retrieve a POA; these information are contained in the object reference used by the client.
Among these information there are the IP address and the port number where resides the server and also the POA name.
To perform <code>replay_completion</code> invocations, the solution adopted by Narayana is to provide one Servant, per machine, and located in the <code>RecoveryManager</code> process, a separate process from client or server applications.
The next section explains how the indirection to a default Servant located on a separate process is provided for JacORB.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_default_recoverycoordinator_in_jacorb"><a class="anchor" href="#_the_default_recoverycoordinator_in_jacorb"></a>2.2.3. The default <code>RecoveryCoordinator</code> in JacOrb</h4>
<div class="paragraph">
<p>JacORB does not define additional policies to redirect any request on a <code>RecoveryCoordinator</code> object to a default servant located in the Recovery Manager process.
However it provides a set of APIs that allows building object references with specific IP address, port number and POA name in order to reach the appropriate default servant.</p>
</div>
<div class="sect4">
<h5 id="_how_does_it_work"><a class="anchor" href="#_how_does_it_work"></a>How Does it work</h5>
<div class="paragraph">
<p>When the Recovery Manager is launched it seeks in the configuration the <code>RecoveryActivator</code> that need be loaded.
Once done it invokes the <code>startRCservice</code> method of each loaded instances.
As seen in in the previous chapter (Recovery Manager ) the class to load that implements the <code>RecoveryActivator</code> interface is the class <code>RecoveryEnablement</code>.
This generic class, located in the package <code>com.arjuna.ats.internal.jts.orbspecific.recovery</code>, hides the nature of the ORB being used by the application (JacORB).
The following figure illustrates the behavior of the <code>RecoveryActivator</code> that leads to the creation of the default servant that performs <code>replay_completion</code> invocations requests.</p>
</div>
<div class="paragraph">
<p>In addition to the creation of the default servant, an object reference to a <code>RecoveryCoordinator</code> object is created and stored in the ObjectStore.
As we will see this object reference will be used to obtain its IP address, port number and POA name and assign them to any <code>RecoveryCoordinator</code> object reference created on register_resource.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/failure-recovery-fig5-recoverymanager.png" alt="failure recovery fig5 recoverymanager">
</div>
<div class="title">Figure 8. Recovery Manager</div>
</div>
<div class="paragraph">
<p>When an application registers a resource with a transaction, a <code>RecoveryCoordinator</code> object reference is expected to be returned.
To build that object reference, the Transaction Service uses the <code>RecoveryCoordinator</code> object reference created within the Recovery Manager as a template.
The new object reference contains practically the same information to retrieve the default servant (IP address, port number, POA name, etc.), but the Object ID is changed; now, it contains the Transaction ID of the transaction in progress and also the Process ID of the process that is creating the new <code>RecoveryCoordinator</code> object reference, as illustrated in <a href="#resource_registration">Resource registration and returned <code>RecoveryCoordinator</code> Object reference build from a referencestored in the ObjectStore.</a>.</p>
</div>
<div id="resource_registration" class="imageblock text-center">
<div class="content">
<img src="images/failure-recovery-fig6-resourceregistration.png" alt="failure recovery fig6 resourceregistration">
</div>
<div class="title">Figure 9. Resource registration and returned <code>RecoveryCoordinator</code> Object reference build from a referencestored in the ObjectStore.</div>
</div>
<div class="paragraph">
<p>Since a <code>RecoveryCoordintaor</code> object reference returned to an application contains all information to retrieve the POA then the default servant located in the Recovery Manager, all <code>replay_completion</code> invocation, per machine, are forwarded to the same default <code>RecoveryCoordinator</code> that is able to retreive the Object ID from the incoming request to extract the transaction identifier and the process identifier needed to determine the status of the requested transaction.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_options"><a class="anchor" href="#_configuration_options"></a>2.3. Configuration Options</h3>
<div class="sect3">
<h4 id="_recovery_protocol_in_ots_overview_2"><a class="anchor" href="#_recovery_protocol_in_ots_overview_2"></a>2.3.1. Recovery Protocol in OTS - Overview</h4>
<div class="paragraph">
<p>Narayana is highly configurable.
For full details of the configuration mechanism used, see the Programmer&#8217;s Guide.</p>
</div>
<div class="paragraph">
<p>The following table shows the configuration features, with default values shown in italics.
More details about each option can be found in the relevant sections of this document.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You need to prefix each property in this table with the string <code>com.arjuna.ats.arjuna.recovery</code>.
The prefix has been removed for formatting reasons, and has been replaced by &#8230;&#8203;</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration Name</th>
<th class="tableblock halign-left valign-top">Possible Values</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8230;&#8203;periodicRecoveryPeriod</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">120/any positive integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval between recovery attempts, in seconds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8230;&#8203;recoveryBackoffPeriod</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10/any positive integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval between first and second recovery passes, in seconds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8230;&#8203;periodicRecoveryInitilizationOffset</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0/any non-negative integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval before first recovery pass, in seconds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8230;&#8203;expiryScanInterval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12/any integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval between expiry scans, in hours. 0 disables scanning.
Negative values postpone the first run.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8230;&#8203;transactionStatusManagerExpiryTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12/any positive integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval after which a non-contactable process is considered dead.
0 = never.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_development_guide"><a class="anchor" href="#_development_guide"></a>3. Development Guide</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_transactions"><a class="anchor" href="#_transactions"></a>3.1. Transactions</h3>
<div class="paragraph">
<p>A transaction is a unit of work that encapsulates multiple database actions such that that either all the encapsulated actions fail or all succeed.</p>
</div>
<div class="paragraph">
<p>Transactions ensure data integrity when an application interacts with multiple datasources.</p>
</div>
<div class="sect3">
<h4 id="_the_java_transaction_api_jakarta_transactions"><a class="anchor" href="#_the_java_transaction_api_jakarta_transactions"></a>3.1.1. The Java Transaction API (Jakarta Transactions)</h4>
<div class="paragraph">
<p>The interfaces specified by the many transaction standards tend to be too low-level for most application programmers.
Therefore, Sun Microsystems created the Java Transaction API (JTA), which specifies higher-level interfaces to assist in the development of distributed transactional applications.
JTA was later renamed Jakarta Transactions and the specification is maintained at <a href="https://jakarta.ee/specifications/transactions" class="bare">https://jakarta.ee/specifications/transactions</a>.</p>
</div>
<div class="paragraph">
<p>Note, these interfaces are still low-level.
You still need to implement state management and concurrency for transactional applications.
The interfaces are also optimized for applications which require XA resource integration capabilities, rather than the more general resources which other transactional APIs allow.</p>
</div>
<div class="paragraph">
<p>With reference to Jakarta Transactions (<a href="https://jakarta.ee/specifications/transactions/" class="bare">https://jakarta.ee/specifications/transactions/</a>), distributed transaction services typically involve a number of participants:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">application server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">provides the infrastructure required to support the application run-time environment which includes transaction state management, such as an EJB server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">transaction manager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">provides the services and management functions required to support transaction demarcation, transactional resource management, synchronization, and transaction context propagation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource manager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using a <em>resource adapter</em>, provides the application with access to resources.
The resource manager participates in distributed transactions by implementing a transaction resource interface used by the transaction manager to communicate transaction association, transaction completion and recovery.</p>
<p class="tableblock">A resource adapter is used by an application server or client to connect to a Resource Manager.
JDBC drivers which are used to connect to relational databases are examples of Resource Adapters.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">communication resource manager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">supports transaction context propagation and access to the transaction service for incoming and outgoing requests.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>From the point of view of the transaction manager, the actual implementation of the transaction services does not need to be exposed.
You only need to define high-level interfaces to allow transaction demarcation, resource enlistment, synchronization and recovery process to be driven from the users of the transaction services.
Jakarta Transactions is a high-level application interface that allows a transactional application to demarcate transaction boundaries, and also contains a mapping of the X/Open XA protocol.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Compatibility</div>
<div class="paragraph">
<p>the Jakarta Transactions support provided by Narayana is compliant with the 1.1 specification.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_introducing_the_api"><a class="anchor" href="#_introducing_the_api"></a>3.1.2. Introducing the API</h4>
<div class="paragraph">
<p>The Java Transaction API consists of three elements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a high-level application transaction demarcation interface</p>
</li>
<li>
<p>a high-level transaction manager interface intended for application server</p>
</li>
<li>
<p>a standard Java mapping of the X/Open XA protocol intended for a transactional resource manager.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of the Jakarta Transactions classes and interfaces exist within the <code>jakarta.transaction</code> package, and the corresponding Narayana implementations within the <code>com.arjuna.ats.jta</code> package.
Note that XA resource API classes are still part of the Java SE (<a href="https://jakarta.ee/specifications/transactions/2.0/jakarta-transactions-spec-2.0.html#relationship-to-other-java-apis" class="bare">https://jakarta.ee/specifications/transactions/2.0/jakarta-transactions-spec-2.0.html#relationship-to-other-java-apis</a>)</p>
</div>
<div class="paragraph">
<p>Each Xid created by Narayana needs a unique node identifier encoded within it, because Narayana can only recover transactions and states that match a specified node identifier.
The node identifier to use should be provided to Narayana via the <code>CoreEnvironmentBean.nodeIdentifier</code> property.
This value must be unique across your Narayana instances.
The identifier is alphanumeric and limited to 10 bytes in length.
If you do not provide a value, then Narayana generates one and reports the value via the logging infrastructure.</p>
</div>
</div>
<div class="sect3">
<h4 id="usertransaction_definition"><a class="anchor" href="#usertransaction_definition"></a>3.1.3. UserTransaction</h4>
<div class="paragraph">
<p>The <code>UserTransaction</code> interface provides applications with the ability to control transaction boundaries.
It provides methods <code>begin</code>, <code>commit</code>, and <code>rollback</code> to operate on top-level transactions.</p>
</div>
<div class="paragraph">
<p>Nested transactions are not supported, and method <code>begin</code> throws the exception <code>NotSupportedException</code> if the calling thread is already associated with a transaction.
<code>UserTransaction</code> automatically associates newly created transactions with the invoking thread.</p>
</div>
<div class="paragraph">
<p>To obtain a <code>UserTransaction</code>, call the static method <code>com.arjuna.ats.jta.UserTransaction.userTransaction()</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Selecting the local Jakarta Transactions Implementation</div>
<ol class="arabic">
<li>
<p>Set property <code>JTAEnvironmentBean.jtaTMImplementation</code> to `com.arjuna.ats.internal.jta.transaction.arjunacore.TransactionManagerImple `.</p>
</li>
<li>
<p>Set property <code>JTAEnvironmentBean.jtaUTImplementation</code> to <code>com.arjuna.ats.internal.jta.transaction.arjunacore.UserTransactionImple</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_transactionmanager"><a class="anchor" href="#_transactionmanager"></a>3.1.4. TransactionManager</h4>
<div class="paragraph">
<p>The <code>TransactionManager</code> interface allows the application server to control transaction boundaries on behalf of the application being managed.</p>
</div>
<div class="paragraph">
<p>To obtain a <code>TransactionManager</code>, invoke the static method <code>com.arjuna.ats.jta.TransactionManager.transactionManager</code>.</p>
</div>
<div class="paragraph">
<p>The <code>TransactionManager</code> maintains the transaction context association with threads as part of its internal data structure.
A thread&#8217;s transaction context may be <code>null</code> or it may refer to a specific global transaction.
Multiple threads may be associated with the same global transaction.
As noted in <a href="#usertransaction_definition">UserTransaction</a>, nested transactions are not supported.</p>
</div>
<div class="paragraph">
<p>Each transaction context is encapsulated by a Transaction object, which can be used to perform operations which are specific to the target transaction, regardless of the calling thread&#8217;s transaction context.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. `TransactionManager`Methods</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>begin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starts a new top-level transaction and associates the transaction context with the calling thread.
If the calling thread is already associated with a transaction, exception <code>NotSupportedException</code> is thrown.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getTransaction</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the Transaction object representing the transaction context which is currently associated with the calling thread.
You can use this object to perform various operations on the target transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>commit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Completes the transaction currently associated with the calling thread.
After it returns, the calling thread is associated with no transaction.
If <code>commit</code> is called when the thread is not associated with any transaction context, an exception is thrown.
In some implementations, the <code>commit</code> operation is restricted to the transaction originator only.
If the calling thread is not allowed to commit the transaction, an exception is thrown.
Narayana does not currently impose any restriction on the ability of threads to terminate transactions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollback</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rolls back the transaction associated with the current thread.
After the <code>rollback</code> method completes, the thread is associated with no transaction.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In a multi-threaded environment, multiple threads may be active within the same transaction.
If checked transaction semantics have been disabled, or the transaction times out, a transaction may terminated by a thread other than the one that created it.
In this case, the creator usually needs to be notified.
Narayana notifies the creator during operations <code>commit</code> or <code>rollback</code> by throwing exception <code>IllegalStateException</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_suspend_and_resuming_a_transaction"><a class="anchor" href="#_suspend_and_resuming_a_transaction"></a>3.1.5. Suspend and resuming a transaction</h4>
<div class="paragraph">
<p>Jakarta Transactions supports the concept of a thread temporarily suspending and resuming transactions in order to perform non-transactional work.
Call the <code>suspend</code> method to temporarily suspend the current transaction that is associated with the calling thread.
The thread then operates outside of the scope of the transaction.
If the thread is not associated with any transaction, a <code>null</code> object reference is returned.
Otherwise, a valid <code>Transaction</code> object is returned.
Pass the <code>Transaction</code> object to the <code>resume</code> method to reinstate the transaction context.</p>
</div>
<div class="paragraph">
<p>The <code>resume</code> method associates the specified transaction context with the calling thread.
If the transaction specified is not a valid transaction, the thread is associated with no transaction.
if <code>resume</code> is invoked when the calling thread is already associated with another transaction, the <code>IllegalStateException</code> exception is thrown.</p>
</div>
<div class="listingblock">
<div class="title">Using the `suspend`method</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Transaction tobj = TransactionManager.suspend();
..
        TransactionManager.

resume(tobj);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Narayana allows a suspended transaction to be resumed by a different thread.
This feature is not required by Jakarta Transactions, but is an important feature.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When a transaction is suspended, the application server must ensure that the resources in use by the application are no longer registered with the suspended transaction.
When a resource is de-listed this triggers the Transaction Manager to inform the resource manager to disassociate the transaction from the specified resource object.
When the application&#8217;s transaction context is resumed, the application server must ensure that the resources in use by the application are again enlisted with the transaction.
Enlisting a resource as a result of resuming a transaction triggers the Transaction Manager to inform the resource manager to re-associate the resource object with the resumed transaction.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_transaction_interface"><a class="anchor" href="#_the_transaction_interface"></a>3.1.6. The Transaction interface</h4>
<div class="paragraph">
<p>The <code>Transaction</code> interface allows you to perform operations on the transaction associated with the target object.
Every top-level transaction is associated with one <code>Transaction</code> object when the transaction is created.</p>
</div>
<div class="ulist">
<div class="title">Uses of the `Transaction`object</div>
<ul>
<li>
<p>enlist the transactional resources in use by the application.</p>
</li>
<li>
<p>register for transaction synchronization call backs.</p>
</li>
<li>
<p>commit or rollback the transaction.</p>
</li>
<li>
<p>obtain the status of the transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>commit</code> and <code>rollback</code> methods allow the target object to be committed or rolled back.
The calling thread does not need to have the same transaction associated with the thread.
If the calling thread is not allowed to commit the transaction, the transaction manager throws an exception.
At present Narayana does not impose restrictions on threads terminating transactions.</p>
</div>
<div class="paragraph">
<p>Jakarta Transactions does not provide a means to obtain the transaction identifier.
However, Narayana provides several ways to view the transaction identifier.
Call method <code>toString</code> to print full information about the transaction, including the identifier.
Alternatively you can cast the <code>jakarta.transaction.Transaction</code> instance to a <code>com.arjuna.ats.jta.transaction.Transaction</code>, then call either method <code>get_uid</code>, which returns an ArjunaCore <code>Uid</code> representation, or <code>getTxId</code>, which returns an <code>Xid</code> for the global identifier, i.e., no branch qualifier.</p>
</div>
</div>
<div class="sect3">
<h4 id="_resource_enlistment"><a class="anchor" href="#_resource_enlistment"></a>3.1.7. Resource enlistment</h4>
<div class="paragraph">
<p>Typically, an application server manages transactional resources, such as database connections, in conjunction with some resource adapter and optionally with connection pooling optimization.
For an external transaction manager to coordinate transactional work performed by the resource managers, the application server must enlist and de-list the resources used in the transaction.
These resources, called <em>participants</em>, are enlisted with the transaction so that they can be informed when the transaction terminates, by being driven through the two-phase commit protocol.</p>
</div>
<div class="paragraph">
<p>As stated previously, Jakarta Transactions is much more closely integrated with the XA concept of resources than the arbitrary objects.
For each resource the application is using, the application server invokes the <code>enlistResource</code> method with an <code>XAResource</code> object which identifies the resource in use.</p>
</div>
<div class="paragraph">
<p>The enlistment request causes the transaction manager to inform the resource manager to start associating the transaction with the work performed through the corresponding resource.
The transaction manager passes the appropriate flag in its <code>XAResource.start</code> method call to the resource manager.</p>
</div>
<div class="paragraph">
<p>The <code>delistResource</code> method disassociates the specified resource from the transaction context in the target object.
The application server invokes the method with the two parameters: the <code>XAResource</code> object that represents the resource, and a flag to indicate whether the operation is due to the transaction being suspended (<code>TMSUSPEND</code>), a portion of the work has failed (<code>TMFAIL</code>), or a normal resource release by the application (<code>TMSUCCESS</code>).</p>
</div>
<div class="paragraph">
<p>The de-list request causes the transaction manager to inform the resource manager to end the association of the transaction with the target <code>XAResource</code>. The flag value allows the application server to indicate whether it intends to come back to the same resource whereby the resource states must be kept intact.
The transaction manager passes the appropriate flag value in its <code>XAResource.end</code> method call to the underlying resource manager.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_synchronization"><a class="anchor" href="#_transaction_synchronization"></a>3.1.8. Transaction synchronization</h4>
<div class="paragraph">
<p>Transaction synchronization allows the application server to be notified before and after the transaction completes.
For each transaction started, the application server may optionally register a <code>Synchronization</code> call-back object to be invoked by the transaction manager, which will be one of the following:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>beforeCompletion</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Called before the start of the two-phase transaction complete process.
This call is executed in the same transaction context of the caller who initiates the <code>TransactionManager.commit</code> or the call is executed with no transaction context if <code>Transaction.commit</code> is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>afterCompletion</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Called after the transaction completes.
The status of the transaction is supplied in the parameter.
This method is executed without a transaction context.</p>
<p class="tableblock">NOTE: If an XAResource throws a RuntimeException, this method will not be called as the transaction has not and cannot complete.
Please see JBTM-2148 for more details.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_transaction_equality"><a class="anchor" href="#_transaction_equality"></a>3.1.9. Transaction equality</h4>
<div class="paragraph">
<p>The transaction manager implements the <code>Transaction</code> object&#8217;s <code>equals</code> method to allow comparison between the target object and another <code>Transaction</code> object.
The <code>equals</code> method returns <code>true</code> if the target object and the parameter object both refer to the same global transaction.</p>
</div>
<div class="listingblock">
<div class="title">Method <code>equals</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Transaction txObj = TransactionManager.getTransaction();
Transaction someOtherTxObj = ..
        ..

boolean isSame = txObj.equals(someOtherTxObj);      </code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_transactionsynchronizationregistry"><a class="anchor" href="#_transactionsynchronizationregistry"></a>3.1.10. TransactionSynchronizationRegistry</h4>
<div class="paragraph">
<p>The <code>jakarta.transaction.TransactionSynchronizationRegistry</code> interface, added to the Jakarta Transactions API in version 1.1, provides for registering Synchronizations with special ordering behavior, and for storing key-value pairs in a per-transaction Map.
Full details are available in the Jakarta Transactions API specification and javadoc.
Here we focus on implementation specific behavior.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Accessing the <code>TransactionSynchronizationRegistry</code> in standalone environments</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jakarta.transaction.TransactionSynchronizationRegistry tsr = <span class="keyword">new</span> com.arjuna.ats.internal.jta.transaction.arjunacore.TransactionSynchronizationRegistryImple();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a stateless object and hence is cheap to instantiate.</p>
</div>
</div>
</div>
<div class="paragraph">
<div class="title">Accessing the TransactionSynchronizationRegistry via JNDI</div>
<p>In application server environments, the standard JNDI name binding is <code>java:comp/TransactionSynchronizationRegistry</code>.</p>
</div>
<div class="paragraph">
<p>Ordering of interposed Synchronizations is relative to other local Synchronizations only.
In cases where the transaction is distributed over multiple JVMs, global ordering is not guaranteed.</p>
</div>
<div class="paragraph">
<p>The per-transaction data storage provided by the <code>TransactionSynchronizationRegistry</code> methods <code>getResource</code> and <code>putResource</code> are non-persistent and thus not available in <code>Transactions</code> during crash recovery.
When running integrated with an application server or other container, this storage may be used for system purposes.
To avoid collisions, use an application-specific prefix on map keys, such as <code>put("myapp_"+key, value)</code>.
The behavior of the <code>Map</code> on <code>Thread</code> s that have status <code>NO_TRANSACTION</code> or where the transaction they are associated with has been rolled back by another <code>Thread</code>, such as in the case of a timeout, is undefined.
A <code>Transaction</code> can be associated with multiple <code>Thread`s.
For such cases the `Map</code> is synchronized to provide thread safety.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_resource_manager"><a class="anchor" href="#_the_resource_manager"></a>3.2. The Resource Manager</h3>
<div class="sect3">
<h4 id="_the_xaresource_interface"><a class="anchor" href="#_the_xaresource_interface"></a>3.2.1. The <code>XAResource</code> interface</h4>
<div class="paragraph">
<p>Some transaction specifications and systems define a generic resource which can be used to register arbitrary resources with a transaction, the JTA is much more XA-specific.
Interface <code>javax.transaction.xa.XAResource</code> is a Java mapping of the XA interface.
The <code>XAResource</code> interface defines the contract between a <code>ResourceManager</code> and a <code>TransactionManager</code> in a distributed transaction processing environment.
A resource adapter for a <code>ResourceManager</code> implements the <code>XAResource</code> interface to support association of a top-level transaction to a resource such as a relational database.</p>
</div>
<div class="paragraph">
<p>The <code>XAResource</code> interface can be supported by any transactional resource adapter designed to be used in an environment where transactions are controlled by an external transaction manager, such a database management system.
An application may access data through multiple database connections.
Each database connection is associated with an <code>XAResource</code> object that serves as a proxy object to the underlying <code>ResourceManager</code> instance.
The transaction manager obtains an <code>XAResource</code> for each <code>ResourceManager</code> participating in a top-level transaction.
The <code>start</code> method associates the transaction with the resource, and the <code>end</code> method disassociates the transaction from the resource.</p>
</div>
<div class="paragraph">
<p>The <code>ResourceManager</code> associates the transaction with all work performed on its data between invocation of <code>start</code> and <code>end</code> methods.
At transaction commit time, these transactional <code>ResourceManager</code> s are informed by the transaction manager to prepare, commit, or roll back the transaction according to the two-phase commit protocol.</p>
</div>
<div class="paragraph">
<p>For better Java integration, the <code>XAResource</code> differs from the standard <code>XA</code> interface in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The resource adapter implicitly initializes the <code>ResourceManager</code> when the resource (the connection) is acquired.
There is no equivalent to the <code>xa_open</code> method of the interface <code>XA</code>.</p>
</li>
<li>
<p><code>Rmid</code> is not passed as an argument.
Each <code>Rmid</code> is represented by a separate <code>XAResource</code> object.</p>
</li>
<li>
<p>Asynchronous operations are not supported, because Java supports multi-threaded processing and most databases do not support asynchronous operations.</p>
</li>
<li>
<p>Error return values caused by the transaction manager&#8217;s improper handling of the <code>XAResource</code> object are mapped to Java exceptions via the <code>XAException</code> class.</p>
</li>
<li>
<p>The DTP concept of Thread of Control maps to all Java threads that are given access to the <code>XAResource</code> and <code>Connection</code> objects.
For example, it is legal for two different threads to perform the <code>start</code> and <code>end</code> operations on the same <code>XAResource</code> object.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_extended_xaresource_control"><a class="anchor" href="#_extended_xaresource_control"></a>Extended <code>XAResource</code> control</h5>
<div class="paragraph">
<p>By default, whenever an <code>XAResource</code> object is registered with a JTA-compliant transaction service, there is no way to manipulate the order in which it is invoked during the two-phase commit protocol, with respect to other <code>XAResource</code> objects.
Narayana, however, provides support for controlling the order via the two interfaces <code>com.arjuna.ats.jta.resources.StartXAResource</code> and <code>com.arjuna.ats.jta.resources.EndXAResource</code>.
By inheriting your <code>XAResource</code> instance from either of these interfaces, you control whether an instance of your class is invoked first or last, respectively.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Only one instance of each interface type may be registered with a specific transaction.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <em>ArjunaCore Development Guide</em> discusses the <em>Last Resource Commit optimization (LRCO)</em>, whereby a single resource that is only one-phase aware, and does not support the <code>prepare</code> phase, can be enlisted with a transaction that is manipulating two-phase aware participants.
This optimization is also supported within the Narayana.</p>
</div>
<div class="paragraph">
<p>In order to use the LRCO, your <code>XAResource</code> implementation must extend the <code>com.arjuna.ats.jta.resources.LastResourceCommitOptimisation</code> marker interface.
A marker interface is an interface which provides no methods.
When enlisting the resource via method <code>Transaction.enlistResource</code>, Narayana ensures that only a single instance of this type of participant is used within each transaction.
Your resource is driven last in the commit protocol, and no invocation of method <code>prepare</code> occurs.</p>
</div>
<div class="paragraph">
<p>By default an attempt to enlist more than one instance of a <code>LastResourceCommitOptimisation</code> class will fail and false will be returned from <code>Transaction.enlistResource</code>.
This behavior can be overridden by setting the <code>com.arjuna.ats.jta.allowMultipleLastResources</code> to true.
However, before doing so you should read the section on enlisting multiple one-phase aware resources.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You need to disable interposition support to use the LCRO in a distributed environment.
You can still use implicit context propagation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="_enlisting_multiple_one_phase_aware_resources"><a class="anchor" href="#_enlisting_multiple_one_phase_aware_resources"></a>Enlisting multiple one-phase-aware resources</h6>
<div class="paragraph">
<p>One-phase commit is used to process a single one-phase aware resource, which does not conform to the two-phase commit protocol.
You can still achieve an atomic outcome across resources, by using the LRCO, as explained earlier.</p>
</div>
<div class="paragraph">
<p>Multiple one-phase-aware resources may be enlisted in the same transaction.
One example is when a legacy database runs within the same transaction as a legacy JMS implementation.
In such a situation, you cannot achieve atomicity of transaction outcome across multiple resources, because none of them enter the <code>prepare</code> state.
They commit or roll back immediately when instructed by the transaction coordinator, without knowledge of other resource states and without a way to undo if subsequent resources make a different choice.
This can result in data corruption or heuristic outcomes.</p>
</div>
<div class="paragraph">
<p>You can approach these situations in two different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Wrap the resources in compensating transactions.
See the <em>XTS Transactions Development Guide</em> for details.</p>
</li>
<li>
<p>Migrate the legacy implementations to two-phase aware equivalents.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If neither of these options is viable, Narayana support enlisting multiple one-phase aware resources within the same transaction, using LRCO, which is discussed in the <em>ArjunaCore Development Guide</em> in detail.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even when this support is enabled, Narayana issues a warning when it detects that the option has been enabled: You have chosen to enable multiple last resources in the transaction manager.
This is transactionally unsafe and should not be relied upon.
Another warning is issued when multiple one-phase aware resources are enlisted within a transaction: This is transactionally unsafe and should not be relied on.</p>
</div>
<div class="paragraph">
<p>To override the above-mentioned warning at runtime, set the <code>CoreEnvironmentBean.disableMultipleLastResourcesWarning</code> property to <code>true</code>.
You will see a warning that you have done this when Narayana starts up and see the warning about enlisting multiple one-phase resources only the first time it happens, but after that no further warnings will be output.
You should obviously only consider changing the default value of this property (false) with caution.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_opening_a_resource_manager"><a class="anchor" href="#_opening_a_resource_manager"></a>3.2.2. Opening a resource manager</h4>
<div class="paragraph">
<p>The X/Open <code>XA</code> interface requires the transaction manager to initialize a resource manager, using method <code>xa_open</code>, before invoking any other of the interface&#8217;s methods.
JTA requires initialization of a resource manager to be embedded within the resource adapter that represents the resource manager.
The transaction manager does not need to know how to initialize a resource manager.
It only informs the resource manager about when to start and end work associated with a transaction and when to complete the transaction.
The resource adapter opens the resource manager when the connection to the resource manager is established.</p>
</div>
</div>
<div class="sect3">
<h4 id="_closing_a_resource_manager"><a class="anchor" href="#_closing_a_resource_manager"></a>3.2.3. Closing a resource manager</h4>
<div class="paragraph">
<p>The resource adapter closes a resource manager as a result of destroying the transactional resource.
A transaction resource at the resource adapter level is comprised of two separate objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <code>XAResource</code> object that allows the transaction manager to start and end the transaction association with the resource in use and to coordinate transaction completion process.</p>
</li>
<li>
<p>A connection object that allows the application to perform operations on the underlying resource, such as JDBC operations on an RDBMS.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once opened, the resource manager is kept open until the resource is released explicitly.
When the application invokes the connection&#8217;s <code>close</code> method, the resource adapter invalidates the connection object reference that was held by the application and notifies the application server about the close.
The transaction manager invokes the <code>XAResource.end</code> method to disassociate the transaction from that connection.</p>
</div>
<div class="paragraph">
<p>The close notification triggers the application server to perform any necessary cleanup work and to mark the physical XA connection as free for reuse, if connection pooling is in place.</p>
</div>
</div>
<div class="sect3">
<h4 id="_thread_of_control"><a class="anchor" href="#_thread_of_control"></a>3.2.4. Thread of control</h4>
<div class="paragraph">
<p>The X/Open <code>XA</code> interface specifies that the transaction-association-related <em>xa</em> calls must be invoked from the same thread context.
This <em>thread-of-control</em> requirement does not apply to the object-oriented component-based application run-time environment, in which application threads are dispatched dynamically as methods are invoked.. Different threads may use the same connection resource to access the resource manager if the connection spans multiple method invocation.
Depending on the implementation of the application server, different threads may be involved with the same <code>XAResource</code> object.
The resource context and the transaction context operate independent of thread context.
This creates the possibility of different threads invoking the <code>start</code> and <code>end</code> methods.</p>
</div>
<div class="paragraph">
<p>If the application server allows multiple threads to use a single <code>XAResource</code> object and the associated connection to the resource manager, the application server must ensure that only one transaction context is associated with the resource at any point of time.
Thus the <code>XAResource</code> interface requires the resource managers to support the two-phase commit protocol from any thread context.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_association"><a class="anchor" href="#_transaction_association"></a>3.2.5. Transaction association</h4>
<div class="paragraph">
<p>A transaction is associated with a transactional resource via the <code>start</code> method and disassociated from the resource via the <code>end</code> method.
The resource adapter internally maintains an association between the resource connection object and the <code>XAResource</code> object.
At any given time, a connection is associated with zero or one transaction.
JTA does not support nestedtransactions, so attempting to invoke the <code>start</code> method on a thread that is already associated with a transaction is an error.</p>
</div>
<div class="paragraph">
<p>The transaction manager can Interleave multiple transaction contexts using the same resource, as long as methods <code>start</code> and <code>end</code> are invoked properly for each transaction context switch.
Each time the resource is used with a different transaction, the method <code>end</code> must be invoked for the previous transaction that was associated with the resource, and method <code>start</code> must be invoked for the current transaction context.</p>
</div>
</div>
<div class="sect3">
<h4 id="_externally_controlled_connections"><a class="anchor" href="#_externally_controlled_connections"></a>3.2.6. Externally controlled connections</h4>
<div class="paragraph">
<p>For a transactional application whose transaction states are managed by an application server, its resources must also be managed by the application server so that transaction association is performed properly.
If an application is associated with a transaction, the application must not perform transactional work through the connection without having the connection&#8217;s resource object already associated with the global transaction.
The application server must ensure that the <code>XAResource</code> object in use is associated with the transaction, by invoking the <code>Transaction.enlistResource</code> method.</p>
</div>
<div class="paragraph">
<p>If a server-side transactional application retains its database connection across multiple client requests, the application server must ensure that before dispatching a client request to the application thread, the resource is enlisted with the application&#8217;s current transaction context.
This implies that the application server manages the connection resource usage status across multiple method invocations.</p>
</div>
</div>
<div class="sect3">
<h4 id="_resource_sharing"><a class="anchor" href="#_resource_sharing"></a>3.2.7. Resource sharing</h4>
<div class="paragraph">
<p>When the same transactional resource is used to interleave multiple transactions, the application server must ensure that only one transaction is enlisted with the resource at any given time.
To initiate the transaction commit process, the transaction manager is allowed to use any of the resource objects connected to the same resource manager instance.
The resource object used for the two-phase commit protocol does not need to have been involved with the transaction being completed.</p>
</div>
<div class="paragraph">
<p>The resource adapter must be able to handle multiple threads invoking the <code>XAResource</code> methods concurrently for transaction commit processing.
This is illustrated in <a href="#resource_sharing_example">Resource sharing example</a> .</p>
</div>
<div id="resource_sharing_example" class="exampleblock">
<div class="title">Example 2. Resource sharing example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">XAResource</span> xares = r1.getXAResource();

xares.

start(xid1); <span class="comment">// associate xid1 to the connection</span>

..
        xares.

end(xid1); <span class="comment">// disassociate xid1 to the connection</span>
..
        xares.

start(xid2); <span class="comment">// associate xid2 to the connection</span>
..
<span class="comment">// While the connection is associated with xid2,</span>
<span class="comment">// the TM starts the commit process for xid1</span>
status =xares.

prepare(xid1);
..
        xares.

commit(xid1, <span class="predefined-constant">false</span>);      </code></pre>
</div>
</div>
<div class="paragraph">
<p>A transactional resource <em>r1</em>.
Global transaction <em>xid1</em> is started and ended with r1.
Then a different global transaction <em>xid2</em> is associated with <em>r1</em>.
Meanwhile, the transaction manager may start the two phase commit process for <em>xid1</em> using <em>r1</em> or any other transactional resource connected to the same resource manager.
The resource adapter needs to allow the commit process to be executed while the resource is currently associated with a different global transaction.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_local_and_global_transactions"><a class="anchor" href="#_local_and_global_transactions"></a>3.2.8. Local and global transactions</h4>
<div class="paragraph">
<p>The resource adapter must support the usage of both local and global transactions within the same transactional connection.
Local transactions are started and coordinated by the resource manager internally.
The <code>XAResource</code> interface is not used for local transactions.
When using the same connection to perform both local and global transactions, the following rules apply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The local transaction must be committed or rolled back before a global transaction is started in the connection.</p>
</li>
<li>
<p>The global transaction must be disassociated from the connection before any local transaction is started.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_timeouts"><a class="anchor" href="#_transaction_timeouts"></a>3.2.9. Transaction timeouts</h4>
<div class="paragraph">
<p>You can associate timeout values with transactions in order to control their lifetimes.
If the timeout value elapses before a transaction terminates, by committing or rolling back, the transaction system rolls it back.
The <code>XAResource</code> interface supports a <code>setTransactionTimeout</code> operation, which allows the timeout associated with the current transaction to be propagated to the resource manager and if supported, overrides any default timeout associated with the resource manager.
Overriding the timeout can be useful when long-running transactions may have lifetimes that would exceed the default, and using the default timeout would cause the resource manager to roll back before the transaction terminates, and cause the transaction to roll back as well.</p>
</div>
<div class="paragraph">
<p>If You do not explicitly set a timeout value for a transaction, or you use a value of <code>0</code>, an implementation-specific default value may be used.
In Narayana, property value <code>CoordinatorEnvironmentBean.defaultTimeout</code> represents this implementation-specific default, in seconds.
The default value is 60 seconds.
A value of <code>0</code> disables default transaction timeouts.</p>
</div>
<div class="paragraph">
<p>Unfortunately, imposing the same timeout as the transaction on a resource manager is not always appropriate.
One example is that your business rules may require you to have control over the lifetimes on resource managers without allowing that control to be passed to some external entity.
Narayana supports an all-or-nothing approach to whether or not method <code>setTransactionTimeout</code> is called on <code>XAResource</code> instances.</p>
</div>
<div class="paragraph">
<p>If the <code>JTAEnvironmentBean.xaTransactionTimeoutEnabled</code> property is set to <code>true</code>, which is the default, it is called on all instances.
Otherwise, use the <code>setXATransactionTimeoutEnabled</code> method of <code>com.arjuna.ats.jta.common.Configuration</code> .</p>
</div>
</div>
<div class="sect3">
<h4 id="_dynamic_registration"><a class="anchor" href="#_dynamic_registration"></a>3.2.10. Dynamic registration</h4>
<div class="paragraph">
<p>Dynamic registration is not supported in <code>XAResource</code>. There are two reasons this makes sense.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the Java component-based application server environment, connections to the resource manager are acquired dynamically when the application explicitly requests a connection.
These resources are enlisted with the transaction manager on an as-needed basis.</p>
</li>
<li>
<p>If a resource manager needs to dynamically register its work to the global transaction, you can implement this at the resource adapter level via a private interface between the resource adapter and the underlying resource manager.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_general_transaction_issues"><a class="anchor" href="#_general_transaction_issues"></a>3.3. General Transaction Issues</h3>
<div class="sect3">
<h4 id="_advanced_transaction_issues_with_arjunacore"><a class="anchor" href="#_advanced_transaction_issues_with_arjunacore"></a>3.3.1. Advanced transaction issues with ArjunaCore</h4>
<div class="paragraph">
<p>Atomic actions (transactions) can be used by both application programmers and class developers.
Thus entire operations (or parts of operations) can be made atomic as required by the semantics of a particular operation.
This chapter will describe some of the more subtle issues involved with using transactions in general and ArjunaCore in particular.</p>
</div>
<div class="paragraph">
<p>Note: in the past ArjunaCore was also referred to as TxCore.</p>
</div>
<div class="sect4">
<h5 id="_checking_transactions"><a class="anchor" href="#_checking_transactions"></a>Checking transactions</h5>
<div class="paragraph">
<p>In a multi-threaded application, multiple threads may be associated with a transaction during its lifetime, sharing the context.
In addition, it is possible that if one thread terminates a transaction, other threads may still be active within it.
In a distributed environment, it can be difficult to guarantee that all threads have finished with a transaction when it is terminated.
By default, ArjunaCore will issue a warning if a thread terminates a transaction when other threads are still active within it.
However, it will allow the transaction termination to continue.</p>
</div>
<div class="paragraph">
<p>Other solutions to this problem are possible.
One example would be to block the thread which is terminating the transaction until all other threads have disassociated themselves from the transaction context.
Therefore, ArjunaCore provides the <code>com.arjuna.ats.arjuna.coordinator.CheckedAction</code> class, which allows the thread or transaction termination policy to be overridden.
Each transaction has an instance of this class associated with it, and application programmers can provide their own implementations on a per transaction basis.</p>
</div>
<div class="listingblock">
<div class="title">Class <code>CheckedAction</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CheckedAction</span> {
    <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> check(<span class="type">boolean</span> isCommit, Uid actUid,
                                   <span class="predefined-type">Hashtable</span> list);
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a thread attempts to terminate the transaction and there are active threads within it, the system will invoke the <code>check</code> method on the transaction&#8217;s <em>CheckedAction</em> object.
The parameters to the check method are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">isCommit</dt>
<dd>
<p>Indicates whether the transaction is in the process of committing or rolling back.</p>
</dd>
<dt class="hdlist1">actUid</dt>
<dd>
<p>The transaction identifier.</p>
</dd>
<dt class="hdlist1">list</dt>
<dd>
<p>A list of all of the threads currently marked as active within this transaction.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When <code>check</code> returns, the transaction termination will continue.
Obviously the state of the transaction at this point may be different from that when <code>check</code> was called, e.g., the transaction may subsequently have been committed.</p>
</div>
<div class="paragraph">
<p>A <code>CheckedAction</code> instance is created for each transaction.
As mentioned above, the default implementation simply issues warnings in the presence of multiple threads active on the transaction when it is terminated.
However, a different instance can be provided to each transaction in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the <code>setCheckedAction</code> method on the <code>BasicAction</code> instance.</p>
</li>
<li>
<p>Define an implementation of the <code>CheckedActionFactory</code> interface, which has a single method <code>getCheckedAction</code> (<code>final Uid`txId</code>, <code>final String`actionType</code>) that returns a <code>CheckedAction</code>. The factory class name can then be provided to the Transaction Service at runtime by setting the <code>CoordinatorEnvironmentBean.checkedActionFactory</code> property.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_gathering_statistics"><a class="anchor" href="#_gathering_statistics"></a>Gathering statistics</h5>
<div class="paragraph">
<p>By default, the Transaction Service does not maintain any history information about transactions.
However, by setting the <code>CoordinatorEnvironmentBean.enableStatistics</code> property variable to <code>YES</code>, the transaction service will maintain information about the number of transactions created, and their outcomes.
This information can be obtained during the execution of a transactional application via the <code>com.arjuna.ats.arjuna.coordinator.TxStats</code> class.</p>
</div>
<div class="listingblock">
<div class="title">Class <code>TxStats</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">TxStats</span> {
    <span class="comment">/**
     * @return the number of transactions (top-level and nested) created so far.
     */</span>

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> numberOfTransactions();

    <span class="comment">/**
     * @return the number of nested (sub) transactions created so far.
     * &lt;p&gt;
     * &lt;p&gt;
     * public static int numberOfNestedTransactions();
     * &lt;p&gt;
     * /**
     * @return the number of transactions which have terminated with heuristic
     * outcomes.
     */</span>

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> numberOfHeuristics();

    <span class="comment">/**
     * @return the number of committed transactions.
     */</span>

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> numberOfCommittedTransactions();

    <span class="comment">/**
     * @return the total number of transactions which have rolled back.
     */</span>

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> numberOfAbortedTransactions();

    <span class="comment">/**
     * @return total number of inflight (active) transactions.
     */</span>

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> numberOfInflightTransactions();

    <span class="comment">/**
     * @return total number of transactions rolled back due to timeout.
     */</span>

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> numberOfTimedOutTransactions();

    <span class="comment">/**
     * @return the number of transactions rolled back by the application.
     */</span>

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> numberOfApplicationRollbacks();

    <span class="comment">/**
     * @return number of transactions rolled back by participants.
     */</span>

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> numberOfResourceRollbacks();

    <span class="comment">/**
     * Print the current information.
     */</span>

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> printStatus(java.io.PrintWriter pw);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The class <code>ActionManager</code> gives further information about specific active transactions through the classes <code>getTimeAdded</code>, which returns the time (in milliseconds) when the transaction was created, and <code>inflightTransactions</code>, which returns the list of currently active transactions.</p>
</div>
</div>
<div class="sect4">
<h5 id="_asynchronously_committing_a_transaction"><a class="anchor" href="#_asynchronously_committing_a_transaction"></a>Asynchronously committing a transaction</h5>
<div class="paragraph">
<p>By default, the Transaction Service executes the <code>commit</code> protocol of a top-level transaction in a synchronous manner.
All registered resources will be told to prepare in order by a single thread, and then they will be told to commit or rollback.
This has several possible disadvantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the case of many registered resources, the <code>prepare</code> operating can logically be invoked in parallel on each resource.
The disadvantage is that if an "early" resource in the list of registered resource forces a rollback during <code>prepare</code>, possibly many prepare operations will have been made needlessly.</p>
</li>
<li>
<p>In the case where heuristic reporting is not required by the application, the second phase of the commit protocol can be done asynchronously, since its success or failure is not important.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore, Narayana provides runtime options to enable possible threading optimisations.
By setting the <code>CoordinatorEnvironmentBean.asyncPrepare</code> environment variable to <code>YES</code>, during the <code>prepare</code> phase a separate thread will be created for each registered participant within the transaction.
By setting <code>CoordinatorEnvironmentBean.asyncCommit</code> to <code>YES</code>, a separate thread will be created to complete the second phase of the transaction if knowledge about heuristics outcomes is not required.</p>
</div>
</div>
<div class="sect4">
<h5 id="_transaction_logs"><a class="anchor" href="#_transaction_logs"></a>Transaction Logs</h5>
<div class="paragraph">
<p>Narayana supports a number of different transaction log implementations.
They are outlined below.</p>
</div>
<div class="sect5">
<h6 id="_the_actionstore"><a class="anchor" href="#_the_actionstore"></a>The ActionStore</h6>
<div class="paragraph">
<p>This is the original version of the transaction log as provided in prior releases.
It is simple but slow.
Each transaction has an instance of its own log and they are all written to the same location in the file system</p>
</div>
</div>
<div class="sect5">
<h6 id="_the_hashedactionstore"><a class="anchor" href="#_the_hashedactionstore"></a>The HashedActionStore</h6>
<div class="paragraph">
<p>This implementation is based on the <code>ActionStore</code> but the individual logs are striped across a number of sub-directories to improve performance.
Check the Configuration Options table for how to configure the <code>HashedActionStore</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_logstore"><a class="anchor" href="#_logstore"></a>LogStore</h6>
<div class="paragraph">
<p>This implementation is based on a traditional transaction log.
All transaction states within the same process (VM instance) are written to the same log (file), which is an append-only entity.
When transaction data would normally be deleted, e.g., at the end of the transaction, a delete record is added to the log instead.
Therefore, the log just keeps growing.
Periodically a thread runs to prune the log of entries that have been deleted.</p>
</div>
<div class="paragraph">
<p>A log is initially given a maximum capacity beyond which it cannot grow.
Once this is reached the system will create a new log for transactions that could not be accommodated in the original log.
The new log and the old log are pruned as usual.
During the normal execution of the transaction system there may be an arbitrary number of log instances.
These should be garbage collected by the system (or the recovery sub-system) eventually.</p>
</div>
<div class="paragraph">
<p>Check the Configuration Options table for how to configure the LogStore.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tools"><a class="anchor" href="#_tools"></a>3.4. Tools</h3>
<div class="paragraph">
<p>This chapter describes the various tools for managing transactions.</p>
</div>
<div class="sect3">
<h4 id="_objectstore_command_line_browsers_and_editors"><a class="anchor" href="#_objectstore_command_line_browsers_and_editors"></a>3.4.1. ObjectStore command-line browsers and editors</h4>
<div class="paragraph">
<p>There are currently three command-line editors for manipulating the ObjectStore.
These tools are used to manipulate the lists of heuristic participants maintained by a transaction log.
They allow a heuristic participant to be moved from that list back to the list of prepared participants so that transaction recovery may attempt to resolve them automatically.</p>
</div>
<div class="sect4">
<h5 id="_browse_and_manage_transactions_using_an_application_server"><a class="anchor" href="#_browse_and_manage_transactions_using_an_application_server"></a>Browse and Manage Transactions Using an Application Server</h5>
<div class="paragraph">
<p>The WildFly Application Server provides a command-line based Management CLI which supports the ability to browse and manipulate transaction records.
This functionality is provided by the interaction between the Transaction Manager &#8482; and the Management API of the application server.
To start the CLI on a non-windows based OS type the following command in application server install directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./bin/jboss-cli.sh --connect controller=IP_ADDRESS</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Windows platforms use the jboss-cli.bat script</p>
</div>
<div class="paragraph">
<p>The transaction manager stores information about each active transaction, and the participants involved in the transaction, in a persistent storage area called the <em>object store</em> . The Management API exposes the object store as a resource called the <code>log-store</code> . An API operation called <code>probe</code> reads the transaction logs and creates a node in the management model corresponding to each log.
These nodes can be inspected using the CLI.
Transaction logs are transient, so these nodes quickly become out of date but you can call the <code>probe</code> command manually whenever you need to refresh the <code>log-store</code>.</p>
</div>
<div id="refresh_log_store" class="paragraph">
<div class="title">Refresh the Log Store</div>
<p>This command refreshes the Log Store for server groups which use the profile <code>default</code> in a managed domain.
For a standalone server, remove the <code>profile=default</code> from the command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">/subsystem=transactions/log-store=log-store/:probe</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">View All Prepared Transactions</div>
<p>To view all prepared transactions, first refresh the log store (see <a href="#refresh_log_store">Refresh the Log Store</a> ), then run the following command, which functions similarly to a filesystem <code>ls</code> command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ls /subsystem=transactions/log-store=log-store/transactions</pre>
</div>
</div>
<div class="paragraph">
<p>Each transaction is shown, along with its unique identifier.
Individual operations can be run against an individual transaction (see <a href="#manage_transaction">Manage a Transaction</a>).</p>
</div>
<div id="manage_transaction" class="dlist">
<div class="title">Manage a Transaction</div>
<dl>
<dt class="hdlist1">View a transaction&#8217;s attributes.</dt>
<dd>
<p>To view information about a transaction, such as its JNDI name, EIS product name and version, or its status, use the <code>:read-resource</code> CLI command.</p>
<div class="listingblock">
<div class="content">
<pre>/subsystem=transactions/log-store=log-store/transactions=0\:ffff7f000001\:-b66efc2\:4f9e6f8f\:9:read-resource</pre>
</div>
</div>
</dd>
<dt class="hdlist1">View the participants of a transaction.</dt>
<dd>
<p>Each transaction log contains a child element called <code>participants</code>. Use the <code>read-resource</code> CLI command on this element to see the participants of the transaction.
Participants are identified by their JNDI names (or some other unique identifier if the JNDI name is not available).</p>
<div class="listingblock">
<div class="content">
<pre>/subsystem=transactions/log-store=log-store/transactions=0\:ffff7f000001\:-b66efc2\:4f9e6f8f\:9/participants=java\:\/JmsXA:read-resource</pre>
</div>
</div>
<div class="paragraph">
<p>The result may look similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
   "outcome" =&gt; "success",
   "result" =&gt; {
       "eis-product-name" =&gt; "HornetQ",
       "eis-product-version" =&gt; "2.0",
       "jndi-name" =&gt; "java:/JmsXA",
       "status" =&gt; "HEURISTIC_HAZARD",
       "type" =&gt; "/StateManager/AbstractRecord/XAResourceRecord"
   }
}</pre>
</div>
</div>
<div class="paragraph">
<p>The outcome status shown here is in a <code>HEURISTIC_HAZARD</code> state and is eligible for recovery.
Refer to <a href="#recover_transaction_participant">[recover_transaction_participant]</a> for more details.</p>
</div>
</dd>
<dt class="hdlist1">Delete a transaction.</dt>
<dd>
<p>Each transaction log supports a <code>:delete</code> operation, to delete the transaction log representing the transaction.</p>
<div class="listingblock">
<div class="content">
<pre>/subsystem=transactions/log-store=log-store/transactions=0\:ffff7f000001\:-b66efc2\:4f9e6f8f\:9:delete</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If failures occur, transaction logs may remain in the object store until crash recovery facilities have resolved the transactions they represent.
Therefore, it is very important that the contents of the object store are not deleted inadvertently, as this will make it impossible to resolve in-doubt transactions.
In addition, if multiple users share the same object store, they must understand that it is not an exclusive resource, and not delete transaction logs without careful consideration.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1">Delete a transaction participant.</dt>
<dd>
<p>Each transaction log participant supports a <code>:delete</code> operation which will delete the participant log that represents the participant:</p>
<div class="listingblock">
<div class="content">
<pre>/subsystem=transactions/log-store=log-store/transactions=0\:ffff7f000001\:-b66efc2\:4f9e6f8f\:9/participants=0\:ffff7f000001\:-f30b80c\:58480e0a\:2c:delete</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Normally you would leave participant log management to the transaction log that owns it or to the recovery system.
However, this delete operation for participant logs is provided for those cases where you know it is safe to do so and, in the case of heuristically completed XA resources, you wish to trigger a forget call so that the XA resource vendors' logs are cleaned correctly.
By default, if this forget call fails then the delete operation will still succeed.
The system administrator may override this behaviour by setting a system property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ObjectStoreEnvironmentBean.ignoreMBeanHeuristics</pre>
</div>
</div>
<div class="paragraph">
<p>to the value false.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
<div id="recover_transaction_participant" class="dlist">
<dl>
<dt class="hdlist1">Recover a transaction participant.</dt>
<dd>
<p>Each transaction participant log may support recovery via the <code>:recover</code> CLI command if it is in a heuristic state.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Recovery of Heuristic Transactions and Participants</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the transaction participant&#8217;s status is <code>HEURISTIC</code> or <code>HEURISTIC_HAZARD</code> or <code>HEURISTIC_MIXED</code> then the recover operation changes the state to <code>PREPARE</code> and triggers a recovery attempt by replaying the <code>commit</code> operation.
If successful, the participant is removed from the transaction log.
You can verify this by re-running the <code>:probe</code> operation on the <code>log-store</code> and checking that the participant is no longer listed.
If this is the last participant, the transaction is also deleted.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Refresh the status of a transaction which needs recovery.</dt>
<dd>
<p>If a transaction needs recovery, you can use the <code>:refresh</code> CLI command to be sure it still requires recovery, before attempting the recovery.</p>
<div class="listingblock">
<div class="content">
<pre>/subsystem=transactions/log-store=log-store/transactions=0\:ffff7f000001\:-b66efc2\:4f9e6f8f\:9:refresh</pre>
</div>
</div>
</dd>
</dl>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_browse_and_manage_transactions_using_jmx"><a class="anchor" href="#_browse_and_manage_transactions_using_jmx"></a>Browse and Manage Transactions Using JMX</h5>
<div class="paragraph">
<p>Transaction logs may also be managed using <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jmx">JMX</a>.
Each transaction log record is instrumented as an MBean.
Any JMX client may be used to manage logs using this mechanism.</p>
</div>
<div class="paragraph">
<p>The JMX MBean for the object store contains one method and one attribute.
The <code>probe</code> operation scans the object store creating JMX MBeans for the various log records contained in the store.
The default behaviour is to only create MBeans for particular record types.
If there is a need to view everything in the store then set the <code>ExposeAllRecordsAsMBeans</code> attribute to <code>true</code> Note that transaction logs are transient so these beans quickly become out of date and will not be refreshed automatically so you must invoke the <code>probe</code> operation again to get the current up to date list of MBeans.</p>
</div>
<div class="paragraph">
<p>MBeans can be queried using the standard JMX query mechanism.
ObjectStore Object Names are in the format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>domain:key-property-list</pre>
</div>
</div>
<div class="paragraph">
<p>where domain is <code>jboss.jta</code> and key-property-list is a comma separated list of key=value pairs.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Object Name Keys</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">itype</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction record type</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique id of the transaction record</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">puid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique id of a participant record</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Transaction record</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">jboss.jta:type=ObjectStore,itype=StateManager/BasicAction/TwoPhaseCoordinator/ AtomicAction,uid=0_ffff7f000001_-3a612f5d_53f63052_39</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">A participant record within a transaction</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">jboss.jta:type=ObjectStore,itype=StateManager/BasicAction/TwoPhaseCoordinator/ AtomicAction,uid=0_ffff7f000001_-3a612f5d_53f63052_39,puid= 0_ffff7f000001_-3a612f5d_53f63052_3c</code></pre>
</div>
</div>
<div class="dlist">
<div class="title">Manage a Transaction</div>
<dl>
<dt class="hdlist1">View a transaction&#8217;s attributes.</dt>
<dd>
<p>To view information about a transaction or a transaction participant, such as its JNDI name, EIS product name and version, or its status, use a JMX client or alternatively use the JMX api:</p>
<div class="listingblock">
<div class="content">
<pre>// obtain connection to the MBean server
MBeanServer mbs = ...

// query all ObjectStore MBean instances
ObjectName on = new ObjectName("jboss.jta:type=ObjectStore,*", null);
Set&lt;ObjectInstance&gt; transactions = mbs.queryMBeans(on);

// lookup the attribute names of an ObjectInstance
MBeanInfo info = mbs.getMBeanInfo( oi.getObjectName() );
MBeanAttributeInfo[] attributeArray = info.getAttributes();

// find the values of the attributes of an ObjectInstance
AttributeList attributes = mbs.getAttributes(oi.getObjectName(), attributeNames);</pre>
</div>
</div>
</dd>
<dt class="hdlist1">View the participants of a transaction.</dt>
<dd>
<p>A transaction log may contain one or more participants which can be viewed as MBeans using a JMX client or programmatically as follows:</p>
<div class="listingblock">
<div class="content">
<pre>ObjectInstance transaction = ... //
ObjectName on = transaction.getObjectName();
String participantQuery =  on + ",puid=*";
Set&lt;bjectInstance&gt; participants = mbs.queryMBeans(new ObjectName(participantQuery), null)</pre>
</div>
</div>
<div class="paragraph">
<p>For example the attributes of an XAResource record might look similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>"eis-product-name" =&gt; "HornetQ",
"eis-product-version" =&gt; "2.0",
"jndi-name" =&gt; "java:/JmsXA",
"status" =&gt; "HEURISTIC_HAZARD",
"type" =&gt; "/StateManager/AbstractRecord/XAResourceRecord"</pre>
</div>
</div>
<div class="paragraph">
<p>The status attribute shown in this example is in a <code>HEURISTIC_HAZARD</code> state and is eligible for recovery.
Refer to <a href="#recover_transaction_participant_jmx">[recover_transaction_participant_jmx]</a> for more details.</p>
</div>
</dd>
<dt class="hdlist1">Delete a transaction or transaction participant.</dt>
<dd>
<p>MBeans for transaction logs and participants contain a <code>remove</code> operation.
Invoke this MBean operation to remove the record from the ObjectStore.</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If failures occur, transaction logs may remain in the object store until crash recovery facilities have resolved the transactions they represent.
Therefore, it is very important that the contents of the object store are not deleted inadvertently, as this will make it impossible to resolve in-doubt transactions.
In addition, if multiple users share the same object store, they must understand that it is not an exclusive resource,</p>
</div>
<div class="paragraph">
<p>Normally you would leave participant log management to the transaction log that owns it or to the recovery system.
However, this remove operation for participant logs is provided for those cases where you know it is safe to do so and, in the case of heuristically completed XA resources, you wish to trigger a forget call so that the XA resource vendors' logs are cleaned correctly.
By default, if this forget call fails then the delete operation will still succeed.
The system administrator may override this behaviour by setting a system property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ObjectStoreEnvironmentBean.ignoreMBeanHeuristics</pre>
</div>
</div>
<div class="paragraph">
<p>to the value false.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
<div id="recover_transaction_participant_jmx" class="dlist">
<dl>
<dt class="hdlist1">Recover a transaction.</dt>
<dd>
<p>Transaction participants support recovery via the <code>clearHeuristic</code> operation.</p>
<div class="ulist">
<ul>
<li>
<p>Recovery of Heuristic Participants</p>
<div class="ulist">
<ul>
<li>
<p>If the transaction participant&#8217;s status is <code>HEURISTIC</code> or <code>HEURISTIC_HAZARD</code> or <code>HEURISTIC_MIXED</code> then the clearHeuristic operation changes the state to <code>PREPARED</code>.</p>
</li>
<li>
<p>Subsequent runs of the recovery manager (periodic recovery) will try to replay the <code>commit</code> operation.
If successful, the participant is removed from the transaction log.</p>
</li>
<li>
<p>You can verify the transaction is completed by re-running the <code>probe</code> operation on the <code>ObjectStore</code> MBean.
If this is the last participant, the transaction will have been also deleted.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_logeditor"><a class="anchor" href="#_logeditor"></a>LogEditor</h5>
<div class="paragraph">
<p>The LogEditor tool is started by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java -Dcom.arjuna.ats.arjuna.common.ObjectStoreEnvironmentBean.objectStoreDir=&quot;path to file based object store&quot; com.arjuna.ats.arjuna.tools.log.LogBrowser</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command works with the file based object store.
If you want to work with the Hornetq store instead then you need to specify a different property for the location of the log store and you also need to explicity provide the class name of the Hornetq Object Store:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java -Dcom.arjuna.ats.internal.arjuna.objectstore.hornetq.HornetqJournalEnvironmentBean.storeDir=&quot;directory path&quot; -Dcom.arjuna.ats.arjuna.common.ObjectStoreEnvironmentBean.objectStoreType=&quot;com.arjuna.ats.internal.arjuna.objectstore.hornetq.HornetqObjectStoreAdaptor&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The tool supports the following options that can be provided on the command-line:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. LogEditor Options</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-tx <code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the transaction log to work on.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-type <code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction type to work on.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-dump</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Print out the contents of the log identified by the other options.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-forget <code>index</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Move the specified target from the heuristic list to the prepared list.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-help</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Print out the list of commands and options.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_logbrowser"><a class="anchor" href="#_logbrowser"></a>LogBrowser</h5>
<div class="paragraph">
<p>The LogBrowser, invoked by calling <code>com.arjuna.ats.arjuna.tools.log.LogBrowser</code>, is similar to the LogEditor, but allows multiple log instances to be manipulated.
It presents a shell-like interface, with the following options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. LogBrowserOptions</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ls [<code>type</code>]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List the logs for the specified type.
If no type is specified, the editor must already be attached to the transaction type.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">select [<code>type</code>]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Browse a specific transaction type.
If already attached to a transaction type, you are detached from that type first.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attach <code>log</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Attach the console to the specified transaction log.
If you are attached to another log, the command will fail.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">detach</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Detach the console from the current log.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">forget <code>pid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Move the specified heuristic participant back to the <em>prepared</em> list.
The console must be attached.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete <code>pid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete the specified heuristic participant.
The console must be attached.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List the supported transaction types.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">quit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exit the console tool.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">help</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Print out the supported commands.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_gui_based_tools"><a class="anchor" href="#_gui_based_tools"></a>3.4.2. GUI Based Tools</h4>
<div class="sect4">
<h5 id="_embedded_console"><a class="anchor" href="#_embedded_console"></a>Embedded Console</h5>
<div class="paragraph">
<p>Transaction management is integrated into the WildFly Application Server.</p>
</div>
</div>
<div class="sect4">
<h5 id="_performance_graphing"><a class="anchor" href="#_performance_graphing"></a>Performance Graphing</h5>
<div class="paragraph">
<p>There is a transaction statistics graphing tool which can run standalone or inside a jconsole tab (jconsole is a tool for managing JVMs and is distributed with the reference JDK):</p>
</div>
<div class="paragraph">
<p>The tool depends on the JFree graphing library.
Download and unpack orson from <a href="http://www.jfree.org/orson" class="bare">http://www.jfree.org/orson</a>.
Set the env variable ORSON_HOME to the directory where you plan to unpack the downloaded zip.
If you intend to use the tool with jconsole you will also need to put the JDK tools and jconsole jars on the classpath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">export CLASSPATH=&quot;$JDK_HOME/lib/tools.jar:$JDK_HOME/lib/jconsole.jar:$ORSON_HOME/orson-0.5.0.jar:$ORSON_HOME/lib/jfreechart-1.0.6.jar:$ORSON_HOME/lib/jcommon-1.0.10.jar:$INSTALL_ROOT/lib/narayana-jta.jar&gt;&quot;</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="_standalone_usage"><a class="anchor" href="#_standalone_usage"></a>Standalone Usage</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java com.arjuna.ats.arjuna.tools.stats.TxPerfGraph</code></pre>
</div>
</div>
<div class="paragraph">
<p>(note that standalone usage does not require the JDK tools and jconsole jars)</p>
</div>
</div>
<div class="sect5">
<h6 id="_usage_with_jconsole"><a class="anchor" href="#_usage_with_jconsole"></a>Usage with jconsole</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">jconsole -J-Djava.class.path=&quot;$CLASSPATH&quot; -pluginpath $INSTALL_ROOT/lib/narayana-jta.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will launch the jconsole GUI in which there will be an extra tab for displaying transaction performance statistics.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_view_transaction_statistics_using_an_application_server"><a class="anchor" href="#_view_transaction_statistics_using_an_application_server"></a>3.4.3. View Transaction Statistics using an Application Server</h4>
<div class="paragraph">
<p>If you are using the Transaction Manager &#8482; inside the WildFly Application Server and if the TM statistics are enabled, then you can view statistics about the TM and transaction subsystem using tools provide by the application server.</p>
</div>
<div class="paragraph">
<p>You can view statistics either via the web-based Management Console or the command-line Management CLI.
In the web-based Management Console, Transaction statistics are available via <code><span class="menuseq"><b class="menu">Runtime</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Subsystem Metrics</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Transactions</b></span></code>.
Transaction statistics are available for each server in a managed domain, as well.
You can specify the server in the <code>Server</code> selection box at the top left.</p>
</div>
<div class="paragraph">
<p>The following table shows each available statistic, its description, and the CLI command to view the statistic.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Transaction Subsystem Statistics</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Statistic</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">CLI Command</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The total number of transactions processed by the TM on this server.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/subsystem=transactions/:read-attribute(name=number-of-transactions,include-defaults=true)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Committed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of committed transactions processed by the TM on this server.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/subsystem=transactions/:read-attribute(name=number-of-committed-transactions,include-defaults=true)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aborted</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of aborted transactions processed by the TM on this server.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/subsystem=transactions/:read-attribute(name=number-of-aborted-transactions,include-defaults=true)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timed Out</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of timed out transactions processed by the TM on this server.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/subsystem=transactions/:read-attribute(name=number-of-timed-out-transactions,include-defaults=true)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heuristics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not available in the Management Console.
Number of transactions in a heuristic state.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/subsystem=transactions/:read-attribute(name=number-of-heuristics,include-defaults=true)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">In-Flight Transactions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not available in the Management Console.
Number of transactions which have begun but not yet terminated.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/subsystem=transactions/:read-attribute(name=number-of-inflight-transactions,include-defaults=true)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Failure Origin - Applications</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of failed transactions whose failure origin was an application.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/subsystem=transactions/:read-attribute(name=number-of-application-rollbacks,include-defaults=true)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Failure Origin - Resources</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of failed transactions whose failure origin was a resource.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/subsystem=transactions/:read-attribute(name=number-of-resource-rollbacks,include-defaults=true)</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_options_2"><a class="anchor" href="#_configuration_options_2"></a>3.5. Configuration options</h3>
<div class="sect3">
<h4 id="_loading_a_configuration"><a class="anchor" href="#_loading_a_configuration"></a>3.5.1. Loading a configuration</h4>
<div class="paragraph">
<p>Each module of the system contains a <code>module propertyManager</code> class, which provides static getter methods for one or more <code>name EnvironmentBean</code> classes.
An example is <code>com.arjuna.ats.arjuna.commmon.arjPropertyManager</code>.
These environment beans are standard JavaBean containing properties for each configuration option in the system.
Typical usage is of the form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">int</span> defaultTimeout = arjPropertyManager.getCoordinatorEnvironmentBean().getDefaultTimeout();</code></pre>
</div>
</div>
<div class="paragraph">
<p>These beans are singletons, instantiated upon first access, using the following algorithm.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Algorithm for environment bean instantiation</div>
<ol class="arabic">
<li>
<p>The properties are loaded and populated from a properties file named and located as follows:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If the properties file name property <code>com.arjuna.ats.arjuna.common.propertiesFile</code> is set, its value is used as the file name.</p>
</li>
<li>
<p>If not, the default file name <code>jbossts-properties.xml</code> is used.
The definition of the used value can be found at Narayana distribution jar file under <code>META-INF/MANIFEST.MF</code> at property <code>arjuna-properties-file</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>The file thus named is searched for by, in order</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>absolute path</p>
</li>
<li>
<p><code>user.dir</code></p>
</li>
<li>
<p><code>user.home</code></p>
</li>
<li>
<p><code>java.home</code></p>
</li>
<li>
<p>directories contained on the classpath</p>
</li>
<li>
<p>a default file embedded in the product .jar file</p>
<div class="paragraph">
<p>if you use Narayana dependency <code>org.jboss.narayana.jts:narayana-jts-idlj</code> you can check the default properties settings <a href="https://github.com/jbosstm/narayana/blob/master/ArjunaJTS/narayana-jts-idlj/src/main/resources/jbossts-properties.xml">
in the Narayana repository at github</a>.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>The file is treated as being of standard <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Properties.html">java.util.Properties xml format</a> and loaded accordingly.
The <code>entry</code> names are of the form <code>EnvironmentBeanClass.propertyName</code>.</p>
<div class="paragraph">
<p>An example is <code>&lt;entrykey="CoordinatorEnvironmentBean.commitOnePhase"&gt;YES&lt;/entry&gt;</code></p>
</div>
<div class="paragraph">
<p>In specific cases when you want to set properties on configuration beans other that the default bean instances the form is <code>EnvironmentBeanClass.&lt;storeType&gt;.propertyName</code>.</p>
</div>
<div class="paragraph">
<p>An example is <code>&lt;entry key="ObjectStoreEnvironmentBean.communicationStore.objectStoreType"&gt;</code> <code>com.arjuna.ats.internal.arjuna.objectstore.VolatileStore&lt;/entry&gt;</code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Valid values for Boolean properties are case-insensitive, and may be one of <code>NO</code>/<code>YES</code>, <code>FALSE</code>/<code>TRUE</code>, <code>OFF</code>/<code>ON</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the case of properties that take multiple values, they are white-space-delimited.</p>
</div>
<div class="listingblock">
<div class="title">Example recovery modules of Recovery Environment Bean</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RecoveryEnvironmentBean.recoveryModuleClassNames</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    com.arjuna.ats.internal.arjuna.recovery.AtomicActionRecoveryModule
    com.arjuna.ats.internal.txoj.recovery.TORecoveryModule
<span class="tag">&lt;/entry&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>After the file is loaded, it is cached and is not re-read until the JVM is restarted.
Changes to the properties file require a restart in order to take effect.</p>
</li>
<li>
<p>After the properties are loaded, the EnvironmentBean is then inspected and, for each field, if the properties contains a matching key in the search order as follows, the <code>setter</code> method for that field is invoked with the value from the properties, or the system properties if different.</p>
<div class="ulist">
<ul>
<li>
<p><code>Fully.Qualified.NameEnvironmentBean.propertyName</code></p>
<div class="paragraph">
<p>for example <code>com.arjuna.ats.arjuna.common.CoordinatorEnvironmentBean.commitOnePhase</code></p>
</div>
</li>
<li>
<p><code>NameEnvironmentBean.propertyName</code> (<code>this is the preferred form used in the properties file</code>)</p>
<div class="paragraph">
<p>for example <code>CoordinatorEnvironmentBean.commitOnePhase</code></p>
</div>
</li>
<li>
<p>the old <code>com.arjuna&#8230;&#8203;</code> properties key defined at bean by annnotations <code>@PropertyPrefix</code> or <code>@FullPropertyName</code> (<code class="replaceable">deprecated, for backwards compatibility only</code>).</p>
<div class="paragraph">
<p>for example <code>com.arjuna.ats.arjuna.coordinator.commitOnePhase</code></p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>The bean is then returned to the caller, which may further override values by calling setter methods.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The implementation reads most bean properties only once, as the consuming component or class is instantiated.
This usually happens the first time a transaction is run.
As a result, calling <code>setter</code> methods to change the value of bean properties while the system is running typically has no effect, unless it is done prior to any use of the transaction system.
Altered bean properties are not persisted back to the properties file.</p>
</div>
<div class="paragraph">
<p>You can configure the system using a bean wiring system such as JBoss Microcontainer or Spring.
Take care when instantiating beans, to obtain the singleton via the static getter (factory) method on the module property manager.
Using a new bean instantiated with the default constructor is ineffective, since it is not possible to pass this configured bean back to the property management system.</p>
</div>
</div>
<div class="sect3">
<h4 id="_arjunacore_options"><a class="anchor" href="#_arjunacore_options"></a>3.5.2. ArjunaCore Options</h4>
<div class="paragraph">
<p>The canonical reference for configuration options is the Javadoc of the various <code>EnvironmentBean</code> classes.
For ArjunaCore these are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.arjuna.common.internal.util.logging.LoggingEnvironmentBean</code></p>
</li>
<li>
<p><code>com.arjuna.common.internal.util.logging.basic.BasicLogEnvironmentBean</code></p>
</li>
<li>
<p><code>com.arjuna.ats.txoj.common.TxojEnvironmentBean</code></p>
</li>
<li>
<p><code>com.arjuna.ats.arjuna.common.CoordinatorEnvironmentBean</code></p>
</li>
<li>
<p><code>com.arjuna.ats.arjuna.common.ObjectStoreEnvironmentBean</code></p>
</li>
<li>
<p><code>com.arjuna.ats.arjuna.common.RecoveryEnvironmentBean</code></p>
</li>
<li>
<p><code>com.arjuna.ats.arjuna.common.CoreEnvironmentBean</code></p>
</li>
<li>
<p><code>com.arjuna.ats.internal.arjuna.objectstore.hornetq.HornetqJournalEnvironmentBean</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_narayana_jta_configuration_options"><a class="anchor" href="#_narayana_jta_configuration_options"></a>3.5.3. Narayana JTA Configuration options</h4>
<div class="paragraph">
<p>The canonical reference for configuration options is the javadoc of the various EnvironmentBean classes.
For Narayana JTA, these classes are the ones provided by ArjunaCore, as well as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.arjuna.ats.jdbc.common.JDBCEnvironmentBean</code></p>
</li>
<li>
<p><code>com.arjuna.ats.jta.common.JTAEnvironmentBean</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_narayana_jts_options"><a class="anchor" href="#_narayana_jts_options"></a>3.5.4. Narayana JTS Options</h4>
<div class="paragraph">
<p>The canonical reference for configuration options is the javadoc of the various <code>EnvironmentBean</code> classes.
For Narayana JTS these are the ones provided by ArjunaCore, as well as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.arjuna.orbportability.common.OrbPortabilityEnvironmentBean</code></p>
</li>
<li>
<p><code>com.arjuna.ats.jts.common.JTSEnvironmentBean</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_narayana_ws_atws_ba_options"><a class="anchor" href="#_narayana_ws_atws_ba_options"></a>3.5.5. Narayana WS-AT/WS-BA Options</h4>
<div class="paragraph">
<p>For Narayana WebService transaction protocols these are the ones provided by ArjunaCore, as well as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.jboss.jbossts.xts.environment.WSCEnvironmentBean</code></p>
</li>
<li>
<p><code>org.jboss.jbossts.xts.environment.WSCFEnvironmentBean</code></p>
</li>
<li>
<p><code>org.jboss.jbossts.xts.environment.WSTEnvironmentBean</code></p>
</li>
<li>
<p><code>org.jboss.jbossts.xts.environment.XTSEnvironmentBean</code></p>
</li>
<li>
<p><code>org.jboss.jbossts.xts.environment.RecoveryEnvironmentBean</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_important_log_messages"><a class="anchor" href="#_important_log_messages"></a>3.6. Important Log Messages</h3>
<div class="paragraph">
<p>The transaction manager can generate a lot of logging information when configured to log in trace level.
Here is a list of some of the log messages to check for.</p>
</div>
<div class="sect3">
<h4 id="_transaction_state_change"><a class="anchor" href="#_transaction_state_change"></a>3.6.1. Transaction State Change</h4>
<div class="paragraph">
<p>The following table</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Begin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When a transaction begins the following code is executed:
<code>`
com.arjuna.ats.arjuna.coordinator.BasicAction::Begin:1342</p>
<p class="tableblock">tsLogger.logger.trace("BasicAction::Begin() for action-id "+ get_uid());
</code>`</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Commit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When a transaction commits the following code is executed:
<code>`
com.arjuna.ats.arjuna.coordinator.BasicAction::End:1342</p>
<p class="tableblock">tsLogger.logger.trace("BasicAction::End() for action-id "+ get_uid());
</code>`</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Rollback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When a transaction commits the following code is executed:
<code>`
com.arjuna.ats.arjuna.coordinator.BasicAction::Abort:1575</p>
<p class="tableblock">tsLogger.logger.trace("BasicAction::Abort() for action-id "+ get_uid());
</code>`</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When a transaction times out the following code is executed:
<code>`
com.arjuna.ats.arjuna.coordinator.TransactionReaper::doCancellations:349</p>
<p class="tableblock">tsLogger.logger.trace("Reaper Worker " + Thread.currentThread() + " attempting to cancel " + e._control.get_uid());
</code>`
You will then see the same thread rolling back the transaction as shown above</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are many more logging messages to check for, above are those that we are often asked about.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_multi_cause_log_message"><a class="anchor" href="#_multi_cause_log_message"></a>3.6.2. Multi cause log message</h4>
<div class="paragraph">
<p>The following table shows some log messages that you may see with an explanation of alternate reasons</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INFO  <code>[com.arjuna.ats.arjuna] ObjectStore</code> record was deleted during restoration, users should not deleted records manually</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If you manually deleted a transaction log then this applies to you - you deleted a transaction that was in flight and so may have caused a data integrity issue in so far as one of the resources may be committed and without the log you will not be able to infer this.</p>
<p class="tableblock">If a transaction is committed at the same time as a resource adapter or remote server attempts recovery then you may see the message in the log due to intentional but unavoidable interaction between distributed transaction managers and the local recovery manager.</p>
<p class="tableblock">The log message will indicate the path of the removed file something like:  <strong><strong>/ShadowNoFileLockStore/defaultStore/StateManager/BasicAction/TwoPhaseCoordinator/AtomicAction/SubordinateAtomicAction/JCA/</strong></strong>: java.io.FileNotFoundException: <strong><strong>/ShadowNoFileLockStore/defaultStore/StateManager/BasicAction/TwoPhaseCoordinator/AtomicAction/SubordinateAtomicAction/JCA/</strong></strong> (No such file or directory)</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are many more logging messages to check for, above are those that we are often asked about.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting"><a class="anchor" href="#_troubleshooting"></a>3.7. Troubleshooting</h3>
<div class="paragraph">
<p>This chapter covers issues that you may hit when developing applications with Narayana.</p>
</div>
<div class="sect3">
<h4 id="_ws_ba_participant_completion_race_condition"><a class="anchor" href="#_ws_ba_participant_completion_race_condition"></a>3.7.1. WS-BA Participant-Completion Race Condition</h4>
<div class="paragraph">
<p>The WS-BA participant-completion protocol has a benign race condition that, in unusual circumstances, can cause some Business Activities to be cancelled that would have otherwise been able to close.
This is safe as no inconsistency arrises, but it can be annoying for users.
This section explains why this can happen, under what conditions, and what you can do to tolerate it.</p>
</div>
<div class="sect4">
<h5 id="_whats_happening_in_a_nutshell"><a class="anchor" href="#_whats_happening_in_a_nutshell"></a>What&#8217;s happening, in a nutshell</h5>
<div class="paragraph">
<p>Imagine a scenario where the client begins a business activity and then invokes a Web service.
If the Web service uses participant completion, it will notify the coordinator when it has completed its work and then return control to the client.
This notification is asynchronous, so it&#8217;s possible that the client will then ask the coordinator to close the activity before the coordinator processes (or even receives) the completed notification from the participant.
In this situation the coordinator will cancel the activity as not all participants (from its perspective) have completed their work.
As a result all completed participants are compensated (including, eventually, the participant with the late 'completed' notification) and the client receives a <code>TransactionRolledBackException</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_when_is_it_most_likely_to_happen"><a class="anchor" href="#_when_is_it_most_likely_to_happen"></a>When is it most likely to happen?</h5>
<div class="paragraph">
<p>Typically this happens when the client, coordinator and participant are running inside the same VM.
This scenario is unlikely to happen in production, but can happen regularly during development where a single VM is used to keep things simple.</p>
</div>
</div>
<div class="sect4">
<h5 id="_how_do_i_know_if_this_is_affecting_my_application"><a class="anchor" href="#_how_do_i_know_if_this_is_affecting_my_application"></a>How do I know if this is affecting my application?</h5>
<div class="paragraph">
<p>If the client is occasionally receiving a <code>TransactionRolledbackException</code> when calling <code>UserBusinessActivity#close()</code>, but none of the machines involved in running the transaction have crashed, you could be affected by this.
Especially if you are running the client, coordinator and participant(s) in the same server.</p>
</div>
<div class="paragraph">
<p>The following log message will help you identify this issue:</p>
</div>
<div class="listingblock">
<div class="title">Example Environment Bean</div>
<div class="content">
<pre class="CodeRay highlight"><code>WARN [com.arjuna.mw.wstx] (TaskWorker-2) ARJUNA045062: Coordinator cancelled the activity</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is only an indication that you are seeing this issue as the coordinator can elect to cancel the activity for other reasons.
For example, network problems might mean the coordinator cannot tell the web service to close the activity.</p>
</div>
</div>
<div class="sect4">
<h5 id="_why_cant_it_be_avoided"><a class="anchor" href="#_why_cant_it_be_avoided"></a>Why can&#8217;t it be avoided?</h5>
<div class="paragraph">
<p>For the protocol to avoid this issue, it would need to make the complete message synchronous, throttling throughput by slowing down both the participant and coordinator and holding sockets open for longer.</p>
</div>
</div>
<div class="sect4">
<h5 id="_what_can_the_application_do_to_tolerate_this"><a class="anchor" href="#_what_can_the_application_do_to_tolerate_this"></a>What can the application do to tolerate this?</h5>
<div class="paragraph">
<p>A real, distributed deployment will rarely see this problem because communication latency between client, participant and coordinator will dominate the race condition.
Even if it does happen your application should tolerate it.
Transaction rollbacks and activity cancelations are inevitable in a distributed environment and can happen for many reasons.
When handling <code>TransactionRolledBack</code> exceptions you can either retry the Transaction/Activity or notify the caller of the failure.
What you choose to do will depend on the requirements of your application.</p>
</div>
</div>
<div class="sect4">
<h5 id="_why_exactly_does_this_happen"><a class="anchor" href="#_why_exactly_does_this_happen"></a>Why exactly does this happen?</h5>
<div class="paragraph">
<p>First consider the following client code:</p>
</div>
<div class="listingblock">
<div class="title">Client Code Example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">UserBusinessActivity uba = UserBusinessActivityFactory.userBusinessActivity();
uba.begin();
myWebServiceClient.invoke();
uba.close();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client code is very simple, it just begins a business activity, invokes a Web service and then closes the business activity.
The Web service uses the Participant-Completion protocol and so notifies the coordinator of completion just before returning control to the client.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a diagram showing the pertinent message exchanges that occur under a normal situation.</p>
</div>
<div id="_fig_pcp_race_success" class="imageblock text-center">
<div class="content">
<img src="images/development-guide-fig-pcp-race-success.png" alt="development guide fig pcp race success">
</div>
<div class="title">Figure 10. Successful close of activity</div>
</div>
<div class="paragraph">
<p>The messages are numbered to indicate the order in which they are sent:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>1.request</code>.
This represents the application request made by the client.</p>
</li>
<li>
<p><code>2.completed</code>.
After the participant has completed its work, it notifies the coordinator that it has completed.</p>
</li>
<li>
<p><code>3.response</code>.
This represents the response to the client&#8217;s application request.</p>
</li>
<li>
<p><code>4.close</code>.
The client notifies the coordinator that it wishes to close the activity.
It then waits for a <code>closed</code> or failure response from the coordinator.</p>
</li>
<li>
<p><code>5a.close</code> and <code>5b.closed</code>.
The coordinator has processed the <code>2.completed</code> message so can close the activity.
It starts by sending the <code>close</code> message to the participant and waits for the <code>closed</code> response as confirmation.
These two messages are asynchronous.</p>
</li>
<li>
<p><code>6.closed</code>.
The coordinator now has all <code>closed</code> acknowledgments so notifies the client that the activity successfully <code>closed</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Messages '2.completed' and '4.close' are asynchronous (or 'one way' in Web services parlance) so effectively, there is a race condition with the following competing parties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Party 1</code>. The completed message <code>2.completed</code>.</p>
</li>
<li>
<p><code>Party 2</code>. The response <code>3.response</code> followed by <code>4.close</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When running in the same VM, or on a low latency network, <code>3.response</code> will be sent very quickly.
This is because it is simply travelling on the HTTP response over an already open socket.
This just leaves messages <code>2.completed</code> and <code>4.close</code> which will take much longer relative to <code>3.response</code>.
To understand this, lets take a look at what happens when an asynchronous Web service call is made:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The client sends the message to the Web service.</p>
</li>
<li>
<p>The server-side SOAP stack uses an existing thread from a pool dedicated to receiving SOAP messages.</p>
</li>
<li>
<p>As the service is asynchronous, the message will be passed to another thread to be processed.</p>
</li>
<li>
<p>The receiving thread will now return the HTTP response.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The race condition occurs because steps 1-3 can happen relatively quickly in a single VM, and thus it&#8217;s likely that both messages 2 and 4, will be waiting to be processed at the same time.
The order in which they are processed is dependent on the implementation of the thread pool and is also at the mercy of thread scheduling in the VM, so it&#8217;s possible that either could be processed first.</p>
</div>
<div class="paragraph">
<p>This race condition is much less likely to happen in a distributed environment as the network costs will be significantly higher.
As a result message <code>3.response</code> will take long enough to send, so as to give message <code>2.completed</code> enough of a head start.
But it is still possible so the client application must be coded defensively to catch and handle a <code>TransactionRollbackException</code>.
The client code ought to be doing this anyway to deal with server crashes.</p>
</div>
<div class="paragraph">
<p>The following diagram shows what messages are exchanged when the race condition occurs.
Notice that the activity ends in a consistent state.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/development-guide-fig-pcp-race-failure.png" alt="development guide fig pcp race failure">
</div>
<div class="title">Figure 11. Failure to close the activity</div>
</div>
<div class="paragraph">
<p>Messages 1-3 are omitted from the following explanation as they are the same as in the success case.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>4.close</code>.
This message is processed by the coordinator before message <code>2.completed</code></p>
</li>
<li>
<p><code>5a.cancel</code>.
The coordinator has not yet processed the <code>2.completed</code> message so cannot close the activity.
The coordinator then sends a 'cancel' message to the participant as it thinks it has not yet completed.
This message and subsequent retires, are dropped by the participant as they are not valid for a completed participant.</p>
</li>
<li>
<p><code>5b.compensate</code>/<code>5c.compensated</code>.
After one or more unacknowledged <code>cancel</code> messages, the coordinator switches to sending <code>compensate</code> messages which will cause the participant to compensate the work.
The participant acknowledges with a <code>compensated</code> reply.</p>
</li>
<li>
<p>6. Transaction rolledback exception.
The coordinator notifies the client that the activity failed to close.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As you can see from the steps above, when this race condition arises, any work done by participants is compensated and the client is notified of the outcome.
Thus a consistent outcome is achieved.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_xts_guide"><a class="anchor" href="#_xts_guide"></a>4. XTS Guide</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_2"><a class="anchor" href="#_introduction_2"></a>4.1. Introduction</h3>
<div class="paragraph">
<p>The <em>XML Transaction Service (XTS)</em> component of Narayana supports the coordination of private and public Web Services in a business transaction.
Therefore, to understand XTS, you must be familiar with Web Services, and also understand something about transactions.
This chapter introduces XTS and provides a brief overview of the technologies that form the Web Services standard.
Additionally, this chapter explores some of the fundamentals of transactioning technology and how it can be applied to Web Services.
Much of the content presented in this chapter is detailed throughout this guide.
However, only overview information about Web Services is provided.
If you are new to creating Web services, please consult your Web Services platform documentation.</p>
</div>
<div class="paragraph">
<p>Narayana provides the XTS component as a transaction solution for Web Services.
Using XTS, business partners can coordinate complex business transactions in a controlled and reliable manner.
The XTS API supports a transactional coordination model based on the <em>WS-Coordination</em>, <em>WS-Atomic Transaction</em>, and <em>WS-Business Activity</em> specifications.</p>
</div>
<div class="ulist">
<div class="title">Protocols Included in XTS* WS-Coordination (WS-C) is a generic coordination framework developed by IBM, Microsoft and BEA.</div>
<ul>
<li>
<p>WS-Atomic Transaction (WS-AT) and WS-Business Activity (WS-BA) together comprise the WS-Transaction (WS-T) transaction protocols that utilize this framework.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Narayana implements versions 1.1, and 1.2 of these three specifications.
Version specifications are available from <a href="http://www.oasis-open.org/specs/" class="bare">http://www.oasis-open.org/specs/</a> .</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The 1.1, and 1.2 specifications only differ in a small number of details.
The rest of this document employs version 1.1 of these specifications when providing explanations and example code.
On the few occasions where the modifications required to adapt these to the 1.1 specifications are not obvious, an explanatory note is provided.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>Web Services</em> are modular, reusable software components that are created by exposing business functionality through a Web service interface.
Web Services communicate directly with other Web Services using standards-based technologies such as SOAP and HTTP.
These standards-based communication technologies enable customers, suppliers, and trading partners to access Web Services, independent of hardware operating system, or programming environment.
The result is a vastly improved collaboration environment as compared to today&#8217;s EDI and <em>business-to-business (B2B)</em> solutions, an environment where businesses can expose their current and future business applications as Web Services that can be easily discovered and accessed by external partners.</p>
</div>
<div class="paragraph">
<p>Web Services, by themselves, are not fault-tolerant.
In fact, some of the reasons that the Web Services model is an attractive development solution are also the same reasons that service-based applications may have drawbacks.</p>
</div>
<div class="ulist">
<div class="title">Properties of Web Services</div>
<ul>
<li>
<p>Application components that are exposed as Web Services may be owned by third parties, which provides benefits in terms of cost of maintenance, but drawbacks in terms of having exclusive control over their behavior.</p>
</li>
<li>
<p>Web Services are usually remotely located, increasing risk of failure due to increased network travel for invocations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Applications that have high dependability requirements need a method of minimizing the effects of errors that may occur when an application consumes Web Services.
One method of safeguarding against such failures is to interact with an application&#8217;s Web Services within the context of a <em>transaction</em>.
A transaction is a unit of work which is completed entirely, or in the case of failures is reversed to some agreed consistent state.
The goal, in the event of a failure, is normally to appear as if the work had never occurred in the first place.
With XTS, transactions can span multiple Web Services, meaning that work performed across multiple enterprises can be managed with transactional support.</p>
</div>
<div class="sect3">
<h4 id="_managing_service_based_processes"><a class="anchor" href="#_managing_service_based_processes"></a>4.1.1. Managing service-Based Processes</h4>
<div class="paragraph">
<p>XTS allows you to create transactions that drive complex business processes, spanning multiple Web Services.
Current Web Services standards do not address the requirements for a high-level coordination of services.
This is because in today&#8217;s Web Services applications, which use single request/response interactions, coordination is typically not a problem.
However, for applications that engage multiple services among multiple business partners, coordinating and controlling the resulting interactions is essential.
This becomes even more apparent when you realize that you generally have little in the way of formal guarantees when interacting with third-party Web Services.</p>
</div>
<div class="paragraph">
<p>XTS provides the infrastructure for coordinating services during a business process.
By organizing processes as transactions, business partners can collaborate on complex business interactions in a reliable manner, insuring the integrity of their data - usually represented by multiple changes to a database  but without the usual overheads and drawbacks of directly exposing traditional transaction-processing engines directly onto the web.
<a href="#example_application">An Evening On the Town</a> demonstrates how an application may manage service-based processes as transactions:</p>
</div>
<div id="example_application" class="paragraph">
<div class="title">An Evening On the Town</div>
<p>The application in question allows a user to plan a social evening.
This application is responsible for reserving a table at a restaurant, and reserving tickets to a show.
Both activities are paid for using a credit card.
In this example, each service represents exposed Web Services provided by different service providers.
XTS is used to envelop the interactions between the theater and restaurant services into a single (potentially) long-running business transaction.
The business transaction must insure that seats are reserved both at the restaurant and the theater.
If one event fails the user has the ability to decline both events, thus returning both services back to their original state.
If both events are successful, the user&#8217;s credit card is charged and both seats are booked.
As you may expect, the interaction between the services must be controlled in a reliable manner over a period of time.
In addition, management must span several third-party services that are remotely deployed.</p>
</div>
<div class="paragraph">
<p>Without the backing of a transaction, an undesirable outcome may occur.
For example, the user credit card may be charged, even if one or both of the bookings fail.</p>
</div>
<div class="paragraph">
<p><a href="#example_application">An Evening On the Town</a> describes the situations where XTS excels at supporting business processes across multiple enterprises.
This example is further refined throughout this guide, and appears as a standard demonstrator (including source code) with the XTS distribution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_servlets"><a class="anchor" href="#_servlets"></a>4.1.2. Servlets</h4>
<div class="paragraph">
<p>The WS-Coordination, WS-Atomic Transaction, and WS-Business Activity protocols are based on one-way interactions of entities rather than traditional synchronous request/response RPC-style interactions.
One group of entities, called transaction participants, invoke operations on other entities, such as the transaction coordinator, in order to return responses to requests.
The programming model is based on peer-to-peer relationships, with the result that all services, whether they are participants, coordinators or clients, must have an <em>active component</em> that allows them to receive unsolicited messages.</p>
</div>
<div class="paragraph">
<p>In XTS, the active component is achieved through deployment of JaxWS endpoints.
Each XTS endpoint that is reachable through SOAP/XML is published via JaxWS, without developer intevention.
The only requirement is that transactional client applications and transactional web services must reside within a domain capable of hosting JaxWS endpoints, such as an application server.
WildFly Application Server can provide this functionality.</p>
</div>
</div>
<div class="sect3">
<h4 id="_soap"><a class="anchor" href="#_soap"></a>4.1.3. SOAP</h4>
<div class="paragraph">
<p>SOAP has emerged as the de facto message format for XML-based communication in the Web Services arena.
It is a lightweight protocol that allows the user to define the content of a message and to provide hints as to how recipients should process that message.</p>
</div>
</div>
<div class="sect3">
<h4 id="_web_services_description_language_wdsl"><a class="anchor" href="#_web_services_description_language_wdsl"></a>4.1.4. Web Services Description Language (WDSL)</h4>
<div class="paragraph">
<p><em class="term">Web Services Description Language (WSDL)</em> is an XML-based language used to define Web service interfaces.
An application that consumes a Web service parses the service&#8217;s WSDL document to discover the location of the service, the operations that the service supports, the protocol bindings the service supports (SOAP, HTTP, etc), and how to access them.
For each operation, WSDL describes the format that the client must follow.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_started"><a class="anchor" href="#_getting_started"></a>4.2. Getting Started</h3>
<div class="sect3">
<h4 id="_enablexts_on_wildfly_application_server"><a class="anchor" href="#_enablexts_on_wildfly_application_server"></a>4.2.1. EnableXTS on WildFly Application Server</h4>
<div class="paragraph">
<p>XTS, which is the Web Services component of Narayana, provides WS-AT and WS-BA support for Web Services hosted on the WildFly Application Server.
XTS is available as an optional SubSystem, enabled using the <code>standalone-xts.xml</code> configuration.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Starting WildFly Application Server with XTS Enabled</div>
<ol class="arabic">
<li>
<p>Change to the WildFly Application Server directory:</p>
<div class="paragraph">
<p><code>cd $JBOSS_HOME</code></p>
</div>
</li>
<li>
<p>Copy the example XTS configuration into the configurations directory:</p>
<div class="paragraph">
<p><code>cp docs/examples/configs/standalone-xts.xml standalone/configuration</code></p>
</div>
</li>
<li>
<p>Start WildFly Application Server, specifying the xts configuration:</p>
<div class="paragraph">
<p>Linux:</p>
</div>
<div class="paragraph">
<p><code>bin/standalone.sh --server-config=standalone-xts.xml</code></p>
</div>
<div class="paragraph">
<p>Windows:</p>
</div>
<div class="paragraph">
<p><code>bin\standalone.bat --server-config=standalone-xts.xml</code></p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_working_with_ws_at"><a class="anchor" href="#_working_with_ws_at"></a>4.2.2. Working With WS-AT</h4>
<div class="sect4">
<h5 id="ref_createwsatclient"><a class="anchor" href="#ref_createwsatclient"></a>Creating Client Applications</h5>
<div class="paragraph">
<p>XTS integrates WS-AT transactions with JTA.
To invoke a web service inside a WS-AT transaction, simply start a new JTA transaction and invoke the web service.
By default, XTS will create a WS-AT context and pass it with your request.
See our quickstarts for an example: <a href="quickstarts_overview.html#ref_wsatmultiservice">WS-AT Multi-Service</a> and <a href="quickstarts_overview.html#ref_wsatmultihop">WS-AT Multi-Hop</a></p>
</div>
</div>
<div class="sect4">
<h5 id="ref_createwsatservice"><a class="anchor" href="#ref_createwsatservice"></a>Creating Transactional Web Services</h5>
<div class="paragraph">
<p>Similarly to the client-side, the service-side is also integrated with JTA.
To make your web service WS-AT compliant, annotate your web service class or method with the EJB 3 <code>jakarta.ejb.TransactionAttribute</code> annotation or the JTA <code>jakarta.transaction.Transactional annotation</code>.
XTS will automatically translate WS-AT context, received with the request, to JTA.
See our quickstarts for an example: <a href="quickstarts_overview.html#ref_wsatmultiservice">WS-AT Multi-Service</a> and <a href="quickstarts_overview.html#ref_wsatmultihop">WS-AT Multi-Hop</a></p>
</div>
</div>
<div class="sect4">
<h5 id="_using_raw_xts_api"><a class="anchor" href="#_using_raw_xts_api"></a>Using Raw XTS API</h5>
<div class="paragraph">
<p>Sometimes more control is needed over the client and the server applications.
Also JTA transactions are not always wanted in the application.
In such case it is possible to create client and service applications using the Raw XTS API.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is not a recommended way to work with WS-AT.
Please take a look at <a href="#ref_createwsatclient">Creating Client Applications</a> and <a href="#ref_createwsatservice">Creating Transactional Web Services</a> for the recommended and easier XTS usage for WS-AT applications.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="_creating_client_applications"><a class="anchor" href="#_creating_client_applications"></a>Creating Client Applications</h6>
<div class="paragraph">
<p>There are two aspects to a client application using Raw XTS, the transaction declaration aspects, and the business logic.
The business logic includes the invocation of Web Services.</p>
</div>
<div class="paragraph">
<p>Transaction declaration aspects are handled automatically with the XTS client API.
This API provides simple transaction directives such as <code>begin</code>, <code>commit</code>, and <code>rollback</code>, which the client application can use to initialize, manage, and terminate transactions.
Internally, this API uses SOAP to invoke operations on the various WS-C and WS-AT services, in order to create a coordinator and drive the transaction to completion.</p>
</div>
<div class="sect6">
<h7 id="_user_transactions"><a class="anchor" href="#_user_transactions"></a>User Transactions</h7>
<div class="paragraph">
<p>A client uses the <code>UserTransactionFactory</code> and <code>UserTransaction</code> classes to create and manage WS-AT transactions.
These classes provide a simple API which operates in a manner similar to the JTA API.
A WS-AT transaction is started and associated with the client thread by calling the <code>begin</code> method of the <code>UserTransaction</code> class.
The transaction can be committed by calling the <code>commit</code> method, and rolled back by calling the <code>rollback</code> method.</p>
</div>
<div class="paragraph">
<p>More complex transaction management, such as suspension and resumption of transactions, is supported by the <code>TransactionManagerFactory</code> and <code>TransactionManager</code> classes.</p>
</div>
<div class="paragraph">
<p>Full details of the WS-AT APIs are provided in <a href="xts_api.html#sec_xts_api">the XTS API</a>.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="ref_wsatrawcreatingtransactionalwebservices"><a class="anchor" href="#ref_wsatrawcreatingtransactionalwebservices"></a>Creating Transactional Web Services</h6>
<div class="paragraph">
<p>The two parts to implementing a Web service using XTS are the transaction management and the business logic.</p>
</div>
<div class="paragraph">
<p>The bulk of the transaction management aspects are organized in a clear and easy-to-implement model by means of the XTS&#8217;s <em>Participant API</em>, provides a structured model for negotiation between the web service and the transaction coordinator.
It allows the web service to manage its own local transactional data, in accordance with the needs of the business logic, while ensuring that its activities are in step with those of the client and other services involved in the transaction.
Internally, this API uses SOAP to invokes operations on the various WS-C and WS-AT services, to drive the transaction to completion.</p>
</div>
<div class="paragraph">
<p>A <em>participant</em> is a software entity which is driven by the transaction manager on behalf of a Web service.
When a web service wants to participate in a particular transaction, it must enroll a participant to act as a proxy for the service in subsequent negotiations with the coordinator.
The participant implements an API appropriate to the type of transaction it is enrolled in, and the participant model selected when it is enrolled.
For example, a <code>Durable2PC</code> participant, as part of a WS-Atomic Transaction, implements the <code>Durable2PCParticipant</code> interface.
The use of participants allows the transactional control management aspects of the Web service to be factored into the participant implementation, while staying separate from the rest of the Web service&#8217;s business logic and private transactional data management.</p>
</div>
<div class="paragraph">
<p>The creation of participants is not trivial, since they ultimately reflect the state of a Web service&#8217;s back-end processing facilities, an aspect normally associated with an enterprise&#8217;s own IT infrastructure.
Implementations must use one of the following interfaces: <code>com.arjuna.wst11.Durable2PCParticipant</code>, <code>com.arjuna.wst11.Volatile2PCParticipant</code>.</p>
</div>
<div class="paragraph">
<p>A full description of XTS&#8217;s participant features is provided in <a href="xts_api.html#sec_xts_api">the XTS API</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_working_with_ws_ba"><a class="anchor" href="#_working_with_ws_ba"></a>4.2.3. Working With WS-BA</h4>
<div class="sect4">
<h5 id="_creating_client_applications_2"><a class="anchor" href="#_creating_client_applications_2"></a>Creating Client Applications</h5>
<div class="paragraph">
<p>There are two aspects to a client application using XTS, the transaction declaration aspects, and the business logic.
The business logic includes the invocation of Web Services.</p>
</div>
<div class="paragraph">
<p>Transaction declaration aspects are handled automatically with the XTS client API.
This API provides simple transaction directives such as <code>begin</code>, <code>close</code>, and <code>cancel</code>, which the client application can use to initialize, manage, and terminate transactions.
Internally, this API uses SOAP to invoke operations on WS-BA services, in order to create a coordinator and drive the transaction to completion.</p>
</div>
<div class="sect5">
<h6 id="_business_activities"><a class="anchor" href="#_business_activities"></a>Business Activities</h6>
<div class="paragraph">
<p>A client creates and manages Business Activities using the <code>UserBusinessActivityFactory</code> and <code>UserBusinessActivity</code> classes.
A WS-BA activity is started and associated with the client thread by calling the <code>begin</code> method of the <code>UserBusinessActivity</code> class.
A client can terminate a business activity by calling the <code>close</code> method, and cancel it by calling the <code>cancel</code> method.</p>
</div>
<div class="paragraph">
<p>If any of the Web Services invoked by the client register for the <code>BusinessActivityWithCoordinatorCompletion</code> protocol, the client can call the <code>completed</code> method before calling the <code>close</code> method, to notify the services that it has finished making service invocations in the current activity.</p>
</div>
<div class="paragraph">
<p>More complex business activity management, such as suspension and resumption of business activities, is supported by the <code>BusinessActivityManagerFactory</code> and <code>BusinessActivityManager</code> classes.</p>
</div>
<div class="paragraph">
<p>Full details of the WS-BA APIs are provided in <a href="xts_api.html#sec_xts_api">the XTS API</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_creating_transactional_web_services"><a class="anchor" href="#_creating_transactional_web_services"></a>Creating Transactional Web Services</h5>
<div class="paragraph">
<p>The theory behind creating WS-BA web services is similar to the WS-AT Raw API <a href="#ref_wsatrawcreatingtransactionalwebservices">Creating Transactional Web Services</a>.
However, different participant classes are used: <code>com.arjuna.wst11.BusinessAgreementWithParticipantCompletionParticipant</code> , or <code>com.arjuna.wst11.BusinessAgreementWithCoordinatorCompletionParticipant</code>.</p>
</div>
<div class="paragraph">
<p>A full description of XTS&#8217;s participant features is provided in <a href="xts_api.html#sec_xts_api">the XTS API</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_new_compensating_transactions_api"><a class="anchor" href="#_new_compensating_transactions_api"></a>New Compensating Transactions API</h5>
<div class="paragraph">
<p>There is a new Compensating Transactions API available to work with WS-BA applications.
Please consult our quickstarts how to use it: <a href="quickstarts_overview.html#ref_compensationsnontransactionalresource">non-transactional resource with compensating transactions API</a> and <a href="quickstarts_overview.html#ref_compensationstravelagent">travel agent with compensating transactions API</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ref_transactioncontextpropagation"><a class="anchor" href="#ref_transactioncontextpropagation"></a>4.2.4. Configuration of The Transaction Context Propagation</h4>
<div class="paragraph">
<p>You can enable transaction propagation for all Web service calls that are invoked within a JTA, WS-AT or WS-BA transaction.
This is done with the <code>default-context-propagation</code> property in the XTS subsystem config of the <code>standalone-xts.xml</code>.</p>
</div>
<div class="paragraph">
<p>As this is enabled by default (for <code>standalone-xts.xml</code>), calls to all Web services that support WS-AT or WS-BA will automatically receive the transaction context allowing them to participate in the distributed transaction.</p>
</div>
<div class="paragraph">
<p>The transaction context is simply ignored if the service does not support WS-AT or WS-BA.
This is done by setting <code>MustUnderstand="false"</code> on the <code>CoordinationContext</code> SOAP header.
Unfortunately, this may cause issues when invoking WS-AT or WS-BA enabled Web services on other vendors' application servers.
This is because the WS-Coordination specification states that <code>MustUnderstand</code> must be set to true.
If you are affected by this issue, you will need to explicitly enable the transaction propagation for every port.</p>
</div>
<div class="paragraph">
<p>The default context propagation policy can also be overridden on a per Web Service port basis.
This allows the developer to easily state which Web Service clients must and must-not propagate the transaction context.
This is done through the standard JAX-WS WebServiceFeature facility.
A JAX-WS <code>WebServiceFeature</code> allows meta-information to be added to a port that describe cross-cutting behaviour, such as logging, security or compression.
In our case we use the <a href="xts_api.html#ref_jtaoverwsatfeature">JTAOverWSATFeature</a> and <a href="xts_api.html#ref_wstxfeature">WSTXFeature</a> features.</p>
</div>
<div class="paragraph">
<p><a href="xts_api.html#ref_jtaoverwsatfeature">JTAOverWSATFeature</a> states that any JTA, WS-AT, or WS-BA transactions should be distributed via calls on this client.
This feature is recommended to use, if you have a JTA transactions which should be propagated.</p>
</div>
<div class="paragraph">
<p><a href="xts_api.html#ref_wstxfeature">WSTXFeature</a> states that any WS-AT or WS-BA transaction should be distributed via calls on this client.
You should use this feature, if you use Raw XTS or WS-BA APIs.</p>
</div>
<div class="paragraph">
<p>Calls to the service will fail if the Web service does not support WS-AT or WS-BA (in this case, XTS sets <code>MustUnderstand=true</code> on the <code>CoordinationContext</code> SOAP header as the developer has explicitly stated that it is required).</p>
</div>
<div class="paragraph">
<p>The developer may also state that the transaction must-not be distributed over calls to this Web service.
This is done by setting the <a href="xts_api.html#ref_jtaoverwsatfeature">JTAOverWSATFeature</a> or <a href="xts_api.html#ref_wstxfeature">WSTXFeature</a> feature to disabled.</p>
</div>
<div class="paragraph">
<p>The use of <a href="xts_api.html#ref_jtaoverwsatfeature">JTAOverWSATFeature</a> and <a href="xts_api.html#ref_wstxfeature">WSTXFeature</a> overrides whatever default context propagation is set to in the <code>standalone-xts.xml</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_summary"><a class="anchor" href="#_summary"></a>4.2.5. Summary</h4>
<div class="paragraph">
<p>This chapter gives a high-level overview of each of the major software pieces used by the Web Services transactions component of Narayana.
The Web Services transaction manager provided by Narayana is the hub of the architecture and is the only piece of software that user-level software does not bind to directly.
XTS provides header-processing infrastructure for use with Web Services transactions contexts for both client applications and Web Services.
XTS provides a simple interface for developing transaction participants, along with the necessary document-handling code.</p>
</div>
<div class="paragraph">
<p>This chapter is only an overview, and does not address the more difficult and subtle aspects of programming Web Services.
For fuller explanations of the components, please continue reading.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec_xts_api"><a class="anchor" href="#sec_xts_api"></a>4.3. The XTS API</h3>
<div class="paragraph">
<p>This chapter discusses the XTS API.
You can use this information to write client and server applications which consume transactional Web Services and coordinate back-end systems.</p>
</div>
<div class="sect3">
<h4 id="_participants_2"><a class="anchor" href="#_participants_2"></a>4.3.1. Participants</h4>
<div class="sect4">
<h5 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h5>
<div class="paragraph">
<p>The <code>participant</code> is the entity that performs the work pertaining to transaction management on behalf of the business services involved in an application.
The Web service (in the example code, a theater booking system) contains some business logic to reserve a seat and inquire about availability, but it needs to be supported by something that maintains information in a durable manner.
Typically this is a database, but it could be a file system, NVRAM, or other storage mechanism.</p>
</div>
<div class="paragraph">
<p>Although the service may talk to the back-end database directly, it cannot commit or undo any changes, since committing and rolling back are ultimately under the control of a transaction.
For the transaction to exercise this control, it must communicate with the database.
In XTS, participant does this communication, as shown in <a href="#fig_participant_backend_control">Transactions, Participants, and Back-End Transaction Control</a>.</p>
</div>
<div id="fig_participant_backend_control" class="imageblock text-center">
<div class="content">
<img src="images/xts-guide-fig-participant-backend-control.png" alt="xts guide fig participant backend control">
</div>
<div class="title">Figure 12. Transactions, Participants, and Back-End Transaction Control</div>
</div>
<div class="sect5">
<h6 id="_atomic_transaction"><a class="anchor" href="#_atomic_transaction"></a>Atomic Transaction</h6>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This section is relevant for WS-AT applications only if Raw XTS API is used.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All Atomic Transaction participants are instances of the <a href="#ref_durable2pcparticipant"><code>Durable2PCParticipant</code></a> or <a href="#ref_volatile2pcparticipant"><code>Volatile2PCParticipant</code></a> .</p>
</div>
</div>
<div class="sect5">
<h6 id="_business_activity"><a class="anchor" href="#_business_activity"></a>Business Activity</h6>
<div class="paragraph">
<p>All Business Activity participants are instances one or the other of the interfaces described in <a href="#ref_businessagreementwithparticipantcompletion"><code>BusinessAgreementWithParticipantCompletionParticipant</code></a> or <a href="#ref_businessagreementwithcoordinatorcompletion"><code>BusinessAgreementWithCoordinatorCompletion</code></a> interface.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_participant_creation_and_deployment"><a class="anchor" href="#_participant_creation_and_deployment"></a>Participant Creation and Deployment</h5>
<div class="paragraph">
<p>The participant provides the plumbing that drives the transactional aspects of the service.
This section discusses the specifics of Participant programming and usage.</p>
</div>
<div class="sect5">
<h6 id="_implementing_participants"><a class="anchor" href="#_implementing_participants"></a>Implementing Participants</h6>
<div class="paragraph">
<p>Implementing a participant is a relatively straightforward task.
However, depending on the complexity of the transactional infrastructure that the participant needs to manage, the task can vary greatly in complexity and scope.
Your implementation needs to implement one of the interfaces found under <code>com.arjuna.wst</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_deploying_participants"><a class="anchor" href="#_deploying_participants"></a>Deploying Participants</h6>
<div class="paragraph">
<p>Transactional web services and transactional clients are regular Jakarta EE applications and can be deployed into the application server in the same way as any other Jakarta EE application.
The XTS Subsystem exports all the client and web service API classes needed to manage transactions and enroll and manage participant web services.
It provides implementations of all the WS-C and WS-T coordination services, not just the coordinator services.
In particular, it exposes the client and web service participant endpoints which are needed to receive incoming messages originating from the coordinator.</p>
</div>
<div class="paragraph">
<p>Normally, a transactional application client and the transaction web service it invokes will be deployed in different application servers.
As long as XTS is enabled on each of these containers it will transparently route coordination messages from clients or web services to their coordinator and vice versa.
When the client begins a transaction by default it creates a context using the coordination services in its local container.
The context holds a reference to the local Registration Service which means that any web services enlisted in the transaction enrol with the coordination services in the same container.</p>
</div>
<div class="paragraph">
<p>The coordinator does not need to reside in the same container as the client application.
By configuring the client deployment appropriately it is possible to use the coordinator services co-located with one of the web services or even to use services deployed in a separate, dedicated container.
See Chapter 8 Stand-Alone Coordination for details of how to configure a coordinator located in a different container to the client.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In previous releases, the XTS and Transaction Manager <code>.jar</code>, <code>.war</code> and configuration files needed to be bundled with the application.
This deployment method is no longer supported in the WildFly Application Server as XTS is pre-installed as a SubSystem.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_api_for_the_atomic_transaction_protocol"><a class="anchor" href="#_api_for_the_atomic_transaction_protocol"></a>4.3.2. API for the Atomic Transaction Protocol</h4>
<div class="sect4">
<h5 id="ref_durable2pcparticipant"><a class="anchor" href="#ref_durable2pcparticipant"></a><code>Durable2PCParticipant</code></h5>
<div class="paragraph">
<p>All participants which support <code>Durable2PC</code> protocol have to implement <code>com.arjuna.wst.Durable2PCParticipant</code> interface.</p>
</div>
<div class="dlist">
<div class="title"><code>Durable2PCParticipant</code> Methods</div>
<dl>
<dt class="hdlist1">prepare</dt>
<dd>
<p>The participant should perform any work necessary, so that it can either <code>commit</code> or <code>roll back</code> the work performed by the Web service under the scope of the transaction.
The implementation is free to do whatever it needs to in order to fulfill the implicit contract between it and the coordinator.</p>
<div class="paragraph">
<p>The participant indicates whether it can <code>prepare</code> by returning an instance of <a href="#ref_vote">Vote</a>.</p>
</div>
</dd>
<dt class="hdlist1"><code>commit</code></dt>
<dd>
<p>The participant should make its work permanent.
How it accomplishes this depends upon its implementation.
For instance, in the theater example, the reservation of the ticket is committed.
If <code>commit</code> processing cannot complete, the participant should throw a <code>SystemException</code> error, potentially leading to a heuristic outcome for the transaction.</p>
</dd>
<dt class="hdlist1"><code>rollback</code></dt>
<dd>
<p>The participant should undo its work.
If <code>rollback</code> processing cannot complete, the participant should throw a <code>SystemException</code> error, potentially leading to a heuristic outcome for the transaction.</p>
</dd>
<dt class="hdlist1"><code>unknown</code></dt>
<dd>
<p>This method has been deprecated and is slated to be removed from XTS in the future.</p>
</dd>
<dt class="hdlist1"><code>error</code></dt>
<dd>
<p>In rare cases when recovering from a system crash, it may be impossible to complete or <code>roll back</code> a previously prepared participant, causing the <code>error</code> operation to be invoked.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="ref_volatile2pcparticipant"><a class="anchor" href="#ref_volatile2pcparticipant"></a><code>Volatile2PCParticipant</code></h5>
<div class="paragraph">
<p>All participants which support <code>Volatile2PC</code> protocol have to implement <code>com.arjuna.wst.Volatile2PCParticipant</code> interface.</p>
</div>
<div class="dlist">
<div class="title"><code>Volatile2PCParticipant</code> Methods</div>
<dl>
<dt class="hdlist1"><code>prepare</code></dt>
<dd>
<p>The participant should perform any work necessary to flush any volatile data created by the Web service under the scope of the transaction, to the system store.
The implementation is free to do whatever it needs to in order to fulfill the implicit contract between it and the coordinator.</p>
<div class="paragraph">
<p>The participant indicates whether it can <code>prepare</code> by returning an instance of <a href="#ref_vote">Vote</a>.</p>
</div>
</dd>
<dt class="hdlist1"><code>commit</code></dt>
<dd>
<p>The participant should perform any cleanup activities required, in response to a successful transaction <code>commit</code>.
These cleanup activities depend upon its implementation.
For instance, it may flush cached backup copies of data modified during the transaction.
In the unlikely event that <code>commit</code> processing cannot complete, the participant should throw a <code>SystemException</code> error.
This will not affect the outcome of the transaction but will cause an error to be logged.
This method may not be called if a crash occurs during <code>commit</code> processing.</p>
</dd>
<dt class="hdlist1"><code>rollback</code></dt>
<dd>
<p>The participant should perform any cleanup activities required, in response to a transaction <code>abort</code>.
In the unlikely event that <code>rollback</code> processing cannot complete, the participant should throw a <code>SystemException</code> error.
This will not affect the outcome of the transaction but will cause an error to be logged.
This method may not be called if a crash occurs during <code>commit</code> processing.</p>
</dd>
<dt class="hdlist1"><code>unknown</code></dt>
<dd>
<p>This method is deprecated and will be removed in a future release of XTS.</p>
</dd>
<dt class="hdlist1"><code>error</code></dt>
<dd>
<p>This method should never be called, since volatile participants are not involved in recovery processing.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="ref_vote"><a class="anchor" href="#ref_vote"></a>Vote</h5>
<div class="paragraph">
<p>During the two-phase commit protocol, a participant is asked to vote on whether it can prepare to confirm the work that it controls.
It must return an instance of one of the subtypes of <code>com.arjuna.wst.Vote</code>.</p>
</div>
<div class="dlist">
<div class="title">Subclasses of <code>com.arjuna.wst.Vote</code></div>
<dl>
<dt class="hdlist1"><code>Prepared</code></dt>
<dd>
<p>Indicates that the participant can prepare if the coordinator requests it.
Nothing has been committed, because the participant does not know the final outcome of the transaction.</p>
</dd>
<dt class="hdlist1"><code>Aborted</code></dt>
<dd>
<p>The participant cannot prepare, and has rolled back.
The participant should not expect to get a second phase message.</p>
</dd>
<dt class="hdlist1"><code>ReadOnly</code></dt>
<dd>
<p>The participant has not made any changes to state, and it does not need to know the final outcome of the transaction.
Essentially the participant is resigning from the transaction.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Example Implementation of 2PC Participant&#8217;s `prepare`method</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> Vote prepare() <span class="directive">throws</span> WrongStateException, SystemException {
    <span class="comment">// Some participant logic here</span>

    <span class="keyword">if</span> (<span class="comment">/* some condition based on the outcome of the business logic */</span>) {
        <span class="comment">// Vote to confirm</span>
        <span class="keyword">return</span> <span class="keyword">new</span> com.arjuna.wst.Prepared();
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="comment">/*another condition based on the outcome of the business logic*/</span>) {
        <span class="comment">// Resign</span>
        <span class="keyword">return</span> <span class="keyword">new</span> com.arjuna.wst.ReadOnly();
    } <span class="keyword">else</span> {
        <span class="comment">// Vote to cancel</span>
        <span class="keyword">return</span> <span class="keyword">new</span> com.arjuna.wst.Aborted();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_txcontext"><a class="anchor" href="#_txcontext"></a>TXContext</h5>
<div class="paragraph">
<p><code>com.arjuna.mw.wst.TxContext</code> is an opaque representation of a transaction context.
It returns one of two possible values, as listed below.</p>
</div>
<div class="dlist">
<div class="title">TxContext Return Values</div>
<dl>
<dt class="hdlist1"><code>valid</code></dt>
<dd>
<p>Indicates whether the contents are valid.</p>
</dd>
<dt class="hdlist1"><code>equals</code></dt>
<dd>
<p>Can be used to compare two instances for equality.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="ref_usertransaction"><a class="anchor" href="#ref_usertransaction"></a>UserTransaction</h5>
<div class="paragraph">
<p><code>com.arjuna.mw.wst11.UserTransaction</code> is the class that clients typically employ.
Before a client can begin a new atomic transaction, it must first obtain a <code>UserTransaction</code> from the <code>UserTransactionFactory</code>.
This class isolates the user from the underlying protocol-specific aspects of the XTS implementation.
A <code>UserTransaction</code> does not represent a specific transaction.
Instead, it provides access to an implicit per-thread transaction context, similar to the <code>UserTransaction</code> in the JTA specification.
All of the <code>UserTransaction</code> methods implicitly act on the current thread of control.</p>
</div>
<div class="dlist">
<div class="title">`UserTransaction`Methods</div>
<dl>
<dt class="hdlist1"><code>begin</code></dt>
<dd>
<p>Used to begin a new transaction and associate it with the invoking thread.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Parameters</div>
<dl>
<dt class="hdlist1"><code>timeout</code></dt>
<dd>
<p>This optional parameter, measured in milliseconds, specifies a time interval after which the newly created transaction may be automatically rolled back by the coordinator</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Exceptions</div>
<dl>
<dt class="hdlist1"><code>WrongStateException</code></dt>
<dd>
<p>A transaction is already associated with the thread.</p>
</dd>
<dt class="hdlist1"><code>commit</code></dt>
<dd>
<p><code>Volatile2PC</code> and <code>Durable2PC</code> participants enrolled in the transaction are requested first to prepare and then to <code>commit</code> their changes.
If any of the participants fails to prepare in the first phase then all other participants are requested to <code>abort</code>.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Exceptions</div>
<dl>
<dt class="hdlist1"><code>UnknownTransactionException</code></dt>
<dd>
<p>No transaction is associated with the invoking thread.</p>
</dd>
<dt class="hdlist1"><code>TransactionRolledBackException</code></dt>
<dd>
<p>The transaction was rolled back either because of a timeout or because a participant was unable to <code>commit</code>.</p>
</dd>
<dt class="hdlist1"><code>rollback</code></dt>
<dd>
<p>Terminates the transaction.
Upon completion, the <code>rollback</code> method disassociates the transaction from the current leaving it unassociated with any transactions.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Exceptions</div>
<dl>
<dt class="hdlist1"><code>UnknownTransactionException</code></dt>
<dd>
<p>No transaction is associated with the invoking thread.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_usertransactionfactory"><a class="anchor" href="#_usertransactionfactory"></a>UserTransactionFactory</h5>
<div class="paragraph">
<p>Call the <code>getUserTransaction</code> method to obtain a <a href="#ref_usertransaction">UserTransaction</a> instance from a <code>UserTransactionFactory</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="ref_transactionmanager"><a class="anchor" href="#ref_transactionmanager"></a>TransactionManager</h5>
<div class="paragraph">
<p>Defines the interaction between a transactional web service and the underlying transaction service implementation.
A <code>TransactionManager</code> does not represent a specific transaction.
Instead, it provides access to an implicit per-thread transaction context.</p>
</div>
<div class="dlist">
<div class="title">Methods</div>
<dl>
<dt class="hdlist1"><code>currentTransaction</code></dt>
<dd>
<p>Returns a <code>TxContext</code> for the current transaction, or null if there is no context.
Use the <code>currentTransaction</code> method to determine whether a web service has been invoked from within an existing transaction.
You can also use the returned value to enable multiple threads to execute within the scope of the same transaction.
Calling the <code>currentTransaction</code> method does not disassociate the current thread from the transaction.</p>
</dd>
<dt class="hdlist1"><code>suspend</code></dt>
<dd>
<p>Dissociates a thread from any transaction.
This enables a thread to do work that is not associated with a specific transaction.</p>
<div class="paragraph">
<p>The <code>suspend</code> method returns a <code>TxContext</code> instance, which is a handle on the transaction.</p>
</div>
</dd>
<dt class="hdlist1"><code>resume</code></dt>
<dd>
<p>Associates or re-associates a thread with a transaction, using its <code>TxContext</code>.
Prior to association or re-association, the thread is disassociated from any transaction with which it may be currently associated.
If the <code>TxContext</code> is null, then the thread is associated with no transaction.
In this way, the result is the same as if the <code>suspend</code> method were used instead.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Parameters</div>
<dl>
<dt class="hdlist1">txContext</dt>
<dd>
<p>A TxContext instance as return by <code>suspend</code>, identifying the transaction to be resumed.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Exceptions</div>
<dl>
<dt class="hdlist1"><code>UnknownTransactionException</code></dt>
<dd>
<p>The transaction referred to by the <code>TxContext</code> is invalid in the scope of the invoking thread.</p>
</dd>
<dt class="hdlist1"><code>enlistForVolitaleTwoPhase</code></dt>
<dd>
<p>Enroll the specified participant with the current transaction, causing it to participate in the <code>Volatile2PC</code> protocol.
You must pass a unique identifier for the participant.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Parameters</div>
<dl>
<dt class="hdlist1">participant</dt>
<dd>
<p>An implementation of interface <code>Volatile2PCParticipant</code> whose prepare, <code>commit</code> and <code>abort</code> methods are called when the corresponding coordinator message is received.</p>
</dd>
<dt class="hdlist1">id</dt>
<dd>
<p>A unique identifier for the participant.
The value of this String should differ for each enlisted participant.
It should also be possible for a given identifier to determine that the participant belongs to the enlisting web service rather than some other web service deployed to the same container.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Exceptions</div>
<dl>
<dt class="hdlist1">UnknownTransactionException</dt>
<dd>
<p>No transaction is associated with the invoking thread.</p>
</dd>
<dt class="hdlist1"><code>WrongStateException</code></dt>
<dd>
<p>The transaction is not in a state that allows participants to be enrolled.
For instance, it may be in the process of terminating.</p>
</dd>
<dt class="hdlist1"><code>enlistForDurableTwoPhase</code></dt>
<dd>
<p>Enroll the specified participant with the current transaction, causing it to participate in the <code>Durable2PC</code> protocol.
You must pass a unique identifier for the participant.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Exceptions</div>
<dl>
<dt class="hdlist1">UnknownTransactionException</dt>
<dd>
<p>No transaction is associated with the invoking thread.</p>
</dd>
<dt class="hdlist1"><code>WrongStateException</code></dt>
<dd>
<p>The transaction is not in a state that allows participants to be enrolled.
For instance, it may be in the process of terminating.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_transactionmanagerfactory"><a class="anchor" href="#_transactionmanagerfactory"></a><code>TransactionManagerFactory</code></h5>
<div class="paragraph">
<p>Use the <code>getTransactionManager</code> method to obtain a <a href="#ref_transactionmanager">TransactionManager</a> from a <code>TransactionManagerFactory</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="ref_wstxfeature"><a class="anchor" href="#ref_wstxfeature"></a>WSTXFeature</h5>
<div class="paragraph">
<p>Use this JAX-WS feature to enable or disable WS-AT context propagation for specific port.
Pass an instance of this feature when creating web service port.</p>
</div>
<div class="dlist">
<div class="title">Methods</div>
<dl>
<dt class="hdlist1"><code>WSTXFeature</code></dt>
<dd>
<p><code>WSTXFeature</code> created with default constructor will enable WS-AT context propagation.</p>
</dd>
<dt class="hdlist1"><code>WSTXFeature</code></dt>
<dd>
<p>Parametrised constructor will either enabled or disable WS-AT context propagation.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Parameters</div>
<dl>
<dt class="hdlist1"><code>enabled</code></dt>
<dd>
<p>Boolean value saying to either enable or disable WS-AT context propagation.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="ref_jtaoverwsatfeature"><a class="anchor" href="#ref_jtaoverwsatfeature"></a>JTAOverWSATFeature</h5>
<div class="paragraph">
<p>Use this JAX-WS feature to enable or disable JTA context propagation for specific port.
Pass an instance of this feature when creating web service port.</p>
</div>
<div class="dlist">
<div class="title">Methods</div>
<dl>
<dt class="hdlist1"><code>JTAOverWSATFeature</code></dt>
<dd>
<p><code>JTAOverWSATFeature</code> created with default constructor will enable JTA context propagation.</p>
</dd>
<dt class="hdlist1"><code>JTAOverWSATFeature</code></dt>
<dd>
<p>Parametrised constructor will either enabled or disable JTA context propagation.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Parameters</div>
<dl>
<dt class="hdlist1"><code>enabled</code></dt>
<dd>
<p>Boolean value saying to either enable or disable JTA context propagation.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_api_for_the_business_activity_protocol"><a class="anchor" href="#_api_for_the_business_activity_protocol"></a>4.3.3. API for the Business Activity Protocol</h4>
<div class="sect4">
<h5 id="_compatibility"><a class="anchor" href="#_compatibility"></a>Compatibility</h5>
<div class="paragraph">
<p>Previous implementations of XTS locate the Business Activity Protocol classes in the <code>com.arjuna.mw.wst</code> package.
In the current implementation, these classes are located in the <code>com.arjuna.mw.wst11</code> package.</p>
</div>
</div>
<div class="sect4">
<h5 id="ref_businessagreementwithparticipantcompletion"><a class="anchor" href="#ref_businessagreementwithparticipantcompletion"></a><code>BusinessAgreementWithParticipantCompletionParticipant</code></h5>
<div class="paragraph">
<p>Participant which support business agreement with participant completion protocol have to implement <code>com.arjuna.wst.BusinessAgreementWithParticipantCompletionParticipant</code> interface.</p>
</div>
<div class="dlist">
<div class="title"><code>BusinessAgreementWithParticipantCompletion</code> Methods</div>
<dl>
<dt class="hdlist1"><code>close</code></dt>
<dd>
<p>The transaction has completed successfully.
The participant has previously informed the coordinator that it was ready to complete.</p>
</dd>
<dt class="hdlist1"><code>cancel</code></dt>
<dd>
<p>The transaction has canceled, and the participant should undo any work.
The participant cannot have informed the coordinator that it has completed.</p>
</dd>
<dt class="hdlist1"><code>compensate</code></dt>
<dd>
<p>The transaction has canceled.
The participant previously informed the coordinator that it had finished work but could compensate later if required, and it is now requested to do so.
If compensation cannot be performed, the participant should throw a <code>FaultedException</code> error, potentially leading to a heuristic outcome for the transaction.
If compensation processing cannot complete because of a transient condition then the participant should throw a <code>SystemException</code> error, in which case the compensation action may be retried or the transaction may finish with a heuristic outcome.</p>
</dd>
<dt class="hdlist1"><code>status</code></dt>
<dd>
<p>Return the status of the participant.</p>
</dd>
<dt class="hdlist1"><code>unknown</code></dt>
<dd>
<p>This method is deprecated and will be removed a future XTS release.</p>
</dd>
<dt class="hdlist1"><code>error</code></dt>
<dd>
<p>In rare cases when recovering from a system crash, it may be impossible to compensate a previously-completed participant.
In such cases the <code>error</code> operation is invoked.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="ref_businessagreementwithcoordinatorcompletion"><a class="anchor" href="#ref_businessagreementwithcoordinatorcompletion"></a><code>BusinessAgreementWithCoordinatorCompletion</code></h5>
<div class="paragraph">
<p>Participant which support business agreement with coordinator completion protocol have to implement <code>com.arjuna.wst.BusinessAgreementWithCoordinatorCompletionParticipant</code> interface.</p>
</div>
<div class="dlist">
<div class="title"><code>BusinessAgreementWithCoordinatorCompletion</code> Methods</div>
<dl>
<dt class="hdlist1"><code>close</code></dt>
<dd>
<p>The transaction completed successfully.
The participant previously informed the coordinator that it was ready to complete.</p>
</dd>
<dt class="hdlist1"><code>cancel</code></dt>
<dd>
<p>The transaction canceled, and the participant should undo any work.</p>
</dd>
<dt class="hdlist1"><code>compensate</code></dt>
<dd>
<p>The transaction canceled.
The participant previously informed the coordinator that it had finished work but could compensate later if required, and it is now requested to do so.
In the unlikely event that compensation cannot be performed the participant should throw a <code>FaultedException</code> error, potentially leading to a heuristic outcome for the transaction.
If compensation processing cannot complete because of a transient condition, the participant should throw a <code>SystemException</code> error, in which case the compensation action may be retried or the transaction may finish with a heuristic outcome.</p>
</dd>
<dt class="hdlist1"><code>complete</code></dt>
<dd>
<p>The coordinator is informing the participant all work it needs to do within the scope of this business activity has been completed and that it should make permananent any provisional changes it has made.</p>
</dd>
<dt class="hdlist1"><code>status</code></dt>
<dd>
<p>Returns the status of the participant.</p>
</dd>
<dt class="hdlist1"><code>unknown</code></dt>
<dd>
<p>This method is deprecated and will be removed in a future release of XTS.</p>
</dd>
<dt class="hdlist1"><code>error</code></dt>
<dd>
<p>In rare cases when recovering from a system crash, it may be impossible to compensate a previously completed participant.
In such cases, the <code>error</code> method is invoked.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_baparticipantmanager"><a class="anchor" href="#_baparticipantmanager"></a><code>BAParticipantManager</code></h5>
<div class="paragraph">
<p>In order for the Business Activity protocol to work correctly, the participants must be able to autonomously notify the coordinator about changes in their status.
Unlike the Atomic Transaction protocol, where all interactions between the coordinator and participants are instigated by the coordinator when the transaction terminates, the <code>BAParticipantManager</code> interaction pattern requires the participant to be able to talk to the coordinator at any time during the lifetime of the business activity.</p>
</div>
<div class="paragraph">
<p>Whenever a participant is registered with a business activity, it receives a handle on the coordinator.
This handle is an instance of interface <code>com.arjuna.wst11.BAParticipantManager</code>.</p>
</div>
<div class="dlist">
<div class="title"><code>BAParticipantManager</code> Methods</div>
<dl>
<dt class="hdlist1">exit</dt>
<dd>
<p>The participant uses the method <code>exit</code> to inform the coordinator that is has left the activity.
It will not be informed when and how the business activity terminates.
This method may only be invoked while the participant is in the <code>active</code> state (or the <code>completing</code> state, in the case of a participant registered for the <code>ParticipantCompletion</code> protocol).
If it is called when the participant is in any other state, a <code>WrongStateException</code> error is thrown.
An <code>exit</code> does not stop the activity as a whole from subsequently being closed or canceled/compensated, but only ensures that the exited participant is no longer involved in completion, close or compensation of the activity.</p>
</dd>
<dt class="hdlist1">completed</dt>
<dd>
<p>The participant has completed its work, but wishes to continue in the business activity, so that it will eventually be informed when, and how, the activity terminates.
The participant may later be asked to compensate for the work it has done or learn that the activity has been closed.</p>
</dd>
<dt class="hdlist1">fault</dt>
<dd>
<p>The participant encountered an error during normal activation and has done whatever it can to compensate the activity.
The <code>fault</code> method places the business activity into a mandatory <code>cancel-only</code> mode.
The faulted participant is no longer involved in completion, close or compensation of the activity.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="ref_userbusinessactivity"><a class="anchor" href="#ref_userbusinessactivity"></a><code>UserBusinessActivity</code></h5>
<div class="paragraph">
<p><code>com.arjuna.wst11.UserBusinessActivity</code> is the class that most clients employ.
A client begins a new business activity by first obtaining a <code>UserBusinessActivity</code> from the <code>UserBusinessActivityFactory</code>.
This class isolates them from the underlying protocol-specific aspects of the XTS implementation.
A <code>UserBusinessActivity</code> does not represent a specific business activity.
Instead, it provides access to an implicit per-thread activity.
Therefore, all of the <code>UserBusinessActivity</code> methods implicitly act on the current thread of control.</p>
</div>
<div class="dlist">
<div class="title">Methods</div>
<dl>
<dt class="hdlist1"><code>begin</code></dt>
<dd>
<p>Begins a new activity, associating it with the invoking thread.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Parameters</div>
<dl>
<dt class="hdlist1">timeout</dt>
<dd>
<p>The interval, in milliseconds, after which an activity times out.
Optional.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Exceptions</div>
<dl>
<dt class="hdlist1"><code>WrongStateException</code></dt>
<dd>
<p>The thread is already associated with a business activity.</p>
</dd>
<dt class="hdlist1"><code>close</code></dt>
<dd>
<p>First, all Coordinator Completion participants enlisted in the activity are requested to complete the activity.
Next all participants, whether they enlisted for Coordinator or Participant Completion, are requested to close the activity.
If any of the Coordinator Completion participants fails to complete at the first stage then all completed participants are asked to compensate the activity while any remaining uncompleted participants are requested to cancel the activity.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Exceptions</div>
<dl>
<dt class="hdlist1"><code>UnknownTransactionException</code></dt>
<dd>
<p>No activity is associated with the invoking thread.</p>
</dd>
<dt class="hdlist1"><code>TransactionRolledBackException</code></dt>
<dd>
<p>The activity has been cancelled because one of the Coordinator Completion participants failed to complete.
This exception may also be thrown if one of the Participant Completion participants has not completed before the client calls close.</p>
</dd>
<dt class="hdlist1"><code>cancel</code></dt>
<dd>
<p>Terminates the business activity.
All Participant Completion participants enlisted in the activity which have already completed are requested to compensate the activity.
All uncompleted Participant Completion participants and all Coordinator Completion participants are requested to cancel the activity.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Exceptions</div>
<dl>
<dt class="hdlist1"><code>UnknownTransactionException</code></dt>
<dd>
<p>No activity is associated with the invoking thread.
Any participants that previous completed are directed to compensate their work.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_userbusinessactivityfactory"><a class="anchor" href="#_userbusinessactivityfactory"></a>UserBusinessActivityFactory</h5>
<div class="paragraph">
<p>Use the <code>getUserBusinessActivity</code> method to obtain a <a href="#ref_userbusinessactivity"><code>UserBusinessActivity</code></a> instance from a <code>userBusinessActivityFactory</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="ref_businessactivitymanager"><a class="anchor" href="#ref_businessactivitymanager"></a>BusinessActivityManager</h5>
<div class="paragraph">
<p><code>com.arjuna.mw.wst11.BusinessActivityManager</code> is the class that web services typically employ.
Defines how a web service interacts with the underlying business activity service implementation.
A <code>BusinessActivityManager</code> does not represent a specific activity.
Instead, it provides access to an implicit per-thread activity.</p>
</div>
<div class="dlist">
<div class="title">Methods</div>
<dl>
<dt class="hdlist1"><code>currentTransaction</code></dt>
<dd>
<p>Returns the <code>TxContext</code> for the current business activity, or <code>NULL</code> if there is no <code>TxContext</code>.
The returned value can be used to enable multiple threads to execute within the scope of the same business activity.
Calling the <code>currenTransaction</code> method does not dissociate the current thread from its activity.</p>
</dd>
<dt class="hdlist1"><code>suspend</code></dt>
<dd>
<p>Dissociates a thread from any current business activity, so that it can perform work not associated with a specific activity.
The <code>suspend</code> method returns a <code>TxContext</code> instance, which is a handle on the activity.
The thread is then no longer associated with any activity.</p>
</dd>
<dt class="hdlist1"><code>resume</code></dt>
<dd>
<p>Associates or re-associates a thread with a business activity, using its <code>TxContext</code>.
Before associating or re-associating the thread, it is disassociated from any business activity with which it is currently associated.
If the <code>TxContext</code> is <code>NULL</code>, the thread is disassociated with all business activities, as though the <code>suspend</code> method were called.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Parameters</div>
<dl>
<dt class="hdlist1"><code>txContext</code></dt>
<dd>
<p>A TxContext instance as returned by <code>suspend</code>, identifying the transaction to be resumed.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Exceptions</div>
<dl>
<dt class="hdlist1"><code>UnknownTransactionException</code></dt>
<dd>
<p>The business activity to which the <code>TxContext</code> refers is invalid in the scope of the invoking thread.</p>
</dd>
<dt class="hdlist1"><code>enlistForBusinessAgreementWithParticipantCompletion</code></dt>
<dd>
<p>Enroll the specified participant with current business activity, causing it to participate in the <code>BusinessAgreementWithParticipantCompletion</code> protocol.
A unique identifier for the participant is also required.</p>
<div class="paragraph">
<p>The return value is an instance of BAParticipantManager which can be used to notify the coordinator of changes in the participant state.
In particular, since the participant is enlisted for the Participant Completion protcol it is expected to call the completed method of this returned instance when it has completed all the work it expects to do in this activity and has made all its changes permanent.
Alternatively, if the participant does not need to perform any compensation actions should some other participant fail it can leave the activity by calling the exit method of the returned <code>BAParticipantManager</code> instance.</p>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Parameters</div>
<dl>
<dt class="hdlist1">participant</dt>
<dd>
<p>An implementation of interface <code>BusinessAgreementWithParticipantCompletionParticipant</code> whose <code>close</code>, <code>cancel</code>, and <code>compensate</code> methods are called when the corresponding coordinator message is received.</p>
</dd>
<dt class="hdlist1"><code>id</code></dt>
<dd>
<p>A unique identifier for the participant.
The value of this String should differ for each enlisted participant.
It should also be possible for a given identifier to determine that the participant belongs to the enlisting web service rather than some other web service deployed to the same container.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Exceptions</div>
<dl>
<dt class="hdlist1"><code>UnknownTransactionException</code></dt>
<dd>
<p>No transaction is associated with the invoking thread.</p>
</dd>
<dt class="hdlist1"><code>WrongStateException</code></dt>
<dd>
<p>The transaction is not in a state where new participants may be enrolled, such as when it is terminating.</p>
</dd>
<dt class="hdlist1"><code>enlistForBusinessAgreementWithCoordinatorCompletion</code></dt>
<dd>
<p>Enroll the specified participant with current activity, causing it to participate in the <code>BusinessAgreementWithCoordinatorCompletion</code> protocol.
A unique identifier for the participant is also required.</p>
<div class="paragraph">
<p>The return value is an instance of <code>BAParticipantManager</code> which can be used to notify the coordinator of changes in the participant state.
Note that in this case it is an error to call the <code>completed</code> method of this returned instance.
With the Coordinator Completion protocol the participant is expected to wait until its <code>completed</code> method is called before it makes all its changes permanent.
Alternatively, if the participant determiens that it has no changes to make, it can leave the activity by calling the <code>exit</code> method of the returned <code>BAParticipantManager</code> instance.</p>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Parameters</div>
<dl>
<dt class="hdlist1">participant</dt>
<dd>
<p>An implementation of interface <code>BusinessAgreementWithCoordinatorCompletionParticipant</code> whose completed, close, cancel and compensate methods are called when the corresponding coordinator message is received.</p>
</dd>
<dt class="hdlist1"><code>id</code></dt>
<dd>
<p>A unique identifier for the participant.
The value of this String should differ for each enlisted participant.
It should also be possible for a given identifier to determine that the participant belongs to the enlisting web service rather than some other web service deployed to the same container.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Exceptions</div>
<dl>
<dt class="hdlist1"><code>UnknownTransactionException</code></dt>
<dd>
<p>No transaction is associated with the invoking thread.</p>
</dd>
<dt class="hdlist1"><code>WrongStateException</code></dt>
<dd>
<p>The transaction is not in a state where new participants may be enrolled, such as when it is terminating.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_businessactivitymanagerfactory"><a class="anchor" href="#_businessactivitymanagerfactory"></a><code>BusinessActivityManagerFactory</code></h5>
<div class="paragraph">
<p>Use the <code>getBusinessActivityManager</code> method to obtain a <a href="#ref_businessactivitymanager">BusinessActivityManager</a> instance from a <code>BusinessActivityManagerFactory</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stand_alone_coordination"><a class="anchor" href="#_stand_alone_coordination"></a>4.4. Stand-Alone Coordination</h3>
<div class="sect3">
<h4 id="_introduction_3"><a class="anchor" href="#_introduction_3"></a>4.4.1. Introduction</h4>
<div class="paragraph">
<p>By default, coordination contexts are obtained from the local coordinator.
Therefore, WS-AT transactions or WS-BA activities created by a locally-deployed client application are supplied with a context which identifies the Registration Service running on the client&#8217;s machine.
Any Web Services invoked by the client are coordinated by the Transaction Protocol services running on the client&#8217;s host.
This is the case whether the Web Services are running locally or remotely.
Such a configuration is called <em>local coordination</em>.</p>
</div>
<div class="paragraph">
<p>You can reconfigure this setting globally for all clients, causing context creation requests to be redirected to an Activation Coordinator Service running on a remote host.
Normally, the rest of the coordination process is executed from the remote host.
This configuration is called <em>stand-alone coordination</em>.</p>
</div>
<div class="ulist">
<div class="title">Reasons for Choosing a Stand-Alone Coordinator</div>
<ul>
<li>
<p>Efficiency: if a client application invokes Web Services on a remote WildFly Application Server, coordinating the transaction from the remote server might be more efficient, since the protocol-specific messages between the coordinator and the participants do not need to travel over the network.</p>
</li>
<li>
<p>Reliability: if the coordinator service runs on a dedicated host, there is no danger of failing applications or services affecting the coordinator and causing failures for unrelated transactions.</p>
</li>
<li>
<p>A third reason might be to use a coordination service provided by a third party vendor.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_the_activation_coordinator"><a class="anchor" href="#_configuring_the_activation_coordinator"></a>4.4.2. Configuring the Activation Coordinator</h4>
<div class="paragraph">
<p>The simplest way to configure a stand-alone coordinator is to provide a complete URL for the remote coordinator.
This can be done by changing the 'url' property of the 'xts-environment' element of the XTS Subsystem configuration in the <code>standalone-xts.xml</code>.
<a href="#example_xts_subsystem.xml">Example <code>standalone-xts.xml</code> configuration settings</a> shows the snippet of XML that you should change.</p>
</div>
<div id="example_xts_subsystem.xml" class="listingblock">
<div class="title">Example <code>standalone-xts.xml</code> configuration settings</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version='1.0' encoding='UTF-8'?&gt;</span>

<span class="tag">&lt;server</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:1.4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    . . .
    <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:xts:1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xts-environment</span> <span class="attribute-name">url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://${jboss.bind.address:127.0.0.1}:8080/ws-c11/ActivationService</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        . . .
    <span class="tag">&lt;/subsystem&gt;</span>
<span class="tag">&lt;/server&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The XTS module (<code>_modules/system/layers/base/org/jboss/xts/main/jbossxts-${XTS_VERSION}.jar</code>) in the WildFly Application Server includes a configuration file, <code>xts-properties.xml</code>, in the root of the jar.
These properties can be edited and then re-packaged in the jar.
The changes will take affect on next boot of the WildFly Application Server.
<a href="#example_xts_properties.xml">Example _xts-properties.xml_configuration settings</a> shows a fragment of this file which details the options for changing the coordinator URL.</p>
</div>
<div id="example_xts_properties.xml" class="listingblock">
<div class="title">Example _xts-properties.xml_configuration settings</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="doctype">&lt;!DOCTYPE properties SYSTEM &quot;http://java.sun.com/dtd/properties.dtd&quot;&gt;</span>
<span class="tag">&lt;properties&gt;</span>
    . . .
    <span class="comment">&lt;!-- coordinator URL
        the following entries are used in the client container only to
        identify the URL used to address the ActivationCoordinator service.
        This is the XTS service which is contacted when a begin operation
        is invoked to start a  WS-AT or WS-BA transaction.

        If a full URL is provide then it will be used as given.
        Otherwise a URL will be constructed using any URL components
        such as scheme, host etc which have been specified as properties
        and defaulting any remaining unspecified properties.
        if no URL or components are specified the URL defaults to that
        of the local coordinator service.
    --&gt;</span>

    <span class="comment">&lt;!-- 1.1 properties : only set if you want to use a non-local coordinator
    --&gt;</span>
    <span class="comment">&lt;!--
    &lt;entry key=&quot;org.jboss.jbossts.xts11.coordinatorURL&quot;&gt;http://localhost:8080/ws-c11/ActivationService&lt;/entry&gt;
    &lt;entry key=&quot;org.jboss.jbossts.xts11.coordinator.scheme&quot;&gt;http&lt;/entry&gt;
    &lt;entry key=&quot;org.jboss.jbossts.xts11.coordinator.address&quot;&gt;localhost&lt;/entry&gt;
    &lt;entry key=&quot;org.jboss.jbossts.xts11.coordinator.port&quot;&gt;8080&lt;/entry&gt;
    &lt;entry key=&quot;org.jboss.jbossts.xts11.coordinator.path&quot;&gt;ws-c11/ActivationService&lt;/entry&gt;
    --&gt;</span>
<span class="tag">&lt;/properties&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify the individual elements of the URL using the properties <code>coordinator.scheme</code>, <code>coordinator.address</code>, and so forth.
These values only apply when the <code>coordinator.url</code> is not set.
The URL is constructed by combining the specified values with default values for any missing elements.
This is particularly useful for two specific use cases.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The first case is where the client is expected to use an XTS coordinator deployed in another WildFly Application Server.
If, for example, this WildFly Application Server is bound to address <code>10.0.1.99</code> , setting property <code>coordinator.address</code> to <code>10.0.1.99</code> is normally all that is required to configure the coordinator URL to identity the remote WildFly Application Server&#8217;s coordination service.
If the Web service on the remote WildFly Application Server were reset to <code>9090</code> then it would also be necessary to set property <code>coordinator.port</code> to this value.</p>
</li>
<li>
<p>The second common use case is where communications between client and coordinator, and between participant and coordinator, must use secure connections.
If property <code>coordinator.scheme</code> is set to value <code>https</code>, the client&#8217;s request to begin a transaction is sent to the coordinator service over a secure https connection.
The XTS coordinator and participant services will ensure that all subsequent communications between coordinator and client or coordinator and web services also employ secure https connections.
Note that this requires configuring the trust stores in the WildFly Application Server running the client, coordinator and participant web services with appropriate trust certificates.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The property names have been abbreviated in order to fit into the table.
They should each start with prefix <code>org.jboss.jbossts.xts11.coordinator</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Command-Line Options Passed with the <code>-DParameter</code>, Ordered by Priority</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Category</th>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Format</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Absolute URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code class="var">...coordinatorURL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://coord.host:coord.port/ws-c11/ActivationService" class="bare">http://coord.host:coord.port/ws-c11/ActivationService</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Coordinator Scheme, Host, Port, and Path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>...coordinator.scheme</code>,
<code>...coordinator.address</code>,
<code>...coordinator.port</code>,
<code>...coordinator.path</code>,</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>http</code>, <code>server.bind.address</code>, <code>jboss.web.bind.port</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_participant_crash_recovery"><a class="anchor" href="#_participant_crash_recovery"></a>4.5. Participant Crash Recovery</h3>
<div class="paragraph">
<p>A key requirement of a transaction service is to be resilient to a system crash by a host running a participant, as well as the host running the transaction coordination services.
Crashes which happen before a transaction terminates or before a business activity completes are relatively easy to accommodate.
The transaction service and participants can adopt a <code>presumed abort</code> policy.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Presumed Abort Policy</div>
<ol class="arabic">
<li>
<p>If the coordinator crashes, it can assume that any transaction it does not know about is invalid, and reject a participant request which refers to such a transaction.</p>
</li>
<li>
<p>If the participant crashes, it can forget any provisional changes it has made, and reject any request from the coordinator service to prepare a transaction or complete a business activity.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Crash recovery is more complex if the crash happens during a transaction commit operation, or between completing and closing a business activity.
The transaction service must ensure as far as possible that participants arrive at a consistent outcome for the transaction.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">WS-AT Transaction</dt>
<dd>
<p>The transaction needs to commit all provisional changes or roll them all back to the state before the transaction started.</p>
</dd>
<dt class="hdlist1">WS-Business Activity Transaction</dt>
<dd>
<p>All participants need to close the activity or cancel the activity, and run any required compensating actions.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>On the rare occasions where such a consensus cannot be reached, the transaction service must log and report transaction failures.</p>
</div>
<div class="paragraph">
<p>XTS includes support for automatic recovery of WS-AT and WS-BA transactions, if either or both of the coordinator and participant hosts crashes.
The XTS recovery manager begins execution on coordinator and participant hosts when the XTS service restarts.
On a coordinator host, the recovery manager detects any WS-AT transactions which have prepared but not committed, as well as any WS-BA transactions which have completed but not yet closed.
It ensures that all their participants are rolled forward in the first case, or closed in the second.</p>
</div>
<div class="paragraph">
<p>On a participant host, the recovery manager detects any prepared WS-AT participants which have not responded to a transaction rollback, and any completed WS-BA participants which have not yet responded to an activity cancel request, and ensures that the former are rolled back and the latter are compensated.
The recovery service also allows for recovery of subordinate WS-AT transactions and their participants if a crash occurs on a host where an interposed WS-AT coordinator has been employed.</p>
</div>
<div class="sect3">
<h4 id="_ws_at_recovery"><a class="anchor" href="#_ws_at_recovery"></a>4.5.1. WS-AT Recovery</h4>
<div class="sect4">
<h5 id="_ws_at_coordinator_crash_recovery"><a class="anchor" href="#_ws_at_coordinator_crash_recovery"></a>WS-AT Coordinator Crash Recovery</h5>
<div class="paragraph">
<p>The WS-AT coordination service tracks the status of each participant in a transaction as the transaction progresses through its two-phase commit.
When all participants have been sent a <code>prepare</code> message and have responded with a <code>prepared</code> message, the coordinator writes a log record storing each participant&#8217;s details, indicating that the transaction is ready to complete.
If the coordinator service crashes after this point has been reached, completion of the two-phase commit protocol is still guaranteed, by reading the log file after reboot and sending a <code>commit</code> message to each participant.
Once all participants have responded to the <code>commit</code> with a <code>committed</code> message, the coordinator can safely delete the log entry.</p>
</div>
<div class="paragraph">
<p>Since the <code>prepared</code> messages returned by the participants imply that they are ready to commit their provisional changes and make them permanent, this type of recovery is safe.
Additionally, the coordinator does not need to account for any commit messages which may have been sent before the crash, or resend messages if it crashes several times.
The XTS participant implementation is resilient to redelivery of the <code>commit</code> messages.
If the participant has implemented the recovery functions described in <a href="#ws_at_recovery_api">WS-AT Participant Crash Recovery APIs</a>, the coordinator can guarantee delivery of <code>commit</code> messages if both it crashes, and one or more of the participant service hosts also crash, at the same time.</p>
</div>
<div class="paragraph">
<p>If the coordination service crashes before the <code>prepare</code> phase completes, the presumed abort protocol ensures that participants are rolled back.
After system restart, the coordination service has the information about about all the transactions which could have entered the <code>commit</code> phase before the reboot, since they have entries in the log.
It also knows about any active transactions started after the reboot.
If a participant is waiting for a response, after sending its <code>prepared</code> message, it automatically re-sends the <code>prepared</code> message at regular intervals.
When the coordinator detects a transaction which is not active and has no entry in the log file after the reboot, it instructs the participant to abort, ensuring that the web service gets a chance to roll back any provisional state changes it made on behalf of the transaction.</p>
</div>
<div class="paragraph">
<p>A web service may decide to unilaterally commit or roll back provisional changes associated with a given participant, if configured to time-out after a specified length of time without a response.
In this situation, the the web service should record this action and log a message to persistent storage.
When the participant receives a request to commit or roll back, it should throw an exception if its unilateral decision action does not match the requested action.
The coordinator detects the exception and logs a message marking the outcome as heuristic.
It also saves the state of the transaction permanently in the transaction log, to be inspected and reconciled by an administrator.</p>
</div>
</div>
<div class="sect4">
<h5 id="_ws_at_participant_crash_recovery"><a class="anchor" href="#_ws_at_participant_crash_recovery"></a>WS-AT Participant Crash Recovery</h5>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This part is relevant only if Raw XTS API is used.
JTA integration does the recovery automatically.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>WS-AT participants associated with a transactional web service do not need to be involved in crash recovery if the Web service&#8217;s host machine crashes before the participant is told to prepare.
The coordinator will assume that the transaction has aborted, and the Web service can discard any information associated with unprepared transactions when it reboots.</p>
</div>
<div class="paragraph">
<p>When a participant is told to <code>prepare</code>, the Web service is expected to save to persistent storage the transactional state it needs to commit or roll back the transaction.
The specific information it needs to save is dependent on the implementation and business logic of the Web Service.
However, the participant must save this state before returning a <code>prepared</code> vote from the <code>prepare</code> call.
If the participant cannot save the required state, or there is some other problem servicing the request made by the client, it must return an <code>aborted</code> vote.</p>
</div>
<div class="paragraph">
<p>The XTS participant services running on a Web Service&#8217;s host machine cooperate with the Web service implementation to facilitate participant crash recovery.
These participant services are responsible for calling the participant&#8217;s <code>prepare</code>, <code>commit</code>, and <code>rollback</code> methods.
The XTS implementation tracks the local state of every enlisted participant.
If the <code>prepare</code> call returns a <code>prepared</code> vote, the XTS implementation ensures that the participant state is logged to the local transaction log before forwarding a <code>prepared</code> message to the coordinator.</p>
</div>
<div class="paragraph">
<p>A participant log record contains information identifying the participant, its transaction, and its coordinator.
This is enough information to allow the rebooted XTS implementation to reinstate the participant as active and to continue communication with the coordinator, as though the participant had been enlisted and driven to the prepared state.
However, a participant instance is still necessary for the commit or rollback process to continue.</p>
</div>
<div class="paragraph">
<p>Full recovery requires the log record to contain information needed by the Web service which enlisted the participant.
This information must allow it to recreate an equivalent participant instance, which can continue the <code>commit</code> process to completion, or roll it back if some other Web Service fails to <code>prepare</code> . This information might be as simple as a String key which the participant can use to locate the data it made persistent before returning its Prepared vote.
It may be as complex as a serialized object tree containing the original participant instance and other objects created by the Web service.</p>
</div>
<div class="paragraph">
<p>If a participant instance implements the relevant interface, the XTS implementation will append this participant recovery state to its log record before writing it to persistent storage.
In the event of a crash, the participant recovery state is retrieved from the log and passed to the Web Service which created it.
The Web Service uses this state to create a new participant, which the XTS implementation uses to drive the transaction to completion.
Log records are only deleted after the participant&#8217;s <code>commit</code> or <code>rollback</code> method is called.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If a crash happens just before or just after a <code>commit</code> method is called, a <code>commit</code> or <code>rollback</code> method may be called twice.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="ws_at_recovery_api"><a class="anchor" href="#ws_at_recovery_api"></a>WS-AT Participant Crash Recovery APIs</h6>
<div class="sect6">
<h7 id="_saving_participant_recovery_state"><a class="anchor" href="#_saving_participant_recovery_state"></a>Saving Participant Recovery State</h7>
<div class="paragraph">
<p>When a Business Activity participant web service completes its work, it may want to save the information which will be required later to close or compensate actions performed during the activity.
The XTS implementation automatically acquires this information from the participant as part of the completion process and writes it to a participant log record.
This ensures that the information can be restored and used to recreate a copy of the participant even if the web service container crashes between the complete and close or compensate operations.</p>
</div>
<div class="paragraph">
<p>For a Participant Completion participant, this information is acquired when the web service invokes the <code>completed</code> method of the <code>BAParticipantManager</code> instance returned from the call which enlisted the participant.
For a Coordinator Completion participant this occurs immediately after the call to it&#8217;s <code>completed</code> method returns.
This assumes that the <code>completed</code> method does not throw an exception or call the participant manager&#8217;s <code>cannotComplete</code> or <code>fail</code> method.</p>
</div>
<div class="paragraph">
<p>A participant may signal that it is capable of performing recovery processing, by implementing the <code>java.lang.Serializable</code> interface.
An alternative is to implement the <a href="#example_persistableatparticipant"><code>PersistableATParticipant</code> Interface</a>.</p>
</div>
<div id="example_persistableatparticipant" class="listingblock">
<div class="title"><code>PersistableATParticipant</code> Interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">PersistableATParticipant</span> {
    <span class="type">byte</span><span class="type">[]</span> getRecoveryState() <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a participant implements the <code>Serializable</code> interface, the XTS participant services implementation uses the serialization API to create a version of the participant which can be appended to the participant log entry.
If it implements the <code>PersistableATParticipant</code> interface, the XTS participant services implementation call the <code>getRecoveryState</code> method to obtain the state to be appended to the participant log entry.</p>
</div>
<div class="paragraph">
<p>If neither of these APIs is implemented, the XTS implementation logs a warning message and proceeds without saving any recovery state.
In the event of a crash on the host machine for the Web service during commit, the transaction cannot be recovered and a heuristic outcome may occur.
This outcome is logged on the host running the coordinator services.</p>
</div>
</div>
<div class="sect6">
<h7 id="_recovering_participants_at_reboot"><a class="anchor" href="#_recovering_participants_at_reboot"></a>Recovering Participants at Reboot</h7>
<div class="paragraph">
<p>A Web service must register with the XTS implementation when it is deployed, and unregister when it is undeployed, in order to participate in recovery processing.
Registration is performed using class <code>XTSATRecoveryManager</code> defined in package <code>org.jboss.jbossts.xts.recovery.participant.at</code>.</p>
</div>
<div class="listingblock">
<div class="title">Registering for Recovery</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">XTSATRecoveryManager</span> {
    ...

    public <span class="directive">static</span> XTSATRecoveryManager getRecoveryManager();

    <span class="directive">public</span> <span class="type">void</span> registerRecoveryModule(XTSATRecoveryModule module);

    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">void</span> unregisterRecoveryModule(XTSATRecoveryModule module)
            <span class="directive">throws</span> <span class="exception">NoSuchElementException</span>;
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Web service must provide an implementation of interface <code>XTSBARecoveryModule</code> in package <code>org.jboss.jbossts.xts.recovery.participant.ba</code>, as an argument to the <code>register</code> and <code>unregister</code> calls.
This instance identifies saved participant recovery records and recreates new, recovered participant instances:</p>
</div>
<div class="listingblock">
<div class="title"><code>XTSBARecoveryModule</code> Interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">XTSATRecoveryModule</span> {
    <span class="directive">public</span> Durable2PCParticipant
    deserialize(<span class="predefined-type">String</span> id, <span class="predefined-type">ObjectInputStream</span> stream)
            <span class="directive">throws</span> <span class="exception">Exception</span>;

    <span class="directive">public</span> Durable2PCParticipant
    recreate(<span class="predefined-type">String</span> id, <span class="type">byte</span><span class="type">[]</span> recoveryState)
            <span class="directive">throws</span> <span class="exception">Exception</span>;

    <span class="directive">public</span> <span class="type">void</span> endScan();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a participant&#8217;s recovery state was saved using serialization, the recovery module&#8217;s <code>deserialize</code> method is called to recreate the participant.
Normally, the recovery module is required to read, cast, and return an object from the supplied input stream.
If a participant&#8217;s recovery state was saved using the <code>PersistableATParticipant</code> interface, the recovery module&#8217;s <code>recreate</code> method is called to recreate the participant from the byte array it provided when the state was saved.</p>
</div>
<div class="paragraph">
<p>The XTS implementation cannot identify which participants belong to which recovery modules.
A module only needs to return a participant instance if the recovery state belongs to the module&#8217;s Web service.
If the participant was created by another Web service, the module should return <code>null</code>.
The participant identifier, which is supplied as argument to the <code>deserialize</code> or <code>recreate</code> method, is the identifier used by the Web service when the original participant was enlisted in the transaction.
Web Services participating in recovery processing should ensure that participant identifiers are unique per service.
If a module recognizes that a participant identifier belongs to its Web service, but cannot recreate the participant, it should throw an exception.
This situation might arise if the service cannot associate the participant with any transactional information which is specific to the business logic.</p>
</div>
<div class="paragraph">
<p>Even if a module relies on serialization to create the participant recovery state saved by the XTS implementation, it still must be registered by the application.
The <code>deserialization</code> operation must employ a class loader capable of loading classes specific to the Web service.
XTS fulfills this requirement by devolving responsibility for the <code>deserialize</code> operation to the recovery module.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ws_ba_recovery"><a class="anchor" href="#_ws_ba_recovery"></a>4.5.2. WS-BA Recovery</h4>
<div class="sect4">
<h5 id="_ws_ba_coordinator_crash_recovery"><a class="anchor" href="#_ws_ba_coordinator_crash_recovery"></a>WS-BA Coordinator Crash Recovery</h5>
<div class="paragraph">
<p>The WS-BA coordination service implementation tracks the status of each participant in an activity as the activity progresses through completion and closure.
A transition point occurs during closure, once all <code>CoordinatorCompletion</code> participants receive a <code>complete</code> message and respond with a <code>completed</code> message.
At this point, all <code>ParticipantCompletion</code> participants should have sent a <code>completed</code> message.
The coordinator writes a log record storing the details of each participant, and indicating that the transaction is ready to close.
If the coordinator service crashes after the log record is written, the <code>close</code> operation is still guaranteed to be successful.
The coordinator checks the log after the system reboots and re-sends a <code>close</code> message to all participants.
After all participants respond to the <code>close</code> with a <code>closed</code> message, the coordinator can safely delete the log entry.</p>
</div>
<div class="paragraph">
<p>The coordinator does not need to account for any <code>close</code> messages sent before the crash, nor resend messages if it crashes several times.
The XTS participant implementation is resilient to redelivery of <code>close</code> messages.
Assuming that the participant has implemented the recovery functions described below, the coordinator can even guarantee delivery of <code>close</code> messages if both it, and one or more of the participant service hosts, crash simultaneously.</p>
</div>
<div class="paragraph">
<p>If the coordination service crashes before it has written the log record, it does not need to explicitly compensate any completed participants.
The presumed abort protocol ensures that all completed participants are eventually sent a <code>compensate</code> message.
Recovery must be initiated from the participant side.</p>
</div>
<div class="paragraph">
<p>A log record does not need to be written when an activity is being canceled.
If a participant does not respond to a <code>cancel</code> or <code>compensate</code> request, the coordinator logs a warning and continues.
The combination of the presumed abort protocol and participant-led recovery ensures that all participants eventually get canceled or compensated, as appropriate, even if the participant host crashes.</p>
</div>
<div class="paragraph">
<p>If a completed participant does not detect a response from its coordinator after resending its <code>completed</code> response a suitable number of times, it switches to sending <code>getstatus</code> messages, to determine whether the coordinator still knows about it.
If a crash occurs before writing the log record, the coordinator has no record of the participant when the coordinator restarts, and the <code>getstatus</code> request returns a fault.
The participant recovery manager automatically compensates the participant in this situation, just as if the activity had been canceled by the client.</p>
</div>
<div class="paragraph">
<p>After a participant crash, the participant recovery manager detects the log entries for each completed participant.
It sends <code>getstatus</code> messages to each participant&#8217;s coordinator host, to determine whether the activity still exists.
If the coordinator has not crashed and the activity is still running, the participant switches back to resending <code>completed</code> messages, and waits for a <code>close</code> or <code>compensate</code> response.
If the coordinator has also crashed or the activity has been canceled, the participant is automatically canceled.</p>
</div>
</div>
<div class="sect4">
<h5 id="_ws_ba_participant_crash_recovery_apis"><a class="anchor" href="#_ws_ba_participant_crash_recovery_apis"></a>WS-BA Participant Crash Recovery APIs</h5>
<div class="sect5">
<h6 id="_saving_participant_recovery_state_2"><a class="anchor" href="#_saving_participant_recovery_state_2"></a>Saving Participant Recovery State</h6>
<div class="paragraph">
<p>A participant may signal that it is capable of performing recovery processing, by implementing the <code>java.lang.Serializable</code> interface.
An alternative is to implement the <a href="#example_persistablebaparticipant">`PersistableBAParticipant`Interface</a>.</p>
</div>
<div id="example_persistablebaparticipant" class="listingblock">
<div class="title">`PersistableBAParticipant`Interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">PersistableBAParticipant</span> {
    <span class="type">byte</span><span class="type">[]</span> getRecoveryState() <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a participant implements the <code>Serializable</code> interface, the XTS participant services implementation uses the serialization API to create a version of the participant which can be appended to the participant log entry.
If the participant implements the <code>PersistableBAParticipant</code>, the XTS participant services implementation call the <code>getRecoveryState</code> method to obtain the state, which is appended to the participant log entry.</p>
</div>
<div class="paragraph">
<p>If neither of these APIs is implemented, the XTS implementation logs a warning message and proceeds without saving any recovery state.
If the Web service&#8217;s host machine crashes while the activity is being closed, the activity cannot be recovered and a heuristic outcome will probably be logged on the coordinator&#8217;s host machine.
If the activity is canceled, the participant is not compensated and the coordinator host machine may log a heuristic outcome for the activity.</p>
</div>
</div>
<div class="sect5">
<h6 id="_recovering_participants_at_reboot_2"><a class="anchor" href="#_recovering_participants_at_reboot_2"></a>Recovering Participants at Reboot</h6>
<div class="paragraph">
<p>A Web service must register with the XTS implementation when it is deployed, and unregister when it is undeployed, so it can take part in recovery processing.</p>
</div>
<div class="paragraph">
<p>Registration is performed using the <code>XTSBARecoveryManager</code>, defined in the <code>org.jboss.jbossts.xts.recovery.participant.ba</code> package.</p>
</div>
<div class="listingblock">
<div class="title"><code>XTSBARecoveryManager</code> Class</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">XTSBARecoveryManager</span> {
    ...

    public <span class="directive">static</span> XTSBARecoveryManager getRecoveryManager();

    <span class="directive">public</span> <span class="type">void</span> registerRecoveryModule(XTSBARecoveryModule module);

    <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">void</span> unregisterRecoveryModule(XTSBARecoveryModule module)
            <span class="directive">throws</span> <span class="exception">NoSuchElementException</span>;
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Web service must provide an implementation of the <code>XTSBARecoveryModule</code> in the <code>org.jboss.jbossts.xts.recovery.participant.ba</code>, as an argument to the <code>register</code> and <code>unregister</code> calls.
This instance identifies saved participant recovery records and recreates new, recovered participant instances:</p>
</div>
<div class="listingblock">
<div class="title">`XTSBARecoveryModule`Interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">XTSBARecoveryModule</span> {
    <span class="directive">public</span> BusinessAgreementWithParticipantCompletionParticipant
    deserializeParticipantCompletionParticipant(<span class="predefined-type">String</span> id,
                                                <span class="predefined-type">ObjectInputStream</span> stream)
            <span class="directive">throws</span> <span class="exception">Exception</span>;

    <span class="directive">public</span> BusinessAgreementWithParticipantCompletionParticipant
    recreateParticipantCompletionParticipant(<span class="predefined-type">String</span> id,
                                             <span class="type">byte</span><span class="type">[]</span> recoveryState)
            <span class="directive">throws</span> <span class="exception">Exception</span>;

    <span class="directive">public</span> BusinessAgreementWithCoordinatorCompletionParticipant
    deserializeCoordinatorCompletionParticipant(<span class="predefined-type">String</span> id,
                                                <span class="predefined-type">ObjectInputStream</span> stream)
            <span class="directive">throws</span> <span class="exception">Exception</span>;

    <span class="directive">public</span> BusinessAgreementWithCoordinatorCompletionParticipant
    recreateCoordinatorCompletionParticipant(<span class="predefined-type">String</span> id,
                                             <span class="type">byte</span><span class="type">[]</span> recoveryState)
            <span class="directive">throws</span> <span class="exception">Exception</span>;

    <span class="directive">public</span> <span class="type">void</span> endScan();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a participant&#8217;s recovery state was saved using serialization, one of the recovery module&#8217;s <code>deserialize</code> methods is called, so that it can recreate the participant.
Which method to use depends on whether the saved participant implemented the <code>ParticipantCompletion</code> protocol or the <code>CoordinatorCompletion</code> protocol.
Normally, the recovery module reads, casts and returns an object from the supplied input stream.
If a participant&#8217;s recovery state was saved using the <code>PersistableBAParticipant</code> interface, one of the recovery module&#8217;s <code>recreate</code> methods is called, so that it can recreate the participant from the byte array provided when the state was saved.
The method to use depends on which protocol the saved participant implemented.</p>
</div>
<div class="paragraph">
<p>The XTS implementation does not track which participants belong to which recovery modules.
A module is only expected to return a participant instance if it can identify that the recovery state belongs to its Web service.
If the participant was created by some other Web service, the module should return <code>null</code>.
The participant identifier supplied as an argument to the <code>deserialize</code> or <code>recreate</code> calls is the identifier used by the Web service when the original participant was enlisted in the transaction.
Web Services which participate in recovery processing should ensure that the participant identifiers they employ are unique per service.
If a module recognizes a participant identifier as belonging to its Web service, but cannot recreate the participant, it throws an exception.
This situation might arise if the service cannot associate the participant with any transactional information specific to business logic.</p>
</div>
<div class="paragraph">
<p>A module must be registered by the application, even when it relies upon serialization to create the participant recovery state saved by the XTS implementation.
The <code>deserialization</code> operation must employ a class loader capable of loading Web service-specific classes.
The XTS implementation achieves this by delegating responsibility for the <code>deserialize</code> operation to the recovery module.</p>
</div>
</div>
<div class="sect5">
<h6 id="_securing_web_service_state_changes"><a class="anchor" href="#_securing_web_service_state_changes"></a>Securing Web Service State Changes</h6>
<div class="paragraph">
<p>When a BA participant completes, it is expected to commit changes to the web service state made during the activity.
The web service usually also needs to persist these changes to a local storage device.
This leaves open a window where the persisted changes may not be guarded with the necessary compensation information.
The web service container may crash after the changes to the service state have been written but before the XTS implementation is able to acquire the recovery state and write a recovery log record for the participant.
Participants may close this window by employing a two phase update to the local store used to persist the web service state.</p>
</div>
<div class="paragraph">
<p>A participant which needs to persist changes to local web service state should implement interface <code>ConfirmCompletedParticipant</code> in package <code>com.arjuna.wst11</code>.
This signals to the XTS implementation that it expects confirmation after a successful write of the participant recovery record, allowing it to roll forward provisionally persisted changes to the web service state.
Delivery of this confirmation can be guaranteed even if the web service container crashes after writing the participant log record.
Conversely, if a recovery record cannot be written because of a fault or a crash prior to writing, the provisional changes can be guaranteed to be rolled back.</p>
</div>
<div class="listingblock">
<div class="title"><code>ConfirmCompletedParticipant</code> Interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ConfirmCompletedParticipant</span> {
    <span class="directive">public</span> <span class="type">void</span> confirmCompleted(<span class="type">boolean</span> confirmed);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the participant is ready to complete, it should prepare its persistent changes by temporarily locking access to the relevant state in the local store and writing the changed data to disk, retaining both the old and new versions of the service state.
For a Participant Completion participant, this prepare operation should be done just before calling the participant manager&#8217;s <code>completed</code> method.
For a Coordinator Completion participant, it should be done just before returning from the call to the participant&#8217;s <code>completed</code> method.
After writing the participant log record, the XTS implementation calls the participant&#8217;s <code>confirmCompleted</code> method, providing value <code>true</code> as the argument.
The participant should respond by installing the provisional state changes and releasing any locks.
If the log record cannot be written, the XTS implementation calls the participant&#8217;s <code>confirmCompleted</code> method, providing value <code>false</code> as the argument.
The participant should respond by restoring the original state values and releasing any locks.</p>
</div>
<div class="paragraph">
<p>If a crash occurs before the call to <code>confirmCompleted</code>, the application&#8217;s recovery module can make sure that the provisional changes to the web service state are rolled forward or rolled back as appropriate.
The web service must identify all provisional writes to persistent state before it starts serving new requests or processing recovered participants.
It must reobtain any locks required to ensure that the state is not changed by new transactions.
When the recovery module recovers a participant from the log, its compensation information is available.
If the participant still has prepared changes, the recovery code must call <code>confirmCompleted</code>, passing value true.
This allows the participant to finish the <code>complete</code> operation.
The XTS implementation then forwards a <code>completed</code> message to the coordinator, ensuring that the participant is subsequently notified either to close or to compensate.
At the end of the first recovery scan, the recovery module may find some prepared changes on disk which are still unaccounted for.
This means that the participant recovery record is not available.
The recovery module should restore the original state values and release any locks.
The XTS implementation responds to coordinator requests regarding the participant with an <code>unknown participant</code> fault, forcing the activity as a whole to be rolled back.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_web_service_transaction_service_xts_management"><a class="anchor" href="#_web_service_transaction_service_xts_management"></a>4.6. Web Service Transaction Service (XTS) Management</h3>
<div class="paragraph">
<p>The basic building blocks of a transactional Web Services application include the application itself, the Web services that the application consumes, the Transaction Manager, and the transaction participants which support those Web services.
Although it is likely that different developers will be responsible for each piece, the concepts are presented here so that you can see the whole picture.
Often, developers produce services, or applications that consume services, and system administrators run the transaction-management infrastructure.</p>
</div>
<div class="sect3">
<h4 id="_transaction_manager_overview"><a class="anchor" href="#_transaction_manager_overview"></a>4.6.1. Transaction manager overview</h4>
<div class="paragraph">
<p>The transaction manager is a Web service which coordinates XTS transactions.
It is the only software component in XTS that is designed to be run directly as a network service, rather than to support end-user code.
The transaction manager runs as a JAXM request/response Web service.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When starting up an application server instance that has XTS transaction manager deployed within it, you may see various <code>error</code> messages in the console or log.
For example, <code>16:53:38,850 ERROR [STDERR] Message Listener Service: started, message listener jndi name activationcoordinator</code>.
These are for information purposes only and are not actual errors.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_the_transaction_manager"><a class="anchor" href="#_configuring_the_transaction_manager"></a>4.6.2. Configuring the transaction manager</h4>
<div class="paragraph">
<p>You can configure the Transaction Manager and related infrastructure by using two properties files.
The <code>standalone-xts.xml</code> file contains the common configuration options.
More advanced options can be configured in the <code>xts-properties.xml_</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The XTS module (<code>modules/system/layers/base/org/jboss/xts/main/jbossxts-${XTS_VERSION}.jar</code>)
in the WildFly Application Server
includes the configuration file, <code>xts-properties.xml</code>,
in the root of the jar.
These properties can be edited and then
re-packaged in the jar.
The changes will take affect on next boot of the WildFly Application Server.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_deployment_descriptors"><a class="anchor" href="#_deployment_descriptors"></a>4.6.3. Deployment descriptors</h4>
<div class="paragraph">
<p>In general, changing the contents of the various deployment descriptors used by XTS is not necessary.
However, if you do need to modify them they are all included in <code>modules/system/layers/base/org/jboss/xts/main/jbossxts-${XTS_VERSION}.jar</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_quickstarts_overview"><a class="anchor" href="#_quickstarts_overview"></a>4.7. Quickstarts Overview</h3>
<div class="paragraph">
<p>There are multiple quickstarts provided on Narayana GitHub repository which should give you a better understanding of how to use our software.
This chapter will give you a brief overview where to find them and what technologies they demonstrate.</p>
</div>
<div class="sect3">
<h4 id="ref_wsatmultiservice"><a class="anchor" href="#ref_wsatmultiservice"></a>4.7.1. WS-AT Multi-Service</h4>
<div class="paragraph">
<p>Quickstart URL: <a href="https://github.com/jbosstm/quickstart/tree//XTS/wsat-jta-multi_service" class="bare">https://github.com/jbosstm/quickstart/tree//XTS/wsat-jta-multi_service</a></p>
</div>
<div class="paragraph">
<p>This quickstart uses JTA to manage WS-AT applications.
The quickstart is composed of a client (the test) and two Web services (<code>FirstServiceAT</code> and <code>SecondServiceAT</code>).
Both services are invoked by the test from within the same JTA transaction.</p>
</div>
<div class="paragraph">
<p>The Client begins a JTA transaction and then invokes an operation on each service.
Transaction context propagation is enabled by default.
Therefore XTS automatically bridges the JTA transaction to a WS-AT transaction before each invocation is made.</p>
</div>
<div class="paragraph">
<p>Each service uses JPA to persist its data (the value of a counter).
Therefore, the service class is annotated with <code>jakarta.ejb.TransactionAttribute</code> which tells XTS to automatically bridge WS-AT transaction to JTA.</p>
</div>
</div>
<div class="sect3">
<h4 id="ref_wsatmultihop"><a class="anchor" href="#ref_wsatmultihop"></a>4.7.2. WS-AT Multi-Hop</h4>
<div class="paragraph">
<p>Quickstart URL: <a href="https://github.com/jbosstm/quickstart/tree//XTS/wsat-jta-multi_hop" class="bare">https://github.com/jbosstm/quickstart/tree//XTS/wsat-jta-multi_hop</a></p>
</div>
<div class="paragraph">
<p>This quickstart uses JTA to manage WS-AT applications.
The quickstart is composed of a client (the test) and two Web services (<code>FirstServiceAT</code> and <code>SecondServiceAT</code>).</p>
</div>
<div class="paragraph">
<p>The Client begins a JTA transaction and then invokes an operation on <code>FirstServiceAT</code>.
Transaction context propagation is enabled by default.
Therefore XTS automatically bridges the JTA transaction to a WS-AT transaction before the invocation is made.</p>
</div>
<div class="paragraph">
<p><code>FirstServiceAT</code> uses JPA to persist its data.
Therefore, the service class is annotated with <code>jakarta.ejb.TransactionAttribute</code> which tells XTS to automatically bridge WS-AT transaction to JTA.
The <code>FirstServiceAT</code> Web Service updates some local data and then invokes the <code>SecondServiceAT</code> Web services.</p>
</div>
<div class="paragraph">
<p>Similarly, to when invoking <code>FirstServiceAT</code>, the JTA transaction is bridged to a WS-AT transaction when invoking <code>SecondServiceAT</code>.
<code>SecondServiceAT</code> also uses JPA for persistence, so the incoming WS-AT transaction is again bridged to JTA.</p>
</div>
</div>
<div class="sect3">
<h4 id="_xts_with_ssl"><a class="anchor" href="#_xts_with_ssl"></a>4.7.3. XTS with SSL</h4>
<div class="paragraph">
<p>Quickstart URL: <a href="https://github.com/jbosstm/quickstart/tree//XTS/ssl" class="bare">https://github.com/jbosstm/quickstart/tree//XTS/ssl</a></p>
</div>
<div class="paragraph">
<p>This example walks you through the steps required to setup two servers (client and server) that communicate via Web services over a secure connection.
The example show how this can be done for WS-Atomic Transaction, but the same applies for WS Business Activity.</p>
</div>
</div>
<div class="sect3">
<h4 id="_raw_xts_api_demo"><a class="anchor" href="#_raw_xts_api_demo"></a>4.7.4. Raw XTS API Demo</h4>
<div class="paragraph">
<p>Quickstart URL: <a href="https://github.com/jbosstm/quickstart/tree//XTS/raw-xts-api-demo" class="bare">https://github.com/jbosstm/quickstart/tree//XTS/raw-xts-api-demo</a></p>
</div>
<div class="paragraph">
<p>This example demonstrates the whole range of XTS possibilities, including WS-AT and WS-BA.</p>
</div>
<div class="paragraph">
<p>This example uses the Raw XTS API.
It is only recommended for scenarios where the WS-AT to JTA integration is not appropriate; or where the Compensating Transactions API support for WS-BA is not appropriate.</p>
</div>
</div>
<div class="sect3">
<h4 id="ref_compensationsnontransactionalresource"><a class="anchor" href="#ref_compensationsnontransactionalresource"></a>4.7.5. Non-transactional Resource with Compensating Transactions API</h4>
<div class="paragraph">
<p>Quickstart URL: <a href="https://github.com/jbosstm/quickstart/tree//compensating-transactions/non-transactional_resource" class="bare">https://github.com/jbosstm/quickstart/tree//compensating-transactions/non-transactional_resource</a></p>
</div>
<div class="paragraph">
<p>This example demonstrates the simple use case of our API for developing applications that use Compensating Transactions.
It shows how a non-transactional activity (such as sending an email, or printing a document) can be coordinated in a compensating transaction.</p>
</div>
</div>
<div class="sect3">
<h4 id="ref_compensationstravelagent"><a class="anchor" href="#ref_compensationstravelagent"></a>4.7.6. Travel Agent with Compensating Transactions API</h4>
<div class="paragraph">
<p>Quickstart URL: <a href="https://github.com/jbosstm/quickstart/tree//compensating-transactions/travel-agent" class="bare">https://github.com/jbosstm/quickstart/tree//compensating-transactions/travel-agent</a></p>
</div>
<div class="paragraph">
<p>This example demonstrates the more complex use case of our API for developing applications that use Compensating Transactions.
It shows how a long running compensating transaction can be composed of a series of short-running ACID transactions.
The example also involves multiple organisations and forms a distributed transaction over Web Services.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_txbridge"><a class="anchor" href="#_txbridge"></a>5. TXBridge Guide</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_4"><a class="anchor" href="#_introduction_4"></a>5.1. Introduction</h3>
<div class="sect3">
<h4 id="_contextual_overview"><a class="anchor" href="#_contextual_overview"></a>5.1.1. Contextual Overview</h4>
<div class="paragraph">
<p>Transactions provide a structuring mechanism for business logic.
Use of transactions allows for grouping of data manipulations into constructs with certain properties.
Traditional ACID transactions provide for properties of Atomicity, Consistency, Isolation and Durability.</p>
</div>
<div class="paragraph">
<p>In JavaEE applications, transaction support is provided via the Java Transaction API (JTA).
The classes and interfaces in the <code>jakarta.transaction</code> and <code>javax.transaction.xa</code> packages provide a means by which the programmer may manage transaction demarcation (<code>begin</code>, <code>commit</code>, <code>rollback</code>) and, where necessary, interact with the transaction management system (e.g. <code>enlistResource</code>).
In many JavaEE applications, further abstractions are provided on top of the JTA.
For example, EJB3 <code>@TransactionAttribute</code> annotations may be used for transaction boundary demarcation in preference to explicit calls to the JTA&#8217;s UserTransaction interface.</p>
</div>
<div class="paragraph">
<p>In distributed applications, the JTA implementation may provide propagation of transaction context and transaction control calls between containers (JVMs) using either a propriety transport or JTS, the Java mapping of the CORBA OTS standard on an RMI/IIOP transport.
In Narayana, both local and distributed (JTS) implementations of the JTA are available.</p>
</div>
<div class="paragraph">
<p>In Web Services applications, ACID transaction management and interoperable context propagation is provided for by the WS-AT standard.
Narayana XTS provides an implementation of both the 1.1 and 1.2 versions of this standard.
Bridging is provided only on the more recent version.
At the time of writing the standard covers only the web services API and protocol, not the Java API through which the protocol may be driven.
Therefore, XTS provides a custom Java API to users, with characteristics broadly similar to the JTA.</p>
</div>
<div class="paragraph">
<p>For applications that combine traditional JavaEE transaction management and Web Service transaction management, it is often desirable to have some mechanism for linking these transaction types, such that a single transaction may span business logic written for either transaction type.
Examples include exposing existing JavaEE transactional business logic (e.g. EJBs) as transactional Web Services, or allowing JavaEE transactional components to utilize transactional Web Services.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transaction_bridging"><a class="anchor" href="#_transaction_bridging"></a>5.1.2. Transaction Bridging</h4>
<div class="paragraph">
<p>We use the term Transaction Bridging to describe the process of linking the JavaEE and Web Services transaction domains.
The transaction bridge component (txbridge) of Narayana provides bi-directional linkage, such that either type of transaction may encompass business logic designed for use with the other type.</p>
</div>
<div class="paragraph">
<p>The technique used by the bridge is a combination of interposition and protocol mapping.</p>
</div>
<div class="paragraph">
<p>Interposition is used in transaction systems to allow a tree of transaction coordinators to be constructed, usually for performance reasons.
Interposed coordinators function as transaction managers for nodes below them in the tree, whilst appearing as resources (participants in WS-AT terminology) to the node above them.</p>
</div>
<div class="paragraph">
<p>Within a single transaction domain, interposition may be used to allow remote nodes to minimize the number of network calls necessary at transaction termination.
The top level node is known as the root coordinator, whilst interposed coordinators are termed subordinate.
This name indicates that they are not autonomously responsible for determining the transaction outcome, but rather are driven by their parent coordinator.
Therefore, whilst a top level coordinator exposes only the <code>commit</code> and <code>rollback</code> methods for transaction termination and handles the 2PC internally, the subordinates additionally expose the prepare method to their parent, behaving much like resources during the termination protocol.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/txbridge-guide-interposition.png" alt="txbridge guide interposition">
</div>
<div class="title">Figure 13. Transaction interposition in a distributed JTA environment</div>
</div>
<div class="paragraph">
<p>In the transaction bridge, an interposed coordinator is registered into the existing transaction and performs the additional task of protocol mapping.
That is, it appears to its parent coordinator to be a resource of its native transaction type, whilst appearing to its children to be a coordinator of their native transaction type, even though these transaction types differ.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/txbridge-guide-bridgeinterposition.png" alt="txbridge guide bridgeinterposition">
</div>
<div class="title">Figure 14. Transactional bridging interposition</div>
</div>
<div class="paragraph">
<p>The interposed coordinator is responsible for performing mapping between the transaction protocols.
There is a strong correspondence between the API and protocol used by the JTA and WS-AT transaction types, which is unsurprising given their common heritage and shared problem domain.
However, method signatures, exception types and such do differ.
The bridge provides a abstraction layer to mask these distinctions as far as possible.</p>
</div>
<div class="paragraph">
<p>The net result of this is that existing business logic perceives its expected transaction environment, even though the transaction in which it is executing may be subordinate to one of a different type.
No changes are necessary to existing transactional applications to allow them to operate in the scope of foreign transactions.
This facilitates reuse of existing business logic components in new environments and increases the possibilities for new architectures and interoperability.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transaction_bridge_architecture"><a class="anchor" href="#_transaction_bridge_architecture"></a>5.2. Transaction <code>Bridge</code> Architecture</h3>
<div class="sect3">
<h4 id="_overview_2"><a class="anchor" href="#_overview_2"></a>5.2.1. Overview</h4>
<div class="paragraph">
<p>The transaction bridge resides in the package <code>org.jboss.jbossts.txbridge</code> and its <code>subpackages.</code>.
It consists of two distinct sets of classes, one for bridging in each direction.</p>
</div>
<div class="paragraph">
<p>The process of inflowing a WS-AT transaction context on a Web Service call into the container and converting it to a local JTA transaction context such that existing transactional JavaEE code (e.g. EJBs) may be called within its scope, is termed Inbound Transaction Bridging.
When using inbound bridging, a parent WS-AT transaction coordinator has a subordinate JTA coordinator interposed into it via the transaction bridge.</p>
</div>
<div class="paragraph">
<p>The process of outflowing a WS-AT transaction context on a call to a transactional Web Service from a business logic method operating in a JavaEE transaction scope, is termed Outbound Transaction Bridging.
When using outbound bridging, a parent JTA transaction coordinator has a subordinate WS-AT coordinator interposed into it via the transaction bridge.</p>
</div>
<div class="paragraph">
<p>For the purpose of understanding this naming convention, it is simplest to view the JTA as being local to the container in which it operates, whilst the Web Service protocol provides for transaction context propagation between servers.
This is an accurate representation of the situation that exists where the local JTA version of Narayana is being used alongside Narayana XTS in an application server.
However, it is an oversimplification of the situation where the JTS option is used.
We will return to this case later.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/txbridge-guide-architecture.png" alt="txbridge guide architecture">
</div>
<div class="title">Figure 15. Simplified <code>Bridge</code> Architecture</div>
</div>
</div>
<div class="sect3">
<h4 id="_shared_design_elements"><a class="anchor" href="#_shared_design_elements"></a>5.2.2. Shared Design Elements</h4>
<div class="paragraph">
<p>The design of the inbound and outbound bridges is conceptually very similar.
Each provides the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>BridgeManager</code>, essentially a factory singleton, providing a means of managing <code>Bridge</code> and resource/participant instances.
The chief role of the <code>BridgeManager</code> is to ensure a distinct mapping of a parent transaction context to a single <code>Bridge</code> and resource/participant instance.</p>
</li>
<li>
<p>A <code>Bridge</code>, which provides Thread to transaction context association and disassociation functions for the subordinate transaction.
The <code>Bridge</code> is usually called from the <code>Handler</code>, but may optionally be driven directly.</p>
</li>
<li>
<p>A <code>Handler</code>, which is registered into the JAX-WS processing pipeline to provide minimally invasive management of Thread to transaction context bindings via the <code>Bridge</code>, an appropriate instance of which it obtains from the <code>BridgeManager</code>.
Whilst the bridge provides handlers only for JAX-WS, it&#8217;s possible to use these as a model for the implementation of JAX-RPC versions if desired.</p>
</li>
<li>
<p>A <code>VolatileParticipant</code> and <code>DurableParticipant</code> (in the case of the InboundBridge) or <code>Synchronization</code> and <code>XAResource</code> (in the case of the OutboundBridge) which are enlisted into the parent transaction and wrap the Subordinate transaction coordinator, providing mapping of the transaction termination protocol operations.</p>
</li>
<li>
<p>A <code>RecoveryManager</code>, which is responsible for automatically restoring the state of crashed transactions and allowing them to complete correctly.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_inbound_bridging"><a class="anchor" href="#_inbound_bridging"></a>5.2.3. Inbound Bridging</h4>
<div class="paragraph">
<p>The process flow when using the inbound bridge is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A remote client starts a WS-AT transaction and invokes a transactional Web Service in the scope of that transaction.
The inbound WS invocation therefore has SOAP headers containing the WS-AT transaction context.
The coordinator used for this transaction is the root coordinator.
It may be remote from either or both of the client and the service it is invoking.
The client needs access to a WS-AT implementation, but not a JTA or the transaction bridge deployed.</p>
</li>
<li>
<p>The call arrives at a web service container, which must have Narayana JTA or JTS, XTS and the transaction bridge deployed.
The JAX-WS handler chain for the web service should have both the XTS WS-AT transaction header processor and the inbound bridge handler registered, such that they are invoked in that order.</p>
</li>
<li>
<p>The transaction header processor takes the WS-AT transaction context from XML, creates a corresponding WS-AT TxContext and associates it to the Thread.
The bridge handler calls the <code>InboundBridgeManager</code> to obtain an <code>InboundBridge</code> instance corresponding to the TxContext.</p>
</li>
<li>
<p>As the <code>BridgeManager</code> is seeing the TxContext for the first time, it creates a new <code>Bridge</code> instance.
It also creates a new <code>Bridge</code>, <code>VolatileParticipant</code>, and <code>DurableParticipant</code> and registers them with the WS-AT transaction coordinator.
These <code>Participants</code> wrap a subordinate JTA transaction.</p>
</li>
<li>
<p>The bridge header processor starts the bridge, which associates the JTA subordinate transaction context to the Thread.
At this point the Thread has transaction contexts for both WS-AT and JTA.</p>
</li>
<li>
<p>The JAX-WS pipeline processing continues, eventually calling whatever business logic is exposed.
This may be e.g. an EJB using JSR-181 annotations.
The business logic may use the JTA transaction in the normal manner e.g. enlisting Synchronizations and <code>XAResources</code> or performing other transactional activity either directly or though the usual JavaEE abstractions.</p>
</li>
<li>
<p>On the return path, the bridge header processor disassociates the JTA transaction context from the Thread via the <code>Bridge</code>.
The XTS context processor then does likewise for the WS-AT TxContext.</p>
</li>
<li>
<p>On subsequent web services calls to the same or other web services from the same client, the process is repeated.
However, the <code>BridgeManager</code> will, upon seeing the same WS-AT transaction context again, return the existing <code>Bridge</code> instance and not register further Participant instances.
This allows substantially better performance than registering one Participant per web service invocation.</p>
</li>
<li>
<p>Upon transaction termination by the client, the WS-AT transaction coordinator will drive the enlisted bridge <code>Participants</code> through the transaction termination protocol.
The <code>Participants</code> maps these calls down to the JTA subtransaction coordinator, which in turn passes them on to any Synchronizations or <code>XAResources</code> enlisted in the transaction.
This process is not visible to the business logic, except in so far as it may have registered its own Synchronizations, <code>XAResources</code> or <code>Participants</code> with the transaction.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_outbound_bridging"><a class="anchor" href="#_outbound_bridging"></a>5.2.4. Outbound Bridging</h4>
<div class="paragraph">
<p>The process flow when using the outbound bridge is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A client starts a JTA transaction and invokes a remote transactional Web Service in the scope of that transaction.
The client must have Narayana JTA (or JTS) and XTS deployed, as well as the transaction bridge.
The coordinator used for the JTA transaction is the root coordinator.
The server hosting the target web service needs a WS-AT transaction implementation but not a JTA or the transaction bridge.</p>
</li>
<li>
<p>The outbound WS invocation flows though a handler chain that has the outbound transaction bridge handler and XTS header context processor registered, such that they are invoked in that order.</p>
</li>
<li>
<p>The bridge handler calls the outbound bridge manager to obtain an outbound bridge instance corresponding to the JTA transaction context.
As the <code>BridgeManager</code> is seeing the context for the first time, it creates a new <code>Bridge</code> instance.
It also creates a <code>Synchronization</code> and <code>XAResource</code> instance to wrap the subordinate WS-AT transaction and registers these with the JTA transaction.</p>
</li>
<li>
<p>The bridge handler starts the bridge, which associates the subordinate WS-AT transaction context to the Thread.
The WS-AT header context processor then serializes this into XML in the headers of the outbound Web Services call.</p>
</li>
<li>
<p>The receiving Web Service sees a WS-AT context and can work with it in the normal manner, without knowing it is a subordinate context.</p>
</li>
<li>
<p>On the return path, the bridge handler disassociates the WS-AT TxContext from the Thread via the <code>Bridge</code>.</p>
</li>
<li>
<p>On subsequent calls to the same or other transactional Web Services in the scope of the same JTA transaction, the process is repeated.
However, the <code>BridgeManager</code> will, upon seeing the same JTA transaction context again, return the existing <code>Bridge</code> and not register another <code>Synchronization</code> or <code>XAResource</code> with the parent JTA transaction.
This allows substantially better performance than registering once per web service invocation.</p>
</li>
<li>
<p>Upon transaction termination by the client, the JTA transaction coordinator will drive the enlisted bridge <code>Synchronization</code> and <code>XAResource</code> through the transaction termination protocol.
The <code>XAResource</code> maps these calls down to the WS-AT subtransaction coordinator, which in turn passes them on to any Volatile or Durable <code>Participants</code> enlisted in the transaction.
This process is not visible to the business logic, except in so far as it may have registered its own <code>Participants</code>, <code>XAResources</code> or <code>Synchronizatons</code> with the transaction.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_crash_recovery"><a class="anchor" href="#_crash_recovery"></a>5.2.5. Crash Recovery</h4>
<div class="paragraph">
<p>The bridge includes independent crash recovery systems for the inbound and outbound sides.
These are automatically installed and activated as part of the bridge deployment.
They rely upon the recovery mechanisms in the JTA and XTS components, which are likewise deployed and activated by default as part of their respective components.</p>
</div>
<div class="paragraph">
<p>It is the responsibility of the application(s) to use suitable <code>XAResources</code> (inbound) or <code>DurableParticipants</code> (outbound).
In general the former will be from XA datasources or messaging systems, whilst the latter will be custom implementations.
In either case it is important to ensure recovery is correctly configured for the resource manager(s) before using them in production, via the bridge or otherwise.
The Narayana documentation set details crash recovery configuration, as does the application server administration guide.
For resource manager specific information e.g. Oracle db permissions settings for recovery connections, please consult the vendor&#8217;s documentation.</p>
</div>
<div class="paragraph">
<p>A bridged transaction will involve several distinct log writes, potentially on multiple hosts.
Resolving the transaction may require more than one crash recovery cycle, due to ordering constrains on the events taking place during recovery.
If a transaction fails to recover after all servers have been restored to service for more than two recovery cycles duration, the Narayana objectstore browser and server logs may be useful for diagnosing the issue.
Where a transaction involves multiple bridges the number of recovery cycles required to resolve it may further increase.
For systems requiring maximum availability it is therefore not recommended to span a transaction through more than one bridge.</p>
</div>
<div class="paragraph">
<p>Note that the 1PC commit optimization should not be used with outbound bridged transactions in which the subordinate may contain more than one Participant.
Even where only one Participant is used, crash recovery logs may not correctly reflect the actual transaction outcome.
The 1PC optimization is on be default and may be disabled by setting <code>&lt;property name="commitOnePhase"&gt;false &lt;/property&gt;</code> on <code>CoordinatorEnvironmentBean</code>.</p>
</div>
<div class="paragraph">
<p>See the 'Design Notes' appendix for detailed information on potential crash recovery scenarios and how each is handled.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_transaction_bridge"><a class="anchor" href="#_using_the_transaction_bridge"></a>5.3. Using the Transaction Bridge</h3>
<div class="sect3">
<h4 id="_introduction_5"><a class="anchor" href="#_introduction_5"></a>5.3.1. Introduction</h4>
<div class="paragraph">
<p>This section describes how to use the transaction bridge in your applications.
It is recommended you first read the preceding chapters for a theoretical background in the way the bridge functions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_enabling"><a class="anchor" href="#_enabling"></a>5.3.2. Enabling</h4>
<div class="paragraph">
<p>TXBridge is integrated with the XTS subsystem of the WildFly Application Server.
The XTS subsystem is enabled using the <code>standalone-xts.xml</code> configuration</p>
</div>
<div class="olist arabic">
<div class="title">Procedure: Starting WildFly Application Server with XTS Enabled</div>
<ol class="arabic">
<li>
<p>Change to the WildFly Application Server directory:</p>
<div class="paragraph">
<p><code>cd $JBOSS_HOME</code></p>
</div>
</li>
<li>
<p>Copy the example XTS configuration into the configurations directory:</p>
<div class="paragraph">
<p><code>cp docs/examples/configs/standalone-xts.xml standalone/configuration</code></p>
</div>
</li>
<li>
<p>Start WildFly Application Server, specifying the xts configuration:</p>
<div class="paragraph">
<p>Linux:</p>
</div>
<div class="paragraph">
<p><code>bin/standalone.sh --server-config=standalone-xts.xml</code></p>
</div>
<div class="paragraph">
<p>Windows:</p>
</div>
<div class="paragraph">
<p><code>bin\standalone.bat --server-config=standalone-xts.xml</code></p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_inbound_bridging_2"><a class="anchor" href="#_inbound_bridging_2"></a>5.3.3. Inbound Bridging</h4>
<div class="paragraph">
<p>To use the inbound bridge, register the JAX-WS handler into the handler chain of any Web Service as follows:</p>
</div>
<div class="listingblock">
<div class="title">Registering the <code>handler</code> for Inbound Bridging</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;handler-chain&gt;</span>
    <span class="tag">&lt;protocol-bindings&gt;</span>##SOAP11_HTTP<span class="tag">&lt;/protocol-bindings&gt;</span>
    <span class="tag">&lt;handler&gt;</span>
        <span class="tag">&lt;handler-name&gt;</span>TransactionBridgeHandler<span class="tag">&lt;/handler-name&gt;</span>
        <span class="tag">&lt;handler-class&gt;</span>org.jboss.jbossts.txbridge.inbound.JaxWSTxInboundBridgeHandler<span class="tag">&lt;/handler-class&gt;</span>
    <span class="tag">&lt;/handler&gt;</span>

    <span class="tag">&lt;handler&gt;</span>
        <span class="tag">&lt;handler-name&gt;</span>WebServicesTxContextHandler<span class="tag">&lt;/handler-name&gt;</span>
        <span class="tag">&lt;handler-class&gt;</span>com.arjuna.mw.wst11.service.JaxWSHeaderContextProcessor<span class="tag">&lt;/handler-class&gt;</span>
    <span class="tag">&lt;/handler&gt;</span>
<span class="tag">&lt;/handler-chain&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The web service may then operate as though running in the scope of a JTA transaction, as indeed it is.
For example, it can call (or indeed simply be) an EJB3 business logic method annotated with <code>@TansactionAttribute(TransactionAttributeType.MANDATORY)</code>.</p>
</div>
<div class="paragraph">
<p>Note that the handlers expect a WS-AT transaction context to be present on all inbound invocations.
If you wish deploy your service in such a way as to make transactional invocation optional, you must expose it though two different endpoints, one transactional and one not, with the handlers registered only on the former.
This limitation may be addressed in future versions.</p>
</div>
<div class="paragraph">
<p>If WS-AT transaction context contains transaction timeout then the bridged JTA transaction is created with this timeout.
If the context does not provide the information then the bridged JTA transaction is created with the default timeout defined by the container.</p>
</div>
</div>
<div class="sect3">
<h4 id="_outbound_bridging_2"><a class="anchor" href="#_outbound_bridging_2"></a>5.3.4. Outbound Bridging</h4>
<div class="paragraph">
<p>To use the outbound bridge, register the JAX-WS handler into the handler chain of any Web Service client application as follows:</p>
</div>
<div class="listingblock">
<div class="title">Registering the <code>handler</code> for Outbound Bridging</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;handler-chain&gt;</span>
    <span class="tag">&lt;protocol-bindings&gt;</span>##SOAP11_HTTP<span class="tag">&lt;/protocol-bindings&gt;</span>
    <span class="tag">&lt;handler&gt;</span>
        <span class="tag">&lt;handler-name&gt;</span>TransactionBridgeHandler<span class="tag">&lt;/handler-name&gt;</span>
        <span class="tag">&lt;handler-class&gt;</span>org.jboss.jbossts.txbridge.outbound.JaxWSTxOutboundBridgeHandler<span class="tag">&lt;/handler-class&gt;</span>
    <span class="tag">&lt;/handler&gt;</span>

    <span class="tag">&lt;handler&gt;</span>
        <span class="tag">&lt;handler-name&gt;</span>WebServicesTxContextHandler<span class="tag">&lt;/handler-name&gt;</span>
        <span class="tag">&lt;handler-class&gt;</span>com.arjuna.mw.wst11.client.JaxWSHeaderContextProcessor<span class="tag">&lt;/handler-class&gt;</span>
    <span class="tag">&lt;/handler&gt;</span>
<span class="tag">&lt;/handler-chain&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The web service client may then make calls to web service implementations that expect to be invoked in the scope of a WS-AT transaction.</p>
</div>
<div class="paragraph">
<p>Note that the handlers expect a JTA transaction context to be present on the client thread used to make the outbound web service invocation.
If the context is not always present, different stubs must be used for the transactional and non-transactional cases and the handler chain registered only on the former.
This limitation may be addressed in future versions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_loops_and_diamonds"><a class="anchor" href="#_loops_and_diamonds"></a>5.3.5. Loops and Diamonds</h4>
<div class="paragraph">
<p>In distributed environments that utilize transaction bridging, it is possible to construct arrangements of servers such that a transaction context passes though more than one interposition.
These can give rise to some undesirable issues, including locking and performance problems.</p>
</div>
<div class="paragraph">
<p>A simple case would be a loop in which a JTA transaction context is bridged outbound to a WS-AT context, passed though one or more remote servers and inflowed back to the original server through an inbound bridge.
This may result in a new subordinate JTA context, rather than reuse of the existing parent context in the original server.</p>
</div>
<div class="paragraph">
<p>This situation has two main observable effects.
Firstly, the parent JTA transaction and indirectly subordinate JTA transaction are considered distinct and <code>XAResources</code> may not be shared between them.
In most cases this will cause isolation between the transactions, such that they do not share locks or see eachother&#8217;s changes.
This may cause deadlocks in the application.
Secondly, performance will be poor relative to reuse of the original context, particularly if the interposition chain becomes long.</p>
</div>
<div class="paragraph">
<p>A similar problem exists where a transaction context is propagated from a single source to a single destination server via two or more separate routes, the abstract paths forming a diamond shape.
In such case the intermediate nodes operate independently and will bridge the original context to two separate interposed contexts.
To the destination server these will appear unrelated, rather than as representations of the same transaction.
Thus instead of recombining into a single shared transaction context at the destination, they will behave as different transactions, giving rise once again to potential deadlock and performance issues.</p>
</div>
<div class="paragraph">
<p>These problems may be partially addressed by having a shared context mapping service available on the network, which each bridge consults when working with a previously unseen transaction context for the first time.
Using such a mechanism, bridge instances may identify transactions for which an established mapping already exists and reuse that relationship rather than creating a new one.</p>
</div>
<div class="paragraph">
<p>This shared service model does however cause some issues of its own with regard to performance and availability.
It is not currently implemented.
Therefore, users are urged to be cautious when constructing distributed applications.
Whilst location abstraction is sometimes desirable, is is important to maintain a clear understanding of the deployment relationships between transactional components in the system.</p>
</div>
</div>
<div class="sect3">
<h4 id="_distributed_jta_and_the_jts"><a class="anchor" href="#_distributed_jta_and_the_jts"></a>5.3.6. Distributed JTA and the JTS</h4>
<div class="paragraph">
<p>The JavaEE transaction engine in Narayana comes in two varieties.
These are the local only JTA, which does not support propagation of transaction context or transaction control calls between JVMs and the JTAX, which provides the JTA API implemented by a JTS engine that does support distributed usage.</p>
</div>
<div class="paragraph">
<p>WildFly Application Server</p>
</div>
<div class="paragraph">
<p>uses the local JTA implementation by default, but can be reconfigured to use the JTS via the JTA API, such that it supports distributed transactions without requiring any changes to business applications.</p>
</div>
<div class="paragraph">
<p>In environments requiring transaction propagation of JTA transactions, it is feasible to use either the JTS or an outbound and inbound bridge pair to achieve this.
In the former case the transport is RMI/IIOP for the transaction control and RMI/IIOP or JRMP for the transactional business logic calls.
In the latter case the transport is Web Services for both transaction control and business logic.</p>
</div>
<div class="paragraph">
<p>From a transaction management perspective the JTS solution is preferred, due to simplicity (no protocol mapping is needed), maturity (Narayana JTS was the world&#8217;s first JTS implementation and has been extensively used and tested in production environments) and performance (binary vs. xml).</p>
</div>
<div class="paragraph">
<p>It is possible to use transactions that propagate context on some calls via JTS and on others via Web Services, such as a client invoking both EJBs via RMI/IIOP and Web services with WS-AT context.
In such cases it&#8217;s possible for a transaction to have multiple representations that the infrastructure cannot determine are related, even if they actually represent different contexts in the same interposition hierarchy.
Care must therefore be taken to avoid the problems described previously in 'Loops and Diamonds'.</p>
</div>
</div>
<div class="sect3">
<h4 id="_logging"><a class="anchor" href="#_logging"></a>5.3.7. Logging</h4>
<div class="paragraph">
<p>The transaction bridge uses the jboss-logging system.
When running inside WildFly Application Server, logging is configured via logging subsystem&#8217;s configuration in <code>standalone-xts.xml</code> file.
To enable full logging for the transaction bridge, which may be useful for debug purposes, the following logger should be added:</p>
</div>
<div class="listingblock">
<div class="title">Configuring Transaction Bridge Logging</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;logger</span> <span class="attribute-name">category</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jboss.jbossts.txbridge</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;level</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/logger&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the transaction bridge is a thin layer on top of the XTS and JTA/JTS components of Narayana, and that it also interacts with other parts of the application server.
To gain a comprehensive understanding of the system&#8217;s operation, it may be necessary to enable verbose logging for some of these other components also.
The Narayana logging system is discussed in detail in the accompanying documentation set, but for ease of reference the following may be used to enable verbose logging:</p>
</div>
<div class="listingblock">
<div class="title">Configuring verbose logging</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;logger</span> <span class="attribute-name">category</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.arjuna</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;level</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/logger&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note also that deployment ordering issues can result in Narayana components, including the transaction bridge, becoming active before the logging system is fully configured.
In such cases a default logging level may apply during startup, resulting in some more detailed debug messages being missed.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_known_limitations"><a class="anchor" href="#_known_limitations"></a>5.4. Known Limitations</h3>
<div class="paragraph">
<p>The current transaction bridge release has the following limitations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The bridge operates only on WS-AT 1.2, not 1.0, although XTS includes implementations of both versions of WS-AT.
Care must therefore be taken to deploy and configure the system correctly.</p>
</li>
<li>
<p>The bridge provides JAX-WS handlers only, not JAX-RPC, although it is possible to create such if required.</p>
</li>
<li>
<p>Long running activities that occur during the transaction termination process may cause timeouts in the transaction system, which can in turn cause inconsistent transaction outcomes or incomplete transaction termination.
To minimize this problem, it is advised to manually flush data that would otherwise be flushed by Synchronizations during termination, such as hibernate session state.</p>
</li>
<li>
<p>A transaction context must always be present on the Thread in order for the context processors to operate correctly, as detailed previously in 'Using the Transaction Bridge'.</p>
</li>
<li>
<p>A subordinate transaction context will be created and registered into the parent transaction unconditionally, which can cause unnecessary overhead in situations where no transactional activity takes place in the scope of the subordinate.
Care should be taken to register the bridge handlers only on methods that do require them.
In future releases this may be addressed by the use of WS-Policy or lazy initialization techniques.</p>
</li>
<li>
<p>Transaction mappings are local to BridgeManagers, which are singletons.
This means mappings are classloader scoped and not shared across JVMs.
This gives rise to issues where transactional resources are accessed indirectly though multiple bridges or transaction context transports, as described in 'Loops and Diamonds'.</p>
</li>
<li>
<p>Crash recovery is subject to certain timing issues, due to the interaction between recovery of the JTA/XA and XTS sides of the transaction.
It may take more than one crash recovery cycle for a bridged transaction to recover fully.
Note that recovery of subordinate transactions is dependent on the recovery of their parent, so care must be taken to ensure the correct recovery of any external transaction manager used in that role.
The transaction bridge does not currently provide dedicated tooling for the manual resolution of orphaned subordinates, instead relying on the general purpose objectstore maintenance tooling provided by Narayana.</p>
</li>
<li>
<p>Note that crash recovery will not behave correctly for outbound bridged transactions if 1PC commit optimization is used in the parent JTA transaction.
This is not specific to the bridge, but rather is a generic issue with any transaction in which a single resource is an interposed subordinate coordinator.
Inbound bridges transactions are unaffected as XTS (WS-AT) does not utilize a 1PC optimization.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_design_notes"><a class="anchor" href="#_design_notes"></a>5.5. Design Notes</h3>
<div class="sect3">
<h4 id="_general_points"><a class="anchor" href="#_general_points"></a>5.5.1. General Points</h4>
<div class="paragraph">
<p>This section records key design points relating to the bridge implementation.
The target audience for this section is software engineers maintaining or extending the transaction bridge implementation.
It is unlikely to contain material useful to users, except in so far as they wish to contribute to the project.
An in-depth knowledge of Narayana internals may be required to make sense of some parts of this appendix.</p>
</div>
<div class="paragraph">
<p>The <code>txbridge</code> is written as far as possible as a user application layered on top of the JTA and XTS implementations.
It accesses these underlying components through standard or supported APIs as far as possible.
For example, <code>XAResource</code> is favored over <code>AbstractRecord</code>, the JCA standard <code>XATerminator</code> is used for driving subordinates and so on.
This facilitates modularity and portability.</p>
</div>
<div class="paragraph">
<p>It follows that functionality required by the bridge should first be evaluated for inclusion in one of the underlying modules, as experience has shown it is often also useful for other user applications.
For example, improvements to allows subordinate termination code portability between JTA and JTS, and support for subordinate crash recovery have benefited from this approach.
The <code>txbridge</code> remains a thin layer on top of this functionality, containing only purpose specific code.</p>
</div>
<div class="paragraph">
<p>The 'loops and diamonds' problem boils down to providing deterministic, bi-directional 1:1 mapping between an Xid (which is fixed length) and a WS-AT context (which is unbounded length in the spec, although bounded for instances created by the XTS).
Consistent hashing techniques get you so far with independent operation, but the only 100% solution is to have a shared service on the network providing the mapping lookup.
Naturally this then becomes a single point of failure as well as a scalability issue.
For some scenarios it may be possible to use interceptors to propagate the Xid on the web services call as extra data, instead of trying to reproduce the mapping at the other end.
Unfortunately XA does not provide for this kind of extensibility, although CORBA does, leading to the possibility of solving the issue without a centralized approach in mixed JTS+WS-AT environments.</p>
</div>
<div class="paragraph">
<p>Requiring a tx context on all calls is a bit limiting, but JBossWS native lacks a WS-Policy implementation.
Things may change with the move to CXF.
This is really a wider issue with XTS, not just the bridge.</p>
</div>
</div>
<div class="sect3">
<h4 id="_crash_recovery_considerations"><a class="anchor" href="#_crash_recovery_considerations"></a>5.5.2. Crash Recovery Considerations</h4>
<div class="paragraph">
<p>As usual with transactions, it&#8217;s the crash recovery that provides for the most complexity.
Recovery for the inbound and outbound sides is handled independently.
Because of event ordering between recovery modules (JTA, XTS), it requires two complete cycles to resolve some of these crash recovery situations.</p>
</div>
<div class="sect4">
<h5 id="_inbound_crash_recovery"><a class="anchor" href="#_inbound_crash_recovery"></a>Inbound Crash Recovery</h5>
<div class="paragraph">
<p>An inbound transaction involves at least four log writes.
Top down (i.e. in reverse order of log creation) these are: The WS-AT coordinator log (assumed here to be XTS, but may be 3rd party), the XTS Participant log in the receiving server, the JCA Subordinate transaction log and at least one XA Resource Manager log (which are 3rd party e.g. Oracle).</p>
</div>
<div class="paragraph">
<p>There is no separate log created by the <code>txbridge</code>.
The XTS Participant log inlines the Serializable <code>BridgeDurableParticipant</code> via its writeObject method.
Recorded state includes its identity (the Xid) and the identity of the separately logged JTA subordinate tx (a Uid).</p>
</div>
<div class="paragraph">
<p>XTS is responsible for the top level coordinator log.
Narayana is responsible for the JTA subordinate tx log and 3rd party RMs are each responsible for their own.</p>
</div>
<div class="paragraph">
<p>The following situations may exist at recovery time, according to the point in time at which the crash occurred:</p>
</div>
<div class="paragraph">
<p>RM log only: In this case, the <code>InboundBridgeRecoveryManager&#8217;s `XAResourceOrphanFilter</code> implementation will be invoked via Narayana <code>XARecoveryModule</code>, will recognize the orphaned Xids by their formatId (which they inherit from the JCA subordinate, which the <code>txbridge</code> previously created with a specially constructed inflowed Xid) and will vote to have the <code>XARecoveryModule</code> roll them back as no corresponding JCA subordinate log exists, so presumed abort applies.</p>
</div>
<div class="paragraph">
<p>RM log and JTA subordinate tx log: The <code>InboundBridgeRecoverytManager&#8217;s scan of indoubt subordinate JTA transactions identifies the JTA subordinate as being orphaned and rolls it back, which in turn causes the rollback of the RM&#8217;s `XAResource</code>.</p>
</div>
<div class="paragraph">
<p>RM log, JTA subordinate log and XTS Participant log: XTS is responsible for detecting that the Participant is orphaned (by re-sending Prepared to the Coordinator and receiving 'unknown tx' back) and initiating rollback under the presumed abort convention.</p>
</div>
<div class="paragraph">
<p>WS-AT coordinator log and all downstream logs: The coordinator re-sends Commit to the Participant and the transaction completes.</p>
</div>
</div>
<div class="sect4">
<h5 id="_outbound_crash_recovery"><a class="anchor" href="#_outbound_crash_recovery"></a>Outbound Crash Recovery</h5>
<div class="paragraph">
<p>An outbound transaction involves log writes for the JTA parent transaction and the XTS <code>BridgeWrapper</code> coordinator.
There is not a separate log created by the <code>txbridge</code>.
The JTA tx log inlines the Serializable <code>BridgeXAResource</code> via its writeObject method.
Recorded state includes the JTA tx id and <code>BridgeWrapper</code> id String.
In addition a Web Service participating in the subordinate transaction will create a log.
Assuming it&#8217;s XTS, the participant side log will inline any <code>Serializable Durable2PCParticipant</code>, effectively forming the RM log.</p>
</div>
<div class="paragraph">
<p>The following situations may exist at recovery time, according to the point in time at which the crash occurred:</p>
</div>
<div class="paragraph">
<p>RM log (i.e. XTS Participant log, inlining <code>Serializable Durable2PCParticipant</code>) only: XTS is responsible for detecting that the Participant is orphaned (its direct parent, the subordinate coordinator, is missing) and rolling it back.
The bridge recovery code is not involved  XTS recovery deserializes and drives any app DurableParticipants directly.</p>
</div>
<div class="paragraph">
<p>RM log and XTS subordinate log: The <code>DurableParticipant</code>(s) (i.e. client side) and XTS subordinate coordinator / <code>BridgeWrapper</code> (i.e. server side) and reinstantiated by XTS.
The <code>BridgeWrapper</code>, being subordinate to a missing parent, must be identified and explicitly rolledback by the bridge recovery code.
The bridge recovery manager is itself a RecoveryModule, thus invoked periodically to perform this task.
It identified its own <code>BridgeWrapper</code> instance from amongst all those awaiting recovery by means of an id prefix specific to the <code>txbridge</code> code.
See <code>JBTM-725</code> for further details.</p>
</div>
<div class="paragraph">
<p>RM log, XTS subordinate log and JTA parent log (with inlined <code>BridgeXAResource</code>): Top down recovery by the JTA recovery module drives tx to completion, taking the normal JTA parent&#8594;`BridgeXAResource`&#8594;XTS subordinate&#8594;`DurableParticipant` path.
Note that if the bridge is the only <code>XAResource</code> in the parent, the JTA must have 1PC commit optimization disabled or it won&#8217;t write a log for recovery.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_test_framework"><a class="anchor" href="#_test_framework"></a>5.5.3. Test framework</h4>
<div class="paragraph">
<p>The test suite for the <code>txbridge</code> is split along two axis.
Firstly, the inbound and outbound sides of the bridge have their own test suites in a parallel code package hierarchy.
These are largely mirrors, containing tests which have matching intent but different implementation details.
Secondly, the tests are split between those for normal execution and those for crash recovery.</p>
</div>
<div class="paragraph">
<p>The tests use a framework consisting of a basic servlet acting as client (the code pre-dates the availability of XTS lightweight client), a basic web service as server and a set of utility classes implementing the appropriate interfaces (<code>Participant</code>/<code>Synchronization</code>/<code>XAResource</code>).
These classes contain the bare minimum of test logic.
In order to make the tests as easy to understand and modify as possible, an attempt is made to capture the entirety of the test logic within the junit test function instead of splitting it over the framework classes.
To facilitate this, extensive use is made of byteman and its associated dtest library, which provides basic distributed mock-like execution tracing and configuration.
You probably need to take a detour and read the dtest docs before proceeding further.</p>
</div>
<div class="paragraph">
<p>The basic tests all follow the same pattern: make a call through the bridge, following different logic paths in each test, and verify that the test resources see the expected method calls.
For example, in a test that runs a transaction successfully, expect to see commit called on enlisted resources and rollback not called.
For a test that configures the prepare to fail, expect to see rollback called and commit not called.
The tests verify behavior in the presence of 'expected' errors e.g. prepare failures, but generally don&#8217;t cover unexpected failures e.g. exceptions thrown from commit.</p>
</div>
<div class="paragraph">
<p>Test normal execution targets in the <code>tests/build.xml</code> assume the server is started manually with byteman installed and has XTS, <code>txbridge</code> and the test artifacts deployed.
Note that it also contains targets that may be called to achieve the last of these steps.</p>
</div>
<div class="paragraph">
<p>The crash rec tests start (and subsequently restart) the server automatically, but assume the that XTS, <code>txbridge</code> and the test artifacts are deployed.
To manage the server they need to be provided with <code>JBOSS_HOME</code> and <code>JAVA_HOME</code> values in the <code>build.xml</code>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-09-27 14:38:03 +0100
</div>
</div>
</body>
</html>