<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Troubleshooting</title>
<style>
@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";
@import "https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css";

h6 > .content > .title,h7,h8,h9 {
    font-family:"Open Sans","DejaVu Sans",sans-serif;
    font-weight:normal;
    font-size:.85em;
    font-style:normal;
    color:#ba8425;
    text-rendering:optimizeLegibility;
    margin-top:1em;
    margin-bottom:1em;
    line-height:2em
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Troubleshooting</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_ws_ba_participant_completion_race_condition">WS-BA Participant-Completion Race Condition</a>
<ul class="sectlevel2">
<li><a href="#_whats_happening_in_a_nutshell">What&#8217;s happening, in a nutshell</a></li>
<li><a href="#_when_is_it_most_likely_to_happen">When is it most likely to happen?</a></li>
<li><a href="#_how_do_i_know_if_this_is_affecting_my_application">How do I know if this is affecting my application?</a></li>
<li><a href="#_why_cant_it_be_avoided">Why can&#8217;t it be avoided?</a></li>
<li><a href="#_what_can_the_application_do_to_tolerate_this">What can the application do to tolerate this?</a></li>
<li><a href="#_why_exactly_does_this_happen">Why exactly does this happen?</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This chapter covers issues that you may hit when developing applications with Narayana.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ws_ba_participant_completion_race_condition"><a class="anchor" href="#_ws_ba_participant_completion_race_condition"></a>WS-BA Participant-Completion Race Condition</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The WS-BA participant-completion protocol has a benign race condition that, in unusual circumstances, can cause some Business Activities to be cancelled that would have otherwise been able to close.
This is safe as no inconsistency arrises, but it can be annoying for users.
This section explains why this can happen, under what conditions, and what you can do to tolerate it.</p>
</div>
<div class="sect2">
<h3 id="_whats_happening_in_a_nutshell"><a class="anchor" href="#_whats_happening_in_a_nutshell"></a>What&#8217;s happening, in a nutshell</h3>
<div class="paragraph">
<p>Imagine a scenario where the client begins a business activity and then invokes a Web service.
If the Web service uses participant completion, it will notify the coordinator when it has completed its work and then return control to the client.
This notification is asynchronous, so it&#8217;s possible that the client will then ask the coordinator to close the activity before the coordinator processes (or even receives) the completed notification from the participant.
In this situation the coordinator will cancel the activity as not all participants (from its perspective) have completed their work.
As a result all completed participants are compensated (including, eventually, the participant with the late 'completed' notification) and the client receives a <code>TransactionRolledBackException</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_when_is_it_most_likely_to_happen"><a class="anchor" href="#_when_is_it_most_likely_to_happen"></a>When is it most likely to happen?</h3>
<div class="paragraph">
<p>Typically this happens when the client, coordinator and participant are running inside the same VM.
This scenario is unlikely to happen in production, but can happen regularly during development where a single VM is used to keep things simple.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_do_i_know_if_this_is_affecting_my_application"><a class="anchor" href="#_how_do_i_know_if_this_is_affecting_my_application"></a>How do I know if this is affecting my application?</h3>
<div class="paragraph">
<p>If the client is occasionally receiving a <code>TransactionRolledbackException</code> when calling <code>UserBusinessActivity#close()</code>, but none of the machines involved in running the transaction have crashed, you could be affected by this.
Especially if you are running the client, coordinator and participant(s) in the same server.</p>
</div>
<div class="paragraph">
<p>The following log message will help you identify this issue:</p>
</div>
<div class="listingblock">
<div class="title">Example Environment Bean</div>
<div class="content">
<pre class="CodeRay highlight"><code>WARN [com.arjuna.mw.wstx] (TaskWorker-2) ARJUNA045062: Coordinator cancelled the activity</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is only an indication that you are seeing this issue as the coordinator can elect to cancel the activity for other reasons.
For example, network problems might mean the coordinator cannot tell the web service to close the activity.</p>
</div>
</div>
<div class="sect2">
<h3 id="_why_cant_it_be_avoided"><a class="anchor" href="#_why_cant_it_be_avoided"></a>Why can&#8217;t it be avoided?</h3>
<div class="paragraph">
<p>For the protocol to avoid this issue, it would need to make the complete message synchronous, throttling throughput by slowing down both the participant and coordinator and holding sockets open for longer.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_can_the_application_do_to_tolerate_this"><a class="anchor" href="#_what_can_the_application_do_to_tolerate_this"></a>What can the application do to tolerate this?</h3>
<div class="paragraph">
<p>A real, distributed deployment will rarely see this problem because communication latency between client, participant and coordinator will dominate the race condition.
Even if it does happen your application should tolerate it.
Transaction rollbacks and activity cancelations are inevitable in a distributed environment and can happen for many reasons.
When handling <code>TransactionRolledBack</code> exceptions you can either retry the Transaction/Activity or notify the caller of the failure.
What you choose to do will depend on the requirements of your application.</p>
</div>
</div>
<div class="sect2">
<h3 id="_why_exactly_does_this_happen"><a class="anchor" href="#_why_exactly_does_this_happen"></a>Why exactly does this happen?</h3>
<div class="paragraph">
<p>First consider the following client code:</p>
</div>
<div class="listingblock">
<div class="title">Client Code Example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">UserBusinessActivity uba = UserBusinessActivityFactory.userBusinessActivity();
uba.begin();
myWebServiceClient.invoke();
uba.close();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client code is very simple, it just begins a business activity, invokes a Web service and then closes the business activity.
The Web service uses the Participant-Completion protocol and so notifies the coordinator of completion just before returning control to the client.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a diagram showing the pertinent message exchanges that occur under a normal situation.</p>
</div>
<div id="_fig_pcp_race_success" class="imageblock text-center">
<div class="content">
<img src="images/development-guide-fig-pcp-race-success.png" alt="development guide fig pcp race success">
</div>
<div class="title">Figure 1. Successful close of activity</div>
</div>
<div class="paragraph">
<p>The messages are numbered to indicate the order in which they are sent:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>1.request</code>.
This represents the application request made by the client.</p>
</li>
<li>
<p><code>2.completed</code>.
After the participant has completed its work, it notifies the coordinator that it has completed.</p>
</li>
<li>
<p><code>3.response</code>.
This represents the response to the client&#8217;s application request.</p>
</li>
<li>
<p><code>4.close</code>.
The client notifies the coordinator that it wishes to close the activity.
It then waits for a <code>closed</code> or failure response from the coordinator.</p>
</li>
<li>
<p><code>5a.close</code> and <code>5b.closed</code>.
The coordinator has processed the <code>2.completed</code> message so can close the activity.
It starts by sending the <code>close</code> message to the participant and waits for the <code>closed</code> response as confirmation.
These two messages are asynchronous.</p>
</li>
<li>
<p><code>6.closed</code>.
The coordinator now has all <code>closed</code> acknowledgments so notifies the client that the activity successfully <code>closed</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Messages '2.completed' and '4.close' are asynchronous (or 'one way' in Web services parlance) so effectively, there is a race condition with the following competing parties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Party 1</code>. The completed message <code>2.completed</code>.</p>
</li>
<li>
<p><code>Party 2</code>. The response <code>3.response</code> followed by <code>4.close</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When running in the same VM, or on a low latency network, <code>3.response</code> will be sent very quickly.
This is because it is simply travelling on the HTTP response over an already open socket.
This just leaves messages <code>2.completed</code> and <code>4.close</code> which will take much longer relative to <code>3.response</code>.
To understand this, lets take a look at what happens when an asynchronous Web service call is made:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The client sends the message to the Web service.</p>
</li>
<li>
<p>The server-side SOAP stack uses an existing thread from a pool dedicated to receiving SOAP messages.</p>
</li>
<li>
<p>As the service is asynchronous, the message will be passed to another thread to be processed.</p>
</li>
<li>
<p>The receiving thread will now return the HTTP response.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The race condition occurs because steps 1-3 can happen relatively quickly in a single VM, and thus it&#8217;s likely that both messages 2 and 4, will be waiting to be processed at the same time.
The order in which they are processed is dependent on the implementation of the thread pool and is also at the mercy of thread scheduling in the VM, so it&#8217;s possible that either could be processed first.</p>
</div>
<div class="paragraph">
<p>This race condition is much less likely to happen in a distributed environment as the network costs will be significantly higher.
As a result message <code>3.response</code> will take long enough to send, so as to give message <code>2.completed</code> enough of a head start.
But it is still possible so the client application must be coded defensively to catch and handle a <code>TransactionRollbackException</code>.
The client code ought to be doing this anyway to deal with server crashes.</p>
</div>
<div class="paragraph">
<p>The following diagram shows what messages are exchanged when the race condition occurs.
Notice that the activity ends in a consistent state.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/development-guide-fig-pcp-race-failure.png" alt="development guide fig pcp race failure">
</div>
<div class="title">Figure 2. Failure to close the activity</div>
</div>
<div class="paragraph">
<p>Messages 1-3 are omitted from the following explanation as they are the same as in the success case.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>4.close</code>.
This message is processed by the coordinator before message <code>2.completed</code></p>
</li>
<li>
<p><code>5a.cancel</code>.
The coordinator has not yet processed the <code>2.completed</code> message so cannot close the activity.
The coordinator then sends a 'cancel' message to the participant as it thinks it has not yet completed.
This message and subsequent retires, are dropped by the participant as they are not valid for a completed participant.</p>
</li>
<li>
<p><code>5b.compensate</code>/<code>5c.compensated</code>.
After one or more unacknowledged <code>cancel</code> messages, the coordinator switches to sending <code>compensate</code> messages which will cause the participant to compensate the work.
The participant acknowledges with a <code>compensated</code> reply.</p>
</li>
<li>
<p>6. Transaction rolledback exception.
The coordinator notifies the client that the activity failed to close.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As you can see from the steps above, when this race condition arises, any work done by participants is compensated and the client is notified of the outcome.
Thus a consistent outcome is achieved.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-10-16 15:47:44 +0200
</div>
</div>
</body>
</html>